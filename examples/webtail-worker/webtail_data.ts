

export const WEBTAIL_APP_HASH = '2e44b4471695e24b3ea09de8998740dadf8fbd71';
export const WEBTAIL_APP_B64 = 'Ly8gZGVuby1mbXQtaWdub3JlLWZpbGUKLy8gZGVuby1saW50LWlnbm9yZS1maWxlCi8vIFRoaXMgY29kZSB3YXMgYnVuZGxlZCB1c2luZyBgZGVubyBidW5kbGVgIGFuZCBpdCdzIG5vdCByZWNvbW1lbmRlZCB0byBlZGl0IGl0IG1hbnVhbGx5Cgpjb25zdCBkaXJlY3RpdmVzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgaXNEaXJlY3RpdmUgPSAobyk9PnsKICAgIHJldHVybiB0eXBlb2YgbyA9PT0gImZ1bmN0aW9uIiAmJiBkaXJlY3RpdmVzLmhhcyhvKTsKfTsKY29uc3QgaXNDRVBvbHlmaWxsID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzICE9IG51bGwgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzLnBvbHlmaWxsV3JhcEZsdXNoQ2FsbGJhY2sgIT09IHZvaWQgMDsKY29uc3QgcmVwYXJlbnROb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsLCBiZWZvcmUgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5pbnNlcnRCZWZvcmUoc3RhcnQsIGJlZm9yZSk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCByZW1vdmVOb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChzdGFydCk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCBub0NoYW5nZSA9IHt9Owpjb25zdCBub3RoaW5nID0ge307CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhMSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICAgIGlmIChkYXRhMS5pbmRleE9mKG1hcmtlcikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdzMiA9IGRhdGExLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7fQp9KSgpOwpjbGFzcyBFdmVudFBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgZXZlbnROYW1lLCBldmVudENvbnRleHQpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgICAgIHRoaXMuZXZlbnRDb250ZXh0ID0gZXZlbnRDb250ZXh0OwogICAgICAgIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50ID0gKGUpPT50aGlzLmhhbmRsZUV2ZW50KGUpCiAgICAgICAgOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy5fX3BlbmRpbmdWYWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fX3BlbmRpbmdWYWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdMaXN0ZW5lciA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgY29uc3Qgb2xkTGlzdGVuZXIgPSB0aGlzLnZhbHVlOwogICAgICAgIGNvbnN0IHNob3VsZFJlbW92ZUxpc3RlbmVyID0gbmV3TGlzdGVuZXIgPT0gbnVsbCB8fCBvbGRMaXN0ZW5lciAhPSBudWxsICYmIChuZXdMaXN0ZW5lci5jYXB0dXJlICE9PSBvbGRMaXN0ZW5lci5jYXB0dXJlIHx8IG5ld0xpc3RlbmVyLm9uY2UgIT09IG9sZExpc3RlbmVyLm9uY2UgfHwgbmV3TGlzdGVuZXIucGFzc2l2ZSAhPT0gb2xkTGlzdGVuZXIucGFzc2l2ZSk7CiAgICAgICAgY29uc3Qgc2hvdWxkQWRkTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciAhPSBudWxsICYmIChvbGRMaXN0ZW5lciA9PSBudWxsIHx8IHNob3VsZFJlbW92ZUxpc3RlbmVyKTsKICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRBZGRMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLl9fb3B0aW9ucyA9IGdldE9wdGlvbnMobmV3TGlzdGVuZXIpOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IG5ld0xpc3RlbmVyOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KICAgIGhhbmRsZUV2ZW50KGV2ZW50KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuY2FsbCh0aGlzLmV2ZW50Q29udGV4dCB8fCB0aGlzLmVsZW1lbnQsIGV2ZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlLmhhbmRsZUV2ZW50KGV2ZW50KTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZ2V0T3B0aW9ucyA9IChvKT0+byAmJiAoZXZlbnRPcHRpb25zU3VwcG9ydGVkID8gewogICAgICAgIGNhcHR1cmU6IG8uY2FwdHVyZSwKICAgICAgICBwYXNzaXZlOiBvLnBhc3NpdmUsCiAgICAgICAgb25jZTogby5vbmNlCiAgICB9IDogby5jYXB0dXJlKQo7CmNsYXNzIERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvciB7CiAgICBoYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhlbGVtZW50LCBuYW1lLCBzdHJpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZVswXTsKICAgICAgICBpZiAocHJlZml4ID09PSAiLiIpIHsKICAgICAgICAgICAgY29uc3QgY29tbWl0dGVyMiA9IG5ldyBQcm9wZXJ0eUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKTsKICAgICAgICAgICAgcmV0dXJuIGNvbW1pdHRlcjIucGFydHM7CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICJAIikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEV2ZW50UGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBvcHRpb25zLmV2ZW50Q29udGV4dCkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIj8iKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgQm9vbGVhbkF0dHJpYnV0ZVBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncykKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tbWl0dGVyID0gbmV3IEF0dHJpYnV0ZUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICByZXR1cm4gY29tbWl0dGVyLnBhcnRzOwogICAgfQogICAgaGFuZGxlVGV4dEV4cHJlc3Npb24ob3B0aW9ucykgewogICAgICAgIHJldHVybiBuZXcgTm9kZVBhcnQob3B0aW9ucyk7CiAgICB9Cn0KY29uc3QgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yID0gbmV3IERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcigpOwpmdW5jdGlvbiB0ZW1wbGF0ZUZhY3RvcnkocmVzdWx0KSB7CiAgICBsZXQgdGVtcGxhdGVDYWNoZSA9IHRlbXBsYXRlQ2FjaGVzLmdldChyZXN1bHQudHlwZSk7CiAgICBpZiAodGVtcGxhdGVDYWNoZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGVDYWNoZSA9IHsKICAgICAgICAgICAgc3RyaW5nc0FycmF5OiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgICBrZXlTdHJpbmc6IG5ldyBNYXAoKQogICAgICAgIH07CiAgICAgICAgdGVtcGxhdGVDYWNoZXMuc2V0KHJlc3VsdC50eXBlLCB0ZW1wbGF0ZUNhY2hlKTsKICAgIH0KICAgIGxldCB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LmdldChyZXN1bHQuc3RyaW5ncyk7CiAgICBpZiAodGVtcGxhdGUgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIGNvbnN0IGtleSA9IHJlc3VsdC5zdHJpbmdzLmpvaW4obWFya2VyKTsKICAgIHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuZ2V0KGtleSk7CiAgICBpZiAodGVtcGxhdGUgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHJlc3VsdCwgcmVzdWx0LmdldFRlbXBsYXRlRWxlbWVudCgpKTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5zZXQoa2V5LCB0ZW1wbGF0ZSk7CiAgICB9CiAgICB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5zZXQocmVzdWx0LnN0cmluZ3MsIHRlbXBsYXRlKTsKICAgIHJldHVybiB0ZW1wbGF0ZTsKfQpjb25zdCB0ZW1wbGF0ZUNhY2hlcyA9IG5ldyBNYXAoKTsKY29uc3QgcGFydHMgPSBuZXcgV2Vha01hcCgpOwpjb25zdCByZW5kZXIgPSAocmVzdWx0LCBjb250YWluZXIsIG9wdGlvbnMpPT57CiAgICBsZXQgcGFydCA9IHBhcnRzLmdldChjb250YWluZXIpOwogICAgaWYgKHBhcnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbW92ZU5vZGVzKGNvbnRhaW5lciwgY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgIHBhcnRzLnNldChjb250YWluZXIsIHBhcnQgPSBuZXcgTm9kZVBhcnQoT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIHRlbXBsYXRlRmFjdG9yeQogICAgICAgIH0sIG9wdGlvbnMpKSk7CiAgICAgICAgcGFydC5hcHBlbmRJbnRvKGNvbnRhaW5lcik7CiAgICB9CiAgICBwYXJ0LnNldFZhbHVlKHJlc3VsdCk7CiAgICBwYXJ0LmNvbW1pdCgpOwp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIxLjQuMSIpOwp9CmNvbnN0IGh0bWwgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFRlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgImh0bWwiLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKY29uc3Qgc3ZnID0gKHN0cmluZ3MsIC4uLnZhbHVlcyk9Pm5ldyBTVkdUZW1wbGF0ZVJlc3VsdChzdHJpbmdzLCB2YWx1ZXMsICJzdmciLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKdmFyIF9hOwp3aW5kb3cuSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSA9IChwcm9wLCBfb2JqKT0+cHJvcAo7CmNvbnN0IGRlZmF1bHRDb252ZXJ0ZXIgPSB7CiAgICB0b0F0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/ICIiIDogbnVsbDsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/IHZhbHVlIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgZnJvbUF0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbDsKICAgICAgICAgICAgY2FzZSBOdW1iZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgPyBudWxsIDogTnVtYmVyKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KfTsKY29uc3Qgbm90RXF1YWwgPSAodmFsdWUsIG9sZCk9PnsKICAgIHJldHVybiBvbGQgIT09IHZhbHVlICYmIChvbGQgPT09IG9sZCB8fCB2YWx1ZSA9PT0gdmFsdWUpOwp9Owpjb25zdCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbiA9IHsKICAgIGF0dHJpYnV0ZTogdHJ1ZSwKICAgIHR5cGU6IFN0cmluZywKICAgIGNvbnZlcnRlcjogZGVmYXVsdENvbnZlcnRlciwKICAgIHJlZmxlY3Q6IGZhbHNlLAogICAgaGFzQ2hhbmdlZDogbm90RXF1YWwKfTsKY29uc3QgU1RBVEVfSEFTX1VQREFURUQgPSAxOwpjb25zdCBTVEFURV9VUERBVEVfUkVRVUVTVEVEID0gMSA8PCAyOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSA9IDEgPDwgMzsKY29uc3QgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSA9IDEgPDwgNDsKY29uc3QgZmluYWxpemVkID0gImZpbmFsaXplZCI7CmNsYXNzIFVwZGF0aW5nRWxlbWVudCBleHRlbmRzIEhUTUxFbGVtZW50IHsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgICAgc3VwZXIoKTsKICAgICAgICB0aGlzLmluaXRpYWxpemUoKTsKICAgIH0KICAgIHN0YXRpYyBnZXQgb2JzZXJ2ZWRBdHRyaWJ1dGVzKCkgewogICAgICAgIHRoaXMuZmluYWxpemUoKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT57CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkocCwgdik7CiAgICAgICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuc2V0KGF0dHIsIHApOwogICAgICAgICAgICAgICAgYXR0cmlidXRlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICBzdGF0aWMgX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX2NsYXNzUHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGNvbnN0IHN1cGVyUHJvcGVydGllcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKS5fY2xhc3NQcm9wZXJ0aWVzOwogICAgICAgICAgICBpZiAoc3VwZXJQcm9wZXJ0aWVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHN1cGVyUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fY2xhc3NQcm9wZXJ0aWVzLnNldChrLCB2KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBjcmVhdGVQcm9wZXJ0eShuYW1lLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm5vQWNjZXNzb3IgfHwgdGhpcy5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSB0eXBlb2YgbmFtZSA9PT0gInN5bWJvbCIgPyBTeW1ib2woKSA6IGBfXyR7bmFtZX1gOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSB0aGlzLmdldFByb3BlcnR5RGVzY3JpcHRvcihuYW1lLCBrZXksIG9wdGlvbnMpOwogICAgICAgIGlmIChkZXNjcmlwdG9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMucHJvdG90eXBlLCBuYW1lLCBkZXNjcmlwdG9yKTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGdldCAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1trZXldOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXNbbmFtZV07CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfTsKICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSkgewogICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgJiYgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmdldChuYW1lKSB8fCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbjsKICAgIH0KICAgIHN0YXRpYyBmaW5hbGl6ZSgpIHsKICAgICAgICBjb25zdCBzdXBlckN0b3IgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7CiAgICAgICAgaWYgKCFzdXBlckN0b3IuaGFzT3duUHJvcGVydHkoZmluYWxpemVkKSkgewogICAgICAgICAgICBzdXBlckN0b3IuZmluYWxpemUoKTsKICAgICAgICB9CiAgICAgICAgdGhpc1tmaW5hbGl6ZWRdID0gdHJ1ZTsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwID0gbmV3IE1hcCgpOwogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoInByb3BlcnRpZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BlcnRpZXM7CiAgICAgICAgICAgIGNvbnN0IHByb3BLZXlzID0gWwogICAgICAgICAgICAgICAgLi4uT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcHMpLAogICAgICAgICAgICAgICAgLi4udHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHByb3BzKSA6IFtdCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiBwcm9wS2V5cyl7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZVByb3BlcnR5KHAsIHByb3BzW3BdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBfYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBvcHRpb25zLmF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlID09PSBmYWxzZSA/IHZvaWQgMCA6IHR5cGVvZiBhdHRyaWJ1dGUgPT09ICJzdHJpbmciID8gYXR0cmlidXRlIDogdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogdm9pZCAwOwogICAgfQogICAgc3RhdGljIF92YWx1ZUhhc0NoYW5nZWQodmFsdWUsIG9sZCwgaGFzQ2hhbmdlZCA9IG5vdEVxdWFsKSB7CiAgICAgICAgcmV0dXJuIGhhc0NoYW5nZWQodmFsdWUsIG9sZCk7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlciB8fCBkZWZhdWx0Q29udmVydGVyOwogICAgICAgIGNvbnN0IGZyb21BdHRyaWJ1dGUgPSB0eXBlb2YgY29udmVydGVyID09PSAiZnVuY3Rpb24iID8gY29udmVydGVyIDogY29udmVydGVyLmZyb21BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGZyb21BdHRyaWJ1dGUgPyBmcm9tQXR0cmlidXRlKHZhbHVlLCB0eXBlKSA6IHZhbHVlOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyOwogICAgICAgIGNvbnN0IHRvQXR0cmlidXRlID0gY29udmVydGVyICYmIGNvbnZlcnRlci50b0F0dHJpYnV0ZSB8fCBkZWZhdWx0Q29udmVydGVyLnRvQXR0cmlidXRlOwogICAgICAgIHJldHVybiB0b0F0dHJpYnV0ZSh2YWx1ZSwgdHlwZSk7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gMDsKICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlcyk9PnRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSByZXMKICAgICAgICApOwogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbCgpOwogICAgfQogICAgX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKF92LCBwKT0+ewogICAgICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW3BdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5zZXQocCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBfYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT50aGlzW3BdID0gdgogICAgICAgICk7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgdGhpcy5lbmFibGVVcGRhdGluZygpOwogICAgfQogICAgZW5hYmxlVXBkYXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyKCk7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSB2b2lkIDA7CiAgICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7fQogICAgYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZCwgdmFsdWUpIHsKICAgICAgICBpZiAob2xkICE9PSB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICBfcHJvcGVydHlUb0F0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3B0aW9ucyA9IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uKSB7CiAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgY29uc3QgYXR0ciA9IGN0b3IuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShuYW1lLCBvcHRpb25zKTsKICAgICAgICBpZiAoYXR0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHJWYWx1ZSA9IGN0b3IuX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKGF0dHIsIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURTsKICAgICAgICB9CiAgICB9CiAgICBfYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgY29uc3QgcHJvcE5hbWUgPSBjdG9yLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwLmdldChuYW1lKTsKICAgICAgICBpZiAocHJvcE5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBvcHRpb25zID0gY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMocHJvcE5hbWUpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICAgICAgdGhpc1twcm9wTmFtZV0gPSBjdG9yLl9wcm9wZXJ0eVZhbHVlRnJvbUF0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICB9CiAgICB9CiAgICByZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBsZXQgc2hvdWxkUmVxdWVzdFVwZGF0ZSA9IHRydWU7CiAgICAgICAgaWYgKG5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwgY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSk7CiAgICAgICAgICAgIGlmIChjdG9yLl92YWx1ZUhhc0NoYW5nZWQodGhpc1tuYW1lXSwgb2xkVmFsdWUsIG9wdGlvbnMuaGFzQ2hhbmdlZCkpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuaGFzKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuc2V0KG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHRydWUgJiYgISh0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLnNldChuYW1lLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNob3VsZFJlcXVlc3RVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSAmJiBzaG91bGRSZXF1ZXN0VXBkYXRlKSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSB0aGlzLl9lbnF1ZXVlVXBkYXRlKCk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZShuYW1lLCBvbGRWYWx1ZSkgewogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVDb21wbGV0ZTsKICAgIH0KICAgIGFzeW5jIF9lbnF1ZXVlVXBkYXRlKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm1VcGRhdGUoKTsKICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgYXdhaXQgcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZTsKICAgIH0KICAgIGdldCBfaGFzUmVxdWVzdGVkVXBkYXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICB9CiAgICBnZXQgaGFzVXBkYXRlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiAxOwogICAgfQogICAgcGVyZm9ybVVwZGF0ZSgpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMpIHsKICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgICAgIGNvbnN0IGNoYW5nZWRQcm9wZXJ0aWVzID0gdGhpcy5fY2hhbmdlZFByb3BlcnRpZXM7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdGhpcy5zaG91bGRVcGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoISh0aGlzLl91cGRhdGVTdGF0ZSAmIDEpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSEFTX1VQREFURUQ7CiAgICAgICAgICAgICAgICB0aGlzLmZpcnN0VXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGVkKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICB9CiAgICB9CiAgICBfbWFya1VwZGF0ZWQoKSB7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IHVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgX2dldFVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldFVwZGF0ZUNvbXBsZXRlKCk7CiAgICB9CiAgICBnZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlUHJvbWlzZTsKICAgIH0KICAgIHNob3VsZFVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBpZiAodGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgIT09IHZvaWQgMCAmJiB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fcHJvcGVydHlUb0F0dHJpYnV0ZShrLCB0aGlzW2tdLCB2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgIH0KICAgIHVwZGF0ZWQoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7fQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykge30KfQpfYSA9IGZpbmFsaXplZDsKVXBkYXRpbmdFbGVtZW50W19hXSA9IHRydWU7CmNvbnN0IEVsZW1lbnRQcm90byA9IEVsZW1lbnQucHJvdG90eXBlOwpFbGVtZW50UHJvdG8ubXNNYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudFByb3RvLndlYmtpdE1hdGNoZXNTZWxlY3RvcjsKY29uc3Qgc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzID0gd2luZG93LlNoYWRvd1Jvb3QgJiYgKHdpbmRvdy5TaGFkeUNTUyA9PT0gdm9pZCAwIHx8IHdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpICYmICJhZG9wdGVkU3R5bGVTaGVldHMiIGluIERvY3VtZW50LnByb3RvdHlwZSAmJiAicmVwbGFjZSIgaW4gQ1NTU3R5bGVTaGVldC5wcm90b3R5cGU7CmNvbnN0IGNvbnN0cnVjdGlvblRva2VuID0gU3ltYm9sKCk7CmNsYXNzIENTU1Jlc3VsdCB7CiAgICBjb25zdHJ1Y3Rvcihjc3NUZXh0LCBzYWZlVG9rZW4pewogICAgICAgIGlmIChzYWZlVG9rZW4gIT09IGNvbnN0cnVjdGlvblRva2VuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ1NTUmVzdWx0IGlzIG5vdCBjb25zdHJ1Y3RhYmxlLiBVc2UgYHVuc2FmZUNTU2Agb3IgYGNzc2AgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgIH0KICAgIGdldCBzdHlsZVNoZWV0KCkgewogICAgICAgIGlmICh0aGlzLl9zdHlsZVNoZWV0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0LnJlcGxhY2VTeW5jKHRoaXMuY3NzVGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmNzc1RleHQ7CiAgICB9Cn0KY29uc3QgdW5zYWZlQ1NTID0gKHZhbHVlKT0+ewogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoU3RyaW5nKHZhbHVlKSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owpjb25zdCB0ZXh0RnJvbUNTU1Jlc3VsdCA9ICh2YWx1ZSk9PnsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENTU1Jlc3VsdCkgewogICAgICAgIHJldHVybiB2YWx1ZS5jc3NUZXh0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZhbHVlIHBhc3NlZCB0byAnY3NzJyBmdW5jdGlvbiBtdXN0IGJlIGEgJ2NzcycgZnVuY3Rpb24gcmVzdWx0OiAke3ZhbHVlfS4gVXNlICd1bnNhZmVDU1MnIHRvIHBhc3Mgbm9uLWxpdGVyYWwgdmFsdWVzLCBidXQKICAgICAgICAgICAgdGFrZSBjYXJlIHRvIGVuc3VyZSBwYWdlIHNlY3VyaXR5LmApOwogICAgfQp9Owpjb25zdCBjc3MgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+ewogICAgY29uc3QgY3NzVGV4dCA9IHZhbHVlcy5yZWR1Y2UoKGFjYywgdiwgaWR4KT0+YWNjICsgdGV4dEZyb21DU1NSZXN1bHQodikgKyBzdHJpbmdzW2lkeCArIDFdCiAgICAsIHN0cmluZ3NbMF0pOwogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoY3NzVGV4dCwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owood2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSB8fCAod2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSA9IFtdKSkucHVzaCgiMi41LjEiKTsKY29uc3QgcmVuZGVyTm90SW1wbGVtZW50ZWQgPSB7fTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKYXN5bmMgZnVuY3Rpb24gbGlzdER1cmFibGVPYmplY3RzTmFtZXNwYWNlcyhhY2NvdW50SWQsIGFwaVRva2VuKSB7CiAgICBjb25zdCB1cmwgPSBgJHtjb21wdXRlQWNjb3VudEJhc2VVcmwoYWNjb3VudElkKX0vd29ya2Vycy9kdXJhYmxlX29iamVjdHMvbmFtZXNwYWNlc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3REdXJhYmxlT2JqZWN0c05hbWVzcGFjZXMnLCAnR0VUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQphc3luYyBmdW5jdGlvbiBsaXN0U2NyaXB0cyhhY2NvdW50SWQsIGFwaVRva2VuKSB7CiAgICBjb25zdCB1cmwgPSBgJHtjb21wdXRlQWNjb3VudEJhc2VVcmwoYWNjb3VudElkKX0vd29ya2Vycy9zY3JpcHRzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnbGlzdFNjcmlwdHMnLCAnR0VUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQphc3luYyBmdW5jdGlvbiBsaXN0VGFpbHMoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnbGlzdFRhaWxzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gY3JlYXRlVGFpbChhY2NvdW50SWQsIHNjcmlwdE5hbWUsIGFwaVRva2VuKSB7CiAgICBjb25zdCB1cmwgPSBgJHtjb21wdXRlQWNjb3VudEJhc2VVcmwoYWNjb3VudElkKX0vd29ya2Vycy9zY3JpcHRzLyR7c2NyaXB0TmFtZX0vdGFpbHNgOwogICAgcmV0dXJuIChhd2FpdCBleGVjdXRlKCdjcmVhdGVUYWlsJywgJ1BPU1QnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmNsYXNzIENsb3VkZmxhcmVBcGkgewogICAgc3RhdGljIERFQlVHID0gZmFsc2U7CiAgICBzdGF0aWMgVVJMX1RSQU5TRk9STUVSID0gKHYpPT52CiAgICA7Cn0KY29uc3QgQVBQTElDQVRJT05fSlNPTiA9ICdhcHBsaWNhdGlvbi9qc29uJzsKY29uc3QgQVBQTElDQVRJT05fSlNPTl9VVEY4ID0gJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9VVRGLTgnOwpjb25zdCBBUFBMSUNBVElPTl9PQ1RFVF9TVFJFQU0gPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJzsKY29uc3QgVEVYVF9QTEFJTl9VVEY4ID0gJ3RleHQvcGxhaW47IGNoYXJzZXQ9VVRGLTgnOwpmdW5jdGlvbiBjb21wdXRlQWNjb3VudEJhc2VVcmwoYWNjb3VudElkKSB7CiAgICByZXR1cm4gQ2xvdWRmbGFyZUFwaS5VUkxfVFJBTlNGT1JNRVIoYGh0dHBzOi8vYXBpLmNsb3VkZmxhcmUuY29tL2NsaWVudC92NC9hY2NvdW50cy8ke2FjY291bnRJZH1gKTsKfQpmdW5jdGlvbiBpc1N0cmluZ1JlY29yZChvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkob2JqKSAmJiBvYmouY29uc3RydWN0b3IgPT09IE9iamVjdDsKfQphc3luYyBmdW5jdGlvbiBleGVjdXRlKG9wLCBtZXRob2QsIHVybCwgYXBpVG9rZW4sIGJvZHksIHJlc3BvbnNlVHlwZSA9ICdqc29uJykgewogICAgaWYgKENsb3VkZmxhcmVBcGkuREVCVUcpIGNvbnNvbGUubG9nKGAke29wfTogJHttZXRob2R9ICR7dXJsfWApOwogICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKHsKICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthcGlUb2tlbn1gCiAgICB9KTsKICAgIGlmICh0eXBlb2YgYm9keSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBoZWFkZXJzLnNldCgnQ29udGVudC1UeXBlJywgVEVYVF9QTEFJTl9VVEY4KTsKICAgIH0gZWxzZSBpZiAoaXNTdHJpbmdSZWNvcmQoYm9keSkpIHsKICAgICAgICBoZWFkZXJzLnNldCgnQ29udGVudC1UeXBlJywgQVBQTElDQVRJT05fSlNPTl9VVEY4KTsKICAgICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoYm9keSk7CiAgICAgICAgaWYgKENsb3VkZmxhcmVBcGkuREVCVUcpIGNvbnNvbGUubG9nKGJvZHkpOwogICAgfQogICAgY29uc3QgZmV0Y2hSZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwgewogICAgICAgIG1ldGhvZCwKICAgICAgICBoZWFkZXJzLAogICAgICAgIGJvZHkKICAgIH0pOwogICAgaWYgKENsb3VkZmxhcmVBcGkuREVCVUcpIGNvbnNvbGUubG9nKGAke2ZldGNoUmVzcG9uc2Uuc3RhdHVzfSAke2ZldGNoUmVzcG9uc2UudXJsfWApOwogICAgaWYgKENsb3VkZmxhcmVBcGkuREVCVUcpIGNvbnNvbGUubG9nKFsKICAgICAgICAuLi5mZXRjaFJlc3BvbnNlLmhlYWRlcnMKICAgIF0ubWFwKCh2KT0+di5qb2luKCc6ICcpCiAgICApLmpvaW4oJ1xuJykpOwogICAgY29uc3QgY29udGVudFR5cGUgPSBmZXRjaFJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKSB8fCAnJzsKICAgIGlmICgocmVzcG9uc2VUeXBlID09PSAnYnl0ZXMnIHx8IHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzPycpICYmIGNvbnRlbnRUeXBlID09PSBBUFBMSUNBVElPTl9PQ1RFVF9TVFJFQU0pIHsKICAgICAgICBjb25zdCBidWZmZXIgPSBhd2FpdCBmZXRjaFJlc3BvbnNlLmFycmF5QnVmZmVyKCk7CiAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgICB9CiAgICBpZiAocmVzcG9uc2VUeXBlID09PSAndGV4dD8nICYmIGNvbnRlbnRUeXBlLnN0YXJ0c1dpdGgoJ3RleHQvJykpIHsKICAgICAgICByZXR1cm4gYXdhaXQgZmV0Y2hSZXNwb25zZS50ZXh0KCk7CiAgICB9CiAgICBpZiAoIVsKICAgICAgICBBUFBMSUNBVElPTl9KU09OX1VURjgsCiAgICAgICAgQVBQTElDQVRJT05fSlNPTgogICAgXS5pbmNsdWRlcyhjb250ZW50VHlwZSkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgY29udGVudC10eXBlOiAke2NvbnRlbnRUeXBlfSwgZmV0Y2hSZXNwb25zZT0ke2ZldGNoUmVzcG9uc2V9LCBib2R5PSR7YXdhaXQgZmV0Y2hSZXNwb25zZS50ZXh0KCl9YCk7CiAgICB9CiAgICBjb25zdCBhcGlSZXNwb25zZSA9IGF3YWl0IGZldGNoUmVzcG9uc2UuanNvbigpOwogICAgaWYgKENsb3VkZmxhcmVBcGkuREVCVUcpIGNvbnNvbGUubG9nKGFwaVJlc3BvbnNlKTsKICAgIGlmICghYXBpUmVzcG9uc2Uuc3VjY2VzcykgewogICAgICAgIGlmIChmZXRjaFJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0ICYmIFsKICAgICAgICAgICAgJ2J5dGVzPycsCiAgICAgICAgICAgICdqc29uPycKICAgICAgICBdLmluY2x1ZGVzKHJlc3BvbnNlVHlwZSkpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgdGhyb3cgbmV3IENsb3VkZmxhcmVBcGlFcnJvcihgJHtvcH0gZmFpbGVkOiBzdGF0dXM9JHtmZXRjaFJlc3BvbnNlLnN0YXR1c30sIGVycm9ycz0ke2FwaVJlc3BvbnNlLmVycm9ycy5tYXAoKHYpPT5gJHt2LmNvZGV9ICR7di5tZXNzYWdlfWAKICAgICAgICApLmpvaW4oJywgJyl9YCwgZmV0Y2hSZXNwb25zZS5zdGF0dXMsIGFwaVJlc3BvbnNlLmVycm9ycyk7CiAgICB9CiAgICByZXR1cm4gYXBpUmVzcG9uc2U7Cn0KY2xhc3MgQ2xvdWRmbGFyZUFwaUVycm9yIGV4dGVuZHMgRXJyb3IgewogICAgc3RhdHVzOwogICAgZXJyb3JzOwogICAgY29uc3RydWN0b3IobWVzc2FnZSwgc3RhdHVzLCBlcnJvcnMpewogICAgICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgICAgIHRoaXMuZXJyb3JzID0gZXJyb3JzOwogICAgfQp9CmZ1bmN0aW9uIHNldFN1YnRyYWN0KGxocywgcmhzKSB7CiAgICBjb25zdCBydCA9IG5ldyBTZXQobGhzKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiByaHMpewogICAgICAgIHJ0LmRlbGV0ZShpdGVtKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBzZXRVbmlvbihsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KGxocyk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmhzKXsKICAgICAgICBydC5hZGQoaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0SW50ZXJzZWN0KGxocywgcmhzKSB7CiAgICBjb25zdCBydCA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBsaHMpewogICAgICAgIGlmIChyaHMuaGFzKGl0ZW0pKSBydC5hZGQoaXRlbSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGl0ZW0xIG9mIHJocyl7CiAgICAgICAgaWYgKGxocy5oYXMoaXRlbTEpKSBydC5hZGQoaXRlbTEpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldEVxdWFsKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLnNpemUgPT09IHJocy5zaXplICYmIFsKICAgICAgICAuLi5saHMKICAgIF0uZXZlcnkoKHYpPT5yaHMuaGFzKHYpCiAgICApOwp9CmZ1bmN0aW9uIHBhcnNlSGVhZGVyRmlsdGVyKGhlYWRlcikgewogICAgY29uc3QgaSA9IGhlYWRlci5pbmRleE9mKCc6Jyk7CiAgICBpZiAoaSA8IDApIHJldHVybiB7CiAgICAgICAga2V5OiBoZWFkZXIKICAgIH07CiAgICBjb25zdCBrZXkgPSBoZWFkZXIuc3Vic3RyaW5nKDAsIGkpLnRyaW0oKTsKICAgIGNvbnN0IHF1ZXJ5MSA9IGhlYWRlci5zdWJzdHJpbmcoaSArIDEpLnRyaW0oKTsKICAgIHJldHVybiB7CiAgICAgICAga2V5LAogICAgICAgIHF1ZXJ5OiBxdWVyeTEKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0tFWVMgPSBuZXcgU2V0KFsKICAgICdvdXRjb21lJywKICAgICdzY3JpcHROYW1lJywKICAgICdleGNlcHRpb25zJywKICAgICdsb2dzJywKICAgICdldmVudFRpbWVzdGFtcCcsCiAgICAnZXZlbnQnCl0pOwpjb25zdCBLTk9XTl9PVVRDT01FUyA9IG5ldyBTZXQoWwogICAgJ29rJywKICAgICdleGNlcHRpb24nLAogICAgJ2V4Y2VlZGVkQ3B1JywKICAgICdjYW5jZWxlZCcsCiAgICAndW5rbm93bicKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2Uob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2U6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCB7IG91dGNvbWUgLCBzY3JpcHROYW1lICwgZXZlbnRUaW1lc3RhbXAgIH0gPSBvYmpBc0FueTsKICAgIGlmICghS05PV05fT1VUQ09NRVMuaGFzKG91dGNvbWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBvdXRjb21lOiBleHBlY3RlZCBvbmUgb2YgWyR7WwogICAgICAgIC4uLktOT1dOX09VVENPTUVTCiAgICBdLmpvaW4oJywgJyl9XSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvdXRjb21lKX1gKTsKICAgIGlmIChzY3JpcHROYW1lICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBzY3JpcHROYW1lOiBleHBlY3RlZCBudWxsLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHNjcmlwdE5hbWUpfWApOwogICAgY29uc3QgbG9ncyA9IHBhcnNlTG9ncyhvYmpBc0FueS5sb2dzKTsKICAgIGNvbnN0IGV4Y2VwdGlvbnMgPSBwYXJzZUV4Y2VwdGlvbnMob2JqQXNBbnkuZXhjZXB0aW9ucyk7CiAgICBpZiAoISh0eXBlb2YgZXZlbnRUaW1lc3RhbXAgPT09ICdudW1iZXInICYmIGV2ZW50VGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIGV2ZW50VGltZXN0YW1wOiBleHBlY3RlZCBwb3NpdGl2ZSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoZXZlbnRUaW1lc3RhbXApfWApOwogICAgY29uc3QgZXZlbnQgPSBvYmpBc0FueS5ldmVudCAmJiBvYmpBc0FueS5ldmVudC5yZXF1ZXN0ID8gcGFyc2VUYWlsTWVzc2FnZVJlcXVlc3RFdmVudChvYmpBc0FueS5ldmVudCkgOiBwYXJzZVRhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iakFzQW55LmV2ZW50KTsKICAgIHJldHVybiB7CiAgICAgICAgb3V0Y29tZSwKICAgICAgICBzY3JpcHROYW1lLAogICAgICAgIGV4Y2VwdGlvbnMsCiAgICAgICAgbG9ncywKICAgICAgICBldmVudFRpbWVzdGFtcCwKICAgICAgICBldmVudAogICAgfTsKfQpmdW5jdGlvbiBwYXJzZUxvZ3Mob2JqKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbG9nczogZXhwZWN0ZWQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBbCiAgICAgICAgLi4ub2JqCiAgICBdLm1hcChwYXJzZVRhaWxNZXNzYWdlTG9nKTsKfQpmdW5jdGlvbiBwYXJzZUV4Y2VwdGlvbnMob2JqKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgZXhjZXB0aW9uczogZXhwZWN0ZWQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBbCiAgICAgICAgLi4ub2JqCiAgICBdLm1hcChwYXJzZVRhaWxNZXNzYWdlRXhjZXB0aW9uKTsKfQpmdW5jdGlvbiBpc0xvZ01lc3NhZ2VQYXJ0KHZhbHVlKSB7CiAgICBjb25zdCB0ID0gdHlwZW9mIHZhbHVlOwogICAgcmV0dXJuIHQgPT09ICdzdHJpbmcnIHx8IHQgPT09ICdudW1iZXInIHx8IHQgPT09ICdib29sZWFuJyB8fCB0ID09PSAndW5kZWZpbmVkJyB8fCB0ID09PSAnb2JqZWN0JzsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfTE9HX0tFWVMgPSBuZXcgU2V0KFsKICAgICdtZXNzYWdlJywKICAgICdsZXZlbCcsCiAgICAndGltZXN0YW1wJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUxvZyhvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUxvZzogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfTE9HX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCBtZXNzYWdlID0gcGFyc2VMb2dNZXNzYWdlUGFydEFycmF5KG9iakFzQW55Lm1lc3NhZ2UsICdtZXNzYWdlJyk7CiAgICBjb25zdCB7IGxldmVsICwgdGltZXN0YW1wICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgbGV2ZWwgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbGV2ZWw6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShsZXZlbCl9YCk7CiAgICBpZiAoISh0eXBlb2YgdGltZXN0YW1wID09PSAnbnVtYmVyJyAmJiB0aW1lc3RhbXAgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGltZXN0YW1wOiBleHBlY3RlZCBwb3NpdGl2ZSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkodGltZXN0YW1wKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgbWVzc2FnZSwKICAgICAgICBsZXZlbCwKICAgICAgICB0aW1lc3RhbXAKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VYQ0VQVElPTl9LRVlTID0gbmV3IFNldChbCiAgICAnbmFtZScsCiAgICAnbWVzc2FnZScsCiAgICAndGltZXN0YW1wJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUV4Y2VwdGlvbihvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUV4Y2VwdGlvbjogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVhDRVBUSU9OX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCB7IG5hbWUgLCBtZXNzYWdlICwgdGltZXN0YW1wICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBuYW1lOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobmFtZSl9YCk7CiAgICBpZiAoISh0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBtZXNzYWdlOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobWVzc2FnZSl9YCk7CiAgICBpZiAoISh0eXBlb2YgdGltZXN0YW1wID09PSAnbnVtYmVyJyAmJiB0aW1lc3RhbXAgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGltZXN0YW1wOiBleHBlY3RlZCBwb3NpdGl2ZSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkodGltZXN0YW1wKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgbmFtZSwKICAgICAgICBtZXNzYWdlLAogICAgICAgIHRpbWVzdGFtcAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfQ1JPTl9FVkVOVF9LRVlTID0gbmV3IFNldChbCiAgICAnY3JvbicsCiAgICAnc2NoZWR1bGVkVGltZScKXSk7CmZ1bmN0aW9uIGlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgcmV0dXJuIGZhbHNlOwogICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoT2JqZWN0LmtleXMob2JqKSk7CiAgICByZXR1cm4gc2V0RXF1YWwoa2V5cywgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyk7Cn0KZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUNyb25FdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUNyb25FdmVudDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfQ1JPTl9FVkVOVF9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBjcm9uICwgc2NoZWR1bGVkVGltZSAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIGNyb24gPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgY3JvbjogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KGNyb24pfWApOwogICAgaWYgKCEodHlwZW9mIHNjaGVkdWxlZFRpbWUgPT09ICdudW1iZXInICYmIHNjaGVkdWxlZFRpbWUgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgc2NoZWR1bGVkVGltZTogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHNjaGVkdWxlZFRpbWUpfWApOwogICAgcmV0dXJuIHsKICAgICAgICBjcm9uLAogICAgICAgIHNjaGVkdWxlZFRpbWUKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX1JFUVVFU1RfRVZFTlRfS0VZUyA9IG5ldyBTZXQoWwogICAgJ3JlcXVlc3QnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50OiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9SRVFVRVNUX0VWRU5UX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCByZXF1ZXN0ID0gcGFyc2VUYWlsTWVzc2FnZUV2ZW50UmVxdWVzdChvYmpBc0FueS5yZXF1ZXN0KTsKICAgIHJldHVybiB7CiAgICAgICAgcmVxdWVzdAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTID0gbmV3IFNldChbCiAgICAndXJsJywKICAgICdtZXRob2QnLAogICAgJ2hlYWRlcnMnCl0pOwpjb25zdCBPUFRJT05BTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTID0gbmV3IFNldChbCiAgICAnY2YnCl0pOwpjb25zdCBBTExfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IHNldFVuaW9uKFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMsIE9QVElPTkFMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMpOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlRXZlbnRSZXF1ZXN0KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlRXZlbnRSZXF1ZXN0OiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMsIEFMTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyB1cmwgLCBtZXRob2QgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdXJsOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkodXJsKX1gKTsKICAgIGlmICghKHR5cGVvZiBtZXRob2QgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWV0aG9kOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobWV0aG9kKX1gKTsKICAgIGNvbnN0IGhlYWRlcnMgPSBwYXJzZVN0cmluZ1JlY29yZChvYmpBc0FueS5oZWFkZXJzLCAnaGVhZGVycycpOwogICAgY29uc3QgY2YgPSBvYmpBc0FueS5jZiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogcGFyc2VJbmNvbWluZ1JlcXVlc3RDZlByb3BlcnRpZXMob2JqQXNBbnkuY2YpOwogICAgcmV0dXJuIHsKICAgICAgICB1cmwsCiAgICAgICAgbWV0aG9kLAogICAgICAgIGhlYWRlcnMsCiAgICAgICAgY2YKICAgIH07Cn0KZnVuY3Rpb24gY2hlY2tLZXlzKG9iaiwgcmVxdWlyZWRLZXlzLCBhbGxLZXlzKSB7CiAgICBjb25zdCBrZXlzID0gbmV3IFNldChPYmplY3Qua2V5cyhvYmopKTsKICAgIGNvbnN0IG1pc3NpbmdLZXlzID0gc2V0U3VidHJhY3QocmVxdWlyZWRLZXlzLCBrZXlzKTsKICAgIGlmIChtaXNzaW5nS2V5cy5zaXplID4gMCkgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGtleXM6ICR7WwogICAgICAgIC4uLm1pc3NpbmdLZXlzCiAgICBdLmpvaW4oJywgJyl9YCk7CiAgICBjb25zdCBleHRyYUtleXMgPSBzZXRTdWJ0cmFjdChrZXlzLCBhbGxLZXlzIHx8IHJlcXVpcmVkS2V5cyk7CiAgICBpZiAoZXh0cmFLZXlzLnNpemUgPiAwKSB0aHJvdyBuZXcgRXJyb3IoYEV4dHJhIGtleXM6ICR7WwogICAgICAgIC4uLmV4dHJhS2V5cwogICAgXS5qb2luKCcsICcpfWApOwp9CmZ1bmN0aW9uIHBhcnNlU3RyaW5nUmVjb3JkKG9iaiwgbmFtZSkgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IEV4cGVjdGVkIHN0cmluZyByZWNvcmQsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGZvciAoY29uc3QgW18sIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKXsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogRXhwZWN0ZWQgc3RyaW5nIHJlY29yZCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgfQogICAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBwYXJzZUxvZ01lc3NhZ2VQYXJ0QXJyYXkob2JqLCBuYW1lKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgIUFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogRXhwZWN0ZWQgbG9nIG1lc3NhZ2UgcGFydCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiBvYmopewogICAgICAgIGlmICghaXNMb2dNZXNzYWdlUGFydCh2YWx1ZSkpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IEV4cGVjdGVkIGxvZyBtZXNzYWdlIHBhcnQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIH0KICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gcGFyc2VJbmNvbWluZ1JlcXVlc3RDZlByb3BlcnRpZXMob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgY2Y6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBkdW1wTWVzc2FnZVByZXR0eShtZXNzYWdlLCBsb2dnZXIsIGFkZGl0aW9uYWxMb2dzID0gW10pIHsKICAgIGNvbnN0IHRpbWUgPSBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKG1lc3NhZ2UuZXZlbnRUaW1lc3RhbXApKTsKICAgIGNvbnN0IG91dGNvbWUgPSBQUkVUVFlfT1VUQ09NRVMuZ2V0KG1lc3NhZ2Uub3V0Y29tZSkgfHwgbWVzc2FnZS5vdXRjb21lOwogICAgY29uc3Qgb3V0Y29tZUNvbG9yID0gbWVzc2FnZS5vdXRjb21lID09PSAnb2snID8gJ2dyZWVuJyA6ICdyZWQnOwogICAgY29uc3QgeyBwcm9wcyAsIHJlbWFpbmluZ0xvZ3MgIH0gPSBwYXJzZUxvZ1Byb3BzKG1lc3NhZ2UubG9ncyk7CiAgICBpZiAoaXNUYWlsTWVzc2FnZUNyb25FdmVudChtZXNzYWdlLmV2ZW50KSkgewogICAgICAgIGNvbnN0IGNvbG8gPSBwcm9wcy5jb2xvIHx8ICc/Pz8nOwogICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gJWMke21lc3NhZ2UuZXZlbnQuY3Jvbn1gLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtvdXRjb21lQ29sb3J9YCwgJycsICdjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkOycpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCB7IG1ldGhvZCAsIHVybCAsIGNmICB9ID0gbWVzc2FnZS5ldmVudC5yZXF1ZXN0OwogICAgICAgIGNvbnN0IHVucmVkYWN0ZWRVcmwgPSB0eXBlb2YgcHJvcHMudXJsID09PSAnc3RyaW5nJyA/IHByb3BzLnVybCA6IHVybDsKICAgICAgICBjb25zdCBjb2xvID0gY2Y/LmNvbG8gfHwgcHJvcHMuY29sbyB8fCAnPz8/JzsKICAgICAgICBpZiAoY2YgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb25zdCB7IGR1cmFibGVPYmplY3RDbGFzcyAsIGR1cmFibGVPYmplY3ROYW1lICwgZHVyYWJsZU9iamVjdElkICB9ID0gY29tcHV0ZUR1cmFibGVPYmplY3RJbmZvKHByb3BzKTsKICAgICAgICAgICAgY29uc3QgZG9UZW1wbGF0ZXMgPSBbXTsKICAgICAgICAgICAgY29uc3QgZG9TdHlsZXMgPSBbXTsKICAgICAgICAgICAgaWYgKGR1cmFibGVPYmplY3RDbGFzcykgewogICAgICAgICAgICAgICAgZG9UZW1wbGF0ZXMucHVzaChgJWMke2R1cmFibGVPYmplY3RDbGFzc30lY2ApOwogICAgICAgICAgICAgICAgZG9TdHlsZXMucHVzaChgY29sb3I6IGdyYXk7IHgtZHVyYWJsZS1vYmplY3QtY2xhc3M6ICcke2R1cmFibGVPYmplY3RDbGFzc30nYCwgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkdXJhYmxlT2JqZWN0TmFtZSkgewogICAgICAgICAgICAgICAgZG9UZW1wbGF0ZXMucHVzaChgJWMke2R1cmFibGVPYmplY3ROYW1lfSVjYCk7CiAgICAgICAgICAgICAgICBkb1N0eWxlcy5wdXNoKGBjb2xvcjogZ3JheTsgeC1kdXJhYmxlLW9iamVjdC1uYW1lOiAnJHtkdXJhYmxlT2JqZWN0TmFtZX0nYCwgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkdXJhYmxlT2JqZWN0SWQpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtjb21wdXRlU2hvcnREdXJhYmxlT2JqZWN0SWQoZHVyYWJsZU9iamVjdElkKX0lY2ApOwogICAgICAgICAgICAgICAgZG9TdHlsZXMucHVzaChgY29sb3I6IGdyYXk7IHgtZHVyYWJsZS1vYmplY3QtaWQ6ICcke2R1cmFibGVPYmplY3RJZH0nYCwgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb1RlbXBsYXRlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjRE8lY2ApOwogICAgICAgICAgICAgICAgZG9TdHlsZXMucHVzaCgnY29sb3I6IGdyYXknLCAnJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSBbJHtkb1RlbXBsYXRlcy5qb2luKCcgJyl9XSAke21ldGhvZH0gJWMke3VucmVkYWN0ZWRVcmx9YCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6ICR7b3V0Y29tZUNvbG9yfWAsICcnLCAuLi5kb1N0eWxlcywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSAke21ldGhvZH0gJWMke3VucmVkYWN0ZWRVcmx9YCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6ICR7b3V0Y29tZUNvbG9yfWAsICcnLCAnY29sb3I6IHJlZDsgZm9udC1zdHlsZTogYm9sZDsnKTsKICAgICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IHsgZGF0YTogZGF0YTIgIH0gb2YgYWRkaXRpb25hbExvZ3MpewogICAgICAgIGxvZ2dlciguLi5kYXRhMik7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsgbGV2ZWwgLCBtZXNzYWdlOiBsb2dNZXNzYWdlICB9IG9mIHJlbWFpbmluZ0xvZ3MpewogICAgICAgIGNvbnN0IGxldmVsQ29sb3IgPSBMT0dfTEVWRUxfQ09MT1JTLmdldChsZXZlbCkgfHwgJ2dyYXknOwogICAgICAgIGNvbnN0IGxvZ01lc3NhZ2VzID0gbG9nTWVzc2FnZS5tYXAoZm9ybWF0TG9nTWVzc2FnZVBhcnQpLmpvaW4oJywgJyk7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtsZXZlbH0lY10gJHtsb2dNZXNzYWdlc31gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke2xldmVsQ29sb3J9YCwgJycpOwogICAgfQogICAgZm9yIChjb25zdCB7IG5hbWUgLCBtZXNzYWdlOiBleGNlcHRpb25NZXNzYWdlICB9IG9mIG1lc3NhZ2UuZXhjZXB0aW9ucyl7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtuYW1lfSVjXSAlYyR7ZXhjZXB0aW9uTWVzc2FnZX1gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGRgLCAnJywgJ2NvbG9yOiByZWQnKTsKICAgIH0KfQpmdW5jdGlvbiBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKGRhdGUpIHsKICAgIHJldHVybiBbCiAgICAgICAgZGF0ZS5nZXRGdWxsWWVhcigpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0TW9udGgoKSArIDEpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0RGF0ZSgpKSwKICAgICAgICAnICcsCiAgICAgICAgcGFkMihkYXRlLmdldEhvdXJzKCkpLAogICAgICAgICc6JywKICAgICAgICBwYWQyKGRhdGUuZ2V0TWludXRlcygpKSwKICAgICAgICAnOicsCiAgICAgICAgcGFkMihkYXRlLmdldFNlY29uZHMoKSkKICAgIF0uam9pbignJyk7Cn0KZnVuY3Rpb24gcGFyc2VMb2dQcm9wcyhsb2dzKSB7CiAgICBjb25zdCByZW1haW5pbmdMb2dzID0gW107CiAgICBjb25zdCBwcm9wcyA9IHt9OwogICAgZm9yIChjb25zdCBsb2cgb2YgbG9ncyl7CiAgICAgICAgaWYgKGxvZy5tZXNzYWdlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgbXNnID0gbG9nLm1lc3NhZ2VbMF07CiAgICAgICAgICAgIGlmICh0eXBlb2YgbXNnID09PSAnc3RyaW5nJyAmJiBtc2cuc3RhcnRzV2l0aCgnbG9ncHJvcHM6JykpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsZXIgPSBtc2cuc3Vic3RyaW5nKG1zZy5pbmRleE9mKCc6JykgKyAxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsZXJQcm9wcyA9IHRyeVBhcnNlUHJvcHNGcm9tSnNvbih0cmFpbGVyKTsKICAgICAgICAgICAgICAgIGFwcGVuZFByb3BzKHRyYWlsZXJQcm9wcywgcHJvcHMpOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIGxvZy5tZXNzYWdlLnNsaWNlKDEpKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJ0UHJvcHMgPSB0cnlQYXJzZVByb3BzRnJvbVBhcnQocGFydCk7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kUHJvcHMocGFydFByb3BzLCBwcm9wcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZW1haW5pbmdMb2dzLnB1c2gobG9nKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgcHJvcHMsCiAgICAgICAgcmVtYWluaW5nTG9ncwogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlRHVyYWJsZU9iamVjdEluZm8ocHJvcHMpIHsKICAgIGNvbnN0IGR1cmFibGVPYmplY3RDbGFzcyA9IHVuZGVmaW5lZElmRW1wdHkoKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0Q2xhc3MgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdENsYXNzIDogJycpLnRyaW0oKSk7CiAgICBjb25zdCBkdXJhYmxlT2JqZWN0SWQgPSB1bmRlZmluZWRJZkVtcHR5KCh0eXBlb2YgcHJvcHMuZHVyYWJsZU9iamVjdElkID09PSAnc3RyaW5nJyA/IHByb3BzLmR1cmFibGVPYmplY3RJZCA6ICcnKS50cmltKCkpOwogICAgY29uc3QgZHVyYWJsZU9iamVjdE5hbWUgPSB1bmRlZmluZWRJZkVtcHR5KCh0eXBlb2YgcHJvcHMuZHVyYWJsZU9iamVjdE5hbWUgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdE5hbWUgOiAnJykudHJpbSgpKTsKICAgIHJldHVybiB7CiAgICAgICAgZHVyYWJsZU9iamVjdENsYXNzLAogICAgICAgIGR1cmFibGVPYmplY3RJZCwKICAgICAgICBkdXJhYmxlT2JqZWN0TmFtZQogICAgfTsKfQpmdW5jdGlvbiB1bmRlZmluZWRJZkVtcHR5KHN0cikgewogICAgcmV0dXJuIHN0ciA9PT0gJycgPyB1bmRlZmluZWQgOiBzdHI7Cn0KZnVuY3Rpb24gY29tcHV0ZVNob3J0RHVyYWJsZU9iamVjdElkKGlkKSB7CiAgICByZXR1cm4gL15bMC05YS1mQS1GXXs1LH0kLy50ZXN0KGlkKSA/IGAke2lkLnN1YnN0cmluZygwLCA0KX3igKZgIDogaWQ7Cn0KZnVuY3Rpb24gYXBwZW5kUHJvcHMoc3JjLCBkc3QpIHsKICAgIGlmIChzcmMpIHsKICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzcmMpKXsKICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gdHJ5UGFyc2VQcm9wc0Zyb21Kc29uKHZhbHVlKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IHByb3BzID0gSlNPTi5wYXJzZSh2YWx1ZS50cmltKCkpOwogICAgICAgIGlmICh0eXBlb2YgcHJvcHMgPT09ICdvYmplY3QnICYmIHByb3BzICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KHByb3BzKSkgewogICAgICAgICAgICByZXR1cm4gcHJvcHM7CiAgICAgICAgfQogICAgfSBjYXRjaCAge30KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gdHJ5UGFyc2VQcm9wc0Zyb21QYXJ0KHBhcnQpIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKHR5cGVvZiBwYXJ0ID09PSAnb2JqZWN0JyAmJiBwYXJ0ICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KHBhcnQpKSB7CiAgICAgICAgICAgIHJldHVybiBwYXJ0OwogICAgICAgIH0KICAgIH0gY2F0Y2ggIHt9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGZvcm1hdExvZ01lc3NhZ2VQYXJ0KHBhcnQpIHsKICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcpIHJldHVybiBKU09OLnN0cmluZ2lmeShwYXJ0KTsKICAgIHJldHVybiBgJHtwYXJ0fWA7Cn0KZnVuY3Rpb24gcGFkMihudW0pIHsKICAgIHJldHVybiBudW0udG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpOwp9CmNvbnN0IFBSRVRUWV9PVVRDT01FUyA9IG5ldyBNYXAoWwogICAgWwogICAgICAgICdvaycsCiAgICAgICAgJ09rJwogICAgXSwKICAgIFsKICAgICAgICAnZXhjZXB0aW9uJywKICAgICAgICAnRXJyb3InCiAgICBdLAogICAgWwogICAgICAgICdleGNlZWRlZENwdScsCiAgICAgICAgJ0V4Y2VlZGVkIExpbWl0JwogICAgXSwKICAgIFsKICAgICAgICAnY2FuY2VsZWQnLAogICAgICAgICdDYW5jZWxlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ3Vua25vd24nLAogICAgICAgICdVbmtub3duJwogICAgXSwgCl0pOwpjb25zdCBMT0dfTEVWRUxfQ09MT1JTID0gbmV3IE1hcChbCiAgICBbCiAgICAgICAgJ3RyYWNlJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2RlYnVnJywKICAgICAgICAncHVycGxlJwogICAgXSwKICAgIFsKICAgICAgICAnbG9nJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2luZm8nLAogICAgICAgICdncmF5JwogICAgXSwKICAgIFsKICAgICAgICAnd2FybicsCiAgICAgICAgJ3JlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ2Vycm9yJywKICAgICAgICAncmVkJwogICAgXSwgCl0pOwpjbGFzcyBUYWlsQ29ubmVjdGlvbiB7CiAgICBzdGF0aWMgVkVSQk9TRSA9IGZhbHNlOwogICAgd3M7CiAgICBjYWxsYmFja3M7CiAgICBvcHRpb25zOwogICAgaGVhcnRiZWF0SWQ7CiAgICBjb25zdHJ1Y3Rvcih3ZWJTb2NrZXRVcmwsIGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQod2ViU29ja2V0VXJsLCAndHJhY2UtdjEnKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICBjb25zdCB7IHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgIH0gPSBvcHRzOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignb3BlbicsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgdGhpcy5zZW5kT3B0aW9uc0lmT3BlbigpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uT3BlbikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uT3Blbih0aGlzLCB0aW1lU3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzID4gMCkgewogICAgICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksIGBzZW5kaW5nIHdzIHBpbmcge30gZXZlcnkgJHt3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzfWApOwogICAgICAgICAgICAgICAgdGhpcy5oZWFydGJlYXRJZCA9IHNldEludGVydmFsKCgpPT57CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMud3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksIGBzZW5kaW5nIHdzIHBpbmcge31gKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53cy5zZW5kKCd7fScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgKiAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignY2xvc2UnLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgY29kZSAsIHJlYXNvbiAsIHdhc0NsZWFuICwgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpLCAnVGFpbENvbm5lY3Rpb246IHdzIGNsb3NlJywgewogICAgICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgIHdhc0NsZWFuLAogICAgICAgICAgICAgICAgdGltZVN0YW1wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0SWQpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uQ2xvc2UpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbkNsb3NlKHRoaXMsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICBjb25zdCBlcnJvckluZm8gPSBjb21wdXRlRXJyb3JJbmZvKGV2ZW50KTsKICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksICdUYWlsQ29ubmVjdGlvbjogd3MgZXJyb3InLCBlcnJvckluZm8pOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbkVycm9yKHRoaXMsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGFzeW5jIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEgaW5zdGFuY2VvZiBCbG9iKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgZXZlbnQuZGF0YS50ZXh0KCk7CiAgICAgICAgICAgICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKHRleHQpOwogICAgICAgICAgICAgICAgbGV0IG1lc3NhZ2U7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBwYXJzZVRhaWxNZXNzYWdlKG9iaik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVW5wYXJzZWRNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgb2JqLCBlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVW5wYXJzZWRNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgZXZlbnQuZGF0YSwgbmV3IEVycm9yKGBFeHBlY3RlZCBldmVudC5kYXRhIHRvIGJlIEJsb2JgKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIHNldE9wdGlvbnMob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgdGhpcy5zZW5kT3B0aW9uc0lmT3BlbigpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2xvc2UoY29kZSwgcmVhc29uKSB7CiAgICAgICAgdGhpcy53cy5jbG9zZShjb2RlLCByZWFzb24pOwogICAgfQogICAgc2VuZE9wdGlvbnNJZk9wZW4oKSB7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucyAmJiB0aGlzLndzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7CiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICBpZiAoVGFpbENvbm5lY3Rpb24uVkVSQk9TRSkgY29uc29sZS5sb2coYHNlbmRPcHRpb25zSWZPcGVuOiBzZW5kaW5nICR7cGF5bG9hZH1gKTsKICAgICAgICAgICAgdGhpcy53cy5zZW5kKHBheWxvYWQpOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlRXJyb3JJbmZvKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ2Vycm9yJykgewogICAgICAgIGNvbnN0IHsgbWVzc2FnZSAsIGZpbGVuYW1lICwgbGluZW5vICwgY29sbm8gLCBlcnJvciAgfSA9IGV2ZW50OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgIGZpbGVuYW1lLAogICAgICAgICAgICBsaW5lbm8sCiAgICAgICAgICAgIGNvbG5vLAogICAgICAgICAgICBlcnJvcgogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGdlbmVyYXRlVXVpZCgpIHsKICAgIGNvbnN0IGNyeXB0b0FzQW55ID0gY3J5cHRvOwogICAgaWYgKHR5cGVvZiBjcnlwdG9Bc0FueS5yYW5kb21VVUlEID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGNyeXB0b0FzQW55LnJhbmRvbVVVSUQoKTsKICAgIH0KICAgIGNvbnN0IHJuZHMgPSBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKG5ldyBVaW50OEFycmF5KDE2KSk7CiAgICBybmRzWzZdID0gcm5kc1s2XSAmIDB4MGYgfCAweDQwOwogICAgcm5kc1s4XSA9IHJuZHNbOF0gJiAweDNmIHwgMHg4MDsKICAgIHJldHVybiBieXRlc1RvVXVpZChybmRzKTsKfQpmdW5jdGlvbiBieXRlc1RvVXVpZChieXRlcykgewogICAgY29uc3QgYml0cyA9IFsKICAgICAgICAuLi5ieXRlcwogICAgXS5tYXAoKGJpdCk9PnsKICAgICAgICBjb25zdCBzID0gYml0LnRvU3RyaW5nKDE2KTsKICAgICAgICByZXR1cm4gYml0IDwgMHgxMCA/ICIwIiArIHMgOiBzOwogICAgfSk7CiAgICByZXR1cm4gWwogICAgICAgIC4uLmJpdHMuc2xpY2UoMCwgNCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoNCwgNiksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoNiwgOCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoOCwgMTApLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDEwLCAxNiksIAogICAgXS5qb2luKCIiKTsKfQpjbGFzcyBNYXRlcmlhbCB7CiAgICBzdGF0aWMgaGlnaEVtcGhhc2lzVGV4dENvbG9yID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC44NyknOwogICAgc3RhdGljIG1lZGl1bUVtcGhhc2lzVGV4dENvbG9yID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCknOwp9CmNvbnN0IE1BVEVSSUFMX0NTUyA9IGNzc2AKCjpyb290IHsKICAtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcjogcmdiKDMwLjc1LCAzMC43NSwgMzAuNzUpOwogIC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yOiByZ2IoNDAuOTUsIDQwLjk1LCA0MC45NSk7CiAgLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC44Nyk7CiAgLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKTsKICAtLWRpc2FibGVkLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4zOCk7CiAgLS1idXR0b24tYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICAtLXByaW1hcnktY29sb3I6ICNiYjg2ZmM7CiAgLS1iYWNrZ3JvdW5kLWNvbG9yOiAjMTIxMjEyOwogIC0tc2Fucy1zZXJpZi1mb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCBhdmVuaXIgbmV4dCwgYXZlbmlyLCBoZWx2ZXRpY2EgbmV1ZSwgaGVsdmV0aWNhLCBVYnVudHUsIHJvYm90bywgbm90bywgc2Vnb2UgdWksIGFyaWFsLCBzYW5zLXNlcmlmOwogIC0tbW9ub3NwYWNlLWZvbnQtZmFtaWx5OiBNZW5sbywgQ29uc29sYXMsIHVpLW1vbm9zcGFjZSwgbW9ub3NwYWNlOwp9CgovKiogdGV4dCBzaXplIGNsYXNzZXMgKi8KCi5oNiB7CiAgICBmb250LXNpemU6IDEuMjVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMDc1MHJlbTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkZXI7Cn0KCi5ib2R5MiwgZmllbGRzZXQgbGFiZWwsIGZpZWxkc2V0IG91dHB1dCwgZmllbGRzZXQgZGV0YWlscyB7CiAgICBmb250LXNpemU6IDAuODc1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDE3ODZyZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwogICAgbGluZS1oZWlnaHQ6IDEuMjVyZW07Cn0KCi5idXR0b24sIGJ1dHRvbiwgLmFjdGlvbi1pY29uIHsKICAgIGZvbnQtc2l6ZTogMC44NzVyZW07CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDg5MjlyZW07CiAgICBmb250LXdlaWdodDogYm9sZGVyOwp9Cgoub3ZlcmxpbmUsIHRoIHsKICAgIGZvbnQtc2l6ZTogMC42MjVyZW07CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMTUwMDByZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwp9CgouY2FwdGlvbiB7CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMzMzM3JlbTsKICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7Cn0KCi8qIGxpZ2h0IHRleHQgb24gZGFyayBiYWNrZ3JvdW5kIGNvbG9ycyAqLwoKLmhpZ2gtZW1waGFzaXMtdGV4dCB7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKLm1lZGl1bS1lbXBoYXNpcy10ZXh0LCBmaWVsZHNldCBsYWJlbCwgdGggewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKLmRpc2FibGVkLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgovKiogZWxldmF0aW9uIGJhY2tncm91bmRzICovCgouc3VyZmFjZS0wMSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwp9Cgouc3VyZmFjZS0wNCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwp9CgovKiogYWN0aW9uLWljb24gKi8KCi5hY3Rpb24taWNvbiB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgbWluLWhlaWdodDogMnJlbTsKICAgIG1pbi13aWR0aDogMnJlbTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgb3BhY2l0eTogMC42OTsgIC8qKiBtZWRpdW0tZW1waGFzaXMgLyBoaWdoLWVtcGhhc2lzICovCiAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKfQoKQG1lZGlhIChob3ZlcjogaG92ZXIpIHsKICAgIC5hY3Rpb24taWNvbjpob3ZlciB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgICAgICBvcGFjaXR5OiAxOwogICAgfQp9CgovKiogYnV0dG9uICovCgpidXR0b24gewogICAgYm9yZGVyOiBub25lOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgbWluLXdpZHRoOiA4cmVtOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpidXR0b24uc2VsZWN0ZWQgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpAbWVkaWEgKGhvdmVyKSB7CiAgICBidXR0b246aG92ZXIgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICAgICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICB9Cn0KCmJ1dHRvbjpkaXNhYmxlZCB7CiAgICBjb2xvcjogdmFyKC0tZGlzYWJsZWQtdGV4dC1jb2xvcik7Cn0KCkBtZWRpYSAoaG92ZXIpIHsKICAgIGJ1dHRvbjpkaXNhYmxlZDpob3ZlciB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgICAgICBjdXJzb3I6IGRlZmF1bHQ7CiAgICB9Cn0KCi8qKiBhbmNob3JzICovCgphIHsKICAgIGNvbG9yOiB2YXIoLS1wcmltYXJ5LWNvbG9yKTsKICAgIHRleHQtdW5kZXJsaW5lLW9mZnNldDogMC4ycmVtOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgYTpob3ZlciB7CiAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7CiAgICB9Cn0KCi8qKiBmb3JtcyAqLwoKZmllbGRzZXQgewogICAgYm9yZGVyOiBzb2xpZCAxcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXJvdy1nYXA6IDFyZW07CiAgICBncmlkLWNvbHVtbi1nYXA6IDFyZW07CiAgICBwYWRkaW5nOiAxcmVtOwp9CgpsYWJlbCB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIHBhZGRpbmc6IDAuNXJlbSAwOwp9CgouZm9ybS1saHMgewogICAgZ3JpZC1jb2x1bW46IDE7Cn0KCmlucHV0LCAuZm9ybS1yaHMgewogICAgZ3JpZC1jb2x1bW46IDI7CiAgICBtaW4td2lkdGg6IDA7Cn0KCi5mb3JtLXJvdyB7CiAgICBncmlkLWNvbHVtbjogMSAvIHNwYW4gMjsKfQoKZmllbGRzZXQgaW5wdXRbdHlwZT10ZXh0XSB7CiAgICBwYWRkaW5nOiAwLjVyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXI6IHNvbGlkIDFweCB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7Cn0KCmZpZWxkc2V0IG91dHB1dCB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCmZpZWxkc2V0IGRldGFpbHMgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKYDsKY29uc3QgSEVBREVSX0hUTUwgPSBodG1sYAo8aGVhZGVyIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQiPgogICAgPGRpdiBpZD0iaGVhZGVyLWNvbnRlbnQiPgogICAgICAgIFdlYnRhaWwKICAgICAgICA8c3BhbiBpZD0iaGVhZGVyLXZlcnNpb24iIGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCI+PC9zcGFuPgogICAgICAgIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayIgaWQ9ImdpdGh1Yi1sb2dvLWFuY2hvciI+PGltZyBpZD0iZ2l0aHViLWxvZ28iPjwvYT4KICAgIDwvZGl2Pgo8L2hlYWRlcj4KYDsKY29uc3QgSEVBREVSX0NTUyA9IGNzc2AKaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBwYWRkaW5nOiAxcmVtIDA7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKfQoKI2hlYWRlci1jb250ZW50IHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogYmFzZWxpbmU7CiAgICBwYWRkaW5nLXJpZ2h0OiAyLjJyZW07Cn0KCiNoZWFkZXItdmVyc2lvbiB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNnaXRodWItbG9nby1hbmNob3IgewogICAgbGluZS1oZWlnaHQ6IDA7CiAgICBvcGFjaXR5OiAwLjU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICAjZ2l0aHViLWxvZ28tYW5jaG9yOmhvdmVyIHsKICAgICAgICBvcGFjaXR5OiAwLjc1OwogICAgfQp9CgojZ2l0aHViLWxvZ28gewogICAgd2lkdGg6IDFyZW07CiAgICBtYXJnaW4tYm90dG9tOiAtMC4xcmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0SGVhZGVyKGRvY3VtZW50LCB2bTEsIGRhdGEzKSB7CiAgICBjb25zdCBoZWFkZXJDb250ZW50RWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFkZXItY29udGVudCcpOwogICAgaWYgKChkYXRhMy5mbGFncyB8fCAnJykuaW5jbHVkZXMoJ2RlbW8tdG9nZ2xlJykpIHsKICAgICAgICBoZWFkZXJDb250ZW50RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdkYmxjbGljaycsIChlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtMS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgIH0pOwogICAgfQogICAgY29uc3QgaGVhZGVyVmVyc2lvblNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGVhZGVyLXZlcnNpb24nKTsKICAgIGNvbnN0IHsgdmVyc2lvbiAgfSA9IGRhdGEzOwogICAgaGVhZGVyVmVyc2lvblNwYW4udGV4dENvbnRlbnQgPSB2ZXJzaW9uID8gYHYke3ZlcnNpb259YCA6ICcnOwogICAgY29uc3QgZ2l0aHViTG9nb0ltZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnaXRodWItbG9nbycpOwogICAgZ2l0aHViTG9nb0ltZy5zcmMgPSBjb21wdXRlR2l0aHViTG9nb0RhdGFVcmwoKTsKICAgIHJldHVybiAoKT0+e307Cn0KZnVuY3Rpb24gY29tcHV0ZUdpdGh1YkxvZ29EYXRhVXJsKCkgewogICAgY29uc3Qgc3ZnMSA9IEdJVEhVQl9MT0dPLnJlcGxhY2UoJ2ZpbGw6d2hpdGU7JywgYGZpbGw6JHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9O2ApOwogICAgcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7dXRmOCwnICsgc3ZnMTsKfQpjb25zdCBHSVRIVUJfTE9HTyA9IGA8c3ZnIHdpZHRoPSJhdXRvIiBoZWlnaHQ9ImF1dG8iIHZpZXdCb3g9IjAgMCAxMzYgMTMzIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zOnNlcmlmPSJodHRwOi8vd3d3LnNlcmlmLmNvbS8iIHN0eWxlPSJmaWxsLXJ1bGU6ZXZlbm9kZDtjbGlwLXJ1bGU6ZXZlbm9kZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6MjsiPgo8ZyB0cmFuc2Zvcm09Im1hdHJpeCg0LjE2NjY3LDAsMCw0LjE2NjY3LC01NjgsLTEzODEuMDYpIj4KICAgIDxwYXRoIGQ9Ik0xNTIuNjA4LDMzMS40NTVDMTQzLjYxNCwzMzEuNDU1IDEzNi4zMiwzMzguNzQ4IDEzNi4zMiwzNDcuNzQ1QzEzNi4zMiwzNTQuOTQyIDE0MC45ODcsMzYxLjA0NyAxNDcuNDYsMzYzLjIwMUMxNDguMjc1LDM2My4zNTEgMTQ4LjU3MiwzNjIuODQ4IDE0OC41NzIsMzYyLjQxNkMxNDguNTcyLDM2Mi4wMjkgMTQ4LjU1OCwzNjEuMDA1IDE0OC41NSwzNTkuNjQ2QzE0NC4wMTksMzYwLjYzIDE0My4wNjMsMzU3LjQ2MiAxNDMuMDYzLDM1Ny40NjJDMTQyLjMyMiwzNTUuNTggMTQxLjI1NCwzNTUuMDc5IDE0MS4yNTQsMzU1LjA3OUMxMzkuNzc1LDM1NC4wNjkgMTQxLjM2NiwzNTQuMDg5IDE0MS4zNjYsMzU0LjA4OUMxNDMuMDAxLDM1NC4yMDQgMTQzLjg2MSwzNTUuNzY4IDE0My44NjEsMzU1Ljc2OEMxNDUuMzE0LDM1OC4yNTcgMTQ3LjY3NCwzNTcuNTM4IDE0OC42MDIsMzU3LjEyMUMxNDguNzUsMzU2LjA2OSAxNDkuMTcxLDM1NS4zNTEgMTQ5LjYzNiwzNTQuOTQ0QzE0Ni4wMTksMzU0LjUzMyAxNDIuMjE2LDM1My4xMzUgMTQyLjIxNiwzNDYuODkzQzE0Mi4yMTYsMzQ1LjExNSAxNDIuODUxLDM0My42NiAxNDMuODkzLDM0Mi41MjJDMTQzLjcyNSwzNDIuMTEgMTQzLjE2NiwzNDAuNDUzIDE0NC4wNTMsMzM4LjIxMUMxNDQuMDUzLDMzOC4yMTEgMTQ1LjQyLDMzNy43NzMgMTQ4LjUzMiwzMzkuODgxQzE0OS44MzEsMzM5LjUxOSAxNTEuMjI1LDMzOS4zMzkgMTUyLjYxLDMzOS4zMzJDMTUzLjk5NCwzMzkuMzM5IDE1NS4zODcsMzM5LjUxOSAxNTYuNjg4LDMzOS44ODFDMTU5Ljc5OCwzMzcuNzczIDE2MS4xNjMsMzM4LjIxMSAxNjEuMTYzLDMzOC4yMTFDMTYyLjA1MiwzNDAuNDUzIDE2MS40OTMsMzQyLjExIDE2MS4zMjYsMzQyLjUyMkMxNjIuMzcsMzQzLjY2IDE2MywzNDUuMTE1IDE2MywzNDYuODkzQzE2MywzNTMuMTUxIDE1OS4xOTEsMzU0LjUyOCAxNTUuNTYzLDM1NC45MzFDMTU2LjE0NywzNTUuNDM0IDE1Ni42NjgsMzU2LjQyOCAxNTYuNjY4LDM1Ny45NDdDMTU2LjY2OCwzNjAuMTI1IDE1Ni42NDgsMzYxLjg4MiAxNTYuNjQ4LDM2Mi40MTZDMTU2LjY0OCwzNjIuODUyIDE1Ni45NDIsMzYzLjM1OSAxNTcuNzY4LDM2My4yQzE2NC4yMzYsMzYxLjA0MSAxNjguODk5LDM1NC45NCAxNjguODk5LDM0Ny43NDVDMTY4Ljg5OSwzMzguNzQ4IDE2MS42MDUsMzMxLjQ1NSAxNTIuNjA4LDMzMS40NTVaIiBzdHlsZT0iZmlsbDp3aGl0ZTsiLz4KPC9nPgo8L3N2Zz5gOwpmdW5jdGlvbiBhY3Rpb25JY29uKGljb24sIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyB0ZXh0ICwgb25jbGljayAgfSA9IG9wdHM7CiAgICByZXR1cm4gaHRtbGA8ZGl2IGNsYXNzPSJhY3Rpb24taWNvbiIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIG9uY2xpY2sgJiYgb25jbGljaygpOwogICAgfX0+JHtpY29ufSR7dGV4dCB8fCAnJ308L2Rpdj5gOwp9CmNvbnN0IENMRUFSX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik01IDEzaDE0di0ySDV2MnptLTIgNGgxNHYtMkgzdjJ6TTcgN3YyaDE0VjdIN3oiLz48L3N2Zz5gOwpjb25zdCBFRElUX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xNC4wNiA5LjAybC45Mi45Mkw1LjkyIDE5SDV2LS45Mmw5LjA2LTkuMDZNMTcuNjYgM2MtLjI1IDAtLjUxLjEtLjcuMjlsLTEuODMgMS44MyAzLjc1IDMuNzUgMS44My0xLjgzYy4zOS0uMzkuMzktMS4wMiAwLTEuNDFsLTIuMzQtMi4zNGMtLjItLjItLjQ1LS4yOS0uNzEtLjI5em0tMy42IDMuMTlMMyAxNy4yNVYyMWgzLjc1TDE3LjgxIDkuOTRsLTMuNzUtMy43NXoiLz48L3N2Zz5gOwpjb25zdCBBRERfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOSAxM2gtNnY2aC0ydi02SDV2LTJoNlY1aDJ2Nmg2djJ6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tfQk9YX1VOQ0hFQ0tFRF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTkgNXYxNEg1VjVoMTRtMC0ySDVjLTEuMSAwLTIgLjktMiAydjE0YzAgMS4xLjkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJWNWMwLTEuMS0uOS0yLTItMnoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19CT1hfQ0hFQ0tFRF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTkgM0g1Yy0xLjEgMC0yIC45LTIgMnYxNGMwIDEuMS45IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjVjMC0xLjEtLjktMi0yLTJ6bTAgMTZINVY1aDE0djE0ek0xNy45OSA5bC0xLjQxLTEuNDItNi41OSA2LjU5LTIuNTgtMi41Ny0xLjQyIDEuNDEgNCAzLjk5eiIvPjwvc3ZnPmA7CmNvbnN0IFNJREVCQVJfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9InNpZGViYXIiPgogICAgJHtIRUFERVJfSFRNTH0KICAgIDxhIGlkPSJzaWRlYmFyLWFib3V0IiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiIGhyZWY9IiMiPkFib3V0PC9hPgogICAgPGRpdiBpZD0icHJvZmlsZXMiPjwvZGl2PgogICAgPGRpdiBpZD0ic2lkZWJhci1hbmFseXRpY3MiPjwvZGl2PgogICAgPGRpdiBpZD0ic2NyaXB0cyI+PC9kaXY+CjwvZGl2PgpgOwpjb25zdCBTSURFQkFSX0NTUyA9IGNzc2AKCiNzaWRlYmFyIHsKICAgIG1hcmdpbi1sZWZ0OiAxcmVtOwogICAgaGVpZ2h0OiAxMDB2aDsKICAgIG1pbi13aWR0aDogMTVyZW07Cn0KCiNzaWRlYmFyLWFib3V0IHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkIHsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAycmVtOwogICAgZ3JpZC1nYXA6IDFweDsKICAgIG1hcmdpbi1sZWZ0OiAxcHg7CiAgICBtYXJnaW4tdG9wOiAxcmVtOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQtbmV3IHsKICAgIGdyaWQtY29sdW1uOiAxOwogICAgbWluLXdpZHRoOiA4cmVtOwp9Cgojc2lkZWJhciBidXR0b24gewogICAgZ3JpZC1jb2x1bW46IDE7Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZCAuaGludCB7CiAgICBncmlkLWNvbHVtbjogMTsgCiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNzY3JpcHRzLXNjcm9sbGVyIHsKICAgIGhlaWdodDogY2FsYygxMDB2aCAtIDI4cmVtKTsKfQoKI3NpZGViYXIgLmV4dHJhLXRvcC1tYXJnaW4gewogICAgbWFyZ2luLXRvcDogMXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdFNpZGViYXIoZG9jdW1lbnQsIHZtMiwgZGF0YTQpIHsKICAgIGNvbnN0IHVwZGF0ZUhlYWRlciA9IGluaXRIZWFkZXIoZG9jdW1lbnQsIHZtMiwgZGF0YTQpOwogICAgY29uc3QgYWJvdXRBbmNob3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2lkZWJhci1hYm91dCcpOwogICAgY29uc3QgcHJvZmlsZXNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZXMnKTsKICAgIGNvbnN0IGFuYWx5dGljc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaWRlYmFyLWFuYWx5dGljcycpOwogICAgY29uc3Qgc2NyaXB0c0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY3JpcHRzJyk7CiAgICBhYm91dEFuY2hvci5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMi5zaG93QWJvdXQoKTsKICAgIH07CiAgICByZXR1cm4gKCk9PnsKICAgICAgICB1cGRhdGVIZWFkZXIoKTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihQUk9GSUxFU19IVE1MKHZtMiksIHByb2ZpbGVzRGl2KTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihBTkFMWVRJQ1NfSFRNTCh2bTIpLCBhbmFseXRpY3NEaXYpOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKFNDUklQVFNfSFRNTCh2bTIpLCBzY3JpcHRzRGl2KTsKICAgIH07Cn0KY29uc3QgUFJPRklMRVNfSFRNTCA9ICh2bTMpPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPlByb2ZpbGVzPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgJHt2bTMucHJvZmlsZXMubWFwKChwcm9maWxlKT0+aHRtbGA8YnV0dG9uIAogICAgICAgICAgICBjbGFzcz0iJHtwcm9maWxlLmlkID09PSB2bTMuc2VsZWN0ZWRQcm9maWxlSWQgPyAnc2VsZWN0ZWQnIDogJyd9IiAKICAgICAgICAgICAgQGNsaWNrPSR7KCk9PnsKICAgICAgICAgICAgdm0zLnNlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZS5pZDsKICAgICAgICB9fQogICAgICAgICAgICA/ZGlzYWJsZWQ9IiR7dm0zLnByb2ZpbGVGb3JtLnNob3dpbmd9Ij4ke3Byb2ZpbGUudGV4dH08L2J1dHRvbj4KICAgICAgICAke3Byb2ZpbGUuaWQgPT09IHZtMy5zZWxlY3RlZFByb2ZpbGVJZCA/IGh0bWxgJHthY3Rpb25JY29uKEVESVRfSUNPTiwgewogICAgICAgICAgICBvbmNsaWNrOiAoKT0+dm0zLmVkaXRQcm9maWxlKHByb2ZpbGUuaWQpCiAgICAgICAgfSl9YCA6ICcnfWAKICAgICl9CiAgICAgICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQtbmV3Ij4ke2FjdGlvbkljb24oQUREX0lDT04sIHsKICAgICAgICB0ZXh0OiAnTmV3JywKICAgICAgICBvbmNsaWNrOiAoKT0+dm0zLm5ld1Byb2ZpbGUoKQogICAgfSl9PC9kaXY+CiAgICA8L2Rpdj4KYAo7CmNvbnN0IEFOQUxZVElDU19IVE1MID0gKHZtNCk9Pmh0bWxgCiAgICA8ZGl2IGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCBleHRyYS10b3AtbWFyZ2luIj5BbmFseXRpY3M8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAke3ZtNC5hbmFseXRpY3MubWFwKChhbmFseXRpYyk9Pmh0bWxgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3M9IiR7dm00LnNlbGVjdGVkQW5hbHl0aWNJZCA9PT0gYW5hbHl0aWMuaWQgPyAnc2VsZWN0ZWQnIDogJyd9IiAKICAgICAgICAgICAgICAgIEBjbGljaz0keygpPT52bTQuc2hvd0FuYWx5dGljKGFuYWx5dGljLmlkKQogICAgICAgIH0gCiAgICAgICAgICAgICAgICA/ZGlzYWJsZWQ9IiR7dm00LnByb2ZpbGVGb3JtLnNob3dpbmd9Ij4ke2FuYWx5dGljLnRleHR9PC9idXR0b24+CiAgICAgICAgYAogICAgKX0KICAgIDwvZGl2PgpgCjsKY29uc3QgU0NSSVBUU19IVE1MID0gKHZtNSk9Pmh0bWxgCiAgICA8ZGl2IGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCBleHRyYS10b3AtbWFyZ2luIj5TY3JpcHRzPC9kaXY+CiAgICA8ZGl2IGlkPSJzY3JpcHRzLXNjcm9sbGVyIiBjbGFzcz0iaGlkZGVuLXZlcnRpY2FsLXNjcm9sbCI+CiAgICAgICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQiPgogICAgICAgICAgICAke3ZtNS5zY3JpcHRzLm1hcCgoc2NyaXB0KT0+aHRtbGA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgY2xhc3M9IiR7dm01LnNlbGVjdGVkU2NyaXB0SWRzLmhhcyhzY3JpcHQuaWQpID8gJ3NlbGVjdGVkJyA6ICcnfSIgCiAgICAgICAgICAgICAgICAgICAgQGNsaWNrPSR7KGUpPT5oYW5kbGVTY3JpcHRDbGljayhlLCBzY3JpcHQuaWQsIHZtNSkKICAgICAgICB9IAogICAgICAgICAgICAgICAgICAgID9kaXNhYmxlZD0iJHt2bTUucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7c2NyaXB0LnRleHR9PC9idXR0b24+CiAgICAgICAgICAgIGAKICAgICl9CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXB0aW9uIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGhpbnQiPiR7Y29tcHV0ZU11bHRpc2VsZWN0S2V5Q2hhcigpfS1jbGljayB0byBtdWx0aXNlbGVjdDwvZGl2PgogICAgPC9kaXY+CmAKOwpmdW5jdGlvbiBjb21wdXRlTXVsdGlzZWxlY3RLZXlDaGFyKCkgewogICAgcmV0dXJuIGlzTWFjaW50b3NoKCkgPyAn4oyYJyA6ICdjdHJsJzsKfQpmdW5jdGlvbiBpc01hY2ludG9zaCgpIHsKICAgIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm0uaW5kZXhPZignTWFjJykgPiAtMTsKfQpmdW5jdGlvbiBoYW5kbGVTY3JpcHRDbGljayhlLCBzY3JpcHRJZCwgdm02KSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBjb25zdCBuZXdTY3JpcHRJZHMgPSBuZXcgU2V0KFsKICAgICAgICBzY3JpcHRJZAogICAgXSk7CiAgICBjb25zdCBtdWx0aSA9IGlzTWFjaW50b3NoKCkgPyBlLm1ldGFLZXkgOiBlLmN0cmxLZXk7CiAgICB2bTYuc2VsZWN0ZWRTY3JpcHRJZHMgPSBtdWx0aSA/IHZtNi5zZWxlY3RlZFNjcmlwdElkcy5oYXMoc2NyaXB0SWQpID8gc2V0U3VidHJhY3Qodm02LnNlbGVjdGVkU2NyaXB0SWRzLCBuZXdTY3JpcHRJZHMpIDogc2V0VW5pb24odm02LnNlbGVjdGVkU2NyaXB0SWRzLCBuZXdTY3JpcHRJZHMpIDogbmV3U2NyaXB0SWRzOwp9CmNsYXNzIEFwcENvbnN0YW50cyB7CiAgICBzdGF0aWMgV0VCU09DS0VUX1BJTkdfSU5URVJWQUxfU0VDT05EUyA9IDEwOwogICAgc3RhdGljIElOQUNUSVZFX1RBSUxfU0VDT05EUyA9IDU7Cn0KY2xhc3MgVGFpbENvbnRyb2xsZXIgewogICAgY2FsbGJhY2tzOwogICAgcmVjb3JkcyA9IG5ldyBNYXAoKTsKICAgIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHM7CiAgICBpbmFjdGl2ZVRhaWxTZWNvbmRzOwogICAgdGFpbE9wdGlvbnMgPSB7CiAgICAgICAgZmlsdGVyczogW10KICAgIH07CiAgICBvbmxpbmU7CiAgICBjb25zdHJ1Y3RvcihjYWxsYmFja3MsIG9wdHMpewogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMud2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcyA9IG9wdHMud2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kczsKICAgICAgICB0aGlzLmluYWN0aXZlVGFpbFNlY29uZHMgPSBvcHRzLmluYWN0aXZlVGFpbFNlY29uZHM7CiAgICAgICAgY29uc3QgbmF2aWdhdG9yQXNBbnkgPSB3aW5kb3cubmF2aWdhdG9yOwogICAgICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yQXNBbnkub25MaW5lID09PSAnYm9vbGVhbicpIHsKICAgICAgICAgICAgdGhpcy5zZXRPbmxpbmUobmF2aWdhdG9yQXNBbnkub25MaW5lKTsKICAgICAgICB9CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29ubGluZScsICgpPT50aGlzLnNldE9ubGluZSh0cnVlKQogICAgICAgICk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29mZmxpbmUnLCAoKT0+dGhpcy5zZXRPbmxpbmUoZmFsc2UpCiAgICAgICAgKTsKICAgIH0KICAgIHNldFRhaWxPcHRpb25zKHRhaWxPcHRpb25zKSB7CiAgICAgICAgY29uc29sZS5sb2coYFRhaWxDb250cm9sbGVyLnNldFRhaWxPcHRpb25zICR7SlNPTi5zdHJpbmdpZnkodGFpbE9wdGlvbnMpfWApOwogICAgICAgIHRoaXMudGFpbE9wdGlvbnMgPSB0YWlsT3B0aW9uczsKICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiB0aGlzLnJlY29yZHMudmFsdWVzKCkpewogICAgICAgICAgICBpZiAocmVjb3JkLmNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgICAgIHJlY29yZC5jb25uZWN0aW9uLnNldE9wdGlvbnModGFpbE9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgc2V0VGFpbHMoYWNjb3VudElkLCBhcGlUb2tlbiwgc2NyaXB0SWRzKSB7CiAgICAgICAgY29uc3Qgc3RvcEtleXMgPSBzZXRTdWJ0cmFjdCh0aGlzLmNvbXB1dGVTdGFydGluZ09yU3RhcnRlZFRhaWxLZXlzKCksIG5ldyBTZXQoWwogICAgICAgICAgICAuLi5zY3JpcHRJZHMKICAgICAgICBdLm1hcCgodik9PnBhY2tUYWlsS2V5KGFjY291bnRJZCwgdikKICAgICAgICApKSk7CiAgICAgICAgZm9yIChjb25zdCBzdG9wS2V5IG9mIHN0b3BLZXlzKXsKICAgICAgICAgICAgY29uc3QgcmVjb3JkID0gdGhpcy5yZWNvcmRzLmdldChzdG9wS2V5KTsKICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gJ2luYWN0aXZlJzsKICAgICAgICAgICAgcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSA9PT0gJ2luYWN0aXZlJyAmJiByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgJiYgRGF0ZS5ub3coKSAtIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZSA+PSB0aGlzLmluYWN0aXZlVGFpbFNlY29uZHMpIHsKICAgICAgICAgICAgICAgICAgICByZWNvcmQuc3RhdGUgPSAnc3RvcHBpbmcnOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTdG9wcGluZyAke3JlY29yZC5zY3JpcHRJZH0sIGluYWN0aXZlIGZvciAke0RhdGUubm93KCkgLSByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWV9bXNgKTsKICAgICAgICAgICAgICAgICAgICByZWNvcmQuY29ubmVjdGlvbj8uY2xvc2UoMTAwMCwgJ25vIGxvbmdlciBpbnRlcmVzdGVkJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRzLmRlbGV0ZShyZWNvcmQudGFpbEtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMuaW5hY3RpdmVUYWlsU2Vjb25kcyAqIDEwMDApOwogICAgICAgIH0KICAgICAgICBpZiAoc3RvcEtleXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFRhaWxzQ2hhbmdlZCgpOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHNjcmlwdElkIG9mIHNjcmlwdElkcyl7CiAgICAgICAgICAgIGNvbnN0IHRhaWxLZXkgPSBwYWNrVGFpbEtleShhY2NvdW50SWQsIHNjcmlwdElkKTsKICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdSZWNvcmQgPSB0aGlzLnJlY29yZHMuZ2V0KHRhaWxLZXkpOwogICAgICAgICAgICBpZiAoZXhpc3RpbmdSZWNvcmQpIHsKICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1JlY29yZC5zdGF0ZSA9PT0gJ2luYWN0aXZlJykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBSZXZpdmluZyBpbmFjdGl2ZSAke3NjcmlwdElkfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXhpc3RpbmdSZWNvcmQuc3RhdGUgPSAnc3RhcnRlZCc7CiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZC5zdG9wUmVxdWVzdGVkVGltZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlY29yZCA9IHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ3N0YXJ0aW5nJywKICAgICAgICAgICAgICAgICAgICB0YWlsS2V5LAogICAgICAgICAgICAgICAgICAgIGFwaVRva2VuLAogICAgICAgICAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgICAgICAgICBzY3JpcHRJZCwKICAgICAgICAgICAgICAgICAgICByZXRyeUNvdW50QWZ0ZXJDbG9zZTogMAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkcy5zZXQodGFpbEtleSwgcmVjb3JkKTsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRUYWlsQ29ubmVjdGlvbihyZWNvcmQpOwogICAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gJ3N0YXJ0ZWQnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKTsKICAgICAgICB9CiAgICB9CiAgICBkaXNwYXRjaFRhaWxzQ2hhbmdlZCgpIHsKICAgICAgICBjb25zdCB0YWlsS2V5cyA9IG5ldyBTZXQoWwogICAgICAgICAgICAuLi50aGlzLnJlY29yZHMudmFsdWVzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYuc3RhdGUgPT09ICdzdGFydGVkJwogICAgICAgICkubWFwKCh2KT0+di50YWlsS2V5CiAgICAgICAgKSk7CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsc0NoYW5nZWQodGFpbEtleXMpOwogICAgfQogICAgY29tcHV0ZVN0YXJ0aW5nT3JTdGFydGVkVGFpbEtleXMoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTZXQoWwogICAgICAgICAgICAuLi50aGlzLnJlY29yZHMudmFsdWVzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYuc3RhdGUgPT09ICdzdGFydGluZycgfHwgdi5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnCiAgICAgICAgKS5tYXAoKHYpPT52LnRhaWxLZXkKICAgICAgICApKTsKICAgIH0KICAgIHNldE9ubGluZShvbmxpbmUpIHsKICAgICAgICBpZiAob25saW5lID09PSB0aGlzLm9ubGluZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IG9sZE9ubGluZSA9IHRoaXMub25saW5lOwogICAgICAgIHRoaXMub25saW5lID0gb25saW5lOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uTmV0d29ya1N0YXR1c0NoYW5nZWQob25saW5lKTsKICAgICAgICBpZiAodHlwZW9mIG9sZE9ubGluZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgIGlmIChvbmxpbmUpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIHRoaXMucmVjb3Jkcy52YWx1ZXMoKSl7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgc2NyaXB0SWQgIH0gPSByZWNvcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUYWlsQ29ubmVjdGlvbihyZWNvcmQpLmNhdGNoKChlKT0+dGhpcy5jYWxsYmFja3Mub25UYWlsRmFpbGVkVG9TdGFydChhY2NvdW50SWQsIHNjcmlwdElkLCAncmVzdGFydC1hZnRlci1jb21pbmctb25saW5lJywgZSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiB0aGlzLnJlY29yZHMudmFsdWVzKCkpewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5jb25uZWN0aW9uPy5jbG9zZSgxMDAwLCAnb2ZmbGluZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgc3RhcnRUYWlsQ29ubmVjdGlvbihyZWNvcmQpIHsKICAgICAgICBjb25zdCBhbGxvd2VkVG9TdGFydCA9IHJlY29yZC5zdGF0ZSA9PT0gJ3N0YXJ0aW5nJyB8fCByZWNvcmQuc3RhdGUgPT09ICdzdGFydGVkJzsKICAgICAgICBpZiAoIWFsbG93ZWRUb1N0YXJ0KSByZXR1cm47CiAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBzY3JpcHRJZCAgfSA9IHVucGFja1RhaWxLZXkocmVjb3JkLnRhaWxLZXkpOwogICAgICAgIGNvbnN0IHsgYXBpVG9rZW4gIH0gPSByZWNvcmQ7CiAgICAgICAgaWYgKCFyZWNvcmQudGFpbCB8fCBEYXRlLm5vdygpID4gbmV3IERhdGUocmVjb3JkLnRhaWwuZXhwaXJlc19hdCkuZ2V0VGltZSgpIC0gMTAwMCAqIDYwICogNSkgewogICAgICAgICAgICBjb25zdCB0YWlsQ3JlYXRpbmdUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRpbmcoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgICAgIGNvbnN0IHRhaWwgPSBhd2FpdCBjcmVhdGVUYWlsKGFjY291bnRJZCwgc2NyaXB0SWQsIGFwaVRva2VuKTsKICAgICAgICAgICAgcmVjb3JkLnRhaWwgPSB0YWlsOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGVkKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCkgLSB0YWlsQ3JlYXRpbmdUaW1lLCB0YWlsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSA9PT0gJ2luYWN0aXZlJykgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgY2FsbGJhY2tzICwgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcyAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgZGlzID0gdGhpczsKICAgICAgICBjb25zdCBvcGVuaW5nVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgY29uc3QgdGFpbENvbm5lY3Rpb25DYWxsYmFja3MgPSB7CiAgICAgICAgICAgIG9uT3BlbiAoX2NuLCB0aW1lU3RhbXApIHsKICAgICAgICAgICAgICAgIHJlY29yZC5yZXRyeUNvdW50QWZ0ZXJDbG9zZSA9IDA7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBEYXRlLm5vdygpIC0gb3BlbmluZ1RpbWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbkNsb3NlIChfY24sIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25DbG9zZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgICAgICAgICAgICAgcmVjb3JkLmNsb3NlVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnc3RhcnRlZCcgJiYgZGlzLm9ubGluZSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICByZWNvcmQucmV0cnlDb3VudEFmdGVyQ2xvc2UrKzsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWxheVNlY29uZHMgPSBNYXRoLm1pbihyZWNvcmQucmV0cnlDb3VudEFmdGVyQ2xvc2UgKiA1LCA2MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFdpbGwgYXR0ZW1wdCB0byByZXN0YXJ0ICR7c2NyaXB0SWR9IGluICR7ZGVsYXlTZWNvbmRzfSBzZWNvbmRzYCk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChhc3luYyBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBkaXMuc3RhcnRUYWlsQ29ubmVjdGlvbihyZWNvcmQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgZGVsYXlTZWNvbmRzICogMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uRXJyb3IgKF9jbiwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uRXJyb3IoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxNZXNzYWdlIChfY24sIHRpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSAhPT0gJ3N0YXJ0ZWQnKSByZXR1cm47CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25VbnBhcnNlZE1lc3NhZ2UgKF9jbiwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25VbnBhcnNlZE1lc3NhZ2UnLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpOwogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24gPSBuZXcgVGFpbENvbm5lY3Rpb24ocmVjb3JkLnRhaWwudXJsLCB0YWlsQ29ubmVjdGlvbkNhbGxiYWNrcywgewogICAgICAgICAgICB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzCiAgICAgICAgfSkuc2V0T3B0aW9ucyh0aGlzLnRhaWxPcHRpb25zKTsKICAgIH0KfQpmdW5jdGlvbiB1bnBhY2tUYWlsS2V5KHRhaWxLZXkpIHsKICAgIGNvbnN0IG0gPSAvXihbXlxzLV0rKS0oW15cc10rKSQvLmV4ZWModGFpbEtleSk7CiAgICBpZiAoIW0pIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxLZXk6ICR7dGFpbEtleX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgYWNjb3VudElkOiBtWzFdLAogICAgICAgIHNjcmlwdElkOiBtWzJdCiAgICB9Owp9CmZ1bmN0aW9uIHBhY2tUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpIHsKICAgIHJldHVybiBgJHthY2NvdW50SWR9LSR7c2NyaXB0SWR9YDsKfQpjbGFzcyBTd2l0Y2hhYmxlVGFpbENvbnRyb2xsZXJDYWxsYmFja3MgewogICAgY2FsbGJhY2tzOwogICAgZW5hYmxlZEZuOwogICAgY29uc3RydWN0b3IoY2FsbGJhY2tzLCBlbmFibGVkRm4pewogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMuZW5hYmxlZEZuID0gZW5hYmxlZEZuOwogICAgfQogICAgb25UYWlsQ3JlYXRpbmcoYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgfQogICAgb25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCB0b29rTWlsbGlzLCB0YWlsKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCB0b29rTWlsbGlzLCB0YWlsKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25PcGVuKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgdG9va01pbGxpcykgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25PcGVuKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgdG9va01pbGxpcyk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uQ2xvc2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkNsb3NlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbik7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uRXJyb3IoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uRXJyb3IoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpOwogICAgfQogICAgb25UYWlsc0NoYW5nZWQodGFpbHMpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxzQ2hhbmdlZCh0YWlscyk7CiAgICB9CiAgICBvbk5ldHdvcmtTdGF0dXNDaGFuZ2VkKG9ubGluZSkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uTmV0d29ya1N0YXR1c0NoYW5nZWQob25saW5lKTsKICAgIH0KICAgIG9uVGFpbEZhaWxlZFRvU3RhcnQoYWNjb3VudElkLCBzY3JpcHRJZCwgdHJpZ2dlciwgZXJyb3IpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxGYWlsZWRUb1N0YXJ0KGFjY291bnRJZCwgc2NyaXB0SWQsIHRyaWdnZXIsIGVycm9yKTsKICAgIH0KfQpjbGFzcyBEZW1vTW9kZSB7CiAgICBzdGF0aWMgcHJvZmlsZXMgPSBbCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3Byb2ZpbGUxJywKICAgICAgICAgICAgdGV4dDogJ2NvcnAtcHJvZmlsZScKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdwcm9maWxlMicsCiAgICAgICAgICAgIHRleHQ6ICdwZXJzLXByb2ZpbGUnCiAgICAgICAgfSwgCiAgICBdOwogICAgc3RhdGljIHNlbGVjdGVkUHJvZmlsZUlkID0gJ3Byb2ZpbGUxJzsKICAgIHN0YXRpYyBzZXRTZWxlY3RlZFByb2ZpbGVJZChfdmFsdWUpIHt9CiAgICBzdGF0aWMgc2NyaXB0cyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MScsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIxLWRldicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQyJywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjEtcHJvZCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQzJywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItZGV2JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDQnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMi1iZXRhJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDUnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMi1wcm9kJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDYnLAogICAgICAgICAgICB0ZXh0OiAnZHVyYWJsZS1vYmplY3QtZGVtbycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ3JywKICAgICAgICAgICAgdGV4dDogJ3NlY3JldC1hcHAnCiAgICAgICAgfSwgCiAgICBdOwogICAgc3RhdGljIHNlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldChbCiAgICAgICAgJ3NjcmlwdDcnLAogICAgICAgICdzY3JpcHQ0JwogICAgXSk7CiAgICBzdGF0aWMgc2V0U2VsZWN0ZWRTY3JpcHRJZHMoX3NjcmlwdElkcykge30KICAgIHN0YXRpYyB0YWlscyA9IG5ldyBTZXQoKTsKICAgIHN0YXRpYyBsb2dGYWtlT3V0cHV0KGNhbGxiYWNrcykgewogICAgICAgIGNvbnN0IGFjY291bnRJZCA9ICcxNWE3ZmEzYTM3MjU0ZmU0YTdjYWRkMWJiMjc2Mjg3OSc7CiAgICAgICAgY29uc3Qgc2NyaXB0SWQgPSAnc2VjcmV0LWFwcCc7CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgIGNvbnN0IHRhaWwgPSB7CiAgICAgICAgICAgIGlkOiAnZGIxOWViOGJlOWY0NDQzYWFiOTFhOTA0MmMwZDM1MTcnLAogICAgICAgICAgICB1cmw6ICd3c3M6Ly90YWlsLmRldmVsb3BlcnMud29ya2Vycy5kZXYvZGIxOWViOGJlOWY0NDQzYWFiOTFhOTA0MmMwZDM1MTcnLAogICAgICAgICAgICAnZXhwaXJlc19hdCc6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgICAgIH07CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgMTU1LCB0YWlsKTsKICAgICAgICBjYWxsYmFja3Mub25UYWlsc0NoYW5nZWQobmV3IFNldChbCiAgICAgICAgICAgIHBhY2tUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpCiAgICAgICAgXSkpOwogICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCA0Mik7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IDI7IGkrKyl7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZVJlcXVlc3QoKSk7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZURvUmVxdWVzdCgpKTsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlUmVxdWVzdFdpdGhMb2dzKCkpOwogICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgY29tcHV0ZUZha2VSZXF1ZXN0RXhjZWVkaW5nVGltZUxpbWl0KCkpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBVU0VSX0FHRU5UID0gJ01vemlsbGEvNS4wIChNYWNpbnRvc2g7IEludGVsIE1hYyBPUyBYIDEwLjE1OyBydjo5MS4wKSBHZWNrby8yMDEwMDEwMSBGaXJlZm94LzkxLjAnOwpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3QoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2V4YW1wbGUuY29tL2VuZHBvaW50JywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ2NmLWNvbm5lY3RpbmctaXAnOiAnMjAzLjAuMTEzLjEyJywKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFVTRVJfQUdFTlQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjZjogewogICAgICAgICAgICAgICAgICAgIGNvbG86ICdERlcnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFtdLAogICAgICAgIGV4Y2VwdGlvbnM6IFtdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdvaycKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUZha2VEb1JlcXVlc3QoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2Zha2UtaG9zdC9wdXQnLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnUFVUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHt9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdsb2cnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdsb2dwcm9wczonLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sbzogJ0VXUicsCiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGVPYmplY3RDbGFzczogJ0xvZ2dlckRPJywKICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZU9iamVjdElkOiAnNTM4ZmM3Y2U1NWIxNGU1M2I2Yjg1NTJiZWZlYjlhZjQnLAogICAgICAgICAgICAgICAgICAgICAgICBkdXJhYmxlT2JqZWN0TmFtZTogJ2xvZzEnCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV4Y2VwdGlvbnM6IFtdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdvaycKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUZha2VSZXF1ZXN0V2l0aExvZ3MoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL215LXdvcmtlci5zdWJkb21haW4ud29ya2Vycy5kZXYvdGVzdD9sb2c9dHJ1ZScsCiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgICAgICdjZi1jb25uZWN0aW5nLWlwJzogJzIwMy4wLjExMy4xMicsCiAgICAgICAgICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiBVU0VSX0FHRU5UCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2Y6IHsKICAgICAgICAgICAgICAgICAgICBjb2xvOiAnREZXJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsb2dzOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnbG9nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdlcnJvcicsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnaW5mbycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnd2FybmluZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnZGVidWcnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV4Y2VwdGlvbnM6IFtdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdvaycKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUZha2VSZXF1ZXN0RXhjZWVkaW5nVGltZUxpbWl0KCkgewogICAgY29uc3QgcnQgPSB7CiAgICAgICAgZXZlbnQ6IHsKICAgICAgICAgICAgcmVxdWVzdDogewogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9teS13b3JrZXIuc3ViZG9tYWluLndvcmtlcnMuZGV2L2NvbXB1dGUtZGlnaXRzLW9mLXBpJywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ2NmLWNvbm5lY3RpbmctaXAnOiAnMjAzLjAuMTEzLjEyJywKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFVTRVJfQUdFTlQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjZjogewogICAgICAgICAgICAgICAgICAgIGNvbG86ICdERlcnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdsb2cnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdidXJuaW5nIGNwdScKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwgCiAgICAgICAgXSwKICAgICAgICBleGNlcHRpb25zOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWU6ICdFcnJvcicsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnV29ya2VyIGV4Y2VlZGVkIENQVSB0aW1lIGxpbWl0LicKICAgICAgICAgICAgfSwgCiAgICAgICAgXSwKICAgICAgICBldmVudFRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICBvdXRjb21lOiAnZXhjZWVkZWRDcHUnCiAgICB9OwogICAgcmV0dXJuIHJ0Owp9CmNsYXNzIFFwc0NvbnRyb2xsZXIgewogICAgc29ydGVkRXZlbnRUaW1lcyA9IFtdOwogICAgY2FsbGJhY2tzOwogICAgbjsKICAgIF9xcHMgPSAwOwogICAgZ2V0IHFwcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcXBzOwogICAgfQogICAgY29uc3RydWN0b3IobiwgY2FsbGJhY2tzKXsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICB0aGlzLm4gPSBuOwogICAgfQogICAgYWRkRXZlbnQoZXZlbnRUaW1lKSB7CiAgICAgICAgY29uc3QgcXBzID0gY29tcHV0ZVFwcyh0aGlzLm4sIHRoaXMuc29ydGVkRXZlbnRUaW1lcywgZXZlbnRUaW1lKTsKICAgICAgICBpZiAocXBzID09PSB0aGlzLl9xcHMpIHJldHVybjsKICAgICAgICB0aGlzLl9xcHMgPSBxcHM7CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25RcHNDaGFuZ2VkKHFwcyk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZVFwcyhuLCBzb3J0ZWRFdmVudFRpbWVzLCBldmVudFRpbWUpIHsKICAgIGFkZChldmVudFRpbWUsIHNvcnRlZEV2ZW50VGltZXMpOwogICAgd2hpbGUoc29ydGVkRXZlbnRUaW1lcy5sZW5ndGggPiBuKXsKICAgICAgICBzb3J0ZWRFdmVudFRpbWVzLnNoaWZ0KCk7CiAgICB9CiAgICBjb25zdCBudW0gPSBzb3J0ZWRFdmVudFRpbWVzLmxlbmd0aDsKICAgIGlmIChudW0gPCAyKSByZXR1cm4gMDsKICAgIGNvbnN0IHRpbWVEaWZmU2Vjb25kcyA9IChzb3J0ZWRFdmVudFRpbWVzW3NvcnRlZEV2ZW50VGltZXMubGVuZ3RoIC0gMV0gLSBzb3J0ZWRFdmVudFRpbWVzWzBdKSAvIDEwMDA7CiAgICByZXR1cm4gKG51bSAtIDEpIC8gdGltZURpZmZTZWNvbmRzOwp9CmZ1bmN0aW9uIGFkZChlbCwgYXJyKSB7CiAgICBhcnIuc3BsaWNlKGZpbmRMb2MoZWwsIGFycikgKyAxLCAwLCBlbCk7CiAgICByZXR1cm4gYXJyOwp9CmZ1bmN0aW9uIGZpbmRMb2MoZWwsIGFyciwgc3QsIGVuKSB7CiAgICBzdCA9IHN0IHx8IDA7CiAgICBlbiA9IGVuIHx8IGFyci5sZW5ndGg7CiAgICBmb3IobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoYXJyW2ldID4gZWwpIHsKICAgICAgICAgICAgcmV0dXJuIGkgLSAxOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbjsKfQpmdW5jdGlvbiBjaGVja0VxdWFsKG5hbWUsIHZhbHVlLCBleHBlY3RlZCkgewogICAgaWYgKHZhbHVlICE9PSBleHBlY3RlZCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogZXhwZWN0ZWQgJHtleHBlY3RlZH0sIGZvdW5kICR7dmFsdWV9YCk7Cn0KZnVuY3Rpb24gY2hlY2tNYXRjaGVzKG5hbWUsIHZhbHVlLCBwYXR0ZXJuKSB7CiAgICBpZiAoIXBhdHRlcm4udGVzdCh2YWx1ZSkpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9YCk7CiAgICByZXR1cm4gdmFsdWU7Cn0KY2xhc3MgR3JhcGhxbFF1ZXJ5IHsKICAgIF9wYXJlbnQ7CiAgICBfbm9kZXM7CiAgICBfbm9kZU9yZGVyOwogICAgX2FyZ3M7CiAgICBfYXJnT3JkZXI7CiAgICBjb25zdHJ1Y3RvcihwYXJlbnQsIG5vZGVzLCBub2RlT3JkZXIsIGFyZ3MsIGFyZ09yZGVyKXsKICAgICAgICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgdGhpcy5fbm9kZXMgPSBub2RlczsKICAgICAgICB0aGlzLl9ub2RlT3JkZXIgPSBub2RlT3JkZXI7CiAgICAgICAgdGhpcy5fYXJncyA9IGFyZ3M7CiAgICAgICAgdGhpcy5fYXJnT3JkZXIgPSBhcmdPcmRlcjsKICAgIH0KICAgIHN0YXRpYyBjcmVhdGUoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBHcmFwaHFsUXVlcnkoW10sIG5ldyBNYXAoKSwgW10sIG5ldyBNYXAoKSwgW10pOwogICAgfQogICAgc2NhbGFyKG5hbWUpIHsKICAgICAgICB0aGlzLmFkZChuYW1lLCBOb2RlS2luZC5TY2FsYXIpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgb2JqZWN0KG5hbWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5hZGQobmFtZSwgTm9kZUtpbmQuT2JqZWN0KTsKICAgICAgICBjb25zdCBydCA9IG5ldyBHcmFwaHFsUXVlcnkoWwogICAgICAgICAgICB0aGlzCiAgICAgICAgXSwgbmV3IE1hcCgpLCBbXSwgbmV3IE1hcCgpLCBbXSk7CiAgICAgICAgbm9kZS5xdWVyeS5wdXNoKHJ0KTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICBvYmplY3RRdWVyeShuYW1lLCBxdWVyeTIpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5hZGQobmFtZSwgTm9kZUtpbmQuT2JqZWN0KTsKICAgICAgICBjb25zdCBxID0gcXVlcnkyLmNvcHlXaXRoUGFyZW50KHRoaXMpOwogICAgICAgIGNvbnN0IHJ0ID0gcTsKICAgICAgICBub2RlLnF1ZXJ5LnB1c2gocnQpOwogICAgICAgIHJldHVybiBydDsKICAgIH0KICAgIGFyZ1JhdyhuYW1lLCByYXdWYWx1ZSkgewogICAgICAgIHJldHVybiB0aGlzLmFkZEFyZyhuYW1lLCByYXdWYWx1ZSk7CiAgICB9CiAgICBhcmdCb29sZWFuKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkQXJnKG5hbWUsIHZhbHVlID8gJ3RydWUnIDogJ2ZhbHNlJyk7CiAgICB9CiAgICBhcmdMb25nKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkQXJnKG5hbWUsIGAke3ZhbHVlfWApOwogICAgfQogICAgYXJnU3RyaW5nKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkQXJnKG5hbWUsIGAiJHt2YWx1ZS5yZXBsYWNlQWxsKCciJywgJ1xcIicpfSJgKTsKICAgIH0KICAgIGFyZ09iamVjdChuYW1lLCBmaWVsZE5hbWUsIGZpZWxkVmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgYHske2ZpZWxkTmFtZX06IiR7ZmllbGRWYWx1ZS5yZXBsYWNlQWxsKCciJywgJ1xcIicpfSJ9YCk7CiAgICB9CiAgICBhcmdWYXJpYWJsZShuYW1lLCB2YXJpYWJsZU5hbWUpIHsKICAgICAgICBjaGVja01hdGNoZXMoJ3ZhcmlhYmxlTmFtZScsIHZhcmlhYmxlTmFtZSwgL15bYS16XSskLyk7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkQXJnKG5hbWUsIGAkJHt2YXJpYWJsZU5hbWV9YCk7CiAgICB9CiAgICBlbmQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudC5sZW5ndGggPiAwID8gdGhpcy5fcGFyZW50WzBdIDogdGhpczsKICAgIH0KICAgIHRvcCgpIHsKICAgICAgICBsZXQgcnQgPSB0aGlzOwogICAgICAgIHdoaWxlKHJ0Ll9wYXJlbnQubGVuZ3RoID4gMCl7CiAgICAgICAgICAgIHJ0ID0gcnQuX3BhcmVudFswXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgY29uc3QgbGluZXMgPSBbXTsKICAgICAgICBsaW5lcy5wdXNoKCd7Jyk7CiAgICAgICAgdGhpcy53cml0ZShsaW5lcywgMSk7CiAgICAgICAgbGluZXMucHVzaCgnfScpOwogICAgICAgIHJldHVybiBsaW5lcy5qb2luKCdcbicpOwogICAgfQogICAgYWRkQXJnKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX2FyZ3MuaGFzKG5hbWUpKSB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBhcmc6ICR7bmFtZX1gKTsKICAgICAgICB0aGlzLl9hcmdPcmRlci5wdXNoKG5hbWUpOwogICAgICAgIHRoaXMuX2FyZ3Muc2V0KG5hbWUsIHZhbHVlKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHdyaXRlKGxpbmVzLCBsZXZlbCkgewogICAgICAgIGNvbnN0IGluZGVudCA9ICcgICcucmVwZWF0KGxldmVsKTsKICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLl9ub2RlT3JkZXIpewogICAgICAgICAgICBjb25zdCBub2RlID0gY2hlY2tHZXQoJ19ub2RlcycsIHRoaXMuX25vZGVzLCBrZXkpOwogICAgICAgICAgICBpZiAobm9kZS5raW5kID09PSBOb2RlS2luZC5TY2FsYXIpIHsKICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCR7aW5kZW50fSR7a2V5fWApOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUua2luZCA9PT0gTm9kZUtpbmQuT2JqZWN0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBxID0gbm9kZS5xdWVyeVswXTsKICAgICAgICAgICAgICAgIGxldCBsaW5lID0gYCR7aW5kZW50fSR7a2V5fWA7CiAgICAgICAgICAgICAgICBpZiAocS5fYXJnT3JkZXIubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGxpbmUgKz0gJygnOwogICAgICAgICAgICAgICAgICAgIGxldCBqID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGFyZ05hbWUgb2YgcS5fYXJnT3JkZXIpewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDApIGxpbmUgKz0gJywgJzsKICAgICAgICAgICAgICAgICAgICAgICAgbGluZSArPSBgJHthcmdOYW1lfTogJHtjaGVja0dldCgncS5fYXJncycsIHEuX2FyZ3MsIGFyZ05hbWUpfWA7CiAgICAgICAgICAgICAgICAgICAgICAgIGorKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGluZSArPSAnKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaW5lICs9ICcgeyc7CiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGxpbmUpOwogICAgICAgICAgICAgICAgbm9kZS5xdWVyeVswXS53cml0ZShsaW5lcywgbGV2ZWwgKyAxKTsKICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCR7aW5kZW50fX1gKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW1wbGVtZW50IG5vZGUga2luZCAke25vZGUua2luZH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFkZChuYW1lLCBraW5kKSB7CiAgICAgICAgaWYgKHRoaXMuX25vZGVzLmhhcyhuYW1lKSkgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgZmllbGQ6ICR7bmFtZX1gKTsKICAgICAgICBjb25zdCBydCA9IG5ldyBOb2RlMShraW5kKTsKICAgICAgICB0aGlzLl9ub2Rlcy5zZXQobmFtZSwgcnQpOwogICAgICAgIHRoaXMuX25vZGVPcmRlci5wdXNoKG5hbWUpOwogICAgICAgIHJldHVybiBydDsKICAgIH0KICAgIGNvcHlXaXRoUGFyZW50KHBhcmVudCkgewogICAgICAgIGNvbnN0IG5vZGVzID0gbmV3IE1hcCgpOwogICAgICAgIGNvbnN0IG5vZGVPcmRlciA9IFsKICAgICAgICAgICAgLi4udGhpcy5fbm9kZU9yZGVyCiAgICAgICAgXTsKICAgICAgICBjb25zdCBhcmdzID0gbmV3IE1hcCgpOwogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHRoaXMuX2FyZ3MuZW50cmllcygpKXsKICAgICAgICAgICAgYXJncy5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFyZ09yZGVyID0gWwogICAgICAgICAgICAuLi50aGlzLl9hcmdPcmRlcgogICAgICAgIF07CiAgICAgICAgY29uc3QgcnQgPSBuZXcgR3JhcGhxbFF1ZXJ5KFsKICAgICAgICAgICAgcGFyZW50CiAgICAgICAgXSwgbm9kZXMsIG5vZGVPcmRlciwgYXJncywgYXJnT3JkZXIpOwogICAgICAgIGZvciAoY29uc3QgW2tleTEsIG5vZGVdIG9mIHRoaXMuX25vZGVzLmVudHJpZXMoKSl7CiAgICAgICAgICAgIGNvbnN0IG5ld05vZGUgPSBuZXcgTm9kZTEobm9kZS5raW5kKTsKICAgICAgICAgICAgaWYgKG5vZGUucXVlcnkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgbmV3UXVlcnkgPSBub2RlLnF1ZXJ5WzBdLmNvcHlXaXRoUGFyZW50KHJ0KTsKICAgICAgICAgICAgICAgIG5ld05vZGUucXVlcnkucHVzaChuZXdRdWVyeSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZXMuc2V0KGtleTEsIG5ld05vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcnQ7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tHZXQobWFwTmFtZSwgbWFwLCBrZXkpIHsKICAgIGNvbnN0IHJ0ID0gbWFwLmdldChrZXkpOwogICAgaWYgKCFydCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHttYXBOYW1lfS5rZXk6ICR7a2V5fWApOwogICAgcmV0dXJuIHJ0Owp9CnZhciBOb2RlS2luZDsKKGZ1bmN0aW9uKE5vZGVLaW5kMSkgewogICAgTm9kZUtpbmQxW05vZGVLaW5kMVsiU2NhbGFyIl0gPSAxXSA9ICJTY2FsYXIiOwogICAgTm9kZUtpbmQxW05vZGVLaW5kMVsiT2JqZWN0Il0gPSAyXSA9ICJPYmplY3QiOwp9KShOb2RlS2luZCB8fCAoTm9kZUtpbmQgPSB7fSkpOwpjbGFzcyBOb2RlMSB7CiAgICBraW5kOwogICAgcXVlcnkgPSBbXTsKICAgIGNvbnN0cnVjdG9yKGtpbmQpewogICAgICAgIHRoaXMua2luZCA9IGtpbmQ7CiAgICB9Cn0KY2xhc3MgQ2ZHcWxDbGllbnQgewogICAgc3RhdGljIERFQlVHID0gZmFsc2U7CiAgICBzdGF0aWMgVVJMX1RSQU5TRk9STUVSID0gKHYpPT52CiAgICA7CiAgICBwcm9maWxlOwogICAgY29uc3RydWN0b3IocHJvZmlsZSl7CiAgICAgICAgdGhpcy5wcm9maWxlID0gcHJvZmlsZTsKICAgIH0KICAgIGFzeW5jIGdldER1cmFibGVPYmplY3RQZXJpb2RpY01ldHJpY3NCeURhdGUoc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9nZXREdXJhYmxlT2JqZWN0UGVyaW9kaWNNZXRyaWNzQnlEYXRlKHRoaXMucHJvZmlsZSwgc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKTsKICAgIH0KICAgIGFzeW5jIGdldER1cmFibGVPYmplY3RTdG9yYWdlQnlEYXRlKHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSkgewogICAgICAgIHJldHVybiBhd2FpdCBfZ2V0RHVyYWJsZU9iamVjdFN0b3JhZ2VCeURhdGUodGhpcy5wcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpOwogICAgfQogICAgYXN5bmMgZ2V0RHVyYWJsZU9iamVjdEludm9jYXRpb25zQnlEYXRlKHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSkgewogICAgICAgIHJldHVybiBhd2FpdCBfZ2V0RHVyYWJsZU9iamVjdEludm9jYXRpb25zQnlEYXRlKHRoaXMucHJvZmlsZSwgc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKTsKICAgIH0KfQphc3luYyBmdW5jdGlvbiBxdWVyeShwcm9maWxlLCBxdWVyeUZuLCB2YXJpYWJsZXMpIHsKICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgY29uc3QgcSA9IEdyYXBocWxRdWVyeS5jcmVhdGUoKS5zY2FsYXIoJ2Nvc3QnKS5vYmplY3QoJ3ZpZXdlcicpLnNjYWxhcignYnVkZ2V0Jykub2JqZWN0KCdhY2NvdW50cycpLmFyZ09iamVjdCgnZmlsdGVyJywgJ2FjY291bnRUYWcnLCBhY2NvdW50SWQpLnNjYWxhcignYWNjb3VudFRhZycpOwogICAgcXVlcnlGbihxKTsKICAgIGNvbnN0IHF1ZXJ5MSA9IHEudG9wKCkudG9TdHJpbmcoKTsKICAgIGlmIChDZkdxbENsaWVudC5ERUJVRykgY29uc29sZS5sb2cocXVlcnkxKTsKICAgIGNvbnN0IHJlcU9iaiA9IHsKICAgICAgICBxdWVyeTogcXVlcnkxLAogICAgICAgIHZhcmlhYmxlcwogICAgfTsKICAgIGNvbnN0IGJvZHkgPSBKU09OLnN0cmluZ2lmeShyZXFPYmopOwogICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgY29uc3QgdXJsID0gQ2ZHcWxDbGllbnQuVVJMX1RSQU5TRk9STUVSKCdodHRwczovL2FwaS5jbG91ZGZsYXJlLmNvbS9jbGllbnQvdjQvZ3JhcGhxbCcpOwogICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsLCB7CiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnLAogICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthcGlUb2tlbn1gCiAgICAgICAgfSwKICAgICAgICBib2R5CiAgICB9KTsKICAgIGNvbnN0IGZldGNoTWlsbGlzID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgaWYgKENmR3FsQ2xpZW50LkRFQlVHKSBjb25zb2xlLmxvZyhyZXMpOwogICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgcmVzLnN0YXR1czogJHtyZXMuc3RhdHVzfSwgZXhwZWN0ZWQgMjAwLCB0ZXh0PSR7YXdhaXQgcmVzLnRleHQoKX1gKTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVzLmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKTsKICAgIGlmIChjb250ZW50VHlwZSAhPT0gJ2FwcGxpY2F0aW9uL2pzb24nKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCByZXMuY29udGVudFR5cGU6ICR7Y29udGVudFR5cGV9LCBleHBlY3RlZCBhcHBsaWNhdGlvbi9qc29uLCBmb3VuZCAke2NvbnRlbnRUeXBlfSwgdGV4dD0ke2F3YWl0IHJlcy50ZXh0KCl9YCk7CiAgICBjb25zdCByZXNPYmogPSBhd2FpdCByZXMuanNvbigpOwogICAgcmVzT2JqLmZldGNoTWlsbGlzID0gZmV0Y2hNaWxsaXM7CiAgICBpZiAoQ2ZHcWxDbGllbnQuREVCVUcpIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlc09iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICBpZiAoaXNHcWxFcnJvclJlc3BvbnNlKHJlc09iaikpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzT2JqLmVycm9ycy5tYXAoY29tcHV0ZUdxbEVycm9yU3RyaW5nKS5qb2luKCcsICcpKTsKICAgIH0KICAgIHJldHVybiByZXNPYmo7Cn0KZnVuY3Rpb24gaXNHcWxFcnJvclJlc3BvbnNlKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmIG9iai5kYXRhID09PSBudWxsICYmIEFycmF5LmlzQXJyYXkob2JqLmVycm9ycyk7Cn0KZnVuY3Rpb24gY29tcHV0ZUdxbEVycm9yU3RyaW5nKGVycm9yKSB7CiAgICBjb25zdCBwaWVjZXMgPSBbCiAgICAgICAgZXJyb3IubWVzc2FnZQogICAgXTsKICAgIGlmIChlcnJvci5wYXRoKSBwaWVjZXMucHVzaChgKCR7ZXJyb3IucGF0aC5qb2luKCcvJyl9KWApOwogICAgaWYgKGVycm9yLmV4dGVuc2lvbnMuY29kZSkgcGllY2VzLnB1c2goYChjb2RlPSR7ZXJyb3IuZXh0ZW5zaW9ucy5jb2RlfSlgKTsKICAgIHJldHVybiBwaWVjZXMuam9pbignICcpOwp9CmFzeW5jIGZ1bmN0aW9uIF9nZXREdXJhYmxlT2JqZWN0UGVyaW9kaWNNZXRyaWNzQnlEYXRlKHByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSkgewogICAgY29uc3QgcmVzT2JqID0gYXdhaXQgcXVlcnkocHJvZmlsZSwgKHEpPT5xLm9iamVjdCgnZHVyYWJsZU9iamVjdHNQZXJpb2RpY0dyb3VwcycpLmFyZ0xvbmcoJ2xpbWl0JywgMTAwMDApLmFyZ1JhdygnZmlsdGVyJywgYHtkYXRlX2dlcTogJHN0YXJ0LCBkYXRlX2xlcTogJGVuZH1gKS5hcmdSYXcoJ29yZGVyQnknLCBgW2RhdGVfQVNDXWApLm9iamVjdCgnZGltZW5zaW9ucycpLnNjYWxhcignZGF0ZScpLnNjYWxhcignbmFtZXNwYWNlSWQnKS5lbmQoKS5vYmplY3QoJ21heCcpLnNjYWxhcignYWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMnKS5lbmQoKS5vYmplY3QoJ3N1bScpLnNjYWxhcignYWN0aXZlVGltZScpLnNjYWxhcignY3B1VGltZScpLnNjYWxhcignZXhjZWVkZWRDcHVFcnJvcnMnKS5zY2FsYXIoJ2V4Y2VlZGVkTWVtb3J5RXJyb3JzJykuc2NhbGFyKCdmYXRhbEludGVybmFsRXJyb3JzJykuc2NhbGFyKCdpbmJvdW5kV2Vic29ja2V0TXNnQ291bnQnKS5zY2FsYXIoJ291dGJvdW5kV2Vic29ja2V0TXNnQ291bnQnKS5zY2FsYXIoJ3N0b3JhZ2VEZWxldGVzJykuc2NhbGFyKCdzdG9yYWdlUmVhZFVuaXRzJykuc2NhbGFyKCdzdG9yYWdlV3JpdGVVbml0cycpLnNjYWxhcignc3VicmVxdWVzdHMnKQogICAgLCB7CiAgICAgICAgc3RhcnQ6IHN0YXJ0RGF0ZUluY2x1c2l2ZSwKICAgICAgICBlbmQ6IGVuZERhdGVJbmNsdXNpdmUKICAgIH0pOwogICAgY29uc3QgZmV0Y2hNaWxsaXMgPSByZXNPYmouZmV0Y2hNaWxsaXM7CiAgICBjb25zdCByZXMgPSByZXNPYmo7CiAgICBjb25zdCBjb3N0ID0gcmVzLmRhdGEuY29zdDsKICAgIGNvbnN0IGJ1ZGdldCA9IHJlcy5kYXRhLnZpZXdlci5idWRnZXQ7CiAgICBjb25zdCByb3dzID0gW107CiAgICBmb3IgKGNvbnN0IGFjY291bnQgb2YgcmVzLmRhdGEudmlld2VyLmFjY291bnRzKXsKICAgICAgICBjaGVja0VxdWFsKCdhY2NvdW50LmFjY291bnRUYWcnLCBhY2NvdW50LmFjY291bnRUYWcsIHByb2ZpbGUuYWNjb3VudElkKTsKICAgICAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGFjY291bnQuZHVyYWJsZU9iamVjdHNQZXJpb2RpY0dyb3Vwcyl7CiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBncm91cC5kaW1lbnNpb25zLmRhdGU7CiAgICAgICAgICAgIGNvbnN0IG5hbWVzcGFjZUlkID0gZ3JvdXAuZGltZW5zaW9ucy5uYW1lc3BhY2VJZDsKICAgICAgICAgICAgY29uc3QgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMgPSBncm91cC5tYXguYWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnM7CiAgICAgICAgICAgIGNvbnN0IHN1bUFjdGl2ZVRpbWUgPSBncm91cC5zdW0uYWN0aXZlVGltZTsKICAgICAgICAgICAgY29uc3Qgc3VtQ3B1VGltZSA9IGdyb3VwLnN1bS5jcHVUaW1lOwogICAgICAgICAgICBjb25zdCBzdW1FeGNlZWRlZENwdUVycm9ycyA9IGdyb3VwLnN1bS5leGNlZWRlZENwdUVycm9yczsKICAgICAgICAgICAgY29uc3Qgc3VtRXhjZWVkZWRNZW1vcnlFcnJvcnMgPSBncm91cC5zdW0uZXhjZWVkZWRNZW1vcnlFcnJvcnM7CiAgICAgICAgICAgIGNvbnN0IHN1bUZhdGFsSW50ZXJuYWxFcnJvcnMgPSBncm91cC5zdW0uZmF0YWxJbnRlcm5hbEVycm9yczsKICAgICAgICAgICAgY29uc3Qgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50ID0gZ3JvdXAuc3VtLmluYm91bmRXZWJzb2NrZXRNc2dDb3VudDsKICAgICAgICAgICAgY29uc3Qgc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCA9IGdyb3VwLnN1bS5vdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50OwogICAgICAgICAgICBjb25zdCBzdW1TdG9yYWdlRGVsZXRlcyA9IGdyb3VwLnN1bS5zdG9yYWdlRGVsZXRlczsKICAgICAgICAgICAgY29uc3Qgc3VtU3RvcmFnZVJlYWRVbml0cyA9IGdyb3VwLnN1bS5zdG9yYWdlUmVhZFVuaXRzOwogICAgICAgICAgICBjb25zdCBzdW1TdG9yYWdlV3JpdGVVbml0cyA9IGdyb3VwLnN1bS5zdG9yYWdlV3JpdGVVbml0czsKICAgICAgICAgICAgY29uc3Qgc3VtU3VicmVxdWVzdHMgPSBncm91cC5zdW0uc3VicmVxdWVzdHM7CiAgICAgICAgICAgIHJvd3MucHVzaCh7CiAgICAgICAgICAgICAgICBkYXRlLAogICAgICAgICAgICAgICAgbmFtZXNwYWNlSWQsCiAgICAgICAgICAgICAgICBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucywKICAgICAgICAgICAgICAgIHN1bUFjdGl2ZVRpbWUsCiAgICAgICAgICAgICAgICBzdW1DcHVUaW1lLAogICAgICAgICAgICAgICAgc3VtRXhjZWVkZWRDcHVFcnJvcnMsCiAgICAgICAgICAgICAgICBzdW1FeGNlZWRlZE1lbW9yeUVycm9ycywKICAgICAgICAgICAgICAgIHN1bUZhdGFsSW50ZXJuYWxFcnJvcnMsCiAgICAgICAgICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgICAgICBzdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgICAgICAgICAgc3VtU3RvcmFnZURlbGV0ZXMsCiAgICAgICAgICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzLAogICAgICAgICAgICAgICAgc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgICAgICBzdW1TdWJyZXF1ZXN0cwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGluZm86IHsKICAgICAgICAgICAgZmV0Y2hNaWxsaXMsCiAgICAgICAgICAgIGNvc3QsCiAgICAgICAgICAgIGJ1ZGdldAogICAgICAgIH0sCiAgICAgICAgcm93cwogICAgfTsKfQphc3luYyBmdW5jdGlvbiBfZ2V0RHVyYWJsZU9iamVjdFN0b3JhZ2VCeURhdGUocHJvZmlsZSwgc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKSB7CiAgICBjb25zdCByZXNPYmogPSBhd2FpdCBxdWVyeShwcm9maWxlLCAocSk9PnEub2JqZWN0KCdkdXJhYmxlT2JqZWN0c1N0b3JhZ2VHcm91cHMnKS5hcmdMb25nKCdsaW1pdCcsIDEwMDAwKS5hcmdSYXcoJ2ZpbHRlcicsIGB7ZGF0ZV9nZXE6ICRzdGFydCwgZGF0ZV9sZXE6ICRlbmR9YCkuYXJnUmF3KCdvcmRlckJ5JywgYFtkYXRlX0FTQ11gKS5vYmplY3QoJ2RpbWVuc2lvbnMnKS5zY2FsYXIoJ2RhdGUnKS5lbmQoKS5vYmplY3QoJ21heCcpLnNjYWxhcignc3RvcmVkQnl0ZXMnKS5lbmQoKQogICAgLCB7CiAgICAgICAgc3RhcnQ6IHN0YXJ0RGF0ZUluY2x1c2l2ZSwKICAgICAgICBlbmQ6IGVuZERhdGVJbmNsdXNpdmUKICAgIH0pOwogICAgY29uc3QgZmV0Y2hNaWxsaXMgPSByZXNPYmouZmV0Y2hNaWxsaXM7CiAgICBjb25zdCByZXMgPSByZXNPYmo7CiAgICBjb25zdCBjb3N0ID0gcmVzLmRhdGEuY29zdDsKICAgIGNvbnN0IGJ1ZGdldCA9IHJlcy5kYXRhLnZpZXdlci5idWRnZXQ7CiAgICBjb25zdCByb3dzID0gW107CiAgICBmb3IgKGNvbnN0IGFjY291bnQgb2YgcmVzLmRhdGEudmlld2VyLmFjY291bnRzKXsKICAgICAgICBjaGVja0VxdWFsKCdhY2NvdW50LmFjY291bnRUYWcnLCBhY2NvdW50LmFjY291bnRUYWcsIHByb2ZpbGUuYWNjb3VudElkKTsKICAgICAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGFjY291bnQuZHVyYWJsZU9iamVjdHNTdG9yYWdlR3JvdXBzKXsKICAgICAgICAgICAgY29uc3QgZGF0ZSA9IGdyb3VwLmRpbWVuc2lvbnMuZGF0ZTsKICAgICAgICAgICAgY29uc3QgbWF4U3RvcmVkQnl0ZXMgPSBncm91cC5tYXguc3RvcmVkQnl0ZXM7CiAgICAgICAgICAgIHJvd3MucHVzaCh7CiAgICAgICAgICAgICAgICBkYXRlLAogICAgICAgICAgICAgICAgbWF4U3RvcmVkQnl0ZXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBpbmZvOiB7CiAgICAgICAgICAgIGZldGNoTWlsbGlzLAogICAgICAgICAgICBjb3N0LAogICAgICAgICAgICBidWRnZXQKICAgICAgICB9LAogICAgICAgIHJvd3MKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gX2dldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZShwcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgIGNvbnN0IHJlc09iaiA9IGF3YWl0IHF1ZXJ5KHByb2ZpbGUsIChxKT0+cS5vYmplY3QoJ2R1cmFibGVPYmplY3RzSW52b2NhdGlvbnNBZGFwdGl2ZUdyb3VwcycpLmFyZ0xvbmcoJ2xpbWl0JywgMTAwMDApLmFyZ1JhdygnZmlsdGVyJywgYHtkYXRlX2dlcTogJHN0YXJ0LCBkYXRlX2xlcTogJGVuZH1gKS5hcmdSYXcoJ29yZGVyQnknLCBgW2RhdGVfQVNDXWApLm9iamVjdCgnZGltZW5zaW9ucycpLnNjYWxhcignZGF0ZScpLnNjYWxhcignbmFtZXNwYWNlSWQnKS5lbmQoKS5vYmplY3QoJ2F2ZycpLnNjYWxhcignc2FtcGxlSW50ZXJ2YWwnKS5lbmQoKS5vYmplY3QoJ3N1bScpLnNjYWxhcigncmVxdWVzdHMnKS5lbmQoKQogICAgLCB7CiAgICAgICAgc3RhcnQ6IHN0YXJ0RGF0ZUluY2x1c2l2ZSwKICAgICAgICBlbmQ6IGVuZERhdGVJbmNsdXNpdmUKICAgIH0pOwogICAgY29uc3QgZmV0Y2hNaWxsaXMgPSByZXNPYmouZmV0Y2hNaWxsaXM7CiAgICBjb25zdCByZXMgPSByZXNPYmo7CiAgICBjb25zdCBjb3N0ID0gcmVzLmRhdGEuY29zdDsKICAgIGNvbnN0IGJ1ZGdldCA9IHJlcy5kYXRhLnZpZXdlci5idWRnZXQ7CiAgICBjb25zdCByb3dzID0gW107CiAgICBmb3IgKGNvbnN0IGFjY291bnQgb2YgcmVzLmRhdGEudmlld2VyLmFjY291bnRzKXsKICAgICAgICBjaGVja0VxdWFsKCdhY2NvdW50LmFjY291bnRUYWcnLCBhY2NvdW50LmFjY291bnRUYWcsIHByb2ZpbGUuYWNjb3VudElkKTsKICAgICAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGFjY291bnQuZHVyYWJsZU9iamVjdHNJbnZvY2F0aW9uc0FkYXB0aXZlR3JvdXBzKXsKICAgICAgICAgICAgY29uc3QgZGF0ZSA9IGdyb3VwLmRpbWVuc2lvbnMuZGF0ZTsKICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlSWQgPSBncm91cC5kaW1lbnNpb25zLm5hbWVzcGFjZUlkOwogICAgICAgICAgICBjb25zdCBhdmdTYW1wbGVJbnRlcnZhbCA9IGdyb3VwLmF2Zy5zYW1wbGVJbnRlcnZhbDsKICAgICAgICAgICAgY29uc3Qgc3VtUmVxdWVzdHMgPSBncm91cC5zdW0ucmVxdWVzdHM7CiAgICAgICAgICAgIHJvd3MucHVzaCh7CiAgICAgICAgICAgICAgICBkYXRlLAogICAgICAgICAgICAgICAgbmFtZXNwYWNlSWQsCiAgICAgICAgICAgICAgICBhdmdTYW1wbGVJbnRlcnZhbCwKICAgICAgICAgICAgICAgIHN1bVJlcXVlc3RzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgaW5mbzogewogICAgICAgICAgICBmZXRjaE1pbGxpcywKICAgICAgICAgICAgY29zdCwKICAgICAgICAgICAgYnVkZ2V0CiAgICAgICAgfSwKICAgICAgICByb3dzCiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVEdXJhYmxlT2JqZWN0c0Nvc3RzVGFibGUoY2xpZW50LCBvcHRzKSB7CiAgICBjb25zdCB7IHN0YXJ0OiBzdGFydDEgLCBlbmQ6IGVuZDEgIH0gPSAoKCk9PnsKICAgICAgICBpZiAoJ2xvb2tiYWNrRGF5cycgaW4gb3B0cykgewogICAgICAgICAgICBjb25zdCBlbmQgPSB1dGNDdXJyZW50RGF0ZSgpOwogICAgICAgICAgICBjb25zdCBzdGFydCA9IGFkZERheXNUb0RhdGUoZW5kLCAtb3B0cy5sb29rYmFja0RheXMpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgICBlbmQKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCB7IHN0YXJ0ICwgZW5kICB9ID0gb3B0czsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICAgICAgZW5kCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSkoKTsKICAgIGNvbnN0IFtzdG9yYWdlLCBwZXJpb2RpYywgaW52b2NhdGlvbnMsIG5hbWVzcGFjZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICAgIGNsaWVudC5nZXREdXJhYmxlT2JqZWN0U3RvcmFnZUJ5RGF0ZShzdGFydDEsIGVuZDEpLAogICAgICAgIGNsaWVudC5nZXREdXJhYmxlT2JqZWN0UGVyaW9kaWNNZXRyaWNzQnlEYXRlKHN0YXJ0MSwgZW5kMSksCiAgICAgICAgY2xpZW50LmdldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZShzdGFydDEsIGVuZDEpLAogICAgICAgIHRyeUxpc3REdXJhYmxlT2JqZWN0c05hbWVzcGFjZXMoY2xpZW50LnByb2ZpbGUpLCAKICAgIF0pOwogICAgY29uc3QgZ3FsUmVzdWx0SW5mb3MgPSB7CiAgICAgICAgJ3N0b3JhZ2UnOiBzdG9yYWdlLmluZm8sCiAgICAgICAgJ3BlcmlvZGljJzogcGVyaW9kaWMuaW5mbywKICAgICAgICAnaW52b2NhdGlvbnMnOiBpbnZvY2F0aW9ucy5pbmZvCiAgICB9OwogICAgY29uc3Qgcm93c0J5TmFtZXNwYWNlID0ge307CiAgICBjb25zdCByb3dzQnlEYXRlID0ge307CiAgICBmb3IgKGNvbnN0IHBSb3cgb2YgcGVyaW9kaWMucm93cyl7CiAgICAgICAgY29uc3QgeyBkYXRlICwgbmFtZXNwYWNlSWQgLCBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyAsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCAsIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdW1TdWJyZXF1ZXN0cyAsIHN1bUFjdGl2ZVRpbWUgLCBzdW1TdG9yYWdlUmVhZFVuaXRzICwgc3VtU3RvcmFnZVdyaXRlVW5pdHMgLCBzdW1TdG9yYWdlRGVsZXRlcyAsICB9ID0gcFJvdzsKICAgICAgICBsZXQgcm93cyA9IHJvd3NCeU5hbWVzcGFjZVtuYW1lc3BhY2VJZF07CiAgICAgICAgaWYgKCFyb3dzKSB7CiAgICAgICAgICAgIHJvd3MgPSBbXTsKICAgICAgICAgICAgcm93c0J5TmFtZXNwYWNlW25hbWVzcGFjZUlkXSA9IHJvd3M7CiAgICAgICAgfQogICAgICAgIGxldCBkYXRlUm93cyA9IHJvd3NCeURhdGVbZGF0ZV07CiAgICAgICAgaWYgKCFkYXRlUm93cykgewogICAgICAgICAgICBkYXRlUm93cyA9IFtdOwogICAgICAgICAgICByb3dzQnlEYXRlW2RhdGVdID0gZGF0ZVJvd3M7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsgc3VtUmVxdWVzdHMgIH0gPSBpbnZvY2F0aW9ucy5yb3dzLmZpbHRlcigodik9PnYuZGF0ZSA9PT0gZGF0ZSAmJiB2Lm5hbWVzcGFjZUlkID09PSBuYW1lc3BhY2VJZAogICAgICAgIClbMF0gfHwgewogICAgICAgICAgICBzdW1SZXF1ZXN0czogMAogICAgICAgIH07CiAgICAgICAgY29uc3QgeyByZXF1ZXN0c0Nvc3QgLCB3ZWJzb2NrZXRzQ29zdCAsIHN1YnJlcXVlc3RzQ29zdCAsIGFjdGl2ZUNvc3QgLCByZWFkVW5pdHNDb3N0ICwgd3JpdGVVbml0c0Nvc3QgLCBkZWxldGVzQ29zdCAsIHRvdGFsQ29zdCAsIGFjdGl2ZUdiU2Vjb25kcyAgfSA9IGNvbXB1dGVDb3N0cyh7CiAgICAgICAgICAgIHN1bVJlcXVlc3RzLAogICAgICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzLAogICAgICAgICAgICBzdW1BY3RpdmVUaW1lLAogICAgICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzLAogICAgICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0cywKICAgICAgICAgICAgc3VtU3RvcmFnZURlbGV0ZXMsCiAgICAgICAgICAgIGV4Y2x1ZGVGcmVlVXNhZ2U6IGZhbHNlLAogICAgICAgICAgICBzdG9yYWdlQ29zdDogMAogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHJvdyA9IHsKICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgc3VtUmVxdWVzdHMsCiAgICAgICAgICAgIHJlcXVlc3RzQ29zdCwKICAgICAgICAgICAgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgd2Vic29ja2V0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzLAogICAgICAgICAgICBzdWJyZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIHN1bUFjdGl2ZVRpbWUsCiAgICAgICAgICAgIGFjdGl2ZUdiU2Vjb25kcywKICAgICAgICAgICAgYWN0aXZlQ29zdCwKICAgICAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICAgICAgcmVhZFVuaXRzQ29zdCwKICAgICAgICAgICAgc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgIHdyaXRlVW5pdHNDb3N0LAogICAgICAgICAgICBzdW1TdG9yYWdlRGVsZXRlcywKICAgICAgICAgICAgZGVsZXRlc0Nvc3QsCiAgICAgICAgICAgIHRvdGFsQ29zdAogICAgICAgIH07CiAgICAgICAgcm93cy5wdXNoKHJvdyk7CiAgICAgICAgZGF0ZVJvd3MucHVzaChyb3cpOwogICAgfQogICAgY29uc3QgbmFtZXNwYWNlVGFibGVzID0ge307CiAgICBmb3IgKGNvbnN0IFtuYW1lc3BhY2VJZCwgcm93c10gb2YgT2JqZWN0LmVudHJpZXMocm93c0J5TmFtZXNwYWNlKSl7CiAgICAgICAgY29uc3QgZXN0aW1hdGVkMzBEYXlSb3cgPSBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3cocm93cywgZmFsc2UpOwogICAgICAgIGNvbnN0IG5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuZmluZCgodik9PnYuaWQgPT09IG5hbWVzcGFjZUlkCiAgICAgICAgKTsKICAgICAgICBuYW1lc3BhY2VUYWJsZXNbbmFtZXNwYWNlSWRdID0gewogICAgICAgICAgICByb3dzLAogICAgICAgICAgICBlc3RpbWF0ZWQzMERheVJvdywKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBlc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZTogdW5kZWZpbmVkCiAgICAgICAgfTsKICAgIH0KICAgIGNvbnN0IGFjY291bnRSb3dzID0gW107CiAgICBmb3IgKGNvbnN0IFtkYXRlLCBkYXRlUm93c10gb2YgT2JqZWN0LmVudHJpZXMocm93c0J5RGF0ZSkpewogICAgICAgIGNvbnN0IHsgbWF4U3RvcmVkQnl0ZXMgIH0gPSBzdG9yYWdlLnJvd3MuZmlsdGVyKCh2KT0+di5kYXRlID09PSBkYXRlCiAgICAgICAgKVswXSB8fCB7CiAgICAgICAgICAgIG1heFN0b3JlZEJ5dGVzOiAwCiAgICAgICAgfTsKICAgICAgICBjb25zdCBzdG9yYWdlR2IgPSBtYXhTdG9yZWRCeXRlcyAvIDEwMjQgLyAxMDI0IC8gMTAyNDsKICAgICAgICBjb25zdCBzdG9yYWdlQ29zdCA9IHN0b3JhZ2VHYiAqIC4yMCAvIDMwOwogICAgICAgIGFjY291bnRSb3dzLnB1c2goY29tcHV0ZVRvdGFsUm93KGRhdGUsIGRhdGVSb3dzLCB7CiAgICAgICAgICAgIHN0b3JhZ2VHYiwKICAgICAgICAgICAgc3RvcmFnZUNvc3QKICAgICAgICB9KSk7CiAgICB9CiAgICBjb25zdCBzdG9yYWdlQ29zdCA9IGFjY291bnRSb3dzLmxlbmd0aCA+IDAgPyBhY2NvdW50Um93cy5tYXAoKHYpPT52LnN0b3JhZ2VDb3N0IHx8IDAKICAgICkucmVkdWNlKChhLCBiKT0+YSArIGIKICAgICkgOiAwOwogICAgY29uc3QgYWNjb3VudE9wdHMgPSB7CiAgICAgICAgc3RvcmFnZUdiOiAwLAogICAgICAgIHN0b3JhZ2VDb3N0CiAgICB9OwogICAgY29uc3QgZXN0aW1hdGVkMzBEYXlSb3cgPSBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3coYWNjb3VudFJvd3MsIGZhbHNlLCBhY2NvdW50T3B0cyk7CiAgICBjb25zdCBlc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZSA9IGNvbXB1dGVFc3RpbWF0ZWQzMERheVJvdyhhY2NvdW50Um93cywgdHJ1ZSwgYWNjb3VudE9wdHMpOwogICAgY29uc3QgYWNjb3VudFRhYmxlID0gewogICAgICAgIHJvd3M6IGFjY291bnRSb3dzLAogICAgICAgIGVzdGltYXRlZDMwRGF5Um93LAogICAgICAgIGVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLAogICAgICAgIG5hbWVzcGFjZTogdW5kZWZpbmVkCiAgICB9OwogICAgcmV0dXJuIHsKICAgICAgICBhY2NvdW50VGFibGUsCiAgICAgICAgbmFtZXNwYWNlVGFibGVzLAogICAgICAgIGdxbFJlc3VsdEluZm9zCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVDb3N0cyhpbnB1dCkgewogICAgY29uc3QgeyBzdW1BY3RpdmVUaW1lICwgc3VtU3RvcmFnZVJlYWRVbml0cyAsIHN1bVN0b3JhZ2VXcml0ZVVuaXRzICwgc3VtU3RvcmFnZURlbGV0ZXMgLCBleGNsdWRlRnJlZVVzYWdlICwgc3RvcmFnZUNvc3QgIH0gPSBpbnB1dDsKICAgIGNvbnN0IHsgc3VtUmVxdWVzdHM6IHN1bVJlcXVlc3RzMSAsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudDogc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50MSAsIHN1bVN1YnJlcXVlc3RzOiBzdW1TdWJyZXF1ZXN0czEgIH0gPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgeyBzdW1SZXF1ZXN0cyAsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCAsIHN1bVN1YnJlcXVlc3RzICB9ID0gaW5wdXQ7CiAgICAgICAgaWYgKGV4Y2x1ZGVGcmVlVXNhZ2UpIHsKICAgICAgICAgICAgbGV0IHJlbWFpbmluZyA9IDEwMDAwMDA7CiAgICAgICAgICAgIGxldCB0YWtlID0gTWF0aC5taW4ocmVtYWluaW5nLCBzdW1SZXF1ZXN0cyk7CiAgICAgICAgICAgIGlmICh0YWtlID4gMCkgewogICAgICAgICAgICAgICAgc3VtUmVxdWVzdHMgLT0gdGFrZTsKICAgICAgICAgICAgICAgIHJlbWFpbmluZyAtPSB0YWtlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRha2UgPSBNYXRoLm1pbihyZW1haW5pbmcsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCk7CiAgICAgICAgICAgIGlmICh0YWtlID4gMCkgewogICAgICAgICAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50IC09IHRha2U7CiAgICAgICAgICAgICAgICByZW1haW5pbmcgLT0gdGFrZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YWtlID0gTWF0aC5taW4ocmVtYWluaW5nLCBzdW1TdWJyZXF1ZXN0cyk7CiAgICAgICAgICAgIGlmICh0YWtlID4gMCkgewogICAgICAgICAgICAgICAgc3VtU3VicmVxdWVzdHMgLT0gdGFrZTsKICAgICAgICAgICAgICAgIHJlbWFpbmluZyAtPSB0YWtlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN1bVJlcXVlc3RzLAogICAgICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzCiAgICAgICAgfTsKICAgIH0oKTsKICAgIGNvbnN0IHJlcXVlc3RzQ29zdCA9IHN1bVJlcXVlc3RzMSAvIDEwMDAwMDAgKiAwLjE1OwogICAgY29uc3Qgd2Vic29ja2V0c0Nvc3QgPSBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQxIC8gMTAwMDAwMCAqIDAuMTU7CiAgICBjb25zdCBzdWJyZXF1ZXN0c0Nvc3QgPSBzdW1TdWJyZXF1ZXN0czEgLyAxMDAwMDAwICogMC4xNTsKICAgIGNvbnN0IGFjdGl2ZVRpbWVTZWNvbmRzID0gc3VtQWN0aXZlVGltZSAvIDEwMDAgLyAxMDAwOwogICAgbGV0IGFjdGl2ZUdiU2Vjb25kcyA9IGFjdGl2ZVRpbWVTZWNvbmRzICogMTI4IC8gMTAyNDsKICAgIGlmIChleGNsdWRlRnJlZVVzYWdlKSB7CiAgICAgICAgYWN0aXZlR2JTZWNvbmRzID0gTWF0aC5tYXgoMCwgYWN0aXZlR2JTZWNvbmRzIC0gNDAwMDAwKTsKICAgIH0KICAgIGNvbnN0IGFjdGl2ZUNvc3QgPSBhY3RpdmVHYlNlY29uZHMgLyA0MDAwMDAgKiAxMi41MDsKICAgIGNvbnN0IHJlYWRVbml0c0Nvc3QgPSAoZXhjbHVkZUZyZWVVc2FnZSA/IE1hdGgubWF4KDAsIHN1bVN0b3JhZ2VSZWFkVW5pdHMgLSAxMDAwMDAwKSA6IHN1bVN0b3JhZ2VSZWFkVW5pdHMpIC8gMTAwMDAwMCAqIC4yMDsKICAgIGNvbnN0IHdyaXRlVW5pdHNDb3N0ID0gKGV4Y2x1ZGVGcmVlVXNhZ2UgPyBNYXRoLm1heCgwLCBzdW1TdG9yYWdlV3JpdGVVbml0cyAtIDEwMDAwMDApIDogc3VtU3RvcmFnZVdyaXRlVW5pdHMpIC8gMTAwMDAwMCAqIDE7CiAgICBjb25zdCBkZWxldGVzQ29zdCA9IChleGNsdWRlRnJlZVVzYWdlID8gTWF0aC5tYXgoMCwgc3VtU3RvcmFnZURlbGV0ZXMgLSAxMDAwMDAwKSA6IHN1bVN0b3JhZ2VEZWxldGVzKSAvIDEwMDAwMDAgKiAxOwogICAgbGV0IG5ld1N0b3JhZ2VDb3N0ID0gc3RvcmFnZUNvc3QgfHwgMDsKICAgIGlmIChleGNsdWRlRnJlZVVzYWdlKSBuZXdTdG9yYWdlQ29zdCA9IE1hdGgubWF4KDAsIG5ld1N0b3JhZ2VDb3N0IC0gMC4yMCk7CiAgICBjb25zdCB0b3RhbENvc3QgPSByZXF1ZXN0c0Nvc3QgKyB3ZWJzb2NrZXRzQ29zdCArIHN1YnJlcXVlc3RzQ29zdCArIGFjdGl2ZUNvc3QgKyByZWFkVW5pdHNDb3N0ICsgd3JpdGVVbml0c0Nvc3QgKyBkZWxldGVzQ29zdCArIG5ld1N0b3JhZ2VDb3N0OwogICAgcmV0dXJuIHsKICAgICAgICByZXF1ZXN0c0Nvc3QsCiAgICAgICAgd2Vic29ja2V0c0Nvc3QsCiAgICAgICAgc3VicmVxdWVzdHNDb3N0LAogICAgICAgIGFjdGl2ZUNvc3QsCiAgICAgICAgcmVhZFVuaXRzQ29zdCwKICAgICAgICB3cml0ZVVuaXRzQ29zdCwKICAgICAgICBkZWxldGVzQ29zdCwKICAgICAgICB0b3RhbENvc3QsCiAgICAgICAgYWN0aXZlR2JTZWNvbmRzLAogICAgICAgIG5ld1N0b3JhZ2VDb3N0CiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIHRyeUxpc3REdXJhYmxlT2JqZWN0c05hbWVzcGFjZXMocHJvZmlsZSkgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gYXdhaXQgbGlzdER1cmFibGVPYmplY3RzTmFtZXNwYWNlcyhwcm9maWxlLmFjY291bnRJZCwgcHJvZmlsZS5hcGlUb2tlbik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKGUpOwogICAgICAgIHJldHVybiBbXTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlVG90YWxSb3coZGF0ZSwgcm93cywgb3B0cykgewogICAgbGV0IGNvbXB1dGVkU3RvcmFnZUNvc3QgPSBmYWxzZTsKICAgIGNvbnN0IGNvbXB1dGVTdG9yYWdlQ29zdE9uY2UgPSAoKT0+ewogICAgICAgIGNvbnN0IHJ0ID0gIWNvbXB1dGVkU3RvcmFnZUNvc3QgPyBvcHRzPy5zdG9yYWdlQ29zdCB8fCAwIDogMDsKICAgICAgICBjb21wdXRlZFN0b3JhZ2VDb3N0ID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9OwogICAgcmV0dXJuIHJvd3MucmVkdWNlKChsaHMsIHJocyk9Pih7CiAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgIHN1bVJlcXVlc3RzOiBsaHMuc3VtUmVxdWVzdHMgKyByaHMuc3VtUmVxdWVzdHMsCiAgICAgICAgICAgIHJlcXVlc3RzQ29zdDogbGhzLnJlcXVlc3RzQ29zdCArIHJocy5yZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zOiBsaHMubWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMgKyByaHMubWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudDogbGhzLnN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCArIHJocy5zdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IGxocy5zdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ICsgcmhzLnN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHdlYnNvY2tldHNDb3N0OiBsaHMud2Vic29ja2V0c0Nvc3QgKyByaHMud2Vic29ja2V0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzOiBsaHMuc3VtU3VicmVxdWVzdHMgKyByaHMuc3VtU3VicmVxdWVzdHMsCiAgICAgICAgICAgIHN1YnJlcXVlc3RzQ29zdDogbGhzLnN1YnJlcXVlc3RzQ29zdCArIHJocy5zdWJyZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIHN1bUFjdGl2ZVRpbWU6IGxocy5zdW1BY3RpdmVUaW1lICsgcmhzLnN1bUFjdGl2ZVRpbWUsCiAgICAgICAgICAgIGFjdGl2ZUdiU2Vjb25kczogbGhzLmFjdGl2ZUdiU2Vjb25kcyArIHJocy5hY3RpdmVHYlNlY29uZHMsCiAgICAgICAgICAgIGFjdGl2ZUNvc3Q6IGxocy5hY3RpdmVDb3N0ICsgcmhzLmFjdGl2ZUNvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHM6IGxocy5zdW1TdG9yYWdlUmVhZFVuaXRzICsgcmhzLnN1bVN0b3JhZ2VSZWFkVW5pdHMsCiAgICAgICAgICAgIHJlYWRVbml0c0Nvc3Q6IGxocy5yZWFkVW5pdHNDb3N0ICsgcmhzLnJlYWRVbml0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzOiBsaHMuc3VtU3RvcmFnZVdyaXRlVW5pdHMgKyByaHMuc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgIHdyaXRlVW5pdHNDb3N0OiBsaHMud3JpdGVVbml0c0Nvc3QgKyByaHMud3JpdGVVbml0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzOiBsaHMuc3VtU3RvcmFnZURlbGV0ZXMgKyByaHMuc3VtU3RvcmFnZURlbGV0ZXMsCiAgICAgICAgICAgIGRlbGV0ZXNDb3N0OiBsaHMuZGVsZXRlc0Nvc3QgKyByaHMuZGVsZXRlc0Nvc3QsCiAgICAgICAgICAgIHN0b3JhZ2VHYjogb3B0cz8uc3RvcmFnZUdiLAogICAgICAgICAgICBzdG9yYWdlQ29zdDogb3B0cz8uc3RvcmFnZUNvc3QsCiAgICAgICAgICAgIHRvdGFsQ29zdDogbGhzLnRvdGFsQ29zdCArIHJocy50b3RhbENvc3QgKyBjb21wdXRlU3RvcmFnZUNvc3RPbmNlKCkKICAgICAgICB9KQogICAgKTsKfQpmdW5jdGlvbiBtdWx0aXBseVJvdyhyb3csIG11bHRpcGxpZXIpIHsKICAgIHJldHVybiB7CiAgICAgICAgZGF0ZTogJycsCiAgICAgICAgc3VtUmVxdWVzdHM6IHJvdy5zdW1SZXF1ZXN0cyAqIG11bHRpcGxpZXIsCiAgICAgICAgcmVxdWVzdHNDb3N0OiByb3cucmVxdWVzdHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9uczogcm93Lm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zICogbXVsdGlwbGllciwKICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IHJvdy5zdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IHJvdy5zdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ICogbXVsdGlwbGllciwKICAgICAgICB3ZWJzb2NrZXRzQ29zdDogcm93LndlYnNvY2tldHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1TdWJyZXF1ZXN0czogcm93LnN1bVN1YnJlcXVlc3RzICogbXVsdGlwbGllciwKICAgICAgICBzdWJyZXF1ZXN0c0Nvc3Q6IHJvdy5zdWJyZXF1ZXN0c0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bUFjdGl2ZVRpbWU6IHJvdy5zdW1BY3RpdmVUaW1lICogbXVsdGlwbGllciwKICAgICAgICBhY3RpdmVHYlNlY29uZHM6IHJvdy5hY3RpdmVHYlNlY29uZHMgKiBtdWx0aXBsaWVyLAogICAgICAgIGFjdGl2ZUNvc3Q6IHJvdy5hY3RpdmVDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzOiByb3cuc3VtU3RvcmFnZVJlYWRVbml0cyAqIG11bHRpcGxpZXIsCiAgICAgICAgcmVhZFVuaXRzQ29zdDogcm93LnJlYWRVbml0c0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzOiByb3cuc3VtU3RvcmFnZVdyaXRlVW5pdHMgKiBtdWx0aXBsaWVyLAogICAgICAgIHdyaXRlVW5pdHNDb3N0OiByb3cud3JpdGVVbml0c0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzOiByb3cuc3VtU3RvcmFnZURlbGV0ZXMgKiBtdWx0aXBsaWVyLAogICAgICAgIGRlbGV0ZXNDb3N0OiByb3cuZGVsZXRlc0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN0b3JhZ2VHYjogcm93LnN0b3JhZ2VHYiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogcm93LnN0b3JhZ2VHYiAqIG11bHRpcGxpZXIsCiAgICAgICAgc3RvcmFnZUNvc3Q6IHJvdy5zdG9yYWdlQ29zdCA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogcm93LnN0b3JhZ2VDb3N0ICogbXVsdGlwbGllciwKICAgICAgICB0b3RhbENvc3Q6IHJvdy50b3RhbENvc3QgKiBtdWx0aXBsaWVyCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVFc3RpbWF0ZWQzMERheVJvdyhyb3dzLCBleGNsdWRlRnJlZVVzYWdlLCBvcHRzKSB7CiAgICBpZiAocm93cy5sZW5ndGggPD0gMSkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IHN1bSA9IGNvbXB1dGVUb3RhbFJvdygnJywgcm93cy5zbGljZSgwLCAtMSksIG9wdHMpOwogICAgY29uc3QgZGF5cyA9IHJvd3MubGVuZ3RoIC0gMTsKICAgIGNvbnN0IGVzdFJvdyA9IG11bHRpcGx5Um93KHN1bSwgMzAgLyBkYXlzKTsKICAgIGNvbnN0IHsgc3VtUmVxdWVzdHMgLCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdW1TdWJyZXF1ZXN0cyAsIHN1bVN0b3JhZ2VSZWFkVW5pdHMgLCBzdW1TdG9yYWdlV3JpdGVVbml0cyAsIHN1bVN0b3JhZ2VEZWxldGVzICwgc3VtQWN0aXZlVGltZSAsIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zICwgc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCAsIHN0b3JhZ2VHYiAsIHN0b3JhZ2VDb3N0ICB9ID0gZXN0Um93OwogICAgY29uc3QgeyByZXF1ZXN0c0Nvc3QgLCB3ZWJzb2NrZXRzQ29zdCAsIHN1YnJlcXVlc3RzQ29zdCAsIGFjdGl2ZUNvc3QgLCByZWFkVW5pdHNDb3N0ICwgd3JpdGVVbml0c0Nvc3QgLCBkZWxldGVzQ29zdCAsIHRvdGFsQ29zdCAsIGFjdGl2ZUdiU2Vjb25kcyAsIG5ld1N0b3JhZ2VDb3N0ICB9ID0gY29tcHV0ZUNvc3RzKHsKICAgICAgICBzdW1SZXF1ZXN0cywKICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgc3VtU3VicmVxdWVzdHMsCiAgICAgICAgc3VtQWN0aXZlVGltZSwKICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzLAogICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzLAogICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzLAogICAgICAgIGV4Y2x1ZGVGcmVlVXNhZ2UsCiAgICAgICAgc3RvcmFnZUNvc3QKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgICBkYXRlOiAnJywKICAgICAgICBzdW1SZXF1ZXN0cywKICAgICAgICByZXF1ZXN0c0Nvc3QsCiAgICAgICAgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgd2Vic29ja2V0c0Nvc3QsCiAgICAgICAgc3VtU3VicmVxdWVzdHMsCiAgICAgICAgc3VicmVxdWVzdHNDb3N0LAogICAgICAgIHN1bUFjdGl2ZVRpbWUsCiAgICAgICAgYWN0aXZlR2JTZWNvbmRzLAogICAgICAgIGFjdGl2ZUNvc3QsCiAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICByZWFkVW5pdHNDb3N0LAogICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzLAogICAgICAgIHdyaXRlVW5pdHNDb3N0LAogICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzLAogICAgICAgIGRlbGV0ZXNDb3N0LAogICAgICAgIHN0b3JhZ2VHYiwKICAgICAgICBzdG9yYWdlQ29zdDogbmV3U3RvcmFnZUNvc3QsCiAgICAgICAgdG90YWxDb3N0CiAgICB9Owp9CmZ1bmN0aW9uIHV0Y0N1cnJlbnREYXRlKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMTApOwp9CmZ1bmN0aW9uIGFkZERheXNUb0RhdGUoZGF0ZSwgZGF5cykgewogICAgY29uc3QgZCA9IG5ldyBEYXRlKGAke2RhdGV9VDAwOjAwOjAwWmApOwogICAgcmV0dXJuIG5ldyBEYXRlKGQuZ2V0RnVsbFllYXIoKSwgZC5nZXRNb250aCgpLCBkLmdldERhdGUoKSArIGRheXMsIGQuZ2V0SG91cnMoKSwgZC5nZXRNaW51dGVzKCksIGQuZ2V0U2Vjb25kcygpLCBkLmdldE1pbGxpc2Vjb25kcygpKS50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLCAxMCk7Cn0KY2xhc3MgV2VidGFpbEFwcFZNIHsKICAgIF9wcm9maWxlcyA9IFtdOwogICAgZ2V0IHByb2ZpbGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUucHJvZmlsZXMgOiB0aGlzLl9wcm9maWxlczsKICAgIH0KICAgIGdldCByZWFsUHJvZmlsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2ZpbGVzOwogICAgfQogICAgX3NlbGVjdGVkUHJvZmlsZUlkOwogICAgZ2V0IHNlbGVjdGVkUHJvZmlsZUlkKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUuc2VsZWN0ZWRQcm9maWxlSWQgOiB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZDsKICAgIH0KICAgIHNldCBzZWxlY3RlZFByb2ZpbGVJZCh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSB7CiAgICAgICAgICAgIERlbW9Nb2RlLnNldFNlbGVjdGVkUHJvZmlsZUlkKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPT09IHZhbHVlKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPSB2YWx1ZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCA9IHZhbHVlOwogICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB0aGlzLmZpbmRTY3JpcHRzKCk7CiAgICB9CiAgICBfYW5hbHl0aWNzID0gWwogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdkdXJhYmxlLW9iamVjdHMnLAogICAgICAgICAgICB0ZXh0OiAnRHVyYWJsZSBPYmplY3RzJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdEYWlseSBtZXRyaWNzIGFuZCBhc3NvY2lhdGVkIGNvc3RzJwogICAgICAgIH0KICAgIF07CiAgICBnZXQgYW5hbHl0aWNzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9hbmFseXRpY3M7CiAgICB9CiAgICBfc2VsZWN0ZWRBbmFseXRpY0lkOwogICAgZ2V0IHNlbGVjdGVkQW5hbHl0aWNJZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkOwogICAgfQogICAgYW5hbHl0aWNzU3RhdGUgPSB7CiAgICAgICAgcXVlcnlpbmc6IGZhbHNlCiAgICB9OwogICAgX3NjcmlwdHMgPSBbXTsKICAgIGdldCBzY3JpcHRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUuc2NyaXB0cyA6IHRoaXMuX3NjcmlwdHM7CiAgICB9CiAgICBfc2VsZWN0ZWRTY3JpcHRJZHMgPSBuZXcgU2V0KCk7CiAgICBnZXQgc2VsZWN0ZWRTY3JpcHRJZHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVtb01vZGUgPyBEZW1vTW9kZS5zZWxlY3RlZFNjcmlwdElkcyA6IHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzOwogICAgfQogICAgc2V0IHNlbGVjdGVkU2NyaXB0SWRzKHNjcmlwdElkcykgewogICAgICAgIGlmICh0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHsKICAgICAgICAgICAgRGVtb01vZGUuc2V0U2VsZWN0ZWRTY3JpcHRJZHMoc2NyaXB0SWRzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoc2V0RXF1YWwodGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHMsIHNjcmlwdElkcykpIHJldHVybjsKICAgICAgICB0aGlzLl9zZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoc2NyaXB0SWRzKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICBpZiAocHJvZmlsZSkgewogICAgICAgICAgICBwcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzID0gWwogICAgICAgICAgICAgICAgLi4uc2NyaXB0SWRzCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXRUYWlscygpOwogICAgfQogICAgcHJvZmlsZUZvcm0gPSBuZXcgUHJvZmlsZUZvcm1WTSgpOwogICAgZmlsdGVyRm9ybSA9IG5ldyBGaWx0ZXJGb3JtVk0oKTsKICAgIGZpbHRlciA9IHt9OwogICAgZXh0cmFGaWVsZHMgPSBbXTsKICAgIF90YWlscyA9IG5ldyBTZXQoKTsKICAgIGdldCB0YWlscygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnRhaWxzIDogdGhpcy5fdGFpbHM7CiAgICB9CiAgICBzZXQgdGFpbHModGFpbHMpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgRGVtb01vZGUudGFpbHMgPSB0YWlsczsKICAgICAgICB0aGlzLl90YWlscyA9IHRhaWxzOwogICAgfQogICAgd2VsY29tZVNob3dpbmcgPSBmYWxzZTsKICAgIGFib3V0U2hvd2luZyA9IGZhbHNlOwogICAgc3RhdGUgPSBsb2FkU3RhdGUoKTsKICAgIHRhaWxDb250cm9sbGVyOwogICAgdGFpbENvbnRyb2xsZXJDYWxsYmFja3M7CiAgICBxcHNDb250cm9sbGVyOwogICAgZGVtb01vZGUgPSBmYWxzZTsKICAgIG9uQ2hhbmdlID0gKCk9Pnt9OwogICAgbG9nZ2VyID0gKCk9Pnt9OwogICAgb25SZXNldE91dHB1dCA9ICgpPT57fTsKICAgIG9uUXBzQ2hhbmdlID0gKCk9Pnt9OwogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBjb25zdCBkaXMgPSB0aGlzOwogICAgICAgIHRoaXMucXBzQ29udHJvbGxlciA9IG5ldyBRcHNDb250cm9sbGVyKDIwLCB7CiAgICAgICAgICAgIG9uUXBzQ2hhbmdlZCAocXBzKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgICAgICBkaXMub25RcHNDaGFuZ2UocXBzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGxvZ1RhaWxzQ2hhbmdlID0gKGFjdGlvbiwgdGFpbEtleXMpPT57CiAgICAgICAgICAgIGlmICh0YWlsS2V5cy5zaXplID4gMCkgdGhpcy5sb2dXaXRoUHJlZml4KGAke2FjdGlvbn0gJHtbCiAgICAgICAgICAgICAgICAuLi50YWlsS2V5cwogICAgICAgICAgICBdLm1hcCgodik9PnVucGFja1RhaWxLZXkodikuc2NyaXB0SWQKICAgICAgICAgICAgKS5zb3J0KCkuam9pbignLCAnKX1gKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGxvZ1dpdGhQcmVmaXggPSB0aGlzLmxvZ1dpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCB2ZXJib3NlV2l0aFByZWZpeCA9IHRoaXMudmVyYm9zZVdpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCBjYWxsYmFja3MgPSB7CiAgICAgICAgICAgIG9uVGFpbENyZWF0aW5nIChfYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENyZWF0aW5nIHRhaWwgZm9yICR7c2NyaXB0SWR9Li4uYCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENyZWF0ZWQgKF9hY2NvdW50SWQsIHNjcmlwdElkLCB0b29rTWlsbGlzLCB0YWlsKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ3JlYXRlZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXMsICR7SlNPTi5zdHJpbmdpZnkodGFpbCl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25PcGVuIChfYWNjb3VudElkLCBzY3JpcHRJZCwgX3RpbWVTdGFtcCwgdG9va01pbGxpcykgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYE9wZW5lZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXNgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbkNsb3NlIChhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uQ2xvc2UnLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ2xvc2VkIHRhaWwgZm9yICR7c2NyaXB0SWR9LCAke0pTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25FcnJvciAoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uRXJyb3InLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBlcnJvckluZm8KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgRXJyb3IgaW4gdGFpbCBmb3IgJHtzY3JpcHRJZH1gLCB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JJbmZvCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UgKF9hY2NvdW50SWQsIF9zY3JpcHRJZCwgX3RpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgaWYgKGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UsIGRpcy5maWx0ZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZSwgZGlzLmxvZ2dlciwgZGlzLmNvbXB1dGVBZGRpdGlvbmFsTG9ncyhtZXNzYWdlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgICAgICBkaXMucXBzQ29udHJvbGxlci5hZGRFdmVudChtZXNzYWdlLmV2ZW50VGltZXN0YW1wKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZSAoX2FjY291bnRJZCwgc2NyaXB0SWQsIF90aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgVW5wYXJzZWQgbWVzc2FnZSBpbiB0YWlsIGZvciAke3NjcmlwdElkfWAsIHBhcnNlRXJyb3Iuc3RhY2sgfHwgcGFyc2VFcnJvci5tZXNzYWdlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsc0NoYW5nZWQgKHRhaWxzKSB7CiAgICAgICAgICAgICAgICBpZiAoc2V0RXF1YWwoZGlzLnRhaWxzLCB0YWlscykpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92ZWQgPSBzZXRTdWJ0cmFjdChkaXMudGFpbHMsIHRhaWxzKTsKICAgICAgICAgICAgICAgIGxvZ1RhaWxzQ2hhbmdlKCdVbnRhaWxpbmcnLCByZW1vdmVkKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFkZGVkID0gc2V0U3VidHJhY3QodGFpbHMsIGRpcy50YWlscyk7CiAgICAgICAgICAgICAgICBsb2dUYWlsc0NoYW5nZSgnVGFpbGluZycsIGFkZGVkKTsKICAgICAgICAgICAgICAgIGRpcy50YWlscyA9IHRhaWxzOwogICAgICAgICAgICAgICAgZGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTmV0d29ya1N0YXR1c0NoYW5nZWQgKG9ubGluZSkgewogICAgICAgICAgICAgICAgaWYgKG9ubGluZSkgewogICAgICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoJyVjT05MSU5FJWMnLCAnY29sb3I6IGdyZWVuJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoJyVjT0ZGTElORSVjJywgJ2NvbG9yOiByZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsRmFpbGVkVG9TdGFydCAoX2FjY291bnRJZCwgc2NyaXB0SWQsIHRyaWdnZXIsIGVycm9yKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgVGFpbCBmb3IgJHtzY3JpcHRJZH0gZmFpbGVkIHRvIHN0YXJ0ICgke3RyaWdnZXJ9KTogJHtlcnJvci5uYW1lfSAke2Vycm9yLm1lc3NhZ2V9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgPSBBcHBDb25zdGFudHMuV0VCU09DS0VUX1BJTkdfSU5URVJWQUxfU0VDT05EUzsKICAgICAgICBjb25zdCBpbmFjdGl2ZVRhaWxTZWNvbmRzID0gQXBwQ29uc3RhbnRzLklOQUNUSVZFX1RBSUxfU0VDT05EUzsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyID0gbmV3IFRhaWxDb250cm9sbGVyKG5ldyBTd2l0Y2hhYmxlVGFpbENvbnRyb2xsZXJDYWxsYmFja3MoY2FsbGJhY2tzLCAoKT0+IXRoaXMuZGVtb01vZGUKICAgICAgICApLCB7CiAgICAgICAgICAgIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMsCiAgICAgICAgICAgIGluYWN0aXZlVGFpbFNlY29uZHMKICAgICAgICB9KTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMuZXh0cmFGaWVsZHMgPSBbCiAgICAgICAgICAgIC4uLnRoaXMuc3RhdGUuZXh0cmFGaWVsZHMgfHwgW10KICAgICAgICBdOwogICAgICAgIHRoaXMuZmlsdGVyID0gdGhpcy5zdGF0ZS5maWx0ZXIgfHwge307CiAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgIHNhdmU6IGZhbHNlCiAgICAgICAgfSk7CiAgICB9CiAgICBzdGFydCgpIHsKICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgdGhpcy5yZWNvbXB1dGVXZWxjb21lU2hvd2luZygpOwogICAgICAgIHRoaXMucGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKTsKICAgIH0KICAgIG5ld1Byb2ZpbGUoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMud2VsY29tZVNob3dpbmcpIHt9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ucHJvZmlsZUlkID0gZ2VuZXJhdGVVdWlkKCk7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnRpdGxlID0gJ05ldyBQcm9maWxlJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSB0aGlzLl9wcm9maWxlcy5sZW5ndGggPT09IDAgPyAnZGVmYXVsdCcgOiBgcHJvZmlsZSR7dGhpcy5fcHJvZmlsZXMubGVuZ3RoICsgMX1gOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hcGlUb2tlbiA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA9IGZhbHNlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0UHJvZmlsZShwcm9maWxlSWQpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgaWYgKCFwcm9maWxlKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgJHtwcm9maWxlSWR9IG5vdCBmb3VuZGApOwogICAgICAgIHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgIGNvbnN0IHsgbmFtZSAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0udGl0bGUgPSAnRWRpdCBQcm9maWxlJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gYWNjb3VudElkOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSBhcGlUb2tlbjsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBkZWxldGVQcm9maWxlKHByb2ZpbGVJZCkgewogICAgICAgIGNvbnNvbGUubG9nKCdkZWxldGUgcHJvZmlsZScsIHByb2ZpbGVJZCk7CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBpZiAoIXByb2ZpbGUpIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSAke3Byb2ZpbGVJZH0gbm90IGZvdW5kYCk7CiAgICAgICAgZGVsZXRlIHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgIHRoaXMucmVjb21wdXRlV2VsY29tZVNob3dpbmcoKTsKICAgICAgICB0aGlzLnBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCk7CiAgICB9CiAgICBjYW5jZWxQcm9maWxlKCkgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVOYW1lKG5hbWUpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2V0UHJvZmlsZUFjY291bnRJZChhY2NvdW50SWQpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9IGFjY291bnRJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVBcGlUb2tlbihhcGlUb2tlbikgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSBhcGlUb2tlbjsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNhdmVQcm9maWxlKCkgewogICAgICAgIGNvbnN0IHsgcHJvZmlsZUZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHsgcHJvZmlsZUlkICB9ID0gcHJvZmlsZUZvcm07CiAgICAgICAgY29uc3QgbmV3UHJvZmlsZSA9IHsKICAgICAgICAgICAgbmFtZTogcHJvZmlsZUZvcm0ubmFtZS50cmltKCksCiAgICAgICAgICAgIGFjY291bnRJZDogcHJvZmlsZUZvcm0uYWNjb3VudElkLnRyaW0oKSwKICAgICAgICAgICAgYXBpVG9rZW46IHByb2ZpbGVGb3JtLmFwaVRva2VuLnRyaW0oKQogICAgICAgIH07CiAgICAgICAgdGhpcy50cnlTYXZlUHJvZmlsZShwcm9maWxlSWQsIG5ld1Byb2ZpbGUpOwogICAgfQogICAgZWRpdEV2ZW50RmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnRXZlbnQgdHlwZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnY3JvbicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQ1JPTiB0cmlnZ2VyJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2h0dHAnLAogICAgICAgICAgICAgICAgdGV4dDogJ0hUVFAgcmVxdWVzdCcKICAgICAgICAgICAgfSwgCiAgICAgICAgXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnID8gJ2h0dHAnIDogZmlsdGVyLmV2ZW50MSA9PT0gJ2Nyb24nID8gJ2Nyb24nIDogJ2FsbCc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdDaG9vc2Ugd2hpY2ggdHlwZXMgb2YgZXZlbnRzIHRvIHNob3cnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuZXZlbnQxID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmV2ZW50MSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZENob2ljZVRleHQgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmZpbmQoKHYpPT52LmlkID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUKICAgICAgICAgICAgKS50ZXh0OwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYEV2ZW50IHR5cGUgZmlsdGVyIGNoYW5nZWQgdG86ICR7c2VsZWN0ZWRDaG9pY2VUZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFN0YXR1c0ZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1N0YXR1czonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnc3VjY2VzcycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnU3VjY2VzcycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICdlcnJvcicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnRXJyb3InCiAgICAgICAgICAgIH0sIAogICAgICAgIF07CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpbHRlci5zdGF0dXMxID09PSAnc3VjY2VzcycgPyAnc3VjY2VzcycgOiBmaWx0ZXIuc3RhdHVzMSA9PT0gJ2Vycm9yJyA/ICdlcnJvcicgOiAnYWxsJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ1Nob3cgZXZlbnRzIHRoaXMgdGhpcyBzdGF0dXMnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5zdGF0dXMxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQ2hvaWNlVGV4dCA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMuZmluZCgodik9PnYuaWQgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZQogICAgICAgICAgICApLnRleHQ7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU3RhdHVzIGZpbHRlciBjaGFuZ2VkIHRvOiAke3NlbGVjdGVkQ2hvaWNlVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRJcEFkZHJlc3NGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGlzVmFsaWRJcEFkZHJlc3MgPSAoaXBBZGRyZXNzKT0+ewogICAgICAgICAgICByZXR1cm4gL14oc2VsZnxbXGRcLjphLWZdezMsfSkkLy50ZXN0KGlwQWRkcmVzcyk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjaGVja1ZhbGlkSXBBZGRyZXNzID0gKGlwQWRkcmVzcyk9PnsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkSXBBZGRyZXNzKGlwQWRkcmVzcykpIHRocm93IG5ldyBFcnJvcihgQmFkIGlwIGFkZHJlc3M6ICR7aXBBZGRyZXNzfWApOwogICAgICAgICAgICByZXR1cm4gaXBBZGRyZXNzOwogICAgICAgIH07CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJJcEFkZHJlc3Nlc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdjEgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodjEgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2MS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApLm1hcChjaGVja1ZhbGlkSXBBZGRyZXNzKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJJcEFkZHJlc3NlcyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIuaXBBZGRyZXNzMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdJUCBhZGRyZXNzKHMpOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJJcEFkZHJlc3NlcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ3NlbGYnIHRvIGZpbHRlciB5b3VyIG93biBhZGRyZXNzLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGUsIGUuZy4gc2VsZiwgMS4xLjEuMWA7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlcklwQWRkcmVzc2VzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLmlwQWRkcmVzczEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmlwQWRkcmVzczEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ2FueSBJUCBhZGRyZXNzJyA6IG5ld1ZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgSVAgYWRkcmVzcyBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdE1ldGhvZEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJNZXRob2RzRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2MiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2MiA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHYyLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkudG9VcHBlckNhc2UoKQogICAgICAgICAgICApLmZpbHRlcigodik9PnYgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIubWV0aG9kMSB8fCBbXSkubWFwKCh2KT0+di50b1VwcGVyQ2FzZSgpCiAgICAgICAgICAgICkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdIVFRQIE1ldGhvZChzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCBlLmcuIEdFVCwgUE9TVCc7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlck1ldGhvZHNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIubWV0aG9kMSB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWUpKSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIubWV0aG9kMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZS5sZW5ndGggPT09IDAgPyAnYW55IG1ldGhvZCcgOiBuZXdWYWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYE1ldGhvZCBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNhbXBsaW5nUmF0ZUZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHBhcnNlU2FtcGxlUmF0ZUZyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIDE7CiAgICAgICAgICAgIGNvbnN0IG51bSA9IHBhcnNlRmxvYXQodik7CiAgICAgICAgICAgIGlmICghaXNWYWxpZFNhbXBsaW5nUmF0ZShudW0pKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcmF0ZTogJHt2fWApOwogICAgICAgICAgICByZXR1cm4gbnVtOwogICAgICAgIH07CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnU2FtcGxpbmcgcmF0ZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gKHR5cGVvZiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gJ251bWJlcicgJiYgaXNWYWxpZFNhbXBsaW5nUmF0ZShmaWx0ZXIuc2FtcGxpbmdSYXRlMSkgPyBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA6IDEpLnRvRml4ZWQoMik7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdDYW4gcmFuZ2UgZnJvbSAwICgwJSkgdG8gMSAoMTAwJSknOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VTYW1wbGVSYXRlRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKGZpbHRlci5zYW1wbGluZ1JhdGUxID09PSBuZXdWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZSA9PT0gMSA/ICdubyBzYW1wbGluZycgOiBgJHtuZXdWYWx1ZX0gKCR7KG5ld1ZhbHVlICogMTAwKS50b0ZpeGVkKDIpfSUpYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTYW1wbGUgcmF0ZSBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNlYXJjaEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1NlYXJjaCB0ZXh0Oic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuc2VhcmNoMSB8fCAnJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ0ZpbHRlciBieSBhIHRleHQgbWF0Y2ggaW4gY29uc29sZS5sb2cgbWVzc2FnZXMnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc2VhcmNoMSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5zZWFyY2gxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSAoZmlsdGVyLnNlYXJjaDEgfHwgJycpLmxlbmd0aCA9PT0gMCA/ICdubyBzZWFyY2ggZmlsdGVyJyA6IGAnJHtmaWx0ZXIuc2VhcmNoMX0nYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTZWFyY2ggZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRIZWFkZXJGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVySGVhZGVyc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdjMgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodjMgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2My5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJIZWFkZXJzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5oZWFkZXIxIHx8IFtdKS5qb2luKCcsICcpOwogICAgICAgIH07CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0hlYWRlcihzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySGVhZGVycygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ2tleScsIG9yICdrZXk6cXVlcnknLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGVgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJIZWFkZXJzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLmhlYWRlcjEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmhlYWRlcjEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ25vIGhlYWRlciBmaWx0ZXInIDogbmV3VmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBIZWFkZXIgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRMb2dwcm9wRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBwYXJzZUxvZ3Byb3BGaWx0ZXJzRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2NCA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2NCA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHY0LnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUxvZ1Byb3BGaWx0ZXJzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5sb2dwcm9wMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdMb2dwcm9wKHMpOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21Mb2dQcm9wRmlsdGVycygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ2tleScsIG9yICdrZXk6dmFsdWUnLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGUsIHZhbHVlIG1heSBpbmNsdWRlICpgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VMb2dwcm9wRmlsdGVyc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMuc2V0TG9ncHJvcEZpbHRlcihuZXdWYWx1ZSk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRMb2dwcm9wRmlsdGVyKGxvZ3Byb3BGaWx0ZXJzKSB7CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgIH0gPSB0aGlzOwogICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5sb2dwcm9wMSB8fCBbXSksIG5ldyBTZXQobG9ncHJvcEZpbHRlcnMpKSkgcmV0dXJuOwogICAgICAgIGZpbHRlci5sb2dwcm9wMSA9IGxvZ3Byb3BGaWx0ZXJzOwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgdGV4dCA9IGxvZ3Byb3BGaWx0ZXJzLmxlbmd0aCA9PT0gMCA/ICdubyBsb2dwcm9wIGZpbHRlcicgOiBsb2dwcm9wRmlsdGVycy5qb2luKCcsICcpOwogICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgTG9ncHJvcCBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgfQogICAgaGFzQW55RmlsdGVycygpIHsKICAgICAgICBjb25zdCB7IGZpbHRlciAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgeyBldmVudDEgIH0gPSBmaWx0ZXI7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpLmZpbHRlcnMubGVuZ3RoID4gMCB8fCB0eXBlb2YgZXZlbnQxID09PSAnc3RyaW5nJyAmJiBldmVudDEgIT09ICcnICYmIGV2ZW50MSAhPT0gJ2FsbCc7CiAgICB9CiAgICByZXNldEZpbHRlcnMoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlciA9IHt9OwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBGaWx0ZXJzIHJlc2V0YCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgY2FuY2VsRmlsdGVyKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdjYW5jZWxGaWx0ZXInKTsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNhdmVGaWx0ZXIoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ3NhdmVGaWx0ZXInKTsKICAgICAgICBjb25zdCB7IGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9ICdDaGVja2luZyBmaWx0ZXIuLi4nOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUoKTsKICAgICAgICAgICAgZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlID0gYGA7CiAgICAgICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlID0gYEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIHNlbGVjdEZpbHRlckNob2ljZShpZCkgewogICAgICAgIGlmICh0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9PT0gaWQpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGlkOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTZWxlY3Rpb25GaWVsZHMoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdBZGRpdGlvbmFsIGZpZWxkczonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gRVhUUkFfRklFTERTX09QVElPTlM7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gKHRoaXMuZXh0cmFGaWVsZHMgfHwgW10pLmpvaW4oJywnKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ1NlbGVjdCBhZGRpdGlvbmFsIGZpZWxkcyB0byBzaG93IGluIHRoZSBvdXRwdXQnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlcyA9IGRpc3RpbmN0KChmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgfHwgJycpLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQodGhpcy5leHRyYUZpZWxkcyB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWVzKSkpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5leHRyYUZpZWxkcyA9IG5ld1ZhbHVlczsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBleHRyYUZpZWxkc1RleHQgPSB0aGlzLmNvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KCk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgT3V0cHV0IGZpZWxkcyBjaGFuZ2VkIHRvOiAke2V4dHJhRmllbGRzVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGNvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KCkgewogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICdzdGFuZGFyZCBmaWVsZHMnLAogICAgICAgICAgICAuLi50aGlzLmV4dHJhRmllbGRzLm1hcCgoaWQpPT5FWFRSQV9GSUVMRFNfT1BUSU9OUy5maW5kKCh2KT0+di5pZCA9PT0gaWQKICAgICAgICAgICAgICAgICk/LnRleHQgfHwgaWQKICAgICAgICAgICAgKQogICAgICAgIF0uam9pbignLCAnKTsKICAgIH0KICAgIHRvZ2dsZUZpbHRlck9wdGlvbihpZCkgewogICAgICAgIGNvbnN0IGV4dHJhRmllbGRzID0gZGlzdGluY3QoKHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICkpOwogICAgICAgIGNvbnN0IGkgPSBleHRyYUZpZWxkcy5pbmRleE9mKGlkKTsKICAgICAgICBpZiAoaSA+PSAwKSB7CiAgICAgICAgICAgIGV4dHJhRmllbGRzLnNwbGljZShpLCAxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHRyYUZpZWxkcy5wdXNoKGlkKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZmllbGRWYWx1ZSA9IGV4dHJhRmllbGRzLmpvaW4oJywnKTsKICAgICAgICBpZiAodGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPT09IGZpZWxkVmFsdWUpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpZWxkVmFsdWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgdGhpcy5zZXREZW1vTW9kZSghdGhpcy5kZW1vTW9kZSk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgcmVzZXRPdXRwdXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgIH0KICAgIHNob3dBYm91dCgpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIHRoaXMuYWJvdXRTaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBjbG9zZUFib3V0KCkgewogICAgICAgIHRoaXMuYWJvdXRTaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2hvd0FuYWx5dGljKGFuYWx5dGljSWQpIHsKICAgICAgICBjb25zdCBhbmFseXRpYyA9IHRoaXMuYW5hbHl0aWNzLmZpbmQoKHYpPT52LmlkID09PSBhbmFseXRpY0lkCiAgICAgICAgKTsKICAgICAgICBpZiAoIWFuYWx5dGljIHx8IGFuYWx5dGljLmlkID09PSB0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQpIHJldHVybjsKICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgaWYgKHByb2ZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgIHRoaXMuX3NlbGVjdGVkQW5hbHl0aWNJZCA9IGFuYWx5dGljSWQ7CiAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5xdWVyeWluZyA9IHRydWU7CiAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5kdXJhYmxlT2JqZWN0c0Nvc3RzID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuYW5hbHl0aWNzU3RhdGUuZXJyb3IgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBDZkdxbENsaWVudCh7CiAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgYXBpVG9rZW4KICAgICAgICB9KTsKICAgICAgICB0aGlzLnF1ZXJ5RHVyYWJsZU9iamVjdHNDb3N0cyhjbGllbnQpOwogICAgfQogICAgc2V0RGVtb01vZGUoZGVtb01vZGUpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSA9PT0gZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmRlbW9Nb2RlID0gZGVtb01vZGU7CiAgICAgICAgaWYgKGRlbW9Nb2RlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFbmFibGUgZGVtbyBtb2RlJyk7CiAgICAgICAgICAgIHRoaXMub25RcHNDaGFuZ2UoMTIuMzQpOwogICAgICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgICAgICAgICAgRGVtb01vZGUubG9nRmFrZU91dHB1dCh0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRGlzYWJsZSBkZW1vIG1vZGUnKTsKICAgICAgICAgICAgdGhpcy5vblFwc0NoYW5nZSh0aGlzLnFwc0NvbnRyb2xsZXIucXBzKTsKICAgICAgICAgICAgdGhpcy5vblJlc2V0T3V0cHV0KCk7CiAgICAgICAgfQogICAgfQogICAgYXBwbHlGaWx0ZXIob3B0cykgewogICAgICAgIGNvbnN0IHsgc2F2ZSAgfSA9IG9wdHM7CiAgICAgICAgdGhpcy5zdGF0ZS5maWx0ZXIgPSB0aGlzLmZpbHRlcjsKICAgICAgICB0aGlzLnN0YXRlLmV4dHJhRmllbGRzID0gdGhpcy5leHRyYUZpZWxkczsKICAgICAgICBpZiAoc2F2ZSkgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIGNvbnN0IHRhaWxPcHRpb25zID0gY29tcHV0ZVRhaWxPcHRpb25zRm9yRmlsdGVyKHRoaXMuZmlsdGVyKTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyLnNldFRhaWxPcHRpb25zKHRhaWxPcHRpb25zKTsKICAgIH0KICAgIGxvZ1dpdGhQcmVmaXgoLi4uZGF0YTUpIHsKICAgICAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKTsKICAgICAgICBpZiAoZGF0YTUubGVuZ3RoID4gMCAmJiB0eXBlb2YgZGF0YTVbMF0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGRhdGE1ID0gWwogICAgICAgICAgICAgICAgYFslYyR7dGltZX0lY10gJHtkYXRhNVswXX1gLAogICAgICAgICAgICAgICAgJ2NvbG9yOiBncmF5JywKICAgICAgICAgICAgICAgICcnLAogICAgICAgICAgICAgICAgLi4uZGF0YTUuc2xpY2UoMSkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sb2dnZXIoLi4uZGF0YTUpOwogICAgfQogICAgdmVyYm9zZVdpdGhQcmVmaXgobWVzc2FnZSkgewogICAgICAgIGNvbnN0IHRpbWUgPSBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpOwogICAgICAgIHRoaXMubG9nZ2VyKGBbJWMke3RpbWV9JWNdICVjJHttZXNzYWdlfSVjYCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScpOwogICAgfQogICAgcGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKSB7CiAgICAgICAgY29uc3QgaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQgPSBjb21wdXRlSW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQodGhpcy5zdGF0ZSwgdGhpcy5fcHJvZmlsZXMpOwogICAgICAgIGlmIChpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBwcm9maWxlOiAke3RoaXMuc3RhdGUucHJvZmlsZXNbaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWRdLm5hbWV9YCk7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPSBpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgdHJ5U2F2ZVByb2ZpbGUocHJvZmlsZUlkLCBwcm9maWxlKSB7CiAgICAgICAgY29uc3QgeyBwcm9maWxlRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgcHJvZmlsZUZvcm0uZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA9IHRydWU7CiAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICdDaGVja2luZyBwcm9maWxlLi4uJzsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgY2FuTGlzdFRhaWxzID0gYXdhaXQgY29tcHV0ZUNhbkxpc3RUYWlscyhwcm9maWxlLmFjY291bnRJZCwgcHJvZmlsZS5hcGlUb2tlbik7CiAgICAgICAgICAgIGlmIChjYW5MaXN0VGFpbHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXSA9IHByb2ZpbGU7CiAgICAgICAgICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCk7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9IGBUaGVzZSBjcmVkZW50aWFscyBkbyBub3QgaGF2ZSBwZXJtaXNzaW9uIHRvIHRhaWxgOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gYEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgcHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgcmVsb2FkUHJvZmlsZXMoKSB7CiAgICAgICAgY29uc3QgeyBzdGF0ZSAgfSA9IHRoaXM7CiAgICAgICAgdGhpcy5fcHJvZmlsZXMuc3BsaWNlKDApOwogICAgICAgIGZvciAoY29uc3QgW3Byb2ZpbGVJZCwgcHJvZmlsZV0gb2YgT2JqZWN0LmVudHJpZXMoc3RhdGUucHJvZmlsZXMpKXsKICAgICAgICAgICAgY29uc3QgbmFtZSA9IHByb2ZpbGUubmFtZSB8fCAnKHVubmFtZWQpJzsKICAgICAgICAgICAgdGhpcy5fcHJvZmlsZXMucHVzaCh7CiAgICAgICAgICAgICAgICBpZDogcHJvZmlsZUlkLAogICAgICAgICAgICAgICAgdGV4dDogbmFtZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyBmaW5kU2NyaXB0cygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgICAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgICAgICB0aGlzLnZlcmJvc2VXaXRoUHJlZml4KGBGaW5kaW5nIHNjcmlwdHMgZm9yICR7cHJvZmlsZS5uYW1lLnRvVXBwZXJDYXNlKCl9Li4uYCk7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgY29uc3Qgc2NyaXB0cyA9IGF3YWl0IGxpc3RTY3JpcHRzKGFjY291bnRJZCwgYXBpVG9rZW4pOwogICAgICAgICAgICBpZiAoIXRoaXMuZGVtb01vZGUpIHRoaXMudmVyYm9zZVdpdGhQcmVmaXgoYEZvdW5kICR7c2NyaXB0cy5sZW5ndGh9IHNjcmlwdHMgaW4gJHtEYXRlLm5vdygpIC0gc3RhcnR9bXNgKTsKICAgICAgICAgICAgdGhpcy5fc2NyaXB0cy5zcGxpY2UoMCk7CiAgICAgICAgICAgIGZvciAoY29uc3Qgc2NyaXB0IG9mIHNjcmlwdHMpewogICAgICAgICAgICAgICAgdGhpcy5fc2NyaXB0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogc2NyaXB0LmlkLAogICAgICAgICAgICAgICAgICAgIHRleHQ6IHNjcmlwdC5pZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fc2NyaXB0cy5zb3J0KChsaHMsIHJocyk9Pmxocy50ZXh0LmxvY2FsZUNvbXBhcmUocmhzLnRleHQpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkU2NyaXB0SWRzID0gdGhpcy5jb21wdXRlU2VsZWN0ZWRTY3JpcHRJZHNBZnRlckZpbmRTY3JpcHRzKCk7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZFNjcmlwdElkcy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFNjcmlwdElkcyA9IHNlbGVjdGVkU2NyaXB0SWRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGhpcy5kZW1vTW9kZSkgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlbW9Nb2RlKSB0aGlzLmxvZ2dlcihgRXJyb3IgaW4gZmluZFNjcmlwdHM6ICR7ZS5zdGFja31gKTsKICAgICAgICB9CiAgICB9CiAgICBjb21wdXRlU2VsZWN0ZWRTY3JpcHRJZHNBZnRlckZpbmRTY3JpcHRzKCkgewogICAgICAgIGlmICh0aGlzLl9zY3JpcHRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnSW5pdGlhbGx5IHNlbGVjdGluZyBubyBzY3JpcHRzLCBubyBzY3JpcHRzIHRvIHNlbGVjdCcpOwogICAgICAgICAgICByZXR1cm4gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkICYmIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWQpIHsKICAgICAgICAgICAgY29uc3QgaW5pdGlhbFByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgICAgICBpZiAoaW5pdGlhbFByb2ZpbGUgJiYgaW5pdGlhbFByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMgJiYgaW5pdGlhbFByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjcmlwdElkcyA9IG5ldyBTZXQodGhpcy5fc2NyaXB0cy5tYXAoKHYpPT52LmlkCiAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBzZXRJbnRlcnNlY3QoY3VycmVudFNjcmlwdElkcywgbmV3IFNldChpbml0aWFsUHJvZmlsZS5zZWxlY3RlZFNjcmlwdElkcykpOwogICAgICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBzY3JpcHQke2NhbmRpZGF0ZXMuc2l6ZSA9PT0gMSA/ICcnIDogJ3MnfSAke1sKICAgICAgICAgICAgICAgICAgICAgICAgLi4uY2FuZGlkYXRlcwogICAgICAgICAgICAgICAgICAgIF0uc29ydCgpLmpvaW4oJywgJyl9OiByZW1lbWJlcmVkIGZyb20gbGFzdCB0aW1lYCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZmlyc3RTY3JpcHRJZCA9IHRoaXMuX3NjcmlwdHNbMF0uaWQ7CiAgICAgICAgY29uc29sZS5sb2coYEluaXRpYWxseSBzZWxlY3Rpbmcgc2NyaXB0ICR7Zmlyc3RTY3JpcHRJZH06IGZpcnN0IG9uZSBpbiB0aGUgbGlzdGApOwogICAgICAgIHJldHVybiBuZXcgU2V0KFsKICAgICAgICAgICAgdGhpcy5fc2NyaXB0c1swXS5pZAogICAgICAgIF0pOwogICAgfQogICAgYXN5bmMgc2V0VGFpbHMoKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgIGlmIChwcm9maWxlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLnRhaWxDb250cm9sbGVyLnNldFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4sIHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHRoaXMubG9nZ2VyKCdFcnJvciBpbiBzZXRUYWlscycsIGUuc3RhY2sgfHwgZS5tZXNzYWdlKTsKICAgICAgICB9CiAgICB9CiAgICBjb21wdXRlQWRkaXRpb25hbExvZ3MobWVzc2FnZSkgewogICAgICAgIGNvbnN0IHJ0ID0gW107CiAgICAgICAgY29uc3QgaW5jbHVkZUlwQWRkcmVzcyA9IHRoaXMuZXh0cmFGaWVsZHMuaW5jbHVkZXMoJ2lwLWFkZHJlc3MnKTsKICAgICAgICBjb25zdCBpbmNsdWRlVXNlckFnZW50ID0gdGhpcy5leHRyYUZpZWxkcy5pbmNsdWRlcygndXNlci1hZ2VudCcpOwogICAgICAgIGNvbnN0IGluY2x1ZGVSZWZlcmVyID0gdGhpcy5leHRyYUZpZWxkcy5pbmNsdWRlcygncmVmZXJlcicpOwogICAgICAgIGlmIChpbmNsdWRlSXBBZGRyZXNzIHx8IGluY2x1ZGVVc2VyQWdlbnQgfHwgaW5jbHVkZVJlZmVyZXIpIHsKICAgICAgICAgICAgaWYgKCFpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UuZXZlbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZUlwQWRkcmVzcykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlwQWRkcmVzcyA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdC5oZWFkZXJzWydjZi1jb25uZWN0aW5nLWlwJ10gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGlmIChpcEFkZHJlc3MpIHJ0LnB1c2goY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKCdJUCBhZGRyZXNzJywgaXBBZGRyZXNzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZVVzZXJBZ2VudCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJBZ2VudCA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdC5oZWFkZXJzWyd1c2VyLWFnZW50J10gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGlmICh1c2VyQWdlbnQpIHJ0LnB1c2goY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKCdVc2VyIGFnZW50JywgdXNlckFnZW50KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZVJlZmVyZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZWZlcmVyID0gbWVzc2FnZS5ldmVudC5yZXF1ZXN0LmhlYWRlcnNbJ3JlZmVyZXInXSB8fCB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlZmVyZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlclVybCA9IHRyeVBhcnNlVXJsKHJlZmVyZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbG9nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlZmVyZXJVcmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdFVybCA9IHRyeVBhcnNlVXJsKG1lc3NhZ2UuZXZlbnQucmVxdWVzdC51cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcXVlc3RVcmwgJiYgcmVxdWVzdFVybC5vcmlnaW4gPT09IHJlZmVyZXJVcmwub3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvZykgcnQucHVzaChjb21wdXRlQWRkaXRpb25hbExvZ0ZvckV4dHJhRmllbGQoJ1JlZmVyZXInLCByZWZlcmVyKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBydDsKICAgIH0KICAgIHJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCkgewogICAgICAgIGNvbnN0IHNob3VsZFNob3cgPSB0aGlzLnByb2ZpbGVzLmxlbmd0aCA9PT0gMDsKICAgICAgICBpZiAoc2hvdWxkU2hvdyA9PT0gdGhpcy53ZWxjb21lU2hvd2luZykgcmV0dXJuOwogICAgICAgIHRoaXMuc2V0RGVtb01vZGUoc2hvdWxkU2hvdyk7CiAgICAgICAgdGhpcy53ZWxjb21lU2hvd2luZyA9IHNob3VsZFNob3c7CiAgICB9CiAgICBhc3luYyBxdWVyeUR1cmFibGVPYmplY3RzQ29zdHMoY2xpZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5kdXJhYmxlT2JqZWN0c0Nvc3RzID0gYXdhaXQgY29tcHV0ZUR1cmFibGVPYmplY3RzQ29zdHNUYWJsZShjbGllbnQsIHsKICAgICAgICAgICAgICAgIGxvb2tiYWNrRGF5czogMjgKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICh0aGlzLmFuYWx5dGljc1N0YXRlLmR1cmFibGVPYmplY3RzQ29zdHMuYWNjb3VudFRhYmxlLnJvd3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLmR1cmFibGVPYmplY3RzQ29zdHMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGR1cmFibGUgb2JqZWN0IGFuYWx5dGljcyBmb3VuZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oZSk7CiAgICAgICAgICAgIGxldCBlcnJvciA9IGAke2V9YDsKICAgICAgICAgICAgaWYgKGVycm9yLmluY2x1ZGVzKCcoY29kZT1hdXRoeiknKSkgewogICAgICAgICAgICAgICAgZXJyb3IgPSBgVGhlIGF1dGggdG9rZW4gZm9yIHRoaXMgcHJvZmlsZSBkb2VzIG5vdCBoYXZlIHRoZSBBY2NvdW50IEFuYWx5dGljczpSZWFkIHBlcm1pc3Npb24uYDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLmVycm9yID0gZXJyb3I7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLnF1ZXJ5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gewogICAgICAgIGRhdGE6IFsKICAgICAgICAgICAgYCAlY3wlYyBbJWMke25hbWV9JWNdICR7dmFsdWV9YCwKICAgICAgICAgICAgJ2NvbG9yOmdyYXknLAogICAgICAgICAgICAnJywKICAgICAgICAgICAgJ2NvbG9yOmdyYXknCiAgICAgICAgXQogICAgfTsKfQpjbGFzcyBQcm9maWxlRm9ybVZNIHsKICAgIHNob3dpbmcgPSBmYWxzZTsKICAgIGVuYWJsZWQgPSBmYWxzZTsKICAgIG5hbWUgPSAnJzsKICAgIGFjY291bnRJZCA9ICcnOwogICAgYXBpVG9rZW4gPSAnJzsKICAgIGRlbGV0ZVZpc2libGUgPSBmYWxzZTsKICAgIHNhdmVFbmFibGVkID0gZmFsc2U7CiAgICBwcm9maWxlSWQgPSAnJzsKICAgIHRpdGxlID0gJyc7CiAgICBwcm9ncmVzc1Zpc2libGUgPSBmYWxzZTsKICAgIG91dHB1dE1lc3NhZ2UgPSAnJzsKICAgIGNvbXB1dGVTYXZlRW5hYmxlZCgpIHsKICAgICAgICB0aGlzLnNhdmVFbmFibGVkID0gdGhpcy5uYW1lLnRyaW0oKS5sZW5ndGggPiAwICYmIHRoaXMuYXBpVG9rZW4udHJpbSgpLmxlbmd0aCA+IDAgJiYgdGhpcy5hY2NvdW50SWQudHJpbSgpLmxlbmd0aCA+IDA7CiAgICB9Cn0KY2xhc3MgRmlsdGVyRm9ybVZNIHsKICAgIHNob3dpbmcgPSBmYWxzZTsKICAgIGVuYWJsZWQgPSBmYWxzZTsKICAgIGZpZWxkTmFtZSA9ICcnOwogICAgZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgIGZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICBmaWVsZFZhbHVlOwogICAgaGVscFRleHQgPSAnJzsKICAgIG91dHB1dE1lc3NhZ2UgPSAnJzsKICAgIGFwcGx5VmFsdWUgPSAoKT0+e307Cn0KY29uc3QgRVhUUkFfRklFTERTX09QVElPTlMgPSBbCiAgICB7CiAgICAgICAgaWQ6ICdpcC1hZGRyZXNzJywKICAgICAgICB0ZXh0OiAnSVAgYWRkcmVzcycKICAgIH0sCiAgICB7CiAgICAgICAgaWQ6ICd1c2VyLWFnZW50JywKICAgICAgICB0ZXh0OiAnVXNlciBhZ2VudCcKICAgIH0sCiAgICB7CiAgICAgICAgaWQ6ICdyZWZlcmVyJywKICAgICAgICB0ZXh0OiAnUmVmZXJlcicKICAgIH0sIApdOwpjb25zdCBTVEFURV9LRVkgPSAnc3RhdGUxJzsKZnVuY3Rpb24gbG9hZFN0YXRlKCkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBqc29uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RBVEVfS0VZKSB8fCB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGpzb24pIHsKICAgICAgICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZShqc29uKTsKICAgICAgICAgICAgY29uc3QgcnQgPSBwYXJzZVN0YXRlKG9iaik7CiAgICAgICAgICAgIHJldHVybiBydDsKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdsb2FkU3RhdGU6IEVycm9yIGxvYWRpbmcgc3RhdGUnLCBlLnN0YWNrIHx8IGUpOwogICAgfQogICAgY29uc29sZS5sb2coJ2xvYWRTdGF0ZTogcmV0dXJuaW5nIG5ldyBzdGF0ZScpOwogICAgcmV0dXJuIHsKICAgICAgICBwcm9maWxlczoge30KICAgIH07Cn0KZnVuY3Rpb24gcGFyc2VTdGF0ZShwYXJzZWQpIHsKICAgIGlmICh0eXBlb2YgcGFyc2VkICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBvYmplY3RgKTsKICAgIGNvbnN0IHsgcHJvZmlsZXMgIH0gPSBwYXJzZWQ7CiAgICBpZiAodHlwZW9mIHByb2ZpbGVzICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwcm9maWxlcyBvYmplY3RgKTsKICAgIGZvciAoY29uc3QgW3Byb2ZpbGVJZCwgcHJvZmlsZVN0YXRlXSBvZiBPYmplY3QuZW50cmllcyhwcm9maWxlcykpewogICAgICAgIGlmICh0eXBlb2YgcHJvZmlsZUlkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKCdQcm9maWxlIGlkIG11c3QgYmUgc3RyaW5nJyk7CiAgICAgICAgcGFyc2VQcm9maWxlU3RhdGUocHJvZmlsZVN0YXRlKTsKICAgIH0KICAgIHJldHVybiBwYXJzZWQ7Cn0KZnVuY3Rpb24gcGFyc2VQcm9maWxlU3RhdGUocGFyc2VkKSB7CiAgICBpZiAodHlwZW9mIHBhcnNlZCAhPT0gJ29iamVjdCcgfHwgcGFyc2VkID09PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2ZpbGUgc3RhdGUgbXVzdCBiZSBvYmplY3QnKTsKICAgIGNvbnN0IHsgbmFtZSAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcGFyc2VkOwogICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJyB8fCBuYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBuYW1lIG11c3QgZXhpc3RgKTsKICAgIGlmICh0eXBlb2YgYWNjb3VudElkICE9PSAnc3RyaW5nJyB8fCBhY2NvdW50SWQudHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIGFjY291bnRJZCBtdXN0IGV4aXN0YCk7CiAgICBpZiAodHlwZW9mIGFwaVRva2VuICE9PSAnc3RyaW5nJyB8fCBhcGlUb2tlbi50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgYXBpVG9rZW4gbXVzdCBleGlzdGApOwogICAgcmV0dXJuIHBhcnNlZDsKfQpmdW5jdGlvbiBzYXZlU3RhdGUoc3RhdGUpIHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUQVRFX0tFWSwgSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTsKfQphc3luYyBmdW5jdGlvbiBjb21wdXRlQ2FuTGlzdFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4pIHsKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbGlzdFRhaWxzKGFjY291bnRJZCwgJycsIGFwaVRva2VuKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIENsb3VkZmxhcmVBcGlFcnJvciAmJiBlLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQpmdW5jdGlvbiBpc1ZhbGlkU2FtcGxpbmdSYXRlKHNhbXBsaW5nUmF0ZSkgewogICAgcmV0dXJuICFpc05hTihzYW1wbGluZ1JhdGUpICYmIHNhbXBsaW5nUmF0ZSA+PSAwICYmIHNhbXBsaW5nUmF0ZSA8PSAxOwp9CmZ1bmN0aW9uIGNvbXB1dGVJbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZChzdGF0ZSwgcHJvZmlsZXMpIHsKICAgIGlmIChzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCAmJiBzdGF0ZS5wcm9maWxlc1tzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZF0pIHJldHVybiBzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZDsKICAgIGlmIChwcm9maWxlcy5sZW5ndGggPiAwKSByZXR1cm4gcHJvZmlsZXNbMF0uaWQ7CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpIHsKICAgIGNvbnN0IGZpbHRlcnMgPSBbXTsKICAgIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ2Vycm9yJykgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIG91dGNvbWU6IFsKICAgICAgICAgICAgICAgICdleGNlcHRpb24nLAogICAgICAgICAgICAgICAgJ2V4Y2VlZGVkQ3B1JywKICAgICAgICAgICAgICAgICdjYW5jZWxlZCcsCiAgICAgICAgICAgICAgICAndW5rbm93bicKICAgICAgICAgICAgXQogICAgICAgIH0pOwogICAgfSBlbHNlIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgb3V0Y29tZTogWwogICAgICAgICAgICAgICAgJ29rJwogICAgICAgICAgICBdCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLnNhbXBsaW5nUmF0ZTEgIT09IHVuZGVmaW5lZCAmJiBpc1ZhbGlkU2FtcGxpbmdSYXRlKGZpbHRlci5zYW1wbGluZ1JhdGUxKSAmJiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA8IDEpIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBzYW1wbGluZ19yYXRlOiBmaWx0ZXIuc2FtcGxpbmdSYXRlMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5zZWFyY2gxICE9PSB1bmRlZmluZWQgJiYgZmlsdGVyLnNlYXJjaDEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIHF1ZXJ5OiBmaWx0ZXIuc2VhcmNoMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5tZXRob2QxICYmIGZpbHRlci5tZXRob2QxLmxlbmd0aCA+IDApIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBtZXRob2Q6IGZpbHRlci5tZXRob2QxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLmlwQWRkcmVzczEgJiYgZmlsdGVyLmlwQWRkcmVzczEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIGNsaWVudF9pcDogZmlsdGVyLmlwQWRkcmVzczEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuaGVhZGVyMSAmJiBmaWx0ZXIuaGVhZGVyMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChjb25zdCBoZWFkZXIgb2YgZmlsdGVyLmhlYWRlcjEpewogICAgICAgICAgICBmaWx0ZXJzLnB1c2gocGFyc2VIZWFkZXJGaWx0ZXIoaGVhZGVyKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBmaWx0ZXJzCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UsIGZpbHRlcikgewogICAgaWYgKCFjb21wdXRlTWVzc2FnZVBhc3Nlc0xvZ1Byb3BGaWx0ZXIobWVzc2FnZSwgZmlsdGVyLmxvZ3Byb3AxKSkgcmV0dXJuIGZhbHNlOwogICAgaWYgKGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyB8fCBmaWx0ZXIuZXZlbnQxID09PSAnaHR0cCcpIHsKICAgICAgICBjb25zdCBpc0Nyb24gPSBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UpOwogICAgICAgIHJldHVybiBpc0Nyb24gJiYgZmlsdGVyLmV2ZW50MSA9PT0gJ2Nyb24nIHx8ICFpc0Nyb24gJiYgZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY29tcHV0ZU1lc3NhZ2VQYXNzZXNMb2dQcm9wRmlsdGVyKG1lc3NhZ2UsIGxvZ3Byb3AxKSB7CiAgICBpZiAobG9ncHJvcDEgPT09IHVuZGVmaW5lZCB8fCBsb2dwcm9wMS5sZW5ndGggPT09IDApIHJldHVybiB0cnVlOwogICAgY29uc3QgbG9ncHJvcEZpbHRlcnMgPSBsb2dwcm9wMS5tYXAocGFyc2VIZWFkZXJGaWx0ZXIpOwogICAgY29uc3QgeyBwcm9wcyAgfSA9IHBhcnNlTG9nUHJvcHMobWVzc2FnZS5sb2dzKTsKICAgIGZvciAoY29uc3QgbG9ncHJvcEZpbHRlciBvZiBsb2dwcm9wRmlsdGVycyl7CiAgICAgICAgaWYgKGNvbXB1dGVQcm9wc1Bhc3NMb2dwcm9wRmlsdGVyKHByb3BzLCBsb2dwcm9wRmlsdGVyKSkgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gY29tcHV0ZVByb3BzUGFzc0xvZ3Byb3BGaWx0ZXIocHJvcHMsIGxvZ3Byb3BGaWx0ZXIpIHsKICAgIGNvbnN0IHZhbCA9IHByb3BzW2xvZ3Byb3BGaWx0ZXIua2V5XTsKICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKGxvZ3Byb3BGaWx0ZXIucXVlcnkgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7CiAgICBjb25zdCBxID0gbG9ncHJvcEZpbHRlci5xdWVyeS50cmltKCkucmVwbGFjZUFsbCgvXCorL2csICcqJyk7CiAgICBpZiAoIXEuaW5jbHVkZXMoJyonKSkgcmV0dXJuIHEgPT09IHZhbDsKICAgIGlmIChxID09PSAnKicpIHJldHVybiB0cnVlOwogICAgaWYgKHR5cGVvZiB2YWwgIT09ICdzdHJpbmcnKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBwYXR0ZXJuID0gJ14nICsgZXNjYXBlRm9yUmVnZXgocSkucmVwbGFjZUFsbCgnXFwqJywgJy4qJykgKyAnJCc7CiAgICByZXR1cm4gbmV3IFJlZ0V4cChwYXR0ZXJuKS50ZXN0KHZhbCk7Cn0KZnVuY3Rpb24gZXNjYXBlRm9yUmVnZXgoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1stXC9cXF4kKis/LigpfFtcXXt9XS9nLCAnXFwkJicpOwp9CmZ1bmN0aW9uIGRpc3RpbmN0KHZhbHVlcykgewogICAgY29uc3QgcnQgPSBbXTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKXsKICAgICAgICBpZiAoIXJ0LmluY2x1ZGVzKHZhbHVlKSkgewogICAgICAgICAgICBydC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gdHJ5UGFyc2VVcmwodXJsKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKHVybCk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpjb25zdCBGSUxURVJfRURJVE9SX0hUTUwgPSBodG1sYAo8Zm9ybSBpZD0iZmlsdGVyLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJmaWx0ZXItZmllbGRzZXQiPgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0IGZvcm0tcm93Ij5FZGl0IGZpbHRlcjwvZGl2PgoKICA8bGFiZWwgaWQ9ImZpbHRlci1maWVsZC1sYWJlbCI+RmlsdGVyIGZpZWxkOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJmaWx0ZXItZmllbGQtdGV4dCIgdHlwZT0idGV4dCI+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLWNob2ljZSI+PC9kaXY+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLW9wdGlvbnMiPjwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1oZWxwIiBjbGFzcz0iYm9keTIgbWVkaXVtLWVtcGhhc2lzLXRleHQiPgogIDwvZGl2PiAgCgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLW91dHB1dC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8b3V0cHV0IGlkPSJmaWx0ZXItZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogIDwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1idXR0b25zIiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0iZmlsdGVyLWFwcGx5IiB0eXBlPSJzdWJtaXQiPkFwcGx5PC9idXR0b24+PCEtLSBmaXJzdCBzbyBpdCBpcyBkZWZhdWx0IGJ1dHRvbiBvbiByZXR1cm4gLS0+CiAgICA8YnV0dG9uIGlkPSJmaWx0ZXItY2FuY2VsIj5DYW5jZWw8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBGSUxURVJfRURJVE9SX0NTUyA9IGNzc2AKCiAgICAjZmlsdGVyLWZvcm0tYnV0dG9ucyB7CiAgICAgICAganVzdGlmeS1zZWxmOiBlbmQ7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtY2hvaWNlIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXB4OwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtb3B0aW9ucyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgZ2FwOiAxcHg7CiAgICB9CgogICAgI2ZpbHRlci1maWVsZC1vcHRpb25zIGJ1dHRvbiB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMC41cmVtOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1oZWxwIHsKICAgICAgICBncmlkLWNvbHVtbjogMjsKICAgIH0KCiAgICAjZmlsdGVyLWZvcm0tb3V0cHV0LXJvdyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMXJlbTsKICAgICAgICBtaW4taGVpZ2h0OiAyLjVyZW07CiAgICB9CgogICAgI2ZpbHRlci1mb3JtLW91dHB1dC1yb3cgb3V0cHV0IHsKICAgICAgICBmbGV4LWdyb3c6IDE7CiAgICB9CgpgOwpmdW5jdGlvbiBpbml0RmlsdGVyRWRpdG9yKGRvY3VtZW50LCB2bTcpIHsKICAgIGNvbnN0IGZpbHRlckZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZvcm0nKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkc2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZHNldCcpOwogICAgY29uc3QgZmlsdGVyRmllbGRMYWJlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtbGFiZWwnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkVGV4dElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZC10ZXh0Jyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZENob2ljZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtY2hvaWNlJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZE9wdGlvbnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLW9wdGlvbnMnKTsKICAgIGNvbnN0IGZpbHRlckNhbmNlbEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItY2FuY2VsJyk7CiAgICBjb25zdCBmaWx0ZXJBcHBseUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItYXBwbHknKTsKICAgIGNvbnN0IGZpbHRlckZvcm1PdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZvcm0tb3V0cHV0Jyk7CiAgICBjb25zdCBmaWx0ZXJGb3JtSGVscERpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZm9ybS1oZWxwJyk7CiAgICBmaWx0ZXJDYW5jZWxCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTcuY2FuY2VsRmlsdGVyKCk7CiAgICB9OwogICAgZmlsdGVyQXBwbHlCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBjb25zdCB0eXBlID0gY29tcHV0ZVR5cGUodm03KTsKICAgICAgICBpZiAodHlwZSA9PT0gJ3RleHQnKSB7CiAgICAgICAgICAgIHZtNy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXJGaWVsZFRleHRJbnB1dC52YWx1ZTsKICAgICAgICB9CiAgICAgICAgdm03LnNhdmVGaWx0ZXIoKTsKICAgIH07CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB3YXNIaWRkZW4gPSBmaWx0ZXJGb3JtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJzsKICAgICAgICBmaWx0ZXJGb3JtLnN0eWxlLmRpc3BsYXkgPSB2bTcuZmlsdGVyRm9ybS5zaG93aW5nID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBmaWx0ZXJGaWVsZHNldC5kaXNhYmxlZCA9ICF2bTcuZmlsdGVyRm9ybS5lbmFibGVkOwogICAgICAgIGNvbnN0IHR5cGUgPSBjb21wdXRlVHlwZSh2bTcpOwogICAgICAgIGZpbHRlckZpZWxkTGFiZWwudGV4dENvbnRlbnQgPSB2bTcuZmlsdGVyRm9ybS5maWVsZE5hbWU7CiAgICAgICAgZmlsdGVyRmllbGRMYWJlbC5odG1sRm9yID0gdHlwZSA9PSAnY2hvaWNlJyA/IGZpbHRlckZpZWxkQ2hvaWNlRGl2LmlkIDogdHlwZSA9PSAnb3B0aW9ucycgPyBmaWx0ZXJGaWVsZE9wdGlvbnNEaXYuaWQgOiBmaWx0ZXJGaWVsZFRleHRJbnB1dC5pZDsKICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5zdHlsZS5kaXNwbGF5ID0gdHlwZSA9PSAndGV4dCcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGZpbHRlckZpZWxkQ2hvaWNlRGl2LnN0eWxlLmRpc3BsYXkgPSB0eXBlID09ICdjaG9pY2UnID8gJ2ZsZXgnIDogJ25vbmUnOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKENIT0lDRVNfSFRNTCh2bTcpLCBmaWx0ZXJGaWVsZENob2ljZURpdik7CiAgICAgICAgZmlsdGVyRmllbGRPcHRpb25zRGl2LnN0eWxlLmRpc3BsYXkgPSB0eXBlID09ICdvcHRpb25zJyA/ICdmbGV4JyA6ICdub25lJzsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihPUFRJT05TX0hUTUwodm03KSwgZmlsdGVyRmllbGRPcHRpb25zRGl2KTsKICAgICAgICBmaWx0ZXJGb3JtSGVscERpdi50ZXh0Q29udGVudCA9IHZtNy5maWx0ZXJGb3JtLmhlbHBUZXh0OwogICAgICAgIGZpbHRlckZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bTcuZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlOwogICAgICAgIGlmICh3YXNIaWRkZW4gJiYgdm03LmZpbHRlckZvcm0uc2hvd2luZykgewogICAgICAgICAgICBjb25zb2xlLmxvZygnZmlsdGVyIGZvcm0gb3BlbicpOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3RleHQnICYmIHZtNy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUpIGZpbHRlckZpZWxkVGV4dElucHV0LnZhbHVlID0gdm03LmZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgZmlsdGVyRmllbGRUZXh0SW5wdXQuZm9jdXMoKTsKICAgICAgICAgICAgICAgIGZpbHRlckZpZWxkVGV4dElucHV0LnNlbGVjdCgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVUeXBlKHZtOCkgewogICAgcmV0dXJuIHZtOC5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmxlbmd0aCA+IDAgPyAnY2hvaWNlJyA6IHZtOC5maWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zLmxlbmd0aCA/ICdvcHRpb25zJyA6ICd0ZXh0JzsKfQpjb25zdCBDSE9JQ0VTX0hUTUwgPSAodm05KT0+ewogICAgcmV0dXJuIHZtOS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLm1hcCgoY2hvaWNlKT0+aHRtbGA8YnV0dG9uIGNsYXNzPSIke2Nob2ljZS5pZCA9PT0gdm05LmZpbHRlckZvcm0uZmllbGRWYWx1ZSA/ICdzZWxlY3RlZCcgOiAnJ30iIEBjbGljaz0keyhlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtOS5zZWxlY3RGaWx0ZXJDaG9pY2UoY2hvaWNlLmlkKTsKICAgICAgICB9fSA/ZGlzYWJsZWQ9IiR7IXZtOS5maWx0ZXJGb3JtLnNob3dpbmd9Ij4ke2Nob2ljZS50ZXh0fTwvYnV0dG9uPmAKICAgICk7Cn07CmNvbnN0IE9QVElPTlNfSFRNTCA9ICh2bTEwKT0+ewogICAgcmV0dXJuIHZtMTAuZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucy5tYXAoKG9wdGlvbik9PnsKICAgICAgICBjb25zdCBzZWxlY3RlZCA9IGZpZWxkVmFsdWVTZXQodm0xMCkuaGFzKG9wdGlvbi5pZCk7CiAgICAgICAgcmV0dXJuIGh0bWxgPGJ1dHRvbiBjbGFzcz0iJHtzZWxlY3RlZCA/ICdzZWxlY3RlZCcgOiAnJ30iIEBjbGljaz0keyhlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtMTAudG9nZ2xlRmlsdGVyT3B0aW9uKG9wdGlvbi5pZCk7CiAgICAgICAgfX0gP2Rpc2FibGVkPSIkeyF2bTEwLmZpbHRlckZvcm0uc2hvd2luZ30iPiR7c2VsZWN0ZWQgPyBDSEVDS19CT1hfQ0hFQ0tFRF9JQ09OIDogQ0hFQ0tfQk9YX1VOQ0hFQ0tFRF9JQ09OfSAke29wdGlvbi50ZXh0fTwvYnV0dG9uPmA7CiAgICB9KTsKfTsKZnVuY3Rpb24gZmllbGRWYWx1ZVNldCh2bTExKSB7CiAgICByZXR1cm4gbmV3IFNldCgodm0xMS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgfHwgJycpLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICkuZmlsdGVyKCh2KT0+di5sZW5ndGggPiAwCiAgICApKTsKfQpjb25zdCBQUk9GSUxFX0VESVRPUl9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9InByb2ZpbGUtZm9ybSIgYXV0b2NvbXBsZXRlPSJvZmYiPgo8ZmllbGRzZXQgaWQ9InByb2ZpbGUtZmllbGRzZXQiPgogIDxkaXYgaWQ9InByb2ZpbGUtZm9ybS10aXRsZSIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCBmb3JtLXJvdyI+UHJvZmlsZTwvZGl2PgoKICA8bGFiZWwgZm9yPSJwcm9maWxlLW5hbWUiPlByb2ZpbGUgbmFtZTo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1uYW1lIiB0eXBlPSJ0ZXh0Ij4KCiAgPGxhYmVsIGZvcj0iYWNjb3VudC1pZCI+Q2xvdWRmbGFyZSBBY2NvdW50IElEOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJwcm9maWxlLWFjY291bnQtaWQiIHR5cGU9InRleHQiPgoKICA8bGFiZWwgZm9yPSJhcGktdG9rZW4iPkNsb3VkZmxhcmUgQVBJIFRva2VuOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJwcm9maWxlLWFwaS10b2tlbiIgdHlwZT0idGV4dCI+CgogIDxkZXRhaWxzIGlkPSJwcm9maWxlLWZvcm0taGVscC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8c3VtbWFyeT5Vc2UgYSA8YSBocmVmPSJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9QcmluY2lwbGVfb2ZfbGVhc3RfcHJpdmlsZWdlIiB0YXJnZXQ9Il9ibGFuayI+bGVhc3QgcHJpdmlsZWdlPC9hPiB0b2tlbiB3aXRoIHBlcm1pc3Npb246IDxjb2RlPkFjY291bnQgJmd0OyBXb3JrZXJzIFRhaWwgJmd0OyBSZWFkPC9jb2RlPjwvc3VtbWFyeT4KICAgIDxvbD4KICAgICAgICA8bGk+U2VsZWN0IDxzcGFuIGNsYXNzPSJjZi1idXR0b24iPkNyZWF0ZSBUb2tlbjwvc3Bhbj4gb24geW91ciBDbG91ZGZsYXJlIDxhIGhyZWY9Imh0dHBzOi8vZGFzaC5jbG91ZGZsYXJlLmNvbS9wcm9maWxlL2FwaS10b2tlbnMiIHRhcmdldD0iX2JsYW5rIj5BUEkgVG9rZW5zPC9hPiBwYWdlLjwvbGk+CiAgICAgICAgPGxpPlNjcm9sbCBkb3duIHRvIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5DcmVhdGUgQ3VzdG9tIFRva2VuPC9zcGFuPiwgdGhlbiA8c3BhbiBjbGFzcz0iY2YtYnV0dG9uIj5HZXQgc3RhcnRlZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5VbmRlciA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UGVybWlzc2lvbnM8L3NwYW4+LCBncmFudCB5b3VyIHRva2VuIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5BY2NvdW50PC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+V29ya2VycyBUYWlsPC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UmVhZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5BbHNvIChmb3IgYW5hbHl0aWNzKSwgZ3JhbnQgeW91ciB0b2tlbiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+QWNjb3VudDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPkFjY291bnQgQW5hbHl0aWNzPC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UmVhZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5BbHNvIChmb3IgRE8gbmFtZXMpLCBncmFudCB5b3VyIHRva2VuIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5BY2NvdW50PC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+V29ya2VyIFNjcmlwdHM8L3NwYW4+IDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5SZWFkPC9zcGFuPjwvbGk+CiAgICA8L29sPgogIDwvZGV0YWlscz4gIAoKICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyIgY2xhc3M9ImZvcm0tcm93Ij4KICAgIDxvdXRwdXQgaWQ9InByb2ZpbGUtZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogICAgPHByb2dyZXNzIGlkPSJwcm9maWxlLWZvcm0tcHJvZ3Jlc3MiIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmb3JtLWxocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWRlbGV0ZSI+RGVsZXRlPC9idXR0b24+CiAgPC9kaXY+CiAgPGRpdiBpZD0icHJvZmlsZS1mb3JtLWJ1dHRvbnMiIGNsYXNzPSJmb3JtLXJocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWNhbmNlbCI+Q2FuY2VsPC9idXR0b24+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLXNhdmUiPlNhdmU8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBQUk9GSUxFX0VESVRPUl9DU1MgPSBjc3NgCgogICAgI3Byb2ZpbGUtZm9ybS1idXR0b25zIHsKICAgICAgICBqdXN0aWZ5LXNlbGY6IGVuZDsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXJlbTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IHsKICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBzdW1tYXJ5IHsKICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IG9sIHsKICAgICAgICBjdXJzb3I6IGRlZmF1bHQ7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBsaSB7CiAgICAgICAgcGFkZGluZzogMC41cmVtIDA7CiAgICB9CgogICAgLmNmLWJ1dHRvbiB7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IGJsdWU7CiAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIHBhZGRpbmc6IDAuMjVyZW0gMC41cmVtOwogICAgICAgIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgICB9CgogICAgLmNmLXNlY3Rpb24gewogICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICAgcGFkZGluZzogMC4yNXJlbSAwLjVyZW07CiAgICAgICAgb3V0bGluZTogc29saWQgMXB4IGdyYXk7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1vdXRwdXQtcm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgICAgIG1pbi1oZWlnaHQ6IDIuNXJlbTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLW91dHB1dC1yb3cgb3V0cHV0IHsKICAgICAgICBmbGV4LWdyb3c6IDE7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1wcm9ncmVzcyB7CiAgICAgICAgZm9udC1zaXplOiAwLjVyZW07IC8qIGRlZmF1bHQgM2VtID0+IDEuNXJlbSAqLwogICAgfQoKYDsKZnVuY3Rpb24gaW5pdFByb2ZpbGVFZGl0b3IoZG9jdW1lbnQsIHZtMTIpIHsKICAgIGNvbnN0IHByb2ZpbGVGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1UaXRsZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tdGl0bGUnKTsKICAgIGNvbnN0IHByb2ZpbGVGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZpZWxkc2V0Jyk7CiAgICBjb25zdCBwcm9maWxlTmFtZUlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtbmFtZScpOwogICAgY29uc3QgcHJvZmlsZUFjY291bnRJZElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtYWNjb3VudC1pZCcpOwogICAgY29uc3QgcHJvZmlsZUFwaVRva2VuSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1hcGktdG9rZW4nKTsKICAgIGNvbnN0IHByb2ZpbGVEZWxldGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1kZWxldGUnKTsKICAgIGNvbnN0IHByb2ZpbGVDYW5jZWxCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1jYW5jZWwnKTsKICAgIGNvbnN0IHByb2ZpbGVTYXZlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtc2F2ZScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1Qcm9ncmVzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tcHJvZ3Jlc3MnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1vdXRwdXQnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtSGVscERldGFpbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLWhlbHAtcm93Jyk7CiAgICBwcm9maWxlQ2FuY2VsQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xMi5jYW5jZWxQcm9maWxlKCk7CiAgICB9OwogICAgcHJvZmlsZU5hbWVJbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bTEyLnNldFByb2ZpbGVOYW1lKHByb2ZpbGVOYW1lSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVBY2NvdW50SWRJbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bTEyLnNldFByb2ZpbGVBY2NvdW50SWQocHJvZmlsZUFjY291bnRJZElucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bTEyLnNldFByb2ZpbGVBcGlUb2tlbihwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZVNhdmVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTEyLnNhdmVQcm9maWxlKCk7CiAgICB9OwogICAgcHJvZmlsZURlbGV0ZUJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTIuZGVsZXRlUHJvZmlsZSh2bTEyLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gcHJvZmlsZUZvcm0uc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIHByb2ZpbGVGb3JtLnN0eWxlLmRpc3BsYXkgPSB2bTEyLnByb2ZpbGVGb3JtLnNob3dpbmcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVGaWVsZHNldC5kaXNhYmxlZCA9ICF2bTEyLnByb2ZpbGVGb3JtLmVuYWJsZWQ7CiAgICAgICAgcHJvZmlsZUZvcm1UaXRsZURpdi50ZXh0Q29udGVudCA9IHZtMTIucHJvZmlsZUZvcm0udGl0bGU7CiAgICAgICAgcHJvZmlsZU5hbWVJbnB1dC52YWx1ZSA9IHZtMTIucHJvZmlsZUZvcm0ubmFtZTsKICAgICAgICBwcm9maWxlQWNjb3VudElkSW5wdXQudmFsdWUgPSB2bTEyLnByb2ZpbGVGb3JtLmFjY291bnRJZDsKICAgICAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSA9IHZtMTIucHJvZmlsZUZvcm0uYXBpVG9rZW47CiAgICAgICAgcHJvZmlsZURlbGV0ZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gdm0xMi5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID8gJ2lubGluZS1ibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZVNhdmVCdXR0b24uZGlzYWJsZWQgPSAhdm0xMi5wcm9maWxlRm9ybS5zYXZlRW5hYmxlZDsKICAgICAgICBwcm9maWxlRm9ybVByb2dyZXNzLnN0eWxlLmRpc3BsYXkgPSB2bTEyLnByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZUZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bTEyLnByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2U7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiB2bTEyLnByb2ZpbGVGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc3QgaW5pdGlhbERldGFpbHNPcGVuID0gdm0xMi5yZWFsUHJvZmlsZXMubGVuZ3RoID09PSAwOwogICAgICAgICAgICBwcm9maWxlRm9ybUhlbHBEZXRhaWxzLm9wZW4gPSBpbml0aWFsRGV0YWlsc09wZW47CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIHByb2ZpbGVOYW1lSW5wdXQuZm9jdXMoKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVOYW1lSW5wdXQuc2VsZWN0KCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgV0VMQ09NRV9QQU5FTF9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9IndlbGNvbWUtcGFuZWwiIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJ3ZWxjb21lLXBhbmVsLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJ3ZWxjb21lLXBhbmVsLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQgZm9ybS1yb3ciPnRpdGxlPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tcm93IGJvZHkyIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij4KICAgIFdlbGNvbWUgdG8gPHNwYW4gY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+V2VidGFpbCBmb3IgQ2xvdWRmbGFyZSBXb3JrZXJzPC9zcGFuPiEKICAgIDxwPlZpZXcgbGl2ZSByZXF1ZXN0cyBhbmQgbG9ncyBmcm9tIDxhIGhyZWY9Imh0dHBzOi8vd29ya2Vycy5jbG91ZGZsYXJlLmNvbS8iIHRhcmdldD0iX2JsYW5rIj5DbG91ZGZsYXJlIFdvcmtlcnM8L2E+IGZyb20gdGhlIGNvbWZvcnQgb2YgeW91ciBicm93c2VyLiAKICAgIEEgZmV3IGVuaGFuY2VtZW50cyBvdmVyIHdoYXQncyBwcm92aWRlZCA8YSBocmVmPSJodHRwczovL2Jsb2cuY2xvdWRmbGFyZS5jb20vaW50cm9kdWNpbmctd29ya2Vycy1kYXNoYm9hcmQtbG9ncy8iIHRhcmdldD0iX2JsYW5rIj5ieSBkZWZhdWx0PC9hPiBpbiB0aGUgQ2xvdWRmbGFyZSBkYXNoYm9hcmQ6PC9wPgogICAgPHVsPgogICAgICAgIDxsaT5UYWlsIG11bHRpcGxlIHdvcmtlcnMgYXQgdGhlIHNhbWUgdGltZTwvbGk+CiAgICAgICAgPGxpPkFkdmFuY2VkIGZpbHRlcmluZyBhbmQgbXVsdGktY29sb3Igb3V0cHV0IHNpbWlsYXIgdG8gPGEgaHJlZj0iaHR0cHM6Ly9kZXZlbG9wZXJzLmNsb3VkZmxhcmUuY29tL3dvcmtlcnMvY2xpLXdyYW5nbGVyL2NvbW1hbmRzI3RhaWwiIHRhcmdldD0iX2JsYW5rIj53cmFuZ2xlciB0YWlsPC9hPjwvbGk+CiAgICAgICAgPGxpPkR1cmFibGUgb2JqZWN0IGNsYXNzL25hbWUvaWQgYW5kIGNvbG8gaW5mb3JtYXRpb24gY2FuIGJlIHN1cmZhY2VkIHdpdGggPGEgaHJlZj0iaHR0cHM6Ly9kZW5vZmxhcmUuZGV2L2V4YW1wbGVzL3dlYnRhaWwjbG9ncHJvcHMiIHRhcmdldD0iX2JsYW5rIj5sb2dwcm9wczwvYT48L2xpPgogICAgICAgIDxsaT5NdWx0aXBsZSBwcm9maWxlcywgc3dpdGNoIGVhc2lseSBiZXR3ZWVuIG11bHRpcGxlIGFjY291bnRzPC9saT4KICAgICAgICA8bGk+Tm8gbmVlZCB0byBsb2cgaW4gd2l0aCB5b3VyIGZ1bGwgQ2xvdWRmbGFyZSBjcmVkZW50aWFscy4gIFByb2ZpbGVzIGFyZSBzdG9yZWQgbG9jYWxseSBpbiB0aGUgYnJvd3NlciwgYW5kIGNhbiBiZSBwZXJtaXNzaW9uZWQgb25seSBmb3IgdGFpbGluZyB3b3JrZXJzPC9saT4KICAgICAgICA8bGk+SW1wbGVtZW50ZWQgYXMgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL3NreW1ldGhvZC9kZW5vZmxhcmUvdHJlZS9tYXN0ZXIvZXhhbXBsZXMvd2VidGFpbC13b3JrZXIiIHRhcmdldD0iX2JsYW5rIj5hbiBvcGVuLXNvdXJjZSBDbG91ZGZsYXJlIFdvcmtlcjwvYT4sIAogICAgICAgICAgIDxhIGhyZWY9Imh0dHBzOi8vZGVub2ZsYXJlLmRldi9leGFtcGxlcy93ZWJ0YWlsI2RlcGxveS1pdC10by15b3VyLW93bi1hY2NvdW50IiB0YXJnZXQ9Il9ibGFuayI+ZGVwbG95IGl0IHRvIHlvdXIgb3duIGFjY291bnQ8L2E+LCAKICAgICAgICAgICAgb3IgPGEgaHJlZj0iaHR0cHM6Ly9kZW5vZmxhcmUuZGV2L2V4YW1wbGVzL3dlYnRhaWwjaG9zdC1pdC1sb2NhbGx5IiB0YXJnZXQ9Il9ibGFuayI+aG9zdCBpdCBsb2NhbGx5PC9hPiB3aXRoIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayI+PGNvZGU+ZGVub2ZsYXJlPC9jb2RlPjwvYT48L2xpPgogICAgPC91bD4KICAgIDxwIGlkPSJ3ZWxjb21lLXBhbmVsLXRyYWlsZXIiPkNyZWF0ZSBhIG5ldyBwcm9maWxlIHRvIGdldCBzdGFydGVkITwvcD4KICAgIDxwIGlkPSJhYm91dC1wYW5lbC10cmFpbGVyIj5IZWFkIG92ZXIgdG8gdGhlIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayI+RGVub2ZsYXJlIEdpdEh1YiByZXBvPC9hPiB0byByZXF1ZXN0IGZlYXR1cmVzLCByZXBvcnQgYnVncywgb3IgY2hlY2sgb3V0IHRoZSBjb2RlITwvcD4KICA8L2Rpdj4KCiAgPGRpdiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0id2VsY29tZS1wYW5lbC1uZXctcHJvZmlsZSIgdHlwZT0ic3VibWl0Ij5OZXcgcHJvZmlsZTwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0id2VsY29tZS1wYW5lbC1jbG9zZSIgdHlwZT0ic3VibWl0Ij5DbG9zZTwvYnV0dG9uPgogIDwvZGl2Pgo8L2ZpZWxkc2V0Pgo8L2Zvcm0+CmA7CmNvbnN0IFdFTENPTUVfUEFORUxfQ1NTID0gY3NzYAoKICAgICN3ZWxjb21lLXBhbmVsLWZvcm0tdGl0bGUgewogICAgICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgfQoKYDsKZnVuY3Rpb24gaW5pdFdlbGNvbWVQYW5lbChkb2N1bWVudCwgdm0xMykgewogICAgY29uc3Qgd2VsY29tZVBhbmVsRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWxjb21lLXBhbmVsJyk7CiAgICBjb25zdCB0aXRsZUVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC1mb3JtLXRpdGxlJyk7CiAgICBjb25zdCB3ZWxjb21lVHJhaWxlckVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC10cmFpbGVyJyk7CiAgICBjb25zdCBhYm91dFRyYWlsZXJFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Fib3V0LXBhbmVsLXRyYWlsZXInKTsKICAgIGNvbnN0IG5ld1Byb2ZpbGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC1uZXctcHJvZmlsZScpOwogICAgY29uc3QgY2xvc2VCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC1jbG9zZScpOwogICAgbmV3UHJvZmlsZUJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTMubmV3UHJvZmlsZSgpOwogICAgfTsKICAgIGNsb3NlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xMy5jbG9zZUFib3V0KCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gd2VsY29tZVBhbmVsRWxlbWVudC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7CiAgICAgICAgY29uc3Qgc2hvdyA9IHZtMTMud2VsY29tZVNob3dpbmcgJiYgIXZtMTMucHJvZmlsZUZvcm0uc2hvd2luZyB8fCB2bTEzLmFib3V0U2hvd2luZzsKICAgICAgICB3ZWxjb21lUGFuZWxFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjb25zdCB3ZWxjb21lID0gdm0xMy53ZWxjb21lU2hvd2luZzsKICAgICAgICB0aXRsZUVsZW1lbnQudGV4dENvbnRlbnQgPSB3ZWxjb21lID8gJ0hlbGxvIPCfkYsnIDogJ0Fib3V0JzsKICAgICAgICB3ZWxjb21lVHJhaWxlckVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IHdlbGNvbWUgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGFib3V0VHJhaWxlckVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IHdlbGNvbWUgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgIG5ld1Byb2ZpbGVCdXR0b24uc3R5bGUuZGlzcGxheSA9IHdlbGNvbWUgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGNsb3NlQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ25vbmUnIDogJ2Jsb2NrJzsKICAgICAgICBpZiAod2FzSGlkZGVuICYmIHNob3cpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7d2VsY29tZSA/ICd3ZWxjb21lJyA6ICdhYm91dCd9IHBhbmVsIG9wZW5gKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgKHdlbGNvbWUgPyBuZXdQcm9maWxlQnV0dG9uIDogY2xvc2VCdXR0b24pLmZvY3VzKCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgTU9EQUxfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9Im1vZGFsIiBjbGFzcz0ibW9kYWwgaGlkZGVuLXZlcnRpY2FsLXNjcm9sbCI+CiAgICA8ZGl2IGNsYXNzPSJtb2RhbC1jb250ZW50Ij4KICAgICR7V0VMQ09NRV9QQU5FTF9IVE1MfQogICAgJHtQUk9GSUxFX0VESVRPUl9IVE1MfQogICAgJHtGSUxURVJfRURJVE9SX0hUTUx9CiAgICA8L2Rpdj4KPC9kaXY+CmA7CmNvbnN0IE1PREFMX0NTUyA9IGNzc2AKLm1vZGFsIHsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICB6LWluZGV4OiAxOwogICAgbGVmdDogMDsKICAgIHRvcDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjQpOwp9CgoubW9kYWwtY29udGVudCB7CiAgICBtYXJnaW46IDEwJSBhdXRvOwogICAgd2lkdGg6IDgwJTsKICAgIG1heC13aWR0aDogNDByZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKQG1lZGlhIHNjcmVlbiBhbmQgKG1heC13aWR0aDogNjAwcHgpIHsKICAgIC5tb2RhbC1jb250ZW50IHsKICAgICAgICBtYXJnaW46IDEwJSAwOwogICAgICAgIHdpZHRoOiAxMDAlOwogICAgfQp9CgpgOwpmdW5jdGlvbiBpbml0TW9kYWwoZG9jdW1lbnQsIHZtMTQpIHsKICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsJyk7CiAgICBjb25zdCB1cGRhdGVQcm9maWxlRWRpdG9yID0gaW5pdFByb2ZpbGVFZGl0b3IoZG9jdW1lbnQsIHZtMTQpOwogICAgY29uc3QgdXBkYXRlRmlsdGVyRWRpdG9yID0gaW5pdEZpbHRlckVkaXRvcihkb2N1bWVudCwgdm0xNCk7CiAgICBjb25zdCB1cGRhdGVXZWxjb21lUGFuZWwgPSBpbml0V2VsY29tZVBhbmVsKGRvY3VtZW50LCB2bTE0KTsKICAgIGNvbnN0IGNsb3NlTW9kYWwgPSAoKT0+ewogICAgICAgIGlmICghdm0xNC5wcm9maWxlRm9ybS5zaG93aW5nICYmICF2bTE0LmZpbHRlckZvcm0uc2hvd2luZyAmJiAhdm0xNC53ZWxjb21lU2hvd2luZyAmJiAhdm0xNC5hYm91dFNob3dpbmcpIHJldHVybjsKICAgICAgICBpZiAodm0xNC5wcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUpIHJldHVybjsKICAgICAgICB2bTE0LnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bTE0LmZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHZtMTQuYWJvdXRTaG93aW5nID0gZmFsc2U7CiAgICAgICAgdm0xNC5vbkNoYW5nZSgpOwogICAgfTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudCk9PnsKICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09IG1vZGFsKSB7CiAgICAgICAgICAgIGNsb3NlTW9kYWwoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZXZlbnQpPT57CiAgICAgICAgZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7CiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gJ0VzY2FwZScpIHsKICAgICAgICAgICAgY2xvc2VNb2RhbCgpOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgdXBkYXRlUHJvZmlsZUVkaXRvcigpOwogICAgICAgIHVwZGF0ZUZpbHRlckVkaXRvcigpOwogICAgICAgIHVwZGF0ZVdlbGNvbWVQYW5lbCgpOwogICAgICAgIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSB2bTE0LnByb2ZpbGVGb3JtLnNob3dpbmcgfHwgdm0xNC5maWx0ZXJGb3JtLnNob3dpbmcgfHwgdm0xNC53ZWxjb21lU2hvd2luZyB8fCB2bTE0LmFib3V0U2hvd2luZyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKY29uc3QgQ09OU09MRV9IVE1MID0gaHRtbGAKPGRpdiBpZD0iY29uc29sZSI+CiAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlciI+CiAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItZmlsdGVycyIgY2xhc3M9ImJvZHkyIj48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1zdGF0dXMiPgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci10YWlscyIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItcXBzIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1jbGVhciI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxjb2RlIGlkPSJjb25zb2xlLWxhc3QtbGluZSIgY2xhc3M9ImxpbmUiPnNwYWNlcjwvY29kZT4KPC9kaXY+CmA7CmNvbnN0IENPTlNPTEVfQ1NTID0gY3NzYAoKI2NvbnNvbGUgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgd2lkdGg6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIG92ZXJmbG93LXk6IHNjcm9sbDsKICAgIG92ZXJmbG93LXg6IGhpZGRlbjsKICAgIGZsZXgtZ3JvdzogMTsKfQoKI2NvbnNvbGU6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICAgIHdpZHRoOiAxcmVtOwogICAgaGVpZ2h0OiAzcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCiNjb25zb2xlLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgaGVpZ2h0OiAzLjc1cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMS4yNXJlbSAxcmVtIDFyZW0gMDsKfQoKI2NvbnNvbGUtaGVhZGVyLWZpbHRlcnMgewogICAgZmxleC1ncm93OiAxOwogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1zYW5zLXNlcmlmLWZvbnQtZmFtaWx5KTsKCiAgICBkaXNwbGF5OiAtd2Via2l0LWJveDsKICAgIC13ZWJraXQtbGluZS1jbGFtcDogMzsKICAgIC13ZWJraXQtYm94LW9yaWVudDogdmVydGljYWw7ICAKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1zdGF0dXMgewogICAgaGVpZ2h0OiAxcmVtOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtaW4td2lkdGg6IDZyZW07CiAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgIHBhZGRpbmctdG9wOiAwLjI1cmVtOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCiNjb25zb2xlLWhlYWRlci10YWlscyB7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgojY29uc29sZS1oZWFkZXItY2xlYXIgewogICAgbWFyZ2luLXJpZ2h0OiAtMC41cmVtOwogICAgbWFyZ2luLWxlZnQ6IDFyZW07CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1jbGVhciAuYWN0aW9uLWljb24gewogICAgcGFkZGluZy1yaWdodDogMC41cmVtOwogICAgcGFkZGluZy1sZWZ0OiAwLjVyZW07Cn0KCiNjb25zb2xlIC5saW5lIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1zaXplOiAwLjc1cmVtOyAvKiAxMnB4ICovCiAgICBsaW5lLWhlaWdodDogMS4xcmVtOwogICAgZm9udC1mYW1pbHk6IHZhcigtLW1vbm9zcGFjZS1mb250LWZhbWlseSk7CiAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCiNjb25zb2xlLWxhc3QtbGluZSB7CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCmA7CmZ1bmN0aW9uIGluaXRDb25zb2xlKGRvY3VtZW50LCB2bTE1KSB7CiAgICBjb25zdCBjb25zb2xlRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJGaWx0ZXJzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLWZpbHRlcnMnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJUYWlsc0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItdGFpbHMnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJRcHNFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLXFwcycpOwogICAgY29uc3QgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1jbGVhcicpOwogICAgY29uc3QgY29uc29sZUxhc3RMaW5lRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWxhc3QtbGluZScpOwogICAgbGV0IHNob3dpbmdDbGVhckJ1dHRvbiA9IGZhbHNlOwogICAgdm0xNS5sb2dnZXIgPSAoLi4uZGF0YTYpPT57CiAgICAgICAgY29uc3QgbGluZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjb2RlJyk7CiAgICAgICAgbGluZUVsZW1lbnQuY2xhc3NOYW1lID0gJ2xpbmUnOwogICAgICAgIGxldCBwb3MgPSAwOwogICAgICAgIHdoaWxlKHBvcyA8IGRhdGE2Lmxlbmd0aCl7CiAgICAgICAgICAgIGlmIChwb3MgPiAwKSB7CiAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnLCAnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgbXNnID0gZGF0YTZbcG9zXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0b2tlbnMgPSBtc2cuc3BsaXQoJyVjJyk7CiAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgICAgICAgICAgICAgICAgIGxldCByZW5kZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChpID4gMCAmJiBpIDwgdG9rZW5zLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkYXRhNltwb3MgKyBpXTsKICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlLmluY2x1ZGVzKCd4LScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IC94LWR1cmFibGUtb2JqZWN0LShjbGFzc3xuYW1lfGlkKVxzKjpccyonKC4qPyknLy5leGVjKHN0eWxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gbVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBtWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2dwcm9wTmFtZSA9ICdkdXJhYmxlT2JqZWN0JyArIHR5cGUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyB0eXBlLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5ocmVmID0gJyMnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLm9uY2xpY2sgPSAoKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm0xNS5zZXRMb2dwcm9wRmlsdGVyKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dwcm9wTmFtZSArICc6JyArIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtMTUub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0b2tlbnNbaV0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbmRlcmVkKSByZW5kZXJUZXh0SW50b1NwYW4odG9rZW5zW2ldLCBzcGFuKTsKICAgICAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvcyArPSAxICsgdG9rZW5zLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShKU09OLnN0cmluZ2lmeShtc2cpKSk7CiAgICAgICAgICAgICAgICBwb3MrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zb2xlRGl2Lmluc2VydEJlZm9yZShsaW5lRWxlbWVudCwgY29uc29sZUxhc3RMaW5lRWxlbWVudCk7CiAgICAgICAgY29uc3QgeyBzY3JvbGxIZWlnaHQgLCBzY3JvbGxUb3AgLCBjbGllbnRIZWlnaHQgIH0gPSBjb25zb2xlRGl2OwogICAgICAgIGNvbnN0IGRpZmYgPSBzY3JvbGxIZWlnaHQgLSBzY3JvbGxUb3A7CiAgICAgICAgY29uc3QgYXV0b3Njcm9sbCA9IGRpZmYgLSAxNiAqIDQgPD0gY2xpZW50SGVpZ2h0OwogICAgICAgIGlmIChhdXRvc2Nyb2xsKSB7CiAgICAgICAgICAgIGNvbnNvbGVMYXN0TGluZUVsZW1lbnQuc2Nyb2xsSW50b1ZpZXcoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZiAoIXNob3dpbmdDbGVhckJ1dHRvbikgewogICAgICAgICAgICBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgICAgICAgIHNob3dpbmdDbGVhckJ1dHRvbiA9IHRydWU7CiAgICAgICAgfQogICAgfTsKICAgIHZtMTUub25SZXNldE91dHB1dCA9ICgpPT57CiAgICAgICAgY29uc3QgbGluZXMgPSBjb25zb2xlRGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJy5saW5lJyk7CiAgICAgICAgbGluZXMuZm9yRWFjaCgobGluZSk9PnsKICAgICAgICAgICAgaWYgKGxpbmUuaWQgIT09ICdjb25zb2xlLWxhc3QtbGluZScpIGNvbnNvbGVEaXYucmVtb3ZlQ2hpbGQobGluZSk7CiAgICAgICAgfSk7CiAgICAgICAgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CiAgICAgICAgc2hvd2luZ0NsZWFyQnV0dG9uID0gZmFsc2U7CiAgICB9OwogICAgY29uc29sZUhlYWRlclFwc0VsZW1lbnQudGV4dENvbnRlbnQgPSBjb21wdXRlUXBzVGV4dCgwKTsKICAgIHZtMTUub25RcHNDaGFuZ2UgPSAocXBzKT0+ewogICAgICAgIGNvbnNvbGVIZWFkZXJRcHNFbGVtZW50LnRleHRDb250ZW50ID0gY29tcHV0ZVFwc1RleHQocXBzKTsKICAgIH07CiAgICBMaXRFbGVtZW50LnJlbmRlcihhY3Rpb25JY29uKENMRUFSX0lDT04sIHsKICAgICAgICB0ZXh0OiAnQ2xlYXInLAogICAgICAgIG9uY2xpY2s6ICgpPT52bTE1LnJlc2V0T3V0cHV0KCkKICAgIH0pLCBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50KTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnNvbGVEaXYuc3R5bGUuZGlzcGxheSA9IHZtMTUuc2VsZWN0ZWRBbmFseXRpY0lkID8gJ25vbmUnIDogJ2Jsb2NrJzsKICAgICAgICBjb25zb2xlSGVhZGVyRmlsdGVyc0Rpdi5zdHlsZS52aXNpYmlsaXR5ID0gdm0xNS5wcm9maWxlcy5sZW5ndGggPiAwID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgY29uc29sZUhlYWRlclRhaWxzRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbXB1dGVUYWlsc1RleHQodm0xNS50YWlscy5zaXplKTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihGSUxURVJTX0hUTUwodm0xNSksIGNvbnNvbGVIZWFkZXJGaWx0ZXJzRGl2KTsKICAgIH07Cn0KY29uc3QgRklMVEVSU19IVE1MID0gKHZtMTYpPT57CiAgICByZXR1cm4gaHRtbGBTaG93aW5nIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTZWxlY3Rpb25GaWVsZHMoKTsKICAgIH19PiR7dm0xNi5jb21wdXRlU2VsZWN0aW9uRmllbGRzVGV4dCgpfTwvYT4KICAgICBmb3IgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdEV2ZW50RmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVFdmVudEZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4KICAgICB3aXRoIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTdGF0dXNGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVN0YXR1c0ZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdElwQWRkcmVzc0ZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSXBBZGRyZXNzRmlsdGVyVGV4dCh2bTE2LmZpbHRlcil9PC9hPiwKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5lZGl0TWV0aG9kRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVNZXRob2RGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+LAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTYW1wbGluZ1JhdGVGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVNhbXBsaW5nUmF0ZUZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sIAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTZWFyY2hGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVNlYXJjaEZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sIAogICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdEhlYWRlckZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSGVhZGVyRmlsdGVyVGV4dCh2bTE2LmZpbHRlcil9PC9hPiwKICAgICBhbmQgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdExvZ3Byb3BGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUxvZ3Byb3BGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+LgogICAgICR7dm0xNi5oYXNBbnlGaWx0ZXJzKCkgPyBodG1sYCg8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5yZXNldEZpbHRlcnMoKTsKICAgIH19PnJlc2V0PC9hPilgIDogJyd9YDsKfTsKZnVuY3Rpb24gY29tcHV0ZUV2ZW50RmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgZXZlbnQxICB9ID0gZmlsdGVyOwogICAgcmV0dXJuIGV2ZW50MSA9PT0gJ2Nyb24nID8gJ0NST04gdHJpZ2dlciBldmVudHMnIDogZXZlbnQxID09PSAnaHR0cCcgPyAnSFRUUCByZXF1ZXN0IGV2ZW50cycgOiAnYWxsIGV2ZW50cyc7Cn0KZnVuY3Rpb24gY29tcHV0ZVN0YXR1c0ZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCB7IHN0YXR1czEgIH0gPSBmaWx0ZXI7CiAgICByZXR1cm4gc3RhdHVzMSA9PT0gJ2Vycm9yJyA/ICdlcnJvciBzdGF0dXMnIDogc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnID8gJ3N1Y2Nlc3Mgc3RhdHVzJyA6ICdhbnkgc3RhdHVzJzsKfQpmdW5jdGlvbiBjb21wdXRlSXBBZGRyZXNzRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IGlwQWRkcmVzczEgPSBmaWx0ZXIuaXBBZGRyZXNzMSB8fCBbXTsKICAgIHJldHVybiBpcEFkZHJlc3MxLmxlbmd0aCA9PT0gMCA/ICdhbnkgSVAgYWRkcmVzcycgOiBpcEFkZHJlc3MxLmxlbmd0aCA9PT0gMSA/IGBJUCBhZGRyZXNzIG9mICR7aXBBZGRyZXNzMVswXX1gIDogYElQIGFkZHJlc3MgaW4gWyR7aXBBZGRyZXNzMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVNZXRob2RGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgbWV0aG9kMSA9IGZpbHRlci5tZXRob2QxIHx8IFtdOwogICAgcmV0dXJuIG1ldGhvZDEubGVuZ3RoID09PSAwID8gJ2FueSBtZXRob2QnIDogbWV0aG9kMS5sZW5ndGggPT09IDEgPyBgbWV0aG9kIG9mICR7bWV0aG9kMVswXX1gIDogYG1ldGhvZCBpbiBbJHttZXRob2QxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZVNhbXBsaW5nUmF0ZUZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBzYW1wbGluZ1JhdGUxID0gdHlwZW9mIGZpbHRlci5zYW1wbGluZ1JhdGUxID09PSAnbnVtYmVyJyA/IGZpbHRlci5zYW1wbGluZ1JhdGUxIDogMTsKICAgIHJldHVybiBzYW1wbGluZ1JhdGUxID49IDEgPyAnbm8gc2FtcGxpbmcnIDogYCR7KE1hdGgubWF4KDAsIHNhbXBsaW5nUmF0ZTEpICogMTAwKS50b0ZpeGVkKDIpfSUgc2FtcGxpbmcgcmF0ZWA7Cn0KZnVuY3Rpb24gY29tcHV0ZVNlYXJjaEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCB7IHNlYXJjaDEgIH0gPSBmaWx0ZXI7CiAgICByZXR1cm4gdHlwZW9mIHNlYXJjaDEgPT09ICdzdHJpbmcnICYmIHNlYXJjaDEubGVuZ3RoID4gMCA/IGBjb25zb2xlIGxvZ3MgY29udGFpbmluZyAiJHtzZWFyY2gxfSJgIDogJ25vIHNlYXJjaCBmaWx0ZXInOwp9CmZ1bmN0aW9uIGNvbXB1dGVIZWFkZXJGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgaGVhZGVyMSA9IGZpbHRlci5oZWFkZXIxIHx8IFtdOwogICAgcmV0dXJuIGhlYWRlcjEubGVuZ3RoID09PSAwID8gJ25vIGhlYWRlciBmaWx0ZXInIDogaGVhZGVyMS5sZW5ndGggPT09IDEgPyBgaGVhZGVyIGZpbHRlciBvZiAke2hlYWRlcjFbMF19YCA6IGBoZWFkZXIgZmlsdGVycyBvZiBbJHtoZWFkZXIxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZUxvZ3Byb3BGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgbG9ncHJvcDEgPSBmaWx0ZXIubG9ncHJvcDEgfHwgW107CiAgICByZXR1cm4gbG9ncHJvcDEubGVuZ3RoID09PSAwID8gJ25vIGxvZ3Byb3AgZmlsdGVyJyA6IGxvZ3Byb3AxLmxlbmd0aCA9PT0gMSA/IGBsb2dwcm9wIGZpbHRlciBvZiAke2xvZ3Byb3AxWzBdfWAgOiBgbG9ncHJvcCBmaWx0ZXJzIG9mIFske2xvZ3Byb3AxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZVRhaWxzVGV4dCh0YWlsQ291bnQpIHsKICAgIHJldHVybiB0YWlsQ291bnQgPT09IDAgPyAnbm8gdGFpbHMnIDogdGFpbENvdW50ID09PSAxID8gJzEgdGFpbCcgOiBgJHt0YWlsQ291bnR9IHRhaWxzYDsKfQpmdW5jdGlvbiBjb21wdXRlUXBzVGV4dChxcHMpIHsKICAgIHJldHVybiBgJHtxcHMudG9GaXhlZCgyKX0gcXBzYDsKfQpmdW5jdGlvbiByZW5kZXJUZXh0SW50b1NwYW4odGV4dCwgc3BhbikgewogICAgY29uc3QgcGF0dGVybiA9IC8oaHR0cHM6XC9cL1teXHMpXSt8XGR7MSwzfVwuXGR7MSwzfVwuXGR7MSwzfVwuXGR7MSwzfXxbXGQwLWZdKyg6KFtcZDAtZl17MCw0fSk/KXs1LDd9KS9nOwogICAgbGV0IG07CiAgICBsZXQgaSA9IDA7CiAgICB3aGlsZShudWxsICE9PSAobSA9IHBhdHRlcm4uZXhlYyh0ZXh0KSkpewogICAgICAgIGlmIChtLmluZGV4ID4gaSkgewogICAgICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQuc3Vic3RyaW5nKGksIG0uaW5kZXgpKSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVybE9ySXAgPSBtWzBdOwogICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsT3JJcC5zdGFydHNXaXRoKCdodHRwczovLycpID8gdXJsT3JJcCA6IGBodHRwczovL2lwaW5mby5pby8ke3VybE9ySXB9YDsKICAgICAgICBhLnRhcmdldCA9ICdfYmxhbmsnOwogICAgICAgIGEucmVsID0gJ25vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3cnOwogICAgICAgIGEuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodXJsT3JJcCkpOwogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgaSA9IG0uaW5kZXggKyB1cmxPcklwLmxlbmd0aDsKICAgIH0KICAgIGlmIChpIDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQuc3Vic3RyaW5nKGkpKSk7CiAgICB9Cn0KY29uc3QgQU5BTFlUSUNTX0hUTUwxID0gaHRtbGAKPGRpdiBpZD0iYW5hbHl0aWNzIj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1oZWFkZXIiPgogICAgICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1oZWFkaW5nIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJhbmFseXRpY3Mtc3ViaGVhZGluZyIgY2xhc3M9Im1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLXF1ZXJ5aW5nIj48cHJvZ3Jlc3MgaWQ9ImFuYWx5dGljcy1wcm9ncmVzcyIgY2xhc3M9InB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIiPjwvcHJvZ3Jlc3M+PGRpdiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPkZldGNoaW5nIGFuYWx5dGljcy4uLjwvZGl2PjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLWVycm9yIiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLXRhYmxlIiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLW5hbWVzcGFjZXMtdGFibGUiICBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLWZvb3Rub3RlIiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjxzdXA+Kjwvc3VwPiBFc3RpbWF0ZWQgYmFzZWQgb24gcmVjZW50IHVzYWdlPC9kaXY+CjwvZGl2PgpgOwpjb25zdCBBTkFMWVRJQ1NfQ1NTID0gY3NzYAoKI2FuYWx5dGljcyB7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGhlaWdodDogMTAwdmg7CiAgICB3aWR0aDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgb3ZlcmZsb3cteTogc2Nyb2xsOwogICAgb3ZlcmZsb3cteDogaGlkZGVuOwogICAgZmxleC1ncm93OiAxOwogICAgZGlzcGxheTogbm9uZTsKfQoKI2FuYWx5dGljczo6LXdlYmtpdC1zY3JvbGxiYXIgewogICAgd2lkdGg6IDFyZW07CiAgICBoZWlnaHQ6IDNyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKI2FuYWx5dGljczo6LXdlYmtpdC1zY3JvbGxiYXItdGh1bWIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgojYW5hbHl0aWNzLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBwYWRkaW5nOiAxcmVtIDA7CiAgICBoZWlnaHQ6IDNyZW07Cn0KCiNhbmFseXRpY3Mtc3ViaGVhZGluZyB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKfQoKI2FuYWx5dGljcy1wcm9ncmVzcyB7CiAgICBmb250LXNpemU6IDAuNXJlbTsgLyogZGVmYXVsdCAzZW0gPT4gMS41cmVtICovCn0KCiNhbmFseXRpY3MtcXVlcnlpbmcgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBnYXA6IDAuNXJlbTsKfQoKI2FuYWx5dGljcyB0YWJsZSB7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgIGJvcmRlci1zcGFjaW5nOiAwLjM3NXJlbTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7Cn0KCiNhbmFseXRpY3MgdGggewogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgojYW5hbHl0aWNzIC5zcGFjZXIgewogICAgd2lkdGg6IDAuNzVyZW07Cn0KCiNhbmFseXRpY3MtdGFibGUgLmVzdGltYXRlIHRkIHsKICAgIHBhZGRpbmctdG9wOiAxcmVtOwp9CgojYW5hbHl0aWNzIC5tb25vIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1tb25vc3BhY2UtZm9udC1mYW1pbHkpOwp9CgojYW5hbHl0aWNzLW5hbWVzcGFjZXMtdGFibGUgewogICAgbWFyZ2luLXRvcDogMnJlbTsKfQoKI2FuYWx5dGljcy1uYW1lc3BhY2VzLXRhYmxlIGEudW5zZWxlY3RlZCB7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgI2FuYWx5dGljcy1uYW1lc3BhY2VzLXRhYmxlIGEudW5zZWxlY3RlZDpob3ZlciB7CiAgICAgICAgY29sb3I6IHZhcigtLXByaW1hcnktY29sb3IpOwogICAgfQp9CgojYW5hbHl0aWNzIC5sZWZ0LWFsaWduZWQgewogICAgdGV4dC1hbGlnbjogbGVmdDsKfQoKI2FuYWx5dGljcy1mb290bm90ZSB7CiAgICBtYXJnaW4tdG9wOiAxcmVtOwogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgZGlzcGxheTogbm9uZTsKfQoKYDsKZnVuY3Rpb24gaW5pdEFuYWx5dGljcyhkb2N1bWVudCwgdm0xNykgewogICAgY29uc3QgYW5hbHl0aWNzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcycpOwogICAgY29uc3QgYW5hbHl0aWNzSGVhZGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtaGVhZGluZycpOwogICAgY29uc3QgYW5hbHl0aWNzU3ViaGVhZGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3Mtc3ViaGVhZGluZycpOwogICAgY29uc3QgYW5hbHl0aWNzUXVlcnlpbmdFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy1xdWVyeWluZycpOwogICAgY29uc3QgYW5hbHl0aWNzRXJyb3JFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy1lcnJvcicpOwogICAgY29uc3QgYW5hbHl0aWNzVGFibGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy10YWJsZScpOwogICAgY29uc3QgYW5hbHl0aWNzTmFtZXNwYWNlc1RhYmxlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtbmFtZXNwYWNlcy10YWJsZScpOwogICAgY29uc3QgYW5hbHl0aWNzRm9vdG5vdGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy1mb290bm90ZScpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgYW5hbHl0aWNzRGl2LnN0eWxlLmRpc3BsYXkgPSB2bTE3LnNlbGVjdGVkQW5hbHl0aWNJZCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgaWYgKCF2bTE3LnNlbGVjdGVkQW5hbHl0aWNJZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHNlbGVjdGVkQW5hbHl0aWMgPSB2bTE3LmFuYWx5dGljcy5maW5kKCh2KT0+di5pZCA9PT0gdm0xNy5zZWxlY3RlZEFuYWx5dGljSWQKICAgICAgICApOwogICAgICAgIGlmICghc2VsZWN0ZWRBbmFseXRpYykgcmV0dXJuOwogICAgICAgIGFuYWx5dGljc0hlYWRpbmcudGV4dENvbnRlbnQgPSBzZWxlY3RlZEFuYWx5dGljLnRleHQ7CiAgICAgICAgYW5hbHl0aWNzU3ViaGVhZGluZy50ZXh0Q29udGVudCA9IHNlbGVjdGVkQW5hbHl0aWMuZGVzY3JpcHRpb24gfHwgJyc7CiAgICAgICAgY29uc3QgeyBkdXJhYmxlT2JqZWN0c0Nvc3RzICwgcXVlcnlpbmcgLCBlcnJvciAgfSA9IHZtMTcuYW5hbHl0aWNzU3RhdGU7CiAgICAgICAgYW5hbHl0aWNzUXVlcnlpbmdFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBxdWVyeWluZyA/ICdmbGV4JyA6ICdub25lJzsKICAgICAgICBhbmFseXRpY3NFcnJvckVsZW1lbnQudGV4dENvbnRlbnQgPSBlcnJvciB8fCAnJzsKICAgICAgICBhbmFseXRpY3NGb290bm90ZUVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IGR1cmFibGVPYmplY3RzQ29zdHMgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGlmIChkdXJhYmxlT2JqZWN0c0Nvc3RzKSB7CiAgICAgICAgICAgIGNvbnN0IHJlbmRlckNvc3RzID0gKG5hbWVzcGFjZUlkKT0+ewogICAgICAgICAgICAgICAgY29uc3QgdGFibGUgPSBkdXJhYmxlT2JqZWN0c0Nvc3RzLm5hbWVzcGFjZVRhYmxlc1tuYW1lc3BhY2VJZCB8fCAnJ10gfHwgZHVyYWJsZU9iamVjdHNDb3N0cy5hY2NvdW50VGFibGU7CiAgICAgICAgICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihDT1NUU19IVE1MKHRhYmxlLCBuYW1lc3BhY2VJZCksIGFuYWx5dGljc1RhYmxlRWxlbWVudCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJlbmRlckNvc3RzKHVuZGVmaW5lZCk7CiAgICAgICAgICAgIExpdEVsZW1lbnQucmVuZGVyKE5BTUVTUEFDRVNfSFRNTChkdXJhYmxlT2JqZWN0c0Nvc3RzLCByZW5kZXJDb3N0cyksIGFuYWx5dGljc05hbWVzcGFjZXNUYWJsZUVsZW1lbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIExpdEVsZW1lbnQucmVuZGVyKHVuZGVmaW5lZCwgYW5hbHl0aWNzVGFibGVFbGVtZW50KTsKICAgICAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIodW5kZWZpbmVkLCBhbmFseXRpY3NOYW1lc3BhY2VzVGFibGVFbGVtZW50KTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IEZJWEVEXzEgPSBuZXcgSW50bC5OdW1iZXJGb3JtYXQoJ2VuLVVTJywgewogICAgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAxLAogICAgbWluaW11bUZyYWN0aW9uRGlnaXRzOiAxCn0pOwpjb25zdCBGSVhFRF8yID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdlbi1VUycsIHsKICAgIG1heGltdW1GcmFjdGlvbkRpZ2l0czogMiwKICAgIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMgp9KTsKZnVuY3Rpb24gZm9ybWF0MSh2YWwpIHsKICAgIGlmICh2YWwgPCAxMDAwKSByZXR1cm4gdmFsLnRvU3RyaW5nKCk7CiAgICByZXR1cm4gYCR7RklYRURfMS5mb3JtYXQodmFsIC8gMTAwMCl9a2A7Cn0KZnVuY3Rpb24gZm9ybWF0Mih2YWwpIHsKICAgIGlmICh2YWwgPCAxMDAwKSByZXR1cm4gdmFsLnRvRml4ZWQoMik7CiAgICByZXR1cm4gYCR7RklYRURfMi5mb3JtYXQodmFsIC8gMTAwMCl9a2A7Cn0KZnVuY3Rpb24gZm9ybWF0R2IodmFsKSB7CiAgICBpZiAodmFsIDwgMSkgcmV0dXJuIGAke2Zvcm1hdDIodmFsICogMTAyNCl9bWJgOwogICAgcmV0dXJuIGAke2Zvcm1hdDIodmFsKX1nYmA7Cn0KZnVuY3Rpb24gY2xpY2tOYW1lc3BhY2UoZSwgcmVuZGVyQ29zdHMpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IHRleHQgPSBlLnRhcmdldC50ZXh0Q29udGVudCB8fCAnJzsKICAgIGNvbnNvbGUubG9nKCdjbGlja05hbWVzcGFjZScsIHRleHQpOwogICAgcmVuZGVyQ29zdHModGV4dC5zdGFydHNXaXRoKCdBbGwnKSA/IHVuZGVmaW5lZCA6IHRleHQpOwogICAgY29uc3QgYW5jaG9ycyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJyNhbmFseXRpY3MtbmFtZXNwYWNlcy10YWJsZSBhJyk7CiAgICBhbmNob3JzLmZvckVhY2goKGEpPT57CiAgICAgICAgYS5jbGFzc05hbWUgPSBhID09PSBlLnRhcmdldCA/ICcnIDogJ3Vuc2VsZWN0ZWQnOwogICAgfSk7Cn0KY29uc3QgTkFNRVNQQUNFU19IVE1MID0gKHRhYmxlLCByZW5kZXJDb3N0cyk9Pmh0bWxgCiAgICA8dGFibGU+CiAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+TmFtZXNwYWNlIElEPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoPlNjcmlwdDwvdGg+CiAgICAgICAgICAgIDx0aD5DbGFzczwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aD5Ub3RhbDwvdGg+CiAgICAgICAgPC90cj4KICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0ibGVmdC1hbGlnbmVkIG1vbm8iPjxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+Y2xpY2tOYW1lc3BhY2UoZSwgcmVuZGVyQ29zdHMpCiAgICB9PkFsbCBkdXJhYmxlIG9iamVjdHM8L2E+PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7KHRhYmxlLmFjY291bnRUYWJsZS5lc3RpbWF0ZWQzMERheVJvdz8udG90YWxDb3N0IHx8IDApLnRvRml4ZWQoMil9PC90ZD4KICAgICAgICA8L3RyPgogICAgJHtbCiAgICAgICAgLi4uT2JqZWN0LmVudHJpZXModGFibGUubmFtZXNwYWNlVGFibGVzKQogICAgXS5zb3J0KChhLCBiKT0+KGJbMV0uZXN0aW1hdGVkMzBEYXlSb3c/LnRvdGFsQ29zdCB8fCAwKSAtIChhWzFdLmVzdGltYXRlZDMwRGF5Um93Py50b3RhbENvc3QgfHwgMCkKICAgICkubWFwKCh2KT0+ewogICAgICAgIGNvbnN0IFtuYW1lc3BhY2VJZCwgdF0gPSB2OwogICAgICAgIHJldHVybiBodG1sYDx0cj4KICAgICAgICAgICAgPHRkIGNsYXNzPSJsZWZ0LWFsaWduZWQgbW9ubyI+PGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT5jbGlja05hbWVzcGFjZShlLCByZW5kZXJDb3N0cykKICAgICAgICB9IGNsYXNzPSJ1bnNlbGVjdGVkIj4ke25hbWVzcGFjZUlkfTwvYT48L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImxlZnQtYWxpZ25lZCI+JHt0Lm5hbWVzcGFjZT8uc2NyaXB0IHx8ICcnfTwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0ibGVmdC1hbGlnbmVkIj4ke3QubmFtZXNwYWNlPy5jbGFzcyB8fCAnJ308L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7KHQuZXN0aW1hdGVkMzBEYXlSb3c/LnRvdGFsQ29zdCB8fCAwKS50b0ZpeGVkKDIpfTwvdGQ+CiAgICAgICAgICAgIDwvdHI+YDsKICAgIH0pfQogICAgPC90YWJsZT4KYAo7CmNvbnN0IENPU1RTX0hUTUwgPSAodGFibGUsIG5hbWVzcGFjZUlkKT0+aHRtbGAKICAgIDx0YWJsZT4KICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5VVEMgRGF5PC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPlJlcXVlc3RzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjQiPldlYnNvY2tldHM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+U3VicmVxdWVzdHM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+RHVyYXRpb248L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+UmVhZHM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+V3JpdGVzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPkRlbGV0ZXM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+U3RvcmFnZTwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aD5Ub3RhbDwvdGg+CiAgICAgICAgPC90cj4KICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoPk1heDwvdGg+CiAgICAgICAgICAgIDx0aD5JbjwvdGg+CiAgICAgICAgICAgIDx0aD5PdXQ8L3RoPgogICAgICAgICAgICA8dGg+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aD5HQi1zZWM8L3RoPgogICAgICAgICAgICA8dGg+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aD48L3RoPgogICAgICAgIDwvdHI+CiAgICAgICAgJHt0YWJsZS5yb3dzLm1hcCgodik9Pmh0bWxgPHRyPgogICAgICAgICAgICA8dGQ+JHt2LmRhdGV9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVJlcXVlc3RzKX08L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2Lm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zKX08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50KX08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi53ZWJzb2NrZXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVN1YnJlcXVlc3RzKX08L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LnN1YnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0Mih2LmFjdGl2ZUdiU2Vjb25kcyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5hY3RpdmVDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtU3RvcmFnZVJlYWRVbml0cyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5yZWFkVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtU3RvcmFnZVdyaXRlVW5pdHMpfTwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYud3JpdGVVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke2Zvcm1hdDEodi5zdW1TdG9yYWdlRGVsZXRlcyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5kZWxldGVzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7di5zdG9yYWdlR2IgPT09IHVuZGVmaW5lZCA/ICc/JyA6IGZvcm1hdEdiKHYuc3RvcmFnZUdiKX08L3RkPgogICAgICAgICAgICA8dGQ+JHt2LnN0b3JhZ2VDb3N0ID09PSB1bmRlZmluZWQgPyAnJyA6IGAkJHtmb3JtYXQyKHYuc3RvcmFnZUNvc3QpfWB9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi50b3RhbENvc3QpfTwvdGQ+CiAgICAgICAgPC90cj5gCiAgICApfQoKICAgICAgICAke3RhYmxlLmVzdGltYXRlZDMwRGF5Um93ID8gaHRtbGA8dHIgY2xhc3M9ImVzdGltYXRlIj4KICAgICAgICAgICAgPHRkPjMwLWRheSBiaWxsPHN1cD4qPC9zdXA+PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93LnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cud2Vic29ja2V0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy5zdWJyZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy5hY3RpdmVDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cucmVhZFVuaXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93LndyaXRlVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cuZGVsZXRlc0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy5zdG9yYWdlQ29zdCB8fCAwKX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy50b3RhbENvc3QpfTwvdGQ+CiAgICAgICAgPC90cj5gIDogJyd9CiAgICAgICAgJHt0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZSA/IGh0bWxgPHRyPgogICAgICAgICAgICA8dGQ+4oiSIGZyZWUgdXNhZ2U8L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUucmVxdWVzdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS53ZWJzb2NrZXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLnN1YnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLmFjdGl2ZUNvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS5yZWFkVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUud3JpdGVVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS5kZWxldGVzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLnN0b3JhZ2VDb3N0IHx8IDApfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLnRvdGFsQ29zdCl9PC90ZD4KICAgICAgICA8L3RyPmAgOiAnJ30KICAgIDwvdGFibGU+CmAKOwpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKCm1haW4gewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41cmVtOwp9Cgo6cm9vdCB7CiAgICAtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2I6IHJnYigxODcsIDEzNCwgMjUyKTsKfQoKLmhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwgewogICAgc2Nyb2xsYmFyLXdpZHRoOiBub25lOyAtbXMtb3ZlcmZsb3ctc3R5bGU6IG5vbmU7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7Cn0KCi5oaWRkZW4tdmVydGljYWwtc2Nyb2xsOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICBkaXNwbGF5OiBub25lOyAvKiBmb3IgQ2hyb21lLCBTYWZhcmksIGFuZCBPcGVyYSAqLwp9CgpgOwpjb25zdCBhcHBIdG1sID0gaHRtbGAKPG1haW4+CiR7U0lERUJBUl9IVE1MfQoke0NPTlNPTEVfSFRNTH0KJHtBTkFMWVRJQ1NfSFRNTDF9CiR7TU9EQUxfSFRNTH0KPC9tYWluPmA7CmZ1bmN0aW9uIGFwcGVuZFN0eWxlc2hlZXRzKGNzc1RleHRzKSB7CiAgICBjb25zdCBzdHlsZVNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgIHN0eWxlU2hlZXQudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgICBzdHlsZVNoZWV0LnRleHRDb250ZW50ID0gY3NzVGV4dHMuam9pbignXG5cbicpOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZVNoZWV0KTsKfQphcHBlbmRTdHlsZXNoZWV0cyhbCiAgICBNQVRFUklBTF9DU1MuY3NzVGV4dCwKICAgIGFwcENzcy5jc3NUZXh0LAogICAgSEVBREVSX0NTUy5jc3NUZXh0LAogICAgU0lERUJBUl9DU1MuY3NzVGV4dCwKICAgIENPTlNPTEVfQ1NTLmNzc1RleHQsCiAgICBBTkFMWVRJQ1NfQ1NTLmNzc1RleHQsCiAgICBNT0RBTF9DU1MuY3NzVGV4dCwKICAgIFdFTENPTUVfUEFORUxfQ1NTLmNzc1RleHQsCiAgICBQUk9GSUxFX0VESVRPUl9DU1MuY3NzVGV4dCwKICAgIEZJTFRFUl9FRElUT1JfQ1NTLmNzc1RleHQsCiAgICBDSVJDVUxBUl9QUk9HUkVTU19DU1MuY3NzVGV4dCwgCl0pOwpMaXRFbGVtZW50LnJlbmRlcihhcHBIdG1sLCBkb2N1bWVudC5ib2R5KTsKZnVuY3Rpb24gcGFyc2VTdGF0aWNEYXRhKCkgewogICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRpYy1kYXRhLXNjcmlwdCcpOwogICAgY29uc3QgZGF0YTEgPSBKU09OLnBhcnNlKHNjcmlwdC50ZXh0KTsKICAgIGNvbnN0IHZlcnNpb24gPSB0eXBlb2YgZGF0YTEudmVyc2lvbiA9PT0gJ3N0cmluZycgPyBkYXRhMS52ZXJzaW9uIDogdW5kZWZpbmVkOwogICAgY29uc3QgZmxhZ3MgPSB0eXBlb2YgZGF0YTEuZmxhZ3MgPT09ICdzdHJpbmcnID8gZGF0YTEuZmxhZ3MgOiB1bmRlZmluZWQ7CiAgICByZXR1cm4gewogICAgICAgIHZlcnNpb24sCiAgICAgICAgZmxhZ3MKICAgIH07Cn0KY29uc3QgZGF0YSA9IHBhcnNlU3RhdGljRGF0YSgpOwpjb25zdCB2bSA9IG5ldyBXZWJ0YWlsQXBwVk0oKTsKY29uc3QgdXBkYXRlU2lkZWJhciA9IGluaXRTaWRlYmFyKGRvY3VtZW50LCB2bSwgZGF0YSk7CmNvbnN0IHVwZGF0ZUNvbnNvbGUgPSBpbml0Q29uc29sZShkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVBbmFseXRpY3MgPSBpbml0QW5hbHl0aWNzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZU1vZGFsID0gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSk7CnZtLm9uQ2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZVNpZGViYXIoKTsKICAgIHVwZGF0ZUNvbnNvbGUoKTsKICAgIHVwZGF0ZUFuYWx5dGljcygpOwogICAgdXBkYXRlTW9kYWwoKTsKfTsKQ2xvdWRmbGFyZUFwaS5VUkxfVFJBTlNGT1JNRVIgPSBDZkdxbENsaWVudC5VUkxfVFJBTlNGT1JNRVIgPSAodik9PmAvZmV0Y2gvJHt2LnN1YnN0cmluZygnaHR0cHM6Ly8nLmxlbmd0aCl9YAo7CnZtLnN0YXJ0KCk7CnNldEFwcFN0YXRlKCdzdGFydGVkJyk7Cg==';