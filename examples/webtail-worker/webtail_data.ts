

export const WEBTAIL_APP_HASH = 'f777a57267003451c9543c2e2d878715b838ef83';
export const WEBTAIL_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7Cn07CmNvbnN0IG5vdGhpbmcgPSB7Cn07CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50Q29udGV4dCl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICAgICAgdGhpcy5ldmVudENvbnRleHQgPSBldmVudENvbnRleHQ7CiAgICAgICAgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQgPSAoZSk9PnRoaXMuaGFuZGxlRXZlbnQoZSkKICAgICAgICA7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBjb25zdCBvbGRMaXN0ZW5lciA9IHRoaXMudmFsdWU7CiAgICAgICAgY29uc3Qgc2hvdWxkUmVtb3ZlTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciA9PSBudWxsIHx8IG9sZExpc3RlbmVyICE9IG51bGwgJiYgKG5ld0xpc3RlbmVyLmNhcHR1cmUgIT09IG9sZExpc3RlbmVyLmNhcHR1cmUgfHwgbmV3TGlzdGVuZXIub25jZSAhPT0gb2xkTGlzdGVuZXIub25jZSB8fCBuZXdMaXN0ZW5lci5wYXNzaXZlICE9PSBvbGRMaXN0ZW5lci5wYXNzaXZlKTsKICAgICAgICBjb25zdCBzaG91bGRBZGRMaXN0ZW5lciA9IG5ld0xpc3RlbmVyICE9IG51bGwgJiYgKG9sZExpc3RlbmVyID09IG51bGwgfHwgc2hvdWxkUmVtb3ZlTGlzdGVuZXIpOwogICAgICAgIGlmIChzaG91bGRSZW1vdmVMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZEFkZExpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX19vcHRpb25zID0gZ2V0T3B0aW9ucyhuZXdMaXN0ZW5lcik7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gbmV3TGlzdGVuZXI7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgfQogICAgaGFuZGxlRXZlbnQoZXZlbnQpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMudmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5jYWxsKHRoaXMuZXZlbnRDb250ZXh0IHx8IHRoaXMuZWxlbWVudCwgZXZlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuaGFuZGxlRXZlbnQoZXZlbnQpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBnZXRPcHRpb25zID0gKG8pPT5vICYmIChldmVudE9wdGlvbnNTdXBwb3J0ZWQgPyB7CiAgICAgICAgY2FwdHVyZTogby5jYXB0dXJlLAogICAgICAgIHBhc3NpdmU6IG8ucGFzc2l2ZSwKICAgICAgICBvbmNlOiBvLm9uY2UKICAgIH0gOiBvLmNhcHR1cmUpCjsKY2xhc3MgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yIHsKICAgIGhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBwcmVmaXggPSBuYW1lWzBdOwogICAgICAgIGlmIChwcmVmaXggPT09ICIuIikgewogICAgICAgICAgICBjb25zdCBjb21taXR0ZXIyID0gbmV3IFByb3BlcnR5Q29tbWl0dGVyKGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpOwogICAgICAgICAgICByZXR1cm4gY29tbWl0dGVyMi5wYXJ0czsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIkAiKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgRXZlbnRQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIG9wdGlvbnMuZXZlbnRDb250ZXh0KQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiPyIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBCb29sZWFuQXR0cmlidXRlUGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21taXR0ZXIgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIucGFydHM7CiAgICB9CiAgICBoYW5kbGVUZXh0RXhwcmVzc2lvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBOb2RlUGFydChvcHRpb25zKTsKICAgIH0KfQpjb25zdCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgPSBuZXcgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKCk7CmZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShyZXN1bHQpIHsKICAgIGxldCB0ZW1wbGF0ZUNhY2hlID0gdGVtcGxhdGVDYWNoZXMuZ2V0KHJlc3VsdC50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0LnR5cGUsIHRlbXBsYXRlQ2FjaGUpOwogICAgfQogICAgbGV0IHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuZ2V0KHJlc3VsdC5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfQogICAgY29uc3Qga2V5ID0gcmVzdWx0LnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5nZXQoa2V5KTsKICAgIGlmICh0ZW1wbGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUocmVzdWx0LCByZXN1bHQuZ2V0VGVtcGxhdGVFbGVtZW50KCkpOwogICAgICAgIHRlbXBsYXRlQ2FjaGUua2V5U3RyaW5nLnNldChrZXksIHRlbXBsYXRlKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQuc3RyaW5ncywgdGVtcGxhdGUpOwogICAgcmV0dXJuIHRlbXBsYXRlOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQsIGNvbnRhaW5lciwgb3B0aW9ucyk9PnsKICAgIGxldCBwYXJ0ID0gcGFydHMuZ2V0KGNvbnRhaW5lcik7CiAgICBpZiAocGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZXMoY29udGFpbmVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgcGFydHMuc2V0KGNvbnRhaW5lciwgcGFydCA9IG5ldyBOb2RlUGFydChPYmplY3QuYXNzaWduKHsKICAgICAgICAgICAgdGVtcGxhdGVGYWN0b3J5CiAgICAgICAgfSwgb3B0aW9ucykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0KTsKICAgIHBhcnQuY29tbWl0KCk7Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogICAgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjEuNC4xIik7Cn0KY29uc3QgaHRtbCA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5ncywgdmFsdWVzLCAiaHRtbCIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwpjb25zdCBzdmcgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFNWR1RlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcyksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHNbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyIHx8IGRlZmF1bHRDb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgZnJvbUF0dHJpYnV0ZSA9IHR5cGVvZiBjb252ZXJ0ZXIgPT09ICJmdW5jdGlvbiIgPyBjb252ZXJ0ZXIgOiBjb252ZXJ0ZXIuZnJvbUF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gZnJvbUF0dHJpYnV0ZSA/IGZyb21BdHRyaWJ1dGUodmFsdWUsIHR5cGUpIDogdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlKTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKT0+dGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHJlcwogICAgICAgICk7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fc2F2ZUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKCk7CiAgICB9CiAgICBfc2F2ZUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgoX3YsIHApPT57CiAgICAgICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNbcF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1twXTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLnNldChwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9hcHBseUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnRoaXNbcF0gPSB2CiAgICAgICAgKTsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSB2b2lkIDA7CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICB0aGlzLmVuYWJsZVVwZGF0aW5nKCk7CiAgICB9CiAgICBlbmFibGVVcGRhdGluZygpIHsKICAgICAgICBpZiAodGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIoKTsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHZvaWQgMDsKICAgICAgICB9CiAgICB9CiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgIH0KICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG9sZCAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX3Byb3BlcnR5VG9BdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IGF0dHIgPSBjdG9yLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBhdHRyVmFsdWUgPSBjdG9yLl9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgfQogICAgfQogICAgX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHByb3BOYW1lID0gY3Rvci5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5nZXQobmFtZSk7CiAgICAgICAgaWYgKHByb3BOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKHByb3BOYW1lKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgICAgIHRoaXNbcHJvcE5hbWVdID0gY3Rvci5fcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtVXBkYXRlKCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIGF3YWl0IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgRWxlbWVudFByb3RvID0gRWxlbWVudC5wcm90b3R5cGU7CkVsZW1lbnRQcm90by5tc01hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50UHJvdG8ud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwpjb25zdCBzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMgPSB3aW5kb3cuU2hhZG93Um9vdCAmJiAod2luZG93LlNoYWR5Q1NTID09PSB2b2lkIDAgfHwgd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgJiYgImFkb3B0ZWRTdHlsZVNoZWV0cyIgaW4gRG9jdW1lbnQucHJvdG90eXBlICYmICJyZXBsYWNlIiBpbiBDU1NTdHlsZVNoZWV0LnByb3RvdHlwZTsKY29uc3QgY29uc3RydWN0aW9uVG9rZW4gPSBTeW1ib2woKTsKY2xhc3MgQ1NTUmVzdWx0IHsKICAgIGNvbnN0cnVjdG9yKGNzc1RleHQsIHNhZmVUb2tlbil7CiAgICAgICAgaWYgKHNhZmVUb2tlbiAhPT0gY29uc3RydWN0aW9uVG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDU1NSZXN1bHQgaXMgbm90IGNvbnN0cnVjdGFibGUuIFVzZSBgdW5zYWZlQ1NTYCBvciBgY3NzYCBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgfQogICAgZ2V0IHN0eWxlU2hlZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0eWxlU2hlZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbmV3IENTU1N0eWxlU2hlZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQucmVwbGFjZVN5bmModGhpcy5jc3NUZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3NzVGV4dDsKICAgIH0KfQpjb25zdCB1bnNhZmVDU1MgPSAodmFsdWUpPT57CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChTdHJpbmcodmFsdWUpLCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07CmNvbnN0IHRleHRGcm9tQ1NTUmVzdWx0ID0gKHZhbHVlKT0+ewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ1NTUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLmNzc1RleHQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsdWUgcGFzc2VkIHRvICdjc3MnIGZ1bmN0aW9uIG11c3QgYmUgYSAnY3NzJyBmdW5jdGlvbiByZXN1bHQ6ICR7dmFsdWV9LiBVc2UgJ3Vuc2FmZUNTUycgdG8gcGFzcyBub24tbGl0ZXJhbCB2YWx1ZXMsIGJ1dAogICAgICAgICAgICB0YWtlIGNhcmUgdG8gZW5zdXJlIHBhZ2Ugc2VjdXJpdHkuYCk7CiAgICB9Cn07CmNvbnN0IGNzcyA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT57CiAgICBjb25zdCBjc3NUZXh0ID0gdmFsdWVzLnJlZHVjZSgoYWNjLCB2LCBpZHgpPT5hY2MgKyB0ZXh0RnJvbUNTU1Jlc3VsdCh2KSArIHN0cmluZ3NbaWR4ICsgMV0KICAgICwgc3RyaW5nc1swXSk7CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChjc3NUZXh0LCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07Cih3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIyLjUuMSIpOwpjb25zdCByZW5kZXJOb3RJbXBsZW1lbnRlZCA9IHsKfTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKYXN5bmMgZnVuY3Rpb24gbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0c2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RTY3JpcHRzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdFRhaWxzKGFjY291bnRJZCwgc2NyaXB0TmFtZSwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpfS93b3JrZXJzL3NjcmlwdHMvJHtzY3JpcHROYW1lfS90YWlsc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RUYWlscycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnY3JlYXRlVGFpbCcsICdQT1NUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04JzsKY29uc3QgQVBQTElDQVRJT05fT0NURVRfU1RSRUFNID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmZ1bmN0aW9uIGNvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpIHsKICAgIHJldHVybiBDbG91ZGZsYXJlQXBpLlVSTF9UUkFOU0ZPUk1FUihgaHR0cHM6Ly9hcGkuY2xvdWRmbGFyZS5jb20vY2xpZW50L3Y0L2FjY291bnRzLyR7YWNjb3VudElkfWApOwp9CmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUob3AsIG1ldGhvZCwgdXJsLCBhcGlUb2tlbiwgYm9keSwgcmVzcG9uc2VUeXBlID0gJ2pzb24nKSB7CiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoewogICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaVRva2VufWAKICAgIH0pOwogICAgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykgewogICAgICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBBUFBMSUNBVElPTl9KU09OX1VURjgpOwogICAgICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhib2R5KTsKICAgIH0KICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZmV0Y2hSZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJykgfHwgJyc7CiAgICBpZiAoKHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzJyB8fCByZXNwb25zZVR5cGUgPT09ICdieXRlcz8nKSAmJiBjb250ZW50VHlwZSA9PT0gQVBQTElDQVRJT05fT0NURVRfU1RSRUFNKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4LAogICAgICAgIEFQUExJQ0FUSU9OX0pTT04KICAgIF0uaW5jbHVkZXMoY29udGVudFR5cGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRlbnQtdHlwZTogJHtjb250ZW50VHlwZX0sICBmZXRjaFJlc3BvbnNlPSR7ZmV0Y2hSZXNwb25zZX0sIGJvZHk9JHthd2FpdCBmZXRjaFJlc3BvbnNlLnRleHQoKX1gKTsKICAgIH0KICAgIGNvbnN0IGFwaVJlc3BvbnNlID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5qc29uKCk7CiAgICBpZiAoQ2xvdWRmbGFyZUFwaS5ERUJVRykgY29uc29sZS5sb2coYXBpUmVzcG9uc2UpOwogICAgaWYgKCFhcGlSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgaWYgKGZldGNoUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgJiYgcmVzcG9uc2VUeXBlID09PSAnYnl0ZXM/JykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB0aHJvdyBuZXcgQ2xvdWRmbGFyZUFwaUVycm9yKGAke29wfSBmYWlsZWQ6IHN0YXR1cz0ke2ZldGNoUmVzcG9uc2Uuc3RhdHVzfSwgZXJyb3JzPSR7YXBpUmVzcG9uc2UuZXJyb3JzLm1hcCgodik9PmAke3YuY29kZX0gJHt2Lm1lc3NhZ2V9YAogICAgICAgICkuam9pbignLCAnKX1gLCBmZXRjaFJlc3BvbnNlLnN0YXR1cywgYXBpUmVzcG9uc2UuZXJyb3JzKTsKICAgIH0KICAgIHJldHVybiBhcGlSZXNwb25zZTsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBzdGF0dXM7CiAgICBlcnJvcnM7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBzdGF0dXMsIGVycm9ycyl7CiAgICAgICAgc3VwZXIobWVzc2FnZSk7CiAgICAgICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgdGhpcy5lcnJvcnMgPSBlcnJvcnM7CiAgICB9Cn0KZnVuY3Rpb24gc2V0U3VidHJhY3QobGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldChsaHMpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIHJocyl7CiAgICAgICAgcnQuZGVsZXRlKGl0ZW0pOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldFVuaW9uKGxocywgcmhzKSB7CiAgICBjb25zdCBydCA9IG5ldyBTZXQobGhzKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiByaHMpewogICAgICAgIHJ0LmFkZChpdGVtKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBzZXRJbnRlcnNlY3QobGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldCgpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIGxocyl7CiAgICAgICAgaWYgKHJocy5oYXMoaXRlbSkpIHJ0LmFkZChpdGVtKTsKICAgIH0KICAgIGZvciAoY29uc3QgaXRlbTEgb2YgcmhzKXsKICAgICAgICBpZiAobGhzLmhhcyhpdGVtMSkpIHJ0LmFkZChpdGVtMSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0RXF1YWwobGhzLCByaHMpIHsKICAgIHJldHVybiBsaHMuc2l6ZSA9PT0gcmhzLnNpemUgJiYgWwogICAgICAgIC4uLmxocwogICAgXS5ldmVyeSgodik9PnJocy5oYXModikKICAgICk7Cn0KZnVuY3Rpb24gcGFyc2VIZWFkZXJGaWx0ZXIoaGVhZGVyKSB7CiAgICBjb25zdCBpID0gaGVhZGVyLmluZGV4T2YoJzonKTsKICAgIGlmIChpIDwgMCkgcmV0dXJuIHsKICAgICAgICBrZXk6IGhlYWRlcgogICAgfTsKICAgIGNvbnN0IGtleSA9IGhlYWRlci5zdWJzdHJpbmcoMCwgaSkudHJpbSgpOwogICAgY29uc3QgcXVlcnkgPSBoZWFkZXIuc3Vic3RyaW5nKGkgKyAxKS50cmltKCk7CiAgICByZXR1cm4gewogICAgICAgIGtleSwKICAgICAgICBxdWVyeQogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyA9IG5ldyBTZXQoWwogICAgJ291dGNvbWUnLAogICAgJ3NjcmlwdE5hbWUnLAogICAgJ2V4Y2VwdGlvbnMnLAogICAgJ2xvZ3MnLAogICAgJ2V2ZW50VGltZXN0YW1wJywKICAgICdldmVudCcKXSk7CmNvbnN0IEtOT1dOX09VVENPTUVTID0gbmV3IFNldChbCiAgICAnb2snLAogICAgJ2V4Y2VwdGlvbicsCiAgICAnZXhjZWVkZWRDcHUnLAogICAgJ2NhbmNlbGVkJywKICAgICd1bmtub3duJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZShvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZTogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgb3V0Y29tZSAsIHNjcmlwdE5hbWUgLCBldmVudFRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCFLTk9XTl9PVVRDT01FUy5oYXMob3V0Y29tZSkpIHRocm93IG5ldyBFcnJvcihgQmFkIG91dGNvbWU6IGV4cGVjdGVkIG9uZSBvZiBbJHtbCiAgICAgICAgLi4uS05PV05fT1VUQ09NRVMKICAgIF0uam9pbignLCAnKX1dLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG91dGNvbWUpfWApOwogICAgaWYgKHNjcmlwdE5hbWUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjcmlwdE5hbWU6IGV4cGVjdGVkIG51bGwsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoc2NyaXB0TmFtZSl9YCk7CiAgICBjb25zdCBsb2dzID0gcGFyc2VMb2dzKG9iakFzQW55LmxvZ3MpOwogICAgY29uc3QgZXhjZXB0aW9ucyA9IHBhcnNlRXhjZXB0aW9ucyhvYmpBc0FueS5leGNlcHRpb25zKTsKICAgIGlmICghKHR5cGVvZiBldmVudFRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgZXZlbnRUaW1lc3RhbXAgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgZXZlbnRUaW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShldmVudFRpbWVzdGFtcCl9YCk7CiAgICBjb25zdCBldmVudCA9IG9iakFzQW55LmV2ZW50ICYmIG9iakFzQW55LmV2ZW50LnJlcXVlc3QgPyBwYXJzZVRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50KG9iakFzQW55LmV2ZW50KSA6IHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqQXNBbnkuZXZlbnQpOwogICAgcmV0dXJuIHsKICAgICAgICBvdXRjb21lLAogICAgICAgIHNjcmlwdE5hbWUsCiAgICAgICAgZXhjZXB0aW9ucywKICAgICAgICBsb2dzLAogICAgICAgIGV2ZW50VGltZXN0YW1wLAogICAgICAgIGV2ZW50CiAgICB9Owp9CmZ1bmN0aW9uIHBhcnNlTG9ncyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBsb2dzOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VMb2cpOwp9CmZ1bmN0aW9uIHBhcnNlRXhjZXB0aW9ucyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBleGNlcHRpb25zOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VFeGNlcHRpb24pOwp9CmZ1bmN0aW9uIGlzTG9nTWVzc2FnZVBhcnQodmFsdWUpIHsKICAgIGNvbnN0IHQgPSB0eXBlb2YgdmFsdWU7CiAgICByZXR1cm4gdCA9PT0gJ3N0cmluZycgfHwgdCA9PT0gJ251bWJlcicgfHwgdCA9PT0gJ2Jvb2xlYW4nIHx8IHQgPT09ICd1bmRlZmluZWQnIHx8IHQgPT09ICdvYmplY3QnOwp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyA9IG5ldyBTZXQoWwogICAgJ21lc3NhZ2UnLAogICAgJ2xldmVsJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlTG9nKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlTG9nOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IG1lc3NhZ2UgPSBwYXJzZUxvZ01lc3NhZ2VQYXJ0QXJyYXkob2JqQXNBbnkubWVzc2FnZSwgJ21lc3NhZ2UnKTsKICAgIGNvbnN0IHsgbGV2ZWwgLCB0aW1lc3RhbXAgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBsZXZlbCA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBsZXZlbDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KGxldmVsKX1gKTsKICAgIGlmICghKHR5cGVvZiB0aW1lc3RhbXAgPT09ICdudW1iZXInICYmIHRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0aW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh0aW1lc3RhbXApfWApOwogICAgcmV0dXJuIHsKICAgICAgICBtZXNzYWdlLAogICAgICAgIGxldmVsLAogICAgICAgIHRpbWVzdGFtcAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVhDRVBUSU9OX0tFWVMgPSBuZXcgU2V0KFsKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlRXhjZXB0aW9uKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlRXhjZXB0aW9uOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FWENFUFRJT05fS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgbmFtZSAsIG1lc3NhZ2UgLCB0aW1lc3RhbXAgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG5hbWU6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShuYW1lKX1gKTsKICAgIGlmICghKHR5cGVvZiBtZXNzYWdlID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG1lc3NhZ2U6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShtZXNzYWdlKX1gKTsKICAgIGlmICghKHR5cGVvZiB0aW1lc3RhbXAgPT09ICdudW1iZXInICYmIHRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0aW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh0aW1lc3RhbXApfWApOwogICAgcmV0dXJuIHsKICAgICAgICBuYW1lLAogICAgICAgIG1lc3NhZ2UsCiAgICAgICAgdGltZXN0YW1wCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMgPSBuZXcgU2V0KFsKICAgICdjcm9uJywKICAgICdzY2hlZHVsZWRUaW1lJwpdKTsKZnVuY3Rpb24gaXNUYWlsTWVzc2FnZUNyb25FdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBrZXlzID0gbmV3IFNldChPYmplY3Qua2V5cyhvYmopKTsKICAgIHJldHVybiBzZXRFcXVhbChrZXlzLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfQ1JPTl9FVkVOVF9LRVlTKTsKfQpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlQ3JvbkV2ZW50OiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCB7IGNyb24gLCBzY2hlZHVsZWRUaW1lICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgY3JvbiA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBjcm9uOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoY3Jvbil9YCk7CiAgICBpZiAoISh0eXBlb2Ygc2NoZWR1bGVkVGltZSA9PT0gJ251bWJlcicgJiYgc2NoZWR1bGVkVGltZSA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBzY2hlZHVsZWRUaW1lOiBleHBlY3RlZCBwb3NpdGl2ZSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoc2NoZWR1bGVkVGltZSl9YCk7CiAgICByZXR1cm4gewogICAgICAgIGNyb24sCiAgICAgICAgc2NoZWR1bGVkVGltZQogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTID0gbmV3IFNldChbCiAgICAncmVxdWVzdCcKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VSZXF1ZXN0RXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VSZXF1ZXN0RXZlbnQ6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX1JFUVVFU1RfRVZFTlRfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHJlcXVlc3QgPSBwYXJzZVRhaWxNZXNzYWdlRXZlbnRSZXF1ZXN0KG9iakFzQW55LnJlcXVlc3QpOwogICAgcmV0dXJuIHsKICAgICAgICByZXF1ZXN0CiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBuZXcgU2V0KFsKICAgICd1cmwnLAogICAgJ21ldGhvZCcsCiAgICAnaGVhZGVycycKXSk7CmNvbnN0IE9QVElPTkFMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBuZXcgU2V0KFsKICAgICdjZicKXSk7CmNvbnN0IEFMTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTID0gc2V0VW5pb24oUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUywgT1BUSU9OQUxfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VFdmVudFJlcXVlc3Qob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VFdmVudFJlcXVlc3Q6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUywgQUxMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCB7IHVybCAsIG1ldGhvZCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIHVybCA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB1cmw6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh1cmwpfWApOwogICAgaWYgKCEodHlwZW9mIG1ldGhvZCA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBtZXRob2Q6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShtZXRob2QpfWApOwogICAgY29uc3QgaGVhZGVycyA9IHBhcnNlU3RyaW5nUmVjb3JkKG9iakFzQW55LmhlYWRlcnMsICdoZWFkZXJzJyk7CiAgICBjb25zdCBjZiA9IG9iakFzQW55LmNmID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBwYXJzZUluY29taW5nUmVxdWVzdENmUHJvcGVydGllcyhvYmpBc0FueS5jZik7CiAgICByZXR1cm4gewogICAgICAgIHVybCwKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBjZgogICAgfTsKfQpmdW5jdGlvbiBjaGVja0tleXMob2JqLCByZXF1aXJlZEtleXMsIGFsbEtleXMpIHsKICAgIGNvbnN0IGtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKG9iaikpOwogICAgY29uc3QgbWlzc2luZ0tleXMgPSBzZXRTdWJ0cmFjdChyZXF1aXJlZEtleXMsIGtleXMpOwogICAgaWYgKG1pc3NpbmdLZXlzLnNpemUgPiAwKSB0aHJvdyBuZXcgRXJyb3IoYE1pc3Npbmcga2V5czogJHtbCiAgICAgICAgLi4ubWlzc2luZ0tleXMKICAgIF0uam9pbignLCAnKX1gKTsKICAgIGNvbnN0IGV4dHJhS2V5cyA9IHNldFN1YnRyYWN0KGtleXMsIGFsbEtleXMgfHwgcmVxdWlyZWRLZXlzKTsKICAgIGlmIChleHRyYUtleXMuc2l6ZSA+IDApIHRocm93IG5ldyBFcnJvcihgRXh0cmEga2V5czogJHtbCiAgICAgICAgLi4uZXh0cmFLZXlzCiAgICBdLmpvaW4oJywgJyl9YCk7Cn0KZnVuY3Rpb24gcGFyc2VTdHJpbmdSZWNvcmQob2JqLCBuYW1lKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogRXhwZWN0ZWQgc3RyaW5nIHJlY29yZCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgZm9yIChjb25zdCBbXywgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBzdHJpbmcgcmVjb3JkLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICB9CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIHBhcnNlTG9nTWVzc2FnZVBhcnRBcnJheShvYmosIG5hbWUpIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCAhQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBsb2cgbWVzc2FnZSBwYXJ0IGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIG9iail7CiAgICAgICAgaWYgKCFpc0xvZ01lc3NhZ2VQYXJ0KHZhbHVlKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogRXhwZWN0ZWQgbG9nIG1lc3NhZ2UgcGFydCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgfQogICAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBwYXJzZUluY29taW5nUmVxdWVzdENmUHJvcGVydGllcyhvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBjZjogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIGR1bXBNZXNzYWdlUHJldHR5KG1lc3NhZ2UsIGxvZ2dlciwgYWRkaXRpb25hbExvZ3MgPSBbXSkgewogICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUobWVzc2FnZS5ldmVudFRpbWVzdGFtcCkpOwogICAgY29uc3Qgb3V0Y29tZSA9IFBSRVRUWV9PVVRDT01FUy5nZXQobWVzc2FnZS5vdXRjb21lKSB8fCBtZXNzYWdlLm91dGNvbWU7CiAgICBjb25zdCBvdXRjb21lQ29sb3IgPSBtZXNzYWdlLm91dGNvbWUgPT09ICdvaycgPyAnZ3JlZW4nIDogJ3JlZCc7CiAgICBjb25zdCB7IHByb3BzICwgcmVtYWluaW5nTG9ncyAgfSA9IHBhcnNlTG9nUHJvcHMobWVzc2FnZS5sb2dzKTsKICAgIGlmIChpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UuZXZlbnQpKSB7CiAgICAgICAgY29uc3QgY29sbyA9IHByb3BzLmNvbG8gfHwgJz8/Pyc7CiAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSAlYyR7bWVzc2FnZS5ldmVudC5jcm9ufWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHsgbWV0aG9kICwgdXJsICwgY2YgIH0gPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3Q7CiAgICAgICAgY29uc3QgY29sbyA9IGNmPy5jb2xvIHx8IHByb3BzLmNvbG8gfHwgJz8/Pyc7CiAgICAgICAgaWYgKGNmID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29uc3QgeyBkdXJhYmxlT2JqZWN0Q2xhc3MgLCBkdXJhYmxlT2JqZWN0TmFtZSAsIGR1cmFibGVPYmplY3RJZCAgfSA9IGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcyk7CiAgICAgICAgICAgIGNvbnN0IGRvVGVtcGxhdGVzID0gW107CiAgICAgICAgICAgIGNvbnN0IGRvU3R5bGVzID0gW107CiAgICAgICAgICAgIGlmIChkdXJhYmxlT2JqZWN0Q2xhc3MpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0Q2xhc3N9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWNsYXNzOiAnJHtkdXJhYmxlT2JqZWN0Q2xhc3N9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0TmFtZX0lY2ApOwogICAgICAgICAgICAgICAgZG9TdHlsZXMucHVzaChgY29sb3I6IGdyYXk7IHgtZHVyYWJsZS1vYmplY3QtbmFtZTogJyR7ZHVyYWJsZU9iamVjdE5hbWV9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdElkKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlYyR7Y29tcHV0ZVNob3J0RHVyYWJsZU9iamVjdElkKGR1cmFibGVPYmplY3RJZCl9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWlkOiAnJHtkdXJhYmxlT2JqZWN0SWR9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZG9UZW1wbGF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlY0RPJWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goJ2NvbG9yOiBncmF5JywgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gWyR7ZG9UZW1wbGF0ZXMuam9pbignICcpfV0gJHttZXRob2R9ICVjJHt1cmx9YCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6ICR7b3V0Y29tZUNvbG9yfWAsICcnLCAuLi5kb1N0eWxlcywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSAke21ldGhvZH0gJWMke3VybH1gLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtvdXRjb21lQ29sb3J9YCwgJycsICdjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkOycpOwogICAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgeyBkYXRhICB9IG9mIGFkZGl0aW9uYWxMb2dzKXsKICAgICAgICBsb2dnZXIoLi4uZGF0YSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsgbGV2ZWwgLCBtZXNzYWdlOiBsb2dNZXNzYWdlICB9IG9mIHJlbWFpbmluZ0xvZ3MpewogICAgICAgIGNvbnN0IGxldmVsQ29sb3IgPSBMT0dfTEVWRUxfQ09MT1JTLmdldChsZXZlbCkgfHwgJ2dyYXknOwogICAgICAgIGNvbnN0IGxvZ01lc3NhZ2VzID0gbG9nTWVzc2FnZS5tYXAoZm9ybWF0TG9nTWVzc2FnZVBhcnQpLmpvaW4oJywgJyk7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtsZXZlbH0lY10gJHtsb2dNZXNzYWdlc31gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke2xldmVsQ29sb3J9YCwgJycpOwogICAgfQogICAgZm9yIChjb25zdCB7IG5hbWUgLCBtZXNzYWdlOiBleGNlcHRpb25NZXNzYWdlICB9IG9mIG1lc3NhZ2UuZXhjZXB0aW9ucyl7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtuYW1lfSVjXSAlYyR7ZXhjZXB0aW9uTWVzc2FnZX1gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGRgLCAnJywgJ2NvbG9yOiByZWQnKTsKICAgIH0KfQpmdW5jdGlvbiBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKGRhdGUpIHsKICAgIHJldHVybiBbCiAgICAgICAgZGF0ZS5nZXRGdWxsWWVhcigpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0TW9udGgoKSArIDEpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0RGF0ZSgpKSwKICAgICAgICAnICcsCiAgICAgICAgcGFkMihkYXRlLmdldEhvdXJzKCkpLAogICAgICAgICc6JywKICAgICAgICBwYWQyKGRhdGUuZ2V0TWludXRlcygpKSwKICAgICAgICAnOicsCiAgICAgICAgcGFkMihkYXRlLmdldFNlY29uZHMoKSkKICAgIF0uam9pbignJyk7Cn0KZnVuY3Rpb24gcGFyc2VMb2dQcm9wcyhsb2dzKSB7CiAgICBjb25zdCByZW1haW5pbmdMb2dzID0gW107CiAgICBjb25zdCBwcm9wcyA9IHsKICAgIH07CiAgICBmb3IgKGNvbnN0IGxvZyBvZiBsb2dzKXsKICAgICAgICBpZiAobG9nLm1lc3NhZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBtc2cgPSBsb2cubWVzc2FnZVswXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnICYmIG1zZy5zdGFydHNXaXRoKCdsb2dwcm9wczonKSkgewogICAgICAgICAgICAgICAgY29uc3QgdHJhaWxlciA9IG1zZy5zdWJzdHJpbmcobXNnLmluZGV4T2YoJzonKSArIDEpOwogICAgICAgICAgICAgICAgY29uc3QgdHJhaWxlclByb3BzID0gdHJ5UGFyc2VQcm9wc0Zyb21Kc29uKHRyYWlsZXIpOwogICAgICAgICAgICAgICAgYXBwZW5kUHJvcHModHJhaWxlclByb3BzLCBwcm9wcyk7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgbG9nLm1lc3NhZ2Uuc2xpY2UoMSkpewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRQcm9wcyA9IHRyeVBhcnNlUHJvcHNGcm9tUGFydChwYXJ0KTsKICAgICAgICAgICAgICAgICAgICBhcHBlbmRQcm9wcyhwYXJ0UHJvcHMsIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlbWFpbmluZ0xvZ3MucHVzaChsb2cpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBwcm9wcywKICAgICAgICByZW1haW5pbmdMb2dzCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcykgewogICAgY29uc3QgZHVyYWJsZU9iamVjdENsYXNzID0gdW5kZWZpbmVkSWZFbXB0eSgodHlwZW9mIHByb3BzLmR1cmFibGVPYmplY3RDbGFzcyA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0Q2xhc3MgOiAnJykudHJpbSgpKTsKICAgIGNvbnN0IGR1cmFibGVPYmplY3RJZCA9IHVuZGVmaW5lZElmRW1wdHkoKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0SWQgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdElkIDogJycpLnRyaW0oKSk7CiAgICBjb25zdCBkdXJhYmxlT2JqZWN0TmFtZSA9IHVuZGVmaW5lZElmRW1wdHkoKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA6ICcnKS50cmltKCkpOwogICAgcmV0dXJuIHsKICAgICAgICBkdXJhYmxlT2JqZWN0Q2xhc3MsCiAgICAgICAgZHVyYWJsZU9iamVjdElkLAogICAgICAgIGR1cmFibGVPYmplY3ROYW1lCiAgICB9Owp9CmZ1bmN0aW9uIHVuZGVmaW5lZElmRW1wdHkoc3RyKSB7CiAgICByZXR1cm4gc3RyID09PSAnJyA/IHVuZGVmaW5lZCA6IHN0cjsKfQpmdW5jdGlvbiBjb21wdXRlU2hvcnREdXJhYmxlT2JqZWN0SWQoaWQpIHsKICAgIHJldHVybiAvXlswLTlhLWZBLUZdezUsfSQvLnRlc3QoaWQpID8gYCR7aWQuc3Vic3RyaW5nKDAsIDQpfeKApmAgOiBpZDsKfQpmdW5jdGlvbiBhcHBlbmRQcm9wcyhzcmMsIGRzdCkgewogICAgaWYgKHNyYykgewogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNyYykpewogICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiB0cnlQYXJzZVByb3BzRnJvbUpzb24odmFsdWUpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgcHJvcHMgPSBKU09OLnBhcnNlKHZhbHVlLnRyaW0oKSk7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wcyA9PT0gJ29iamVjdCcgJiYgcHJvcHMgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wczsKICAgICAgICB9CiAgICB9IGNhdGNoICB7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHRyeVBhcnNlUHJvcHNGcm9tUGFydChwYXJ0KSB7CiAgICB0cnkgewogICAgICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcgJiYgcGFydCAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheShwYXJ0KSkgewogICAgICAgICAgICByZXR1cm4gcGFydDsKICAgICAgICB9CiAgICB9IGNhdGNoICB7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGZvcm1hdExvZ01lc3NhZ2VQYXJ0KHBhcnQpIHsKICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcpIHJldHVybiBKU09OLnN0cmluZ2lmeShwYXJ0KTsKICAgIHJldHVybiBgJHtwYXJ0fWA7Cn0KZnVuY3Rpb24gcGFkMihudW0pIHsKICAgIHJldHVybiBudW0udG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpOwp9CmNvbnN0IFBSRVRUWV9PVVRDT01FUyA9IG5ldyBNYXAoWwogICAgWwogICAgICAgICdvaycsCiAgICAgICAgJ09rJwogICAgXSwKICAgIFsKICAgICAgICAnZXhjZXB0aW9uJywKICAgICAgICAnRXJyb3InCiAgICBdLAogICAgWwogICAgICAgICdleGNlZWRlZENwdScsCiAgICAgICAgJ0V4Y2VlZGVkIExpbWl0JwogICAgXSwKICAgIFsKICAgICAgICAnY2FuY2VsZWQnLAogICAgICAgICdDYW5jZWxlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ3Vua25vd24nLAogICAgICAgICdVbmtub3duJwogICAgXSwgCl0pOwpjb25zdCBMT0dfTEVWRUxfQ09MT1JTID0gbmV3IE1hcChbCiAgICBbCiAgICAgICAgJ3RyYWNlJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2RlYnVnJywKICAgICAgICAncHVycGxlJwogICAgXSwKICAgIFsKICAgICAgICAnbG9nJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2luZm8nLAogICAgICAgICdncmF5JwogICAgXSwKICAgIFsKICAgICAgICAnd2FybicsCiAgICAgICAgJ3JlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ2Vycm9yJywKICAgICAgICAncmVkJwogICAgXSwgCl0pOwpjbGFzcyBUYWlsQ29ubmVjdGlvbiB7CiAgICBzdGF0aWMgVkVSQk9TRSA9IGZhbHNlOwogICAgd3M7CiAgICBjYWxsYmFja3M7CiAgICBvcHRpb25zOwogICAgaGVhcnRiZWF0SWQ7CiAgICBjb25zdHJ1Y3Rvcih3ZWJTb2NrZXRVcmwsIGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQod2ViU29ja2V0VXJsLCAndHJhY2UtdjEnKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICBjb25zdCB7IHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgIH0gPSBvcHRzOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignb3BlbicsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgdGhpcy5zZW5kT3B0aW9uc0lmT3BlbigpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uT3BlbikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uT3Blbih0aGlzLCB0aW1lU3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzID4gMCkgewogICAgICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksIGBzZW5kaW5nIHdzIHBpbmcge30gZXZlcnkgJHt3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzfWApOwogICAgICAgICAgICAgICAgdGhpcy5oZWFydGJlYXRJZCA9IHNldEludGVydmFsKCgpPT57CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMud3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksIGBzZW5kaW5nIHdzIHBpbmcge31gKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53cy5zZW5kKCd7fScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgKiAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignY2xvc2UnLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgY29kZSAsIHJlYXNvbiAsIHdhc0NsZWFuICwgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpLCAnVGFpbENvbm5lY3Rpb246IHdzIGNsb3NlJywgewogICAgICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgIHdhc0NsZWFuLAogICAgICAgICAgICAgICAgdGltZVN0YW1wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0SWQpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uQ2xvc2UpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbkNsb3NlKHRoaXMsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICBjb25zdCBlcnJvckluZm8gPSBjb21wdXRlRXJyb3JJbmZvKGV2ZW50KTsKICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksICdUYWlsQ29ubmVjdGlvbjogd3MgZXJyb3InLCBlcnJvckluZm8pOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbkVycm9yKHRoaXMsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGFzeW5jIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEgaW5zdGFuY2VvZiBCbG9iKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgZXZlbnQuZGF0YS50ZXh0KCk7CiAgICAgICAgICAgICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKHRleHQpOwogICAgICAgICAgICAgICAgbGV0IG1lc3NhZ2U7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBwYXJzZVRhaWxNZXNzYWdlKG9iaik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVW5wYXJzZWRNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgb2JqLCBlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVW5wYXJzZWRNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgZXZlbnQuZGF0YSwgbmV3IEVycm9yKGBFeHBlY3RlZCBldmVudC5kYXRhIHRvIGJlIEJsb2JgKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIHNldE9wdGlvbnMob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgdGhpcy5zZW5kT3B0aW9uc0lmT3BlbigpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2xvc2UoY29kZSwgcmVhc29uKSB7CiAgICAgICAgdGhpcy53cy5jbG9zZShjb2RlLCByZWFzb24pOwogICAgfQogICAgc2VuZE9wdGlvbnNJZk9wZW4oKSB7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucyAmJiB0aGlzLndzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7CiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICBpZiAoVGFpbENvbm5lY3Rpb24uVkVSQk9TRSkgY29uc29sZS5sb2coYHNlbmRPcHRpb25zSWZPcGVuOiBzZW5kaW5nICR7cGF5bG9hZH1gKTsKICAgICAgICAgICAgdGhpcy53cy5zZW5kKHBheWxvYWQpOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlRXJyb3JJbmZvKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ2Vycm9yJykgewogICAgICAgIGNvbnN0IHsgbWVzc2FnZSAsIGZpbGVuYW1lICwgbGluZW5vICwgY29sbm8gLCBlcnJvciAgfSA9IGV2ZW50OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgIGZpbGVuYW1lLAogICAgICAgICAgICBsaW5lbm8sCiAgICAgICAgICAgIGNvbG5vLAogICAgICAgICAgICBlcnJvcgogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGdlbmVyYXRlVXVpZCgpIHsKICAgIGNvbnN0IGNyeXB0b0FzQW55ID0gY3J5cHRvOwogICAgaWYgKHR5cGVvZiBjcnlwdG9Bc0FueS5yYW5kb21VVUlEID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGNyeXB0b0FzQW55LnJhbmRvbVVVSUQoKTsKICAgIH0KICAgIGNvbnN0IHJuZHMgPSBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKG5ldyBVaW50OEFycmF5KDE2KSk7CiAgICBybmRzWzZdID0gcm5kc1s2XSAmIDE1IHwgNjQ7CiAgICBybmRzWzhdID0gcm5kc1s4XSAmIDYzIHwgMTI4OwogICAgcmV0dXJuIGJ5dGVzVG9VdWlkKHJuZHMpOwp9CmZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ5dGVzKSB7CiAgICBjb25zdCBiaXRzID0gWwogICAgICAgIC4uLmJ5dGVzCiAgICBdLm1hcCgoYml0KT0+ewogICAgICAgIGNvbnN0IHMgPSBiaXQudG9TdHJpbmcoMTYpOwogICAgICAgIHJldHVybiBiaXQgPCAxNiA/ICIwIiArIHMgOiBzOwogICAgfSk7CiAgICByZXR1cm4gWwogICAgICAgIC4uLmJpdHMuc2xpY2UoMCwgNCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoNCwgNiksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoNiwgOCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoOCwgMTApLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDEwLCAxNiksIAogICAgXS5qb2luKCIiKTsKfQpjbGFzcyBNYXRlcmlhbCB7CiAgICBzdGF0aWMgaGlnaEVtcGhhc2lzVGV4dENvbG9yID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC44NyknOwogICAgc3RhdGljIG1lZGl1bUVtcGhhc2lzVGV4dENvbG9yID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCknOwp9CmNvbnN0IE1BVEVSSUFMX0NTUyA9IGNzc2AKCjpyb290IHsKICAtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcjogcmdiKDMwLjc1LCAzMC43NSwgMzAuNzUpOwogIC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yOiByZ2IoNDAuOTUsIDQwLjk1LCA0MC45NSk7CiAgLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC44Nyk7CiAgLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKTsKICAtLWRpc2FibGVkLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4zOCk7CiAgLS1idXR0b24tYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICAtLXByaW1hcnktY29sb3I6ICNiYjg2ZmM7CiAgLS1iYWNrZ3JvdW5kLWNvbG9yOiAjMTIxMjEyOwogIC0tc2Fucy1zZXJpZi1mb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCBhdmVuaXIgbmV4dCwgYXZlbmlyLCBoZWx2ZXRpY2EgbmV1ZSwgaGVsdmV0aWNhLCBVYnVudHUsIHJvYm90bywgbm90bywgc2Vnb2UgdWksIGFyaWFsLCBzYW5zLXNlcmlmOwogIC0tbW9ub3NwYWNlLWZvbnQtZmFtaWx5OiBNZW5sbywgQ29uc29sYXMsIHVpLW1vbm9zcGFjZSwgbW9ub3NwYWNlOwp9CgovKiogdGV4dCBzaXplIGNsYXNzZXMgKi8KCi5oNiB7CiAgICBmb250LXNpemU6IDEuMjVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMDc1MHJlbTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkZXI7Cn0KCi5ib2R5MiwgZmllbGRzZXQgbGFiZWwsIGZpZWxkc2V0IG91dHB1dCwgZmllbGRzZXQgZGV0YWlscyB7CiAgICBmb250LXNpemU6IDAuODc1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDE3ODZyZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwogICAgbGluZS1oZWlnaHQ6IDEuMjVyZW07Cn0KCi5idXR0b24sIGJ1dHRvbiwgLmFjdGlvbi1pY29uIHsKICAgIGZvbnQtc2l6ZTogMC44NzVyZW07CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDg5MjlyZW07CiAgICBmb250LXdlaWdodDogYm9sZGVyOwp9Cgoub3ZlcmxpbmUgewogICAgZm9udC1zaXplOiAwLjYyNXJlbTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMC4xNTAwMHJlbTsKICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7Cn0KCi5jYXB0aW9uIHsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjAzMzMzcmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKfQoKLyogbGlnaHQgdGV4dCBvbiBkYXJrIGJhY2tncm91bmQgY29sb3JzICovCgouaGlnaC1lbXBoYXNpcy10ZXh0IHsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgoubWVkaXVtLWVtcGhhc2lzLXRleHQsIGZpZWxkc2V0IGxhYmVsIHsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCi5kaXNhYmxlZC1lbXBoYXNpcy10ZXh0IHsKICAgIGNvbG9yOiB2YXIoLS1kaXNhYmxlZC10ZXh0LWNvbG9yKTsKfQoKLyoqIGVsZXZhdGlvbiBiYWNrZ3JvdW5kcyAqLwoKLnN1cmZhY2UtMDEgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKLnN1cmZhY2UtMDQgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKLyoqIGFjdGlvbi1pY29uICovCgouYWN0aW9uLWljb24gewogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIG1pbi1oZWlnaHQ6IDJyZW07CiAgICBtaW4td2lkdGg6IDJyZW07CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIG9wYWNpdHk6IDAuNjk7ICAvKiogbWVkaXVtLWVtcGhhc2lzIC8gaGlnaC1lbXBoYXNpcyAqLwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICAuYWN0aW9uLWljb246aG92ZXIgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICAgICAgb3BhY2l0eTogMTsKICAgIH0KfQoKLyoqIGJ1dHRvbiAqLwoKYnV0dG9uIHsKICAgIGJvcmRlcjogbm9uZTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcik7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKICAgIG1pbi13aWR0aDogOHJlbTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKfQoKYnV0dG9uLnNlbGVjdGVkIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKQG1lZGlhIChob3ZlcikgewogICAgYnV0dG9uOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwogICAgICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgfQp9CgpidXR0b246ZGlzYWJsZWQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgpAbWVkaWEgKGhvdmVyKSB7CiAgICBidXR0b246ZGlzYWJsZWQ6aG92ZXIgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcik7CiAgICAgICAgY3Vyc29yOiBkZWZhdWx0OwogICAgfQp9CgovKiogYW5jaG9ycyAqLwoKYSB7CiAgICBjb2xvcjogdmFyKC0tcHJpbWFyeS1jb2xvcik7CiAgICB0ZXh0LXVuZGVybGluZS1vZmZzZXQ6IDAuMnJlbTsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKfQoKQG1lZGlhIChob3ZlcjogaG92ZXIpIHsKICAgIGE6aG92ZXIgewogICAgICAgIHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOwogICAgfQp9CgovKiogZm9ybXMgKi8KCmZpZWxkc2V0IHsKICAgIGJvcmRlcjogc29saWQgMXB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCk7CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC1yb3ctZ2FwOiAxcmVtOwogICAgZ3JpZC1jb2x1bW4tZ2FwOiAxcmVtOwogICAgcGFkZGluZzogMXJlbTsKfQoKbGFiZWwgewogICAgZ3JpZC1jb2x1bW46IDE7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKfQoKLmZvcm0tbGhzIHsKICAgIGdyaWQtY29sdW1uOiAxOwp9CgppbnB1dCwgLmZvcm0tcmhzIHsKICAgIGdyaWQtY29sdW1uOiAyOwogICAgbWluLXdpZHRoOiAwOwp9CgouZm9ybS1yb3cgewogICAgZ3JpZC1jb2x1bW46IDEgLyBzcGFuIDI7Cn0KCmZpZWxkc2V0IGlucHV0W3R5cGU9dGV4dF0gewogICAgcGFkZGluZzogMC41cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgYm9yZGVyOiBzb2xpZCAxcHggdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpmaWVsZHNldCBvdXRwdXQgewogICAgcGFkZGluZzogMC41cmVtIDA7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpmaWVsZHNldCBkZXRhaWxzIHsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCmA7CmNvbnN0IEhFQURFUl9IVE1MID0gaHRtbGAKPGhlYWRlciBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0Ij4KICAgIDxkaXYgaWQ9ImhlYWRlci1jb250ZW50Ij4KICAgICAgICBXZWJ0YWlsCiAgICAgICAgPHNwYW4gaWQ9ImhlYWRlci12ZXJzaW9uIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvc3Bhbj4KICAgICAgICA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiIGlkPSJnaXRodWItbG9nby1hbmNob3IiPjxpbWcgaWQ9ImdpdGh1Yi1sb2dvIj48L2E+CiAgICA8L2Rpdj4KPC9oZWFkZXI+CmA7CmNvbnN0IEhFQURFUl9DU1MgPSBjc3NgCmhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMXJlbSAwOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCiNoZWFkZXItY29udGVudCB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGJhc2VsaW5lOwogICAgcGFkZGluZy1yaWdodDogMi4ycmVtOwp9CgojaGVhZGVyLXZlcnNpb24gewogICAgZmxleC1ncm93OiAxOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgojZ2l0aHViLWxvZ28tYW5jaG9yIHsKICAgIGxpbmUtaGVpZ2h0OiAwOwogICAgb3BhY2l0eTogMC41Owp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgI2dpdGh1Yi1sb2dvLWFuY2hvcjpob3ZlciB7CiAgICAgICAgb3BhY2l0eTogMC43NTsKICAgIH0KfQoKI2dpdGh1Yi1sb2dvIHsKICAgIHdpZHRoOiAxcmVtOwogICAgbWFyZ2luLWJvdHRvbTogLTAuMXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdEhlYWRlcihkb2N1bWVudCwgdm0sIGRhdGEpIHsKICAgIGNvbnN0IGhlYWRlckNvbnRlbnRFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlYWRlci1jb250ZW50Jyk7CiAgICBpZiAoKGRhdGEuZmxhZ3MgfHwgJycpLmluY2x1ZGVzKCdkZW1vLXRvZ2dsZScpKSB7CiAgICAgICAgaGVhZGVyQ29udGVudEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGJsY2xpY2snLCAoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2bS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgIH0pOwogICAgfQogICAgY29uc3QgaGVhZGVyVmVyc2lvblNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGVhZGVyLXZlcnNpb24nKTsKICAgIGNvbnN0IHsgdmVyc2lvbiAgfSA9IGRhdGE7CiAgICBoZWFkZXJWZXJzaW9uU3Bhbi50ZXh0Q29udGVudCA9IHZlcnNpb24gPyBgdiR7dmVyc2lvbn1gIDogJyc7CiAgICBjb25zdCBnaXRodWJMb2dvSW1nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dpdGh1Yi1sb2dvJyk7CiAgICBnaXRodWJMb2dvSW1nLnNyYyA9IGNvbXB1dGVHaXRodWJMb2dvRGF0YVVybCgpOwogICAgcmV0dXJuICgpPT57CiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVHaXRodWJMb2dvRGF0YVVybCgpIHsKICAgIGNvbnN0IHN2ZyA9IEdJVEhVQl9MT0dPLnJlcGxhY2UoJ2ZpbGw6d2hpdGU7JywgYGZpbGw6JHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9O2ApOwogICAgcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7dXRmOCwnICsgc3ZnOwp9CmNvbnN0IEdJVEhVQl9MT0dPID0gYDxzdmcgd2lkdGg9ImF1dG8iIGhlaWdodD0iYXV0byIgdmlld0JveD0iMCAwIDEzNiAxMzMiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgeG1sbnM6c2VyaWY9Imh0dHA6Ly93d3cuc2VyaWYuY29tLyIgc3R5bGU9ImZpbGwtcnVsZTpldmVub2RkO2NsaXAtcnVsZTpldmVub2RkO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDoyOyI+CjxnIHRyYW5zZm9ybT0ibWF0cml4KDQuMTY2NjcsMCwwLDQuMTY2NjcsLTU2OCwtMTM4MS4wNikiPgogICAgPHBhdGggZD0iTTE1Mi42MDgsMzMxLjQ1NUMxNDMuNjE0LDMzMS40NTUgMTM2LjMyLDMzOC43NDggMTM2LjMyLDM0Ny43NDVDMTM2LjMyLDM1NC45NDIgMTQwLjk4NywzNjEuMDQ3IDE0Ny40NiwzNjMuMjAxQzE0OC4yNzUsMzYzLjM1MSAxNDguNTcyLDM2Mi44NDggMTQ4LjU3MiwzNjIuNDE2QzE0OC41NzIsMzYyLjAyOSAxNDguNTU4LDM2MS4wMDUgMTQ4LjU1LDM1OS42NDZDMTQ0LjAxOSwzNjAuNjMgMTQzLjA2MywzNTcuNDYyIDE0My4wNjMsMzU3LjQ2MkMxNDIuMzIyLDM1NS41OCAxNDEuMjU0LDM1NS4wNzkgMTQxLjI1NCwzNTUuMDc5QzEzOS43NzUsMzU0LjA2OSAxNDEuMzY2LDM1NC4wODkgMTQxLjM2NiwzNTQuMDg5QzE0My4wMDEsMzU0LjIwNCAxNDMuODYxLDM1NS43NjggMTQzLjg2MSwzNTUuNzY4QzE0NS4zMTQsMzU4LjI1NyAxNDcuNjc0LDM1Ny41MzggMTQ4LjYwMiwzNTcuMTIxQzE0OC43NSwzNTYuMDY5IDE0OS4xNzEsMzU1LjM1MSAxNDkuNjM2LDM1NC45NDRDMTQ2LjAxOSwzNTQuNTMzIDE0Mi4yMTYsMzUzLjEzNSAxNDIuMjE2LDM0Ni44OTNDMTQyLjIxNiwzNDUuMTE1IDE0Mi44NTEsMzQzLjY2IDE0My44OTMsMzQyLjUyMkMxNDMuNzI1LDM0Mi4xMSAxNDMuMTY2LDM0MC40NTMgMTQ0LjA1MywzMzguMjExQzE0NC4wNTMsMzM4LjIxMSAxNDUuNDIsMzM3Ljc3MyAxNDguNTMyLDMzOS44ODFDMTQ5LjgzMSwzMzkuNTE5IDE1MS4yMjUsMzM5LjMzOSAxNTIuNjEsMzM5LjMzMkMxNTMuOTk0LDMzOS4zMzkgMTU1LjM4NywzMzkuNTE5IDE1Ni42ODgsMzM5Ljg4MUMxNTkuNzk4LDMzNy43NzMgMTYxLjE2MywzMzguMjExIDE2MS4xNjMsMzM4LjIxMUMxNjIuMDUyLDM0MC40NTMgMTYxLjQ5MywzNDIuMTEgMTYxLjMyNiwzNDIuNTIyQzE2Mi4zNywzNDMuNjYgMTYzLDM0NS4xMTUgMTYzLDM0Ni44OTNDMTYzLDM1My4xNTEgMTU5LjE5MSwzNTQuNTI4IDE1NS41NjMsMzU0LjkzMUMxNTYuMTQ3LDM1NS40MzQgMTU2LjY2OCwzNTYuNDI4IDE1Ni42NjgsMzU3Ljk0N0MxNTYuNjY4LDM2MC4xMjUgMTU2LjY0OCwzNjEuODgyIDE1Ni42NDgsMzYyLjQxNkMxNTYuNjQ4LDM2Mi44NTIgMTU2Ljk0MiwzNjMuMzU5IDE1Ny43NjgsMzYzLjJDMTY0LjIzNiwzNjEuMDQxIDE2OC44OTksMzU0Ljk0IDE2OC44OTksMzQ3Ljc0NUMxNjguODk5LDMzOC43NDggMTYxLjYwNSwzMzEuNDU1IDE1Mi42MDgsMzMxLjQ1NVoiIHN0eWxlPSJmaWxsOndoaXRlOyIvPgo8L2c+Cjwvc3ZnPmA7CmZ1bmN0aW9uIGFjdGlvbkljb24oaWNvbiwgb3B0cyA9IHsKfSkgewogICAgY29uc3QgeyB0ZXh0ICwgb25jbGljayAgfSA9IG9wdHM7CiAgICByZXR1cm4gaHRtbGA8ZGl2IGNsYXNzPSJhY3Rpb24taWNvbiIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIG9uY2xpY2sgJiYgb25jbGljaygpOwogICAgfX0+JHtpY29ufSR7dGV4dCB8fCAnJ308L2Rpdj5gOwp9CmNvbnN0IENMRUFSX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik01IDEzaDE0di0ySDV2MnptLTIgNGgxNHYtMkgzdjJ6TTcgN3YyaDE0VjdIN3oiLz48L3N2Zz5gOwpjb25zdCBFRElUX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xNC4wNiA5LjAybC45Mi45Mkw1LjkyIDE5SDV2LS45Mmw5LjA2LTkuMDZNMTcuNjYgM2MtLjI1IDAtLjUxLjEtLjcuMjlsLTEuODMgMS44MyAzLjc1IDMuNzUgMS44My0xLjgzYy4zOS0uMzkuMzktMS4wMiAwLTEuNDFsLTIuMzQtMi4zNGMtLjItLjItLjQ1LS4yOS0uNzEtLjI5em0tMy42IDMuMTlMMyAxNy4yNVYyMWgzLjc1TDE3LjgxIDkuOTRsLTMuNzUtMy43NXoiLz48L3N2Zz5gOwpjb25zdCBBRERfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOSAxM2gtNnY2aC0ydi02SDV2LTJoNlY1aDJ2Nmg2djJ6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tfQk9YX1VOQ0hFQ0tFRF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTkgNXYxNEg1VjVoMTRtMC0ySDVjLTEuMSAwLTIgLjktMiAydjE0YzAgMS4xLjkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJWNWMwLTEuMS0uOS0yLTItMnoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19CT1hfQ0hFQ0tFRF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTkgM0g1Yy0xLjEgMC0yIC45LTIgMnYxNGMwIDEuMS45IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjVjMC0xLjEtLjktMi0yLTJ6bTAgMTZINVY1aDE0djE0ek0xNy45OSA5bC0xLjQxLTEuNDItNi41OSA2LjU5LTIuNTgtMi41Ny0xLjQyIDEuNDEgNCAzLjk5eiIvPjwvc3ZnPmA7CmNvbnN0IFNJREVCQVJfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9InNpZGViYXIiPgogICAgJHtIRUFERVJfSFRNTH0KICAgIDxhIGlkPSJzaWRlYmFyLWFib3V0IiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiIGhyZWY9IiMiPkFib3V0PC9hPgogICAgPGRpdiBpZD0icHJvZmlsZXMiPjwvZGl2PgogICAgPGRpdiBpZD0ic2lkZWJhci1hbmFseXRpY3MiPjwvZGl2PgogICAgPGRpdiBpZD0ic2NyaXB0cyI+PC9kaXY+CjwvZGl2PgpgOwpjb25zdCBTSURFQkFSX0NTUyA9IGNzc2AKCiNzaWRlYmFyIHsKICAgIG1hcmdpbi1sZWZ0OiAxcmVtOwogICAgaGVpZ2h0OiAxMDB2aDsKICAgIG1pbi13aWR0aDogMTVyZW07Cn0KCiNzaWRlYmFyLWFib3V0IHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkIHsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAycmVtOwogICAgZ3JpZC1nYXA6IDFweDsKICAgIG1hcmdpbi1sZWZ0OiAxcHg7CiAgICBtYXJnaW4tdG9wOiAxcmVtOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQtbmV3IHsKICAgIGdyaWQtY29sdW1uOiAxOwogICAgbWluLXdpZHRoOiA4cmVtOwp9Cgojc2lkZWJhciBidXR0b24gewogICAgZ3JpZC1jb2x1bW46IDE7Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZCAuaGludCB7CiAgICBncmlkLWNvbHVtbjogMTsgCiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNzY3JpcHRzLXNjcm9sbGVyIHsKICAgIGhlaWdodDogY2FsYygxMDB2aCAtIDI4cmVtKTsKfQoKI3NpZGViYXIgLmV4dHJhLXRvcC1tYXJnaW4gewogICAgbWFyZ2luLXRvcDogMXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdFNpZGViYXIoZG9jdW1lbnQsIHZtLCBkYXRhKSB7CiAgICBjb25zdCB1cGRhdGVIZWFkZXIgPSBpbml0SGVhZGVyKGRvY3VtZW50LCB2bSwgZGF0YSk7CiAgICBjb25zdCBhYm91dEFuY2hvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaWRlYmFyLWFib3V0Jyk7CiAgICBjb25zdCBwcm9maWxlc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlcycpOwogICAgY29uc3QgYW5hbHl0aWNzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZGViYXItYW5hbHl0aWNzJyk7CiAgICBjb25zdCBzY3JpcHRzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmlwdHMnKTsKICAgIGFib3V0QW5jaG9yLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uc2hvd0Fib3V0KCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgdXBkYXRlSGVhZGVyKCk7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoUFJPRklMRVNfSFRNTCh2bSksIHByb2ZpbGVzRGl2KTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihBTkFMWVRJQ1NfSFRNTCh2bSksIGFuYWx5dGljc0Rpdik7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoU0NSSVBUU19IVE1MKHZtKSwgc2NyaXB0c0Rpdik7CiAgICB9Owp9CmNvbnN0IFBST0ZJTEVTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPlByb2ZpbGVzPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgJHt2bS5wcm9maWxlcy5tYXAoKHByb2ZpbGUpPT5odG1sYDxidXR0b24gCiAgICAgICAgICAgIGNsYXNzPSIke3Byb2ZpbGUuaWQgPT09IHZtLnNlbGVjdGVkUHJvZmlsZUlkID8gJ3NlbGVjdGVkJyA6ICcnfSIgCiAgICAgICAgICAgIEBjbGljaz0keygpPT57CiAgICAgICAgICAgIHZtLnNlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZS5pZDsKICAgICAgICB9fQogICAgICAgICAgICA/ZGlzYWJsZWQ9IiR7dm0ucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7cHJvZmlsZS50ZXh0fTwvYnV0dG9uPgogICAgICAgICR7cHJvZmlsZS5pZCA9PT0gdm0uc2VsZWN0ZWRQcm9maWxlSWQgPyBodG1sYCR7YWN0aW9uSWNvbihFRElUX0lDT04sIHsKICAgICAgICAgICAgb25jbGljazogKCk9PnZtLmVkaXRQcm9maWxlKHByb2ZpbGUuaWQpCiAgICAgICAgfSl9YCA6ICcnfWAKICAgICl9CiAgICAgICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQtbmV3Ij4ke2FjdGlvbkljb24oQUREX0lDT04sIHsKICAgICAgICB0ZXh0OiAnTmV3JywKICAgICAgICBvbmNsaWNrOiAoKT0+dm0ubmV3UHJvZmlsZSgpCiAgICB9KX08L2Rpdj4KICAgIDwvZGl2PgpgCjsKY29uc3QgQU5BTFlUSUNTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQgZXh0cmEtdG9wLW1hcmdpbiI+QW5hbHl0aWNzPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgJHt2bS5hbmFseXRpY3MubWFwKChhbmFseXRpYyk9Pmh0bWxgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3M9IiR7dm0uc2VsZWN0ZWRBbmFseXRpY0lkID09PSBhbmFseXRpYy5pZCA/ICdzZWxlY3RlZCcgOiAnJ30iIAogICAgICAgICAgICAgICAgQGNsaWNrPSR7KCk9PnZtLnNob3dBbmFseXRpYyhhbmFseXRpYy5pZCkKICAgICAgICB9IAogICAgICAgICAgICAgICAgP2Rpc2FibGVkPSIke3ZtLnByb2ZpbGVGb3JtLnNob3dpbmd9Ij4ke2FuYWx5dGljLnRleHR9PC9idXR0b24+CiAgICAgICAgYAogICAgKX0KICAgIDwvZGl2PgpgCjsKY29uc3QgU0NSSVBUU19IVE1MID0gKHZtKT0+aHRtbGAKICAgIDxkaXYgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGV4dHJhLXRvcC1tYXJnaW4iPlNjcmlwdHM8L2Rpdj4KICAgIDxkaXYgaWQ9InNjcmlwdHMtc2Nyb2xsZXIiIGNsYXNzPSJoaWRkZW4tdmVydGljYWwtc2Nyb2xsIj4KICAgICAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgICAgICR7dm0uc2NyaXB0cy5tYXAoKHNjcmlwdCk9Pmh0bWxgPGJ1dHRvbgogICAgICAgICAgICAgICAgICAgIGNsYXNzPSIke3ZtLnNlbGVjdGVkU2NyaXB0SWRzLmhhcyhzY3JpcHQuaWQpID8gJ3NlbGVjdGVkJyA6ICcnfSIgCiAgICAgICAgICAgICAgICAgICAgQGNsaWNrPSR7KGUpPT5oYW5kbGVTY3JpcHRDbGljayhlLCBzY3JpcHQuaWQsIHZtKQogICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgP2Rpc2FibGVkPSIke3ZtLnByb2ZpbGVGb3JtLnNob3dpbmd9Ij4ke3NjcmlwdC50ZXh0fTwvYnV0dG9uPgogICAgICAgICAgICBgCiAgICApfQogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FwdGlvbiBtZWRpdW0tZW1waGFzaXMtdGV4dCBoaW50Ij4ke2NvbXB1dGVNdWx0aXNlbGVjdEtleUNoYXIoKX0tY2xpY2sgdG8gbXVsdGlzZWxlY3Q8L2Rpdj4KICAgIDwvZGl2PgpgCjsKZnVuY3Rpb24gY29tcHV0ZU11bHRpc2VsZWN0S2V5Q2hhcigpIHsKICAgIHJldHVybiBpc01hY2ludG9zaCgpID8gJ+KMmCcgOiAnY3RybCc7Cn0KZnVuY3Rpb24gaXNNYWNpbnRvc2goKSB7CiAgICByZXR1cm4gbmF2aWdhdG9yLnBsYXRmb3JtLmluZGV4T2YoJ01hYycpID4gLTE7Cn0KZnVuY3Rpb24gaGFuZGxlU2NyaXB0Q2xpY2soZSwgc2NyaXB0SWQsIHZtKSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBjb25zdCBuZXdTY3JpcHRJZHMgPSBuZXcgU2V0KFsKICAgICAgICBzY3JpcHRJZAogICAgXSk7CiAgICBjb25zdCBtdWx0aSA9IGlzTWFjaW50b3NoKCkgPyBlLm1ldGFLZXkgOiBlLmN0cmxLZXk7CiAgICB2bS5zZWxlY3RlZFNjcmlwdElkcyA9IG11bHRpID8gdm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdElkKSA/IHNldFN1YnRyYWN0KHZtLnNlbGVjdGVkU2NyaXB0SWRzLCBuZXdTY3JpcHRJZHMpIDogc2V0VW5pb24odm0uc2VsZWN0ZWRTY3JpcHRJZHMsIG5ld1NjcmlwdElkcykgOiBuZXdTY3JpcHRJZHM7Cn0KY2xhc3MgQXBwQ29uc3RhbnRzIHsKICAgIHN0YXRpYyBXRUJTT0NLRVRfUElOR19JTlRFUlZBTF9TRUNPTkRTID0gMTA7CiAgICBzdGF0aWMgSU5BQ1RJVkVfVEFJTF9TRUNPTkRTID0gNTsKfQpjbGFzcyBUYWlsQ29udHJvbGxlciB7CiAgICBjYWxsYmFja3M7CiAgICByZWNvcmRzID0gbmV3IE1hcCgpOwogICAgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kczsKICAgIGluYWN0aXZlVGFpbFNlY29uZHM7CiAgICB0YWlsT3B0aW9ucyA9IHsKICAgICAgICBmaWx0ZXJzOiBbXQogICAgfTsKICAgIG9ubGluZTsKICAgIGNvbnN0cnVjdG9yKGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy53ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzID0gb3B0cy53ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzOwogICAgICAgIHRoaXMuaW5hY3RpdmVUYWlsU2Vjb25kcyA9IG9wdHMuaW5hY3RpdmVUYWlsU2Vjb25kczsKICAgICAgICBjb25zdCBuYXZpZ2F0b3JBc0FueSA9IHdpbmRvdy5uYXZpZ2F0b3I7CiAgICAgICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3JBc0FueS5vbkxpbmUgPT09ICdib29sZWFuJykgewogICAgICAgICAgICB0aGlzLnNldE9ubGluZShuYXZpZ2F0b3JBc0FueS5vbkxpbmUpOwogICAgICAgIH0KICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb25saW5lJywgKCk9PnRoaXMuc2V0T25saW5lKHRydWUpCiAgICAgICAgKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb2ZmbGluZScsICgpPT50aGlzLnNldE9ubGluZShmYWxzZSkKICAgICAgICApOwogICAgfQogICAgc2V0VGFpbE9wdGlvbnModGFpbE9wdGlvbnMpIHsKICAgICAgICBjb25zb2xlLmxvZyhgVGFpbENvbnRyb2xsZXIuc2V0VGFpbE9wdGlvbnMgJHtKU09OLnN0cmluZ2lmeSh0YWlsT3B0aW9ucyl9YCk7CiAgICAgICAgdGhpcy50YWlsT3B0aW9ucyA9IHRhaWxPcHRpb25zOwogICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIHRoaXMucmVjb3Jkcy52YWx1ZXMoKSl7CiAgICAgICAgICAgIGlmIChyZWNvcmQuY29ubmVjdGlvbikgewogICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24uc2V0T3B0aW9ucyh0YWlsT3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBzZXRUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuLCBzY3JpcHRJZHMpIHsKICAgICAgICBjb25zdCBzdG9wS2V5cyA9IHNldFN1YnRyYWN0KHRoaXMuY29tcHV0ZVN0YXJ0aW5nT3JTdGFydGVkVGFpbEtleXMoKSwgbmV3IFNldChbCiAgICAgICAgICAgIC4uLnNjcmlwdElkcwogICAgICAgIF0ubWFwKCh2KT0+cGFja1RhaWxLZXkoYWNjb3VudElkLCB2KQogICAgICAgICkpKTsKICAgICAgICBmb3IgKGNvbnN0IHN0b3BLZXkgb2Ygc3RvcEtleXMpewogICAgICAgICAgICBjb25zdCByZWNvcmQgPSB0aGlzLnJlY29yZHMuZ2V0KHN0b3BLZXkpOwogICAgICAgICAgICByZWNvcmQuc3RhdGUgPSAnaW5hY3RpdmUnOwogICAgICAgICAgICByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnaW5hY3RpdmUnICYmIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZSAmJiBEYXRlLm5vdygpIC0gcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lID49IHRoaXMuaW5hY3RpdmVUYWlsU2Vjb25kcykgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdzdG9wcGluZyc7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN0b3BwaW5nICR7cmVjb3JkLnNjcmlwdElkfSwgaW5hY3RpdmUgZm9yICR7RGF0ZS5ub3coKSAtIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZX1tc2ApOwogICAgICAgICAgICAgICAgICAgIHJlY29yZC5jb25uZWN0aW9uPy5jbG9zZSgxMDAwLCAnbm8gbG9uZ2VyIGludGVyZXN0ZWQnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY29yZHMuZGVsZXRlKHJlY29yZC50YWlsS2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcy5pbmFjdGl2ZVRhaWxTZWNvbmRzICogMTAwMCk7CiAgICAgICAgfQogICAgICAgIGlmIChzdG9wS2V5cy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLmRpc3BhdGNoVGFpbHNDaGFuZ2VkKCk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3Qgc2NyaXB0SWQgb2Ygc2NyaXB0SWRzKXsKICAgICAgICAgICAgY29uc3QgdGFpbEtleSA9IHBhY2tUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQodGFpbEtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ1JlY29yZCkgewogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkLnN0YXRlID09PSAnaW5hY3RpdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFJldml2aW5nIGluYWN0aXZlICR7c2NyaXB0SWR9YCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZC5zdGF0ZSA9ICdzdGFydGVkJzsKICAgICAgICAgICAgICAgIGV4aXN0aW5nUmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkID0gewogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnc3RhcnRpbmcnLAogICAgICAgICAgICAgICAgICAgIHRhaWxLZXksCiAgICAgICAgICAgICAgICAgICAgYXBpVG9rZW4sCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHJldHJ5Q291bnRBZnRlckNsb3NlOiAwCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRzLnNldCh0YWlsS2V5LCByZWNvcmQpOwogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCk7CiAgICAgICAgICAgICAgICByZWNvcmQuc3RhdGUgPSAnc3RhcnRlZCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFRhaWxzQ2hhbmdlZCgpOwogICAgICAgIH0KICAgIH0KICAgIGRpc3BhdGNoVGFpbHNDaGFuZ2VkKCkgewogICAgICAgIGNvbnN0IHRhaWxLZXlzID0gbmV3IFNldChbCiAgICAgICAgICAgIC4uLnRoaXMucmVjb3Jkcy52YWx1ZXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+di5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnCiAgICAgICAgKS5tYXAoKHYpPT52LnRhaWxLZXkKICAgICAgICApKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxzQ2hhbmdlZCh0YWlsS2V5cyk7CiAgICB9CiAgICBjb21wdXRlU3RhcnRpbmdPclN0YXJ0ZWRUYWlsS2V5cygpIHsKICAgICAgICByZXR1cm4gbmV3IFNldChbCiAgICAgICAgICAgIC4uLnRoaXMucmVjb3Jkcy52YWx1ZXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+di5zdGF0ZSA9PT0gJ3N0YXJ0aW5nJyB8fCB2LnN0YXRlID09PSAnc3RhcnRlZCcKICAgICAgICApLm1hcCgodik9PnYudGFpbEtleQogICAgICAgICkpOwogICAgfQogICAgc2V0T25saW5lKG9ubGluZSkgewogICAgICAgIGlmIChvbmxpbmUgPT09IHRoaXMub25saW5lKSByZXR1cm47CiAgICAgICAgY29uc3Qgb2xkT25saW5lID0gdGhpcy5vbmxpbmU7CiAgICAgICAgdGhpcy5vbmxpbmUgPSBvbmxpbmU7CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25OZXR3b3JrU3RhdHVzQ2hhbmdlZChvbmxpbmUpOwogICAgICAgIGlmICh0eXBlb2Ygb2xkT25saW5lID09PSAnYm9vbGVhbicpIHsKICAgICAgICAgICAgaWYgKG9ubGluZSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5yZWNvcmRzLnZhbHVlcygpKXsKICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnc3RhcnRlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBzY3JpcHRJZCAgfSA9IHJlY29yZDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCkuY2F0Y2goKGUpPT50aGlzLmNhbGxiYWNrcy5vblRhaWxGYWlsZWRUb1N0YXJ0KGFjY291bnRJZCwgc2NyaXB0SWQsICdyZXN0YXJ0LWFmdGVyLWNvbWluZy1vbmxpbmUnLCBlKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIHRoaXMucmVjb3Jkcy52YWx1ZXMoKSl7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24/LmNsb3NlKDEwMDAsICdvZmZsaW5lJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBzdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCkgewogICAgICAgIGNvbnN0IGFsbG93ZWRUb1N0YXJ0ID0gcmVjb3JkLnN0YXRlID09PSAnc3RhcnRpbmcnIHx8IHJlY29yZC5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnOwogICAgICAgIGlmICghYWxsb3dlZFRvU3RhcnQpIHJldHVybjsKICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIHNjcmlwdElkICB9ID0gdW5wYWNrVGFpbEtleShyZWNvcmQudGFpbEtleSk7CiAgICAgICAgY29uc3QgeyBhcGlUb2tlbiAgfSA9IHJlY29yZDsKICAgICAgICBpZiAoIXJlY29yZC50YWlsIHx8IERhdGUubm93KCkgPiBuZXcgRGF0ZShyZWNvcmQudGFpbC5leHBpcmVzX2F0KS5nZXRUaW1lKCkgLSAxMDAwICogNjAgKiA1KSB7CiAgICAgICAgICAgIGNvbnN0IHRhaWxDcmVhdGluZ1RpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKTsKICAgICAgICAgICAgY29uc3QgdGFpbCA9IGF3YWl0IGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHRJZCwgYXBpVG9rZW4pOwogICAgICAgICAgICByZWNvcmQudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSAtIHRhaWxDcmVhdGluZ1RpbWUsIHRhaWwpOwogICAgICAgIH0KICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnaW5hY3RpdmUnKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBjYWxsYmFja3MgLCB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzICB9ID0gdGhpczsKICAgICAgICBjb25zdCBkaXMgPSB0aGlzOwogICAgICAgIGNvbnN0IG9wZW5pbmdUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICBjb25zdCB0YWlsQ29ubmVjdGlvbkNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgb25PcGVuIChfY24sIHRpbWVTdGFtcCkgewogICAgICAgICAgICAgICAgcmVjb3JkLnJldHJ5Q291bnRBZnRlckNsb3NlID0gMDsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIERhdGUubm93KCkgLSBvcGVuaW5nVGltZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uQ2xvc2UgKF9jbiwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkNsb3NlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbik7CiAgICAgICAgICAgICAgICByZWNvcmQuY2xvc2VUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdzdGFydGVkJyAmJiBkaXMub25saW5lICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5yZXRyeUNvdW50QWZ0ZXJDbG9zZSsrOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlbGF5U2Vjb25kcyA9IE1hdGgubWluKHJlY29yZC5yZXRyeUNvdW50QWZ0ZXJDbG9zZSAqIDUsIDYwKTsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgV2lsbCBhdHRlbXB0IHRvIHJlc3RhcnQgJHtzY3JpcHRJZH0gaW4gJHtkZWxheVNlY29uZHN9IHNlY29uZHNgKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnc3RhcnRlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGRpcy5zdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBkZWxheVNlY29uZHMgKiAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25FcnJvciAoX2NuLCB0aW1lU3RhbXAsIGVycm9ySW5mbykgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25FcnJvcihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbE1lc3NhZ2UgKF9jbiwgdGltZVN0YW1wLCBtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlICE9PSAnc3RhcnRlZCcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblVucGFyc2VkTWVzc2FnZSAoX2NuLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblVucGFyc2VkTWVzc2FnZScsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcik7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZWNvcmQuY29ubmVjdGlvbiA9IG5ldyBUYWlsQ29ubmVjdGlvbihyZWNvcmQudGFpbC51cmwsIHRhaWxDb25uZWN0aW9uQ2FsbGJhY2tzLCB7CiAgICAgICAgICAgIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMKICAgICAgICB9KS5zZXRPcHRpb25zKHRoaXMudGFpbE9wdGlvbnMpOwogICAgfQp9CmZ1bmN0aW9uIHVucGFja1RhaWxLZXkodGFpbEtleSkgewogICAgY29uc3QgbSA9IC9eKFteXHMtXSspLShbXlxzXSspJC8uZXhlYyh0YWlsS2V5KTsKICAgIGlmICghbSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbEtleTogJHt0YWlsS2V5fWApOwogICAgcmV0dXJuIHsKICAgICAgICBhY2NvdW50SWQ6IG1bMV0sCiAgICAgICAgc2NyaXB0SWQ6IG1bMl0KICAgIH07Cn0KZnVuY3Rpb24gcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgcmV0dXJuIGAke2FjY291bnRJZH0tJHtzY3JpcHRJZH1gOwp9CmNsYXNzIFN3aXRjaGFibGVUYWlsQ29udHJvbGxlckNhbGxiYWNrcyB7CiAgICBjYWxsYmFja3M7CiAgICBlbmFibGVkRm47CiAgICBjb25zdHJ1Y3RvcihjYWxsYmFja3MsIGVuYWJsZWRGbil7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5lbmFibGVkRm4gPSBlbmFibGVkRm47CiAgICB9CiAgICBvblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRpbmcoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICB9CiAgICBvblRhaWxDcmVhdGVkKGFjY291bnRJZCwgc2NyaXB0SWQsIHRvb2tNaWxsaXMsIHRhaWwpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGVkKGFjY291bnRJZCwgc2NyaXB0SWQsIHRvb2tNaWxsaXMsIHRhaWwpOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCB0b29rTWlsbGlzKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCB0b29rTWlsbGlzKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25DbG9zZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uQ2xvc2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25FcnJvcihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbykgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25FcnJvcihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcik7CiAgICB9CiAgICBvblRhaWxzQ2hhbmdlZCh0YWlscykgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbHNDaGFuZ2VkKHRhaWxzKTsKICAgIH0KICAgIG9uTmV0d29ya1N0YXR1c0NoYW5nZWQob25saW5lKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25OZXR3b3JrU3RhdHVzQ2hhbmdlZChvbmxpbmUpOwogICAgfQogICAgb25UYWlsRmFpbGVkVG9TdGFydChhY2NvdW50SWQsIHNjcmlwdElkLCB0cmlnZ2VyLCBlcnJvcikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbEZhaWxlZFRvU3RhcnQoYWNjb3VudElkLCBzY3JpcHRJZCwgdHJpZ2dlciwgZXJyb3IpOwogICAgfQp9CmNsYXNzIERlbW9Nb2RlIHsKICAgIHN0YXRpYyBwcm9maWxlcyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAncHJvZmlsZTEnLAogICAgICAgICAgICB0ZXh0OiAnY29ycC1wcm9maWxlJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3Byb2ZpbGUyJywKICAgICAgICAgICAgdGV4dDogJ3BlcnMtcHJvZmlsZScKICAgICAgICB9LCAKICAgIF07CiAgICBzdGF0aWMgc2VsZWN0ZWRQcm9maWxlSWQgPSAncHJvZmlsZTEnOwogICAgc3RhdGljIHNldFNlbGVjdGVkUHJvZmlsZUlkKF92YWx1ZSkgewogICAgfQogICAgc3RhdGljIHNjcmlwdHMgPSBbCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDEnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMS1kZXYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MicsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIxLXByb2QnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MycsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIyLWRldicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ0JywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItYmV0YScKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ1JywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItcHJvZCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ2JywKICAgICAgICAgICAgdGV4dDogJ2R1cmFibGUtb2JqZWN0LWRlbW8nCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0NycsCiAgICAgICAgICAgIHRleHQ6ICdzZWNyZXQtYXBwJwogICAgICAgIH0sIAogICAgXTsKICAgIHN0YXRpYyBzZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgICdzY3JpcHQ3JywKICAgICAgICAnc2NyaXB0NCcKICAgIF0pOwogICAgc3RhdGljIHNldFNlbGVjdGVkU2NyaXB0SWRzKF9zY3JpcHRJZHMpIHsKICAgIH0KICAgIHN0YXRpYyB0YWlscyA9IG5ldyBTZXQoKTsKICAgIHN0YXRpYyBsb2dGYWtlT3V0cHV0KGNhbGxiYWNrcykgewogICAgICAgIGNvbnN0IGFjY291bnRJZCA9ICcxNWE3ZmEzYTM3MjU0ZmU0YTdjYWRkMWJiMjc2Mjg3OSc7CiAgICAgICAgY29uc3Qgc2NyaXB0SWQgPSAnc2VjcmV0LWFwcCc7CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgIGNvbnN0IHRhaWwgPSB7CiAgICAgICAgICAgIGlkOiAnZGIxOWViOGJlOWY0NDQzYWFiOTFhOTA0MmMwZDM1MTcnLAogICAgICAgICAgICB1cmw6ICd3c3M6Ly90YWlsLmRldmVsb3BlcnMud29ya2Vycy5kZXYvZGIxOWViOGJlOWY0NDQzYWFiOTFhOTA0MmMwZDM1MTcnLAogICAgICAgICAgICAnZXhwaXJlc19hdCc6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgICAgIH07CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgMTU1LCB0YWlsKTsKICAgICAgICBjYWxsYmFja3Mub25UYWlsc0NoYW5nZWQobmV3IFNldChbCiAgICAgICAgICAgIHBhY2tUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpCiAgICAgICAgXSkpOwogICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCA0Mik7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IDI7IGkrKyl7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZVJlcXVlc3QoKSk7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZURvUmVxdWVzdCgpKTsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlUmVxdWVzdFdpdGhMb2dzKCkpOwogICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgY29tcHV0ZUZha2VSZXF1ZXN0RXhjZWVkaW5nVGltZUxpbWl0KCkpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBVU0VSX0FHRU5UID0gJ01vemlsbGEvNS4wIChNYWNpbnRvc2g7IEludGVsIE1hYyBPUyBYIDEwLjE1OyBydjo5MS4wKSBHZWNrby8yMDEwMDEwMSBGaXJlZm94LzkxLjAnOwpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3QoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2V4YW1wbGUuY29tL2VuZHBvaW50JywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ2NmLWNvbm5lY3RpbmctaXAnOiAnMjAzLjAuMTEzLjEyJywKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFVTRVJfQUdFTlQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjZjogewogICAgICAgICAgICAgICAgICAgIGNvbG86ICdERlcnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFtdLAogICAgICAgIGV4Y2VwdGlvbnM6IFtdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdvaycKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUZha2VEb1JlcXVlc3QoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2Zha2UtaG9zdC9wdXQnLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnUFVUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ2xvZ3Byb3BzOicsCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvOiAnRVdSJywKICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZU9iamVjdENsYXNzOiAnTG9nZ2VyRE8nLAogICAgICAgICAgICAgICAgICAgICAgICBkdXJhYmxlT2JqZWN0SWQ6ICc1MzhmYzdjZTU1YjE0ZTUzYjZiODU1MmJlZmViOWFmNCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGVPYmplY3ROYW1lOiAnbG9nMScKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3RXaXRoTG9ncygpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vbXktd29ya2VyLnN1YmRvbWFpbi53b3JrZXJzLmRldi90ZXN0P2xvZz10cnVlJywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ2NmLWNvbm5lY3RpbmctaXAnOiAnMjAzLjAuMTEzLjEyJywKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFVTRVJfQUdFTlQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjZjogewogICAgICAgICAgICAgICAgICAgIGNvbG86ICdERlcnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdsb2cnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2Vycm9yJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdpbmZvJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICd3YXJuaW5nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdkZWJ1ZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3RFeGNlZWRpbmdUaW1lTGltaXQoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL215LXdvcmtlci5zdWJkb21haW4ud29ya2Vycy5kZXYvY29tcHV0ZS1kaWdpdHMtb2YtcGknLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnY2YtY29ubmVjdGluZy1pcCc6ICcyMDMuMC4xMTMuMTInLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVVNFUl9BR0VOVAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNmOiB7CiAgICAgICAgICAgICAgICAgICAgY29sbzogJ0RGVycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ2J1cm5pbmcgY3B1JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV4Y2VwdGlvbnM6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmFtZTogJ0Vycm9yJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdXb3JrZXIgZXhjZWVkZWQgQ1BVIHRpbWUgbGltaXQuJwogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdleGNlZWRlZENwdScKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KY2xhc3MgUXBzQ29udHJvbGxlciB7CiAgICBzb3J0ZWRFdmVudFRpbWVzID0gW107CiAgICBjYWxsYmFja3M7CiAgICBuOwogICAgX3FwcyA9IDA7CiAgICBnZXQgcXBzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9xcHM7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihuLCBjYWxsYmFja3MpewogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMubiA9IG47CiAgICB9CiAgICBhZGRFdmVudChldmVudFRpbWUpIHsKICAgICAgICBjb25zdCBxcHMgPSBjb21wdXRlUXBzKHRoaXMubiwgdGhpcy5zb3J0ZWRFdmVudFRpbWVzLCBldmVudFRpbWUpOwogICAgICAgIGlmIChxcHMgPT09IHRoaXMuX3FwcykgcmV0dXJuOwogICAgICAgIHRoaXMuX3FwcyA9IHFwczsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblFwc0NoYW5nZWQocXBzKTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlUXBzKG4sIHNvcnRlZEV2ZW50VGltZXMsIGV2ZW50VGltZSkgewogICAgYWRkKGV2ZW50VGltZSwgc29ydGVkRXZlbnRUaW1lcyk7CiAgICB3aGlsZShzb3J0ZWRFdmVudFRpbWVzLmxlbmd0aCA+IG4pewogICAgICAgIHNvcnRlZEV2ZW50VGltZXMuc2hpZnQoKTsKICAgIH0KICAgIGNvbnN0IG51bSA9IHNvcnRlZEV2ZW50VGltZXMubGVuZ3RoOwogICAgaWYgKG51bSA8IDIpIHJldHVybiAwOwogICAgY29uc3QgdGltZURpZmZTZWNvbmRzID0gKHNvcnRlZEV2ZW50VGltZXNbc29ydGVkRXZlbnRUaW1lcy5sZW5ndGggLSAxXSAtIHNvcnRlZEV2ZW50VGltZXNbMF0pIC8gMTAwMDsKICAgIHJldHVybiAobnVtIC0gMSkgLyB0aW1lRGlmZlNlY29uZHM7Cn0KZnVuY3Rpb24gYWRkKGVsLCBhcnIpIHsKICAgIGFyci5zcGxpY2UoZmluZExvYyhlbCwgYXJyKSArIDEsIDAsIGVsKTsKICAgIHJldHVybiBhcnI7Cn0KZnVuY3Rpb24gZmluZExvYyhlbCwgYXJyLCBzdCwgZW4pIHsKICAgIHN0ID0gc3QgfHwgMDsKICAgIGVuID0gZW4gfHwgYXJyLmxlbmd0aDsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspewogICAgICAgIGlmIChhcnJbaV0gPiBlbCkgewogICAgICAgICAgICByZXR1cm4gaSAtIDE7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGVuOwp9CmNsYXNzIFdlYnRhaWxBcHBWTSB7CiAgICBfcHJvZmlsZXMgPSBbXTsKICAgIGdldCBwcm9maWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnByb2ZpbGVzIDogdGhpcy5fcHJvZmlsZXM7CiAgICB9CiAgICBnZXQgcmVhbFByb2ZpbGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wcm9maWxlczsKICAgIH0KICAgIF9zZWxlY3RlZFByb2ZpbGVJZDsKICAgIGdldCBzZWxlY3RlZFByb2ZpbGVJZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnNlbGVjdGVkUHJvZmlsZUlkIDogdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQ7CiAgICB9CiAgICBzZXQgc2VsZWN0ZWRQcm9maWxlSWQodmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgewogICAgICAgICAgICBEZW1vTW9kZS5zZXRTZWxlY3RlZFByb2ZpbGVJZCh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID09PSB2YWx1ZSkgcmV0dXJuOwogICAgICAgIHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID0gdmFsdWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWQgPSB2YWx1ZTsKICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5maW5kU2NyaXB0cygpOwogICAgfQogICAgX2FuYWx5dGljcyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnZG8tY29zdHMnLAogICAgICAgICAgICB0ZXh0OiAnRHVyYWJsZSBPYmplY3QgQ29zdHMnCiAgICAgICAgfQogICAgXTsKICAgIGdldCBhbmFseXRpY3MoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FuYWx5dGljczsKICAgIH0KICAgIF9zZWxlY3RlZEFuYWx5dGljSWQ7CiAgICBnZXQgc2VsZWN0ZWRBbmFseXRpY0lkKCkgewogICAgICAgIHJldHVybiB0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQ7CiAgICB9CiAgICBfc2NyaXB0cyA9IFtdOwogICAgZ2V0IHNjcmlwdHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVtb01vZGUgPyBEZW1vTW9kZS5zY3JpcHRzIDogdGhpcy5fc2NyaXB0czsKICAgIH0KICAgIF9zZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoKTsKICAgIGdldCBzZWxlY3RlZFNjcmlwdElkcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnNlbGVjdGVkU2NyaXB0SWRzIDogdGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHM7CiAgICB9CiAgICBzZXQgc2VsZWN0ZWRTY3JpcHRJZHMoc2NyaXB0SWRzKSB7CiAgICAgICAgaWYgKHRoaXMuX3NlbGVjdGVkQW5hbHl0aWNJZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMuX3NlbGVjdGVkQW5hbHl0aWNJZCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgewogICAgICAgICAgICBEZW1vTW9kZS5zZXRTZWxlY3RlZFNjcmlwdElkcyhzY3JpcHRJZHMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChzZXRFcXVhbCh0aGlzLl9zZWxlY3RlZFNjcmlwdElkcywgc2NyaXB0SWRzKSkgcmV0dXJuOwogICAgICAgIHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldChzY3JpcHRJZHMpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgIGlmIChwcm9maWxlKSB7CiAgICAgICAgICAgIHByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMgPSBbCiAgICAgICAgICAgICAgICAuLi5zY3JpcHRJZHMKICAgICAgICAgICAgXTsKICAgICAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIH0KICAgICAgICB0aGlzLnNldFRhaWxzKCk7CiAgICB9CiAgICBwcm9maWxlRm9ybSA9IG5ldyBQcm9maWxlRm9ybVZNKCk7CiAgICBmaWx0ZXJGb3JtID0gbmV3IEZpbHRlckZvcm1WTSgpOwogICAgZmlsdGVyID0gewogICAgfTsKICAgIGV4dHJhRmllbGRzID0gW107CiAgICBfdGFpbHMgPSBuZXcgU2V0KCk7CiAgICBnZXQgdGFpbHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVtb01vZGUgPyBEZW1vTW9kZS50YWlscyA6IHRoaXMuX3RhaWxzOwogICAgfQogICAgc2V0IHRhaWxzKHRhaWxzKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIERlbW9Nb2RlLnRhaWxzID0gdGFpbHM7CiAgICAgICAgdGhpcy5fdGFpbHMgPSB0YWlsczsKICAgIH0KICAgIHdlbGNvbWVTaG93aW5nID0gZmFsc2U7CiAgICBhYm91dFNob3dpbmcgPSBmYWxzZTsKICAgIHN0YXRlID0gbG9hZFN0YXRlKCk7CiAgICB0YWlsQ29udHJvbGxlcjsKICAgIHRhaWxDb250cm9sbGVyQ2FsbGJhY2tzOwogICAgcXBzQ29udHJvbGxlcjsKICAgIGRlbW9Nb2RlID0gZmFsc2U7CiAgICBvbkNoYW5nZSA9ICgpPT57CiAgICB9OwogICAgbG9nZ2VyID0gKCk9PnsKICAgIH07CiAgICBvblJlc2V0T3V0cHV0ID0gKCk9PnsKICAgIH07CiAgICBvblFwc0NoYW5nZSA9ICgpPT57CiAgICB9OwogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBjb25zdCBkaXMgPSB0aGlzOwogICAgICAgIHRoaXMucXBzQ29udHJvbGxlciA9IG5ldyBRcHNDb250cm9sbGVyKDIwLCB7CiAgICAgICAgICAgIG9uUXBzQ2hhbmdlZCAocXBzKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgICAgICBkaXMub25RcHNDaGFuZ2UocXBzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGxvZ1RhaWxzQ2hhbmdlID0gKGFjdGlvbiwgdGFpbEtleXMpPT57CiAgICAgICAgICAgIGlmICh0YWlsS2V5cy5zaXplID4gMCkgdGhpcy5sb2dXaXRoUHJlZml4KGAke2FjdGlvbn0gJHtbCiAgICAgICAgICAgICAgICAuLi50YWlsS2V5cwogICAgICAgICAgICBdLm1hcCgodik9PnVucGFja1RhaWxLZXkodikuc2NyaXB0SWQKICAgICAgICAgICAgKS5zb3J0KCkuam9pbignLCAnKX1gKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGxvZ1dpdGhQcmVmaXggPSB0aGlzLmxvZ1dpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCB2ZXJib3NlV2l0aFByZWZpeCA9IHRoaXMudmVyYm9zZVdpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCBjYWxsYmFja3MgPSB7CiAgICAgICAgICAgIG9uVGFpbENyZWF0aW5nIChfYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENyZWF0aW5nIHRhaWwgZm9yICR7c2NyaXB0SWR9Li4uYCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENyZWF0ZWQgKF9hY2NvdW50SWQsIHNjcmlwdElkLCB0b29rTWlsbGlzLCB0YWlsKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ3JlYXRlZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXMsICR7SlNPTi5zdHJpbmdpZnkodGFpbCl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25PcGVuIChfYWNjb3VudElkLCBzY3JpcHRJZCwgX3RpbWVTdGFtcCwgdG9va01pbGxpcykgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYE9wZW5lZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXNgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbkNsb3NlIChhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uQ2xvc2UnLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ2xvc2VkIHRhaWwgZm9yICR7c2NyaXB0SWR9LCAke0pTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25FcnJvciAoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uRXJyb3InLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBlcnJvckluZm8KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgRXJyb3IgaW4gdGFpbCBmb3IgJHtzY3JpcHRJZH1gLCB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JJbmZvCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UgKF9hY2NvdW50SWQsIF9zY3JpcHRJZCwgX3RpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgaWYgKGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UsIGRpcy5maWx0ZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZSwgZGlzLmxvZ2dlciwgZGlzLmNvbXB1dGVBZGRpdGlvbmFsTG9ncyhtZXNzYWdlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgICAgICBkaXMucXBzQ29udHJvbGxlci5hZGRFdmVudChtZXNzYWdlLmV2ZW50VGltZXN0YW1wKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZSAoX2FjY291bnRJZCwgc2NyaXB0SWQsIF90aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgVW5wYXJzZWQgbWVzc2FnZSBpbiB0YWlsIGZvciAke3NjcmlwdElkfWAsIHBhcnNlRXJyb3Iuc3RhY2sgfHwgcGFyc2VFcnJvci5tZXNzYWdlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsc0NoYW5nZWQgKHRhaWxzKSB7CiAgICAgICAgICAgICAgICBpZiAoc2V0RXF1YWwoZGlzLnRhaWxzLCB0YWlscykpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92ZWQgPSBzZXRTdWJ0cmFjdChkaXMudGFpbHMsIHRhaWxzKTsKICAgICAgICAgICAgICAgIGxvZ1RhaWxzQ2hhbmdlKCdVbnRhaWxpbmcnLCByZW1vdmVkKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFkZGVkID0gc2V0U3VidHJhY3QodGFpbHMsIGRpcy50YWlscyk7CiAgICAgICAgICAgICAgICBsb2dUYWlsc0NoYW5nZSgnVGFpbGluZycsIGFkZGVkKTsKICAgICAgICAgICAgICAgIGRpcy50YWlscyA9IHRhaWxzOwogICAgICAgICAgICAgICAgZGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTmV0d29ya1N0YXR1c0NoYW5nZWQgKG9ubGluZSkgewogICAgICAgICAgICAgICAgaWYgKG9ubGluZSkgewogICAgICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoJyVjT05MSU5FJWMnLCAnY29sb3I6IGdyZWVuJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoJyVjT0ZGTElORSVjJywgJ2NvbG9yOiByZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsRmFpbGVkVG9TdGFydCAoX2FjY291bnRJZCwgc2NyaXB0SWQsIHRyaWdnZXIsIGVycm9yKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgVGFpbCBmb3IgJHtzY3JpcHRJZH0gZmFpbGVkIHRvIHN0YXJ0ICgke3RyaWdnZXJ9KTogJHtlcnJvci5uYW1lfSAke2Vycm9yLm1lc3NhZ2V9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgPSBBcHBDb25zdGFudHMuV0VCU09DS0VUX1BJTkdfSU5URVJWQUxfU0VDT05EUzsKICAgICAgICBjb25zdCBpbmFjdGl2ZVRhaWxTZWNvbmRzID0gQXBwQ29uc3RhbnRzLklOQUNUSVZFX1RBSUxfU0VDT05EUzsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyID0gbmV3IFRhaWxDb250cm9sbGVyKG5ldyBTd2l0Y2hhYmxlVGFpbENvbnRyb2xsZXJDYWxsYmFja3MoY2FsbGJhY2tzLCAoKT0+IXRoaXMuZGVtb01vZGUKICAgICAgICApLCB7CiAgICAgICAgICAgIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMsCiAgICAgICAgICAgIGluYWN0aXZlVGFpbFNlY29uZHMKICAgICAgICB9KTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMuZXh0cmFGaWVsZHMgPSBbCiAgICAgICAgICAgIC4uLnRoaXMuc3RhdGUuZXh0cmFGaWVsZHMgfHwgW10KICAgICAgICBdOwogICAgICAgIHRoaXMuZmlsdGVyID0gdGhpcy5zdGF0ZS5maWx0ZXIgfHwgewogICAgICAgIH07CiAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgIHNhdmU6IGZhbHNlCiAgICAgICAgfSk7CiAgICB9CiAgICBzdGFydCgpIHsKICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgdGhpcy5yZWNvbXB1dGVXZWxjb21lU2hvd2luZygpOwogICAgICAgIHRoaXMucGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKTsKICAgIH0KICAgIG5ld1Byb2ZpbGUoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMud2VsY29tZVNob3dpbmcpIHsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCA9IGdlbmVyYXRlVXVpZCgpOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS50aXRsZSA9ICdOZXcgUHJvZmlsZSc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gdGhpcy5fcHJvZmlsZXMubGVuZ3RoID09PSAwID8gJ2RlZmF1bHQnIDogYHByb2ZpbGUke3RoaXMuX3Byb2ZpbGVzLmxlbmd0aCArIDF9YDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSAnJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPSBmYWxzZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFByb2ZpbGUocHJvZmlsZUlkKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdOwogICAgICAgIGlmICghcHJvZmlsZSkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlICR7cHJvZmlsZUlkfSBub3QgZm91bmRgKTsKICAgICAgICB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICBjb25zdCB7IG5hbWUgLCBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5wcm9maWxlSWQgPSBwcm9maWxlSWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnRpdGxlID0gJ0VkaXQgUHJvZmlsZSc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9IGFjY291bnRJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gYXBpVG9rZW47CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZGVsZXRlUHJvZmlsZShwcm9maWxlSWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnZGVsZXRlIHByb2ZpbGUnLCBwcm9maWxlSWQpOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgaWYgKCFwcm9maWxlKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgJHtwcm9maWxlSWR9IG5vdCBmb3VuZGApOwogICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMucmVsb2FkUHJvZmlsZXMoKTsKICAgICAgICB0aGlzLnJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCk7CiAgICAgICAgdGhpcy5wZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpOwogICAgfQogICAgY2FuY2VsUHJvZmlsZSgpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlTmFtZShuYW1lKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVBY2NvdW50SWQoYWNjb3VudElkKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hY2NvdW50SWQgPSBhY2NvdW50SWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlQXBpVG9rZW4oYXBpVG9rZW4pIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gYXBpVG9rZW47CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzYXZlUHJvZmlsZSgpIHsKICAgICAgICBjb25zdCB7IHByb2ZpbGVGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCB7IHByb2ZpbGVJZCAgfSA9IHByb2ZpbGVGb3JtOwogICAgICAgIGNvbnN0IG5ld1Byb2ZpbGUgPSB7CiAgICAgICAgICAgIG5hbWU6IHByb2ZpbGVGb3JtLm5hbWUudHJpbSgpLAogICAgICAgICAgICBhY2NvdW50SWQ6IHByb2ZpbGVGb3JtLmFjY291bnRJZC50cmltKCksCiAgICAgICAgICAgIGFwaVRva2VuOiBwcm9maWxlRm9ybS5hcGlUb2tlbi50cmltKCkKICAgICAgICB9OwogICAgICAgIHRoaXMudHJ5U2F2ZVByb2ZpbGUocHJvZmlsZUlkLCBuZXdQcm9maWxlKTsKICAgIH0KICAgIGVkaXRFdmVudEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0V2ZW50IHR5cGU6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2FsbCcsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQWxsJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2Nyb24nLAogICAgICAgICAgICAgICAgdGV4dDogJ0NST04gdHJpZ2dlcicKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICdodHRwJywKICAgICAgICAgICAgICAgIHRleHQ6ICdIVFRQIHJlcXVlc3QnCiAgICAgICAgICAgIH0sIAogICAgICAgIF07CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpbHRlci5ldmVudDEgPT09ICdodHRwJyA/ICdodHRwJyA6IGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyA/ICdjcm9uJyA6ICdhbGwnOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnQ2hvb3NlIHdoaWNoIHR5cGVzIG9mIGV2ZW50cyB0byBzaG93JzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLmV2ZW50MSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5ldmVudDEgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRDaG9pY2VUZXh0ID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5maW5kKCh2KT0+di5pZCA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlCiAgICAgICAgICAgICkudGV4dDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBFdmVudCB0eXBlIGZpbHRlciBjaGFuZ2VkIHRvOiAke3NlbGVjdGVkQ2hvaWNlVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTdGF0dXNGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdTdGF0dXM6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2FsbCcsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQWxsJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgdGV4dDogJ1N1Y2Nlc3MnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnZXJyb3InLAogICAgICAgICAgICAgICAgdGV4dDogJ0Vycm9yJwogICAgICAgICAgICB9LCAKICAgICAgICBdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnID8gJ3N1Y2Nlc3MnIDogZmlsdGVyLnN0YXR1czEgPT09ICdlcnJvcicgPyAnZXJyb3InIDogJ2FsbCc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdTaG93IGV2ZW50cyB0aGlzIHRoaXMgc3RhdHVzJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLnN0YXR1czEgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc3RhdHVzMSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZENob2ljZVRleHQgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmZpbmQoKHYpPT52LmlkID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUKICAgICAgICAgICAgKS50ZXh0OwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYFN0YXR1cyBmaWx0ZXIgY2hhbmdlZCB0bzogJHtzZWxlY3RlZENob2ljZVRleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0SXBBZGRyZXNzRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBpc1ZhbGlkSXBBZGRyZXNzID0gKGlwQWRkcmVzcyk9PnsKICAgICAgICAgICAgcmV0dXJuIC9eKHNlbGZ8W1xkXC46YS1mXXszLH0pJC8udGVzdChpcEFkZHJlc3MpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY2hlY2tWYWxpZElwQWRkcmVzcyA9IChpcEFkZHJlc3MpPT57CiAgICAgICAgICAgIGlmICghaXNWYWxpZElwQWRkcmVzcyhpcEFkZHJlc3MpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBpcCBhZGRyZXNzOiAke2lwQWRkcmVzc31gKTsKICAgICAgICAgICAgcmV0dXJuIGlwQWRkcmVzczsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVySXBBZGRyZXNzZXNGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodiA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHYuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKS5tYXAoY2hlY2tWYWxpZElwQWRkcmVzcykpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySXBBZGRyZXNzZXMgPSAoKT0+ewogICAgICAgICAgICByZXR1cm4gZGlzdGluY3QoZmlsdGVyLmlwQWRkcmVzczEgfHwgW10pLmpvaW4oJywgJyk7CiAgICAgICAgfTsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnSVAgYWRkcmVzcyhzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySXBBZGRyZXNzZXMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gYCdzZWxmJyB0byBmaWx0ZXIgeW91ciBvd24gYWRkcmVzcywgY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCBlLmcuIHNlbGYsIDEuMS4xLjFgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJJcEFkZHJlc3Nlc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5pcEFkZHJlc3MxIHx8IFtdKSwgbmV3IFNldChuZXdWYWx1ZSkpKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5pcEFkZHJlc3MxID0gbmV3VmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IG5ld1ZhbHVlLmxlbmd0aCA9PT0gMCA/ICdhbnkgSVAgYWRkcmVzcycgOiBuZXdWYWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYElQIGFkZHJlc3MgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRNZXRob2RGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVyTWV0aG9kc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3Qodi5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpLnRvVXBwZXJDYXNlKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlck1ldGhvZHMgPSAoKT0+ewogICAgICAgICAgICByZXR1cm4gZGlzdGluY3QoZmlsdGVyLm1ldGhvZDEgfHwgW10pLm1hcCgodik9PnYudG9VcHBlckNhc2UoKQogICAgICAgICAgICApLmpvaW4oJywgJyk7CiAgICAgICAgfTsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnSFRUUCBNZXRob2Qocyk6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlck1ldGhvZHMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ2NvbW1hLXNlcGFyYXRlZCBpZiBtdWx0aXBsZSwgZS5nLiBHRVQsIFBPU1QnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJNZXRob2RzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLm1ldGhvZDEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLm1ldGhvZDEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ2FueSBtZXRob2QnIDogbmV3VmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBNZXRob2QgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTYW1wbGluZ1JhdGVGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCBwYXJzZVNhbXBsZVJhdGVGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodiA9PT0gJycpIHJldHVybiAxOwogICAgICAgICAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHYpOwogICAgICAgICAgICBpZiAoIWlzVmFsaWRTYW1wbGluZ1JhdGUobnVtKSkgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJhdGU6ICR7dn1gKTsKICAgICAgICAgICAgcmV0dXJuIG51bTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1NhbXBsaW5nIHJhdGU6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9ICh0eXBlb2YgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPT09ICdudW1iZXInICYmIGlzVmFsaWRTYW1wbGluZ1JhdGUoZmlsdGVyLnNhbXBsaW5nUmF0ZTEpID8gZmlsdGVyLnNhbXBsaW5nUmF0ZTEgOiAxKS50b0ZpeGVkKDIpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnQ2FuIHJhbmdlIGZyb20gMCAoMCUpIHRvIDEgKDEwMCUpJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlU2FtcGxlUmF0ZUZyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gbmV3VmFsdWUpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUgPT09IDEgPyAnbm8gc2FtcGxpbmcnIDogYCR7bmV3VmFsdWV9ICgkeyhuZXdWYWx1ZSAqIDEwMCkudG9GaXhlZCgyKX0lKWA7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU2FtcGxlIHJhdGUgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTZWFyY2hGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdTZWFyY2ggdGV4dDonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyLnNlYXJjaDEgfHwgJyc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdGaWx0ZXIgYnkgYSB0ZXh0IG1hdGNoIGluIGNvbnNvbGUubG9nIG1lc3NhZ2VzJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLnNlYXJjaDEgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc2VhcmNoMSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gKGZpbHRlci5zZWFyY2gxIHx8ICcnKS5sZW5ndGggPT09IDAgPyAnbm8gc2VhcmNoIGZpbHRlcicgOiBgJyR7ZmlsdGVyLnNlYXJjaDF9J2A7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU2VhcmNoIGZpbHRlciBjaGFuZ2VkIHRvOiAke3RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0SGVhZGVyRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBwYXJzZUZpbHRlckhlYWRlcnNGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodiA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHYuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKQogICAgICAgICAgICApLmZpbHRlcigodik9PnYgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySGVhZGVycyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIuaGVhZGVyMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdIZWFkZXIocyk6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlckhlYWRlcnMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gYCdrZXknLCBvciAna2V5OnF1ZXJ5JywgY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlYDsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlRmlsdGVySGVhZGVyc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5oZWFkZXIxIHx8IFtdKSwgbmV3IFNldChuZXdWYWx1ZSkpKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5oZWFkZXIxID0gbmV3VmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IG5ld1ZhbHVlLmxlbmd0aCA9PT0gMCA/ICdubyBoZWFkZXIgZmlsdGVyJyA6IG5ld1ZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgSGVhZGVyIGZpbHRlciBjaGFuZ2VkIHRvOiAke3RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0TG9ncHJvcEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgcGFyc2VMb2dwcm9wRmlsdGVyc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3Qodi5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21Mb2dQcm9wRmlsdGVycyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIubG9ncHJvcDEgfHwgW10pLmpvaW4oJywgJyk7CiAgICAgICAgfTsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnTG9ncHJvcChzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tTG9nUHJvcEZpbHRlcnMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gYCdrZXknLCBvciAna2V5OnZhbHVlJywgY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCB2YWx1ZSBtYXkgaW5jbHVkZSAqYDsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlTG9ncHJvcEZpbHRlcnNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICB0aGlzLnNldExvZ3Byb3BGaWx0ZXIobmV3VmFsdWUpOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2V0TG9ncHJvcEZpbHRlcihsb2dwcm9wRmlsdGVycykgewogICAgICAgIGNvbnN0IHsgZmlsdGVyICB9ID0gdGhpczsKICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIubG9ncHJvcDEgfHwgW10pLCBuZXcgU2V0KGxvZ3Byb3BGaWx0ZXJzKSkpIHJldHVybjsKICAgICAgICBmaWx0ZXIubG9ncHJvcDEgPSBsb2dwcm9wRmlsdGVyczsKICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHRleHQgPSBsb2dwcm9wRmlsdGVycy5sZW5ndGggPT09IDAgPyAnbm8gbG9ncHJvcCBmaWx0ZXInIDogbG9ncHJvcEZpbHRlcnMuam9pbignLCAnKTsKICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYExvZ3Byb3AgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgIH0KICAgIGhhc0FueUZpbHRlcnMoKSB7CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHsgZXZlbnQxICB9ID0gZmlsdGVyOwogICAgICAgIHJldHVybiBjb21wdXRlVGFpbE9wdGlvbnNGb3JGaWx0ZXIoZmlsdGVyKS5maWx0ZXJzLmxlbmd0aCA+IDAgfHwgdHlwZW9mIGV2ZW50MSA9PT0gJ3N0cmluZycgJiYgZXZlbnQxICE9PSAnJyAmJiBldmVudDEgIT09ICdhbGwnOwogICAgfQogICAgcmVzZXRGaWx0ZXJzKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgdGhpcy5maWx0ZXIgPSB7CiAgICAgICAgfTsKICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgRmlsdGVycyByZXNldGApOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGNhbmNlbEZpbHRlcigpIHsKICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsRmlsdGVyJyk7CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzYXZlRmlsdGVyKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdzYXZlRmlsdGVyJyk7CiAgICAgICAgY29uc3QgeyBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBmaWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2UgPSAnQ2hlY2tpbmcgZmlsdGVyLi4uJzsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlKCk7CiAgICAgICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9IGBgOwogICAgICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9IGBFcnJvcjogJHtlLm1lc3NhZ2V9YDsKICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICBzZWxlY3RGaWx0ZXJDaG9pY2UoaWQpIHsKICAgICAgICBpZiAodGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPT09IGlkKSByZXR1cm47CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBpZDsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0U2VsZWN0aW9uRmllbGRzKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnQWRkaXRpb25hbCBmaWVsZHM6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IEVYVFJBX0ZJRUxEU19PUFRJT05TOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9ICh0aGlzLmV4dHJhRmllbGRzIHx8IFtdKS5qb2luKCcsJyk7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdTZWxlY3QgYWRkaXRpb25hbCBmaWVsZHMgdG8gc2hvdyBpbiB0aGUgb3V0cHV0JzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZXMgPSBkaXN0aW5jdCgoZmlsdGVyRm9ybS5maWVsZFZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KHRoaXMuZXh0cmFGaWVsZHMgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlcykpKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZXh0cmFGaWVsZHMgPSBuZXdWYWx1ZXM7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgZXh0cmFGaWVsZHNUZXh0ID0gdGhpcy5jb21wdXRlU2VsZWN0aW9uRmllbGRzVGV4dCgpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYE91dHB1dCBmaWVsZHMgY2hhbmdlZCB0bzogJHtleHRyYUZpZWxkc1RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBjb21wdXRlU2VsZWN0aW9uRmllbGRzVGV4dCgpIHsKICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAnc3RhbmRhcmQgZmllbGRzJywKICAgICAgICAgICAgLi4udGhpcy5leHRyYUZpZWxkcy5tYXAoKGlkKT0+RVhUUkFfRklFTERTX09QVElPTlMuZmluZCgodik9PnYuaWQgPT09IGlkCiAgICAgICAgICAgICAgICApPy50ZXh0IHx8IGlkCiAgICAgICAgICAgICkKICAgICAgICBdLmpvaW4oJywgJyk7CiAgICB9CiAgICB0b2dnbGVGaWx0ZXJPcHRpb24oaWQpIHsKICAgICAgICBjb25zdCBleHRyYUZpZWxkcyA9IGRpc3RpbmN0KCh0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSB8fCAnJykuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKQogICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICApKTsKICAgICAgICBjb25zdCBpID0gZXh0cmFGaWVsZHMuaW5kZXhPZihpZCk7CiAgICAgICAgaWYgKGkgPj0gMCkgewogICAgICAgICAgICBleHRyYUZpZWxkcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0cmFGaWVsZHMucHVzaChpZCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpZWxkVmFsdWUgPSBleHRyYUZpZWxkcy5qb2luKCcsJyk7CiAgICAgICAgaWYgKHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlID09PSBmaWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWVsZFZhbHVlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHRvZ2dsZURlbW9Nb2RlKCkgewogICAgICAgIHRoaXMuc2V0RGVtb01vZGUoIXRoaXMuZGVtb01vZGUpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHJlc2V0T3V0cHV0KCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgdGhpcy5vblJlc2V0T3V0cHV0KCk7CiAgICB9CiAgICBzaG93QWJvdXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmFib3V0U2hvd2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgY2xvc2VBYm91dCgpIHsKICAgICAgICB0aGlzLmFib3V0U2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNob3dBbmFseXRpYyhhbmFseXRpY0lkKSB7CiAgICAgICAgY29uc3QgYW5hbHl0aWMgPSB0aGlzLmFuYWx5dGljcy5maW5kKCh2KT0+di5pZCA9PT0gYW5hbHl0aWNJZAogICAgICAgICk7CiAgICAgICAgaWYgKCFhbmFseXRpYyB8fCBhbmFseXRpYy5pZCA9PT0gdGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkID0gYW5hbHl0aWNJZDsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXREZW1vTW9kZShkZW1vTW9kZSkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlID09PSBkZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIHRoaXMuZGVtb01vZGUgPSBkZW1vTW9kZTsKICAgICAgICBpZiAoZGVtb01vZGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0VuYWJsZSBkZW1vIG1vZGUnKTsKICAgICAgICAgICAgdGhpcy5vblFwc0NoYW5nZSgxMi4zNCk7CiAgICAgICAgICAgIHRoaXMub25SZXNldE91dHB1dCgpOwogICAgICAgICAgICBEZW1vTW9kZS5sb2dGYWtlT3V0cHV0KHRoaXMudGFpbENvbnRyb2xsZXJDYWxsYmFja3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdEaXNhYmxlIGRlbW8gbW9kZScpOwogICAgICAgICAgICB0aGlzLm9uUXBzQ2hhbmdlKHRoaXMucXBzQ29udHJvbGxlci5xcHMpOwogICAgICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgICAgICB9CiAgICB9CiAgICBhcHBseUZpbHRlcihvcHRzKSB7CiAgICAgICAgY29uc3QgeyBzYXZlICB9ID0gb3B0czsKICAgICAgICB0aGlzLnN0YXRlLmZpbHRlciA9IHRoaXMuZmlsdGVyOwogICAgICAgIHRoaXMuc3RhdGUuZXh0cmFGaWVsZHMgPSB0aGlzLmV4dHJhRmllbGRzOwogICAgICAgIGlmIChzYXZlKSBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgY29uc3QgdGFpbE9wdGlvbnMgPSBjb21wdXRlVGFpbE9wdGlvbnNGb3JGaWx0ZXIodGhpcy5maWx0ZXIpOwogICAgICAgIHRoaXMudGFpbENvbnRyb2xsZXIuc2V0VGFpbE9wdGlvbnModGFpbE9wdGlvbnMpOwogICAgfQogICAgbG9nV2l0aFByZWZpeCguLi5kYXRhKSB7CiAgICAgICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSk7CiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCAmJiB0eXBlb2YgZGF0YVswXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgZGF0YSA9IFsKICAgICAgICAgICAgICAgIGBbJWMke3RpbWV9JWNdICR7ZGF0YVswXX1gLAogICAgICAgICAgICAgICAgJ2NvbG9yOiBncmF5JywKICAgICAgICAgICAgICAgICcnLAogICAgICAgICAgICAgICAgLi4uZGF0YS5zbGljZSgxKQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICB0aGlzLmxvZ2dlciguLi5kYXRhKTsKICAgIH0KICAgIHZlcmJvc2VXaXRoUHJlZml4KG1lc3NhZ2UpIHsKICAgICAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKTsKICAgICAgICB0aGlzLmxvZ2dlcihgWyVjJHt0aW1lfSVjXSAlYyR7bWVzc2FnZX0lY2AsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknKTsKICAgIH0KICAgIHBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCkgewogICAgICAgIGNvbnN0IGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkID0gY29tcHV0ZUluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKHRoaXMuc3RhdGUsIHRoaXMuX3Byb2ZpbGVzKTsKICAgICAgICBpZiAoaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYEluaXRpYWxseSBzZWxlY3RpbmcgcHJvZmlsZTogJHt0aGlzLnN0YXRlLnByb2ZpbGVzW2luaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkXS5uYW1lfWApOwogICAgICAgICAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID0gaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHRyeVNhdmVQcm9maWxlKHByb2ZpbGVJZCwgcHJvZmlsZSkgewogICAgICAgIGNvbnN0IHsgcHJvZmlsZUZvcm0gIH0gPSB0aGlzOwogICAgICAgIHByb2ZpbGVGb3JtLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBwcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPSB0cnVlOwogICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnQ2hlY2tpbmcgcHJvZmlsZS4uLic7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGNhbkxpc3RUYWlscyA9IGF3YWl0IGNvbXB1dGVDYW5MaXN0VGFpbHMocHJvZmlsZS5hY2NvdW50SWQsIHByb2ZpbGUuYXBpVG9rZW4pOwogICAgICAgICAgICBpZiAoY2FuTGlzdFRhaWxzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF0gPSBwcm9maWxlOwogICAgICAgICAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgICAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICcnOwogICAgICAgICAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNvbXB1dGVXZWxjb21lU2hvd2luZygpOwogICAgICAgICAgICAgICAgcHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSBgVGhlc2UgY3JlZGVudGlhbHMgZG8gbm90IGhhdmUgcGVybWlzc2lvbiB0byB0YWlsYDsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9IGBFcnJvcjogJHtlLm1lc3NhZ2V9YDsKICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICBwcm9maWxlRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlbG9hZFByb2ZpbGVzKCkgewogICAgICAgIGNvbnN0IHsgc3RhdGUgIH0gPSB0aGlzOwogICAgICAgIHRoaXMuX3Byb2ZpbGVzLnNwbGljZSgwKTsKICAgICAgICBmb3IgKGNvbnN0IFtwcm9maWxlSWQsIHByb2ZpbGVdIG9mIE9iamVjdC5lbnRyaWVzKHN0YXRlLnByb2ZpbGVzKSl7CiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBwcm9maWxlLm5hbWUgfHwgJyh1bm5hbWVkKSc7CiAgICAgICAgICAgIHRoaXMuX3Byb2ZpbGVzLnB1c2goewogICAgICAgICAgICAgICAgaWQ6IHByb2ZpbGVJZCwKICAgICAgICAgICAgICAgIHRleHQ6IG5hbWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgZmluZFNjcmlwdHMoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICAgICAgaWYgKHByb2ZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICAgICAgdGhpcy52ZXJib3NlV2l0aFByZWZpeChgRmluZGluZyBzY3JpcHRzIGZvciAke3Byb2ZpbGUubmFtZS50b1VwcGVyQ2FzZSgpfS4uLmApOwogICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIGNvbnN0IHNjcmlwdHMgPSBhd2FpdCBsaXN0U2NyaXB0cyhhY2NvdW50SWQsIGFwaVRva2VuKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlbW9Nb2RlKSB0aGlzLnZlcmJvc2VXaXRoUHJlZml4KGBGb3VuZCAke3NjcmlwdHMubGVuZ3RofSBzY3JpcHRzIGluICR7RGF0ZS5ub3coKSAtIHN0YXJ0fW1zYCk7CiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMuc3BsaWNlKDApOwogICAgICAgICAgICBmb3IgKGNvbnN0IHNjcmlwdCBvZiBzY3JpcHRzKXsKICAgICAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IHNjcmlwdC5pZCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBzY3JpcHQuaWQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMuc29ydCgobGhzLCByaHMpPT5saHMudGV4dC5sb2NhbGVDb21wYXJlKHJocy50ZXh0KQogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZFNjcmlwdElkcyA9IHRoaXMuY29tcHV0ZVNlbGVjdGVkU2NyaXB0SWRzQWZ0ZXJGaW5kU2NyaXB0cygpOwogICAgICAgICAgICBpZiAoc2VsZWN0ZWRTY3JpcHRJZHMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRTY3JpcHRJZHMgPSBzZWxlY3RlZFNjcmlwdElkczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuZGVtb01vZGUpIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZW1vTW9kZSkgdGhpcy5sb2dnZXIoYEVycm9yIGluIGZpbmRTY3JpcHRzOiAke2Uuc3RhY2t9YCk7CiAgICAgICAgfQogICAgfQogICAgY29tcHV0ZVNlbGVjdGVkU2NyaXB0SWRzQWZ0ZXJGaW5kU2NyaXB0cygpIHsKICAgICAgICBpZiAodGhpcy5fc2NyaXB0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0luaXRpYWxseSBzZWxlY3Rpbmcgbm8gc2NyaXB0cywgbm8gc2NyaXB0cyB0byBzZWxlY3QnKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkKSB7CiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxQcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICAgICAgaWYgKGluaXRpYWxQcm9maWxlICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY3JpcHRJZHMgPSBuZXcgU2V0KHRoaXMuX3NjcmlwdHMubWFwKCh2KT0+di5pZAogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gc2V0SW50ZXJzZWN0KGN1cnJlbnRTY3JpcHRJZHMsIG5ldyBTZXQoaW5pdGlhbFByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMpKTsKICAgICAgICAgICAgICAgIGlmIChjYW5kaWRhdGVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEluaXRpYWxseSBzZWxlY3Rpbmcgc2NyaXB0JHtjYW5kaWRhdGVzLnNpemUgPT09IDEgPyAnJyA6ICdzJ30gJHtbCiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmNhbmRpZGF0ZXMKICAgICAgICAgICAgICAgICAgICBdLnNvcnQoKS5qb2luKCcsICcpfTogcmVtZW1iZXJlZCBmcm9tIGxhc3QgdGltZWApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYW5kaWRhdGVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpcnN0U2NyaXB0SWQgPSB0aGlzLl9zY3JpcHRzWzBdLmlkOwogICAgICAgIGNvbnNvbGUubG9nKGBJbml0aWFsbHkgc2VsZWN0aW5nIHNjcmlwdCAke2ZpcnN0U2NyaXB0SWR9OiBmaXJzdCBvbmUgaW4gdGhlIGxpc3RgKTsKICAgICAgICByZXR1cm4gbmV3IFNldChbCiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHNbMF0uaWQKICAgICAgICBdKTsKICAgIH0KICAgIGFzeW5jIHNldFRhaWxzKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy50YWlsQ29udHJvbGxlci5zZXRUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuLCB0aGlzLl9zZWxlY3RlZFNjcmlwdElkcyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmxvZ2dlcignRXJyb3IgaW4gc2V0VGFpbHMnLCBlLnN0YWNrIHx8IGUubWVzc2FnZSk7CiAgICAgICAgfQogICAgfQogICAgY29tcHV0ZUFkZGl0aW9uYWxMb2dzKG1lc3NhZ2UpIHsKICAgICAgICBjb25zdCBydCA9IFtdOwogICAgICAgIGNvbnN0IGluY2x1ZGVJcEFkZHJlc3MgPSB0aGlzLmV4dHJhRmllbGRzLmluY2x1ZGVzKCdpcC1hZGRyZXNzJyk7CiAgICAgICAgY29uc3QgaW5jbHVkZVVzZXJBZ2VudCA9IHRoaXMuZXh0cmFGaWVsZHMuaW5jbHVkZXMoJ3VzZXItYWdlbnQnKTsKICAgICAgICBjb25zdCBpbmNsdWRlUmVmZXJlciA9IHRoaXMuZXh0cmFGaWVsZHMuaW5jbHVkZXMoJ3JlZmVyZXInKTsKICAgICAgICBpZiAoaW5jbHVkZUlwQWRkcmVzcyB8fCBpbmNsdWRlVXNlckFnZW50IHx8IGluY2x1ZGVSZWZlcmVyKSB7CiAgICAgICAgICAgIGlmICghaXNUYWlsTWVzc2FnZUNyb25FdmVudChtZXNzYWdlLmV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVJcEFkZHJlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpcEFkZHJlc3MgPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3QuaGVhZGVyc1snY2YtY29ubmVjdGluZy1pcCddIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAoaXBBZGRyZXNzKSBydC5wdXNoKGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZCgnSVAgYWRkcmVzcycsIGlwQWRkcmVzcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVVc2VyQWdlbnQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyQWdlbnQgPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3QuaGVhZGVyc1sndXNlci1hZ2VudCddIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAodXNlckFnZW50KSBydC5wdXNoKGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZCgnVXNlciBhZ2VudCcsIHVzZXJBZ2VudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVSZWZlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlciA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdC5oZWFkZXJzWydyZWZlcmVyJ10gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWZlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZXJVcmwgPSB0cnlQYXJzZVVybChyZWZlcmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxvZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWZlcmVyVXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcXVlc3RVcmwgPSB0cnlQYXJzZVVybChtZXNzYWdlLmV2ZW50LnJlcXVlc3QudXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXF1ZXN0VXJsICYmIHJlcXVlc3RVcmwub3JpZ2luID09PSByZWZlcmVyVXJsLm9yaWdpbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb2cpIHJ0LnB1c2goY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKCdSZWZlcmVyJywgcmVmZXJlcikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICByZWNvbXB1dGVXZWxjb21lU2hvd2luZygpIHsKICAgICAgICBjb25zdCBzaG91bGRTaG93ID0gdGhpcy5wcm9maWxlcy5sZW5ndGggPT09IDA7CiAgICAgICAgaWYgKHNob3VsZFNob3cgPT09IHRoaXMud2VsY29tZVNob3dpbmcpIHJldHVybjsKICAgICAgICB0aGlzLnNldERlbW9Nb2RlKHNob3VsZFNob3cpOwogICAgICAgIHRoaXMud2VsY29tZVNob3dpbmcgPSBzaG91bGRTaG93OwogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZChuYW1lLCB2YWx1ZSkgewogICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBbCiAgICAgICAgICAgIGAgJWN8JWMgWyVjJHtuYW1lfSVjXSAke3ZhbHVlfWAsCiAgICAgICAgICAgICdjb2xvcjpncmF5JywKICAgICAgICAgICAgJycsCiAgICAgICAgICAgICdjb2xvcjpncmF5JwogICAgICAgIF0KICAgIH07Cn0KY2xhc3MgUHJvZmlsZUZvcm1WTSB7CiAgICBzaG93aW5nID0gZmFsc2U7CiAgICBlbmFibGVkID0gZmFsc2U7CiAgICBuYW1lID0gJyc7CiAgICBhY2NvdW50SWQgPSAnJzsKICAgIGFwaVRva2VuID0gJyc7CiAgICBkZWxldGVWaXNpYmxlID0gZmFsc2U7CiAgICBzYXZlRW5hYmxlZCA9IGZhbHNlOwogICAgcHJvZmlsZUlkID0gJyc7CiAgICB0aXRsZSA9ICcnOwogICAgcHJvZ3Jlc3NWaXNpYmxlID0gZmFsc2U7CiAgICBvdXRwdXRNZXNzYWdlID0gJyc7CiAgICBjb21wdXRlU2F2ZUVuYWJsZWQoKSB7CiAgICAgICAgdGhpcy5zYXZlRW5hYmxlZCA9IHRoaXMubmFtZS50cmltKCkubGVuZ3RoID4gMCAmJiB0aGlzLmFwaVRva2VuLnRyaW0oKS5sZW5ndGggPiAwICYmIHRoaXMuYWNjb3VudElkLnRyaW0oKS5sZW5ndGggPiAwOwogICAgfQp9CmNsYXNzIEZpbHRlckZvcm1WTSB7CiAgICBzaG93aW5nID0gZmFsc2U7CiAgICBlbmFibGVkID0gZmFsc2U7CiAgICBmaWVsZE5hbWUgPSAnJzsKICAgIGZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICBmaWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgZmllbGRWYWx1ZTsKICAgIGhlbHBUZXh0ID0gJyc7CiAgICBvdXRwdXRNZXNzYWdlID0gJyc7CiAgICBhcHBseVZhbHVlID0gKCk9PnsKICAgIH07Cn0KY29uc3QgRVhUUkFfRklFTERTX09QVElPTlMgPSBbCiAgICB7CiAgICAgICAgaWQ6ICdpcC1hZGRyZXNzJywKICAgICAgICB0ZXh0OiAnSVAgYWRkcmVzcycKICAgIH0sCiAgICB7CiAgICAgICAgaWQ6ICd1c2VyLWFnZW50JywKICAgICAgICB0ZXh0OiAnVXNlciBhZ2VudCcKICAgIH0sCiAgICB7CiAgICAgICAgaWQ6ICdyZWZlcmVyJywKICAgICAgICB0ZXh0OiAnUmVmZXJlcicKICAgIH0sIApdOwpjb25zdCBTVEFURV9LRVkgPSAnc3RhdGUxJzsKZnVuY3Rpb24gbG9hZFN0YXRlKCkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBqc29uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RBVEVfS0VZKSB8fCB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGpzb24pIHsKICAgICAgICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZShqc29uKTsKICAgICAgICAgICAgY29uc3QgcnQgPSBwYXJzZVN0YXRlKG9iaik7CiAgICAgICAgICAgIHJldHVybiBydDsKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdsb2FkU3RhdGU6IEVycm9yIGxvYWRpbmcgc3RhdGUnLCBlLnN0YWNrIHx8IGUpOwogICAgfQogICAgY29uc29sZS5sb2coJ2xvYWRTdGF0ZTogcmV0dXJuaW5nIG5ldyBzdGF0ZScpOwogICAgcmV0dXJuIHsKICAgICAgICBwcm9maWxlczogewogICAgICAgIH0KICAgIH07Cn0KZnVuY3Rpb24gcGFyc2VTdGF0ZShwYXJzZWQpIHsKICAgIGlmICh0eXBlb2YgcGFyc2VkICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBvYmplY3RgKTsKICAgIGNvbnN0IHsgcHJvZmlsZXMgIH0gPSBwYXJzZWQ7CiAgICBpZiAodHlwZW9mIHByb2ZpbGVzICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwcm9maWxlcyBvYmplY3RgKTsKICAgIGZvciAoY29uc3QgW3Byb2ZpbGVJZCwgcHJvZmlsZVN0YXRlXSBvZiBPYmplY3QuZW50cmllcyhwcm9maWxlcykpewogICAgICAgIGlmICh0eXBlb2YgcHJvZmlsZUlkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKCdQcm9maWxlIGlkIG11c3QgYmUgc3RyaW5nJyk7CiAgICAgICAgcGFyc2VQcm9maWxlU3RhdGUocHJvZmlsZVN0YXRlKTsKICAgIH0KICAgIHJldHVybiBwYXJzZWQ7Cn0KZnVuY3Rpb24gcGFyc2VQcm9maWxlU3RhdGUocGFyc2VkKSB7CiAgICBpZiAodHlwZW9mIHBhcnNlZCAhPT0gJ29iamVjdCcgfHwgcGFyc2VkID09PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2ZpbGUgc3RhdGUgbXVzdCBiZSBvYmplY3QnKTsKICAgIGNvbnN0IHsgbmFtZSAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcGFyc2VkOwogICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJyB8fCBuYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBuYW1lIG11c3QgZXhpc3RgKTsKICAgIGlmICh0eXBlb2YgYWNjb3VudElkICE9PSAnc3RyaW5nJyB8fCBhY2NvdW50SWQudHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIGFjY291bnRJZCBtdXN0IGV4aXN0YCk7CiAgICBpZiAodHlwZW9mIGFwaVRva2VuICE9PSAnc3RyaW5nJyB8fCBhcGlUb2tlbi50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgYXBpVG9rZW4gbXVzdCBleGlzdGApOwogICAgcmV0dXJuIHBhcnNlZDsKfQpmdW5jdGlvbiBzYXZlU3RhdGUoc3RhdGUpIHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUQVRFX0tFWSwgSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTsKfQphc3luYyBmdW5jdGlvbiBjb21wdXRlQ2FuTGlzdFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4pIHsKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbGlzdFRhaWxzKGFjY291bnRJZCwgJycsIGFwaVRva2VuKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIENsb3VkZmxhcmVBcGlFcnJvciAmJiBlLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQpmdW5jdGlvbiBpc1ZhbGlkU2FtcGxpbmdSYXRlKHNhbXBsaW5nUmF0ZSkgewogICAgcmV0dXJuICFpc05hTihzYW1wbGluZ1JhdGUpICYmIHNhbXBsaW5nUmF0ZSA+PSAwICYmIHNhbXBsaW5nUmF0ZSA8PSAxOwp9CmZ1bmN0aW9uIGNvbXB1dGVJbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZChzdGF0ZSwgcHJvZmlsZXMpIHsKICAgIGlmIChzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCAmJiBzdGF0ZS5wcm9maWxlc1tzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZF0pIHJldHVybiBzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZDsKICAgIGlmIChwcm9maWxlcy5sZW5ndGggPiAwKSByZXR1cm4gcHJvZmlsZXNbMF0uaWQ7CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpIHsKICAgIGNvbnN0IGZpbHRlcnMgPSBbXTsKICAgIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ2Vycm9yJykgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIG91dGNvbWU6IFsKICAgICAgICAgICAgICAgICdleGNlcHRpb24nLAogICAgICAgICAgICAgICAgJ2V4Y2VlZGVkQ3B1JywKICAgICAgICAgICAgICAgICdjYW5jZWxlZCcsCiAgICAgICAgICAgICAgICAndW5rbm93bicKICAgICAgICAgICAgXQogICAgICAgIH0pOwogICAgfSBlbHNlIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgb3V0Y29tZTogWwogICAgICAgICAgICAgICAgJ29rJwogICAgICAgICAgICBdCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLnNhbXBsaW5nUmF0ZTEgIT09IHVuZGVmaW5lZCAmJiBpc1ZhbGlkU2FtcGxpbmdSYXRlKGZpbHRlci5zYW1wbGluZ1JhdGUxKSAmJiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA8IDEpIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBzYW1wbGluZ19yYXRlOiBmaWx0ZXIuc2FtcGxpbmdSYXRlMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5zZWFyY2gxICE9PSB1bmRlZmluZWQgJiYgZmlsdGVyLnNlYXJjaDEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIHF1ZXJ5OiBmaWx0ZXIuc2VhcmNoMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5tZXRob2QxICYmIGZpbHRlci5tZXRob2QxLmxlbmd0aCA+IDApIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBtZXRob2Q6IGZpbHRlci5tZXRob2QxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLmlwQWRkcmVzczEgJiYgZmlsdGVyLmlwQWRkcmVzczEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIGNsaWVudF9pcDogZmlsdGVyLmlwQWRkcmVzczEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuaGVhZGVyMSAmJiBmaWx0ZXIuaGVhZGVyMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChjb25zdCBoZWFkZXIgb2YgZmlsdGVyLmhlYWRlcjEpewogICAgICAgICAgICBmaWx0ZXJzLnB1c2gocGFyc2VIZWFkZXJGaWx0ZXIoaGVhZGVyKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBmaWx0ZXJzCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UsIGZpbHRlcikgewogICAgaWYgKCFjb21wdXRlTWVzc2FnZVBhc3Nlc0xvZ1Byb3BGaWx0ZXIobWVzc2FnZSwgZmlsdGVyLmxvZ3Byb3AxKSkgcmV0dXJuIGZhbHNlOwogICAgaWYgKGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyB8fCBmaWx0ZXIuZXZlbnQxID09PSAnaHR0cCcpIHsKICAgICAgICBjb25zdCBpc0Nyb24gPSBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UpOwogICAgICAgIHJldHVybiBpc0Nyb24gJiYgZmlsdGVyLmV2ZW50MSA9PT0gJ2Nyb24nIHx8ICFpc0Nyb24gJiYgZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY29tcHV0ZU1lc3NhZ2VQYXNzZXNMb2dQcm9wRmlsdGVyKG1lc3NhZ2UsIGxvZ3Byb3AxKSB7CiAgICBpZiAobG9ncHJvcDEgPT09IHVuZGVmaW5lZCB8fCBsb2dwcm9wMS5sZW5ndGggPT09IDApIHJldHVybiB0cnVlOwogICAgY29uc3QgbG9ncHJvcEZpbHRlcnMgPSBsb2dwcm9wMS5tYXAocGFyc2VIZWFkZXJGaWx0ZXIpOwogICAgY29uc3QgeyBwcm9wcyAgfSA9IHBhcnNlTG9nUHJvcHMobWVzc2FnZS5sb2dzKTsKICAgIGZvciAoY29uc3QgbG9ncHJvcEZpbHRlciBvZiBsb2dwcm9wRmlsdGVycyl7CiAgICAgICAgaWYgKGNvbXB1dGVQcm9wc1Bhc3NMb2dwcm9wRmlsdGVyKHByb3BzLCBsb2dwcm9wRmlsdGVyKSkgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gY29tcHV0ZVByb3BzUGFzc0xvZ3Byb3BGaWx0ZXIocHJvcHMsIGxvZ3Byb3BGaWx0ZXIpIHsKICAgIGNvbnN0IHZhbCA9IHByb3BzW2xvZ3Byb3BGaWx0ZXIua2V5XTsKICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKGxvZ3Byb3BGaWx0ZXIucXVlcnkgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7CiAgICBjb25zdCBxID0gbG9ncHJvcEZpbHRlci5xdWVyeS50cmltKCkucmVwbGFjZUFsbCgvXCorL2csICcqJyk7CiAgICBpZiAoIXEuaW5jbHVkZXMoJyonKSkgcmV0dXJuIHEgPT09IHZhbDsKICAgIGlmIChxID09PSAnKicpIHJldHVybiB0cnVlOwogICAgaWYgKHR5cGVvZiB2YWwgIT09ICdzdHJpbmcnKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBwYXR0ZXJuID0gJ14nICsgZXNjYXBlRm9yUmVnZXgocSkucmVwbGFjZUFsbCgnXFwqJywgJy4qJykgKyAnJCc7CiAgICByZXR1cm4gbmV3IFJlZ0V4cChwYXR0ZXJuKS50ZXN0KHZhbCk7Cn0KZnVuY3Rpb24gZXNjYXBlRm9yUmVnZXgoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1stXC9cXF4kKis/LigpfFtcXXt9XS9nLCAnXFwkJicpOwp9CmZ1bmN0aW9uIGRpc3RpbmN0KHZhbHVlcykgewogICAgY29uc3QgcnQgPSBbXTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKXsKICAgICAgICBpZiAoIXJ0LmluY2x1ZGVzKHZhbHVlKSkgewogICAgICAgICAgICBydC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gdHJ5UGFyc2VVcmwodXJsKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKHVybCk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpjb25zdCBGSUxURVJfRURJVE9SX0hUTUwgPSBodG1sYAo8Zm9ybSBpZD0iZmlsdGVyLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJmaWx0ZXItZmllbGRzZXQiPgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0IGZvcm0tcm93Ij5FZGl0IGZpbHRlcjwvZGl2PgoKICA8bGFiZWwgaWQ9ImZpbHRlci1maWVsZC1sYWJlbCI+RmlsdGVyIGZpZWxkOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJmaWx0ZXItZmllbGQtdGV4dCIgdHlwZT0idGV4dCI+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLWNob2ljZSI+PC9kaXY+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLW9wdGlvbnMiPjwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1oZWxwIiBjbGFzcz0iYm9keTIgbWVkaXVtLWVtcGhhc2lzLXRleHQiPgogIDwvZGl2PiAgCgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLW91dHB1dC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8b3V0cHV0IGlkPSJmaWx0ZXItZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogIDwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1idXR0b25zIiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0iZmlsdGVyLWFwcGx5IiB0eXBlPSJzdWJtaXQiPkFwcGx5PC9idXR0b24+PCEtLSBmaXJzdCBzbyBpdCBpcyBkZWZhdWx0IGJ1dHRvbiBvbiByZXR1cm4gLS0+CiAgICA8YnV0dG9uIGlkPSJmaWx0ZXItY2FuY2VsIj5DYW5jZWw8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBGSUxURVJfRURJVE9SX0NTUyA9IGNzc2AKCiAgICAjZmlsdGVyLWZvcm0tYnV0dG9ucyB7CiAgICAgICAganVzdGlmeS1zZWxmOiBlbmQ7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtY2hvaWNlIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXB4OwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtb3B0aW9ucyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgZ2FwOiAxcHg7CiAgICB9CgogICAgI2ZpbHRlci1maWVsZC1vcHRpb25zIGJ1dHRvbiB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMC41cmVtOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1oZWxwIHsKICAgICAgICBncmlkLWNvbHVtbjogMjsKICAgIH0KCiAgICAjZmlsdGVyLWZvcm0tb3V0cHV0LXJvdyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMXJlbTsKICAgICAgICBtaW4taGVpZ2h0OiAyLjVyZW07CiAgICB9CgogICAgI2ZpbHRlci1mb3JtLW91dHB1dC1yb3cgb3V0cHV0IHsKICAgICAgICBmbGV4LWdyb3c6IDE7CiAgICB9CgpgOwpmdW5jdGlvbiBpbml0RmlsdGVyRWRpdG9yKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgZmlsdGVyRm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZm9ybScpOwogICAgY29uc3QgZmlsdGVyRmllbGRzZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkc2V0Jyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZExhYmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZC1sYWJlbCcpOwogICAgY29uc3QgZmlsdGVyRmllbGRUZXh0SW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLXRleHQnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkQ2hvaWNlRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZC1jaG9pY2UnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkT3B0aW9uc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtb3B0aW9ucycpOwogICAgY29uc3QgZmlsdGVyQ2FuY2VsQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1jYW5jZWwnKTsKICAgIGNvbnN0IGZpbHRlckFwcGx5QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1hcHBseScpOwogICAgY29uc3QgZmlsdGVyRm9ybU91dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZm9ybS1vdXRwdXQnKTsKICAgIGNvbnN0IGZpbHRlckZvcm1IZWxwRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtLWhlbHAnKTsKICAgIGZpbHRlckNhbmNlbEJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmNhbmNlbEZpbHRlcigpOwogICAgfTsKICAgIGZpbHRlckFwcGx5QnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgY29uc3QgdHlwZSA9IGNvbXB1dGVUeXBlKHZtKTsKICAgICAgICBpZiAodHlwZSA9PT0gJ3RleHQnKSB7CiAgICAgICAgICAgIHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpbHRlckZpZWxkVGV4dElucHV0LnZhbHVlOwogICAgICAgIH0KICAgICAgICB2bS5zYXZlRmlsdGVyKCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gZmlsdGVyRm9ybS5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7CiAgICAgICAgZmlsdGVyRm9ybS5zdHlsZS5kaXNwbGF5ID0gdm0uZmlsdGVyRm9ybS5zaG93aW5nID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBmaWx0ZXJGaWVsZHNldC5kaXNhYmxlZCA9ICF2bS5maWx0ZXJGb3JtLmVuYWJsZWQ7CiAgICAgICAgY29uc3QgdHlwZSA9IGNvbXB1dGVUeXBlKHZtKTsKICAgICAgICBmaWx0ZXJGaWVsZExhYmVsLnRleHRDb250ZW50ID0gdm0uZmlsdGVyRm9ybS5maWVsZE5hbWU7CiAgICAgICAgZmlsdGVyRmllbGRMYWJlbC5odG1sRm9yID0gdHlwZSA9PSAnY2hvaWNlJyA/IGZpbHRlckZpZWxkQ2hvaWNlRGl2LmlkIDogdHlwZSA9PSAnb3B0aW9ucycgPyBmaWx0ZXJGaWVsZE9wdGlvbnNEaXYuaWQgOiBmaWx0ZXJGaWVsZFRleHRJbnB1dC5pZDsKICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5zdHlsZS5kaXNwbGF5ID0gdHlwZSA9PSAndGV4dCcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGZpbHRlckZpZWxkQ2hvaWNlRGl2LnN0eWxlLmRpc3BsYXkgPSB0eXBlID09ICdjaG9pY2UnID8gJ2ZsZXgnIDogJ25vbmUnOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKENIT0lDRVNfSFRNTCh2bSksIGZpbHRlckZpZWxkQ2hvaWNlRGl2KTsKICAgICAgICBmaWx0ZXJGaWVsZE9wdGlvbnNEaXYuc3R5bGUuZGlzcGxheSA9IHR5cGUgPT0gJ29wdGlvbnMnID8gJ2ZsZXgnIDogJ25vbmUnOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKE9QVElPTlNfSFRNTCh2bSksIGZpbHRlckZpZWxkT3B0aW9uc0Rpdik7CiAgICAgICAgZmlsdGVyRm9ybUhlbHBEaXYudGV4dENvbnRlbnQgPSB2bS5maWx0ZXJGb3JtLmhlbHBUZXh0OwogICAgICAgIGZpbHRlckZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bS5maWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2U7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiB2bS5maWx0ZXJGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2ZpbHRlciBmb3JtIG9wZW4nKTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd0ZXh0JyAmJiB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUpIGZpbHRlckZpZWxkVGV4dElucHV0LnZhbHVlID0gdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5mb2N1cygpOwogICAgICAgICAgICAgICAgZmlsdGVyRmllbGRUZXh0SW5wdXQuc2VsZWN0KCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZVR5cGUodm0pIHsKICAgIHJldHVybiB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmxlbmd0aCA+IDAgPyAnY2hvaWNlJyA6IHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMubGVuZ3RoID8gJ29wdGlvbnMnIDogJ3RleHQnOwp9CmNvbnN0IENIT0lDRVNfSFRNTCA9ICh2bSk9PnsKICAgIHJldHVybiB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLm1hcCgoY2hvaWNlKT0+aHRtbGA8YnV0dG9uIGNsYXNzPSIke2Nob2ljZS5pZCA9PT0gdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlID8gJ3NlbGVjdGVkJyA6ICcnfSIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdm0uc2VsZWN0RmlsdGVyQ2hvaWNlKGNob2ljZS5pZCk7CiAgICAgICAgfX0gP2Rpc2FibGVkPSIkeyF2bS5maWx0ZXJGb3JtLnNob3dpbmd9Ij4ke2Nob2ljZS50ZXh0fTwvYnV0dG9uPmAKICAgICk7Cn07CmNvbnN0IE9QVElPTlNfSFRNTCA9ICh2bSk9PnsKICAgIHJldHVybiB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zLm1hcCgob3B0aW9uKT0+ewogICAgICAgIGNvbnN0IHNlbGVjdGVkID0gZmllbGRWYWx1ZVNldCh2bSkuaGFzKG9wdGlvbi5pZCk7CiAgICAgICAgcmV0dXJuIGh0bWxgPGJ1dHRvbiBjbGFzcz0iJHtzZWxlY3RlZCA/ICdzZWxlY3RlZCcgOiAnJ30iIEBjbGljaz0keyhlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtLnRvZ2dsZUZpbHRlck9wdGlvbihvcHRpb24uaWQpOwogICAgICAgIH19ID9kaXNhYmxlZD0iJHshdm0uZmlsdGVyRm9ybS5zaG93aW5nfSI+JHtzZWxlY3RlZCA/IENIRUNLX0JPWF9DSEVDS0VEX0lDT04gOiBDSEVDS19CT1hfVU5DSEVDS0VEX0lDT059ICR7b3B0aW9uLnRleHR9PC9idXR0b24+YDsKICAgIH0pOwp9OwpmdW5jdGlvbiBmaWVsZFZhbHVlU2V0KHZtKSB7CiAgICByZXR1cm4gbmV3IFNldCgodm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICApLmZpbHRlcigodik9PnYubGVuZ3RoID4gMAogICAgKSk7Cn0KY29uc3QgUFJPRklMRV9FRElUT1JfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJwcm9maWxlLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJwcm9maWxlLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQgZm9ybS1yb3ciPlByb2ZpbGU8L2Rpdj4KCiAgPGxhYmVsIGZvcj0icHJvZmlsZS1uYW1lIj5Qcm9maWxlIG5hbWU6PC9sYWJlbD4KICA8aW5wdXQgaWQ9InByb2ZpbGUtbmFtZSIgdHlwZT0idGV4dCI+CgogIDxsYWJlbCBmb3I9ImFjY291bnQtaWQiPkNsb3VkZmxhcmUgQWNjb3VudCBJRDo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hY2NvdW50LWlkIiB0eXBlPSJ0ZXh0Ij4KCiAgPGxhYmVsIGZvcj0iYXBpLXRva2VuIj5DbG91ZGZsYXJlIEFQSSBUb2tlbjo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hcGktdG9rZW4iIHR5cGU9InRleHQiPgoKICA8ZGV0YWlscyBpZD0icHJvZmlsZS1mb3JtLWhlbHAtcm93IiBjbGFzcz0iZm9ybS1yb3ciPgogICAgPHN1bW1hcnk+VXNlIGEgPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJpbmNpcGxlX29mX2xlYXN0X3ByaXZpbGVnZSIgdGFyZ2V0PSJfYmxhbmsiPmxlYXN0IHByaXZpbGVnZTwvYT4gdG9rZW4gd2l0aCBwZXJtaXNzaW9uOiA8Y29kZT5BY2NvdW50ICZndDsgV29ya2VycyBUYWlsICZndDsgUmVhZDwvY29kZT48L3N1bW1hcnk+CiAgICA8b2w+CiAgICAgICAgPGxpPlNlbGVjdCA8c3BhbiBjbGFzcz0iY2YtYnV0dG9uIj5DcmVhdGUgVG9rZW48L3NwYW4+IG9uIHlvdXIgQ2xvdWRmbGFyZSA8YSBocmVmPSJodHRwczovL2Rhc2guY2xvdWRmbGFyZS5jb20vcHJvZmlsZS9hcGktdG9rZW5zIiB0YXJnZXQ9Il9ibGFuayI+QVBJIFRva2VuczwvYT4gcGFnZS48L2xpPgogICAgICAgIDxsaT5TY3JvbGwgZG93biB0byA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+Q3JlYXRlIEN1c3RvbSBUb2tlbjwvc3Bhbj4sIHRoZW4gPHNwYW4gY2xhc3M9ImNmLWJ1dHRvbiI+R2V0IHN0YXJ0ZWQ8L3NwYW4+PC9saT4KICAgICAgICA8bGk+VW5kZXIgPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPlBlcm1pc3Npb25zPC9zcGFuPiwgZ3JhbnQgeW91ciB0b2tlbiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+QWNjb3VudDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPldvcmtlcnMgVGFpbDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPlJlYWQ8L3NwYW4+PC9saT4KICAgIDwvb2w+CiAgPC9kZXRhaWxzPiAgCgogIDxkaXYgaWQ9InByb2ZpbGUtZm9ybS1vdXRwdXQtcm93IiBjbGFzcz0iZm9ybS1yb3ciPgogICAgPG91dHB1dCBpZD0icHJvZmlsZS1mb3JtLW91dHB1dCI+PC9vdXRwdXQ+CiAgICA8cHJvZ3Jlc3MgaWQ9InByb2ZpbGUtZm9ybS1wcm9ncmVzcyIgY2xhc3M9InB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIiPjwvcHJvZ3Jlc3M+CiAgPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tbGhzIj4KICAgIDxidXR0b24gaWQ9InByb2ZpbGUtZGVsZXRlIj5EZWxldGU8L2J1dHRvbj4KICA8L2Rpdj4KICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tYnV0dG9ucyIgY2xhc3M9ImZvcm0tcmhzIj4KICAgIDxidXR0b24gaWQ9InByb2ZpbGUtY2FuY2VsIj5DYW5jZWw8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9InByb2ZpbGUtc2F2ZSI+U2F2ZTwvYnV0dG9uPgogIDwvZGl2Pgo8L2ZpZWxkc2V0Pgo8L2Zvcm0+CmA7CmNvbnN0IFBST0ZJTEVfRURJVE9SX0NTUyA9IGNzc2AKCiAgICAjcHJvZmlsZS1mb3JtLWJ1dHRvbnMgewogICAgICAgIGp1c3RpZnktc2VsZjogZW5kOwogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgewogICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IHN1bW1hcnkgewogICAgICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgb2wgewogICAgICAgIGN1cnNvcjogZGVmYXVsdDsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IGxpIHsKICAgICAgICBwYWRkaW5nOiAwLjVyZW0gMDsKICAgIH0KCiAgICAuY2YtYnV0dG9uIHsKICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogYmx1ZTsKICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgcGFkZGluZzogMC4yNXJlbSAwLjVyZW07CiAgICAgICAgYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICAgIH0KCiAgICAuY2Ytc2VjdGlvbiB7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgICBwYWRkaW5nOiAwLjI1cmVtIDAuNXJlbTsKICAgICAgICBvdXRsaW5lOiBzb2xpZCAxcHggZ3JheTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLW91dHB1dC1yb3cgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBnYXA6IDFyZW07CiAgICAgICAgbWluLWhlaWdodDogMi41cmVtOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyBvdXRwdXQgewogICAgICAgIGZsZXgtZ3JvdzogMTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLXByb2dyZXNzIHsKICAgICAgICBmb250LXNpemU6IDAuNXJlbTsgLyogZGVmYXVsdCAzZW0gPT4gMS41cmVtICovCiAgICB9CgpgOwpmdW5jdGlvbiBpbml0UHJvZmlsZUVkaXRvcihkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHByb2ZpbGVGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1UaXRsZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tdGl0bGUnKTsKICAgIGNvbnN0IHByb2ZpbGVGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZpZWxkc2V0Jyk7CiAgICBjb25zdCBwcm9maWxlTmFtZUlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtbmFtZScpOwogICAgY29uc3QgcHJvZmlsZUFjY291bnRJZElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtYWNjb3VudC1pZCcpOwogICAgY29uc3QgcHJvZmlsZUFwaVRva2VuSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1hcGktdG9rZW4nKTsKICAgIGNvbnN0IHByb2ZpbGVEZWxldGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1kZWxldGUnKTsKICAgIGNvbnN0IHByb2ZpbGVDYW5jZWxCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1jYW5jZWwnKTsKICAgIGNvbnN0IHByb2ZpbGVTYXZlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtc2F2ZScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1Qcm9ncmVzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tcHJvZ3Jlc3MnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1vdXRwdXQnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtSGVscERldGFpbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLWhlbHAtcm93Jyk7CiAgICBwcm9maWxlQ2FuY2VsQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uY2FuY2VsUHJvZmlsZSgpOwogICAgfTsKICAgIHByb2ZpbGVOYW1lSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0uc2V0UHJvZmlsZU5hbWUocHJvZmlsZU5hbWVJbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZUFjY291bnRJZElucHV0Lm9uaW5wdXQgPSAoKT0+ewogICAgICAgIHZtLnNldFByb2ZpbGVBY2NvdW50SWQocHJvZmlsZUFjY291bnRJZElucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bS5zZXRQcm9maWxlQXBpVG9rZW4ocHJvZmlsZUFwaVRva2VuSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVTYXZlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uc2F2ZVByb2ZpbGUoKTsKICAgIH07CiAgICBwcm9maWxlRGVsZXRlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZGVsZXRlUHJvZmlsZSh2bS5wcm9maWxlRm9ybS5wcm9maWxlSWQpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0hpZGRlbiA9IHByb2ZpbGVGb3JtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJzsKICAgICAgICBwcm9maWxlRm9ybS5zdHlsZS5kaXNwbGF5ID0gdm0ucHJvZmlsZUZvcm0uc2hvd2luZyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZUZpZWxkc2V0LmRpc2FibGVkID0gIXZtLnByb2ZpbGVGb3JtLmVuYWJsZWQ7CiAgICAgICAgcHJvZmlsZUZvcm1UaXRsZURpdi50ZXh0Q29udGVudCA9IHZtLnByb2ZpbGVGb3JtLnRpdGxlOwogICAgICAgIHByb2ZpbGVOYW1lSW5wdXQudmFsdWUgPSB2bS5wcm9maWxlRm9ybS5uYW1lOwogICAgICAgIHByb2ZpbGVBY2NvdW50SWRJbnB1dC52YWx1ZSA9IHZtLnByb2ZpbGVGb3JtLmFjY291bnRJZDsKICAgICAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSA9IHZtLnByb2ZpbGVGb3JtLmFwaVRva2VuOwogICAgICAgIHByb2ZpbGVEZWxldGVCdXR0b24uc3R5bGUuZGlzcGxheSA9IHZtLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPyAnaW5saW5lLWJsb2NrJyA6ICdub25lJzsKICAgICAgICBwcm9maWxlU2F2ZUJ1dHRvbi5kaXNhYmxlZCA9ICF2bS5wcm9maWxlRm9ybS5zYXZlRW5hYmxlZDsKICAgICAgICBwcm9maWxlRm9ybVByb2dyZXNzLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVGb3JtT3V0cHV0LnRleHRDb250ZW50ID0gdm0ucHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZTsKICAgICAgICBpZiAod2FzSGlkZGVuICYmIHZtLnByb2ZpbGVGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc3QgaW5pdGlhbERldGFpbHNPcGVuID0gdm0ucmVhbFByb2ZpbGVzLmxlbmd0aCA9PT0gMDsKICAgICAgICAgICAgcHJvZmlsZUZvcm1IZWxwRGV0YWlscy5vcGVuID0gaW5pdGlhbERldGFpbHNPcGVuOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LnNlbGVjdCgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IFdFTENPTUVfUEFORUxfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJ3ZWxjb21lLXBhbmVsIiBhdXRvY29tcGxldGU9Im9mZiI+CjxmaWVsZHNldCBpZD0id2VsY29tZS1wYW5lbC1maWVsZHNldCI+CiAgPGRpdiBpZD0id2VsY29tZS1wYW5lbC1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0IGZvcm0tcm93Ij50aXRsZTwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmb3JtLXJvdyBib2R5MiBtZWRpdW0tZW1waGFzaXMtdGV4dCI+CiAgICBXZWxjb21lIHRvIDxzcGFuIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPldlYnRhaWwgZm9yIENsb3VkZmxhcmUgV29ya2Vyczwvc3Bhbj4hCiAgICA8cD5WaWV3IGxpdmUgcmVxdWVzdHMgYW5kIGxvZ3MgZnJvbSA8YSBocmVmPSJodHRwczovL3dvcmtlcnMuY2xvdWRmbGFyZS5jb20vIiB0YXJnZXQ9Il9ibGFuayI+Q2xvdWRmbGFyZSBXb3JrZXJzPC9hPiBmcm9tIHRoZSBjb21mb3J0IG9mIHlvdXIgYnJvd3Nlci4gCiAgICBBIGZldyBlbmhhbmNlbWVudHMgb3ZlciB3aGF0J3MgcHJvdmlkZWQgPGEgaHJlZj0iaHR0cHM6Ly9ibG9nLmNsb3VkZmxhcmUuY29tL2ludHJvZHVjaW5nLXdvcmtlcnMtZGFzaGJvYXJkLWxvZ3MvIiB0YXJnZXQ9Il9ibGFuayI+YnkgZGVmYXVsdDwvYT4gaW4gdGhlIENsb3VkZmxhcmUgZGFzaGJvYXJkOjwvcD4KICAgIDx1bD4KICAgICAgICA8bGk+VGFpbCBtdWx0aXBsZSB3b3JrZXJzIGF0IHRoZSBzYW1lIHRpbWU8L2xpPgogICAgICAgIDxsaT5BZHZhbmNlZCBmaWx0ZXJpbmcgYW5kIG11bHRpLWNvbG9yIG91dHB1dCBzaW1pbGFyIHRvIDxhIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVycy5jbG91ZGZsYXJlLmNvbS93b3JrZXJzL2NsaS13cmFuZ2xlci9jb21tYW5kcyN0YWlsIiB0YXJnZXQ9Il9ibGFuayI+d3JhbmdsZXIgdGFpbDwvYT48L2xpPgogICAgICAgIDxsaT5EdXJhYmxlIG9iamVjdCBjbGFzcy9uYW1lL2lkIGFuZCBjb2xvIGluZm9ybWF0aW9uIGNhbiBiZSBzdXJmYWNlZCB3aXRoIDxhIGhyZWY9Imh0dHBzOi8vZGVub2ZsYXJlLmRldi9leGFtcGxlcy93ZWJ0YWlsI2xvZ3Byb3BzIiB0YXJnZXQ9Il9ibGFuayI+bG9ncHJvcHM8L2E+PC9saT4KICAgICAgICA8bGk+TXVsdGlwbGUgcHJvZmlsZXMsIHN3aXRjaCBlYXNpbHkgYmV0d2VlbiBtdWx0aXBsZSBhY2NvdW50czwvbGk+CiAgICAgICAgPGxpPk5vIG5lZWQgdG8gbG9nIGluIHdpdGggeW91ciBmdWxsIENsb3VkZmxhcmUgY3JlZGVudGlhbHMuICBQcm9maWxlcyBhcmUgc3RvcmVkIGxvY2FsbHkgaW4gdGhlIGJyb3dzZXIsIGFuZCBjYW4gYmUgcGVybWlzc2lvbmVkIG9ubHkgZm9yIHRhaWxpbmcgd29ya2VyczwvbGk+CiAgICAgICAgPGxpPkltcGxlbWVudGVkIGFzIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlL3RyZWUvbWFzdGVyL2V4YW1wbGVzL3dlYnRhaWwtd29ya2VyIiB0YXJnZXQ9Il9ibGFuayI+YW4gb3Blbi1zb3VyY2UgQ2xvdWRmbGFyZSBXb3JrZXI8L2E+LCAKICAgICAgICAgICA8YSBocmVmPSJodHRwczovL2Rlbm9mbGFyZS5kZXYvZXhhbXBsZXMvd2VidGFpbCNkZXBsb3ktaXQtdG8teW91ci1vd24tYWNjb3VudCIgdGFyZ2V0PSJfYmxhbmsiPmRlcGxveSBpdCB0byB5b3VyIG93biBhY2NvdW50PC9hPiwgCiAgICAgICAgICAgIG9yIDxhIGhyZWY9Imh0dHBzOi8vZGVub2ZsYXJlLmRldi9leGFtcGxlcy93ZWJ0YWlsI2hvc3QtaXQtbG9jYWxseSIgdGFyZ2V0PSJfYmxhbmsiPmhvc3QgaXQgbG9jYWxseTwvYT4gd2l0aCA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiPjxjb2RlPmRlbm9mbGFyZTwvY29kZT48L2E+PC9saT4KICAgIDwvdWw+CiAgICA8cCBpZD0id2VsY29tZS1wYW5lbC10cmFpbGVyIj5DcmVhdGUgYSBuZXcgcHJvZmlsZSB0byBnZXQgc3RhcnRlZCE8L3A+CiAgICA8cCBpZD0iYWJvdXQtcGFuZWwtdHJhaWxlciI+SGVhZCBvdmVyIHRvIHRoZSA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiPkRlbm9mbGFyZSBHaXRIdWIgcmVwbzwvYT4gdG8gcmVxdWVzdCBmZWF0dXJlcywgcmVwb3J0IGJ1Z3MsIG9yIGNoZWNrIG91dCB0aGUgY29kZSE8L3A+CiAgPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tcmhzIj4KICAgIDxidXR0b24gaWQ9IndlbGNvbWUtcGFuZWwtbmV3LXByb2ZpbGUiIHR5cGU9InN1Ym1pdCI+TmV3IHByb2ZpbGU8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9IndlbGNvbWUtcGFuZWwtY2xvc2UiIHR5cGU9InN1Ym1pdCI+Q2xvc2U8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBXRUxDT01FX1BBTkVMX0NTUyA9IGNzc2AKCiAgICAjd2VsY29tZS1wYW5lbC1mb3JtLXRpdGxlIHsKICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRXZWxjb21lUGFuZWwoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCB3ZWxjb21lUGFuZWxFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwnKTsKICAgIGNvbnN0IHRpdGxlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWxjb21lLXBhbmVsLWZvcm0tdGl0bGUnKTsKICAgIGNvbnN0IHdlbGNvbWVUcmFpbGVyRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWxjb21lLXBhbmVsLXRyYWlsZXInKTsKICAgIGNvbnN0IGFib3V0VHJhaWxlckVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWJvdXQtcGFuZWwtdHJhaWxlcicpOwogICAgY29uc3QgbmV3UHJvZmlsZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWxjb21lLXBhbmVsLW5ldy1wcm9maWxlJyk7CiAgICBjb25zdCBjbG9zZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWxjb21lLXBhbmVsLWNsb3NlJyk7CiAgICBuZXdQcm9maWxlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0ubmV3UHJvZmlsZSgpOwogICAgfTsKICAgIGNsb3NlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uY2xvc2VBYm91dCgpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0hpZGRlbiA9IHdlbGNvbWVQYW5lbEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIGNvbnN0IHNob3cgPSB2bS53ZWxjb21lU2hvd2luZyAmJiAhdm0ucHJvZmlsZUZvcm0uc2hvd2luZyB8fCB2bS5hYm91dFNob3dpbmc7CiAgICAgICAgd2VsY29tZVBhbmVsRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgY29uc3Qgd2VsY29tZSA9IHZtLndlbGNvbWVTaG93aW5nOwogICAgICAgIHRpdGxlRWxlbWVudC50ZXh0Q29udGVudCA9IHdlbGNvbWUgPyAnSGVsbG8g8J+RiycgOiAnQWJvdXQnOwogICAgICAgIHdlbGNvbWVUcmFpbGVyRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gd2VsY29tZSA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgYWJvdXRUcmFpbGVyRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gd2VsY29tZSA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgbmV3UHJvZmlsZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gd2VsY29tZSA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgY2xvc2VCdXR0b24uc3R5bGUuZGlzcGxheSA9IHdlbGNvbWUgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgIGlmICh3YXNIaWRkZW4gJiYgc2hvdykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt3ZWxjb21lID8gJ3dlbGNvbWUnIDogJ2Fib3V0J30gcGFuZWwgb3BlbmApOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICAod2VsY29tZSA/IG5ld1Byb2ZpbGVCdXR0b24gOiBjbG9zZUJ1dHRvbikuZm9jdXMoKTsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBNT0RBTF9IVE1MID0gaHRtbGAKPGRpdiBpZD0ibW9kYWwiIGNsYXNzPSJtb2RhbCBoaWRkZW4tdmVydGljYWwtc2Nyb2xsIj4KICAgIDxkaXYgY2xhc3M9Im1vZGFsLWNvbnRlbnQiPgogICAgJHtXRUxDT01FX1BBTkVMX0hUTUx9CiAgICAke1BST0ZJTEVfRURJVE9SX0hUTUx9CiAgICAke0ZJTFRFUl9FRElUT1JfSFRNTH0KICAgIDwvZGl2Pgo8L2Rpdj4KYDsKY29uc3QgTU9EQUxfQ1NTID0gY3NzYAoubW9kYWwgewogICAgZGlzcGxheTogbm9uZTsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIHotaW5kZXg6IDE7CiAgICBsZWZ0OiAwOwogICAgdG9wOiAwOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuNCk7Cn0KCi5tb2RhbC1jb250ZW50IHsKICAgIG1hcmdpbjogMTAlIGF1dG87CiAgICB3aWR0aDogODAlOwogICAgbWF4LXdpZHRoOiA0MHJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwp9CgpAbWVkaWEgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA2MDBweCkgewogICAgLm1vZGFsLWNvbnRlbnQgewogICAgICAgIG1hcmdpbjogMTAlIDA7CiAgICAgICAgd2lkdGg6IDEwMCU7CiAgICB9Cn0KCmA7CmZ1bmN0aW9uIGluaXRNb2RhbChkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsJyk7CiAgICBjb25zdCB1cGRhdGVQcm9maWxlRWRpdG9yID0gaW5pdFByb2ZpbGVFZGl0b3IoZG9jdW1lbnQsIHZtKTsKICAgIGNvbnN0IHVwZGF0ZUZpbHRlckVkaXRvciA9IGluaXRGaWx0ZXJFZGl0b3IoZG9jdW1lbnQsIHZtKTsKICAgIGNvbnN0IHVwZGF0ZVdlbGNvbWVQYW5lbCA9IGluaXRXZWxjb21lUGFuZWwoZG9jdW1lbnQsIHZtKTsKICAgIGNvbnN0IGNsb3NlTW9kYWwgPSAoKT0+ewogICAgICAgIGlmICghdm0ucHJvZmlsZUZvcm0uc2hvd2luZyAmJiAhdm0uZmlsdGVyRm9ybS5zaG93aW5nICYmICF2bS53ZWxjb21lU2hvd2luZyAmJiAhdm0uYWJvdXRTaG93aW5nKSByZXR1cm47CiAgICAgICAgaWYgKHZtLnByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSkgcmV0dXJuOwogICAgICAgIHZtLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bS5maWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bS5hYm91dFNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bS5vbkNoYW5nZSgpOwogICAgfTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudCk9PnsKICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09IG1vZGFsKSB7CiAgICAgICAgICAgIGNsb3NlTW9kYWwoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZXZlbnQpPT57CiAgICAgICAgZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7CiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gJ0VzY2FwZScpIHsKICAgICAgICAgICAgY2xvc2VNb2RhbCgpOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgdXBkYXRlUHJvZmlsZUVkaXRvcigpOwogICAgICAgIHVwZGF0ZUZpbHRlckVkaXRvcigpOwogICAgICAgIHVwZGF0ZVdlbGNvbWVQYW5lbCgpOwogICAgICAgIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5zaG93aW5nIHx8IHZtLmZpbHRlckZvcm0uc2hvd2luZyB8fCB2bS53ZWxjb21lU2hvd2luZyB8fCB2bS5hYm91dFNob3dpbmcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgfTsKfQpjb25zdCBDSVJDVUxBUl9QUk9HUkVTU19DU1MgPSBjc3NgCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgIC1tb3otYXBwZWFyYW5jZTogbm9uZTsKICAgIGFwcGVhcmFuY2U6IG5vbmU7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcGFkZGluZzogMC4yNWVtOwogICAgd2lkdGg6IDNlbTsKICAgIGhlaWdodDogM2VtOwogICAgY29sb3I6IHZhcigtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2IsIHJnYigzMywgMTUwLCAyNDMpKTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZm9udC1zaXplOiAxNnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6Oi13ZWJraXQtcHJvZ3Jlc3MtYmFyIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50Owp9CgovKiBJbmRldGVybWluYXRlICovCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGUgewogICAgLXdlYmtpdC1tYXNrLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpLCBsaW5lYXItZ3JhZGllbnQodG8gcmlnaHQsIHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKTsKICAgIG1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIDZzIGluZmluaXRlIGN1YmljLWJlemllcigwLjMsIDAuNiwgMSwgMSk7Cn0KCjotbXMtbGFuZyh4KSwgLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICBhbmltYXRpb246IG5vbmU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6OmJlZm9yZSwKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6LXdlYmtpdC1wcm9ncmVzcy12YWx1ZSB7CiAgICBjb250ZW50OiAiIjsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIG1hcmdpbi1ib3R0b206IDAuMjVlbTsKICAgIGJvcmRlcjogc29saWQgMC4yNWVtIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogY3VycmVudENvbG9yOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgd2lkdGg6IDEwMCUgIWltcG9ydGFudDsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbW96LXByb2dyZXNzLWJhciB7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbXMtZmlsbCB7CiAgICBhbmltYXRpb24tbmFtZTogLW1zLXJpbmc7Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7CiAgICB9CiAgICAxMi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAyNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDYzMGRlZyk7CiAgICB9CiAgICAzNy41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoODEwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICA1MCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDEyNjBkZWcpOwogICAgfQogICAgNjIuNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDE0NDBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDc1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTg5MGRlZyk7CiAgICB9CiAgICA4Ny41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjA3MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgMTAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjUyMGRlZyk7CiAgICB9Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhci1wc2V1ZG8gewogICAgMCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKC0zMGRlZyk7CiAgICB9CiAgICAyOS40JSB7CiAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgMjkuNDElIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgfQogICAgNjQuNyUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgNjQuNzElIHsKICAgICAgICBib3JkZXItYm90dG9tLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMjVkZWcpOwogICAgfQp9CmA7CmNvbnN0IENPTlNPTEVfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9ImNvbnNvbGUiPgogICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXIiPgogICAgICAgIDxkaXYgaWQ9ImNvbnNvbGUtaGVhZGVyLWZpbHRlcnMiIGNsYXNzPSJib2R5MiI+PC9kaXY+CiAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItc3RhdHVzIj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItdGFpbHMiIGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCI+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgaWQ9ImNvbnNvbGUtaGVhZGVyLXFwcyIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItY2xlYXIiPjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8Y29kZSBpZD0iY29uc29sZS1sYXN0LWxpbmUiIGNsYXNzPSJsaW5lIj5zcGFjZXI8L2NvZGU+CjwvZGl2PgpgOwpjb25zdCBDT05TT0xFX0NTUyA9IGNzc2AKCiNjb25zb2xlIHsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgaGVpZ2h0OiAxMDB2aDsKICAgIHdpZHRoOiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7CiAgICBvdmVyZmxvdy14OiBoaWRkZW47CiAgICBmbGV4LWdyb3c6IDE7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICB3aWR0aDogMXJlbTsKICAgIGhlaWdodDogM3JlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwp9CgojY29uc29sZTo6LXdlYmtpdC1zY3JvbGxiYXItdGh1bWIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgojY29uc29sZS1oZWFkZXIgewogICAgcG9zaXRpb246IHN0aWNreTsKICAgIHRvcDogMDsKICAgIGhlaWdodDogMy43NXJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgZGlzcGxheTogZmxleDsKICAgIHBhZGRpbmc6IDEuMjVyZW0gMXJlbSAxcmVtIDA7Cn0KCiNjb25zb2xlLWhlYWRlci1maWx0ZXJzIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBmb250LWZhbWlseTogdmFyKC0tc2Fucy1zZXJpZi1mb250LWZhbWlseSk7CgogICAgZGlzcGxheTogLXdlYmtpdC1ib3g7CiAgICAtd2Via2l0LWxpbmUtY2xhbXA6IDM7CiAgICAtd2Via2l0LWJveC1vcmllbnQ6IHZlcnRpY2FsOyAgCiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY29uc29sZS1oZWFkZXItc3RhdHVzIHsKICAgIGhlaWdodDogMXJlbTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgbWluLXdpZHRoOiA2cmVtOwogICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICBwYWRkaW5nLXRvcDogMC4yNXJlbTsKICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwp9CgojY29uc29sZS1oZWFkZXItdGFpbHMgewogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKfQoKI2NvbnNvbGUtaGVhZGVyLWNsZWFyIHsKICAgIG1hcmdpbi1yaWdodDogLTAuNXJlbTsKICAgIG1hcmdpbi1sZWZ0OiAxcmVtOwogICAgdmlzaWJpbGl0eTogaGlkZGVuOwp9CgojY29uc29sZS1oZWFkZXItY2xlYXIgLmFjdGlvbi1pY29uIHsKICAgIHBhZGRpbmctcmlnaHQ6IDAuNXJlbTsKICAgIHBhZGRpbmctbGVmdDogMC41cmVtOwp9CgojY29uc29sZSAubGluZSB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsgLyogMTJweCAqLwogICAgbGluZS1oZWlnaHQ6IDEuMXJlbTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1tb25vc3BhY2UtZm9udC1mYW1pbHkpOwogICAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgojY29uc29sZS1sYXN0LWxpbmUgewogICAgdmlzaWJpbGl0eTogaGlkZGVuOwp9CgpgOwpmdW5jdGlvbiBpbml0Q29uc29sZShkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IGNvbnNvbGVEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZScpOwogICAgY29uc3QgY29uc29sZUhlYWRlckZpbHRlcnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItZmlsdGVycycpOwogICAgY29uc3QgY29uc29sZUhlYWRlclRhaWxzRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci10YWlscycpOwogICAgY29uc3QgY29uc29sZUhlYWRlclFwc0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItcXBzJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLWNsZWFyJyk7CiAgICBjb25zdCBjb25zb2xlTGFzdExpbmVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtbGFzdC1saW5lJyk7CiAgICBsZXQgc2hvd2luZ0NsZWFyQnV0dG9uID0gZmFsc2U7CiAgICB2bS5sb2dnZXIgPSAoLi4uZGF0YSk9PnsKICAgICAgICBjb25zdCBsaW5lRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NvZGUnKTsKICAgICAgICBsaW5lRWxlbWVudC5jbGFzc05hbWUgPSAnbGluZSc7CiAgICAgICAgbGV0IHBvcyA9IDA7CiAgICAgICAgd2hpbGUocG9zIDwgZGF0YS5sZW5ndGgpewogICAgICAgICAgICBpZiAocG9zID4gMCkgewogICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJywgJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGRhdGFbcG9zXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0b2tlbnMgPSBtc2cuc3BsaXQoJyVjJyk7CiAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgICAgICAgICAgICAgICAgIGxldCByZW5kZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChpID4gMCAmJiBpIDwgdG9rZW5zLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkYXRhW3BvcyArIGldOwogICAgICAgICAgICAgICAgICAgICAgICBzcGFuLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCBzdHlsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3R5bGUuaW5jbHVkZXMoJ3gtJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtID0gL3gtZHVyYWJsZS1vYmplY3QtKGNsYXNzfG5hbWV8aWQpXHMqOlxzKicoLio/KScvLmV4ZWMoc3R5bGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBtWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG1bMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvZ3Byb3BOYW1lID0gJ2R1cmFibGVPYmplY3QnICsgdHlwZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHR5cGUuc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmhyZWYgPSAnIyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEub25jbGljayA9ICgpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bS5zZXRMb2dwcm9wRmlsdGVyKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dwcm9wTmFtZSArICc6JyArIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodG9rZW5zW2ldKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZW5kZXJlZCkgcmVuZGVyVGV4dEludG9TcGFuKHRva2Vuc1tpXSwgc3Bhbik7CiAgICAgICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb3MgKz0gMSArIHRva2Vucy5sZW5ndGggLSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoSlNPTi5zdHJpbmdpZnkobXNnKSkpOwogICAgICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc29sZURpdi5pbnNlcnRCZWZvcmUobGluZUVsZW1lbnQsIGNvbnNvbGVMYXN0TGluZUVsZW1lbnQpOwogICAgICAgIGNvbnN0IHsgc2Nyb2xsSGVpZ2h0ICwgc2Nyb2xsVG9wICwgY2xpZW50SGVpZ2h0ICB9ID0gY29uc29sZURpdjsKICAgICAgICBjb25zdCBkaWZmID0gc2Nyb2xsSGVpZ2h0IC0gc2Nyb2xsVG9wOwogICAgICAgIGNvbnN0IGF1dG9zY3JvbGwgPSBkaWZmIC0gMTYgKiA0IDw9IGNsaWVudEhlaWdodDsKICAgICAgICBpZiAoYXV0b3Njcm9sbCkgewogICAgICAgICAgICBjb25zb2xlTGFzdExpbmVFbGVtZW50LnNjcm9sbEludG9WaWV3KGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFzaG93aW5nQ2xlYXJCdXR0b24pIHsKICAgICAgICAgICAgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwogICAgICAgICAgICBzaG93aW5nQ2xlYXJCdXR0b24gPSB0cnVlOwogICAgICAgIH0KICAgIH07CiAgICB2bS5vblJlc2V0T3V0cHV0ID0gKCk9PnsKICAgICAgICBjb25zdCBsaW5lcyA9IGNvbnNvbGVEaXYucXVlcnlTZWxlY3RvckFsbCgnLmxpbmUnKTsKICAgICAgICBsaW5lcy5mb3JFYWNoKChsaW5lKT0+ewogICAgICAgICAgICBpZiAobGluZS5pZCAhPT0gJ2NvbnNvbGUtbGFzdC1saW5lJykgY29uc29sZURpdi5yZW1vdmVDaGlsZChsaW5lKTsKICAgICAgICB9KTsKICAgICAgICBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgICBzaG93aW5nQ2xlYXJCdXR0b24gPSBmYWxzZTsKICAgIH07CiAgICBjb25zb2xlSGVhZGVyUXBzRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbXB1dGVRcHNUZXh0KDApOwogICAgdm0ub25RcHNDaGFuZ2UgPSAocXBzKT0+ewogICAgICAgIGNvbnNvbGVIZWFkZXJRcHNFbGVtZW50LnRleHRDb250ZW50ID0gY29tcHV0ZVFwc1RleHQocXBzKTsKICAgIH07CiAgICBMaXRFbGVtZW50LnJlbmRlcihhY3Rpb25JY29uKENMRUFSX0lDT04sIHsKICAgICAgICB0ZXh0OiAnQ2xlYXInLAogICAgICAgIG9uY2xpY2s6ICgpPT52bS5yZXNldE91dHB1dCgpCiAgICB9KSwgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudCk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zb2xlRGl2LnN0eWxlLmRpc3BsYXkgPSB2bS5zZWxlY3RlZEFuYWx5dGljSWQgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgIGNvbnNvbGVIZWFkZXJGaWx0ZXJzRGl2LnN0eWxlLnZpc2liaWxpdHkgPSB2bS5wcm9maWxlcy5sZW5ndGggPiAwID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgY29uc29sZUhlYWRlclRhaWxzRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbXB1dGVUYWlsc1RleHQodm0udGFpbHMuc2l6ZSk7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoRklMVEVSU19IVE1MKHZtKSwgY29uc29sZUhlYWRlckZpbHRlcnNEaXYpOwogICAgfTsKfQpjb25zdCBGSUxURVJTX0hUTUwgPSAodm0pPT57CiAgICByZXR1cm4gaHRtbGBTaG93aW5nIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U2VsZWN0aW9uRmllbGRzKCk7CiAgICB9fT4ke3ZtLmNvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KCl9PC9hPgogICAgIGZvciA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZWRpdEV2ZW50RmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVFdmVudEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+CiAgICAgd2l0aCA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZWRpdFN0YXR1c0ZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlU3RhdHVzRmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4sCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRJcEFkZHJlc3NGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUlwQWRkcmVzc0ZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0TWV0aG9kRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVNZXRob2RGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZWRpdFNhbXBsaW5nUmF0ZUZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlU2FtcGxpbmdSYXRlRmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4sIAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U2VhcmNoRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTZWFyY2hGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwgCiAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZWRpdEhlYWRlckZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSGVhZGVyRmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4sCiAgICAgYW5kIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0TG9ncHJvcEZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlTG9ncHJvcEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LgogICAgICR7dm0uaGFzQW55RmlsdGVycygpID8gaHRtbGAoPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLnJlc2V0RmlsdGVycygpOwogICAgfX0+cmVzZXQ8L2E+KWAgOiAnJ31gOwp9OwpmdW5jdGlvbiBjb21wdXRlRXZlbnRGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgeyBldmVudDEgIH0gPSBmaWx0ZXI7CiAgICByZXR1cm4gZXZlbnQxID09PSAnY3JvbicgPyAnQ1JPTiB0cmlnZ2VyIGV2ZW50cycgOiBldmVudDEgPT09ICdodHRwJyA/ICdIVFRQIHJlcXVlc3QgZXZlbnRzJyA6ICdhbGwgZXZlbnRzJzsKfQpmdW5jdGlvbiBjb21wdXRlU3RhdHVzRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgc3RhdHVzMSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiBzdGF0dXMxID09PSAnZXJyb3InID8gJ2Vycm9yIHN0YXR1cycgOiBzdGF0dXMxID09PSAnc3VjY2VzcycgPyAnc3VjY2VzcyBzdGF0dXMnIDogJ2FueSBzdGF0dXMnOwp9CmZ1bmN0aW9uIGNvbXB1dGVJcEFkZHJlc3NGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgaXBBZGRyZXNzMSA9IGZpbHRlci5pcEFkZHJlc3MxIHx8IFtdOwogICAgcmV0dXJuIGlwQWRkcmVzczEubGVuZ3RoID09PSAwID8gJ2FueSBJUCBhZGRyZXNzJyA6IGlwQWRkcmVzczEubGVuZ3RoID09PSAxID8gYElQIGFkZHJlc3Mgb2YgJHtpcEFkZHJlc3MxWzBdfWAgOiBgSVAgYWRkcmVzcyBpbiBbJHtpcEFkZHJlc3MxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZU1ldGhvZEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBtZXRob2QxID0gZmlsdGVyLm1ldGhvZDEgfHwgW107CiAgICByZXR1cm4gbWV0aG9kMS5sZW5ndGggPT09IDAgPyAnYW55IG1ldGhvZCcgOiBtZXRob2QxLmxlbmd0aCA9PT0gMSA/IGBtZXRob2Qgb2YgJHttZXRob2QxWzBdfWAgOiBgbWV0aG9kIGluIFske21ldGhvZDEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlU2FtcGxpbmdSYXRlRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHNhbXBsaW5nUmF0ZTEgPSB0eXBlb2YgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPT09ICdudW1iZXInID8gZmlsdGVyLnNhbXBsaW5nUmF0ZTEgOiAxOwogICAgcmV0dXJuIHNhbXBsaW5nUmF0ZTEgPj0gMSA/ICdubyBzYW1wbGluZycgOiBgJHsoTWF0aC5tYXgoMCwgc2FtcGxpbmdSYXRlMSkgKiAxMDApLnRvRml4ZWQoMil9JSBzYW1wbGluZyByYXRlYDsKfQpmdW5jdGlvbiBjb21wdXRlU2VhcmNoRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgc2VhcmNoMSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiB0eXBlb2Ygc2VhcmNoMSA9PT0gJ3N0cmluZycgJiYgc2VhcmNoMS5sZW5ndGggPiAwID8gYGNvbnNvbGUgbG9ncyBjb250YWluaW5nICIke3NlYXJjaDF9ImAgOiAnbm8gc2VhcmNoIGZpbHRlcic7Cn0KZnVuY3Rpb24gY29tcHV0ZUhlYWRlckZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBoZWFkZXIxID0gZmlsdGVyLmhlYWRlcjEgfHwgW107CiAgICByZXR1cm4gaGVhZGVyMS5sZW5ndGggPT09IDAgPyAnbm8gaGVhZGVyIGZpbHRlcicgOiBoZWFkZXIxLmxlbmd0aCA9PT0gMSA/IGBoZWFkZXIgZmlsdGVyIG9mICR7aGVhZGVyMVswXX1gIDogYGhlYWRlciBmaWx0ZXJzIG9mIFske2hlYWRlcjEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlTG9ncHJvcEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBsb2dwcm9wMSA9IGZpbHRlci5sb2dwcm9wMSB8fCBbXTsKICAgIHJldHVybiBsb2dwcm9wMS5sZW5ndGggPT09IDAgPyAnbm8gbG9ncHJvcCBmaWx0ZXInIDogbG9ncHJvcDEubGVuZ3RoID09PSAxID8gYGxvZ3Byb3AgZmlsdGVyIG9mICR7bG9ncHJvcDFbMF19YCA6IGBsb2dwcm9wIGZpbHRlcnMgb2YgWyR7bG9ncHJvcDEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlVGFpbHNUZXh0KHRhaWxDb3VudCkgewogICAgcmV0dXJuIHRhaWxDb3VudCA9PT0gMCA/ICdubyB0YWlscycgOiB0YWlsQ291bnQgPT09IDEgPyAnMSB0YWlsJyA6IGAke3RhaWxDb3VudH0gdGFpbHNgOwp9CmZ1bmN0aW9uIGNvbXB1dGVRcHNUZXh0KHFwcykgewogICAgcmV0dXJuIGAke3Fwcy50b0ZpeGVkKDIpfSBxcHNgOwp9CmZ1bmN0aW9uIHJlbmRlclRleHRJbnRvU3Bhbih0ZXh0LCBzcGFuKSB7CiAgICBjb25zdCBwYXR0ZXJuID0gLyhodHRwczpcL1wvW15ccyldK3xcZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9fFtcZDAtZl0rKDooW1xkMC1mXXswLDR9KT8pezUsN30pL2c7CiAgICBsZXQgbTsKICAgIGxldCBpID0gMDsKICAgIHdoaWxlKG51bGwgIT09IChtID0gcGF0dGVybi5leGVjKHRleHQpKSl7CiAgICAgICAgaWYgKG0uaW5kZXggPiBpKSB7CiAgICAgICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dC5zdWJzdHJpbmcoaSwgbS5pbmRleCkpKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXJsT3JJcCA9IG1bMF07CiAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBhLmhyZWYgPSB1cmxPcklwLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykgPyB1cmxPcklwIDogYGh0dHBzOi8vaXBpbmZvLmlvLyR7dXJsT3JJcH1gOwogICAgICAgIGEudGFyZ2V0ID0gJ19ibGFuayc7CiAgICAgICAgYS5yZWwgPSAnbm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyc7CiAgICAgICAgYS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh1cmxPcklwKSk7CiAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChhKTsKICAgICAgICBpID0gbS5pbmRleCArIHVybE9ySXAubGVuZ3RoOwogICAgfQogICAgaWYgKGkgPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dC5zdWJzdHJpbmcoaSkpKTsKICAgIH0KfQpjb25zdCBBTkFMWVRJQ1NfSFRNTDEgPSBodG1sYAo8ZGl2IGlkPSJhbmFseXRpY3MiPgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLWhlYWRlciI+CiAgICAgICAgaGVhZGVyCiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1wYW5lbCI+PC9kaXY+CjwvZGl2PgpgOwpjb25zdCBBTkFMWVRJQ1NfQ1NTID0gY3NzYAoKI2FuYWx5dGljcyB7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGhlaWdodDogMTAwdmg7CiAgICB3aWR0aDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgb3ZlcmZsb3cteTogc2Nyb2xsOwogICAgb3ZlcmZsb3cteDogaGlkZGVuOwogICAgZmxleC1ncm93OiAxOwp9CgojYW5hbHl0aWNzOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICB3aWR0aDogMXJlbTsKICAgIGhlaWdodDogM3JlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwp9CgojYW5hbHl0aWNzOjotd2Via2l0LXNjcm9sbGJhci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCiNhbmFseXRpY3MtaGVhZGVyIHsKICAgIHBvc2l0aW9uOiBzdGlja3k7CiAgICB0b3A6IDA7CiAgICBoZWlnaHQ6IDMuNzVyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBwYWRkaW5nOiAxLjI1cmVtIDFyZW0gMXJlbSAwOwp9CgojYW5hbHl0aWNzLXBhbmVsIHsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCmA7CmZ1bmN0aW9uIGluaXRBbmFseXRpY3MoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBhbmFseXRpY3NEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5hbHl0aWNzJyk7CiAgICBjb25zdCBhbmFseXRpY3NIZWFkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5hbHl0aWNzLWhlYWRlcicpOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy1wYW5lbCcpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgYW5hbHl0aWNzRGl2LnN0eWxlLmRpc3BsYXkgPSB2bS5zZWxlY3RlZEFuYWx5dGljSWQgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGlmICh2bS5zZWxlY3RlZEFuYWx5dGljSWQgPT09ICdkby1jb3N0cycpIHsKICAgICAgICAgICAgYW5hbHl0aWNzSGVhZGVyLmlubmVyVGV4dCA9ICdEdXJhYmxlIE9iamVjdCBDb3N0cyc7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKCm1haW4gewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41cmVtOwp9Cgo6cm9vdCB7CiAgICAtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2I6IHJnYigxODcsIDEzNCwgMjUyKTsKfQoKLmhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwgewogICAgc2Nyb2xsYmFyLXdpZHRoOiBub25lOyAtbXMtb3ZlcmZsb3ctc3R5bGU6IG5vbmU7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7Cn0KCi5oaWRkZW4tdmVydGljYWwtc2Nyb2xsOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICBkaXNwbGF5OiBub25lOyAvKiBmb3IgQ2hyb21lLCBTYWZhcmksIGFuZCBPcGVyYSAqLwp9CgpgOwpjb25zdCBhcHBIdG1sID0gaHRtbGAKPG1haW4+CiR7U0lERUJBUl9IVE1MfQoke0NPTlNPTEVfSFRNTH0KJHtBTkFMWVRJQ1NfSFRNTDF9CiR7TU9EQUxfSFRNTH0KPC9tYWluPmA7CmZ1bmN0aW9uIGFwcGVuZFN0eWxlc2hlZXRzKGNzc1RleHRzKSB7CiAgICBjb25zdCBzdHlsZVNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgIHN0eWxlU2hlZXQudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgICBzdHlsZVNoZWV0LnRleHRDb250ZW50ID0gY3NzVGV4dHMuam9pbignXG5cbicpOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZVNoZWV0KTsKfQphcHBlbmRTdHlsZXNoZWV0cyhbCiAgICBNQVRFUklBTF9DU1MuY3NzVGV4dCwKICAgIGFwcENzcy5jc3NUZXh0LAogICAgSEVBREVSX0NTUy5jc3NUZXh0LAogICAgU0lERUJBUl9DU1MuY3NzVGV4dCwKICAgIENPTlNPTEVfQ1NTLmNzc1RleHQsCiAgICBBTkFMWVRJQ1NfQ1NTLmNzc1RleHQsCiAgICBNT0RBTF9DU1MuY3NzVGV4dCwKICAgIFdFTENPTUVfUEFORUxfQ1NTLmNzc1RleHQsCiAgICBQUk9GSUxFX0VESVRPUl9DU1MuY3NzVGV4dCwKICAgIEZJTFRFUl9FRElUT1JfQ1NTLmNzc1RleHQsCiAgICBDSVJDVUxBUl9QUk9HUkVTU19DU1MuY3NzVGV4dCwgCl0pOwpMaXRFbGVtZW50LnJlbmRlcihhcHBIdG1sLCBkb2N1bWVudC5ib2R5KTsKZnVuY3Rpb24gcGFyc2VTdGF0aWNEYXRhKCkgewogICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRpYy1kYXRhLXNjcmlwdCcpOwogICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0LnRleHQpOwogICAgY29uc3QgdmVyc2lvbiA9IHR5cGVvZiBkYXRhLnZlcnNpb24gPT09ICdzdHJpbmcnID8gZGF0YS52ZXJzaW9uIDogdW5kZWZpbmVkOwogICAgY29uc3QgZmxhZ3MgPSB0eXBlb2YgZGF0YS5mbGFncyA9PT0gJ3N0cmluZycgPyBkYXRhLmZsYWdzIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGZsYWdzCiAgICB9Owp9CmNvbnN0IGRhdGExID0gcGFyc2VTdGF0aWNEYXRhKCk7CmNvbnN0IHZtID0gbmV3IFdlYnRhaWxBcHBWTSgpOwpjb25zdCB1cGRhdGVTaWRlYmFyID0gaW5pdFNpZGViYXIoZG9jdW1lbnQsIHZtLCBkYXRhMSk7CmNvbnN0IHVwZGF0ZUNvbnNvbGUgPSBpbml0Q29uc29sZShkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVBbmFseXRpY3MgPSBpbml0QW5hbHl0aWNzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZU1vZGFsID0gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSk7CnZtLm9uQ2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZVNpZGViYXIoKTsKICAgIHVwZGF0ZUNvbnNvbGUoKTsKICAgIHVwZGF0ZUFuYWx5dGljcygpOwogICAgdXBkYXRlTW9kYWwoKTsKfTsKQ2xvdWRmbGFyZUFwaS5VUkxfVFJBTlNGT1JNRVIgPSAodik9PmAvZmV0Y2gvJHt2LnN1YnN0cmluZygnaHR0cHM6Ly8nLmxlbmd0aCl9YAo7CnZtLnN0YXJ0KCk7CnNldEFwcFN0YXRlKCdzdGFydGVkJyk7Cg==';