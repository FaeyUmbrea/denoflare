

export const TAILWEB_APP_HASH = '802687cd83cce8f52309e3bc1ea9f8f6b7a11576';
export const TAILWEB_APP_B64 = 'YXN5bmMgZnVuY3Rpb24gbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0c2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RTY3JpcHRzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdFRhaWxzKGFjY291bnRJZCwgc2NyaXB0TmFtZSwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpfS93b3JrZXJzL3NjcmlwdHMvJHtzY3JpcHROYW1lfS90YWlsc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RUYWlscycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnY3JlYXRlVGFpbCcsICdQT1NUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04JzsKY29uc3QgQVBQTElDQVRJT05fT0NURVRfU1RSRUFNID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmZ1bmN0aW9uIGNvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpIHsKICAgIHJldHVybiBDbG91ZGZsYXJlQXBpLlVSTF9UUkFOU0ZPUk1FUihgaHR0cHM6Ly9hcGkuY2xvdWRmbGFyZS5jb20vY2xpZW50L3Y0L2FjY291bnRzLyR7YWNjb3VudElkfWApOwp9CmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUob3AsIG1ldGhvZCwgdXJsLCBhcGlUb2tlbiwgYm9keSwgcmVzcG9uc2VUeXBlID0gJ2pzb24nKSB7CiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoewogICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaVRva2VufWAKICAgIH0pOwogICAgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykgewogICAgICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBBUFBMSUNBVElPTl9KU09OX1VURjgpOwogICAgICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhib2R5KTsKICAgIH0KICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZmV0Y2hSZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJykgfHwgJyc7CiAgICBpZiAoKHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzJyB8fCByZXNwb25zZVR5cGUgPT09ICdieXRlcz8nKSAmJiBjb250ZW50VHlwZSA9PT0gQVBQTElDQVRJT05fT0NURVRfU1RSRUFNKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4LAogICAgICAgIEFQUExJQ0FUSU9OX0pTT04KICAgIF0uaW5jbHVkZXMoY29udGVudFR5cGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRlbnQtdHlwZTogJHtjb250ZW50VHlwZX0sICBmZXRjaFJlc3BvbnNlPSR7ZmV0Y2hSZXNwb25zZX0sIGJvZHk9JHthd2FpdCBmZXRjaFJlc3BvbnNlLnRleHQoKX1gKTsKICAgIH0KICAgIGNvbnN0IGFwaVJlc3BvbnNlID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5qc29uKCk7CiAgICBpZiAoQ2xvdWRmbGFyZUFwaS5ERUJVRykgY29uc29sZS5sb2coYXBpUmVzcG9uc2UpOwogICAgaWYgKCFhcGlSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgaWYgKGZldGNoUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgJiYgcmVzcG9uc2VUeXBlID09PSAnYnl0ZXM/JykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB0aHJvdyBuZXcgQ2xvdWRmbGFyZUFwaUVycm9yKGAke29wfSBmYWlsZWQ6IHN0YXR1cz0ke2ZldGNoUmVzcG9uc2Uuc3RhdHVzfSwgZXJyb3JzPSR7YXBpUmVzcG9uc2UuZXJyb3JzLm1hcCgodik9PmAke3YuY29kZX0gJHt2Lm1lc3NhZ2V9YAogICAgICAgICkuam9pbignLCAnKX1gLCBmZXRjaFJlc3BvbnNlLnN0YXR1cywgYXBpUmVzcG9uc2UuZXJyb3JzKTsKICAgIH0KICAgIHJldHVybiBhcGlSZXNwb25zZTsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBzdGF0dXM7CiAgICBlcnJvcnM7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlMSwgc3RhdHVzLCBlcnJvcnMpewogICAgICAgIHN1cGVyKG1lc3NhZ2UxKTsKICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgIH0KfQpmdW5jdGlvbiBzZXRTdWJ0cmFjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KGxocyk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmhzKXsKICAgICAgICBydC5kZWxldGUoaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0VW5pb24obGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldChsaHMpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIHJocyl7CiAgICAgICAgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldEludGVyc2VjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgbGhzKXsKICAgICAgICBpZiAocmhzLmhhcyhpdGVtKSkgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgZm9yIChjb25zdCBpdGVtMSBvZiByaHMpewogICAgICAgIGlmIChsaHMuaGFzKGl0ZW0xKSkgcnQuYWRkKGl0ZW0xKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBzZXRFcXVhbChsaHMsIHJocykgewogICAgcmV0dXJuIGxocy5zaXplID09PSByaHMuc2l6ZSAmJiBbCiAgICAgICAgLi4ubGhzCiAgICBdLmV2ZXJ5KCh2KT0+cmhzLmhhcyh2KQogICAgKTsKfQpjb25zdCBkaXJlY3RpdmVzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgZGlyZWN0aXZlID0gKGYpPT4oLi4uYXJncyk9PnsKICAgICAgICBjb25zdCBkID0gZiguLi5hcmdzKTsKICAgICAgICBkaXJlY3RpdmVzLnNldChkLCB0cnVlKTsKICAgICAgICByZXR1cm4gZDsKICAgIH0KOwpjb25zdCBpc0RpcmVjdGl2ZSA9IChvKT0+ewogICAgcmV0dXJuIHR5cGVvZiBvID09PSAiZnVuY3Rpb24iICYmIGRpcmVjdGl2ZXMuaGFzKG8pOwp9Owpjb25zdCBpc0NFUG9seWZpbGwgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuY3VzdG9tRWxlbWVudHMgIT0gbnVsbCAmJiB3aW5kb3cuY3VzdG9tRWxlbWVudHMucG9seWZpbGxXcmFwRmx1c2hDYWxsYmFjayAhPT0gdm9pZCAwOwpjb25zdCByZXBhcmVudE5vZGVzID0gKGNvbnRhaW5lciwgc3RhcnQsIGVuZCA9IG51bGwsIGJlZm9yZSA9IG51bGwpPT57CiAgICB3aGlsZShzdGFydCAhPT0gZW5kKXsKICAgICAgICBjb25zdCBuID0gc3RhcnQubmV4dFNpYmxpbmc7CiAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShzdGFydCwgYmVmb3JlKTsKICAgICAgICBzdGFydCA9IG47CiAgICB9Cn07CmNvbnN0IHJlbW92ZU5vZGVzID0gKGNvbnRhaW5lciwgc3RhcnQsIGVuZCA9IG51bGwpPT57CiAgICB3aGlsZShzdGFydCAhPT0gZW5kKXsKICAgICAgICBjb25zdCBuID0gc3RhcnQubmV4dFNpYmxpbmc7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHN0YXJ0KTsKICAgICAgICBzdGFydCA9IG47CiAgICB9Cn07CmNvbnN0IG5vQ2hhbmdlID0gewp9Owpjb25zdCBub3RoaW5nID0gewp9Owpjb25zdCBtYXJrZXIgPSBge3tsaXQtJHtTdHJpbmcoTWF0aC5yYW5kb20oKSkuc2xpY2UoMil9fX1gOwpjb25zdCBub2RlTWFya2VyID0gYDwhLS0ke21hcmtlcn0tLT5gOwpjb25zdCBtYXJrZXJSZWdleCA9IG5ldyBSZWdFeHAoYCR7bWFya2VyfXwke25vZGVNYXJrZXJ9YCk7CmNvbnN0IGJvdW5kQXR0cmlidXRlU3VmZml4ID0gIiRsaXQkIjsKY2xhc3MgVGVtcGxhdGUgewogICAgY29uc3RydWN0b3IocmVzdWx0LCBlbGVtZW50NSl7CiAgICAgICAgdGhpcy5wYXJ0cyA9IFtdOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ1OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudDUuY29udGVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IGxhc3RQYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpbmRleCA9IC0xOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IHsgc3RyaW5nczogc3RyaW5nczUgLCB2YWx1ZXM6IHsgbGVuZ3RoICB9ICB9ID0gcmVzdWx0OwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IGxlbmd0aCl7CiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB3YWxrZXIubmV4dE5vZGUoKTsKICAgICAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IHN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZXMoKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBub2RlLmF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBsZW5ndGg6IGxlbmd0aDIgIH0gPSBhdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbmd0aDI7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbmRzV2l0aChhdHRyaWJ1dGVzW2ldLm5hbWUsIGJvdW5kQXR0cmlidXRlU3VmZml4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB3aGlsZShjb3VudC0tID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmluZ0ZvclBhcnQgPSBzdHJpbmdzNVtwYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleDEgPSBzdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aDsKICAgIHJldHVybiBpbmRleDEgPj0gMCAmJiBzdHIuc2xpY2UoaW5kZXgxKSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9uczIpewogICAgICAgIHRoaXMuX19wYXJ0cyA9IFtdOwogICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB0aGlzLnByb2Nlc3NvciA9IHByb2Nlc3NvcjsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zMjsKICAgIH0KICAgIHVwZGF0ZSh2YWx1ZXMpIHsKICAgICAgICBsZXQgaSA9IDA7CiAgICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBhcnQuc2V0VmFsdWUodmFsdWVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgcGFydDEgb2YgdGhpcy5fX3BhcnRzKXsKICAgICAgICAgICAgaWYgKHBhcnQxICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBhcnQxLmNvbW1pdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgX2Nsb25lKCkgewogICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaXNDRVBvbHlmaWxsID8gdGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpIDogZG9jdW1lbnQuaW1wb3J0Tm9kZSh0aGlzLnRlbXBsYXRlLmVsZW1lbnQuY29udGVudCwgdHJ1ZSk7CiAgICAgICAgY29uc3Qgc3RhY2sxID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIxID0gZG9jdW1lbnQuY3JlYXRlVHJlZVdhbGtlcihmcmFnbWVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IHBhcnRJbmRleDEgPSAwOwogICAgICAgIGxldCBub2RlSW5kZXggPSAwOwogICAgICAgIGxldCBwYXJ0OwogICAgICAgIGxldCBub2RlID0gd2Fsa2VyMS5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleDEgPCBwYXJ0czIubGVuZ3RoKXsKICAgICAgICAgICAgcGFydCA9IHBhcnRzMltwYXJ0SW5kZXgxXTsKICAgICAgICAgICAgaWYgKCFpc1RlbXBsYXRlUGFydEFjdGl2ZShwYXJ0KSkgewogICAgICAgICAgICAgICAgdGhpcy5fX3BhcnRzLnB1c2godm9pZCAwKTsKICAgICAgICAgICAgICAgIHBhcnRJbmRleDErKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrMS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlcjEuY3VycmVudE5vZGUgPSBub2RlLmNvbnRlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKG5vZGUgPSB3YWxrZXIxLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyMS5jdXJyZW50Tm9kZSA9IHN0YWNrMS5wb3AoKTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gd2Fsa2VyMS5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgxKys7CiAgICAgICAgfQogICAgICAgIGlmIChpc0NFUG9seWZpbGwpIHsKICAgICAgICAgICAgZG9jdW1lbnQuYWRvcHROb2RlKGZyYWdtZW50KTsKICAgICAgICAgICAgY3VzdG9tRWxlbWVudHMudXBncmFkZShmcmFnbWVudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmcmFnbWVudDsKICAgIH0KfQpjb25zdCBwb2xpY3kgPSB3aW5kb3cudHJ1c3RlZFR5cGVzICYmIHRydXN0ZWRUeXBlcy5jcmVhdGVQb2xpY3koImxpdC1odG1sIiwgewogICAgY3JlYXRlSFRNTDogKHMpPT5zCn0pOwpjb25zdCBjb21tZW50TWFya2VyID0gYCAke21hcmtlcn0gYDsKY2xhc3MgVGVtcGxhdGVSZXN1bHQgewogICAgY29uc3RydWN0b3Ioc3RyaW5nczEsIHZhbHVlcywgdHlwZTEsIHByb2Nlc3NvcjEpewogICAgICAgIHRoaXMuc3RyaW5ncyA9IHN0cmluZ3MxOwogICAgICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogICAgICAgIHRoaXMudHlwZSA9IHR5cGUxOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yMTsKICAgIH0KICAgIGdldEhUTUwoKSB7CiAgICAgICAgY29uc3QgbCA9IHRoaXMuc3RyaW5ncy5sZW5ndGggLSAxOwogICAgICAgIGxldCBodG1sMiA9ICIiOwogICAgICAgIGxldCBpc0NvbW1lbnRCaW5kaW5nID0gZmFsc2U7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIGNvbnN0IHMgPSB0aGlzLnN0cmluZ3NbaV07CiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnRPcGVuID0gcy5sYXN0SW5kZXhPZigiPCEtLSIpOwogICAgICAgICAgICBpc0NvbW1lbnRCaW5kaW5nID0gKGNvbW1lbnRPcGVuID4gLTEgfHwgaXNDb21tZW50QmluZGluZykgJiYgcy5pbmRleE9mKCItLT4iLCBjb21tZW50T3BlbiArIDEpID09PSAtMTsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlTWF0Y2ggPSBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4LmV4ZWMocyk7CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVNYXRjaCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcyArIChpc0NvbW1lbnRCaW5kaW5nID8gY29tbWVudE1hcmtlciA6IG5vZGVNYXJrZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcy5zdWJzdHIoMCwgYXR0cmlidXRlTWF0Y2guaW5kZXgpICsgYXR0cmlidXRlTWF0Y2hbMV0gKyBhdHRyaWJ1dGVNYXRjaFsyXSArIGJvdW5kQXR0cmlidXRlU3VmZml4ICsgYXR0cmlidXRlTWF0Y2hbM10gKyBtYXJrZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaHRtbDIgKz0gdGhpcy5zdHJpbmdzW2xdOwogICAgICAgIHJldHVybiBodG1sMjsKICAgIH0KICAgIGdldFRlbXBsYXRlRWxlbWVudCgpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZTEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZW1wbGF0ZSIpOwogICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZ2V0SFRNTCgpOwogICAgICAgIGlmIChwb2xpY3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YWx1ZSA9IHBvbGljeS5jcmVhdGVIVE1MKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGUxLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTE7CiAgICB9Cn0KY2xhc3MgU1ZHVGVtcGxhdGVSZXN1bHQgZXh0ZW5kcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBnZXRIVE1MKCkgewogICAgICAgIHJldHVybiBgPHN2Zz4ke3N1cGVyLmdldEhUTUwoKX08L3N2Zz5gOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlMSA9IHN1cGVyLmdldFRlbXBsYXRlRWxlbWVudCgpOwogICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0ZW1wbGF0ZTEuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTE7CiAgICB9Cn0KY29uc3QgaXNQcmltaXRpdmUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgISh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIik7Cn07CmNvbnN0IGlzSXRlcmFibGUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgISEodmFsdWUgJiYgdmFsdWVbU3ltYm9sLml0ZXJhdG9yXSk7Cn07CmNsYXNzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50MSwgbmFtZTMsIHN0cmluZ3MyKXsKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50MTsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lMzsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzMjsKICAgICAgICB0aGlzLnBhcnRzID0gW107CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHN0cmluZ3MyLmxlbmd0aCAtIDE7IGkrKyl7CiAgICAgICAgICAgIHRoaXMucGFydHNbaV0gPSB0aGlzLl9jcmVhdGVQYXJ0KCk7CiAgICAgICAgfQogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBdHRyaWJ1dGVQYXJ0KHRoaXMpOwogICAgfQogICAgX2dldFZhbHVlKCkgewogICAgICAgIGNvbnN0IHN0cmluZ3MzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzMy5sZW5ndGggLSAxOwogICAgICAgIGNvbnN0IHBhcnRzMiA9IHRoaXMucGFydHM7CiAgICAgICAgaWYgKGwgPT09IDEgJiYgc3RyaW5nczNbMF0gPT09ICIiICYmIHN0cmluZ3MzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpMSA9IDA7IGkxIDwgbDsgaTErKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nczNbaTFdOwogICAgICAgICAgICBjb25zdCBwYXJ0ID0gcGFydHMyW2kxXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3MzW2xdOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsIHRoaXMuX2dldFZhbHVlKCkpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBBdHRyaWJ1dGVQYXJ0IHsKICAgIGNvbnN0cnVjdG9yKGNvbW1pdHRlcil7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmNvbW1pdHRlciA9IGNvbW1pdHRlcjsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBub0NoYW5nZSAmJiAoIWlzUHJpbWl0aXZlKHZhbHVlKSB8fCB2YWx1ZSAhPT0gdGhpcy52YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoIWlzRGlyZWN0aXZlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhpcy5jb21taXR0ZXIuZGlydHkgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMudmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMudmFsdWU7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5jb21taXR0ZXIuY29tbWl0KCk7CiAgICB9Cn0KY2xhc3MgTm9kZVBhcnQgewogICAgY29uc3RydWN0b3Iob3B0aW9uczEpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zMTsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUxID0gdGhpcy5vcHRpb25zLnRlbXBsYXRlRmFjdG9yeSh2YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZUluc3RhbmNlICYmIHRoaXMudmFsdWUudGVtcGxhdGUgPT09IHRlbXBsYXRlMSkgewogICAgICAgICAgICB0aGlzLnZhbHVlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gbmV3IFRlbXBsYXRlSW5zdGFuY2UodGVtcGxhdGUxLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXgxID0gMDsKICAgICAgICBsZXQgaXRlbVBhcnQ7CiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbHVlKXsKICAgICAgICAgICAgaXRlbVBhcnQgPSBpdGVtUGFydHNbcGFydEluZGV4MV07CiAgICAgICAgICAgIGlmIChpdGVtUGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpdGVtUGFydCA9IG5ldyBOb2RlUGFydCh0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgaXRlbVBhcnRzLnB1c2goaXRlbVBhcnQpOwogICAgICAgICAgICAgICAgaWYgKHBhcnRJbmRleDEgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXgxIC0gMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGl0ZW1QYXJ0LnNldFZhbHVlKGl0ZW0pOwogICAgICAgICAgICBpdGVtUGFydC5jb21taXQoKTsKICAgICAgICAgICAgcGFydEluZGV4MSsrOwogICAgICAgIH0KICAgICAgICBpZiAocGFydEluZGV4MSA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDE7CiAgICAgICAgICAgIHRoaXMuY2xlYXIoaXRlbVBhcnQgJiYgaXRlbVBhcnQuZW5kTm9kZSk7CiAgICAgICAgfQogICAgfQogICAgY2xlYXIoc3RhcnROb2RlID0gdGhpcy5zdGFydE5vZGUpIHsKICAgICAgICByZW1vdmVOb2Rlcyh0aGlzLnN0YXJ0Tm9kZS5wYXJlbnROb2RlLCBzdGFydE5vZGUubmV4dFNpYmxpbmcsIHRoaXMuZW5kTm9kZSk7CiAgICB9Cn0KY2xhc3MgQm9vbGVhbkF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudDIsIG5hbWUxLCBzdHJpbmdzMyl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIGlmIChzdHJpbmdzMy5sZW5ndGggIT09IDIgfHwgc3RyaW5nczNbMF0gIT09ICIiIHx8IHN0cmluZ3MzWzFdICE9PSAiIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJvb2xlYW4gYXR0cmlidXRlcyBjYW4gb25seSBjb250YWluIGEgc2luZ2xlIGV4cHJlc3Npb24iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDI7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTE7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczM7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZhbHVlID0gISF0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUodGhpcy5uYW1lLCAiIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICB9Cn0KY2xhc3MgUHJvcGVydHlDb21taXR0ZXIgZXh0ZW5kcyBBdHRyaWJ1dGVDb21taXR0ZXIgewogICAgY29uc3RydWN0b3IoZWxlbWVudDMsIG5hbWUyLCBzdHJpbmdzNCl7CiAgICAgICAgc3VwZXIoZWxlbWVudDMsIG5hbWUyLCBzdHJpbmdzNCk7CiAgICAgICAgdGhpcy5zaW5nbGUgPSBzdHJpbmdzNC5sZW5ndGggPT09IDIgJiYgc3RyaW5nczRbMF0gPT09ICIiICYmIHN0cmluZ3M0WzFdID09PSAiIjsKICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgUHJvcGVydHlQYXJ0KHRoaXMpOwogICAgfQogICAgX2dldFZhbHVlKCkgewogICAgICAgIGlmICh0aGlzLnNpbmdsZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJ0c1swXS52YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRWYWx1ZSgpOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50W3RoaXMubmFtZV0gPSB0aGlzLl9nZXRWYWx1ZSgpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBQcm9wZXJ0eVBhcnQgZXh0ZW5kcyBBdHRyaWJ1dGVQYXJ0IHsKfQpsZXQgZXZlbnRPcHRpb25zU3VwcG9ydGVkID0gZmFsc2U7CigoKT0+ewogICAgdHJ5IHsKICAgICAgICBjb25zdCBvcHRpb25zMiA9IHsKICAgICAgICAgICAgZ2V0IGNhcHR1cmUgKCkgewogICAgICAgICAgICAgICAgZXZlbnRPcHRpb25zU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zMiwgb3B0aW9uczIpOwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9uczIsIG9wdGlvbnMyKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50NCwgZXZlbnROYW1lLCBldmVudENvbnRleHQpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50NDsKICAgICAgICB0aGlzLmV2ZW50TmFtZSA9IGV2ZW50TmFtZTsKICAgICAgICB0aGlzLmV2ZW50Q29udGV4dCA9IGV2ZW50Q29udGV4dDsKICAgICAgICB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCA9IChlKT0+dGhpcy5oYW5kbGVFdmVudChlKQogICAgICAgIDsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmV3TGlzdGVuZXIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGNvbnN0IG9sZExpc3RlbmVyID0gdGhpcy52YWx1ZTsKICAgICAgICBjb25zdCBzaG91bGRSZW1vdmVMaXN0ZW5lciA9IG5ld0xpc3RlbmVyID09IG51bGwgfHwgb2xkTGlzdGVuZXIgIT0gbnVsbCAmJiAobmV3TGlzdGVuZXIuY2FwdHVyZSAhPT0gb2xkTGlzdGVuZXIuY2FwdHVyZSB8fCBuZXdMaXN0ZW5lci5vbmNlICE9PSBvbGRMaXN0ZW5lci5vbmNlIHx8IG5ld0xpc3RlbmVyLnBhc3NpdmUgIT09IG9sZExpc3RlbmVyLnBhc3NpdmUpOwogICAgICAgIGNvbnN0IHNob3VsZEFkZExpc3RlbmVyID0gbmV3TGlzdGVuZXIgIT0gbnVsbCAmJiAob2xkTGlzdGVuZXIgPT0gbnVsbCB8fCBzaG91bGRSZW1vdmVMaXN0ZW5lcik7CiAgICAgICAgaWYgKHNob3VsZFJlbW92ZUxpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkQWRkTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5fX29wdGlvbnMgPSBnZXRPcHRpb25zKG5ld0xpc3RlbmVyKTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWUgPSBuZXdMaXN0ZW5lcjsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICB9CiAgICBoYW5kbGVFdmVudChldmVudCkgewogICAgICAgIGlmICh0eXBlb2YgdGhpcy52YWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLnZhbHVlLmNhbGwodGhpcy5ldmVudENvbnRleHQgfHwgdGhpcy5lbGVtZW50LCBldmVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5oYW5kbGVFdmVudChldmVudCk7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGdldE9wdGlvbnMgPSAobyk9Pm8gJiYgKGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA/IHsKICAgICAgICBjYXB0dXJlOiBvLmNhcHR1cmUsCiAgICAgICAgcGFzc2l2ZTogby5wYXNzaXZlLAogICAgICAgIG9uY2U6IG8ub25jZQogICAgfSA6IG8uY2FwdHVyZSkKOwpjbGFzcyBEZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgewogICAgaGFuZGxlQXR0cmlidXRlRXhwcmVzc2lvbnMoZWxlbWVudCwgbmFtZSwgc3RyaW5ncywgb3B0aW9ucykgewogICAgICAgIGNvbnN0IHByZWZpeCA9IG5hbWVbMF07CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIi4iKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbW1pdHRlcjIgPSBuZXcgUHJvcGVydHlDb21taXR0ZXIoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncyk7CiAgICAgICAgICAgIHJldHVybiBjb21taXR0ZXIyLnBhcnRzOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiQCIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBFdmVudFBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgb3B0aW9ucy5ldmVudENvbnRleHQpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICI/IikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEJvb2xlYW5BdHRyaWJ1dGVQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbW1pdHRlcjEgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIxLnBhcnRzOwogICAgfQogICAgaGFuZGxlVGV4dEV4cHJlc3Npb24ob3B0aW9ucykgewogICAgICAgIHJldHVybiBuZXcgTm9kZVBhcnQob3B0aW9ucyk7CiAgICB9Cn0KY29uc3QgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yID0gbmV3IERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcigpOwpmdW5jdGlvbiB0ZW1wbGF0ZUZhY3RvcnkocmVzdWx0MSkgewogICAgbGV0IHRlbXBsYXRlQ2FjaGUgPSB0ZW1wbGF0ZUNhY2hlcy5nZXQocmVzdWx0MS50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0MS50eXBlLCB0ZW1wbGF0ZUNhY2hlKTsKICAgIH0KICAgIGxldCB0ZW1wbGF0ZTEgPSB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5nZXQocmVzdWx0MS5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZTEgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiB0ZW1wbGF0ZTE7CiAgICB9CiAgICBjb25zdCBrZXkgPSByZXN1bHQxLnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUxID0gdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuZ2V0KGtleSk7CiAgICBpZiAodGVtcGxhdGUxID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZTEgPSBuZXcgVGVtcGxhdGUocmVzdWx0MSwgcmVzdWx0MS5nZXRUZW1wbGF0ZUVsZW1lbnQoKSk7CiAgICAgICAgdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuc2V0KGtleSwgdGVtcGxhdGUxKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQxLnN0cmluZ3MsIHRlbXBsYXRlMSk7CiAgICByZXR1cm4gdGVtcGxhdGUxOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQxLCBjb250YWluZXIsIG9wdGlvbnMzKT0+ewogICAgbGV0IHBhcnQgPSBwYXJ0cy5nZXQoY29udGFpbmVyKTsKICAgIGlmIChwYXJ0ID09PSB2b2lkIDApIHsKICAgICAgICByZW1vdmVOb2Rlcyhjb250YWluZXIsIGNvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICBwYXJ0cy5zZXQoY29udGFpbmVyLCBwYXJ0ID0gbmV3IE5vZGVQYXJ0KE9iamVjdC5hc3NpZ24oewogICAgICAgICAgICB0ZW1wbGF0ZUZhY3RvcnkKICAgICAgICB9LCBvcHRpb25zMykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0MSk7CiAgICBwYXJ0LmNvbW1pdCgpOwp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIxLjQuMSIpOwp9CmNvbnN0IGh0bWwgPSAoc3RyaW5nczYsIC4uLnZhbHVlczEpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5nczYsIHZhbHVlczEsICJodG1sIiwgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKQo7CmNvbnN0IHN2ZyA9IChzdHJpbmdzNiwgLi4udmFsdWVzMSk9Pm5ldyBTVkdUZW1wbGF0ZVJlc3VsdChzdHJpbmdzNiwgdmFsdWVzMSwgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcyksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHNbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlMiA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlciB8fCBkZWZhdWx0Q29udmVydGVyOwogICAgICAgIGNvbnN0IGZyb21BdHRyaWJ1dGUgPSB0eXBlb2YgY29udmVydGVyID09PSAiZnVuY3Rpb24iID8gY29udmVydGVyIDogY29udmVydGVyLmZyb21BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGZyb21BdHRyaWJ1dGUgPyBmcm9tQXR0cmlidXRlKHZhbHVlLCB0eXBlMikgOiB2YWx1ZTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKG9wdGlvbnMucmVmbGVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHlwZTIgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlMik7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gMDsKICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlcyk9PnRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSByZXMKICAgICAgICApOwogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbCgpOwogICAgfQogICAgX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKF92LCBwKT0+ewogICAgICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW3BdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5zZXQocCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBfYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT50aGlzW3BdID0gdgogICAgICAgICk7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgdGhpcy5lbmFibGVVcGRhdGluZygpOwogICAgfQogICAgZW5hYmxlVXBkYXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyKCk7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSB2b2lkIDA7CiAgICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICB9CiAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkLCB2YWx1ZSkgewogICAgICAgIGlmIChvbGQgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9wcm9wZXJ0eVRvQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBhdHRyID0gY3Rvci5fYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgYXR0clZhbHVlID0gY3Rvci5fcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKGF0dHIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoYXR0ciwgYXR0clZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgIH0KICAgIH0KICAgIF9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBwcm9wTmFtZSA9IGN0b3IuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuZ2V0KG5hbWUpOwogICAgICAgIGlmIChwcm9wTmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMzID0gY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMocHJvcE5hbWUpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICAgICAgdGhpc1twcm9wTmFtZV0gPSBjdG9yLl9wcm9wZXJ0eVZhbHVlRnJvbUF0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9uczMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0MSA9IHRoaXMucGVyZm9ybVVwZGF0ZSgpOwogICAgICAgIGlmIChyZXN1bHQxICE9IG51bGwpIHsKICAgICAgICAgICAgYXdhaXQgcmVzdWx0MTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgbGVnYWN5Q3VzdG9tRWxlbWVudCA9ICh0YWdOYW1lLCBjbGF6eik9PnsKICAgIHdpbmRvdy5jdXN0b21FbGVtZW50cy5kZWZpbmUodGFnTmFtZSwgY2xhenopOwogICAgcmV0dXJuIGNsYXp6Owp9Owpjb25zdCBzdGFuZGFyZEN1c3RvbUVsZW1lbnQgPSAodGFnTmFtZSwgZGVzY3JpcHRvcik9PnsKICAgIGNvbnN0IHsga2luZCAsIGVsZW1lbnRzICB9ID0gZGVzY3JpcHRvcjsKICAgIHJldHVybiB7CiAgICAgICAga2luZCwKICAgICAgICBlbGVtZW50cywKICAgICAgICBmaW5pc2hlciAoY2xhenopIHsKICAgICAgICAgICAgd2luZG93LmN1c3RvbUVsZW1lbnRzLmRlZmluZSh0YWdOYW1lLCBjbGF6eik7CiAgICAgICAgfQogICAgfTsKfTsKY29uc3Qgc3RhbmRhcmRQcm9wZXJ0eSA9IChvcHRpb25zMywgZWxlbWVudDYpPT57CiAgICBpZiAoZWxlbWVudDYua2luZCA9PT0gIm1ldGhvZCIgJiYgZWxlbWVudDYuZGVzY3JpcHRvciAmJiAhKCJ2YWx1ZSIgaW4gZWxlbWVudDYuZGVzY3JpcHRvcikpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHsKICAgICAgICB9LCBlbGVtZW50NiksIHsKICAgICAgICAgICAgZmluaXNoZXIgKGNsYXp6KSB7CiAgICAgICAgICAgICAgICBjbGF6ei5jcmVhdGVQcm9wZXJ0eShlbGVtZW50Ni5rZXksIG9wdGlvbnMzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBraW5kOiAiZmllbGQiLAogICAgICAgICAgICBrZXk6IFN5bWJvbCgpLAogICAgICAgICAgICBwbGFjZW1lbnQ6ICJvd24iLAogICAgICAgICAgICBkZXNjcmlwdG9yOiB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGluaXRpYWxpemVyICgpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudDYuaW5pdGlhbGl6ZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzW2VsZW1lbnQ2LmtleV0gPSBlbGVtZW50Ni5pbml0aWFsaXplci5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBmaW5pc2hlciAoY2xhenopIHsKICAgICAgICAgICAgICAgIGNsYXp6LmNyZWF0ZVByb3BlcnR5KGVsZW1lbnQ2LmtleSwgb3B0aW9uczMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KfTsKY29uc3QgbGVnYWN5UHJvcGVydHkgPSAob3B0aW9uczMsIHByb3RvLCBuYW1lNCk9PnsKICAgIHByb3RvLmNvbnN0cnVjdG9yLmNyZWF0ZVByb3BlcnR5KG5hbWU0LCBvcHRpb25zMyk7Cn07CmNvbnN0IGxlZ2FjeVF1ZXJ5ID0gKGRlc2NyaXB0b3IsIHByb3RvLCBuYW1lNCk9PnsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywgbmFtZTQsIGRlc2NyaXB0b3IpOwp9Owpjb25zdCBzdGFuZGFyZEV2ZW50T3B0aW9ucyA9IChvcHRpb25zMywgZWxlbWVudDYpPT57CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHsKICAgIH0sIGVsZW1lbnQ2KSwgewogICAgICAgIGZpbmlzaGVyIChjbGF6eikgewogICAgICAgICAgICBPYmplY3QuYXNzaWduKGNsYXp6LnByb3RvdHlwZVtlbGVtZW50Ni5rZXldLCBvcHRpb25zMyk7CiAgICAgICAgfQogICAgfSk7Cn07CmNvbnN0IGxlZ2FjeUV2ZW50T3B0aW9ucyA9IChvcHRpb25zMywgcHJvdG8sIG5hbWU0KT0+ewogICAgT2JqZWN0LmFzc2lnbihwcm90b1tuYW1lNF0sIG9wdGlvbnMzKTsKfTsKY29uc3Qgc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzID0gd2luZG93LlNoYWRvd1Jvb3QgJiYgKHdpbmRvdy5TaGFkeUNTUyA9PT0gdm9pZCAwIHx8IHdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpICYmICJhZG9wdGVkU3R5bGVTaGVldHMiIGluIERvY3VtZW50LnByb3RvdHlwZSAmJiAicmVwbGFjZSIgaW4gQ1NTU3R5bGVTaGVldC5wcm90b3R5cGU7CmNvbnN0IGNvbnN0cnVjdGlvblRva2VuID0gU3ltYm9sKCk7CmNsYXNzIENTU1Jlc3VsdCB7CiAgICBjb25zdHJ1Y3Rvcihjc3NUZXh0LCBzYWZlVG9rZW4pewogICAgICAgIGlmIChzYWZlVG9rZW4gIT09IGNvbnN0cnVjdGlvblRva2VuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ1NTUmVzdWx0IGlzIG5vdCBjb25zdHJ1Y3RhYmxlLiBVc2UgYHVuc2FmZUNTU2Agb3IgYGNzc2AgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgIH0KICAgIGdldCBzdHlsZVNoZWV0KCkgewogICAgICAgIGlmICh0aGlzLl9zdHlsZVNoZWV0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0LnJlcGxhY2VTeW5jKHRoaXMuY3NzVGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmNzc1RleHQ7CiAgICB9Cn0KY29uc3QgdW5zYWZlQ1NTID0gKHZhbHVlKT0+ewogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoU3RyaW5nKHZhbHVlKSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owpjb25zdCB0ZXh0RnJvbUNTU1Jlc3VsdCA9ICh2YWx1ZSk9PnsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENTU1Jlc3VsdCkgewogICAgICAgIHJldHVybiB2YWx1ZS5jc3NUZXh0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZhbHVlIHBhc3NlZCB0byAnY3NzJyBmdW5jdGlvbiBtdXN0IGJlIGEgJ2NzcycgZnVuY3Rpb24gcmVzdWx0OiAke3ZhbHVlfS4gVXNlICd1bnNhZmVDU1MnIHRvIHBhc3Mgbm9uLWxpdGVyYWwgdmFsdWVzLCBidXQKICAgICAgICAgICAgdGFrZSBjYXJlIHRvIGVuc3VyZSBwYWdlIHNlY3VyaXR5LmApOwogICAgfQp9Owpjb25zdCBjc3MgPSAoc3RyaW5nczYsIC4uLnZhbHVlczEpPT57CiAgICBjb25zdCBjc3NUZXh0MSA9IHZhbHVlczEucmVkdWNlKChhY2MsIHYsIGlkeCk9PmFjYyArIHRleHRGcm9tQ1NTUmVzdWx0KHYpICsgc3RyaW5nczZbaWR4ICsgMV0KICAgICwgc3RyaW5nczZbMF0pOwogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoY3NzVGV4dDEsIGNvbnN0cnVjdGlvblRva2VuKTsKfTsKKHdpbmRvd1sibGl0RWxlbWVudFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0RWxlbWVudFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjIuNS4xIik7CmNvbnN0IHJlbmRlck5vdEltcGxlbWVudGVkID0gewp9OwpjbGFzcyBMaXRFbGVtZW50IGV4dGVuZHMgVXBkYXRpbmdFbGVtZW50IHsKICAgIHN0YXRpYyBnZXRTdHlsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3R5bGVzOwogICAgfQogICAgc3RhdGljIF9nZXRVbmlxdWVTdHlsZXMoKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX3N0eWxlcyIsIHRoaXMpKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVzZXJTdHlsZXMgPSB0aGlzLmdldFN0eWxlcygpOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHVzZXJTdHlsZXMpKSB7CiAgICAgICAgICAgIGNvbnN0IGFkZFN0eWxlcyA9IChzdHlsZXMyLCBzZXQyKT0+c3R5bGVzMi5yZWR1Y2VSaWdodCgoc2V0Mywgcyk9PkFycmF5LmlzQXJyYXkocykgPyBhZGRTdHlsZXMocywgc2V0MykgOiAoc2V0My5hZGQocyksIHNldDMpCiAgICAgICAgICAgICAgICAsIHNldDIpCiAgICAgICAgICAgIDsKICAgICAgICAgICAgY29uc3Qgc2V0ID0gYWRkU3R5bGVzKHVzZXJTdHlsZXMsIG5ldyBTZXQoKSk7CiAgICAgICAgICAgIGNvbnN0IHN0eWxlcyA9IFtdOwogICAgICAgICAgICBzZXQuZm9yRWFjaCgodik9PnN0eWxlcy51bnNoaWZ0KHYpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlcyA9IHN0eWxlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSB1c2VyU3R5bGVzID09PSB2b2lkIDAgPyBbXSA6IFsKICAgICAgICAgICAgICAgIHVzZXJTdHlsZXMKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fc3R5bGVzID0gdGhpcy5fc3R5bGVzLm1hcCgocyk9PnsKICAgICAgICAgICAgaWYgKHMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ICYmICFzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1RleHQxID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gczsKICAgICAgICB9KTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgc3VwZXIuaW5pdGlhbGl6ZSgpOwogICAgICAgIHRoaXMuY29uc3RydWN0b3IuX2dldFVuaXF1ZVN0eWxlcygpOwogICAgICAgIHRoaXMucmVuZGVyUm9vdCA9IHRoaXMuY3JlYXRlUmVuZGVyUm9vdCgpOwogICAgICAgIGlmICh3aW5kb3cuU2hhZG93Um9vdCAmJiB0aGlzLnJlbmRlclJvb3QgaW5zdGFuY2VvZiB3aW5kb3cuU2hhZG93Um9vdCkgewogICAgICAgICAgICB0aGlzLmFkb3B0U3R5bGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY3JlYXRlUmVuZGVyUm9vdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hTaGFkb3codGhpcy5jb25zdHJ1Y3Rvci5zaGFkb3dSb290T3B0aW9ucyk7CiAgICB9CiAgICBhZG9wdFN0eWxlcygpIHsKICAgICAgICBjb25zdCBzdHlsZXMgPSB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXM7CiAgICAgICAgaWYgKHN0eWxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAod2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDAgJiYgIXdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLlNjb3BpbmdTaGltLnByZXBhcmVBZG9wdGVkQ3NzVGV4dChzdHlsZXMubWFwKChzKT0+cy5jc3NUZXh0CiAgICAgICAgICAgICksIHRoaXMubG9jYWxOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYWRvcHRlZFN0eWxlU2hlZXRzID0gc3R5bGVzLm1hcCgocyk9PnMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ID8gcyA6IHMuc3R5bGVTaGVldAogICAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IHRydWU7CiAgICAgICAgfQogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgc3VwZXIuY29ubmVjdGVkQ2FsbGJhY2soKTsKICAgICAgICBpZiAodGhpcy5oYXNVcGRhdGVkICYmIHdpbmRvdy5TaGFkeUNTUyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHdpbmRvdy5TaGFkeUNTUy5zdHlsZUVsZW1lbnQodGhpcyk7CiAgICAgICAgfQogICAgfQogICAgdXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGVSZXN1bHQgPSB0aGlzLnJlbmRlcigpOwogICAgICAgIHN1cGVyLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgaWYgKHRlbXBsYXRlUmVzdWx0ICE9PSByZW5kZXJOb3RJbXBsZW1lbnRlZCkgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnJlbmRlcih0ZW1wbGF0ZVJlc3VsdCwgdGhpcy5yZW5kZXJSb290LCB7CiAgICAgICAgICAgICAgICBzY29wZU5hbWU6IHRoaXMubG9jYWxOYW1lLAogICAgICAgICAgICAgICAgZXZlbnRDb250ZXh0OiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXMuZm9yRWFjaCgocyk9PnsKICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICAgICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcy5jc3NUZXh0OwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJSb290LmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmVuZGVyKCkgewogICAgICAgIHJldHVybiByZW5kZXJOb3RJbXBsZW1lbnRlZDsKICAgIH0KfQpMaXRFbGVtZW50WyJmaW5hbGl6ZWQiXSA9IHRydWU7CkxpdEVsZW1lbnQucmVuZGVyID0gcmVuZGVyOwpMaXRFbGVtZW50LnNoYWRvd1Jvb3RPcHRpb25zID0gewogICAgbW9kZTogIm9wZW4iCn07CmNsYXNzIE1hdGVyaWFsIHsKICAgIHN0YXRpYyBoaWdoRW1waGFzaXNUZXh0Q29sb3IgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjg3KSc7CiAgICBzdGF0aWMgbWVkaXVtRW1waGFzaXNUZXh0Q29sb3IgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKSc7Cn0KY29uc3QgTUFURVJJQUxfQ1NTID0gY3NzYAoKOnJvb3QgewogIC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yOiByZ2IoMzAuNzUsIDMwLjc1LCAzMC43NSk7CiAgLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3I6IHJnYig0MC45NSwgNDAuOTUsIDQwLjk1KTsKICAtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjg3KTsKICAtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNjApOwogIC0tZGlzYWJsZWQtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjM4KTsKICAtLWJ1dHRvbi1ib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogIC0tcHJpbWFyeS1jb2xvcjogI2JiODZmYzsKICAtLWJhY2tncm91bmQtY29sb3I6ICMxMjEyMTI7CiAgLS1zYW5zLXNlcmlmLWZvbnQtZmFtaWx5OiAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsIGF2ZW5pciBuZXh0LCBhdmVuaXIsIGhlbHZldGljYSBuZXVlLCBoZWx2ZXRpY2EsIFVidW50dSwgcm9ib3RvLCBub3RvLCBzZWdvZSB1aSwgYXJpYWwsIHNhbnMtc2VyaWY7CiAgLS1tb25vc3BhY2UtZm9udC1mYW1pbHk6IE1lbmxvLCBDb25zb2xhcywgdWktbW9ub3NwYWNlLCBtb25vc3BhY2U7Cn0KCi8qKiB0ZXh0IHNpemUgY2xhc3NlcyAqLwoKLmg2IHsKICAgIGZvbnQtc2l6ZTogMS4yNXJlbTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjAwNzUwcmVtOwogICAgZm9udC13ZWlnaHQ6IGJvbGRlcjsKfQoKLmJvZHkyLCBmaWVsZHNldCBsYWJlbCwgZmllbGRzZXQgb3V0cHV0LCBmaWVsZHNldCBkZXRhaWxzIHsKICAgIGZvbnQtc2l6ZTogMC44NzVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMTc4NnJlbTsKICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7CiAgICBsaW5lLWhlaWdodDogMS4yNXJlbTsKfQoKLmJ1dHRvbiwgYnV0dG9uLCAuYWN0aW9uLWljb24gewogICAgZm9udC1zaXplOiAwLjg3NXJlbTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMC4wODkyOXJlbTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkZXI7Cn0KCi5vdmVybGluZSB7CiAgICBmb250LXNpemU6IDAuNjI1cmVtOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjE1MDAwcmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKfQoKLmNhcHRpb24gewogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDMzMzNyZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwp9CgovKiBsaWdodCB0ZXh0IG9uIGRhcmsgYmFja2dyb3VuZCBjb2xvcnMgKi8KCi5oaWdoLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCi5tZWRpdW0tZW1waGFzaXMtdGV4dCwgZmllbGRzZXQgbGFiZWwgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKLmRpc2FibGVkLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgovKiogZWxldmF0aW9uIGJhY2tncm91bmRzICovCgouc3VyZmFjZS0wMSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwp9Cgouc3VyZmFjZS0wNCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwp9CgovKiogYWN0aW9uLWljb24gKi8KCi5hY3Rpb24taWNvbiB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgbWluLWhlaWdodDogMnJlbTsKICAgIG1pbi13aWR0aDogMnJlbTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgb3BhY2l0eTogMC42OTsgIC8qKiBtZWRpdW0tZW1waGFzaXMgLyBoaWdoLWVtcGhhc2lzICovCiAgICB1c2VyLXNlbGVjdDogbm9uZTsKfQoKLmFjdGlvbi1pY29uOmhvdmVyIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICBvcGFjaXR5OiAxOwp9CgovKiogYnV0dG9uICovCgpidXR0b24gewogICAgYm9yZGVyOiBub25lOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHVzZXItc2VsZWN0OiBub25lOwogICAgbWluLXdpZHRoOiA4cmVtOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpidXR0b24uc2VsZWN0ZWQgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpidXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpidXR0b246ZGlzYWJsZWQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgpidXR0b246ZGlzYWJsZWQ6aG92ZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGN1cnNvcjogZGVmYXVsdDsKfQoKLyoqIGFuY2hvcnMgKi8KCmEgewogICAgY29sb3I6IHZhcigtLXByaW1hcnktY29sb3IpOwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjJyZW07CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7Cn0KCmE6aG92ZXIgewogICAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7Cn0KCi8qKiBmb3JtcyAqLwoKZmllbGRzZXQgewogICAgYm9yZGVyOiBzb2xpZCAxcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXJvdy1nYXA6IDFyZW07CiAgICBncmlkLWNvbHVtbi1nYXA6IDFyZW07CiAgICBwYWRkaW5nOiAxcmVtOwp9CgpsYWJlbCB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIC8qIGJhY2tncm91bmQtY29sb3I6IHJlZDsgKi8KICAgIHBhZGRpbmc6IDAuNXJlbSAwOwp9CgouZm9ybS1saHMgewogICAgZ3JpZC1jb2x1bW46IDE7Cn0KCmlucHV0LCAuZm9ybS1yaHMgewogICAgZ3JpZC1jb2x1bW46IDI7Cn0KCi5mb3JtLXJvdyB7CiAgICBncmlkLWNvbHVtbjogMSAvIHNwYW4gMjsKfQoKZmllbGRzZXQgaW5wdXRbdHlwZT10ZXh0XSB7CiAgICBwYWRkaW5nOiAwLjVyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXI6IHNvbGlkIDFweCB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7Cn0KCmZpZWxkc2V0IG91dHB1dCB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCmZpZWxkc2V0IGRldGFpbHMgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKYDsKY29uc3QgSEVBREVSX0hUTUwgPSBodG1sYAo8aGVhZGVyIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQiPgogICAgPGRpdiBpZD0iaGVhZGVyLWNvbnRlbnQiPgogICAgICAgIERlbm9mbGFyZSBUYWlsCiAgICAgICAgPHNwYW4gaWQ9ImhlYWRlci12ZXJzaW9uIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvc3Bhbj4KICAgICAgICA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiIGlkPSJnaXRodWItbG9nby1hbmNob3IiPjxpbWcgaWQ9ImdpdGh1Yi1sb2dvIj48L2E+CiAgICA8L2Rpdj4KPC9oZWFkZXI+CmA7CmNvbnN0IEhFQURFUl9DU1MgPSBjc3NgCmhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMXJlbSAwOwp9CgojaGVhZGVyLWNvbnRlbnQgewogICAgZmxleC1ncm93OiAxOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBiYXNlbGluZTsKICAgIHBhZGRpbmctcmlnaHQ6IDIuMnJlbTsKfQoKI2hlYWRlci12ZXJzaW9uIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI2dpdGh1Yi1sb2dvLWFuY2hvciB7CiAgICBsaW5lLWhlaWdodDogMDsKICAgIG9wYWNpdHk6IDAuNTsKfQoKI2dpdGh1Yi1sb2dvLWFuY2hvcjpob3ZlciB7CiAgICBvcGFjaXR5OiAwLjc1Owp9CgojZ2l0aHViLWxvZ28gewogICAgd2lkdGg6IDFyZW07CiAgICBtYXJnaW4tYm90dG9tOiAtMC4xcmVtOwoKfQoKYDsKZnVuY3Rpb24gaW5pdEhlYWRlcihkb2N1bWVudCwgX3ZtKSB7CiAgICBjb25zdCBoZWFkZXJWZXJzaW9uU3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFkZXItdmVyc2lvbicpOwogICAgY29uc3QgdmVyc2lvbiA9IGNvbXB1dGVWZXJzaW9uKCk7CiAgICBoZWFkZXJWZXJzaW9uU3Bhbi50ZXh0Q29udGVudCA9IHZlcnNpb24gPyBgdiR7dmVyc2lvbn1gIDogJyc7CiAgICBjb25zdCBnaXRodWJMb2dvSW1nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dpdGh1Yi1sb2dvJyk7CiAgICBnaXRodWJMb2dvSW1nLnNyYyA9IGNvbXB1dGVHaXRodWJMb2dvRGF0YVVybCgpOwogICAgcmV0dXJuICgpPT57CiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVHaXRodWJMb2dvRGF0YVVybCgpIHsKICAgIGNvbnN0IHN2ZzEgPSBHSVRIVUJfTE9HTy5yZXBsYWNlKCdmaWxsOndoaXRlOycsIGBmaWxsOiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfTtgKTsKICAgIHJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO3V0ZjgsJyArIHN2ZzE7Cn0KZnVuY3Rpb24gY29tcHV0ZVZlcnNpb24oKSB7CiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdGljLWRhdGEtc2NyaXB0Jyk7CiAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShzY3JpcHQudGV4dCk7CiAgICByZXR1cm4gdHlwZW9mIGRhdGEudmVyc2lvbiA9PT0gJ3N0cmluZycgPyBkYXRhLnZlcnNpb24gOiB1bmRlZmluZWQ7Cn0KY29uc3QgR0lUSFVCX0xPR08gPSBgPHN2ZyB3aWR0aD0iYXV0byIgaGVpZ2h0PSJhdXRvIiB2aWV3Qm94PSIwIDAgMTM2IDEzMyIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxuczpzZXJpZj0iaHR0cDovL3d3dy5zZXJpZi5jb20vIiBzdHlsZT0iZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjI7Ij4KPGcgdHJhbnNmb3JtPSJtYXRyaXgoNC4xNjY2NywwLDAsNC4xNjY2NywtNTY4LC0xMzgxLjA2KSI+CiAgICA8cGF0aCBkPSJNMTUyLjYwOCwzMzEuNDU1QzE0My42MTQsMzMxLjQ1NSAxMzYuMzIsMzM4Ljc0OCAxMzYuMzIsMzQ3Ljc0NUMxMzYuMzIsMzU0Ljk0MiAxNDAuOTg3LDM2MS4wNDcgMTQ3LjQ2LDM2My4yMDFDMTQ4LjI3NSwzNjMuMzUxIDE0OC41NzIsMzYyLjg0OCAxNDguNTcyLDM2Mi40MTZDMTQ4LjU3MiwzNjIuMDI5IDE0OC41NTgsMzYxLjAwNSAxNDguNTUsMzU5LjY0NkMxNDQuMDE5LDM2MC42MyAxNDMuMDYzLDM1Ny40NjIgMTQzLjA2MywzNTcuNDYyQzE0Mi4zMjIsMzU1LjU4IDE0MS4yNTQsMzU1LjA3OSAxNDEuMjU0LDM1NS4wNzlDMTM5Ljc3NSwzNTQuMDY5IDE0MS4zNjYsMzU0LjA4OSAxNDEuMzY2LDM1NC4wODlDMTQzLjAwMSwzNTQuMjA0IDE0My44NjEsMzU1Ljc2OCAxNDMuODYxLDM1NS43NjhDMTQ1LjMxNCwzNTguMjU3IDE0Ny42NzQsMzU3LjUzOCAxNDguNjAyLDM1Ny4xMjFDMTQ4Ljc1LDM1Ni4wNjkgMTQ5LjE3MSwzNTUuMzUxIDE0OS42MzYsMzU0Ljk0NEMxNDYuMDE5LDM1NC41MzMgMTQyLjIxNiwzNTMuMTM1IDE0Mi4yMTYsMzQ2Ljg5M0MxNDIuMjE2LDM0NS4xMTUgMTQyLjg1MSwzNDMuNjYgMTQzLjg5MywzNDIuNTIyQzE0My43MjUsMzQyLjExIDE0My4xNjYsMzQwLjQ1MyAxNDQuMDUzLDMzOC4yMTFDMTQ0LjA1MywzMzguMjExIDE0NS40MiwzMzcuNzczIDE0OC41MzIsMzM5Ljg4MUMxNDkuODMxLDMzOS41MTkgMTUxLjIyNSwzMzkuMzM5IDE1Mi42MSwzMzkuMzMyQzE1My45OTQsMzM5LjMzOSAxNTUuMzg3LDMzOS41MTkgMTU2LjY4OCwzMzkuODgxQzE1OS43OTgsMzM3Ljc3MyAxNjEuMTYzLDMzOC4yMTEgMTYxLjE2MywzMzguMjExQzE2Mi4wNTIsMzQwLjQ1MyAxNjEuNDkzLDM0Mi4xMSAxNjEuMzI2LDM0Mi41MjJDMTYyLjM3LDM0My42NiAxNjMsMzQ1LjExNSAxNjMsMzQ2Ljg5M0MxNjMsMzUzLjE1MSAxNTkuMTkxLDM1NC41MjggMTU1LjU2MywzNTQuOTMxQzE1Ni4xNDcsMzU1LjQzNCAxNTYuNjY4LDM1Ni40MjggMTU2LjY2OCwzNTcuOTQ3QzE1Ni42NjgsMzYwLjEyNSAxNTYuNjQ4LDM2MS44ODIgMTU2LjY0OCwzNjIuNDE2QzE1Ni42NDgsMzYyLjg1MiAxNTYuOTQyLDM2My4zNTkgMTU3Ljc2OCwzNjMuMkMxNjQuMjM2LDM2MS4wNDEgMTY4Ljg5OSwzNTQuOTQgMTY4Ljg5OSwzNDcuNzQ1QzE2OC44OTksMzM4Ljc0OCAxNjEuNjA1LDMzMS40NTUgMTUyLjYwOCwzMzEuNDU1WiIgc3R5bGU9ImZpbGw6d2hpdGU7Ii8+CjwvZz4KPC9zdmc+YDsKY29uc3QgU0lERUJBUl9IVE1MID0gaHRtbGAKPGRpdiBpZD0ic2lkZWJhciI+CiAgICAke0hFQURFUl9IVE1MfQogICAgPGRpdiBpZD0icHJvZmlsZXMiPjwvZGl2PgogICAgPGRpdiBpZD0ic2NyaXB0cyI+PC9kaXY+CjwvZGl2PgpgOwpjb25zdCBTSURFQkFSX0NTUyA9IGNzc2AKCiNzaWRlYmFyIHsKICAgIG1hcmdpbi1sZWZ0OiAxcmVtOwogICAgaGVpZ2h0OiAxMDB2aDsKICAgIG92ZXJmbG93LXk6IGhpZGRlbjsKICAgIG1pbi13aWR0aDogMTVyZW07Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZCB7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMnJlbTsKICAgIGdyaWQtZ2FwOiAxcHg7CiAgICBtYXJnaW4tbGVmdDogMXB4OwogICAgbWFyZ2luLXRvcDogMXJlbTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkLW5ldyB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIG1pbi13aWR0aDogOHJlbTsKfQoKI3NpZGViYXIgYnV0dG9uIHsKICAgIGdyaWQtY29sdW1uOiAxOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQgLmhpbnQgewogICAgZ3JpZC1jb2x1bW46IDE7IAogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLXRvcDogMC41cmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0U2lkZWJhcihkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHVwZGF0ZUhlYWRlciA9IGluaXRIZWFkZXIoZG9jdW1lbnQsIHZtKTsKICAgIGNvbnN0IHByb2ZpbGVzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGVzJyk7CiAgICBjb25zdCBzY3JpcHRzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmlwdHMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIHVwZGF0ZUhlYWRlcigpOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKFBST0ZJTEVTX0hUTUwodm0pLCBwcm9maWxlc0Rpdik7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoU0NSSVBUU19IVE1MKHZtKSwgc2NyaXB0c0Rpdik7CiAgICB9Owp9CmNvbnN0IFBST0ZJTEVTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPlByb2ZpbGVzPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgJHt2bS5wcm9maWxlcy5tYXAoKHByb2ZpbGUpPT5odG1sYDxidXR0b24gY2xhc3M9IiR7cHJvZmlsZS5pZCA9PT0gdm0uc2VsZWN0ZWRQcm9maWxlSWQgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoKT0+ewogICAgICAgICAgICB2bS5zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGUuaWQ7CiAgICAgICAgfX0gP2Rpc2FibGVkPSIke3ZtLnByb2ZpbGVGb3JtLnNob3dpbmd9Ij4ke3Byb2ZpbGUudGV4dH08L2J1dHRvbj4KICAgICAgICAke3Byb2ZpbGUuaWQgPT09IHZtLnNlbGVjdGVkUHJvZmlsZUlkID8gaHRtbGAke2FjdGlvbkljb24oZWRpdEljb24sIHsKICAgICAgICAgICAgb25jbGljazogKCk9PnZtLmVkaXRQcm9maWxlKHByb2ZpbGUuaWQpCiAgICAgICAgfSl9YCA6ICcnfWAKICAgICl9CiAgICAgICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQtbmV3Ij4ke2FjdGlvbkljb24oYWRkSWNvbiwgewogICAgICAgIHRleHQ6ICdOZXcnLAogICAgICAgIG9uY2xpY2s6ICgpPT52bS5uZXdQcm9maWxlKCkKICAgIH0pfTwvZGl2PgogICAgPC9kaXY+CmAKOwpjb25zdCBTQ1JJUFRTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPlNjcmlwdHM8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAke3ZtLnNjcmlwdHMubWFwKChzY3JpcHQpPT5odG1sYDxidXR0b24gY2xhc3M9IiR7dm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdC5pZCkgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PmhhbmRsZVNjcmlwdENsaWNrKGUsIHNjcmlwdC5pZCwgdm0pCiAgICAgICAgfSA/ZGlzYWJsZWQ9IiR7dm0ucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7c2NyaXB0LnRleHR9PC9idXR0b24+CiAgICAgICAgYAogICAgKX0KICAgICAgICA8ZGl2IGNsYXNzPSJjYXB0aW9uIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGhpbnQiPiR7Y29tcHV0ZU1ldGFLZXlDaGFyKCl9LWNsaWNrIHRvIG11bHRpc2VsZWN0PC9kaXY+CiAgICA8L2Rpdj4KYAo7CmZ1bmN0aW9uIGNvbXB1dGVNZXRhS2V5Q2hhcigpIHsKICAgIHJldHVybiBpc01hY2ludG9zaCgpID8gJ+KMmCcgOiBpc1dpbmRvd3MoKSA/ICfiip4nIDogJ21ldGEnOwp9CmZ1bmN0aW9uIGlzTWFjaW50b3NoKCkgewogICAgcmV0dXJuIG5hdmlnYXRvci5wbGF0Zm9ybS5pbmRleE9mKCdNYWMnKSA+IC0xOwp9CmZ1bmN0aW9uIGlzV2luZG93cygpIHsKICAgIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm0uaW5kZXhPZignV2luJykgPiAtMTsKfQpmdW5jdGlvbiBoYW5kbGVTY3JpcHRDbGljayhlLCBzY3JpcHRJZCwgdm0pIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IG5ld1NjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgIHNjcmlwdElkCiAgICBdKTsKICAgIHZtLnNlbGVjdGVkU2NyaXB0SWRzID0gZS5tZXRhS2V5ID8gdm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdElkKSA/IHNldFN1YnRyYWN0KHZtLnNlbGVjdGVkU2NyaXB0SWRzLCBuZXdTY3JpcHRJZHMpIDogc2V0VW5pb24odm0uc2VsZWN0ZWRTY3JpcHRJZHMsIG5ld1NjcmlwdElkcykgOiBuZXdTY3JpcHRJZHM7Cn0KZnVuY3Rpb24gYWN0aW9uSWNvbihpY29uLCBvcHRzID0gewp9KSB7CiAgICBjb25zdCB7IHRleHQgLCBvbmNsaWNrICB9ID0gb3B0czsKICAgIHJldHVybiBodG1sYDxkaXYgY2xhc3M9ImFjdGlvbi1pY29uIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgb25jbGljayAmJiBvbmNsaWNrKCk7CiAgICB9fT4ke2ljb259JHt0ZXh0IHx8ICcnfTwvZGl2PmA7Cn0KY29uc3QgZWRpdEljb24gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xNC4wNiA5LjAybC45Mi45Mkw1LjkyIDE5SDV2LS45Mmw5LjA2LTkuMDZNMTcuNjYgM2MtLjI1IDAtLjUxLjEtLjcuMjlsLTEuODMgMS44MyAzLjc1IDMuNzUgMS44My0xLjgzYy4zOS0uMzkuMzktMS4wMiAwLTEuNDFsLTIuMzQtMi4zNGMtLjItLjItLjQ1LS4yOS0uNzEtLjI5em0tMy42IDMuMTlMMyAxNy4yNVYyMWgzLjc1TDE3LjgxIDkuOTRsLTMuNzUtMy43NXoiLz48L3N2Zz5gOwpjb25zdCBhZGRJY29uID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij4+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE5IDEzaC02djZoLTJ2LTZINXYtMmg2VjVoMnY2aDZ2MnoiLz48L3N2Zz5gOwpmdW5jdGlvbiBwYXJzZUhlYWRlckZpbHRlcihoZWFkZXIpIHsKICAgIGNvbnN0IGkxID0gaGVhZGVyLmluZGV4T2YoJzonKTsKICAgIGlmIChpMSA8IDApIHJldHVybiB7CiAgICAgICAga2V5OiBoZWFkZXIKICAgIH07CiAgICBjb25zdCBrZXkgPSBoZWFkZXIuc3Vic3RyaW5nKDAsIGkxKS50cmltKCk7CiAgICBjb25zdCBxdWVyeSA9IGhlYWRlci5zdWJzdHJpbmcoaTEgKyAxKS50cmltKCk7CiAgICByZXR1cm4gewogICAgICAgIGtleSwKICAgICAgICBxdWVyeQogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyA9IG5ldyBTZXQoWwogICAgJ291dGNvbWUnLAogICAgJ3NjcmlwdE5hbWUnLAogICAgJ2V4Y2VwdGlvbnMnLAogICAgJ2xvZ3MnLAogICAgJ2V2ZW50VGltZXN0YW1wJywKICAgICdldmVudCcKXSk7CmNvbnN0IEtOT1dOX09VVENPTUVTID0gbmV3IFNldChbCiAgICAnb2snLAogICAgJ2V4Y2VwdGlvbicsCiAgICAnZXhjZWVkZWRDcHUnLAogICAgJ2NhbmNlbGVkJywKICAgICd1bmtub3duJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZShvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZTogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgb3V0Y29tZSAsIHNjcmlwdE5hbWUgLCBldmVudFRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCFLTk9XTl9PVVRDT01FUy5oYXMob3V0Y29tZSkpIHRocm93IG5ldyBFcnJvcihgQmFkIG91dGNvbWU6IGV4cGVjdGVkIG9uZSBvZiBbJHtbCiAgICAgICAgLi4uS05PV05fT1VUQ09NRVMKICAgIF0uam9pbignLCAnKX1dLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG91dGNvbWUpfWApOwogICAgaWYgKHNjcmlwdE5hbWUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjcmlwdE5hbWU6IGV4cGVjdGVkIG51bGwsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoc2NyaXB0TmFtZSl9YCk7CiAgICBjb25zdCBsb2dzID0gcGFyc2VMb2dzKG9iakFzQW55LmxvZ3MpOwogICAgY29uc3QgZXhjZXB0aW9ucyA9IHBhcnNlRXhjZXB0aW9ucyhvYmpBc0FueS5leGNlcHRpb25zKTsKICAgIGlmICghKHR5cGVvZiBldmVudFRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgZXZlbnRUaW1lc3RhbXAgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgZXZlbnRUaW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShldmVudFRpbWVzdGFtcCl9YCk7CiAgICBjb25zdCBldmVudCA9IG9iakFzQW55LmV2ZW50ICYmIG9iakFzQW55LmV2ZW50LnJlcXVlc3QgPyBwYXJzZVRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50KG9iakFzQW55LmV2ZW50KSA6IHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqQXNBbnkuZXZlbnQpOwogICAgcmV0dXJuIHsKICAgICAgICBvdXRjb21lLAogICAgICAgIHNjcmlwdE5hbWUsCiAgICAgICAgZXhjZXB0aW9ucywKICAgICAgICBsb2dzLAogICAgICAgIGV2ZW50VGltZXN0YW1wLAogICAgICAgIGV2ZW50CiAgICB9Owp9CmZ1bmN0aW9uIHBhcnNlTG9ncyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBsb2dzOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VMb2cpOwp9CmZ1bmN0aW9uIHBhcnNlRXhjZXB0aW9ucyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBleGNlcHRpb25zOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VFeGNlcHRpb24pOwp9CmZ1bmN0aW9uIGlzTG9nTWVzc2FnZVBhcnQodmFsdWUpIHsKICAgIGNvbnN0IHQgPSB0eXBlb2YgdmFsdWU7CiAgICByZXR1cm4gdCA9PT0gJ3N0cmluZycgfHwgdCA9PT0gJ251bWJlcicgfHwgdCA9PT0gJ2Jvb2xlYW4nIHx8IHQgPT09ICd1bmRlZmluZWQnIHx8IHQgPT09ICdvYmplY3QnOwp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyA9IG5ldyBTZXQoWwogICAgJ21lc3NhZ2UnLAogICAgJ2xldmVsJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlTG9nKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlTG9nOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IG1lc3NhZ2UxID0gcGFyc2VMb2dNZXNzYWdlUGFydEFycmF5KG9iakFzQW55Lm1lc3NhZ2UsICdtZXNzYWdlJyk7CiAgICBjb25zdCB7IGxldmVsICwgdGltZXN0YW1wICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgbGV2ZWwgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbGV2ZWw6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShsZXZlbCl9YCk7CiAgICBpZiAoISh0eXBlb2YgdGltZXN0YW1wID09PSAnbnVtYmVyJyAmJiB0aW1lc3RhbXAgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGltZXN0YW1wOiBleHBlY3RlZCBwb3NpdGl2ZSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkodGltZXN0YW1wKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgbWVzc2FnZTogbWVzc2FnZTEsCiAgICAgICAgbGV2ZWwsCiAgICAgICAgdGltZXN0YW1wCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FWENFUFRJT05fS0VZUyA9IG5ldyBTZXQoWwogICAgJ25hbWUnLAogICAgJ21lc3NhZ2UnLAogICAgJ3RpbWVzdGFtcCcKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VFeGNlcHRpb24ob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VFeGNlcHRpb246IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VYQ0VQVElPTl9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBuYW1lOiBuYW1lNCAsIG1lc3NhZ2U6IG1lc3NhZ2UxICwgdGltZXN0YW1wICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgbmFtZTQgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbmFtZTogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG5hbWU0KX1gKTsKICAgIGlmICghKHR5cGVvZiBtZXNzYWdlMSA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBtZXNzYWdlOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobWVzc2FnZTEpfWApOwogICAgaWYgKCEodHlwZW9mIHRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgdGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHRpbWVzdGFtcCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG5hbWU6IG5hbWU0LAogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UxLAogICAgICAgIHRpbWVzdGFtcAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfQ1JPTl9FVkVOVF9LRVlTID0gbmV3IFNldChbCiAgICAnY3JvbicsCiAgICAnc2NoZWR1bGVkVGltZScKXSk7CmZ1bmN0aW9uIGlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgcmV0dXJuIGZhbHNlOwogICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoT2JqZWN0LmtleXMob2JqKSk7CiAgICByZXR1cm4gc2V0RXF1YWwoa2V5cywgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyk7Cn0KZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUNyb25FdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUNyb25FdmVudDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfQ1JPTl9FVkVOVF9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBjcm9uICwgc2NoZWR1bGVkVGltZSAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIGNyb24gPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgY3JvbjogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KGNyb24pfWApOwogICAgaWYgKCEodHlwZW9mIHNjaGVkdWxlZFRpbWUgPT09ICdudW1iZXInICYmIHNjaGVkdWxlZFRpbWUgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgc2NoZWR1bGVkVGltZTogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHNjaGVkdWxlZFRpbWUpfWApOwogICAgcmV0dXJuIHsKICAgICAgICBjcm9uLAogICAgICAgIHNjaGVkdWxlZFRpbWUKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX1JFUVVFU1RfRVZFTlRfS0VZUyA9IG5ldyBTZXQoWwogICAgJ3JlcXVlc3QnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50OiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9SRVFVRVNUX0VWRU5UX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCByZXF1ZXN0ID0gcGFyc2VUYWlsTWVzc2FnZUV2ZW50UmVxdWVzdChvYmpBc0FueS5yZXF1ZXN0KTsKICAgIHJldHVybiB7CiAgICAgICAgcmVxdWVzdAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTID0gbmV3IFNldChbCiAgICAndXJsJywKICAgICdtZXRob2QnLAogICAgJ2hlYWRlcnMnCl0pOwpjb25zdCBPUFRJT05BTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTID0gbmV3IFNldChbCiAgICAnY2YnCl0pOwpjb25zdCBBTExfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IHNldFVuaW9uKFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMsIE9QVElPTkFMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMpOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlRXZlbnRSZXF1ZXN0KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlRXZlbnRSZXF1ZXN0OiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMsIEFMTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyB1cmwgLCBtZXRob2QgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdXJsOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkodXJsKX1gKTsKICAgIGlmICghKHR5cGVvZiBtZXRob2QgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWV0aG9kOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobWV0aG9kKX1gKTsKICAgIGNvbnN0IGhlYWRlcnMgPSBwYXJzZVN0cmluZ1JlY29yZChvYmpBc0FueS5oZWFkZXJzLCAnaGVhZGVycycpOwogICAgY29uc3QgY2YgPSBvYmpBc0FueS5jZiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogcGFyc2VJbmNvbWluZ1JlcXVlc3RDZlByb3BlcnRpZXMob2JqQXNBbnkuY2YpOwogICAgcmV0dXJuIHsKICAgICAgICB1cmwsCiAgICAgICAgbWV0aG9kLAogICAgICAgIGhlYWRlcnMsCiAgICAgICAgY2YKICAgIH07Cn0KZnVuY3Rpb24gY2hlY2tLZXlzKG9iaiwgcmVxdWlyZWRLZXlzLCBhbGxLZXlzKSB7CiAgICBjb25zdCBrZXlzID0gbmV3IFNldChPYmplY3Qua2V5cyhvYmopKTsKICAgIGNvbnN0IG1pc3NpbmdLZXlzID0gc2V0U3VidHJhY3QocmVxdWlyZWRLZXlzLCBrZXlzKTsKICAgIGlmIChtaXNzaW5nS2V5cy5zaXplID4gMCkgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGtleXM6ICR7WwogICAgICAgIC4uLm1pc3NpbmdLZXlzCiAgICBdLmpvaW4oJywgJyl9YCk7CiAgICBjb25zdCBleHRyYUtleXMgPSBzZXRTdWJ0cmFjdChrZXlzLCBhbGxLZXlzIHx8IHJlcXVpcmVkS2V5cyk7CiAgICBpZiAoZXh0cmFLZXlzLnNpemUgPiAwKSB0aHJvdyBuZXcgRXJyb3IoYEV4dHJhIGtleXM6ICR7WwogICAgICAgIC4uLmV4dHJhS2V5cwogICAgXS5qb2luKCcsICcpfWApOwp9CmZ1bmN0aW9uIHBhcnNlU3RyaW5nUmVjb3JkKG9iaiwgbmFtZTQpIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWU0fTogRXhwZWN0ZWQgc3RyaW5nIHJlY29yZCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgZm9yIChjb25zdCBbXywgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWU0fTogRXhwZWN0ZWQgc3RyaW5nIHJlY29yZCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgfQogICAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBwYXJzZUxvZ01lc3NhZ2VQYXJ0QXJyYXkob2JqLCBuYW1lNCkgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8ICFBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZTR9OiBFeHBlY3RlZCBsb2cgbWVzc2FnZSBwYXJ0IGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIG9iail7CiAgICAgICAgaWYgKCFpc0xvZ01lc3NhZ2VQYXJ0KHZhbHVlKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lNH06IEV4cGVjdGVkIGxvZyBtZXNzYWdlIHBhcnQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIH0KICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gcGFyc2VJbmNvbWluZ1JlcXVlc3RDZlByb3BlcnRpZXMob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgY2Y6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBkdW1wTWVzc2FnZVByZXR0eShtZXNzYWdlMSwgbG9nZ2VyKSB7CiAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZShtZXNzYWdlMS5ldmVudFRpbWVzdGFtcCkpOwogICAgY29uc3Qgb3V0Y29tZSA9IFBSRVRUWV9PVVRDT01FUy5nZXQobWVzc2FnZTEub3V0Y29tZSkgfHwgbWVzc2FnZTEub3V0Y29tZTsKICAgIGNvbnN0IG91dGNvbWVDb2xvciA9IG1lc3NhZ2UxLm91dGNvbWUgPT09ICdvaycgPyAnZ3JlZW4nIDogJ3JlZCc7CiAgICBjb25zdCB7IHByb3BzICwgcmVtYWluaW5nTG9ncyAgfSA9IHBhcnNlTG9nUHJvcHMobWVzc2FnZTEubG9ncyk7CiAgICBpZiAoaXNUYWlsTWVzc2FnZUNyb25FdmVudChtZXNzYWdlMS5ldmVudCkpIHsKICAgICAgICBjb25zdCBjb2xvID0gcHJvcHMuY29sbyB8fCAnPz8/JzsKICAgICAgICBsb2dnZXIoYFslYyR7dGltZX0lY10gWyVjJHtjb2xvfSVjXSBbJWMke291dGNvbWV9JWNdICVjJHttZXNzYWdlMS5ldmVudC5jcm9ufWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHsgbWV0aG9kICwgdXJsICwgY2YgIH0gPSBtZXNzYWdlMS5ldmVudC5yZXF1ZXN0OwogICAgICAgIGNvbnN0IGNvbG8gPSBjZj8uY29sbyB8fCBwcm9wcy5jb2xvIHx8ICc/Pz8nOwogICAgICAgIGlmIChjZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNvbnN0IGR1cmFibGVPYmplY3RJbmZvID0gY29tcHV0ZUR1cmFibGVPYmplY3RJbmZvKHByb3BzKTsKICAgICAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSBbJWMke2R1cmFibGVPYmplY3RJbmZvfSVjXSAke21ldGhvZH0gJWMke3VybH1gLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtvdXRjb21lQ29sb3J9YCwgJycsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IHJlZDsgZm9udC1zdHlsZTogYm9sZDsnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsb2dnZXIoYFslYyR7dGltZX0lY10gWyVjJHtjb2xvfSVjXSBbJWMke291dGNvbWV9JWNdICR7bWV0aG9kfSAlYyR7dXJsfWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCB7IGxldmVsICwgbWVzc2FnZTogbG9nTWVzc2FnZSAgfSBvZiByZW1haW5pbmdMb2dzKXsKICAgICAgICBjb25zdCBsZXZlbENvbG9yID0gTE9HX0xFVkVMX0NPTE9SUy5nZXQobGV2ZWwpIHx8ICdncmF5JzsKICAgICAgICBjb25zdCBsb2dNZXNzYWdlcyA9IGxvZ01lc3NhZ2UubWFwKGZvcm1hdExvZ01lc3NhZ2VQYXJ0KS5qb2luKCcsICcpOwogICAgICAgIGxvZ2dlcihgICVjfCVjIFslYyR7bGV2ZWx9JWNdICR7bG9nTWVzc2FnZXN9YCwgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtsZXZlbENvbG9yfWAsICcnKTsKICAgIH0KICAgIGZvciAoY29uc3QgeyBuYW1lOiBuYW1lNCAsIG1lc3NhZ2U6IGV4Y2VwdGlvbk1lc3NhZ2UgIH0gb2YgbWVzc2FnZTEuZXhjZXB0aW9ucyl7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtuYW1lNH0lY10gJWMke2V4Y2VwdGlvbk1lc3NhZ2V9YCwgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkYCwgJycsICdjb2xvcjogcmVkJyk7CiAgICB9Cn0KZnVuY3Rpb24gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhkYXRlKSB7CiAgICByZXR1cm4gWwogICAgICAgIGRhdGUuZ2V0RnVsbFllYXIoKSwKICAgICAgICAnLScsCiAgICAgICAgcGFkMihkYXRlLmdldE1vbnRoKCkgKyAxKSwKICAgICAgICAnLScsCiAgICAgICAgcGFkMihkYXRlLmdldERhdGUoKSksCiAgICAgICAgJyAnLAogICAgICAgIHBhZDIoZGF0ZS5nZXRIb3VycygpKSwKICAgICAgICAnOicsCiAgICAgICAgcGFkMihkYXRlLmdldE1pbnV0ZXMoKSksCiAgICAgICAgJzonLAogICAgICAgIHBhZDIoZGF0ZS5nZXRTZWNvbmRzKCkpCiAgICBdLmpvaW4oJycpOwp9CmZ1bmN0aW9uIGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcykgewogICAgY29uc3QgZHVyYWJsZU9iamVjdENsYXNzID0gKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0Q2xhc3MgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdENsYXNzIDogJycpLnRyaW0oKTsKICAgIGNvbnN0IGR1cmFibGVPYmplY3RJZCA9ICh0eXBlb2YgcHJvcHMuZHVyYWJsZU9iamVjdElkID09PSAnc3RyaW5nJyA/IHByb3BzLmR1cmFibGVPYmplY3RJZCA6ICcnKS50cmltKCk7CiAgICBjb25zdCBkdXJhYmxlT2JqZWN0TmFtZSA9ICh0eXBlb2YgcHJvcHMuZHVyYWJsZU9iamVjdE5hbWUgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdE5hbWUgOiAnJykudHJpbSgpOwogICAgY29uc3QgcnQgPSBbXTsKICAgIGlmIChkdXJhYmxlT2JqZWN0Q2xhc3MubGVuZ3RoID4gMCkgcnQucHVzaChkdXJhYmxlT2JqZWN0Q2xhc3MpOwogICAgaWYgKGR1cmFibGVPYmplY3ROYW1lLmxlbmd0aCA+IDApIHJ0LnB1c2goZHVyYWJsZU9iamVjdE5hbWUpOwogICAgaWYgKGR1cmFibGVPYmplY3RJZC5sZW5ndGggPiAwKSBydC5wdXNoKGNvbXB1dGVTaG9ydER1cmFibGVPYmplY3RJZChkdXJhYmxlT2JqZWN0SWQpKTsKICAgIHJldHVybiBydC5sZW5ndGggPiAwID8gcnQuam9pbignICcpIDogJ0RPJzsKfQpmdW5jdGlvbiBjb21wdXRlU2hvcnREdXJhYmxlT2JqZWN0SWQoaWQpIHsKICAgIHJldHVybiAvXlswLTlhLWZBLUZdezUsfSQvLnRlc3QoaWQpID8gYCR7aWQuc3Vic3RyaW5nKDAsIDQpfeKApmAgOiBpZDsKfQpmdW5jdGlvbiBwYXJzZUxvZ1Byb3BzKGxvZ3MpIHsKICAgIGNvbnN0IHJlbWFpbmluZ0xvZ3MgPSBbXTsKICAgIGNvbnN0IHByb3BzID0gewogICAgfTsKICAgIGZvciAoY29uc3QgbG9nIG9mIGxvZ3MpewogICAgICAgIGlmIChsb2cubWVzc2FnZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGxvZy5tZXNzYWdlWzBdOwogICAgICAgICAgICBpZiAodHlwZW9mIG1zZyA9PT0gJ3N0cmluZycgJiYgbXNnLnN0YXJ0c1dpdGgoJ2xvZ3Byb3BzOicpKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbGVyID0gbXNnLnN1YnN0cmluZyhtc2cuaW5kZXhPZignOicpICsgMSk7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbGVyUHJvcHMgPSB0cnlQYXJzZVByb3BzRnJvbUpzb24odHJhaWxlcik7CiAgICAgICAgICAgICAgICBhcHBlbmRQcm9wcyh0cmFpbGVyUHJvcHMsIHByb3BzKTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcGFydCBvZiBsb2cubWVzc2FnZS5zbGljZSgxKSl7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFydFByb3BzID0gdHJ5UGFyc2VQcm9wc0Zyb21QYXJ0KHBhcnQpOwogICAgICAgICAgICAgICAgICAgIGFwcGVuZFByb3BzKHBhcnRQcm9wcywgcHJvcHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVtYWluaW5nTG9ncy5wdXNoKGxvZyk7CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIHByb3BzLAogICAgICAgIHJlbWFpbmluZ0xvZ3MKICAgIH07Cn0KZnVuY3Rpb24gYXBwZW5kUHJvcHMoc3JjLCBkc3QpIHsKICAgIGlmIChzcmMpIHsKICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzcmMpKXsKICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gdHJ5UGFyc2VQcm9wc0Zyb21Kc29uKHZhbHVlKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IHByb3BzID0gSlNPTi5wYXJzZSh2YWx1ZS50cmltKCkpOwogICAgICAgIGlmICh0eXBlb2YgcHJvcHMgPT09ICdvYmplY3QnICYmIHByb3BzICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KHByb3BzKSkgewogICAgICAgICAgICByZXR1cm4gcHJvcHM7CiAgICAgICAgfQogICAgfSBjYXRjaCAgewogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiB0cnlQYXJzZVByb3BzRnJvbVBhcnQocGFydCkgewogICAgdHJ5IHsKICAgICAgICBpZiAodHlwZW9mIHBhcnQgPT09ICdvYmplY3QnICYmIHBhcnQgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkocGFydCkpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnQ7CiAgICAgICAgfQogICAgfSBjYXRjaCAgewogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBmb3JtYXRMb2dNZXNzYWdlUGFydChwYXJ0KSB7CiAgICBpZiAodHlwZW9mIHBhcnQgPT09ICdvYmplY3QnKSByZXR1cm4gSlNPTi5zdHJpbmdpZnkocGFydCk7CiAgICByZXR1cm4gYCR7cGFydH1gOwp9CmZ1bmN0aW9uIHBhZDIobnVtKSB7CiAgICByZXR1cm4gbnVtLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKTsKfQpjb25zdCBQUkVUVFlfT1VUQ09NRVMgPSBuZXcgTWFwKFsKICAgIFsKICAgICAgICAnb2snLAogICAgICAgICdPaycKICAgIF0sCiAgICBbCiAgICAgICAgJ2V4Y2VwdGlvbicsCiAgICAgICAgJ0Vycm9yJwogICAgXSwKICAgIFsKICAgICAgICAnZXhjZWVkZWRDcHUnLAogICAgICAgICdFeGNlZWRlZCBMaW1pdCcKICAgIF0sCiAgICBbCiAgICAgICAgJ2NhbmNlbGVkJywKICAgICAgICAnQ2FuY2VsZWQnCiAgICBdLAogICAgWwogICAgICAgICd1bmtub3duJywKICAgICAgICAnVW5rbm93bicKICAgIF0sIApdKTsKY29uc3QgTE9HX0xFVkVMX0NPTE9SUyA9IG5ldyBNYXAoWwogICAgWwogICAgICAgICd0cmFjZScsCiAgICAgICAgJ2dyYXknCiAgICBdLAogICAgWwogICAgICAgICdkZWJ1ZycsCiAgICAgICAgJ3B1cnBsZScKICAgIF0sCiAgICBbCiAgICAgICAgJ2xvZycsCiAgICAgICAgJ2dyYXknCiAgICBdLAogICAgWwogICAgICAgICdpbmZvJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ3dhcm4nLAogICAgICAgICdyZWQnCiAgICBdLAogICAgWwogICAgICAgICdlcnJvcicsCiAgICAgICAgJ3JlZCcKICAgIF0sIApdKTsKZnVuY3Rpb24gZ2VuZXJhdGVVdWlkKCkgewogICAgY29uc3QgY3J5cHRvQXNBbnkgPSBjcnlwdG87CiAgICBpZiAodHlwZW9mIGNyeXB0b0FzQW55LnJhbmRvbVVVSUQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gY3J5cHRvQXNBbnkucmFuZG9tVVVJRCgpOwogICAgfQogICAgY29uc3Qgcm5kcyA9IGNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQ4QXJyYXkoMTYpKTsKICAgIHJuZHNbNl0gPSBybmRzWzZdICYgMTUgfCA2NDsKICAgIHJuZHNbOF0gPSBybmRzWzhdICYgNjMgfCAxMjg7CiAgICByZXR1cm4gYnl0ZXNUb1V1aWQocm5kcyk7Cn0KZnVuY3Rpb24gYnl0ZXNUb1V1aWQoYnl0ZXMpIHsKICAgIGNvbnN0IGJpdHMgPSBbCiAgICAgICAgLi4uYnl0ZXMKICAgIF0ubWFwKChiaXQpPT57CiAgICAgICAgY29uc3QgcyA9IGJpdC50b1N0cmluZygxNik7CiAgICAgICAgcmV0dXJuIGJpdCA8IDE2ID8gIjAiICsgcyA6IHM7CiAgICB9KTsKICAgIHJldHVybiBbCiAgICAgICAgLi4uYml0cy5zbGljZSgwLCA0KSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSg0LCA2KSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSg2LCA4KSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSg4LCAxMCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoMTAsIDE2KSwgCiAgICBdLmpvaW4oIiIpOwp9CmNsYXNzIFRhaWxDb25uZWN0aW9uIHsKICAgIHN0YXRpYyBWRVJCT1NFID0gZmFsc2U7CiAgICB3czsKICAgIGNhbGxiYWNrczsKICAgIG9wdGlvbnM7CiAgICBjb25zdHJ1Y3Rvcih3ZWJTb2NrZXRVcmwsIGNhbGxiYWNrczEpewogICAgICAgIHRoaXMud3MgPSBuZXcgV2ViU29ja2V0KHdlYlNvY2tldFVybCwgJ3RyYWNlLXYxJyk7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3MxOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignb3BlbicsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgdGhpcy5zZW5kT3B0aW9uc0lmT3BlbigpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzMS5vbk9wZW4pIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25PcGVuKHRoaXMsIHRpbWVTdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ2Nsb3NlJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IGNvZGUgLCByZWFzb24gLCB3YXNDbGVhbiAsIHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzMS5vbkNsb3NlKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3MxLm9uQ2xvc2UodGhpcywgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGNvbnN0IGVycm9ySW5mbyA9IGNvbXB1dGVFcnJvckluZm8oZXZlbnQpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzMS5vbkVycm9yKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3MxLm9uRXJyb3IodGhpcywgdGltZVN0YW1wLCBlcnJvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgYXN5bmMgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICBpZiAoZXZlbnQuZGF0YSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCBldmVudC5kYXRhLnRleHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IG9iaiA9IEpTT04ucGFyc2UodGV4dCk7CiAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZTE7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UxID0gcGFyc2VUYWlsTWVzc2FnZShvYmopOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25VbnBhcnNlZE1lc3NhZ2UodGhpcywgdGltZVN0YW1wLCBvYmosIGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25UYWlsTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIG1lc3NhZ2UxKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25VbnBhcnNlZE1lc3NhZ2UodGhpcywgdGltZVN0YW1wLCBldmVudC5kYXRhLCBuZXcgRXJyb3IoYEV4cGVjdGVkIGV2ZW50LmRhdGEgdG8gYmUgQmxvYmApKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgc2V0T3B0aW9ucyhvcHRpb25zKSB7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICB0aGlzLnNlbmRPcHRpb25zSWZPcGVuKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjbG9zZShjb2RlLCByZWFzb24pIHsKICAgICAgICB0aGlzLndzLmNsb3NlKGNvZGUsIHJlYXNvbik7CiAgICB9CiAgICBzZW5kT3B0aW9uc0lmT3BlbigpIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zICYmIHRoaXMud3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICAgICAgY29uc3QgcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhgc2VuZE9wdGlvbnNJZk9wZW46IHNlbmRpbmcgJHtwYXlsb2FkfWApOwogICAgICAgICAgICB0aGlzLndzLnNlbmQocGF5bG9hZCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVFcnJvckluZm8oZXZlbnQpIHsKICAgIGlmIChldmVudC50eXBlID09PSAnZXJyb3InKSB7CiAgICAgICAgY29uc3QgeyBtZXNzYWdlOiBtZXNzYWdlMSAsIGZpbGVuYW1lICwgbGluZW5vICwgY29sbm8gLCBlcnJvciAgfSA9IGV2ZW50OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UxLAogICAgICAgICAgICBmaWxlbmFtZSwKICAgICAgICAgICAgbGluZW5vLAogICAgICAgICAgICBjb2xubywKICAgICAgICAgICAgZXJyb3IKICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpjbGFzcyBUYWlsQ29udHJvbGxlciB7CiAgICBjYWxsYmFja3M7CiAgICByZWNvcmRzID0gbmV3IE1hcCgpOwogICAgdGFpbE9wdGlvbnMgPSB7CiAgICAgICAgZmlsdGVyczogW10KICAgIH07CiAgICBjb25zdHJ1Y3RvcihjYWxsYmFja3MyKXsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczI7CiAgICB9CiAgICBzZXRUYWlsT3B0aW9ucyh0YWlsT3B0aW9ucykgewogICAgICAgIGNvbnNvbGUubG9nKGBUYWlsQ29udHJvbGxlci5zZXRUYWlsT3B0aW9ucyAke0pTT04uc3RyaW5naWZ5KHRhaWxPcHRpb25zKX1gKTsKICAgICAgICB0aGlzLnRhaWxPcHRpb25zID0gdGFpbE9wdGlvbnM7CiAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5yZWNvcmRzLnZhbHVlcygpKXsKICAgICAgICAgICAgaWYgKHJlY29yZC5jb25uZWN0aW9uKSB7CiAgICAgICAgICAgICAgICByZWNvcmQuY29ubmVjdGlvbi5zZXRPcHRpb25zKHRhaWxPcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHNldFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4sIHNjcmlwdElkcykgewogICAgICAgIGNvbnN0IHN0b3BLZXlzID0gc2V0U3VidHJhY3QodGhpcy5jb21wdXRlU3RhcnRpbmdPclN0YXJ0ZWRUYWlsS2V5cygpLCBuZXcgU2V0KFsKICAgICAgICAgICAgLi4uc2NyaXB0SWRzCiAgICAgICAgXS5tYXAoKHYpPT5jb21wdXRlVGFpbEtleShhY2NvdW50SWQsIHYpCiAgICAgICAgKSkpOwogICAgICAgIGZvciAoY29uc3Qgc3RvcEtleSBvZiBzdG9wS2V5cyl7CiAgICAgICAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQoc3RvcEtleSk7CiAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdpbmFjdGl2ZSc7CiAgICAgICAgICAgIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScgJiYgcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lICYmIERhdGUubm93KCkgLSByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPj0gNTAwMCkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdjbG9zaW5nJzsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQ2xvc2luZyAke3VucGFja1RhaWxLZXkocmVjb3JkLnRhaWxLZXkpLnNjcmlwdElkfSwgaW5hY3RpdmUgZm9yICR7RGF0ZS5ub3coKSAtIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZX1tc2ApOwogICAgICAgICAgICAgICAgICAgIHJlY29yZC5jb25uZWN0aW9uPy5jbG9zZSgxMDAwLCAnbm8gbG9uZ2VyIGludGVyZXN0ZWQnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY29yZHMuZGVsZXRlKHJlY29yZC50YWlsS2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgNTAwMCk7CiAgICAgICAgfQogICAgICAgIGlmIChzdG9wS2V5cy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLmRpc3BhdGNoVGFpbHNDaGFuZ2VkKCk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3Qgc2NyaXB0SWQgb2Ygc2NyaXB0SWRzKXsKICAgICAgICAgICAgY29uc3QgdGFpbEtleSA9IGNvbXB1dGVUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQodGFpbEtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ1JlY29yZCkgewogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkLnN0YXRlID09PSAnaW5hY3RpdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFJldml2aW5nIGluYWN0aXZlICR7c2NyaXB0SWR9YCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZC5zdGF0ZSA9ICdzdGFydGVkJzsKICAgICAgICAgICAgICAgIGV4aXN0aW5nUmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkID0gewogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnc3RhcnRpbmcnLAogICAgICAgICAgICAgICAgICAgIHRhaWxLZXkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLnJlY29yZHMuc2V0KHRhaWxLZXksIHJlY29yZCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YWlsQ3JlYXRpbmdUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgICAgICAgICAgY29uc3QgdGFpbCA9IGF3YWl0IGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHRJZCwgYXBpVG9rZW4pOwogICAgICAgICAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpIC0gdGFpbENyZWF0aW5nVGltZSwgdGFpbCk7CiAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlICE9PSAnc3RhcnRpbmcnKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB7IGNhbGxiYWNrczogY2FsbGJhY2tzMyAgfSA9IHRoaXM7CiAgICAgICAgICAgICAgICBjb25zdCBvcGVuaW5nVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YWlsQ29ubmVjdGlvbkNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgICAgICAgICBvbk9wZW4gKF9jbiwgdGltZVN0YW1wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrczMub25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBEYXRlLm5vdygpIC0gb3BlbmluZ1RpbWUpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb25DbG9zZSAoX2NuLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMy5vblRhaWxDb25uZWN0aW9uQ2xvc2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG9uRXJyb3IgKF9jbiwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMy5vblRhaWxDb25uZWN0aW9uRXJyb3IoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb25UYWlsTWVzc2FnZSAoX2NuLCB0aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSAhPT0gJ3N0YXJ0ZWQnKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrczMub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG9uVW5wYXJzZWRNZXNzYWdlIChfY24sIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MzLm9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24gPSBuZXcgVGFpbENvbm5lY3Rpb24odGFpbC51cmwsIHRhaWxDb25uZWN0aW9uQ2FsbGJhY2tzKS5zZXRPcHRpb25zKHRoaXMudGFpbE9wdGlvbnMpOwogICAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gJ3N0YXJ0ZWQnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKTsKICAgICAgICB9CiAgICB9CiAgICBkaXNwYXRjaFRhaWxzQ2hhbmdlZCgpIHsKICAgICAgICBjb25zdCB0YWlsS2V5cyA9IG5ldyBTZXQoWwogICAgICAgICAgICAuLi50aGlzLnJlY29yZHMudmFsdWVzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYuc3RhdGUgPT09ICdzdGFydGVkJwogICAgICAgICkubWFwKCh2KT0+di50YWlsS2V5CiAgICAgICAgKSk7CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsc0NoYW5nZWQodGFpbEtleXMpOwogICAgfQogICAgY29tcHV0ZVN0YXJ0aW5nT3JTdGFydGVkVGFpbEtleXMoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTZXQoWwogICAgICAgICAgICAuLi50aGlzLnJlY29yZHMudmFsdWVzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYuc3RhdGUgPT09ICdzdGFydGluZycgfHwgdi5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnCiAgICAgICAgKS5tYXAoKHYpPT52LnRhaWxLZXkKICAgICAgICApKTsKICAgIH0KfQpmdW5jdGlvbiB1bnBhY2tUYWlsS2V5KHRhaWxLZXkpIHsKICAgIGNvbnN0IG0gPSAvXihbXlxzLV0rKS0oW15cc10rKSQvLmV4ZWModGFpbEtleSk7CiAgICBpZiAoIW0pIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxLZXk6ICR7dGFpbEtleX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgYWNjb3VudElkOiBtWzFdLAogICAgICAgIHNjcmlwdElkOiBtWzJdCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpIHsKICAgIHJldHVybiBgJHthY2NvdW50SWR9LSR7c2NyaXB0SWR9YDsKfQpjbGFzcyBUYWlsd2ViQXBwVk0gewogICAgcHJvZmlsZXMgPSBbXTsKICAgIGdldCBzZWxlY3RlZFByb2ZpbGVJZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQ7CiAgICB9CiAgICBzZXQgc2VsZWN0ZWRQcm9maWxlSWQodmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPT09IHZhbHVlKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPSB2YWx1ZTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCA9IHZhbHVlOwogICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB0aGlzLmZpbmRTY3JpcHRzKCk7CiAgICB9CiAgICBzY3JpcHRzID0gW107CiAgICBnZXQgc2VsZWN0ZWRTY3JpcHRJZHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzOwogICAgfQogICAgc2V0IHNlbGVjdGVkU2NyaXB0SWRzKHNjcmlwdElkcykgewogICAgICAgIGlmIChzZXRFcXVhbCh0aGlzLl9zZWxlY3RlZFNjcmlwdElkcywgc2NyaXB0SWRzKSkgcmV0dXJuOwogICAgICAgIHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldChzY3JpcHRJZHMpOwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgIGlmIChwcm9maWxlKSB7CiAgICAgICAgICAgIHByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMgPSBbCiAgICAgICAgICAgICAgICAuLi5zY3JpcHRJZHMKICAgICAgICAgICAgXTsKICAgICAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIH0KICAgICAgICB0aGlzLnNldFRhaWxzKCk7CiAgICB9CiAgICBwcm9maWxlRm9ybSA9IG5ldyBQcm9maWxlRm9ybVZNKCk7CiAgICBmaWx0ZXJGb3JtID0gbmV3IEZpbHRlckZvcm1WTSgpOwogICAgZmlsdGVyID0gewogICAgfTsKICAgIHRhaWxzID0gbmV3IFNldCgpOwogICAgc3RhdGUgPSBsb2FkU3RhdGUoKTsKICAgIHRhaWxDb250cm9sbGVyOwogICAgX3NlbGVjdGVkUHJvZmlsZUlkOwogICAgX3NlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldCgpOwogICAgb25jaGFuZ2UgPSAoKT0+ewogICAgfTsKICAgIGxvZ2dlciA9ICgpPT57CiAgICB9OwogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBjb25zdCBkaXMgPSB0aGlzOwogICAgICAgIGNvbnN0IGxvZ1RhaWxzQ2hhbmdlID0gKGFjdGlvbiwgdGFpbEtleXMpPT57CiAgICAgICAgICAgIGlmICh0YWlsS2V5cy5zaXplID4gMCkgdGhpcy5sb2dXaXRoUHJlZml4KGAke2FjdGlvbn0gJHtbCiAgICAgICAgICAgICAgICAuLi50YWlsS2V5cwogICAgICAgICAgICBdLm1hcCgodik9PnVucGFja1RhaWxLZXkodikuc2NyaXB0SWQKICAgICAgICAgICAgKS5zb3J0KCkuam9pbignLCAnKX1gKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGxvZ1dpdGhQcmVmaXggPSB0aGlzLmxvZ1dpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCB2ZXJib3NlV2l0aFByZWZpeCA9IHRoaXMudmVyYm9zZVdpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCBjYWxsYmFja3MzID0gewogICAgICAgICAgICBvblRhaWxDcmVhdGluZyAoX2FjY291bnRJZCwgc2NyaXB0SWQpIHsKICAgICAgICAgICAgICAgIHZlcmJvc2VXaXRoUHJlZml4KGBDcmVhdGluZyB0YWlsIGZvciAke3NjcmlwdElkfS4uLmApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDcmVhdGVkIChfYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCkgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENyZWF0ZWQgdGFpbCBmb3IgJHtzY3JpcHRJZH0gaW4gJHt0b29rTWlsbGlzfW1zLCAke0pTT04uc3RyaW5naWZ5KHRhaWwpfWApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uT3BlbiAoX2FjY291bnRJZCwgc2NyaXB0SWQsIF90aW1lU3RhbXAsIHRvb2tNaWxsaXMpIHsKICAgICAgICAgICAgICAgIHZlcmJvc2VXaXRoUHJlZml4KGBPcGVuZWQgdGFpbCBmb3IgJHtzY3JpcHRJZH0gaW4gJHt0b29rTWlsbGlzfW1zYCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25DbG9zZSAoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25UYWlsQ29ubmVjdGlvbkNsb3NlJywgewogICAgICAgICAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgICAgICAgICBzY3JpcHRJZCwKICAgICAgICAgICAgICAgICAgICB0aW1lU3RhbXAsCiAgICAgICAgICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgICAgICAgICByZWFzb24sCiAgICAgICAgICAgICAgICAgICAgd2FzQ2xlYW4KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENsb3NlZCB0YWlsIGZvciAke3NjcmlwdElkfSwgJHtKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgICAgICAgICByZWFzb24sCiAgICAgICAgICAgICAgICAgICAgd2FzQ2xlYW4KICAgICAgICAgICAgICAgIH0pfWApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uRXJyb3IgKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25UYWlsQ29ubmVjdGlvbkVycm9yJywgewogICAgICAgICAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgICAgICAgICBzY3JpcHRJZCwKICAgICAgICAgICAgICAgICAgICB0aW1lU3RhbXAsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JJbmZvCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoYEVycm9yIGluIHRhaWwgZm9yICR7c2NyaXB0SWR9YCwgewogICAgICAgICAgICAgICAgICAgIGVycm9ySW5mbwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25NZXNzYWdlIChfYWNjb3VudElkLCBfc2NyaXB0SWQsIF90aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChjb21wdXRlTWVzc2FnZVBhc3Nlc0ZpbHRlcihtZXNzYWdlLCBkaXMuZmlsdGVyKSkgewogICAgICAgICAgICAgICAgICAgIGR1bXBNZXNzYWdlUHJldHR5KG1lc3NhZ2UsIGRpcy5sb2dnZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlIChfYWNjb3VudElkLCBzY3JpcHRJZCwgX3RpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2cobWVzc2FnZSk7CiAgICAgICAgICAgICAgICBsb2dXaXRoUHJlZml4KGBVbnBhcnNlZCBtZXNzYWdlIGluIHRhaWwgZm9yICR7c2NyaXB0SWR9YCwgcGFyc2VFcnJvci5zdGFjayB8fCBwYXJzZUVycm9yLm1lc3NhZ2UpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxzQ2hhbmdlZCAodGFpbHMpIHsKICAgICAgICAgICAgICAgIGlmIChzZXRFcXVhbChkaXMudGFpbHMsIHRhaWxzKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlZCA9IHNldFN1YnRyYWN0KGRpcy50YWlscywgdGFpbHMpOwogICAgICAgICAgICAgICAgbG9nVGFpbHNDaGFuZ2UoJ1VudGFpbGluZycsIHJlbW92ZWQpOwogICAgICAgICAgICAgICAgY29uc3QgYWRkZWQgPSBzZXRTdWJ0cmFjdCh0YWlscywgZGlzLnRhaWxzKTsKICAgICAgICAgICAgICAgIGxvZ1RhaWxzQ2hhbmdlKCdUYWlsaW5nJywgYWRkZWQpOwogICAgICAgICAgICAgICAgZGlzLnRhaWxzID0gdGFpbHM7CiAgICAgICAgICAgICAgICBkaXMub25jaGFuZ2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy50YWlsQ29udHJvbGxlciA9IG5ldyBUYWlsQ29udHJvbGxlcihjYWxsYmFja3MzKTsKICAgICAgICB0aGlzLmZpbHRlciA9IHRoaXMuc3RhdGUuZmlsdGVyIHx8IHsKICAgICAgICB9OwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiBmYWxzZQogICAgICAgIH0pOwogICAgfQogICAgc3RhcnQoKSB7CiAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgIHRoaXMucGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKTsKICAgIH0KICAgIG5ld1Byb2ZpbGUoKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5wcm9maWxlSWQgPSBnZW5lcmF0ZVV1aWQoKTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0udGl0bGUgPSAnTmV3IFByb2ZpbGUnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ubmFtZSA9IHRoaXMucHJvZmlsZXMubGVuZ3RoID09PSAwID8gJ2RlZmF1bHQnIDogYHByb2ZpbGUke3RoaXMucHJvZmlsZXMubGVuZ3RoICsgMX1gOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hcGlUb2tlbiA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA9IGZhbHNlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBlZGl0UHJvZmlsZShwcm9maWxlSWQpIHsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdOwogICAgICAgIGlmICghcHJvZmlsZSkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlICR7cHJvZmlsZUlkfSBub3QgZm91bmRgKTsKICAgICAgICB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICBjb25zdCB7IG5hbWU6IG5hbWU0ICwgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ucHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS50aXRsZSA9ICdFZGl0IFByb2ZpbGUnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ubmFtZSA9IG5hbWU0OwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gYWNjb3VudElkOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSBhcGlUb2tlbjsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBkZWxldGVQcm9maWxlKHByb2ZpbGVJZCkgewogICAgICAgIGNvbnNvbGUubG9nKCdkZWxldGUgcHJvZmlsZScsIHByb2ZpbGVJZCk7CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBpZiAoIXByb2ZpbGUpIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSAke3Byb2ZpbGVJZH0gbm90IGZvdW5kYCk7CiAgICAgICAgZGVsZXRlIHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgIHRoaXMucGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKTsKICAgIH0KICAgIGNhbmNlbFByb2ZpbGUoKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5vbmNoYW5nZSgpOwogICAgfQogICAgc2V0UHJvZmlsZU5hbWUobmFtZSkgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlQWNjb3VudElkKGFjY291bnRJZCkgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gYWNjb3VudElkOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbmNoYW5nZSgpOwogICAgfQogICAgc2V0UHJvZmlsZUFwaVRva2VuKGFwaVRva2VuKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hcGlUb2tlbiA9IGFwaVRva2VuOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbmNoYW5nZSgpOwogICAgfQogICAgc2F2ZVByb2ZpbGUoKSB7CiAgICAgICAgY29uc3QgeyBwcm9maWxlRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgeyBwcm9maWxlSWQgIH0gPSBwcm9maWxlRm9ybTsKICAgICAgICBjb25zdCBuZXdQcm9maWxlID0gewogICAgICAgICAgICBuYW1lOiBwcm9maWxlRm9ybS5uYW1lLnRyaW0oKSwKICAgICAgICAgICAgYWNjb3VudElkOiBwcm9maWxlRm9ybS5hY2NvdW50SWQudHJpbSgpLAogICAgICAgICAgICBhcGlUb2tlbjogcHJvZmlsZUZvcm0uYXBpVG9rZW4udHJpbSgpCiAgICAgICAgfTsKICAgICAgICB0aGlzLnRyeVNhdmVQcm9maWxlKHByb2ZpbGVJZCwgbmV3UHJvZmlsZSk7CiAgICB9CiAgICBlZGl0RXZlbnRGaWx0ZXIoKSB7CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnRXZlbnQgdHlwZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnY3JvbicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQ1JPTiB0cmlnZ2VyJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2h0dHAnLAogICAgICAgICAgICAgICAgdGV4dDogJ0hUVFAgcmVxdWVzdCcKICAgICAgICAgICAgfSwgCiAgICAgICAgXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuZXZlbnQxID09PSAnaHR0cCcgPyAnaHR0cCcgOiBmaWx0ZXIuZXZlbnQxID09PSAnY3JvbicgPyAnY3JvbicgOiAnYWxsJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ0Nob29zZSB3aGljaCB0eXBlcyBvZiBldmVudHMgdG8gc2hvdyc7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgaWYgKGZpbHRlci5ldmVudDEgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuZXZlbnQxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQ2hvaWNlVGV4dCA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMuZmluZCgodik9PnYuaWQgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZQogICAgICAgICAgICApLnRleHQ7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgRXZlbnQgdHlwZSBmaWx0ZXIgY2hhbmdlZCB0bzogJHtzZWxlY3RlZENob2ljZVRleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBlZGl0U3RhdHVzRmlsdGVyKCkgewogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1N0YXR1czonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnc3VjY2VzcycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnU3VjY2VzcycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICdlcnJvcicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnRXJyb3InCiAgICAgICAgICAgIH0sIAogICAgICAgIF07CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyLnN0YXR1czEgPT09ICdzdWNjZXNzJyA/ICdzdWNjZXNzJyA6IGZpbHRlci5zdGF0dXMxID09PSAnZXJyb3InID8gJ2Vycm9yJyA6ICdhbGwnOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnU2hvdyBldmVudHMgdGhpcyB0aGlzIHN0YXR1cyc7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgaWYgKGZpbHRlci5zdGF0dXMxID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLnN0YXR1czEgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRDaG9pY2VUZXh0ID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5maW5kKCh2KT0+di5pZCA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlCiAgICAgICAgICAgICkudGV4dDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTdGF0dXMgZmlsdGVyIGNoYW5nZWQgdG86ICR7c2VsZWN0ZWRDaG9pY2VUZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbmNoYW5nZSgpOwogICAgfQogICAgZWRpdElwQWRkcmVzc0ZpbHRlcigpIHsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGlzVmFsaWRJcEFkZHJlc3MgPSAoaXBBZGRyZXNzKT0+ewogICAgICAgICAgICByZXR1cm4gL14oc2VsZnxbXGRcLjphLWZdezMsfSkkLy50ZXN0KGlwQWRkcmVzcyk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjaGVja1ZhbGlkSXBBZGRyZXNzID0gKGlwQWRkcmVzcyk9PnsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkSXBBZGRyZXNzKGlwQWRkcmVzcykpIHRocm93IG5ldyBFcnJvcihgQmFkIGlwIGFkZHJlc3M6ICR7aXBBZGRyZXNzfWApOwogICAgICAgICAgICByZXR1cm4gaXBBZGRyZXNzOwogICAgICAgIH07CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJJcEFkZHJlc3Nlc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3Qodi5zcGxpdCgnLCcpLm1hcCgodjEpPT52MS50cmltKCkudG9Mb3dlckNhc2UoKQogICAgICAgICAgICApLmZpbHRlcigodjEpPT52MSAhPT0gJycKICAgICAgICAgICAgKS5tYXAoY2hlY2tWYWxpZElwQWRkcmVzcykpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySXBBZGRyZXNzZXMgPSAoKT0+ewogICAgICAgICAgICByZXR1cm4gZGlzdGluY3QoZmlsdGVyLmlwQWRkcmVzczEgfHwgW10pLmpvaW4oJywgJyk7CiAgICAgICAgfTsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnSVAgYWRkcmVzcyhzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJJcEFkZHJlc3NlcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ3NlbGYnIHRvIGZpbHRlciB5b3VyIG93biBhZGRyZXNzLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGUsIGUuZy4gc2VsZiwgMS4xLjEuMWA7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlcklwQWRkcmVzc2VzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLmlwQWRkcmVzczEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmlwQWRkcmVzczEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ2FueSBJUCBhZGRyZXNzJyA6IG5ld1ZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgSVAgYWRkcmVzcyBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbmNoYW5nZSgpOwogICAgfQogICAgZWRpdE1ldGhvZEZpbHRlcigpIHsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVyTWV0aG9kc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3Qodi5zcGxpdCgnLCcpLm1hcCgodjEpPT52MS50cmltKCkudG9VcHBlckNhc2UoKQogICAgICAgICAgICApLmZpbHRlcigodjEpPT52MSAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJNZXRob2RzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5tZXRob2QxIHx8IFtdKS5tYXAoKHYpPT52LnRvVXBwZXJDYXNlKCkKICAgICAgICAgICAgKS5qb2luKCcsICcpOwogICAgICAgIH07CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0hUVFAgTWV0aG9kKHMpOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlck1ldGhvZHMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ2NvbW1hLXNlcGFyYXRlZCBpZiBtdWx0aXBsZSwgZS5nLiBHRVQsIFBPU1QnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJNZXRob2RzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLm1ldGhvZDEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLm1ldGhvZDEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ2FueSBtZXRob2QnIDogbmV3VmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBNZXRob2QgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTYW1wbGluZ1JhdGVGaWx0ZXIoKSB7CiAgICAgICAgY29uc3QgcGFyc2VTYW1wbGVSYXRlRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2ID0gKGZpZWxkVmFsdWUgfHwgJycpLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHYgPT09ICcnKSByZXR1cm4gMTsKICAgICAgICAgICAgY29uc3QgbnVtID0gcGFyc2VGbG9hdCh2KTsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkU2FtcGxpbmdSYXRlKG51bSkpIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByYXRlOiAke3Z9YCk7CiAgICAgICAgICAgIHJldHVybiBudW07CiAgICAgICAgfTsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdTYW1wbGluZyByYXRlOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9ICh0eXBlb2YgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPT09ICdudW1iZXInICYmIGlzVmFsaWRTYW1wbGluZ1JhdGUoZmlsdGVyLnNhbXBsaW5nUmF0ZTEpID8gZmlsdGVyLnNhbXBsaW5nUmF0ZTEgOiAxKS50b0ZpeGVkKDIpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnQ2FuIHJhbmdlIGZyb20gMCAoMCUpIHRvIDEgKDEwMCUpJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlU2FtcGxlUmF0ZUZyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gbmV3VmFsdWUpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUgPT09IDEgPyAnbm8gc2FtcGxpbmcnIDogYCR7bmV3VmFsdWV9ICgkeyhuZXdWYWx1ZSAqIDEwMCkudG9GaXhlZCgyKX0lKWA7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU2FtcGxlIHJhdGUgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTZWFyY2hGaWx0ZXIoKSB7CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnU2VhcmNoIHRleHQ6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyLnNlYXJjaDEgfHwgJyc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdGaWx0ZXIgYnkgYSB0ZXh0IG1hdGNoIGluIGNvbnNvbGUubG9nIG1lc3NhZ2VzJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLnNlYXJjaDEgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc2VhcmNoMSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gKGZpbHRlci5zZWFyY2gxIHx8ICcnKS5sZW5ndGggPT09IDAgPyAnbm8gc2VhcmNoIGZpbHRlcicgOiBgJyR7ZmlsdGVyLnNlYXJjaDF9J2A7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU2VhcmNoIGZpbHRlciBjaGFuZ2VkIHRvOiAke3RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBlZGl0SGVhZGVyRmlsdGVyKCkgewogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJIZWFkZXJzRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2ID0gKGZpZWxkVmFsdWUgfHwgJycpLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHYgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2LnNwbGl0KCcsJykubWFwKCh2MSk9PnYxLnRyaW0oKQogICAgICAgICAgICApLmZpbHRlcigodjEpPT52MSAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJIZWFkZXJzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5oZWFkZXIxIHx8IFtdKS5qb2luKCcsICcpOwogICAgICAgIH07CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0hlYWRlcihzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJIZWFkZXJzKCk7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9IGAna2V5Jywgb3IgJ2tleTpxdWVyeScsIGNvbW1hLXNlcGFyYXRlZCBpZiBtdWx0aXBsZWA7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlckhlYWRlcnNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIuaGVhZGVyMSB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWUpKSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuaGVhZGVyMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZS5sZW5ndGggPT09IDAgPyAnbm8gaGVhZGVyIGZpbHRlcicgOiBuZXdWYWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYEhlYWRlciBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbmNoYW5nZSgpOwogICAgfQogICAgaGFzQW55RmlsdGVycygpIHsKICAgICAgICBjb25zdCB7IGZpbHRlciAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgeyBldmVudDEgIH0gPSBmaWx0ZXI7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpLmZpbHRlcnMubGVuZ3RoID4gMCB8fCB0eXBlb2YgZXZlbnQxID09PSAnc3RyaW5nJyAmJiBldmVudDEgIT09ICcnICYmIGV2ZW50MSAhPT0gJ2FsbCc7CiAgICB9CiAgICByZXNldEZpbHRlcnMoKSB7CiAgICAgICAgdGhpcy5maWx0ZXIgPSB7CiAgICAgICAgfTsKICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgRmlsdGVycyByZXNldGApOwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgIH0KICAgIGNhbmNlbEZpbHRlcigpIHsKICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsRmlsdGVyJyk7CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBzYXZlRmlsdGVyKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdzYXZlRmlsdGVyJyk7CiAgICAgICAgY29uc3QgeyBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBmaWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2UgPSAnQ2hlY2tpbmcgZmlsdGVyLi4uJzsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlKCk7CiAgICAgICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9IGBgOwogICAgICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9IGBFcnJvcjogJHtlLm1lc3NhZ2V9YDsKICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICBzZWxlY3RGaWx0ZXJDaG9pY2UoaWQpIHsKICAgICAgICBpZiAodGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPT09IGlkKSByZXR1cm47CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBpZDsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBlZGl0U2VsZWN0aW9uRmllbGRzKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdUT0RPIGVkaXRTZWxlY3Rpb25GaWVsZHMnKTsKICAgIH0KICAgIGFwcGx5RmlsdGVyKG9wdHMpIHsKICAgICAgICBjb25zdCB7IHNhdmUgIH0gPSBvcHRzOwogICAgICAgIHRoaXMuc3RhdGUuZmlsdGVyID0gdGhpcy5maWx0ZXI7CiAgICAgICAgaWYgKHNhdmUpIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICBjb25zdCB0YWlsT3B0aW9ucyA9IGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcih0aGlzLmZpbHRlcik7CiAgICAgICAgdGhpcy50YWlsQ29udHJvbGxlci5zZXRUYWlsT3B0aW9ucyh0YWlsT3B0aW9ucyk7CiAgICB9CiAgICBsb2dXaXRoUHJlZml4KC4uLmRhdGEpIHsKICAgICAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKTsKICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiAwICYmIHR5cGVvZiBkYXRhWzBdID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBkYXRhID0gWwogICAgICAgICAgICAgICAgYFslYyR7dGltZX0lY10gJHtkYXRhWzBdfWAsCiAgICAgICAgICAgICAgICAnY29sb3I6IGdyYXknLAogICAgICAgICAgICAgICAgJycsCiAgICAgICAgICAgICAgICAuLi5kYXRhLnNsaWNlKDEpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMubG9nZ2VyKC4uLmRhdGEpOwogICAgfQogICAgdmVyYm9zZVdpdGhQcmVmaXgobWVzc2FnZSkgewogICAgICAgIGNvbnN0IHRpbWUgPSBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpOwogICAgICAgIHRoaXMubG9nZ2VyKGBbJWMke3RpbWV9JWNdICVjJHttZXNzYWdlfSVjYCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScpOwogICAgfQogICAgcGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKSB7CiAgICAgICAgY29uc3QgaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQgPSBjb21wdXRlSW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQodGhpcy5zdGF0ZSwgdGhpcy5wcm9maWxlcyk7CiAgICAgICAgaWYgKGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJbml0aWFsbHkgc2VsZWN0aW5nIHByb2ZpbGU6ICR7dGhpcy5zdGF0ZS5wcm9maWxlc1tpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZF0ubmFtZX1gKTsKICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9IGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyB0cnlTYXZlUHJvZmlsZShwcm9maWxlSWQsIHByb2ZpbGUpIHsKICAgICAgICBjb25zdCB7IHByb2ZpbGVGb3JtICB9ID0gdGhpczsKICAgICAgICBwcm9maWxlRm9ybS5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgcHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlID0gdHJ1ZTsKICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJ0NoZWNraW5nIHByb2ZpbGUuLi4nOwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBjYW5MaXN0VGFpbHMgPSBhd2FpdCBjb21wdXRlQ2FuTGlzdFRhaWxzKHByb2ZpbGUuYWNjb3VudElkLCBwcm9maWxlLmFwaVRva2VuKTsKICAgICAgICAgICAgaWYgKGNhbkxpc3RUYWlscykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdID0gcHJvZmlsZTsKICAgICAgICAgICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnJzsKICAgICAgICAgICAgICAgIHRoaXMucmVsb2FkUHJvZmlsZXMoKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPSBwcm9maWxlSWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gYFRoZXNlIGNyZWRlbnRpYWxzIGRvIG5vdCBoYXZlIHBlcm1pc3Npb24gdG8gdGFpbGA7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSBgRXJyb3I6ICR7ZS5tZXNzYWdlfWA7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICBwcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgcHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICByZWxvYWRQcm9maWxlcygpIHsKICAgICAgICBjb25zdCB7IHN0YXRlICB9ID0gdGhpczsKICAgICAgICB0aGlzLnByb2ZpbGVzLnNwbGljZSgwKTsKICAgICAgICBmb3IgKGNvbnN0IFtwcm9maWxlSWQsIHByb2ZpbGVdIG9mIE9iamVjdC5lbnRyaWVzKHN0YXRlLnByb2ZpbGVzKSl7CiAgICAgICAgICAgIGNvbnN0IG5hbWU0ID0gcHJvZmlsZS5uYW1lIHx8ICcodW5uYW1lZCknOwogICAgICAgICAgICB0aGlzLnByb2ZpbGVzLnB1c2goewogICAgICAgICAgICAgICAgaWQ6IHByb2ZpbGVJZCwKICAgICAgICAgICAgICAgIHRleHQ6IG5hbWU0CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGZpbmRTY3JpcHRzKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgICAgIGlmIChwcm9maWxlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgICAgIHRoaXMudmVyYm9zZVdpdGhQcmVmaXgoYEZpbmRpbmcgc2NyaXB0cyBmb3IgJHtwcm9maWxlLm5hbWUudG9VcHBlckNhc2UoKX0uLi5gKTsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBjb25zdCBzY3JpcHRzID0gYXdhaXQgbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbik7CiAgICAgICAgICAgIHRoaXMudmVyYm9zZVdpdGhQcmVmaXgoYEZvdW5kICR7c2NyaXB0cy5sZW5ndGh9IHNjcmlwdHMgaW4gJHtEYXRlLm5vdygpIC0gc3RhcnR9bXNgKTsKICAgICAgICAgICAgdGhpcy5zY3JpcHRzLnNwbGljZSgwKTsKICAgICAgICAgICAgZm9yIChjb25zdCBzY3JpcHQgb2Ygc2NyaXB0cyl7CiAgICAgICAgICAgICAgICB0aGlzLnNjcmlwdHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IHNjcmlwdC5pZCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBzY3JpcHQuaWQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2NyaXB0cy5zb3J0KChsaHMsIHJocyk9Pmxocy50ZXh0LmxvY2FsZUNvbXBhcmUocmhzLnRleHQpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkU2NyaXB0SWRzID0gdGhpcy5jb21wdXRlU2VsZWN0ZWRTY3JpcHRJZHNBZnRlckZpbmRTY3JpcHRzKCk7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZFNjcmlwdElkcy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFNjcmlwdElkcyA9IHNlbGVjdGVkU2NyaXB0SWRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHRoaXMubG9nZ2VyKGBFcnJvciBpbiBmaW5kU2NyaXB0czogJHtlLnN0YWNrfWApOwogICAgICAgIH0KICAgIH0KICAgIGNvbXB1dGVTZWxlY3RlZFNjcmlwdElkc0FmdGVyRmluZFNjcmlwdHMoKSB7CiAgICAgICAgaWYgKHRoaXMuc2NyaXB0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0luaXRpYWxseSBzZWxlY3Rpbmcgbm8gc2NyaXB0cywgbm8gc2NyaXB0cyB0byBzZWxlY3QnKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkKSB7CiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxQcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICAgICAgaWYgKGluaXRpYWxQcm9maWxlICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY3JpcHRJZHMgPSBuZXcgU2V0KHRoaXMuc2NyaXB0cy5tYXAoKHYpPT52LmlkCiAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBzZXRJbnRlcnNlY3QoY3VycmVudFNjcmlwdElkcywgbmV3IFNldChpbml0aWFsUHJvZmlsZS5zZWxlY3RlZFNjcmlwdElkcykpOwogICAgICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBzY3JpcHQke2NhbmRpZGF0ZXMuc2l6ZSA9PT0gMSA/ICcnIDogJ3MnfSAke1sKICAgICAgICAgICAgICAgICAgICAgICAgLi4uY2FuZGlkYXRlcwogICAgICAgICAgICAgICAgICAgIF0uc29ydCgpLmpvaW4oJywgJyl9OiByZW1lbWJlcmVkIGZyb20gbGFzdCB0aW1lYCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZmlyc3RTY3JpcHRJZCA9IHRoaXMuc2NyaXB0c1swXS5pZDsKICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBzY3JpcHQgJHtmaXJzdFNjcmlwdElkfTogZmlyc3Qgb25lIGluIHRoZSBsaXN0YCk7CiAgICAgICAgcmV0dXJuIG5ldyBTZXQoWwogICAgICAgICAgICB0aGlzLnNjcmlwdHNbMF0uaWQKICAgICAgICBdKTsKICAgIH0KICAgIGFzeW5jIHNldFRhaWxzKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy50YWlsQ29udHJvbGxlci5zZXRUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuLCB0aGlzLl9zZWxlY3RlZFNjcmlwdElkcyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmxvZ2dlcignRXJyb3IgaW4gc2V0VGFpbHMnLCBlLnN0YWNrIHx8IGUubWVzc2FnZSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb2ZpbGVGb3JtVk0gewogICAgc2hvd2luZyA9IGZhbHNlOwogICAgZW5hYmxlZCA9IGZhbHNlOwogICAgbmFtZSA9ICcnOwogICAgYWNjb3VudElkID0gJyc7CiAgICBhcGlUb2tlbiA9ICcnOwogICAgZGVsZXRlVmlzaWJsZSA9IGZhbHNlOwogICAgc2F2ZUVuYWJsZWQgPSBmYWxzZTsKICAgIHByb2ZpbGVJZCA9ICcnOwogICAgdGl0bGUgPSAnJzsKICAgIHByb2dyZXNzVmlzaWJsZSA9IGZhbHNlOwogICAgb3V0cHV0TWVzc2FnZSA9ICcnOwogICAgY29tcHV0ZVNhdmVFbmFibGVkKCkgewogICAgICAgIHRoaXMuc2F2ZUVuYWJsZWQgPSB0aGlzLm5hbWUudHJpbSgpLmxlbmd0aCA+IDAgJiYgdGhpcy5hcGlUb2tlbi50cmltKCkubGVuZ3RoID4gMCAmJiB0aGlzLmFjY291bnRJZC50cmltKCkubGVuZ3RoID4gMDsKICAgIH0KfQpjbGFzcyBGaWx0ZXJGb3JtVk0gewogICAgc2hvd2luZyA9IGZhbHNlOwogICAgZW5hYmxlZCA9IGZhbHNlOwogICAgZmllbGROYW1lID0gJyc7CiAgICBmaWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgZmllbGRWYWx1ZTsKICAgIGhlbHBUZXh0ID0gJyc7CiAgICBvdXRwdXRNZXNzYWdlID0gJyc7CiAgICBhcHBseVZhbHVlID0gKCk9PnsKICAgIH07Cn0KY29uc3QgU1RBVEVfS0VZID0gJ3N0YXRlMSc7CmZ1bmN0aW9uIGxvYWRTdGF0ZSgpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QganNvbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUQVRFX0tFWSkgfHwgdW5kZWZpbmVkOwogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIGNvbnN0IHJ0ID0gSlNPTi5wYXJzZShqc29uKTsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlU3RhdGUocnQpOwogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ2xvYWRTdGF0ZTogRXJyb3IgbG9hZGluZyBzdGF0ZScsIGUpOwogICAgfQogICAgY29uc29sZS5sb2coJ2xvYWRTdGF0ZTogcmV0dXJuaW5nIG5ldyBzdGF0ZScpOwogICAgcmV0dXJuIHsKICAgICAgICBwcm9maWxlczogewogICAgICAgIH0KICAgIH07Cn0KZnVuY3Rpb24gcGFyc2VTdGF0ZShwYXJzZWQpIHsKICAgIGlmICh0eXBlb2YgcGFyc2VkICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBvYmplY3RgKTsKICAgIGNvbnN0IHsgcHJvZmlsZXMgIH0gPSBwYXJzZWQ7CiAgICBpZiAodHlwZW9mIHByb2ZpbGVzICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwcm9maWxlcyBvYmplY3RgKTsKICAgIGZvciAoY29uc3QgW3Byb2ZpbGVJZCwgcHJvZmlsZVN0YXRlXSBvZiBPYmplY3QuZW50cmllcyhwcm9maWxlcykpewogICAgICAgIGlmICh0eXBlb2YgcHJvZmlsZUlkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKCdQcm9maWxlIGlkIG11c3QgYmUgc3RyaW5nJyk7CiAgICAgICAgcGFyc2VQcm9maWxlU3RhdGUocHJvZmlsZVN0YXRlKTsKICAgIH0KICAgIHJldHVybiBwYXJzZWQ7Cn0KZnVuY3Rpb24gcGFyc2VQcm9maWxlU3RhdGUocGFyc2VkKSB7CiAgICBpZiAodHlwZW9mIHBhcnNlZCAhPT0gJ29iamVjdCcgfHwgcGFyc2VkID09PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2ZpbGUgc3RhdGUgbXVzdCBiZSBvYmplY3QnKTsKICAgIGNvbnN0IHsgbmFtZTogbmFtZTQgLCBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHBhcnNlZDsKICAgIGlmICh0eXBlb2YgbmFtZTQgIT09ICdzdHJpbmcnIHx8IG5hbWU0LnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBuYW1lIG11c3QgZXhpc3RgKTsKICAgIGlmICh0eXBlb2YgYWNjb3VudElkICE9PSAnc3RyaW5nJyB8fCBhY2NvdW50SWQudHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIGFjY291bnRJZCBtdXN0IGV4aXN0YCk7CiAgICBpZiAodHlwZW9mIGFwaVRva2VuICE9PSAnc3RyaW5nJyB8fCBhcGlUb2tlbi50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgYXBpVG9rZW4gbXVzdCBleGlzdGApOwogICAgcmV0dXJuIHBhcnNlZDsKfQpmdW5jdGlvbiBzYXZlU3RhdGUoc3RhdGUpIHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUQVRFX0tFWSwgSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTsKfQphc3luYyBmdW5jdGlvbiBjb21wdXRlQ2FuTGlzdFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4pIHsKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbGlzdFRhaWxzKGFjY291bnRJZCwgJycsIGFwaVRva2VuKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIENsb3VkZmxhcmVBcGlFcnJvciAmJiBlLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQpmdW5jdGlvbiBpc1ZhbGlkU2FtcGxpbmdSYXRlKHNhbXBsaW5nUmF0ZSkgewogICAgcmV0dXJuICFpc05hTihzYW1wbGluZ1JhdGUpICYmIHNhbXBsaW5nUmF0ZSA+PSAwICYmIHNhbXBsaW5nUmF0ZSA8PSAxOwp9CmZ1bmN0aW9uIGNvbXB1dGVJbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZChzdGF0ZSwgcHJvZmlsZXMpIHsKICAgIGlmIChzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCAmJiBzdGF0ZS5wcm9maWxlc1tzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZF0pIHJldHVybiBzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZDsKICAgIGlmIChwcm9maWxlcy5sZW5ndGggPiAwKSByZXR1cm4gcHJvZmlsZXNbMF0uaWQ7CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpIHsKICAgIGNvbnN0IGZpbHRlcnMgPSBbXTsKICAgIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ2Vycm9yJykgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIG91dGNvbWU6IFsKICAgICAgICAgICAgICAgICdleGNlcHRpb24nLAogICAgICAgICAgICAgICAgJ2V4Y2VlZGVkQ3B1JywKICAgICAgICAgICAgICAgICdjYW5jZWxlZCcsCiAgICAgICAgICAgICAgICAndW5rbm93bicKICAgICAgICAgICAgXQogICAgICAgIH0pOwogICAgfSBlbHNlIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgb3V0Y29tZTogWwogICAgICAgICAgICAgICAgJ29rJwogICAgICAgICAgICBdCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLnNhbXBsaW5nUmF0ZTEgIT09IHVuZGVmaW5lZCAmJiBpc1ZhbGlkU2FtcGxpbmdSYXRlKGZpbHRlci5zYW1wbGluZ1JhdGUxKSAmJiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA8IDEpIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBzYW1wbGluZ19yYXRlOiBmaWx0ZXIuc2FtcGxpbmdSYXRlMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5zZWFyY2gxICE9PSB1bmRlZmluZWQgJiYgZmlsdGVyLnNlYXJjaDEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIHF1ZXJ5OiBmaWx0ZXIuc2VhcmNoMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5tZXRob2QxICYmIGZpbHRlci5tZXRob2QxLmxlbmd0aCA+IDApIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBtZXRob2Q6IGZpbHRlci5tZXRob2QxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLmlwQWRkcmVzczEgJiYgZmlsdGVyLmlwQWRkcmVzczEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIGNsaWVudF9pcDogZmlsdGVyLmlwQWRkcmVzczEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuaGVhZGVyMSAmJiBmaWx0ZXIuaGVhZGVyMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChjb25zdCBoZWFkZXIgb2YgZmlsdGVyLmhlYWRlcjEpewogICAgICAgICAgICBmaWx0ZXJzLnB1c2gocGFyc2VIZWFkZXJGaWx0ZXIoaGVhZGVyKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBmaWx0ZXJzCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UyLCBmaWx0ZXIpIHsKICAgIGlmIChmaWx0ZXIuZXZlbnQxID09PSAnY3JvbicgfHwgZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnKSB7CiAgICAgICAgY29uc3QgaXNDcm9uID0gaXNUYWlsTWVzc2FnZUNyb25FdmVudChtZXNzYWdlMik7CiAgICAgICAgcmV0dXJuIGlzQ3JvbiAmJiBmaWx0ZXIuZXZlbnQxID09PSAnY3JvbicgfHwgIWlzQ3JvbiAmJiBmaWx0ZXIuZXZlbnQxID09PSAnaHR0cCc7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBkaXN0aW5jdCh2YWx1ZXMxKSB7CiAgICBjb25zdCBydCA9IFtdOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMxKXsKICAgICAgICBpZiAoIXJ0LmluY2x1ZGVzKHZhbHVlKSkgewogICAgICAgICAgICBydC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KY29uc3QgRklMVEVSX0VESVRPUl9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9ImZpbHRlci1mb3JtIiBhdXRvY29tcGxldGU9Im9mZiI+CjxmaWVsZHNldCBpZD0iZmlsdGVyLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS10aXRsZSIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCI+RWRpdCBmaWx0ZXI8L2Rpdj4KCiAgPGxhYmVsIGlkPSJmaWx0ZXItZmllbGQtbGFiZWwiPkZpbHRlciBmaWVsZDo8L2xhYmVsPgogIDxpbnB1dCBpZD0iZmlsdGVyLWZpZWxkLXRleHQiIHR5cGU9InRleHQiPgogIDxkaXYgaWQ9ImZpbHRlci1maWVsZC1jaG9pY2UiPjwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1oZWxwIiBjbGFzcz0iYm9keTIgbWVkaXVtLWVtcGhhc2lzLXRleHQiPgogIDwvZGl2PiAgCgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLW91dHB1dC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8b3V0cHV0IGlkPSJmaWx0ZXItZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogIDwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1idXR0b25zIiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0iZmlsdGVyLWFwcGx5IiB0eXBlPSJzdWJtaXQiPkFwcGx5PC9idXR0b24+PCEtLSBmaXJzdCBzbyBpdCBpcyBkZWZhdWx0IGJ1dHRvbiBvbiByZXR1cm4gLS0+CiAgICA8YnV0dG9uIGlkPSJmaWx0ZXItY2FuY2VsIj5DYW5jZWw8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBGSUxURVJfRURJVE9SX0NTUyA9IGNzc2AKCiAgICAjZmlsdGVyLWZvcm0tdGl0bGUgewogICAgICAgIGdyaWQtY29sdW1uOiAxIC8gc3BhbiAyOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1idXR0b25zIHsKICAgICAgICBqdXN0aWZ5LXNlbGY6IGVuZDsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgICAgICBnYXA6IDFyZW07CiAgICB9CgogICAgI2ZpbHRlci1maWVsZC1jaG9pY2UgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZ2FwOiAxcHg7CiAgICB9CgogICAgI2ZpbHRlci1mb3JtLWhlbHAgewogICAgICAgIGdyaWQtY29sdW1uOiAyOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1vdXRwdXQtcm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgICAgIG1pbi1oZWlnaHQ6IDIuNXJlbTsKICAgIH0KCiAgICAjZmlsdGVyLWZvcm0tb3V0cHV0LXJvdyBvdXRwdXQgewogICAgICAgIGZsZXgtZ3JvdzogMTsKICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRGaWx0ZXJFZGl0b3IoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBmaWx0ZXJGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGRzZXQnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkTGFiZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWxhYmVsJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZFRleHRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtdGV4dCcpOwogICAgY29uc3QgZmlsdGVyRmllbGRDaG9pY2VEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWNob2ljZScpOwogICAgY29uc3QgZmlsdGVyQ2FuY2VsQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1jYW5jZWwnKTsKICAgIGNvbnN0IGZpbHRlckFwcGx5QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1hcHBseScpOwogICAgY29uc3QgZmlsdGVyRm9ybU91dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZm9ybS1vdXRwdXQnKTsKICAgIGNvbnN0IGZpbHRlckZvcm1IZWxwRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtLWhlbHAnKTsKICAgIGZpbHRlckNhbmNlbEJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmNhbmNlbEZpbHRlcigpOwogICAgfTsKICAgIGZpbHRlckFwcGx5QnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgY29uc3QgaXNDaG9pY2UgPSB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmxlbmd0aCA+IDA7CiAgICAgICAgaWYgKCFpc0Nob2ljZSkgewogICAgICAgICAgICB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXJGaWVsZFRleHRJbnB1dC52YWx1ZTsKICAgICAgICB9CiAgICAgICAgdm0uc2F2ZUZpbHRlcigpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0hpZGRlbiA9IGZpbHRlckZvcm0uc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIGZpbHRlckZvcm0uc3R5bGUuZGlzcGxheSA9IHZtLmZpbHRlckZvcm0uc2hvd2luZyA/ICdncmlkJyA6ICdub25lJzsKICAgICAgICBmaWx0ZXJGaWVsZHNldC5kaXNhYmxlZCA9ICF2bS5maWx0ZXJGb3JtLmVuYWJsZWQ7CiAgICAgICAgY29uc3QgaXNDaG9pY2UgPSB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmxlbmd0aCA+IDA7CiAgICAgICAgZmlsdGVyRmllbGRMYWJlbC50ZXh0Q29udGVudCA9IHZtLmZpbHRlckZvcm0uZmllbGROYW1lOwogICAgICAgIGZpbHRlckZpZWxkTGFiZWwuaHRtbEZvciA9IGlzQ2hvaWNlID8gZmlsdGVyRmllbGRDaG9pY2VEaXYuaWQgOiBmaWx0ZXJGaWVsZFRleHRJbnB1dC5pZDsKICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5zdHlsZS5kaXNwbGF5ID0gaXNDaG9pY2UgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgIGZpbHRlckZpZWxkQ2hvaWNlRGl2LnN0eWxlLmRpc3BsYXkgPSBpc0Nob2ljZSA/ICdmbGV4JyA6ICdub25lJzsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihDSE9JQ0VTX0hUTUwodm0pLCBmaWx0ZXJGaWVsZENob2ljZURpdik7CiAgICAgICAgZmlsdGVyRm9ybUhlbHBEaXYudGV4dENvbnRlbnQgPSB2bS5maWx0ZXJGb3JtLmhlbHBUZXh0OwogICAgICAgIGZpbHRlckZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bS5maWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2U7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiB2bS5maWx0ZXJGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2ZpbHRlciBmb3JtIG9wZW4nKTsKICAgICAgICAgICAgaWYgKCFpc0Nob2ljZSAmJiB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUpIGZpbHRlckZpZWxkVGV4dElucHV0LnZhbHVlID0gdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5mb2N1cygpOwogICAgICAgICAgICAgICAgZmlsdGVyRmllbGRUZXh0SW5wdXQuc2VsZWN0KCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgQ0hPSUNFU19IVE1MID0gKHZtKT0+ewogICAgcmV0dXJuIHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMubWFwKChjaG9pY2UpPT5odG1sYDxidXR0b24gY2xhc3M9IiR7Y2hvaWNlLmlkID09PSB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2bS5zZWxlY3RGaWx0ZXJDaG9pY2UoY2hvaWNlLmlkKTsKICAgICAgICB9fSA/ZGlzYWJsZWQ9IiR7IXZtLmZpbHRlckZvcm0uc2hvd2luZ30iPiR7Y2hvaWNlLnRleHR9PC9idXR0b24+YAogICAgKTsKfTsKY29uc3QgUFJPRklMRV9FRElUT1JfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJwcm9maWxlLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJwcm9maWxlLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQiPlByb2ZpbGU8L2Rpdj4KCiAgPGxhYmVsIGZvcj0icHJvZmlsZS1uYW1lIj5Qcm9maWxlIG5hbWU6PC9sYWJlbD4KICA8aW5wdXQgaWQ9InByb2ZpbGUtbmFtZSIgdHlwZT0idGV4dCI+CgogIDxsYWJlbCBmb3I9ImFjY291bnQtaWQiPkNsb3VkZmxhcmUgQWNjb3VudCBJRDo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hY2NvdW50LWlkIiB0eXBlPSJ0ZXh0Ij4KCiAgPGxhYmVsIGZvcj0iYXBpLXRva2VuIj5DbG91ZGZsYXJlIEFQSSBUb2tlbjo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hcGktdG9rZW4iIHR5cGU9InRleHQiPgoKICA8ZGV0YWlscyBpZD0icHJvZmlsZS1mb3JtLWhlbHAtcm93IiBjbGFzcz0iZm9ybS1yb3ciPgogICAgPHN1bW1hcnk+VXNlIGEgPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJpbmNpcGxlX29mX2xlYXN0X3ByaXZpbGVnZSIgdGFyZ2V0PSJfYmxhbmsiPmxlYXN0IHByaXZpbGVnZTwvYT4gdG9rZW4gd2l0aCBwZXJtaXNzaW9uOiA8Y29kZT5BY2NvdW50ICZndDsgV29ya2VycyBUYWlsICZndDsgUmVhZDwvY29kZT48L3N1bW1hcnk+CiAgICA8b2w+CiAgICAgICAgPGxpPlNlbGVjdCA8c3BhbiBjbGFzcz0iY2YtYnV0dG9uIj5DcmVhdGUgVG9rZW48L3NwYW4+IG9uIHlvdXIgQ2xvdWRmbGFyZSA8YSBocmVmPSJodHRwczovL2Rhc2guY2xvdWRmbGFyZS5jb20vcHJvZmlsZS9hcGktdG9rZW5zIiB0YXJnZXQ9Il9ibGFuayI+QVBJIFRva2VuczwvYT4gcGFnZS48L2xpPgogICAgICAgIDxsaT5TY3JvbGwgZG93biB0byA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+Q3JlYXRlIEN1c3RvbSBUb2tlbjwvc3Bhbj4sIHRoZW4gPHNwYW4gY2xhc3M9ImNmLWJ1dHRvbiI+R2V0IHN0YXJ0ZWQ8L3NwYW4+PC9saT4KICAgICAgICA8bGk+VW5kZXIgPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPlBlcm1pc3Npb25zPC9zcGFuPiwgZ3JhbnQgeW91ciB0b2tlbiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+QWNjb3VudDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPldvcmtlcnMgVGFpbDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPlJlYWQ8L3NwYW4+PC9saT4KICAgIDwvb2w+CiAgPC9kZXRhaWxzPiAgCgogIDxkaXYgaWQ9InByb2ZpbGUtZm9ybS1vdXRwdXQtcm93IiBjbGFzcz0iZm9ybS1yb3ciPgogICAgPG91dHB1dCBpZD0icHJvZmlsZS1mb3JtLW91dHB1dCI+PC9vdXRwdXQ+CiAgICA8cHJvZ3Jlc3MgaWQ9InByb2ZpbGUtZm9ybS1wcm9ncmVzcyIgY2xhc3M9InB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIiPjwvcHJvZ3Jlc3M+CiAgPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tbGhzIj4KICAgIDxidXR0b24gaWQ9InByb2ZpbGUtZGVsZXRlIj5EZWxldGU8L2J1dHRvbj4KICA8L2Rpdj4KICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tYnV0dG9ucyIgY2xhc3M9ImZvcm0tcmhzIj4KICAgIDxidXR0b24gaWQ9InByb2ZpbGUtY2FuY2VsIj5DYW5jZWw8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9InByb2ZpbGUtc2F2ZSI+U2F2ZTwvYnV0dG9uPgogIDwvZGl2Pgo8L2ZpZWxkc2V0Pgo8L2Zvcm0+CmA7CmNvbnN0IFBST0ZJTEVfRURJVE9SX0NTUyA9IGNzc2AKCiAgICAjcHJvZmlsZS1mb3JtLWJ1dHRvbnMgewogICAgICAgIGp1c3RpZnktc2VsZjogZW5kOwogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgewogICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IHN1bW1hcnkgewogICAgICAgIHVzZXItc2VsZWN0OiBub25lOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgb2wgewogICAgICAgIGN1cnNvcjogZGVmYXVsdDsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IGxpIHsKICAgICAgICBwYWRkaW5nOiAwLjVyZW0gMDsKICAgIH0KCiAgICAuY2YtYnV0dG9uIHsKICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogYmx1ZTsKICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgcGFkZGluZzogMC4yNXJlbSAwLjVyZW07CiAgICAgICAgYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICAgIH0KCiAgICAuY2Ytc2VjdGlvbiB7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgICBwYWRkaW5nOiAwLjI1cmVtIDAuNXJlbTsKICAgICAgICBvdXRsaW5lOiBzb2xpZCAxcHggZ3JheTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLW91dHB1dC1yb3cgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBnYXA6IDFyZW07CiAgICAgICAgbWluLWhlaWdodDogMi41cmVtOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyBvdXRwdXQgewogICAgICAgIGZsZXgtZ3JvdzogMTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLXByb2dyZXNzIHsKICAgICAgICBmb250LXNpemU6IDAuNXJlbTsgLyogZGVmYXVsdCAzZW0gPT4gMS41cmVtICovCiAgICB9CgpgOwpmdW5jdGlvbiBpbml0UHJvZmlsZUVkaXRvcihkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHByb2ZpbGVGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1UaXRsZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tdGl0bGUnKTsKICAgIGNvbnN0IHByb2ZpbGVGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZpZWxkc2V0Jyk7CiAgICBjb25zdCBwcm9maWxlTmFtZUlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtbmFtZScpOwogICAgY29uc3QgcHJvZmlsZUFjY291bnRJZElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtYWNjb3VudC1pZCcpOwogICAgY29uc3QgcHJvZmlsZUFwaVRva2VuSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1hcGktdG9rZW4nKTsKICAgIGNvbnN0IHByb2ZpbGVEZWxldGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1kZWxldGUnKTsKICAgIGNvbnN0IHByb2ZpbGVDYW5jZWxCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1jYW5jZWwnKTsKICAgIGNvbnN0IHByb2ZpbGVTYXZlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtc2F2ZScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1Qcm9ncmVzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tcHJvZ3Jlc3MnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1vdXRwdXQnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtSGVscERldGFpbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLWhlbHAtcm93Jyk7CiAgICBwcm9maWxlQ2FuY2VsQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uY2FuY2VsUHJvZmlsZSgpOwogICAgfTsKICAgIHByb2ZpbGVOYW1lSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0uc2V0UHJvZmlsZU5hbWUocHJvZmlsZU5hbWVJbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZUFjY291bnRJZElucHV0Lm9uaW5wdXQgPSAoKT0+ewogICAgICAgIHZtLnNldFByb2ZpbGVBY2NvdW50SWQocHJvZmlsZUFjY291bnRJZElucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bS5zZXRQcm9maWxlQXBpVG9rZW4ocHJvZmlsZUFwaVRva2VuSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVTYXZlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uc2F2ZVByb2ZpbGUoKTsKICAgIH07CiAgICBwcm9maWxlRGVsZXRlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZGVsZXRlUHJvZmlsZSh2bS5wcm9maWxlRm9ybS5wcm9maWxlSWQpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0hpZGRlbiA9IHByb2ZpbGVGb3JtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJzsKICAgICAgICBwcm9maWxlRm9ybS5zdHlsZS5kaXNwbGF5ID0gdm0ucHJvZmlsZUZvcm0uc2hvd2luZyA/ICdncmlkJyA6ICdub25lJzsKICAgICAgICBwcm9maWxlRmllbGRzZXQuZGlzYWJsZWQgPSAhdm0ucHJvZmlsZUZvcm0uZW5hYmxlZDsKICAgICAgICBwcm9maWxlRm9ybVRpdGxlRGl2LnRleHRDb250ZW50ID0gdm0ucHJvZmlsZUZvcm0udGl0bGU7CiAgICAgICAgcHJvZmlsZU5hbWVJbnB1dC52YWx1ZSA9IHZtLnByb2ZpbGVGb3JtLm5hbWU7CiAgICAgICAgcHJvZmlsZUFjY291bnRJZElucHV0LnZhbHVlID0gdm0ucHJvZmlsZUZvcm0uYWNjb3VudElkOwogICAgICAgIHByb2ZpbGVBcGlUb2tlbklucHV0LnZhbHVlID0gdm0ucHJvZmlsZUZvcm0uYXBpVG9rZW47CiAgICAgICAgcHJvZmlsZURlbGV0ZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gdm0ucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA/ICdpbmxpbmUtYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVTYXZlQnV0dG9uLmRpc2FibGVkID0gIXZtLnByb2ZpbGVGb3JtLnNhdmVFbmFibGVkOwogICAgICAgIHByb2ZpbGVGb3JtUHJvZ3Jlc3Muc3R5bGUuZGlzcGxheSA9IHZtLnByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZUZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bS5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlOwogICAgICAgIGlmICh3YXNIaWRkZW4gJiYgdm0ucHJvZmlsZUZvcm0uc2hvd2luZykgewogICAgICAgICAgICBwcm9maWxlRm9ybUhlbHBEZXRhaWxzLm9wZW4gPSBmYWxzZTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgcHJvZmlsZU5hbWVJbnB1dC5mb2N1cygpOwogICAgICAgICAgICAgICAgcHJvZmlsZU5hbWVJbnB1dC5zZWxlY3QoKTsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBNT0RBTF9IVE1MID0gaHRtbGAKPGRpdiBpZD0ibW9kYWwiIGNsYXNzPSJtb2RhbCI+CiAgICA8ZGl2IGNsYXNzPSJtb2RhbC1jb250ZW50Ij4KICAgICR7UFJPRklMRV9FRElUT1JfSFRNTH0KICAgICR7RklMVEVSX0VESVRPUl9IVE1MfQogICAgPC9kaXY+CjwvZGl2PgpgOwpjb25zdCBNT0RBTF9DU1MgPSBjc3NgCi5tb2RhbCB7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9zaXRpb246IGZpeGVkOwogICAgei1pbmRleDogMTsKICAgIGxlZnQ6IDA7CiAgICB0b3A6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuNCk7Cn0KCi5tb2RhbC1jb250ZW50IHsKICAgIG1hcmdpbjogMTUlIGF1dG87CiAgICB3aWR0aDogODAlOwogICAgbWF4LXdpZHRoOiA0MHJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwp9CmA7CmZ1bmN0aW9uIGluaXRNb2RhbChkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsJyk7CiAgICBjb25zdCB1cGRhdGVQcm9maWxlRWRpdG9yID0gaW5pdFByb2ZpbGVFZGl0b3IoZG9jdW1lbnQsIHZtKTsKICAgIGNvbnN0IHVwZGF0ZUZpbHRlckVkaXRvciA9IGluaXRGaWx0ZXJFZGl0b3IoZG9jdW1lbnQsIHZtKTsKICAgIGNvbnN0IGNsb3NlTW9kYWwgPSAoKT0+ewogICAgICAgIGlmICghdm0ucHJvZmlsZUZvcm0uc2hvd2luZyAmJiAhdm0uZmlsdGVyRm9ybS5zaG93aW5nKSByZXR1cm47CiAgICAgICAgaWYgKHZtLnByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSkgcmV0dXJuOwogICAgICAgIHZtLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bS5maWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bS5vbmNoYW5nZSgpOwogICAgfTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudCk9PnsKICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09IG1vZGFsKSB7CiAgICAgICAgICAgIGNsb3NlTW9kYWwoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZXZlbnQpPT57CiAgICAgICAgZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7CiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gJ0VzY2FwZScpIHsKICAgICAgICAgICAgY2xvc2VNb2RhbCgpOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgdXBkYXRlUHJvZmlsZUVkaXRvcigpOwogICAgICAgIHVwZGF0ZUZpbHRlckVkaXRvcigpOwogICAgICAgIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5zaG93aW5nIHx8IHZtLmZpbHRlckZvcm0uc2hvd2luZyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKY29uc3QgQ09OU09MRV9IVE1MID0gaHRtbGAKPGRpdiBpZD0iY29uc29sZSI+CiAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlciI+CiAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItZmlsdGVycyIgY2xhc3M9ImJvZHkyIj48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1zdGF0dXMiPgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci10YWlscyIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGNvZGUgaWQ9ImNvbnNvbGUtbGFzdC1saW5lIiBjbGFzcz0ibGluZSI+c3BhY2VyPC9jb2RlPgo8L2Rpdj4KCmA7CmNvbnN0IENPTlNPTEVfQ1NTID0gY3NzYAoKI2NvbnNvbGUgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgd2lkdGg6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIG92ZXJmbG93LXk6IHNjcm9sbDsKICAgIG92ZXJmbG93LXg6IGhpZGRlbjsKICAgIGZsZXgtZ3JvdzogMTsKfQoKI2NvbnNvbGU6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICAgIHdpZHRoOiAxcmVtOwogICAgaGVpZ2h0OiAzcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCiNjb25zb2xlLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgaGVpZ2h0OiAzLjVyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBwYWRkaW5nOiAxcmVtIDFyZW0gMXJlbSAwOwp9CgojY29uc29sZS1oZWFkZXItZmlsdGVycyB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgZm9udC1mYW1pbHk6IHZhcigtLXNhbnMtc2VyaWYtZm9udC1mYW1pbHkpOwoKICAgIGRpc3BsYXk6IC13ZWJraXQtYm94OwogICAgLXdlYmtpdC1saW5lLWNsYW1wOiAzOwogICAgLXdlYmtpdC1ib3gtb3JpZW50OiB2ZXJ0aWNhbDsgIAogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKI2NvbnNvbGUtaGVhZGVyLXN0YXR1cyB7CiAgICBoZWlnaHQ6IDFyZW07CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwp9CgojY29uc29sZS1oZWFkZXItdGFpbHMgewogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIG1pbi13aWR0aDogNHJlbTsKICAgIHRleHQtYWxpZ246IHJpZ2h0Owp9CgojY29uc29sZSAubGluZSB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsgLyogMTJweCAqLwogICAgbGluZS1oZWlnaHQ6IDEuMXJlbTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1tb25vc3BhY2UtZm9udC1mYW1pbHkpOwogICAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgojY29uc29sZS1sYXN0LWxpbmUgewogICAgdmlzaWJpbGl0eTogaGlkZGVuOwp9CgpgOwpmdW5jdGlvbiBpbml0Q29uc29sZShkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IGNvbnNvbGVEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZScpOwogICAgY29uc3QgY29uc29sZUhlYWRlckZpbHRlcnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItZmlsdGVycycpOwogICAgY29uc3QgY29uc29sZUhlYWRlclRhaWxzRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci10YWlscycpOwogICAgY29uc3QgY29uc29sZUxhc3RMaW5lRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWxhc3QtbGluZScpOwogICAgdm0ubG9nZ2VyID0gKC4uLmRhdGEpPT57CiAgICAgICAgY29uc3QgbGluZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjb2RlJyk7CiAgICAgICAgbGluZUVsZW1lbnQuY2xhc3NOYW1lID0gJ2xpbmUnOwogICAgICAgIGxldCBwb3MgPSAwOwogICAgICAgIHdoaWxlKHBvcyA8IGRhdGEubGVuZ3RoKXsKICAgICAgICAgICAgaWYgKHBvcyA+IDApIHsKICAgICAgICAgICAgICAgIGxpbmVFbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcsICcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBtc2cgPSBkYXRhW3Bvc107CiAgICAgICAgICAgIGlmICh0eXBlb2YgbXNnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgY29uc3QgdG9rZW5zID0gbXNnLnNwbGl0KCclYycpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpMSA9IDA7IGkxIDwgdG9rZW5zLmxlbmd0aDsgaTErKyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaTEgPiAwICYmIGkxIDwgdG9rZW5zLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkYXRhW3BvcyArIGkxXTsKICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZW5kZXJUZXh0SW50b1NwYW4odG9rZW5zW2kxXSwgc3Bhbik7CiAgICAgICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb3MgKz0gMSArIHRva2Vucy5sZW5ndGggLSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoSlNPTi5zdHJpbmdpZnkobXNnKSkpOwogICAgICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc29sZURpdi5pbnNlcnRCZWZvcmUobGluZUVsZW1lbnQsIGNvbnNvbGVMYXN0TGluZUVsZW1lbnQpOwogICAgICAgIGNvbnN0IHsgc2Nyb2xsSGVpZ2h0ICwgc2Nyb2xsVG9wICwgY2xpZW50SGVpZ2h0ICB9ID0gY29uc29sZURpdjsKICAgICAgICBjb25zdCBkaWZmID0gc2Nyb2xsSGVpZ2h0IC0gc2Nyb2xsVG9wOwogICAgICAgIGNvbnN0IGF1dG9zY3JvbGwgPSBkaWZmIC0gMTYgKiA0IDw9IGNsaWVudEhlaWdodDsKICAgICAgICBpZiAoYXV0b3Njcm9sbCkgewogICAgICAgICAgICBjb25zb2xlTGFzdExpbmVFbGVtZW50LnNjcm9sbEludG9WaWV3KGZhbHNlKTsKICAgICAgICB9CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc29sZUhlYWRlclRhaWxzRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbXB1dGVUYWlsc1RleHQodm0udGFpbHMuc2l6ZSk7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoRklMVEVSU19IVE1MKHZtKSwgY29uc29sZUhlYWRlckZpbHRlcnNEaXYpOwogICAgfTsKfQpjb25zdCBGSUxURVJTX0hUTUwgPSAodm0pPT57CiAgICByZXR1cm4gaHRtbGBTaG93aW5nIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U2VsZWN0aW9uRmllbGRzKCk7CiAgICB9fT4ke2NvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KHZtKX08L2E+CiAgICAgZm9yIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0RXZlbnRGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUV2ZW50RmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4KICAgICB3aXRoIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U3RhdHVzRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTdGF0dXNGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZWRpdElwQWRkcmVzc0ZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSXBBZGRyZXNzRmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4sCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRNZXRob2RGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZU1ldGhvZEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U2FtcGxpbmdSYXRlRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTYW1wbGluZ1JhdGVGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwgCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRTZWFyY2hGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVNlYXJjaEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LCAKICAgICBhbmQgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRIZWFkZXJGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUhlYWRlckZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LgogICAgICR7dm0uaGFzQW55RmlsdGVycygpID8gaHRtbGAoPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLnJlc2V0RmlsdGVycygpOwogICAgfX0+cmVzZXQ8L2E+KWAgOiAnJ31gOwp9OwpmdW5jdGlvbiBjb21wdXRlU2VsZWN0aW9uRmllbGRzVGV4dChfdm0pIHsKICAgIHJldHVybiAnc3RhbmRhcmQgZmllbGRzJzsKfQpmdW5jdGlvbiBjb21wdXRlRXZlbnRGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgeyBldmVudDEgIH0gPSBmaWx0ZXI7CiAgICByZXR1cm4gZXZlbnQxID09PSAnY3JvbicgPyAnQ1JPTiB0cmlnZ2VyIGV2ZW50cycgOiBldmVudDEgPT09ICdodHRwJyA/ICdIVFRQIHJlcXVlc3QgZXZlbnRzJyA6ICdhbGwgZXZlbnRzJzsKfQpmdW5jdGlvbiBjb21wdXRlU3RhdHVzRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgc3RhdHVzMSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiBzdGF0dXMxID09PSAnZXJyb3InID8gJ2Vycm9yIHN0YXR1cycgOiBzdGF0dXMxID09PSAnc3VjY2VzcycgPyAnc3VjY2VzcyBzdGF0dXMnIDogJ2FueSBzdGF0dXMnOwp9CmZ1bmN0aW9uIGNvbXB1dGVJcEFkZHJlc3NGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgaXBBZGRyZXNzMSA9IGZpbHRlci5pcEFkZHJlc3MxIHx8IFtdOwogICAgcmV0dXJuIGlwQWRkcmVzczEubGVuZ3RoID09PSAwID8gJ2FueSBJUCBhZGRyZXNzJyA6IGlwQWRkcmVzczEubGVuZ3RoID09PSAxID8gYElQIGFkZHJlc3Mgb2YgJHtpcEFkZHJlc3MxWzBdfWAgOiBgSVAgYWRkcmVzcyBpbiBbJHtpcEFkZHJlc3MxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZU1ldGhvZEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBtZXRob2QxID0gZmlsdGVyLm1ldGhvZDEgfHwgW107CiAgICByZXR1cm4gbWV0aG9kMS5sZW5ndGggPT09IDAgPyAnYW55IG1ldGhvZCcgOiBtZXRob2QxLmxlbmd0aCA9PT0gMSA/IGBtZXRob2Qgb2YgJHttZXRob2QxWzBdfWAgOiBgbWV0aG9kIGluIFske21ldGhvZDEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlU2FtcGxpbmdSYXRlRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHNhbXBsaW5nUmF0ZTEgPSB0eXBlb2YgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPT09ICdudW1iZXInID8gZmlsdGVyLnNhbXBsaW5nUmF0ZTEgOiAxOwogICAgcmV0dXJuIHNhbXBsaW5nUmF0ZTEgPj0gMSA/ICdubyBzYW1wbGluZycgOiBgJHsoTWF0aC5tYXgoMCwgc2FtcGxpbmdSYXRlMSkgKiAxMDApLnRvRml4ZWQoMil9JSBzYW1wbGluZyByYXRlYDsKfQpmdW5jdGlvbiBjb21wdXRlU2VhcmNoRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgc2VhcmNoMSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiB0eXBlb2Ygc2VhcmNoMSA9PT0gJ3N0cmluZycgJiYgc2VhcmNoMS5sZW5ndGggPiAwID8gYGNvbnNvbGUgbG9ncyBjb250YWluaW5nICIke3NlYXJjaDF9ImAgOiAnbm8gc2VhcmNoIGZpbHRlcic7Cn0KZnVuY3Rpb24gY29tcHV0ZUhlYWRlckZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBoZWFkZXIxID0gZmlsdGVyLmhlYWRlcjEgfHwgW107CiAgICByZXR1cm4gaGVhZGVyMS5sZW5ndGggPT09IDAgPyAnbm8gaGVhZGVyIGZpbHRlcicgOiBoZWFkZXIxLmxlbmd0aCA9PT0gMSA/IGBoZWFkZXIgZmlsdGVyIG9mICR7aGVhZGVyMVswXX1gIDogYGhlYWRlciBmaWx0ZXJzIG9mIFske2hlYWRlcjEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlVGFpbHNUZXh0KHRhaWxDb3VudCkgewogICAgcmV0dXJuIHRhaWxDb3VudCA9PT0gMCA/ICdubyB0YWlscycgOiB0YWlsQ291bnQgPT09IDEgPyAnMSB0YWlsJyA6IGAke3RhaWxDb3VudH0gdGFpbHNgOwp9CmZ1bmN0aW9uIHJlbmRlclRleHRJbnRvU3Bhbih0ZXh0LCBzcGFuKSB7CiAgICBjb25zdCBwYXR0ZXJuID0gL2h0dHBzOlwvXC9bXlxzXSsvZzsKICAgIGxldCBtOwogICAgbGV0IGkxID0gMDsKICAgIHdoaWxlKG51bGwgIT09IChtID0gcGF0dGVybi5leGVjKHRleHQpKSl7CiAgICAgICAgaWYgKG0uaW5kZXggPiBpMSkgewogICAgICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQuc3Vic3RyaW5nKGkxLCBtLmluZGV4KSkpOwogICAgICAgIH0KICAgICAgICBjb25zdCB1cmwgPSBtWzBdOwogICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgIGEudGFyZ2V0ID0gJ19ibGFuayc7CiAgICAgICAgYS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh1cmwpKTsKICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGEpOwogICAgICAgIGkxID0gbS5pbmRleCArIHVybC5sZW5ndGg7CiAgICB9CiAgICBpZiAoaTEgPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dC5zdWJzdHJpbmcoaTEpKSk7CiAgICB9Cn0KY29uc3QgYXBwQ3NzID0gY3NzYAoKbWFpbiB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZ2FwOiAwLjVyZW07Cn0KCjpyb290IHsKICAgIC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYjogcmdiKDE4NywgMTM0LCAyNTIpOwp9CmA7CmNvbnN0IGFwcEh0bWwgPSBodG1sYAo8bWFpbj4KJHtTSURFQkFSX0hUTUx9CiR7Q09OU09MRV9IVE1MfQoke01PREFMX0hUTUx9CjwvbWFpbj5gOwpmdW5jdGlvbiBhcHBlbmRTdHlsZXNoZWV0cyhjc3NUZXh0cykgewogICAgY29uc3Qgc3R5bGVTaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBzdHlsZVNoZWV0LnR5cGUgPSAndGV4dC9jc3MnOwogICAgc3R5bGVTaGVldC50ZXh0Q29udGVudCA9IGNzc1RleHRzLmpvaW4oJ1xuXG4nKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVTaGVldCk7Cn0KYXBwZW5kU3R5bGVzaGVldHMoWwogICAgTUFURVJJQUxfQ1NTLmNzc1RleHQsCiAgICBhcHBDc3MuY3NzVGV4dCwKICAgIEhFQURFUl9DU1MuY3NzVGV4dCwKICAgIFNJREVCQVJfQ1NTLmNzc1RleHQsCiAgICBDT05TT0xFX0NTUy5jc3NUZXh0LAogICAgTU9EQUxfQ1NTLmNzc1RleHQsCiAgICBQUk9GSUxFX0VESVRPUl9DU1MuY3NzVGV4dCwKICAgIEZJTFRFUl9FRElUT1JfQ1NTLmNzc1RleHQsCiAgICBDSVJDVUxBUl9QUk9HUkVTU19DU1MuY3NzVGV4dCwgCl0pOwpMaXRFbGVtZW50LnJlbmRlcihhcHBIdG1sLCBkb2N1bWVudC5ib2R5KTsKY29uc3Qgdm0gPSBuZXcgVGFpbHdlYkFwcFZNKCk7CmNvbnN0IHVwZGF0ZVNpZGViYXIgPSBpbml0U2lkZWJhcihkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVDb25zb2xlID0gaW5pdENvbnNvbGUoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlTW9kYWwgPSBpbml0TW9kYWwoZG9jdW1lbnQsIHZtKTsKdm0ub25jaGFuZ2UgPSAoKT0+ewogICAgdXBkYXRlU2lkZWJhcigpOwogICAgdXBkYXRlQ29uc29sZSgpOwogICAgdXBkYXRlTW9kYWwoKTsKfTsKQ2xvdWRmbGFyZUFwaS5VUkxfVFJBTlNGT1JNRVIgPSAodik9PmAvZmV0Y2gvJHt2LnN1YnN0cmluZygnaHR0cHM6Ly8nLmxlbmd0aCl9YAo7CnZtLnN0YXJ0KCk7Cg==';