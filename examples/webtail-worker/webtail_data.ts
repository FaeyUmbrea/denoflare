

export const WEBTAIL_APP_HASH = '7215f12b06c68e644596154d0aa94c6d1cf9d341';
export const WEBTAIL_APP_B64 = 'Ly8gZGVuby1mbXQtaWdub3JlLWZpbGUKLy8gZGVuby1saW50LWlnbm9yZS1maWxlCi8vIFRoaXMgY29kZSB3YXMgYnVuZGxlZCB1c2luZyBgZGVubyBidW5kbGVgIGFuZCBpdCdzIG5vdCByZWNvbW1lbmRlZCB0byBlZGl0IGl0IG1hbnVhbGx5Cgpjb25zdCBkaXJlY3RpdmVzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgaXNEaXJlY3RpdmUgPSAobyk9PnsKICAgIHJldHVybiB0eXBlb2YgbyA9PT0gImZ1bmN0aW9uIiAmJiBkaXJlY3RpdmVzLmhhcyhvKTsKfTsKY29uc3QgaXNDRVBvbHlmaWxsID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzICE9IG51bGwgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzLnBvbHlmaWxsV3JhcEZsdXNoQ2FsbGJhY2sgIT09IHZvaWQgMDsKY29uc3QgcmVwYXJlbnROb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsLCBiZWZvcmUgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5pbnNlcnRCZWZvcmUoc3RhcnQsIGJlZm9yZSk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCByZW1vdmVOb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChzdGFydCk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCBub0NoYW5nZSA9IHt9Owpjb25zdCBub3RoaW5nID0ge307CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhMSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICAgIGlmIChkYXRhMS5pbmRleE9mKG1hcmtlcikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdzMiA9IGRhdGExLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7fQp9KSgpOwpjbGFzcyBFdmVudFBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgZXZlbnROYW1lLCBldmVudENvbnRleHQpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgICAgIHRoaXMuZXZlbnRDb250ZXh0ID0gZXZlbnRDb250ZXh0OwogICAgICAgIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50ID0gKGUpPT50aGlzLmhhbmRsZUV2ZW50KGUpCiAgICAgICAgOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy5fX3BlbmRpbmdWYWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fX3BlbmRpbmdWYWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdMaXN0ZW5lciA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgY29uc3Qgb2xkTGlzdGVuZXIgPSB0aGlzLnZhbHVlOwogICAgICAgIGNvbnN0IHNob3VsZFJlbW92ZUxpc3RlbmVyID0gbmV3TGlzdGVuZXIgPT0gbnVsbCB8fCBvbGRMaXN0ZW5lciAhPSBudWxsICYmIChuZXdMaXN0ZW5lci5jYXB0dXJlICE9PSBvbGRMaXN0ZW5lci5jYXB0dXJlIHx8IG5ld0xpc3RlbmVyLm9uY2UgIT09IG9sZExpc3RlbmVyLm9uY2UgfHwgbmV3TGlzdGVuZXIucGFzc2l2ZSAhPT0gb2xkTGlzdGVuZXIucGFzc2l2ZSk7CiAgICAgICAgY29uc3Qgc2hvdWxkQWRkTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciAhPSBudWxsICYmIChvbGRMaXN0ZW5lciA9PSBudWxsIHx8IHNob3VsZFJlbW92ZUxpc3RlbmVyKTsKICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRBZGRMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLl9fb3B0aW9ucyA9IGdldE9wdGlvbnMobmV3TGlzdGVuZXIpOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IG5ld0xpc3RlbmVyOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KICAgIGhhbmRsZUV2ZW50KGV2ZW50KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuY2FsbCh0aGlzLmV2ZW50Q29udGV4dCB8fCB0aGlzLmVsZW1lbnQsIGV2ZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlLmhhbmRsZUV2ZW50KGV2ZW50KTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZ2V0T3B0aW9ucyA9IChvKT0+byAmJiAoZXZlbnRPcHRpb25zU3VwcG9ydGVkID8gewogICAgICAgIGNhcHR1cmU6IG8uY2FwdHVyZSwKICAgICAgICBwYXNzaXZlOiBvLnBhc3NpdmUsCiAgICAgICAgb25jZTogby5vbmNlCiAgICB9IDogby5jYXB0dXJlKQo7CmNsYXNzIERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvciB7CiAgICBoYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhlbGVtZW50LCBuYW1lLCBzdHJpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZVswXTsKICAgICAgICBpZiAocHJlZml4ID09PSAiLiIpIHsKICAgICAgICAgICAgY29uc3QgY29tbWl0dGVyMiA9IG5ldyBQcm9wZXJ0eUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKTsKICAgICAgICAgICAgcmV0dXJuIGNvbW1pdHRlcjIucGFydHM7CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICJAIikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEV2ZW50UGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBvcHRpb25zLmV2ZW50Q29udGV4dCkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIj8iKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgQm9vbGVhbkF0dHJpYnV0ZVBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncykKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tbWl0dGVyID0gbmV3IEF0dHJpYnV0ZUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICByZXR1cm4gY29tbWl0dGVyLnBhcnRzOwogICAgfQogICAgaGFuZGxlVGV4dEV4cHJlc3Npb24ob3B0aW9ucykgewogICAgICAgIHJldHVybiBuZXcgTm9kZVBhcnQob3B0aW9ucyk7CiAgICB9Cn0KY29uc3QgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yID0gbmV3IERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcigpOwpmdW5jdGlvbiB0ZW1wbGF0ZUZhY3RvcnkocmVzdWx0KSB7CiAgICBsZXQgdGVtcGxhdGVDYWNoZSA9IHRlbXBsYXRlQ2FjaGVzLmdldChyZXN1bHQudHlwZSk7CiAgICBpZiAodGVtcGxhdGVDYWNoZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGVDYWNoZSA9IHsKICAgICAgICAgICAgc3RyaW5nc0FycmF5OiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgICBrZXlTdHJpbmc6IG5ldyBNYXAoKQogICAgICAgIH07CiAgICAgICAgdGVtcGxhdGVDYWNoZXMuc2V0KHJlc3VsdC50eXBlLCB0ZW1wbGF0ZUNhY2hlKTsKICAgIH0KICAgIGxldCB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LmdldChyZXN1bHQuc3RyaW5ncyk7CiAgICBpZiAodGVtcGxhdGUgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIGNvbnN0IGtleSA9IHJlc3VsdC5zdHJpbmdzLmpvaW4obWFya2VyKTsKICAgIHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuZ2V0KGtleSk7CiAgICBpZiAodGVtcGxhdGUgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHJlc3VsdCwgcmVzdWx0LmdldFRlbXBsYXRlRWxlbWVudCgpKTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5zZXQoa2V5LCB0ZW1wbGF0ZSk7CiAgICB9CiAgICB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5zZXQocmVzdWx0LnN0cmluZ3MsIHRlbXBsYXRlKTsKICAgIHJldHVybiB0ZW1wbGF0ZTsKfQpjb25zdCB0ZW1wbGF0ZUNhY2hlcyA9IG5ldyBNYXAoKTsKY29uc3QgcGFydHMgPSBuZXcgV2Vha01hcCgpOwpjb25zdCByZW5kZXIgPSAocmVzdWx0LCBjb250YWluZXIsIG9wdGlvbnMpPT57CiAgICBsZXQgcGFydCA9IHBhcnRzLmdldChjb250YWluZXIpOwogICAgaWYgKHBhcnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbW92ZU5vZGVzKGNvbnRhaW5lciwgY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgIHBhcnRzLnNldChjb250YWluZXIsIHBhcnQgPSBuZXcgTm9kZVBhcnQoT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIHRlbXBsYXRlRmFjdG9yeQogICAgICAgIH0sIG9wdGlvbnMpKSk7CiAgICAgICAgcGFydC5hcHBlbmRJbnRvKGNvbnRhaW5lcik7CiAgICB9CiAgICBwYXJ0LnNldFZhbHVlKHJlc3VsdCk7CiAgICBwYXJ0LmNvbW1pdCgpOwp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIxLjQuMSIpOwp9CmNvbnN0IGh0bWwgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFRlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgImh0bWwiLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKY29uc3Qgc3ZnID0gKHN0cmluZ3MsIC4uLnZhbHVlcyk9Pm5ldyBTVkdUZW1wbGF0ZVJlc3VsdChzdHJpbmdzLCB2YWx1ZXMsICJzdmciLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKdmFyIF9hOwp3aW5kb3cuSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSA9IChwcm9wLCBfb2JqKT0+cHJvcAo7CmNvbnN0IGRlZmF1bHRDb252ZXJ0ZXIgPSB7CiAgICB0b0F0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/ICIiIDogbnVsbDsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/IHZhbHVlIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgZnJvbUF0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbDsKICAgICAgICAgICAgY2FzZSBOdW1iZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgPyBudWxsIDogTnVtYmVyKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KfTsKY29uc3Qgbm90RXF1YWwgPSAodmFsdWUsIG9sZCk9PnsKICAgIHJldHVybiBvbGQgIT09IHZhbHVlICYmIChvbGQgPT09IG9sZCB8fCB2YWx1ZSA9PT0gdmFsdWUpOwp9Owpjb25zdCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbiA9IHsKICAgIGF0dHJpYnV0ZTogdHJ1ZSwKICAgIHR5cGU6IFN0cmluZywKICAgIGNvbnZlcnRlcjogZGVmYXVsdENvbnZlcnRlciwKICAgIHJlZmxlY3Q6IGZhbHNlLAogICAgaGFzQ2hhbmdlZDogbm90RXF1YWwKfTsKY29uc3QgU1RBVEVfSEFTX1VQREFURUQgPSAxOwpjb25zdCBTVEFURV9VUERBVEVfUkVRVUVTVEVEID0gMSA8PCAyOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSA9IDEgPDwgMzsKY29uc3QgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSA9IDEgPDwgNDsKY29uc3QgZmluYWxpemVkID0gImZpbmFsaXplZCI7CmNsYXNzIFVwZGF0aW5nRWxlbWVudCBleHRlbmRzIEhUTUxFbGVtZW50IHsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgICAgc3VwZXIoKTsKICAgICAgICB0aGlzLmluaXRpYWxpemUoKTsKICAgIH0KICAgIHN0YXRpYyBnZXQgb2JzZXJ2ZWRBdHRyaWJ1dGVzKCkgewogICAgICAgIHRoaXMuZmluYWxpemUoKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT57CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkocCwgdik7CiAgICAgICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuc2V0KGF0dHIsIHApOwogICAgICAgICAgICAgICAgYXR0cmlidXRlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICBzdGF0aWMgX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX2NsYXNzUHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGNvbnN0IHN1cGVyUHJvcGVydGllcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKS5fY2xhc3NQcm9wZXJ0aWVzOwogICAgICAgICAgICBpZiAoc3VwZXJQcm9wZXJ0aWVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHN1cGVyUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fY2xhc3NQcm9wZXJ0aWVzLnNldChrLCB2KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBjcmVhdGVQcm9wZXJ0eShuYW1lLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm5vQWNjZXNzb3IgfHwgdGhpcy5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSB0eXBlb2YgbmFtZSA9PT0gInN5bWJvbCIgPyBTeW1ib2woKSA6IGBfXyR7bmFtZX1gOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSB0aGlzLmdldFByb3BlcnR5RGVzY3JpcHRvcihuYW1lLCBrZXksIG9wdGlvbnMpOwogICAgICAgIGlmIChkZXNjcmlwdG9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMucHJvdG90eXBlLCBuYW1lLCBkZXNjcmlwdG9yKTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGdldCAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1trZXldOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXNbbmFtZV07CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfTsKICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSkgewogICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgJiYgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmdldChuYW1lKSB8fCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbjsKICAgIH0KICAgIHN0YXRpYyBmaW5hbGl6ZSgpIHsKICAgICAgICBjb25zdCBzdXBlckN0b3IgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7CiAgICAgICAgaWYgKCFzdXBlckN0b3IuaGFzT3duUHJvcGVydHkoZmluYWxpemVkKSkgewogICAgICAgICAgICBzdXBlckN0b3IuZmluYWxpemUoKTsKICAgICAgICB9CiAgICAgICAgdGhpc1tmaW5hbGl6ZWRdID0gdHJ1ZTsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwID0gbmV3IE1hcCgpOwogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoInByb3BlcnRpZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BlcnRpZXM7CiAgICAgICAgICAgIGNvbnN0IHByb3BLZXlzID0gWwogICAgICAgICAgICAgICAgLi4uT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcHMpLAogICAgICAgICAgICAgICAgLi4udHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHByb3BzKSA6IFtdCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiBwcm9wS2V5cyl7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZVByb3BlcnR5KHAsIHByb3BzW3BdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBfYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBvcHRpb25zLmF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlID09PSBmYWxzZSA/IHZvaWQgMCA6IHR5cGVvZiBhdHRyaWJ1dGUgPT09ICJzdHJpbmciID8gYXR0cmlidXRlIDogdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogdm9pZCAwOwogICAgfQogICAgc3RhdGljIF92YWx1ZUhhc0NoYW5nZWQodmFsdWUsIG9sZCwgaGFzQ2hhbmdlZCA9IG5vdEVxdWFsKSB7CiAgICAgICAgcmV0dXJuIGhhc0NoYW5nZWQodmFsdWUsIG9sZCk7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlciB8fCBkZWZhdWx0Q29udmVydGVyOwogICAgICAgIGNvbnN0IGZyb21BdHRyaWJ1dGUgPSB0eXBlb2YgY29udmVydGVyID09PSAiZnVuY3Rpb24iID8gY29udmVydGVyIDogY29udmVydGVyLmZyb21BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGZyb21BdHRyaWJ1dGUgPyBmcm9tQXR0cmlidXRlKHZhbHVlLCB0eXBlKSA6IHZhbHVlOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyOwogICAgICAgIGNvbnN0IHRvQXR0cmlidXRlID0gY29udmVydGVyICYmIGNvbnZlcnRlci50b0F0dHJpYnV0ZSB8fCBkZWZhdWx0Q29udmVydGVyLnRvQXR0cmlidXRlOwogICAgICAgIHJldHVybiB0b0F0dHJpYnV0ZSh2YWx1ZSwgdHlwZSk7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gMDsKICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlcyk9PnRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSByZXMKICAgICAgICApOwogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbCgpOwogICAgfQogICAgX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKF92LCBwKT0+ewogICAgICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW3BdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5zZXQocCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBfYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT50aGlzW3BdID0gdgogICAgICAgICk7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgdGhpcy5lbmFibGVVcGRhdGluZygpOwogICAgfQogICAgZW5hYmxlVXBkYXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyKCk7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSB2b2lkIDA7CiAgICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7fQogICAgYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZCwgdmFsdWUpIHsKICAgICAgICBpZiAob2xkICE9PSB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICBfcHJvcGVydHlUb0F0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3B0aW9ucyA9IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uKSB7CiAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgY29uc3QgYXR0ciA9IGN0b3IuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShuYW1lLCBvcHRpb25zKTsKICAgICAgICBpZiAoYXR0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHJWYWx1ZSA9IGN0b3IuX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKGF0dHIsIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURTsKICAgICAgICB9CiAgICB9CiAgICBfYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgY29uc3QgcHJvcE5hbWUgPSBjdG9yLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwLmdldChuYW1lKTsKICAgICAgICBpZiAocHJvcE5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBvcHRpb25zID0gY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMocHJvcE5hbWUpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICAgICAgdGhpc1twcm9wTmFtZV0gPSBjdG9yLl9wcm9wZXJ0eVZhbHVlRnJvbUF0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICB9CiAgICB9CiAgICByZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBsZXQgc2hvdWxkUmVxdWVzdFVwZGF0ZSA9IHRydWU7CiAgICAgICAgaWYgKG5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwgY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSk7CiAgICAgICAgICAgIGlmIChjdG9yLl92YWx1ZUhhc0NoYW5nZWQodGhpc1tuYW1lXSwgb2xkVmFsdWUsIG9wdGlvbnMuaGFzQ2hhbmdlZCkpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuaGFzKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuc2V0KG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHRydWUgJiYgISh0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLnNldChuYW1lLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNob3VsZFJlcXVlc3RVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSAmJiBzaG91bGRSZXF1ZXN0VXBkYXRlKSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSB0aGlzLl9lbnF1ZXVlVXBkYXRlKCk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZShuYW1lLCBvbGRWYWx1ZSkgewogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVDb21wbGV0ZTsKICAgIH0KICAgIGFzeW5jIF9lbnF1ZXVlVXBkYXRlKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm1VcGRhdGUoKTsKICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgYXdhaXQgcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZTsKICAgIH0KICAgIGdldCBfaGFzUmVxdWVzdGVkVXBkYXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICB9CiAgICBnZXQgaGFzVXBkYXRlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiAxOwogICAgfQogICAgcGVyZm9ybVVwZGF0ZSgpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMpIHsKICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgICAgIGNvbnN0IGNoYW5nZWRQcm9wZXJ0aWVzID0gdGhpcy5fY2hhbmdlZFByb3BlcnRpZXM7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdGhpcy5zaG91bGRVcGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoISh0aGlzLl91cGRhdGVTdGF0ZSAmIDEpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSEFTX1VQREFURUQ7CiAgICAgICAgICAgICAgICB0aGlzLmZpcnN0VXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGVkKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICB9CiAgICB9CiAgICBfbWFya1VwZGF0ZWQoKSB7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IHVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgX2dldFVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldFVwZGF0ZUNvbXBsZXRlKCk7CiAgICB9CiAgICBnZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlUHJvbWlzZTsKICAgIH0KICAgIHNob3VsZFVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBpZiAodGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgIT09IHZvaWQgMCAmJiB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fcHJvcGVydHlUb0F0dHJpYnV0ZShrLCB0aGlzW2tdLCB2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgIH0KICAgIHVwZGF0ZWQoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7fQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykge30KfQpfYSA9IGZpbmFsaXplZDsKVXBkYXRpbmdFbGVtZW50W19hXSA9IHRydWU7CmNvbnN0IEVsZW1lbnRQcm90byA9IEVsZW1lbnQucHJvdG90eXBlOwpFbGVtZW50UHJvdG8ubXNNYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudFByb3RvLndlYmtpdE1hdGNoZXNTZWxlY3RvcjsKY29uc3Qgc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzID0gd2luZG93LlNoYWRvd1Jvb3QgJiYgKHdpbmRvdy5TaGFkeUNTUyA9PT0gdm9pZCAwIHx8IHdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpICYmICJhZG9wdGVkU3R5bGVTaGVldHMiIGluIERvY3VtZW50LnByb3RvdHlwZSAmJiAicmVwbGFjZSIgaW4gQ1NTU3R5bGVTaGVldC5wcm90b3R5cGU7CmNvbnN0IGNvbnN0cnVjdGlvblRva2VuID0gU3ltYm9sKCk7CmNsYXNzIENTU1Jlc3VsdCB7CiAgICBjb25zdHJ1Y3Rvcihjc3NUZXh0LCBzYWZlVG9rZW4pewogICAgICAgIGlmIChzYWZlVG9rZW4gIT09IGNvbnN0cnVjdGlvblRva2VuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ1NTUmVzdWx0IGlzIG5vdCBjb25zdHJ1Y3RhYmxlLiBVc2UgYHVuc2FmZUNTU2Agb3IgYGNzc2AgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgIH0KICAgIGdldCBzdHlsZVNoZWV0KCkgewogICAgICAgIGlmICh0aGlzLl9zdHlsZVNoZWV0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0LnJlcGxhY2VTeW5jKHRoaXMuY3NzVGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmNzc1RleHQ7CiAgICB9Cn0KY29uc3QgdW5zYWZlQ1NTID0gKHZhbHVlKT0+ewogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoU3RyaW5nKHZhbHVlKSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owpjb25zdCB0ZXh0RnJvbUNTU1Jlc3VsdCA9ICh2YWx1ZSk9PnsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENTU1Jlc3VsdCkgewogICAgICAgIHJldHVybiB2YWx1ZS5jc3NUZXh0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZhbHVlIHBhc3NlZCB0byAnY3NzJyBmdW5jdGlvbiBtdXN0IGJlIGEgJ2NzcycgZnVuY3Rpb24gcmVzdWx0OiAke3ZhbHVlfS4gVXNlICd1bnNhZmVDU1MnIHRvIHBhc3Mgbm9uLWxpdGVyYWwgdmFsdWVzLCBidXQKICAgICAgICAgICAgdGFrZSBjYXJlIHRvIGVuc3VyZSBwYWdlIHNlY3VyaXR5LmApOwogICAgfQp9Owpjb25zdCBjc3MgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+ewogICAgY29uc3QgY3NzVGV4dCA9IHZhbHVlcy5yZWR1Y2UoKGFjYywgdiwgaWR4KT0+YWNjICsgdGV4dEZyb21DU1NSZXN1bHQodikgKyBzdHJpbmdzW2lkeCArIDFdCiAgICAsIHN0cmluZ3NbMF0pOwogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoY3NzVGV4dCwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owood2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSB8fCAod2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSA9IFtdKSkucHVzaCgiMi41LjEiKTsKY29uc3QgcmVuZGVyTm90SW1wbGVtZW50ZWQgPSB7fTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKYXN5bmMgZnVuY3Rpb24gbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0c2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RTY3JpcHRzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdFRhaWxzKGFjY291bnRJZCwgc2NyaXB0TmFtZSwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpfS93b3JrZXJzL3NjcmlwdHMvJHtzY3JpcHROYW1lfS90YWlsc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RUYWlscycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnY3JlYXRlVGFpbCcsICdQT1NUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04JzsKY29uc3QgQVBQTElDQVRJT05fT0NURVRfU1RSRUFNID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmNvbnN0IFRFWFRfUExBSU5fVVRGOCA9ICd0ZXh0L3BsYWluOyBjaGFyc2V0PVVURi04JzsKZnVuY3Rpb24gY29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCkgewogICAgcmV0dXJuIENsb3VkZmxhcmVBcGkuVVJMX1RSQU5TRk9STUVSKGBodHRwczovL2FwaS5jbG91ZGZsYXJlLmNvbS9jbGllbnQvdjQvYWNjb3VudHMvJHthY2NvdW50SWR9YCk7Cn0KZnVuY3Rpb24gaXNTdHJpbmdSZWNvcmQob2JqKSB7CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KG9iaikgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3Q7Cn0KYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZShvcCwgbWV0aG9kLCB1cmwsIGFwaVRva2VuLCBib2R5LCByZXNwb25zZVR5cGUgPSAnanNvbicpIHsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhgJHtvcH06ICR7bWV0aG9kfSAke3VybH1gKTsKICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyh7CiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YXBpVG9rZW59YAogICAgfSk7CiAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsIFRFWFRfUExBSU5fVVRGOCk7CiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nUmVjb3JkKGJvZHkpKSB7CiAgICAgICAgaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsIEFQUExJQ0FUSU9OX0pTT05fVVRGOCk7CiAgICAgICAgYm9keSA9IEpTT04uc3RyaW5naWZ5KGJvZHkpOwogICAgICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhib2R5KTsKICAgIH0KICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhgJHtmZXRjaFJlc3BvbnNlLnN0YXR1c30gJHtmZXRjaFJlc3BvbnNlLnVybH1gKTsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhbCiAgICAgICAgLi4uZmV0Y2hSZXNwb25zZS5oZWFkZXJzCiAgICBdLm1hcCgodik9PnYuam9pbignOiAnKQogICAgKS5qb2luKCdcbicpKTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZmV0Y2hSZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJykgfHwgJyc7CiAgICBpZiAoKHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzJyB8fCByZXNwb25zZVR5cGUgPT09ICdieXRlcz8nKSAmJiBjb250ZW50VHlwZSA9PT0gQVBQTElDQVRJT05fT0NURVRfU1RSRUFNKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKHJlc3BvbnNlVHlwZSA9PT0gJ3RleHQ/JyAmJiBjb250ZW50VHlwZS5zdGFydHNXaXRoKCd0ZXh0LycpKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoUmVzcG9uc2UudGV4dCgpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4LAogICAgICAgIEFQUExJQ0FUSU9OX0pTT04KICAgIF0uaW5jbHVkZXMoY29udGVudFR5cGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRlbnQtdHlwZTogJHtjb250ZW50VHlwZX0sIGZldGNoUmVzcG9uc2U9JHtmZXRjaFJlc3BvbnNlfSwgYm9keT0ke2F3YWl0IGZldGNoUmVzcG9uc2UudGV4dCgpfWApOwogICAgfQogICAgY29uc3QgYXBpUmVzcG9uc2UgPSBhd2FpdCBmZXRjaFJlc3BvbnNlLmpzb24oKTsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhhcGlSZXNwb25zZSk7CiAgICBpZiAoIWFwaVJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAoZmV0Y2hSZXNwb25zZS5zdGF0dXMgPT09IDQwNCAmJiBbCiAgICAgICAgICAgICdieXRlcz8nLAogICAgICAgICAgICAnanNvbj8nCiAgICAgICAgXS5pbmNsdWRlcyhyZXNwb25zZVR5cGUpKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHRocm93IG5ldyBDbG91ZGZsYXJlQXBpRXJyb3IoYCR7b3B9IGZhaWxlZDogc3RhdHVzPSR7ZmV0Y2hSZXNwb25zZS5zdGF0dXN9LCBlcnJvcnM9JHthcGlSZXNwb25zZS5lcnJvcnMubWFwKCh2KT0+YCR7di5jb2RlfSAke3YubWVzc2FnZX1gCiAgICAgICAgKS5qb2luKCcsICcpfWAsIGZldGNoUmVzcG9uc2Uuc3RhdHVzLCBhcGlSZXNwb25zZS5lcnJvcnMpOwogICAgfQogICAgcmV0dXJuIGFwaVJlc3BvbnNlOwp9CmNsYXNzIENsb3VkZmxhcmVBcGlFcnJvciBleHRlbmRzIEVycm9yIHsKICAgIHN0YXR1czsKICAgIGVycm9yczsKICAgIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIHN0YXR1cywgZXJyb3JzKXsKICAgICAgICBzdXBlcihtZXNzYWdlKTsKICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgIH0KfQpmdW5jdGlvbiBzZXRTdWJ0cmFjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KGxocyk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmhzKXsKICAgICAgICBydC5kZWxldGUoaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0VW5pb24obGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldChsaHMpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIHJocyl7CiAgICAgICAgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldEludGVyc2VjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgbGhzKXsKICAgICAgICBpZiAocmhzLmhhcyhpdGVtKSkgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgZm9yIChjb25zdCBpdGVtMSBvZiByaHMpewogICAgICAgIGlmIChsaHMuaGFzKGl0ZW0xKSkgcnQuYWRkKGl0ZW0xKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBzZXRFcXVhbChsaHMsIHJocykgewogICAgcmV0dXJuIGxocy5zaXplID09PSByaHMuc2l6ZSAmJiBbCiAgICAgICAgLi4ubGhzCiAgICBdLmV2ZXJ5KCh2KT0+cmhzLmhhcyh2KQogICAgKTsKfQpmdW5jdGlvbiBwYXJzZUhlYWRlckZpbHRlcihoZWFkZXIpIHsKICAgIGNvbnN0IGkgPSBoZWFkZXIuaW5kZXhPZignOicpOwogICAgaWYgKGkgPCAwKSByZXR1cm4gewogICAgICAgIGtleTogaGVhZGVyCiAgICB9OwogICAgY29uc3Qga2V5ID0gaGVhZGVyLnN1YnN0cmluZygwLCBpKS50cmltKCk7CiAgICBjb25zdCBxdWVyeTEgPSBoZWFkZXIuc3Vic3RyaW5nKGkgKyAxKS50cmltKCk7CiAgICByZXR1cm4gewogICAgICAgIGtleSwKICAgICAgICBxdWVyeTogcXVlcnkxCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9LRVlTID0gbmV3IFNldChbCiAgICAnb3V0Y29tZScsCiAgICAnc2NyaXB0TmFtZScsCiAgICAnZXhjZXB0aW9ucycsCiAgICAnbG9ncycsCiAgICAnZXZlbnRUaW1lc3RhbXAnLAogICAgJ2V2ZW50JwpdKTsKY29uc3QgS05PV05fT1VUQ09NRVMgPSBuZXcgU2V0KFsKICAgICdvaycsCiAgICAnZXhjZXB0aW9uJywKICAgICdleGNlZWRlZENwdScsCiAgICAnY2FuY2VsZWQnLAogICAgJ3Vua25vd24nCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBvdXRjb21lICwgc2NyaXB0TmFtZSAsIGV2ZW50VGltZXN0YW1wICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoIUtOT1dOX09VVENPTUVTLmhhcyhvdXRjb21lKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgb3V0Y29tZTogZXhwZWN0ZWQgb25lIG9mIFske1sKICAgICAgICAuLi5LTk9XTl9PVVRDT01FUwogICAgXS5qb2luKCcsICcpfV0sIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob3V0Y29tZSl9YCk7CiAgICBpZiAoc2NyaXB0TmFtZSAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgc2NyaXB0TmFtZTogZXhwZWN0ZWQgbnVsbCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShzY3JpcHROYW1lKX1gKTsKICAgIGNvbnN0IGxvZ3MgPSBwYXJzZUxvZ3Mob2JqQXNBbnkubG9ncyk7CiAgICBjb25zdCBleGNlcHRpb25zID0gcGFyc2VFeGNlcHRpb25zKG9iakFzQW55LmV4Y2VwdGlvbnMpOwogICAgaWYgKCEodHlwZW9mIGV2ZW50VGltZXN0YW1wID09PSAnbnVtYmVyJyAmJiBldmVudFRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBldmVudFRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KGV2ZW50VGltZXN0YW1wKX1gKTsKICAgIGNvbnN0IGV2ZW50ID0gb2JqQXNBbnkuZXZlbnQgJiYgb2JqQXNBbnkuZXZlbnQucmVxdWVzdCA/IHBhcnNlVGFpbE1lc3NhZ2VSZXF1ZXN0RXZlbnQob2JqQXNBbnkuZXZlbnQpIDogcGFyc2VUYWlsTWVzc2FnZUNyb25FdmVudChvYmpBc0FueS5ldmVudCk7CiAgICByZXR1cm4gewogICAgICAgIG91dGNvbWUsCiAgICAgICAgc2NyaXB0TmFtZSwKICAgICAgICBleGNlcHRpb25zLAogICAgICAgIGxvZ3MsCiAgICAgICAgZXZlbnRUaW1lc3RhbXAsCiAgICAgICAgZXZlbnQKICAgIH07Cn0KZnVuY3Rpb24gcGFyc2VMb2dzKG9iaikgewogICAgaWYgKCFBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGxvZ3M6IGV4cGVjdGVkIGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICByZXR1cm4gWwogICAgICAgIC4uLm9iagogICAgXS5tYXAocGFyc2VUYWlsTWVzc2FnZUxvZyk7Cn0KZnVuY3Rpb24gcGFyc2VFeGNlcHRpb25zKG9iaikgewogICAgaWYgKCFBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGV4Y2VwdGlvbnM6IGV4cGVjdGVkIGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICByZXR1cm4gWwogICAgICAgIC4uLm9iagogICAgXS5tYXAocGFyc2VUYWlsTWVzc2FnZUV4Y2VwdGlvbik7Cn0KZnVuY3Rpb24gaXNMb2dNZXNzYWdlUGFydCh2YWx1ZSkgewogICAgY29uc3QgdCA9IHR5cGVvZiB2YWx1ZTsKICAgIHJldHVybiB0ID09PSAnc3RyaW5nJyB8fCB0ID09PSAnbnVtYmVyJyB8fCB0ID09PSAnYm9vbGVhbicgfHwgdCA9PT0gJ3VuZGVmaW5lZCcgfHwgdCA9PT0gJ29iamVjdCc7Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0xPR19LRVlTID0gbmV3IFNldChbCiAgICAnbWVzc2FnZScsCiAgICAnbGV2ZWwnLAogICAgJ3RpbWVzdGFtcCcKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VMb2cob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VMb2c6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0xPR19LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgbWVzc2FnZSA9IHBhcnNlTG9nTWVzc2FnZVBhcnRBcnJheShvYmpBc0FueS5tZXNzYWdlLCAnbWVzc2FnZScpOwogICAgY29uc3QgeyBsZXZlbCAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIGxldmVsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGxldmVsOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobGV2ZWwpfWApOwogICAgaWYgKCEodHlwZW9mIHRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgdGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHRpbWVzdGFtcCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG1lc3NhZ2UsCiAgICAgICAgbGV2ZWwsCiAgICAgICAgdGltZXN0YW1wCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FWENFUFRJT05fS0VZUyA9IG5ldyBTZXQoWwogICAgJ25hbWUnLAogICAgJ21lc3NhZ2UnLAogICAgJ3RpbWVzdGFtcCcKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VFeGNlcHRpb24ob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VFeGNlcHRpb246IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VYQ0VQVElPTl9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBuYW1lICwgbWVzc2FnZSAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbmFtZTogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG5hbWUpfWApOwogICAgaWYgKCEodHlwZW9mIG1lc3NhZ2UgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVzc2FnZTogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1lc3NhZ2UpfWApOwogICAgaWYgKCEodHlwZW9mIHRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgdGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHRpbWVzdGFtcCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG5hbWUsCiAgICAgICAgbWVzc2FnZSwKICAgICAgICB0aW1lc3RhbXAKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2Nyb24nLAogICAgJ3NjaGVkdWxlZFRpbWUnCl0pOwpmdW5jdGlvbiBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKG9iaikpOwogICAgcmV0dXJuIHNldEVxdWFsKGtleXMsIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMpOwp9CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VDcm9uRXZlbnQ6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgY3JvbiAsIHNjaGVkdWxlZFRpbWUgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBjcm9uID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGNyb246IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShjcm9uKX1gKTsKICAgIGlmICghKHR5cGVvZiBzY2hlZHVsZWRUaW1lID09PSAnbnVtYmVyJyAmJiBzY2hlZHVsZWRUaW1lID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjaGVkdWxlZFRpbWU6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShzY2hlZHVsZWRUaW1lKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgY3JvbiwKICAgICAgICBzY2hlZHVsZWRUaW1lCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9SRVFVRVNUX0VWRU5UX0tFWVMgPSBuZXcgU2V0KFsKICAgICdyZXF1ZXN0JwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZVJlcXVlc3RFdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZVJlcXVlc3RFdmVudDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgcmVxdWVzdCA9IHBhcnNlVGFpbE1lc3NhZ2VFdmVudFJlcXVlc3Qob2JqQXNBbnkucmVxdWVzdCk7CiAgICByZXR1cm4gewogICAgICAgIHJlcXVlc3QKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ3VybCcsCiAgICAnbWV0aG9kJywKICAgICdoZWFkZXJzJwpdKTsKY29uc3QgT1BUSU9OQUxfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2NmJwpdKTsKY29uc3QgQUxMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBzZXRVbmlvbihSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBPUFRJT05BTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUV2ZW50UmVxdWVzdChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUV2ZW50UmVxdWVzdDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBBTExfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgdXJsICwgbWV0aG9kICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIHVybDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7CiAgICBpZiAoISh0eXBlb2YgbWV0aG9kID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG1ldGhvZDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1ldGhvZCl9YCk7CiAgICBjb25zdCBoZWFkZXJzID0gcGFyc2VTdHJpbmdSZWNvcmQob2JqQXNBbnkuaGVhZGVycywgJ2hlYWRlcnMnKTsKICAgIGNvbnN0IGNmID0gb2JqQXNBbnkuY2YgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iakFzQW55LmNmKTsKICAgIHJldHVybiB7CiAgICAgICAgdXJsLAogICAgICAgIG1ldGhvZCwKICAgICAgICBoZWFkZXJzLAogICAgICAgIGNmCiAgICB9Owp9CmZ1bmN0aW9uIGNoZWNrS2V5cyhvYmosIHJlcXVpcmVkS2V5cywgYWxsS2V5cykgewogICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoT2JqZWN0LmtleXMob2JqKSk7CiAgICBjb25zdCBtaXNzaW5nS2V5cyA9IHNldFN1YnRyYWN0KHJlcXVpcmVkS2V5cywga2V5cyk7CiAgICBpZiAobWlzc2luZ0tleXMuc2l6ZSA+IDApIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBrZXlzOiAke1sKICAgICAgICAuLi5taXNzaW5nS2V5cwogICAgXS5qb2luKCcsICcpfWApOwogICAgY29uc3QgZXh0cmFLZXlzID0gc2V0U3VidHJhY3Qoa2V5cywgYWxsS2V5cyB8fCByZXF1aXJlZEtleXMpOwogICAgaWYgKGV4dHJhS2V5cy5zaXplID4gMCkgdGhyb3cgbmV3IEVycm9yKGBFeHRyYSBrZXlzOiAke1sKICAgICAgICAuLi5leHRyYUtleXMKICAgIF0uam9pbignLCAnKX1gKTsKfQpmdW5jdGlvbiBwYXJzZVN0cmluZ1JlY29yZChvYmosIG5hbWUpIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBzdHJpbmcgcmVjb3JkLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBmb3IgKGNvbnN0IFtfLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqKSl7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IEV4cGVjdGVkIHN0cmluZyByZWNvcmQsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIH0KICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gcGFyc2VMb2dNZXNzYWdlUGFydEFycmF5KG9iaiwgbmFtZSkgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8ICFBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IEV4cGVjdGVkIGxvZyBtZXNzYWdlIHBhcnQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2Ygb2JqKXsKICAgICAgICBpZiAoIWlzTG9nTWVzc2FnZVBhcnQodmFsdWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBsb2cgbWVzc2FnZSBwYXJ0IGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICB9CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGNmOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZSwgbG9nZ2VyLCBhZGRpdGlvbmFsTG9ncyA9IFtdKSB7CiAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZShtZXNzYWdlLmV2ZW50VGltZXN0YW1wKSk7CiAgICBjb25zdCBvdXRjb21lID0gUFJFVFRZX09VVENPTUVTLmdldChtZXNzYWdlLm91dGNvbWUpIHx8IG1lc3NhZ2Uub3V0Y29tZTsKICAgIGNvbnN0IG91dGNvbWVDb2xvciA9IG1lc3NhZ2Uub3V0Y29tZSA9PT0gJ29rJyA/ICdncmVlbicgOiAncmVkJzsKICAgIGNvbnN0IHsgcHJvcHMgLCByZW1haW5pbmdMb2dzICB9ID0gcGFyc2VMb2dQcm9wcyhtZXNzYWdlLmxvZ3MpOwogICAgaWYgKGlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQobWVzc2FnZS5ldmVudCkpIHsKICAgICAgICBjb25zdCBjb2xvID0gcHJvcHMuY29sbyB8fCAnPz8/JzsKICAgICAgICBsb2dnZXIoYFslYyR7dGltZX0lY10gWyVjJHtjb2xvfSVjXSBbJWMke291dGNvbWV9JWNdICVjJHttZXNzYWdlLmV2ZW50LmNyb259YCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6ICR7b3V0Y29tZUNvbG9yfWAsICcnLCAnY29sb3I6IHJlZDsgZm9udC1zdHlsZTogYm9sZDsnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgeyBtZXRob2QgLCB1cmwgLCBjZiAgfSA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdDsKICAgICAgICBjb25zdCB1bnJlZGFjdGVkVXJsID0gdHlwZW9mIHByb3BzLnVybCA9PT0gJ3N0cmluZycgPyBwcm9wcy51cmwgOiB1cmw7CiAgICAgICAgY29uc3QgY29sbyA9IGNmPy5jb2xvIHx8IHByb3BzLmNvbG8gfHwgJz8/Pyc7CiAgICAgICAgaWYgKGNmID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29uc3QgeyBkdXJhYmxlT2JqZWN0Q2xhc3MgLCBkdXJhYmxlT2JqZWN0TmFtZSAsIGR1cmFibGVPYmplY3RJZCAgfSA9IGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcyk7CiAgICAgICAgICAgIGNvbnN0IGRvVGVtcGxhdGVzID0gW107CiAgICAgICAgICAgIGNvbnN0IGRvU3R5bGVzID0gW107CiAgICAgICAgICAgIGlmIChkdXJhYmxlT2JqZWN0Q2xhc3MpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0Q2xhc3N9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWNsYXNzOiAnJHtkdXJhYmxlT2JqZWN0Q2xhc3N9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0TmFtZX0lY2ApOwogICAgICAgICAgICAgICAgZG9TdHlsZXMucHVzaChgY29sb3I6IGdyYXk7IHgtZHVyYWJsZS1vYmplY3QtbmFtZTogJyR7ZHVyYWJsZU9iamVjdE5hbWV9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdElkKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlYyR7Y29tcHV0ZVNob3J0RHVyYWJsZU9iamVjdElkKGR1cmFibGVPYmplY3RJZCl9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWlkOiAnJHtkdXJhYmxlT2JqZWN0SWR9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZG9UZW1wbGF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlY0RPJWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goJ2NvbG9yOiBncmF5JywgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gWyR7ZG9UZW1wbGF0ZXMuam9pbignICcpfV0gJHttZXRob2R9ICVjJHt1bnJlZGFjdGVkVXJsfWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgLi4uZG9TdHlsZXMsICdjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkOycpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gJHttZXRob2R9ICVjJHt1bnJlZGFjdGVkVXJsfWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCB7IGRhdGE6IGRhdGEyICB9IG9mIGFkZGl0aW9uYWxMb2dzKXsKICAgICAgICBsb2dnZXIoLi4uZGF0YTIpOwogICAgfQogICAgZm9yIChjb25zdCB7IGxldmVsICwgbWVzc2FnZTogbG9nTWVzc2FnZSAgfSBvZiByZW1haW5pbmdMb2dzKXsKICAgICAgICBjb25zdCBsZXZlbENvbG9yID0gTE9HX0xFVkVMX0NPTE9SUy5nZXQobGV2ZWwpIHx8ICdncmF5JzsKICAgICAgICBjb25zdCBsb2dNZXNzYWdlcyA9IGxvZ01lc3NhZ2UubWFwKGZvcm1hdExvZ01lc3NhZ2VQYXJ0KS5qb2luKCcsICcpOwogICAgICAgIGxvZ2dlcihgICVjfCVjIFslYyR7bGV2ZWx9JWNdICR7bG9nTWVzc2FnZXN9YCwgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtsZXZlbENvbG9yfWAsICcnKTsKICAgIH0KICAgIGZvciAoY29uc3QgeyBuYW1lICwgbWVzc2FnZTogZXhjZXB0aW9uTWVzc2FnZSAgfSBvZiBtZXNzYWdlLmV4Y2VwdGlvbnMpewogICAgICAgIGxvZ2dlcihgICVjfCVjIFslYyR7bmFtZX0lY10gJWMke2V4Y2VwdGlvbk1lc3NhZ2V9YCwgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkYCwgJycsICdjb2xvcjogcmVkJyk7CiAgICB9Cn0KZnVuY3Rpb24gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhkYXRlKSB7CiAgICByZXR1cm4gWwogICAgICAgIGRhdGUuZ2V0RnVsbFllYXIoKSwKICAgICAgICAnLScsCiAgICAgICAgcGFkMihkYXRlLmdldE1vbnRoKCkgKyAxKSwKICAgICAgICAnLScsCiAgICAgICAgcGFkMihkYXRlLmdldERhdGUoKSksCiAgICAgICAgJyAnLAogICAgICAgIHBhZDIoZGF0ZS5nZXRIb3VycygpKSwKICAgICAgICAnOicsCiAgICAgICAgcGFkMihkYXRlLmdldE1pbnV0ZXMoKSksCiAgICAgICAgJzonLAogICAgICAgIHBhZDIoZGF0ZS5nZXRTZWNvbmRzKCkpCiAgICBdLmpvaW4oJycpOwp9CmZ1bmN0aW9uIHBhcnNlTG9nUHJvcHMobG9ncykgewogICAgY29uc3QgcmVtYWluaW5nTG9ncyA9IFtdOwogICAgY29uc3QgcHJvcHMgPSB7fTsKICAgIGZvciAoY29uc3QgbG9nIG9mIGxvZ3MpewogICAgICAgIGlmIChsb2cubWVzc2FnZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGxvZy5tZXNzYWdlWzBdOwogICAgICAgICAgICBpZiAodHlwZW9mIG1zZyA9PT0gJ3N0cmluZycgJiYgbXNnLnN0YXJ0c1dpdGgoJ2xvZ3Byb3BzOicpKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbGVyID0gbXNnLnN1YnN0cmluZyhtc2cuaW5kZXhPZignOicpICsgMSk7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbGVyUHJvcHMgPSB0cnlQYXJzZVByb3BzRnJvbUpzb24odHJhaWxlcik7CiAgICAgICAgICAgICAgICBhcHBlbmRQcm9wcyh0cmFpbGVyUHJvcHMsIHByb3BzKTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcGFydCBvZiBsb2cubWVzc2FnZS5zbGljZSgxKSl7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFydFByb3BzID0gdHJ5UGFyc2VQcm9wc0Zyb21QYXJ0KHBhcnQpOwogICAgICAgICAgICAgICAgICAgIGFwcGVuZFByb3BzKHBhcnRQcm9wcywgcHJvcHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVtYWluaW5nTG9ncy5wdXNoKGxvZyk7CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIHByb3BzLAogICAgICAgIHJlbWFpbmluZ0xvZ3MKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUR1cmFibGVPYmplY3RJbmZvKHByb3BzKSB7CiAgICBjb25zdCBkdXJhYmxlT2JqZWN0Q2xhc3MgPSB1bmRlZmluZWRJZkVtcHR5KCh0eXBlb2YgcHJvcHMuZHVyYWJsZU9iamVjdENsYXNzID09PSAnc3RyaW5nJyA/IHByb3BzLmR1cmFibGVPYmplY3RDbGFzcyA6ICcnKS50cmltKCkpOwogICAgY29uc3QgZHVyYWJsZU9iamVjdElkID0gdW5kZWZpbmVkSWZFbXB0eSgodHlwZW9mIHByb3BzLmR1cmFibGVPYmplY3RJZCA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0SWQgOiAnJykudHJpbSgpKTsKICAgIGNvbnN0IGR1cmFibGVPYmplY3ROYW1lID0gdW5kZWZpbmVkSWZFbXB0eSgodHlwZW9mIHByb3BzLmR1cmFibGVPYmplY3ROYW1lID09PSAnc3RyaW5nJyA/IHByb3BzLmR1cmFibGVPYmplY3ROYW1lIDogJycpLnRyaW0oKSk7CiAgICByZXR1cm4gewogICAgICAgIGR1cmFibGVPYmplY3RDbGFzcywKICAgICAgICBkdXJhYmxlT2JqZWN0SWQsCiAgICAgICAgZHVyYWJsZU9iamVjdE5hbWUKICAgIH07Cn0KZnVuY3Rpb24gdW5kZWZpbmVkSWZFbXB0eShzdHIpIHsKICAgIHJldHVybiBzdHIgPT09ICcnID8gdW5kZWZpbmVkIDogc3RyOwp9CmZ1bmN0aW9uIGNvbXB1dGVTaG9ydER1cmFibGVPYmplY3RJZChpZCkgewogICAgcmV0dXJuIC9eWzAtOWEtZkEtRl17NSx9JC8udGVzdChpZCkgPyBgJHtpZC5zdWJzdHJpbmcoMCwgNCl94oCmYCA6IGlkOwp9CmZ1bmN0aW9uIGFwcGVuZFByb3BzKHNyYywgZHN0KSB7CiAgICBpZiAoc3JjKSB7CiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoc3JjKSl7CiAgICAgICAgICAgIGRzdFtrZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIHRyeVBhcnNlUHJvcHNGcm9tSnNvbih2YWx1ZSkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBwcm9wcyA9IEpTT04ucGFyc2UodmFsdWUudHJpbSgpKTsKICAgICAgICBpZiAodHlwZW9mIHByb3BzID09PSAnb2JqZWN0JyAmJiBwcm9wcyAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheShwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgIH0KICAgIH0gY2F0Y2ggIHt9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHRyeVBhcnNlUHJvcHNGcm9tUGFydChwYXJ0KSB7CiAgICB0cnkgewogICAgICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcgJiYgcGFydCAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheShwYXJ0KSkgewogICAgICAgICAgICByZXR1cm4gcGFydDsKICAgICAgICB9CiAgICB9IGNhdGNoICB7fQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBmb3JtYXRMb2dNZXNzYWdlUGFydChwYXJ0KSB7CiAgICBpZiAodHlwZW9mIHBhcnQgPT09ICdvYmplY3QnKSByZXR1cm4gSlNPTi5zdHJpbmdpZnkocGFydCk7CiAgICByZXR1cm4gYCR7cGFydH1gOwp9CmZ1bmN0aW9uIHBhZDIobnVtKSB7CiAgICByZXR1cm4gbnVtLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKTsKfQpjb25zdCBQUkVUVFlfT1VUQ09NRVMgPSBuZXcgTWFwKFsKICAgIFsKICAgICAgICAnb2snLAogICAgICAgICdPaycKICAgIF0sCiAgICBbCiAgICAgICAgJ2V4Y2VwdGlvbicsCiAgICAgICAgJ0Vycm9yJwogICAgXSwKICAgIFsKICAgICAgICAnZXhjZWVkZWRDcHUnLAogICAgICAgICdFeGNlZWRlZCBMaW1pdCcKICAgIF0sCiAgICBbCiAgICAgICAgJ2NhbmNlbGVkJywKICAgICAgICAnQ2FuY2VsZWQnCiAgICBdLAogICAgWwogICAgICAgICd1bmtub3duJywKICAgICAgICAnVW5rbm93bicKICAgIF0sIApdKTsKY29uc3QgTE9HX0xFVkVMX0NPTE9SUyA9IG5ldyBNYXAoWwogICAgWwogICAgICAgICd0cmFjZScsCiAgICAgICAgJ2dyYXknCiAgICBdLAogICAgWwogICAgICAgICdkZWJ1ZycsCiAgICAgICAgJ3B1cnBsZScKICAgIF0sCiAgICBbCiAgICAgICAgJ2xvZycsCiAgICAgICAgJ2dyYXknCiAgICBdLAogICAgWwogICAgICAgICdpbmZvJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ3dhcm4nLAogICAgICAgICdyZWQnCiAgICBdLAogICAgWwogICAgICAgICdlcnJvcicsCiAgICAgICAgJ3JlZCcKICAgIF0sIApdKTsKY2xhc3MgVGFpbENvbm5lY3Rpb24gewogICAgc3RhdGljIFZFUkJPU0UgPSBmYWxzZTsKICAgIHdzOwogICAgY2FsbGJhY2tzOwogICAgb3B0aW9uczsKICAgIGhlYXJ0YmVhdElkOwogICAgY29uc3RydWN0b3Iod2ViU29ja2V0VXJsLCBjYWxsYmFja3MsIG9wdHMpewogICAgICAgIHRoaXMud3MgPSBuZXcgV2ViU29ja2V0KHdlYlNvY2tldFVybCwgJ3RyYWNlLXYxJyk7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgY29uc3QgeyB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzICB9ID0gb3B0czsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ29wZW4nLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIHRoaXMuc2VuZE9wdGlvbnNJZk9wZW4oKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5vbk9wZW4pIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbk9wZW4odGhpcywgdGltZVN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcyA+IDApIHsKICAgICAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpLCBgc2VuZGluZyB3cyBwaW5nIHt9IGV2ZXJ5ICR7d2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kc31gKTsKICAgICAgICAgICAgICAgIHRoaXMuaGVhcnRiZWF0SWQgPSBzZXRJbnRlcnZhbCgoKT0+ewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLndzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpLCBgc2VuZGluZyB3cyBwaW5nIHt9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud3Muc2VuZCgne30nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzICogMTAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ2Nsb3NlJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IGNvZGUgLCByZWFzb24gLCB3YXNDbGVhbiAsIHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICBpZiAoVGFpbENvbm5lY3Rpb24uVkVSQk9TRSkgY29uc29sZS5sb2coZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKSwgJ1RhaWxDb25uZWN0aW9uOiB3cyBjbG9zZScsIHsKICAgICAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgICAgICByZWFzb24sCiAgICAgICAgICAgICAgICB3YXNDbGVhbiwKICAgICAgICAgICAgICAgIHRpbWVTdGFtcAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmhlYXJ0YmVhdElkKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5vbkNsb3NlKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25DbG9zZSh0aGlzLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgY29uc3QgZXJyb3JJbmZvID0gY29tcHV0ZUVycm9ySW5mbyhldmVudCk7CiAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpLCAnVGFpbENvbm5lY3Rpb246IHdzIGVycm9yJywgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5vbkVycm9yKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25FcnJvcih0aGlzLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBhc3luYyAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChldmVudC5kYXRhIGluc3RhbmNlb2YgQmxvYikgewogICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IGV2ZW50LmRhdGEudGV4dCgpOwogICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZSh0ZXh0KTsKICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gcGFyc2VUYWlsTWVzc2FnZShvYmopOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblVucGFyc2VkTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIG9iaiwgZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbE1lc3NhZ2UodGhpcywgdGltZVN0YW1wLCBtZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblVucGFyc2VkTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIGV2ZW50LmRhdGEsIG5ldyBFcnJvcihgRXhwZWN0ZWQgZXZlbnQuZGF0YSB0byBiZSBCbG9iYCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBzZXRPcHRpb25zKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgIHRoaXMuc2VuZE9wdGlvbnNJZk9wZW4oKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNsb3NlKGNvZGUsIHJlYXNvbikgewogICAgICAgIHRoaXMud3MuY2xvc2UoY29kZSwgcmVhc29uKTsKICAgIH0KICAgIHNlbmRPcHRpb25zSWZPcGVuKCkgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMgJiYgdGhpcy53cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikgewogICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGBzZW5kT3B0aW9uc0lmT3Blbjogc2VuZGluZyAke3BheWxvYWR9YCk7CiAgICAgICAgICAgIHRoaXMud3Muc2VuZChwYXlsb2FkKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUVycm9ySW5mbyhldmVudCkgewogICAgaWYgKGV2ZW50LnR5cGUgPT09ICdlcnJvcicpIHsKICAgICAgICBjb25zdCB7IG1lc3NhZ2UgLCBmaWxlbmFtZSAsIGxpbmVubyAsIGNvbG5vICwgZXJyb3IgIH0gPSBldmVudDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtZXNzYWdlLAogICAgICAgICAgICBmaWxlbmFtZSwKICAgICAgICAgICAgbGluZW5vLAogICAgICAgICAgICBjb2xubywKICAgICAgICAgICAgZXJyb3IKICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBnZW5lcmF0ZVV1aWQoKSB7CiAgICBjb25zdCBjcnlwdG9Bc0FueSA9IGNyeXB0bzsKICAgIGlmICh0eXBlb2YgY3J5cHRvQXNBbnkucmFuZG9tVVVJRCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBjcnlwdG9Bc0FueS5yYW5kb21VVUlEKCk7CiAgICB9CiAgICBjb25zdCBybmRzID0gY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDhBcnJheSgxNikpOwogICAgcm5kc1s2XSA9IHJuZHNbNl0gJiAweDBmIHwgMHg0MDsKICAgIHJuZHNbOF0gPSBybmRzWzhdICYgMHgzZiB8IDB4ODA7CiAgICByZXR1cm4gYnl0ZXNUb1V1aWQocm5kcyk7Cn0KZnVuY3Rpb24gYnl0ZXNUb1V1aWQoYnl0ZXMpIHsKICAgIGNvbnN0IGJpdHMgPSBbCiAgICAgICAgLi4uYnl0ZXMKICAgIF0ubWFwKChiaXQpPT57CiAgICAgICAgY29uc3QgcyA9IGJpdC50b1N0cmluZygxNik7CiAgICAgICAgcmV0dXJuIGJpdCA8IDB4MTAgPyAiMCIgKyBzIDogczsKICAgIH0pOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5iaXRzLnNsaWNlKDAsIDQpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDQsIDYpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDYsIDgpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDgsIDEwKSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSgxMCwgMTYpLCAKICAgIF0uam9pbigiIik7Cn0KY2xhc3MgTWF0ZXJpYWwgewogICAgc3RhdGljIGhpZ2hFbXBoYXNpc1RleHRDb2xvciA9ICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuODcpJzsKICAgIHN0YXRpYyBtZWRpdW1FbXBoYXNpc1RleHRDb2xvciA9ICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNjApJzsKfQpjb25zdCBNQVRFUklBTF9DU1MgPSBjc3NgCgo6cm9vdCB7CiAgLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3I6IHJnYigzMC43NSwgMzAuNzUsIDMwLjc1KTsKICAtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcjogcmdiKDQwLjk1LCA0MC45NSwgNDAuOTUpOwogIC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuODcpOwogIC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCk7CiAgLS1kaXNhYmxlZC10ZXh0LWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMzgpOwogIC0tYnV0dG9uLWJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgLS1wcmltYXJ5LWNvbG9yOiAjYmI4NmZjOwogIC0tYmFja2dyb3VuZC1jb2xvcjogIzEyMTIxMjsKICAtLXNhbnMtc2VyaWYtZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgYXZlbmlyIG5leHQsIGF2ZW5pciwgaGVsdmV0aWNhIG5ldWUsIGhlbHZldGljYSwgVWJ1bnR1LCByb2JvdG8sIG5vdG8sIHNlZ29lIHVpLCBhcmlhbCwgc2Fucy1zZXJpZjsKICAtLW1vbm9zcGFjZS1mb250LWZhbWlseTogTWVubG8sIENvbnNvbGFzLCB1aS1tb25vc3BhY2UsIG1vbm9zcGFjZTsKfQoKLyoqIHRleHQgc2l6ZSBjbGFzc2VzICovCgouaDYgewogICAgZm9udC1zaXplOiAxLjI1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDA3NTByZW07CiAgICBmb250LXdlaWdodDogYm9sZGVyOwp9CgouYm9keTIsIGZpZWxkc2V0IGxhYmVsLCBmaWVsZHNldCBvdXRwdXQsIGZpZWxkc2V0IGRldGFpbHMgewogICAgZm9udC1zaXplOiAwLjg3NXJlbTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjAxNzg2cmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGxpbmUtaGVpZ2h0OiAxLjI1cmVtOwp9CgouYnV0dG9uLCBidXR0b24sIC5hY3Rpb24taWNvbiB7CiAgICBmb250LXNpemU6IDAuODc1cmVtOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjA4OTI5cmVtOwogICAgZm9udC13ZWlnaHQ6IGJvbGRlcjsKfQoKLm92ZXJsaW5lLCB0aCB7CiAgICBmb250LXNpemU6IDAuNjI1cmVtOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjE1MDAwcmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKfQoKLmNhcHRpb24gewogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDMzMzNyZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwp9CgovKiBsaWdodCB0ZXh0IG9uIGRhcmsgYmFja2dyb3VuZCBjb2xvcnMgKi8KCi5oaWdoLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCi5tZWRpdW0tZW1waGFzaXMtdGV4dCwgZmllbGRzZXQgbGFiZWwsIHRoIHsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCi5kaXNhYmxlZC1lbXBoYXNpcy10ZXh0IHsKICAgIGNvbG9yOiB2YXIoLS1kaXNhYmxlZC10ZXh0LWNvbG9yKTsKfQoKLyoqIGVsZXZhdGlvbiBiYWNrZ3JvdW5kcyAqLwoKLnN1cmZhY2UtMDEgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKLnN1cmZhY2UtMDQgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKLyoqIGFjdGlvbi1pY29uICovCgouYWN0aW9uLWljb24gewogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIG1pbi1oZWlnaHQ6IDJyZW07CiAgICBtaW4td2lkdGg6IDJyZW07CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIG9wYWNpdHk6IDAuNjk7ICAvKiogbWVkaXVtLWVtcGhhc2lzIC8gaGlnaC1lbXBoYXNpcyAqLwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICAuYWN0aW9uLWljb246aG92ZXIgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICAgICAgb3BhY2l0eTogMTsKICAgIH0KfQoKLyoqIGJ1dHRvbiAqLwoKYnV0dG9uIHsKICAgIGJvcmRlcjogbm9uZTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcik7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKICAgIG1pbi13aWR0aDogOHJlbTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKfQoKYnV0dG9uLnNlbGVjdGVkIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKQG1lZGlhIChob3ZlcikgewogICAgYnV0dG9uOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwogICAgICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgfQp9CgpidXR0b246ZGlzYWJsZWQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgpAbWVkaWEgKGhvdmVyKSB7CiAgICBidXR0b246ZGlzYWJsZWQ6aG92ZXIgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcik7CiAgICAgICAgY3Vyc29yOiBkZWZhdWx0OwogICAgfQp9CgovKiogYW5jaG9ycyAqLwoKYSB7CiAgICBjb2xvcjogdmFyKC0tcHJpbWFyeS1jb2xvcik7CiAgICB0ZXh0LXVuZGVybGluZS1vZmZzZXQ6IDAuMnJlbTsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKfQoKQG1lZGlhIChob3ZlcjogaG92ZXIpIHsKICAgIGE6aG92ZXIgewogICAgICAgIHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOwogICAgfQp9CgovKiogZm9ybXMgKi8KCmZpZWxkc2V0IHsKICAgIGJvcmRlcjogc29saWQgMXB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCk7CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC1yb3ctZ2FwOiAxcmVtOwogICAgZ3JpZC1jb2x1bW4tZ2FwOiAxcmVtOwogICAgcGFkZGluZzogMXJlbTsKfQoKbGFiZWwgewogICAgZ3JpZC1jb2x1bW46IDE7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKfQoKLmZvcm0tbGhzIHsKICAgIGdyaWQtY29sdW1uOiAxOwp9CgppbnB1dCwgLmZvcm0tcmhzIHsKICAgIGdyaWQtY29sdW1uOiAyOwogICAgbWluLXdpZHRoOiAwOwp9CgouZm9ybS1yb3cgewogICAgZ3JpZC1jb2x1bW46IDEgLyBzcGFuIDI7Cn0KCmZpZWxkc2V0IGlucHV0W3R5cGU9dGV4dF0gewogICAgcGFkZGluZzogMC41cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgYm9yZGVyOiBzb2xpZCAxcHggdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpmaWVsZHNldCBvdXRwdXQgewogICAgcGFkZGluZzogMC41cmVtIDA7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpmaWVsZHNldCBkZXRhaWxzIHsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCmA7CmNvbnN0IEhFQURFUl9IVE1MID0gaHRtbGAKPGhlYWRlciBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0Ij4KICAgIDxkaXYgaWQ9ImhlYWRlci1jb250ZW50Ij4KICAgICAgICBXZWJ0YWlsCiAgICAgICAgPHNwYW4gaWQ9ImhlYWRlci12ZXJzaW9uIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvc3Bhbj4KICAgICAgICA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiIGlkPSJnaXRodWItbG9nby1hbmNob3IiPjxpbWcgaWQ9ImdpdGh1Yi1sb2dvIj48L2E+CiAgICA8L2Rpdj4KPC9oZWFkZXI+CmA7CmNvbnN0IEhFQURFUl9DU1MgPSBjc3NgCmhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMXJlbSAwOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCiNoZWFkZXItY29udGVudCB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGJhc2VsaW5lOwogICAgcGFkZGluZy1yaWdodDogMi4ycmVtOwp9CgojaGVhZGVyLXZlcnNpb24gewogICAgZmxleC1ncm93OiAxOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgojZ2l0aHViLWxvZ28tYW5jaG9yIHsKICAgIGxpbmUtaGVpZ2h0OiAwOwogICAgb3BhY2l0eTogMC41Owp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgI2dpdGh1Yi1sb2dvLWFuY2hvcjpob3ZlciB7CiAgICAgICAgb3BhY2l0eTogMC43NTsKICAgIH0KfQoKI2dpdGh1Yi1sb2dvIHsKICAgIHdpZHRoOiAxcmVtOwogICAgbWFyZ2luLWJvdHRvbTogLTAuMXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdEhlYWRlcihkb2N1bWVudCwgdm0xLCBkYXRhMykgewogICAgY29uc3QgaGVhZGVyQ29udGVudEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGVhZGVyLWNvbnRlbnQnKTsKICAgIGlmICgoZGF0YTMuZmxhZ3MgfHwgJycpLmluY2x1ZGVzKCdkZW1vLXRvZ2dsZScpKSB7CiAgICAgICAgaGVhZGVyQ29udGVudEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGJsY2xpY2snLCAoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2bTEudG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGhlYWRlclZlcnNpb25TcGFuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlYWRlci12ZXJzaW9uJyk7CiAgICBjb25zdCB7IHZlcnNpb24gIH0gPSBkYXRhMzsKICAgIGhlYWRlclZlcnNpb25TcGFuLnRleHRDb250ZW50ID0gdmVyc2lvbiA/IGB2JHt2ZXJzaW9ufWAgOiAnJzsKICAgIGNvbnN0IGdpdGh1YkxvZ29JbWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2l0aHViLWxvZ28nKTsKICAgIGdpdGh1YkxvZ29JbWcuc3JjID0gY29tcHV0ZUdpdGh1YkxvZ29EYXRhVXJsKCk7CiAgICByZXR1cm4gKCk9Pnt9Owp9CmZ1bmN0aW9uIGNvbXB1dGVHaXRodWJMb2dvRGF0YVVybCgpIHsKICAgIGNvbnN0IHN2ZzEgPSBHSVRIVUJfTE9HTy5yZXBsYWNlKCdmaWxsOndoaXRlOycsIGBmaWxsOiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfTtgKTsKICAgIHJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO3V0ZjgsJyArIHN2ZzE7Cn0KY29uc3QgR0lUSFVCX0xPR08gPSBgPHN2ZyB3aWR0aD0iYXV0byIgaGVpZ2h0PSJhdXRvIiB2aWV3Qm94PSIwIDAgMTM2IDEzMyIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxuczpzZXJpZj0iaHR0cDovL3d3dy5zZXJpZi5jb20vIiBzdHlsZT0iZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjI7Ij4KPGcgdHJhbnNmb3JtPSJtYXRyaXgoNC4xNjY2NywwLDAsNC4xNjY2NywtNTY4LC0xMzgxLjA2KSI+CiAgICA8cGF0aCBkPSJNMTUyLjYwOCwzMzEuNDU1QzE0My42MTQsMzMxLjQ1NSAxMzYuMzIsMzM4Ljc0OCAxMzYuMzIsMzQ3Ljc0NUMxMzYuMzIsMzU0Ljk0MiAxNDAuOTg3LDM2MS4wNDcgMTQ3LjQ2LDM2My4yMDFDMTQ4LjI3NSwzNjMuMzUxIDE0OC41NzIsMzYyLjg0OCAxNDguNTcyLDM2Mi40MTZDMTQ4LjU3MiwzNjIuMDI5IDE0OC41NTgsMzYxLjAwNSAxNDguNTUsMzU5LjY0NkMxNDQuMDE5LDM2MC42MyAxNDMuMDYzLDM1Ny40NjIgMTQzLjA2MywzNTcuNDYyQzE0Mi4zMjIsMzU1LjU4IDE0MS4yNTQsMzU1LjA3OSAxNDEuMjU0LDM1NS4wNzlDMTM5Ljc3NSwzNTQuMDY5IDE0MS4zNjYsMzU0LjA4OSAxNDEuMzY2LDM1NC4wODlDMTQzLjAwMSwzNTQuMjA0IDE0My44NjEsMzU1Ljc2OCAxNDMuODYxLDM1NS43NjhDMTQ1LjMxNCwzNTguMjU3IDE0Ny42NzQsMzU3LjUzOCAxNDguNjAyLDM1Ny4xMjFDMTQ4Ljc1LDM1Ni4wNjkgMTQ5LjE3MSwzNTUuMzUxIDE0OS42MzYsMzU0Ljk0NEMxNDYuMDE5LDM1NC41MzMgMTQyLjIxNiwzNTMuMTM1IDE0Mi4yMTYsMzQ2Ljg5M0MxNDIuMjE2LDM0NS4xMTUgMTQyLjg1MSwzNDMuNjYgMTQzLjg5MywzNDIuNTIyQzE0My43MjUsMzQyLjExIDE0My4xNjYsMzQwLjQ1MyAxNDQuMDUzLDMzOC4yMTFDMTQ0LjA1MywzMzguMjExIDE0NS40MiwzMzcuNzczIDE0OC41MzIsMzM5Ljg4MUMxNDkuODMxLDMzOS41MTkgMTUxLjIyNSwzMzkuMzM5IDE1Mi42MSwzMzkuMzMyQzE1My45OTQsMzM5LjMzOSAxNTUuMzg3LDMzOS41MTkgMTU2LjY4OCwzMzkuODgxQzE1OS43OTgsMzM3Ljc3MyAxNjEuMTYzLDMzOC4yMTEgMTYxLjE2MywzMzguMjExQzE2Mi4wNTIsMzQwLjQ1MyAxNjEuNDkzLDM0Mi4xMSAxNjEuMzI2LDM0Mi41MjJDMTYyLjM3LDM0My42NiAxNjMsMzQ1LjExNSAxNjMsMzQ2Ljg5M0MxNjMsMzUzLjE1MSAxNTkuMTkxLDM1NC41MjggMTU1LjU2MywzNTQuOTMxQzE1Ni4xNDcsMzU1LjQzNCAxNTYuNjY4LDM1Ni40MjggMTU2LjY2OCwzNTcuOTQ3QzE1Ni42NjgsMzYwLjEyNSAxNTYuNjQ4LDM2MS44ODIgMTU2LjY0OCwzNjIuNDE2QzE1Ni42NDgsMzYyLjg1MiAxNTYuOTQyLDM2My4zNTkgMTU3Ljc2OCwzNjMuMkMxNjQuMjM2LDM2MS4wNDEgMTY4Ljg5OSwzNTQuOTQgMTY4Ljg5OSwzNDcuNzQ1QzE2OC44OTksMzM4Ljc0OCAxNjEuNjA1LDMzMS40NTUgMTUyLjYwOCwzMzEuNDU1WiIgc3R5bGU9ImZpbGw6d2hpdGU7Ii8+CjwvZz4KPC9zdmc+YDsKZnVuY3Rpb24gYWN0aW9uSWNvbihpY29uLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgdGV4dCAsIG9uY2xpY2sgIH0gPSBvcHRzOwogICAgcmV0dXJuIGh0bWxgPGRpdiBjbGFzcz0iYWN0aW9uLWljb24iIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBvbmNsaWNrICYmIG9uY2xpY2soKTsKICAgIH19PiR7aWNvbn0ke3RleHQgfHwgJyd9PC9kaXY+YDsKfQpjb25zdCBDTEVBUl9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNNSAxM2gxNHYtMkg1djJ6bS0yIDRoMTR2LTJIM3Yyek03IDd2MmgxNFY3SDd6Ii8+PC9zdmc+YDsKY29uc3QgRURJVF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTQuMDYgOS4wMmwuOTIuOTJMNS45MiAxOUg1di0uOTJsOS4wNi05LjA2TTE3LjY2IDNjLS4yNSAwLS41MS4xLS43LjI5bC0xLjgzIDEuODMgMy43NSAzLjc1IDEuODMtMS44M2MuMzktLjM5LjM5LTEuMDIgMC0xLjQxbC0yLjM0LTIuMzRjLS4yLS4yLS40NS0uMjktLjcxLS4yOXptLTMuNiAzLjE5TDMgMTcuMjVWMjFoMy43NUwxNy44MSA5Ljk0bC0zLjc1LTMuNzV6Ii8+PC9zdmc+YDsKY29uc3QgQUREX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTkgMTNoLTZ2NmgtMnYtNkg1di0yaDZWNWgydjZoNnYyeiIvPjwvc3ZnPmA7CmNvbnN0IENIRUNLX0JPWF9VTkNIRUNLRURfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE5IDV2MTRINVY1aDE0bTAtMkg1Yy0xLjEgMC0yIC45LTIgMnYxNGMwIDEuMS45IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjVjMC0xLjEtLjktMi0yLTJ6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tfQk9YX0NIRUNLRURfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE5IDNINWMtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDVWNWgxNHYxNHpNMTcuOTkgOWwtMS40MS0xLjQyLTYuNTkgNi41OS0yLjU4LTIuNTctMS40MiAxLjQxIDQgMy45OXoiLz48L3N2Zz5gOwpjb25zdCBTSURFQkFSX0hUTUwgPSBodG1sYAo8ZGl2IGlkPSJzaWRlYmFyIj4KICAgICR7SEVBREVSX0hUTUx9CiAgICA8YSBpZD0ic2lkZWJhci1hYm91dCIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0IiBocmVmPSIjIj5BYm91dDwvYT4KICAgIDxkaXYgaWQ9InByb2ZpbGVzIj48L2Rpdj4KICAgIDxkaXYgaWQ9InNpZGViYXItYW5hbHl0aWNzIj48L2Rpdj4KICAgIDxkaXYgaWQ9InNjcmlwdHMiPjwvZGl2Pgo8L2Rpdj4KYDsKY29uc3QgU0lERUJBUl9DU1MgPSBjc3NgCgojc2lkZWJhciB7CiAgICBtYXJnaW4tbGVmdDogMXJlbTsKICAgIGhlaWdodDogMTAwdmg7CiAgICBtaW4td2lkdGg6IDE1cmVtOwp9Cgojc2lkZWJhci1hYm91dCB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZCB7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMnJlbTsKICAgIGdyaWQtZ2FwOiAxcHg7CiAgICBtYXJnaW4tbGVmdDogMXB4OwogICAgbWFyZ2luLXRvcDogMXJlbTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkLW5ldyB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIG1pbi13aWR0aDogOHJlbTsKfQoKI3NpZGViYXIgYnV0dG9uIHsKICAgIGdyaWQtY29sdW1uOiAxOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQgLmhpbnQgewogICAgZ3JpZC1jb2x1bW46IDE7IAogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9Cgojc2NyaXB0cy1zY3JvbGxlciB7CiAgICBoZWlnaHQ6IGNhbGMoMTAwdmggLSAyOHJlbSk7Cn0KCiNzaWRlYmFyIC5leHRyYS10b3AtbWFyZ2luIHsKICAgIG1hcmdpbi10b3A6IDFyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRTaWRlYmFyKGRvY3VtZW50LCB2bTIsIGRhdGE0KSB7CiAgICBjb25zdCB1cGRhdGVIZWFkZXIgPSBpbml0SGVhZGVyKGRvY3VtZW50LCB2bTIsIGRhdGE0KTsKICAgIGNvbnN0IGFib3V0QW5jaG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZGViYXItYWJvdXQnKTsKICAgIGNvbnN0IHByb2ZpbGVzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGVzJyk7CiAgICBjb25zdCBhbmFseXRpY3NEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2lkZWJhci1hbmFseXRpY3MnKTsKICAgIGNvbnN0IHNjcmlwdHNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NyaXB0cycpOwogICAgYWJvdXRBbmNob3Iub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTIuc2hvd0Fib3V0KCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgdXBkYXRlSGVhZGVyKCk7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoUFJPRklMRVNfSFRNTCh2bTIpLCBwcm9maWxlc0Rpdik7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoQU5BTFlUSUNTX0hUTUwodm0yKSwgYW5hbHl0aWNzRGl2KTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihTQ1JJUFRTX0hUTUwodm0yKSwgc2NyaXB0c0Rpdik7CiAgICB9Owp9CmNvbnN0IFBST0ZJTEVTX0hUTUwgPSAodm0zKT0+aHRtbGAKICAgIDxkaXYgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij5Qcm9maWxlczwvZGl2PgogICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQiPgogICAgICAgICR7dm0zLnByb2ZpbGVzLm1hcCgocHJvZmlsZSk9Pmh0bWxgPGJ1dHRvbiAKICAgICAgICAgICAgY2xhc3M9IiR7cHJvZmlsZS5pZCA9PT0gdm0zLnNlbGVjdGVkUHJvZmlsZUlkID8gJ3NlbGVjdGVkJyA6ICcnfSIgCiAgICAgICAgICAgIEBjbGljaz0keygpPT57CiAgICAgICAgICAgIHZtMy5zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGUuaWQ7CiAgICAgICAgfX0KICAgICAgICAgICAgP2Rpc2FibGVkPSIke3ZtMy5wcm9maWxlRm9ybS5zaG93aW5nfSI+JHtwcm9maWxlLnRleHR9PC9idXR0b24+CiAgICAgICAgJHtwcm9maWxlLmlkID09PSB2bTMuc2VsZWN0ZWRQcm9maWxlSWQgPyBodG1sYCR7YWN0aW9uSWNvbihFRElUX0lDT04sIHsKICAgICAgICAgICAgb25jbGljazogKCk9PnZtMy5lZGl0UHJvZmlsZShwcm9maWxlLmlkKQogICAgICAgIH0pfWAgOiAnJ31gCiAgICApfQogICAgICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkLW5ldyI+JHthY3Rpb25JY29uKEFERF9JQ09OLCB7CiAgICAgICAgdGV4dDogJ05ldycsCiAgICAgICAgb25jbGljazogKCk9PnZtMy5uZXdQcm9maWxlKCkKICAgIH0pfTwvZGl2PgogICAgPC9kaXY+CmAKOwpjb25zdCBBTkFMWVRJQ1NfSFRNTCA9ICh2bTQpPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQgZXh0cmEtdG9wLW1hcmdpbiI+QW5hbHl0aWNzPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgJHt2bTQuYW5hbHl0aWNzLm1hcCgoYW5hbHl0aWMpPT5odG1sYDxidXR0b24KICAgICAgICAgICAgICAgIGNsYXNzPSIke3ZtNC5zZWxlY3RlZEFuYWx5dGljSWQgPT09IGFuYWx5dGljLmlkID8gJ3NlbGVjdGVkJyA6ICcnfSIgCiAgICAgICAgICAgICAgICBAY2xpY2s9JHsoKT0+dm00LnNob3dBbmFseXRpYyhhbmFseXRpYy5pZCkKICAgICAgICB9IAogICAgICAgICAgICAgICAgP2Rpc2FibGVkPSIke3ZtNC5wcm9maWxlRm9ybS5zaG93aW5nfSI+JHthbmFseXRpYy50ZXh0fTwvYnV0dG9uPgogICAgICAgIGAKICAgICl9CiAgICA8L2Rpdj4KYAo7CmNvbnN0IFNDUklQVFNfSFRNTCA9ICh2bTUpPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQgZXh0cmEtdG9wLW1hcmdpbiI+U2NyaXB0czwvZGl2PgogICAgPGRpdiBpZD0ic2NyaXB0cy1zY3JvbGxlciIgY2xhc3M9ImhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwiPgogICAgICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAgICAgJHt2bTUuc2NyaXB0cy5tYXAoKHNjcmlwdCk9Pmh0bWxgPGJ1dHRvbgogICAgICAgICAgICAgICAgICAgIGNsYXNzPSIke3ZtNS5zZWxlY3RlZFNjcmlwdElkcy5oYXMoc2NyaXB0LmlkKSA/ICdzZWxlY3RlZCcgOiAnJ30iIAogICAgICAgICAgICAgICAgICAgIEBjbGljaz0keyhlKT0+aGFuZGxlU2NyaXB0Q2xpY2soZSwgc2NyaXB0LmlkLCB2bTUpCiAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICA/ZGlzYWJsZWQ9IiR7dm01LnByb2ZpbGVGb3JtLnNob3dpbmd9Ij4ke3NjcmlwdC50ZXh0fTwvYnV0dG9uPgogICAgICAgICAgICBgCiAgICApfQogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FwdGlvbiBtZWRpdW0tZW1waGFzaXMtdGV4dCBoaW50Ij4ke2NvbXB1dGVNdWx0aXNlbGVjdEtleUNoYXIoKX0tY2xpY2sgdG8gbXVsdGlzZWxlY3Q8L2Rpdj4KICAgIDwvZGl2PgpgCjsKZnVuY3Rpb24gY29tcHV0ZU11bHRpc2VsZWN0S2V5Q2hhcigpIHsKICAgIHJldHVybiBpc01hY2ludG9zaCgpID8gJ+KMmCcgOiAnY3RybCc7Cn0KZnVuY3Rpb24gaXNNYWNpbnRvc2goKSB7CiAgICByZXR1cm4gbmF2aWdhdG9yLnBsYXRmb3JtLmluZGV4T2YoJ01hYycpID4gLTE7Cn0KZnVuY3Rpb24gaGFuZGxlU2NyaXB0Q2xpY2soZSwgc2NyaXB0SWQsIHZtNikgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgY29uc3QgbmV3U2NyaXB0SWRzID0gbmV3IFNldChbCiAgICAgICAgc2NyaXB0SWQKICAgIF0pOwogICAgY29uc3QgbXVsdGkgPSBpc01hY2ludG9zaCgpID8gZS5tZXRhS2V5IDogZS5jdHJsS2V5OwogICAgdm02LnNlbGVjdGVkU2NyaXB0SWRzID0gbXVsdGkgPyB2bTYuc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdElkKSA/IHNldFN1YnRyYWN0KHZtNi5zZWxlY3RlZFNjcmlwdElkcywgbmV3U2NyaXB0SWRzKSA6IHNldFVuaW9uKHZtNi5zZWxlY3RlZFNjcmlwdElkcywgbmV3U2NyaXB0SWRzKSA6IG5ld1NjcmlwdElkczsKfQpjbGFzcyBBcHBDb25zdGFudHMgewogICAgc3RhdGljIFdFQlNPQ0tFVF9QSU5HX0lOVEVSVkFMX1NFQ09ORFMgPSAxMDsKICAgIHN0YXRpYyBJTkFDVElWRV9UQUlMX1NFQ09ORFMgPSA1Owp9CmNsYXNzIFRhaWxDb250cm9sbGVyIHsKICAgIGNhbGxiYWNrczsKICAgIHJlY29yZHMgPSBuZXcgTWFwKCk7CiAgICB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzOwogICAgaW5hY3RpdmVUYWlsU2Vjb25kczsKICAgIHRhaWxPcHRpb25zID0gewogICAgICAgIGZpbHRlcnM6IFtdCiAgICB9OwogICAgb25saW5lOwogICAgY29uc3RydWN0b3IoY2FsbGJhY2tzLCBvcHRzKXsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICB0aGlzLndlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgPSBvcHRzLndlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHM7CiAgICAgICAgdGhpcy5pbmFjdGl2ZVRhaWxTZWNvbmRzID0gb3B0cy5pbmFjdGl2ZVRhaWxTZWNvbmRzOwogICAgICAgIGNvbnN0IG5hdmlnYXRvckFzQW55ID0gd2luZG93Lm5hdmlnYXRvcjsKICAgICAgICBpZiAodHlwZW9mIG5hdmlnYXRvckFzQW55Lm9uTGluZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgIHRoaXMuc2V0T25saW5lKG5hdmlnYXRvckFzQW55Lm9uTGluZSk7CiAgICAgICAgfQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCAoKT0+dGhpcy5zZXRPbmxpbmUodHJ1ZSkKICAgICAgICApOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvZmZsaW5lJywgKCk9PnRoaXMuc2V0T25saW5lKGZhbHNlKQogICAgICAgICk7CiAgICB9CiAgICBzZXRUYWlsT3B0aW9ucyh0YWlsT3B0aW9ucykgewogICAgICAgIGNvbnNvbGUubG9nKGBUYWlsQ29udHJvbGxlci5zZXRUYWlsT3B0aW9ucyAke0pTT04uc3RyaW5naWZ5KHRhaWxPcHRpb25zKX1gKTsKICAgICAgICB0aGlzLnRhaWxPcHRpb25zID0gdGFpbE9wdGlvbnM7CiAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5yZWNvcmRzLnZhbHVlcygpKXsKICAgICAgICAgICAgaWYgKHJlY29yZC5jb25uZWN0aW9uKSB7CiAgICAgICAgICAgICAgICByZWNvcmQuY29ubmVjdGlvbi5zZXRPcHRpb25zKHRhaWxPcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHNldFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4sIHNjcmlwdElkcykgewogICAgICAgIGNvbnN0IHN0b3BLZXlzID0gc2V0U3VidHJhY3QodGhpcy5jb21wdXRlU3RhcnRpbmdPclN0YXJ0ZWRUYWlsS2V5cygpLCBuZXcgU2V0KFsKICAgICAgICAgICAgLi4uc2NyaXB0SWRzCiAgICAgICAgXS5tYXAoKHYpPT5wYWNrVGFpbEtleShhY2NvdW50SWQsIHYpCiAgICAgICAgKSkpOwogICAgICAgIGZvciAoY29uc3Qgc3RvcEtleSBvZiBzdG9wS2V5cyl7CiAgICAgICAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQoc3RvcEtleSk7CiAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdpbmFjdGl2ZSc7CiAgICAgICAgICAgIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScgJiYgcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lICYmIERhdGUubm93KCkgLSByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPj0gdGhpcy5pbmFjdGl2ZVRhaWxTZWNvbmRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gJ3N0b3BwaW5nJzsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3RvcHBpbmcgJHtyZWNvcmQuc2NyaXB0SWR9LCBpbmFjdGl2ZSBmb3IgJHtEYXRlLm5vdygpIC0gcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lfW1zYCk7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24/LmNsb3NlKDEwMDAsICdubyBsb25nZXIgaW50ZXJlc3RlZCcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkcy5kZWxldGUocmVjb3JkLnRhaWxLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0aGlzLmluYWN0aXZlVGFpbFNlY29uZHMgKiAxMDAwKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0b3BLZXlzLnNpemUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKTsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBzY3JpcHRJZCBvZiBzY3JpcHRJZHMpewogICAgICAgICAgICBjb25zdCB0YWlsS2V5ID0gcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nUmVjb3JkID0gdGhpcy5yZWNvcmRzLmdldCh0YWlsS2V5KTsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkKSB7CiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdSZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUmV2aXZpbmcgaW5hY3RpdmUgJHtzY3JpcHRJZH1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGV4aXN0aW5nUmVjb3JkLnN0YXRlID0gJ3N0YXJ0ZWQnOwogICAgICAgICAgICAgICAgZXhpc3RpbmdSZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCByZWNvcmQgPSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGU6ICdzdGFydGluZycsCiAgICAgICAgICAgICAgICAgICAgdGFpbEtleSwKICAgICAgICAgICAgICAgICAgICBhcGlUb2tlbiwKICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQsCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0SWQsCiAgICAgICAgICAgICAgICAgICAgcmV0cnlDb3VudEFmdGVyQ2xvc2U6IDAKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLnJlY29yZHMuc2V0KHRhaWxLZXksIHJlY29yZCk7CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKTsKICAgICAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdzdGFydGVkJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRpc3BhdGNoVGFpbHNDaGFuZ2VkKCk7CiAgICAgICAgfQogICAgfQogICAgZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKSB7CiAgICAgICAgY29uc3QgdGFpbEtleXMgPSBuZXcgU2V0KFsKICAgICAgICAgICAgLi4udGhpcy5yZWNvcmRzLnZhbHVlcygpCiAgICAgICAgXS5maWx0ZXIoKHYpPT52LnN0YXRlID09PSAnc3RhcnRlZCcKICAgICAgICApLm1hcCgodik9PnYudGFpbEtleQogICAgICAgICkpOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbHNDaGFuZ2VkKHRhaWxLZXlzKTsKICAgIH0KICAgIGNvbXB1dGVTdGFydGluZ09yU3RhcnRlZFRhaWxLZXlzKCkgewogICAgICAgIHJldHVybiBuZXcgU2V0KFsKICAgICAgICAgICAgLi4udGhpcy5yZWNvcmRzLnZhbHVlcygpCiAgICAgICAgXS5maWx0ZXIoKHYpPT52LnN0YXRlID09PSAnc3RhcnRpbmcnIHx8IHYuc3RhdGUgPT09ICdzdGFydGVkJwogICAgICAgICkubWFwKCh2KT0+di50YWlsS2V5CiAgICAgICAgKSk7CiAgICB9CiAgICBzZXRPbmxpbmUob25saW5lKSB7CiAgICAgICAgaWYgKG9ubGluZSA9PT0gdGhpcy5vbmxpbmUpIHJldHVybjsKICAgICAgICBjb25zdCBvbGRPbmxpbmUgPSB0aGlzLm9ubGluZTsKICAgICAgICB0aGlzLm9ubGluZSA9IG9ubGluZTsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vbk5ldHdvcmtTdGF0dXNDaGFuZ2VkKG9ubGluZSk7CiAgICAgICAgaWYgKHR5cGVvZiBvbGRPbmxpbmUgPT09ICdib29sZWFuJykgewogICAgICAgICAgICBpZiAob25saW5lKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiB0aGlzLnJlY29yZHMudmFsdWVzKCkpewogICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdzdGFydGVkJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIHNjcmlwdElkICB9ID0gcmVjb3JkOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKS5jYXRjaCgoZSk9PnRoaXMuY2FsbGJhY2tzLm9uVGFpbEZhaWxlZFRvU3RhcnQoYWNjb3VudElkLCBzY3JpcHRJZCwgJ3Jlc3RhcnQtYWZ0ZXItY29taW5nLW9ubGluZScsIGUpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5yZWNvcmRzLnZhbHVlcygpKXsKICAgICAgICAgICAgICAgICAgICByZWNvcmQuY29ubmVjdGlvbj8uY2xvc2UoMTAwMCwgJ29mZmxpbmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKSB7CiAgICAgICAgY29uc3QgYWxsb3dlZFRvU3RhcnQgPSByZWNvcmQuc3RhdGUgPT09ICdzdGFydGluZycgfHwgcmVjb3JkLnN0YXRlID09PSAnc3RhcnRlZCc7CiAgICAgICAgaWYgKCFhbGxvd2VkVG9TdGFydCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgc2NyaXB0SWQgIH0gPSB1bnBhY2tUYWlsS2V5KHJlY29yZC50YWlsS2V5KTsKICAgICAgICBjb25zdCB7IGFwaVRva2VuICB9ID0gcmVjb3JkOwogICAgICAgIGlmICghcmVjb3JkLnRhaWwgfHwgRGF0ZS5ub3coKSA+IG5ldyBEYXRlKHJlY29yZC50YWlsLmV4cGlyZXNfYXQpLmdldFRpbWUoKSAtIDEwMDAgKiA2MCAqIDUpIHsKICAgICAgICAgICAgY29uc3QgdGFpbENyZWF0aW5nVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgICAgICBjb25zdCB0YWlsID0gYXdhaXQgY3JlYXRlVGFpbChhY2NvdW50SWQsIHNjcmlwdElkLCBhcGlUb2tlbik7CiAgICAgICAgICAgIHJlY29yZC50YWlsID0gdGFpbDsKICAgICAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpIC0gdGFpbENyZWF0aW5nVGltZSwgdGFpbCk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScpIHJldHVybjsKICAgICAgICBjb25zdCB7IGNhbGxiYWNrcyAsIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGRpcyA9IHRoaXM7CiAgICAgICAgY29uc3Qgb3BlbmluZ1RpbWUgPSBEYXRlLm5vdygpOwogICAgICAgIGNvbnN0IHRhaWxDb25uZWN0aW9uQ2FsbGJhY2tzID0gewogICAgICAgICAgICBvbk9wZW4gKF9jbiwgdGltZVN0YW1wKSB7CiAgICAgICAgICAgICAgICByZWNvcmQucmV0cnlDb3VudEFmdGVyQ2xvc2UgPSAwOwogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25PcGVuKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgRGF0ZS5ub3coKSAtIG9wZW5pbmdUaW1lKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25DbG9zZSAoX2NuLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uQ2xvc2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgICAgICAgICAgICAgIHJlY29yZC5jbG9zZVRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnICYmIGRpcy5vbmxpbmUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLnJldHJ5Q291bnRBZnRlckNsb3NlKys7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVsYXlTZWNvbmRzID0gTWF0aC5taW4ocmVjb3JkLnJldHJ5Q291bnRBZnRlckNsb3NlICogNSwgNjApOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBXaWxsIGF0dGVtcHQgdG8gcmVzdGFydCAke3NjcmlwdElkfSBpbiAke2RlbGF5U2Vjb25kc30gc2Vjb25kc2ApOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXN5bmMgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdzdGFydGVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGlzLnN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIGRlbGF5U2Vjb25kcyAqIDEwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBvbkVycm9yIChfY24sIHRpbWVTdGFtcCwgZXJyb3JJbmZvKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsTWVzc2FnZSAoX2NuLCB0aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgIT09ICdzdGFydGVkJykgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVW5wYXJzZWRNZXNzYWdlIChfY24sIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29uVW5wYXJzZWRNZXNzYWdlJywgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJlY29yZC5jb25uZWN0aW9uID0gbmV3IFRhaWxDb25uZWN0aW9uKHJlY29yZC50YWlsLnVybCwgdGFpbENvbm5lY3Rpb25DYWxsYmFja3MsIHsKICAgICAgICAgICAgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcwogICAgICAgIH0pLnNldE9wdGlvbnModGhpcy50YWlsT3B0aW9ucyk7CiAgICB9Cn0KZnVuY3Rpb24gdW5wYWNrVGFpbEtleSh0YWlsS2V5KSB7CiAgICBjb25zdCBtID0gL14oW15ccy1dKyktKFteXHNdKykkLy5leGVjKHRhaWxLZXkpOwogICAgaWYgKCFtKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsS2V5OiAke3RhaWxLZXl9YCk7CiAgICByZXR1cm4gewogICAgICAgIGFjY291bnRJZDogbVsxXSwKICAgICAgICBzY3JpcHRJZDogbVsyXQogICAgfTsKfQpmdW5jdGlvbiBwYWNrVGFpbEtleShhY2NvdW50SWQsIHNjcmlwdElkKSB7CiAgICByZXR1cm4gYCR7YWNjb3VudElkfS0ke3NjcmlwdElkfWA7Cn0KY2xhc3MgU3dpdGNoYWJsZVRhaWxDb250cm9sbGVyQ2FsbGJhY2tzIHsKICAgIGNhbGxiYWNrczsKICAgIGVuYWJsZWRGbjsKICAgIGNvbnN0cnVjdG9yKGNhbGxiYWNrcywgZW5hYmxlZEZuKXsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICB0aGlzLmVuYWJsZWRGbiA9IGVuYWJsZWRGbjsKICAgIH0KICAgIG9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKTsKICAgIH0KICAgIG9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIHRvb2tNaWxsaXMpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIHRvb2tNaWxsaXMpOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbkNsb3NlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25DbG9zZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgIH0KICAgIG9uVGFpbHNDaGFuZ2VkKHRhaWxzKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsc0NoYW5nZWQodGFpbHMpOwogICAgfQogICAgb25OZXR3b3JrU3RhdHVzQ2hhbmdlZChvbmxpbmUpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vbk5ldHdvcmtTdGF0dXNDaGFuZ2VkKG9ubGluZSk7CiAgICB9CiAgICBvblRhaWxGYWlsZWRUb1N0YXJ0KGFjY291bnRJZCwgc2NyaXB0SWQsIHRyaWdnZXIsIGVycm9yKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsRmFpbGVkVG9TdGFydChhY2NvdW50SWQsIHNjcmlwdElkLCB0cmlnZ2VyLCBlcnJvcik7CiAgICB9Cn0KY2xhc3MgRGVtb01vZGUgewogICAgc3RhdGljIHByb2ZpbGVzID0gWwogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdwcm9maWxlMScsCiAgICAgICAgICAgIHRleHQ6ICdjb3JwLXByb2ZpbGUnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAncHJvZmlsZTInLAogICAgICAgICAgICB0ZXh0OiAncGVycy1wcm9maWxlJwogICAgICAgIH0sIAogICAgXTsKICAgIHN0YXRpYyBzZWxlY3RlZFByb2ZpbGVJZCA9ICdwcm9maWxlMSc7CiAgICBzdGF0aWMgc2V0U2VsZWN0ZWRQcm9maWxlSWQoX3ZhbHVlKSB7fQogICAgc3RhdGljIHNjcmlwdHMgPSBbCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDEnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMS1kZXYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MicsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIxLXByb2QnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MycsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIyLWRldicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ0JywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItYmV0YScKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ1JywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItcHJvZCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ2JywKICAgICAgICAgICAgdGV4dDogJ2R1cmFibGUtb2JqZWN0LWRlbW8nCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0NycsCiAgICAgICAgICAgIHRleHQ6ICdzZWNyZXQtYXBwJwogICAgICAgIH0sIAogICAgXTsKICAgIHN0YXRpYyBzZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgICdzY3JpcHQ3JywKICAgICAgICAnc2NyaXB0NCcKICAgIF0pOwogICAgc3RhdGljIHNldFNlbGVjdGVkU2NyaXB0SWRzKF9zY3JpcHRJZHMpIHt9CiAgICBzdGF0aWMgdGFpbHMgPSBuZXcgU2V0KCk7CiAgICBzdGF0aWMgbG9nRmFrZU91dHB1dChjYWxsYmFja3MpIHsKICAgICAgICBjb25zdCBhY2NvdW50SWQgPSAnMTVhN2ZhM2EzNzI1NGZlNGE3Y2FkZDFiYjI3NjI4NzknOwogICAgICAgIGNvbnN0IHNjcmlwdElkID0gJ3NlY3JldC1hcHAnOwogICAgICAgIGNhbGxiYWNrcy5vblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKTsKICAgICAgICBjb25zdCB0YWlsID0gewogICAgICAgICAgICBpZDogJ2RiMTllYjhiZTlmNDQ0M2FhYjkxYTkwNDJjMGQzNTE3JywKICAgICAgICAgICAgdXJsOiAnd3NzOi8vdGFpbC5kZXZlbG9wZXJzLndvcmtlcnMuZGV2L2RiMTllYjhiZTlmNDQ0M2FhYjkxYTkwNDJjMGQzNTE3JywKICAgICAgICAgICAgJ2V4cGlyZXNfYXQnOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgICAgICB9OwogICAgICAgIGNhbGxiYWNrcy5vblRhaWxDcmVhdGVkKGFjY291bnRJZCwgc2NyaXB0SWQsIDE1NSwgdGFpbCk7CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbHNDaGFuZ2VkKG5ldyBTZXQoWwogICAgICAgICAgICBwYWNrVGFpbEtleShhY2NvdW50SWQsIHNjcmlwdElkKQogICAgICAgIF0pKTsKICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgNDIpOwogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCAyOyBpKyspewogICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgY29tcHV0ZUZha2VSZXF1ZXN0KCkpOwogICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgY29tcHV0ZUZha2VEb1JlcXVlc3QoKSk7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZVJlcXVlc3RXaXRoTG9ncygpKTsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlUmVxdWVzdEV4Y2VlZGluZ1RpbWVMaW1pdCgpKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgVVNFUl9BR0VOVCA9ICdNb3ppbGxhLzUuMCAoTWFjaW50b3NoOyBJbnRlbCBNYWMgT1MgWCAxMC4xNTsgcnY6OTEuMCkgR2Vja28vMjAxMDAxMDEgRmlyZWZveC85MS4wJzsKZnVuY3Rpb24gY29tcHV0ZUZha2VSZXF1ZXN0KCkgewogICAgY29uc3QgcnQgPSB7CiAgICAgICAgZXZlbnQ6IHsKICAgICAgICAgICAgcmVxdWVzdDogewogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9leGFtcGxlLmNvbS9lbmRwb2ludCcsCiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgICAgICdjZi1jb25uZWN0aW5nLWlwJzogJzIwMy4wLjExMy4xMicsCiAgICAgICAgICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiBVU0VSX0FHRU5UCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2Y6IHsKICAgICAgICAgICAgICAgICAgICBjb2xvOiAnREZXJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsb2dzOiBbXSwKICAgICAgICBleGNlcHRpb25zOiBbXSwKICAgICAgICBldmVudFRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICBvdXRjb21lOiAnb2snCiAgICB9OwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVGYWtlRG9SZXF1ZXN0KCkgewogICAgY29uc3QgcnQgPSB7CiAgICAgICAgZXZlbnQ6IHsKICAgICAgICAgICAgcmVxdWVzdDogewogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9mYWtlLWhvc3QvcHV0JywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BVVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7fQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsb2dzOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnbG9nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnbG9ncHJvcHM6JywKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG86ICdFV1InLAogICAgICAgICAgICAgICAgICAgICAgICBkdXJhYmxlT2JqZWN0Q2xhc3M6ICdMb2dnZXJETycsCiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGVPYmplY3RJZDogJzUzOGZjN2NlNTViMTRlNTNiNmI4NTUyYmVmZWI5YWY0JywKICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZU9iamVjdE5hbWU6ICdsb2cxJwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwgCiAgICAgICAgXSwKICAgICAgICBleGNlcHRpb25zOiBbXSwKICAgICAgICBldmVudFRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICBvdXRjb21lOiAnb2snCiAgICB9OwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVGYWtlUmVxdWVzdFdpdGhMb2dzKCkgewogICAgY29uc3QgcnQgPSB7CiAgICAgICAgZXZlbnQ6IHsKICAgICAgICAgICAgcmVxdWVzdDogewogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9teS13b3JrZXIuc3ViZG9tYWluLndvcmtlcnMuZGV2L3Rlc3Q/bG9nPXRydWUnLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnY2YtY29ubmVjdGluZy1pcCc6ICcyMDMuMC4xMTMuMTInLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVVNFUl9BR0VOVAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNmOiB7CiAgICAgICAgICAgICAgICAgICAgY29sbzogJ0RGVycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnZXJyb3InLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2luZm8nLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ3dhcm5pbmcnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2RlYnVnJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwgCiAgICAgICAgXSwKICAgICAgICBleGNlcHRpb25zOiBbXSwKICAgICAgICBldmVudFRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICBvdXRjb21lOiAnb2snCiAgICB9OwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVGYWtlUmVxdWVzdEV4Y2VlZGluZ1RpbWVMaW1pdCgpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vbXktd29ya2VyLnN1YmRvbWFpbi53b3JrZXJzLmRldi9jb21wdXRlLWRpZ2l0cy1vZi1waScsCiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgICAgICdjZi1jb25uZWN0aW5nLWlwJzogJzIwMy4wLjExMy4xMicsCiAgICAgICAgICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiBVU0VSX0FHRU5UCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2Y6IHsKICAgICAgICAgICAgICAgICAgICBjb2xvOiAnREZXJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsb2dzOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnbG9nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnYnVybmluZyBjcHUnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lOiAnRXJyb3InLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogJ1dvcmtlciBleGNlZWRlZCBDUFUgdGltZSBsaW1pdC4nCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ2V4Y2VlZGVkQ3B1JwogICAgfTsKICAgIHJldHVybiBydDsKfQpjbGFzcyBRcHNDb250cm9sbGVyIHsKICAgIHNvcnRlZEV2ZW50VGltZXMgPSBbXTsKICAgIGNhbGxiYWNrczsKICAgIG47CiAgICBfcXBzID0gMDsKICAgIGdldCBxcHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3FwczsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG4sIGNhbGxiYWNrcyl7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5uID0gbjsKICAgIH0KICAgIGFkZEV2ZW50KGV2ZW50VGltZSkgewogICAgICAgIGNvbnN0IHFwcyA9IGNvbXB1dGVRcHModGhpcy5uLCB0aGlzLnNvcnRlZEV2ZW50VGltZXMsIGV2ZW50VGltZSk7CiAgICAgICAgaWYgKHFwcyA9PT0gdGhpcy5fcXBzKSByZXR1cm47CiAgICAgICAgdGhpcy5fcXBzID0gcXBzOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uUXBzQ2hhbmdlZChxcHMpOwogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVRcHMobiwgc29ydGVkRXZlbnRUaW1lcywgZXZlbnRUaW1lKSB7CiAgICBhZGQoZXZlbnRUaW1lLCBzb3J0ZWRFdmVudFRpbWVzKTsKICAgIHdoaWxlKHNvcnRlZEV2ZW50VGltZXMubGVuZ3RoID4gbil7CiAgICAgICAgc29ydGVkRXZlbnRUaW1lcy5zaGlmdCgpOwogICAgfQogICAgY29uc3QgbnVtID0gc29ydGVkRXZlbnRUaW1lcy5sZW5ndGg7CiAgICBpZiAobnVtIDwgMikgcmV0dXJuIDA7CiAgICBjb25zdCB0aW1lRGlmZlNlY29uZHMgPSAoc29ydGVkRXZlbnRUaW1lc1tzb3J0ZWRFdmVudFRpbWVzLmxlbmd0aCAtIDFdIC0gc29ydGVkRXZlbnRUaW1lc1swXSkgLyAxMDAwOwogICAgcmV0dXJuIChudW0gLSAxKSAvIHRpbWVEaWZmU2Vjb25kczsKfQpmdW5jdGlvbiBhZGQoZWwsIGFycikgewogICAgYXJyLnNwbGljZShmaW5kTG9jKGVsLCBhcnIpICsgMSwgMCwgZWwpOwogICAgcmV0dXJuIGFycjsKfQpmdW5jdGlvbiBmaW5kTG9jKGVsLCBhcnIsIHN0LCBlbikgewogICAgc3QgPSBzdCB8fCAwOwogICAgZW4gPSBlbiB8fCBhcnIubGVuZ3RoOwogICAgZm9yKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKGFycltpXSA+IGVsKSB7CiAgICAgICAgICAgIHJldHVybiBpIC0gMTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gZW47Cn0KZnVuY3Rpb24gY2hlY2tFcXVhbChuYW1lLCB2YWx1ZSwgZXhwZWN0ZWQpIHsKICAgIGlmICh2YWx1ZSAhPT0gZXhwZWN0ZWQpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IGV4cGVjdGVkICR7ZXhwZWN0ZWR9LCBmb3VuZCAke3ZhbHVlfWApOwp9CmZ1bmN0aW9uIGNoZWNrTWF0Y2hlcyhuYW1lLCB2YWx1ZSwgcGF0dGVybikgewogICAgaWYgKCFwYXR0ZXJuLnRlc3QodmFsdWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfWApOwogICAgcmV0dXJuIHZhbHVlOwp9CmNsYXNzIEdyYXBocWxRdWVyeSB7CiAgICBfcGFyZW50OwogICAgX25vZGVzOwogICAgX25vZGVPcmRlcjsKICAgIF9hcmdzOwogICAgX2FyZ09yZGVyOwogICAgY29uc3RydWN0b3IocGFyZW50LCBub2Rlcywgbm9kZU9yZGVyLCBhcmdzLCBhcmdPcmRlcil7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gcGFyZW50OwogICAgICAgIHRoaXMuX25vZGVzID0gbm9kZXM7CiAgICAgICAgdGhpcy5fbm9kZU9yZGVyID0gbm9kZU9yZGVyOwogICAgICAgIHRoaXMuX2FyZ3MgPSBhcmdzOwogICAgICAgIHRoaXMuX2FyZ09yZGVyID0gYXJnT3JkZXI7CiAgICB9CiAgICBzdGF0aWMgY3JlYXRlKCkgewogICAgICAgIHJldHVybiBuZXcgR3JhcGhxbFF1ZXJ5KFtdLCBuZXcgTWFwKCksIFtdLCBuZXcgTWFwKCksIFtdKTsKICAgIH0KICAgIHNjYWxhcihuYW1lKSB7CiAgICAgICAgdGhpcy5hZGQobmFtZSwgTm9kZUtpbmQuU2NhbGFyKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIG9iamVjdChuYW1lKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuYWRkKG5hbWUsIE5vZGVLaW5kLk9iamVjdCk7CiAgICAgICAgY29uc3QgcnQgPSBuZXcgR3JhcGhxbFF1ZXJ5KFsKICAgICAgICAgICAgdGhpcwogICAgICAgIF0sIG5ldyBNYXAoKSwgW10sIG5ldyBNYXAoKSwgW10pOwogICAgICAgIG5vZGUucXVlcnkucHVzaChydCk7CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQogICAgb2JqZWN0UXVlcnkobmFtZSwgcXVlcnkyKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuYWRkKG5hbWUsIE5vZGVLaW5kLk9iamVjdCk7CiAgICAgICAgY29uc3QgcSA9IHF1ZXJ5Mi5jb3B5V2l0aFBhcmVudCh0aGlzKTsKICAgICAgICBjb25zdCBydCA9IHE7CiAgICAgICAgbm9kZS5xdWVyeS5wdXNoKHJ0KTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICBhcmdSYXcobmFtZSwgcmF3VmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgcmF3VmFsdWUpOwogICAgfQogICAgYXJnQm9vbGVhbihuYW1lLCB2YWx1ZSkgewogICAgICAgIHJldHVybiB0aGlzLmFkZEFyZyhuYW1lLCB2YWx1ZSA/ICd0cnVlJyA6ICdmYWxzZScpOwogICAgfQogICAgYXJnTG9uZyhuYW1lLCB2YWx1ZSkgewogICAgICAgIHJldHVybiB0aGlzLmFkZEFyZyhuYW1lLCBgJHt2YWx1ZX1gKTsKICAgIH0KICAgIGFyZ1N0cmluZyhuYW1lLCB2YWx1ZSkgewogICAgICAgIHJldHVybiB0aGlzLmFkZEFyZyhuYW1lLCBgIiR7dmFsdWUucmVwbGFjZUFsbCgnIicsICdcXCInKX0iYCk7CiAgICB9CiAgICBhcmdPYmplY3QobmFtZSwgZmllbGROYW1lLCBmaWVsZFZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkQXJnKG5hbWUsIGB7JHtmaWVsZE5hbWV9OiIke2ZpZWxkVmFsdWUucmVwbGFjZUFsbCgnIicsICdcXCInKX0ifWApOwogICAgfQogICAgYXJnVmFyaWFibGUobmFtZSwgdmFyaWFibGVOYW1lKSB7CiAgICAgICAgY2hlY2tNYXRjaGVzKCd2YXJpYWJsZU5hbWUnLCB2YXJpYWJsZU5hbWUsIC9eW2Etel0rJC8pOwogICAgICAgIHJldHVybiB0aGlzLmFkZEFyZyhuYW1lLCBgJCR7dmFyaWFibGVOYW1lfWApOwogICAgfQogICAgZW5kKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wYXJlbnQubGVuZ3RoID4gMCA/IHRoaXMuX3BhcmVudFswXSA6IHRoaXM7CiAgICB9CiAgICB0b3AoKSB7CiAgICAgICAgbGV0IHJ0ID0gdGhpczsKICAgICAgICB3aGlsZShydC5fcGFyZW50Lmxlbmd0aCA+IDApewogICAgICAgICAgICBydCA9IHJ0Ll9wYXJlbnRbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBydDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIGNvbnN0IGxpbmVzID0gW107CiAgICAgICAgbGluZXMucHVzaCgneycpOwogICAgICAgIHRoaXMud3JpdGUobGluZXMsIDEpOwogICAgICAgIGxpbmVzLnB1c2goJ30nKTsKICAgICAgICByZXR1cm4gbGluZXMuam9pbignXG4nKTsKICAgIH0KICAgIGFkZEFyZyhuYW1lLCB2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLl9hcmdzLmhhcyhuYW1lKSkgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgYXJnOiAke25hbWV9YCk7CiAgICAgICAgdGhpcy5fYXJnT3JkZXIucHVzaChuYW1lKTsKICAgICAgICB0aGlzLl9hcmdzLnNldChuYW1lLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICB3cml0ZShsaW5lcywgbGV2ZWwpIHsKICAgICAgICBjb25zdCBpbmRlbnQgPSAnICAnLnJlcGVhdChsZXZlbCk7CiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgdGhpcy5fbm9kZU9yZGVyKXsKICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGNoZWNrR2V0KCdfbm9kZXMnLCB0aGlzLl9ub2Rlcywga2V5KTsKICAgICAgICAgICAgaWYgKG5vZGUua2luZCA9PT0gTm9kZUtpbmQuU2NhbGFyKSB7CiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGAke2luZGVudH0ke2tleX1gKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmtpbmQgPT09IE5vZGVLaW5kLk9iamVjdCkgewogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5vZGUucXVlcnlbMF07CiAgICAgICAgICAgICAgICBsZXQgbGluZSA9IGAke2luZGVudH0ke2tleX1gOwogICAgICAgICAgICAgICAgaWYgKHEuX2FyZ09yZGVyLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBsaW5lICs9ICcoJzsKICAgICAgICAgICAgICAgICAgICBsZXQgaiA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBhcmdOYW1lIG9mIHEuX2FyZ09yZGVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGogPiAwKSBsaW5lICs9ICcsICc7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUgKz0gYCR7YXJnTmFtZX06ICR7Y2hlY2tHZXQoJ3EuX2FyZ3MnLCBxLl9hcmdzLCBhcmdOYW1lKX1gOwogICAgICAgICAgICAgICAgICAgICAgICBqKys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxpbmUgKz0gJyknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGluZSArPSAnIHsnOwogICAgICAgICAgICAgICAgbGluZXMucHVzaChsaW5lKTsKICAgICAgICAgICAgICAgIG5vZGUucXVlcnlbMF0ud3JpdGUobGluZXMsIGxldmVsICsgMSk7CiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGAke2luZGVudH19YCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEltcGxlbWVudCBub2RlIGtpbmQgJHtub2RlLmtpbmR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhZGQobmFtZSwga2luZCkgewogICAgICAgIGlmICh0aGlzLl9ub2Rlcy5oYXMobmFtZSkpIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIGZpZWxkOiAke25hbWV9YCk7CiAgICAgICAgY29uc3QgcnQgPSBuZXcgTm9kZTEoa2luZCk7CiAgICAgICAgdGhpcy5fbm9kZXMuc2V0KG5hbWUsIHJ0KTsKICAgICAgICB0aGlzLl9ub2RlT3JkZXIucHVzaChuYW1lKTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICBjb3B5V2l0aFBhcmVudChwYXJlbnQpIHsKICAgICAgICBjb25zdCBub2RlcyA9IG5ldyBNYXAoKTsKICAgICAgICBjb25zdCBub2RlT3JkZXIgPSBbCiAgICAgICAgICAgIC4uLnRoaXMuX25vZGVPcmRlcgogICAgICAgIF07CiAgICAgICAgY29uc3QgYXJncyA9IG5ldyBNYXAoKTsKICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0aGlzLl9hcmdzLmVudHJpZXMoKSl7CiAgICAgICAgICAgIGFyZ3Muc2V0KGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhcmdPcmRlciA9IFsKICAgICAgICAgICAgLi4udGhpcy5fYXJnT3JkZXIKICAgICAgICBdOwogICAgICAgIGNvbnN0IHJ0ID0gbmV3IEdyYXBocWxRdWVyeShbCiAgICAgICAgICAgIHBhcmVudAogICAgICAgIF0sIG5vZGVzLCBub2RlT3JkZXIsIGFyZ3MsIGFyZ09yZGVyKTsKICAgICAgICBmb3IgKGNvbnN0IFtrZXkxLCBub2RlXSBvZiB0aGlzLl9ub2Rlcy5lbnRyaWVzKCkpewogICAgICAgICAgICBjb25zdCBuZXdOb2RlID0gbmV3IE5vZGUxKG5vZGUua2luZCk7CiAgICAgICAgICAgIGlmIChub2RlLnF1ZXJ5Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld1F1ZXJ5ID0gbm9kZS5xdWVyeVswXS5jb3B5V2l0aFBhcmVudChydCk7CiAgICAgICAgICAgICAgICBuZXdOb2RlLnF1ZXJ5LnB1c2gobmV3UXVlcnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGVzLnNldChrZXkxLCBuZXdOb2RlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQp9CmZ1bmN0aW9uIGNoZWNrR2V0KG1hcE5hbWUsIG1hcCwga2V5KSB7CiAgICBjb25zdCBydCA9IG1hcC5nZXQoa2V5KTsKICAgIGlmICghcnQpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bWFwTmFtZX0ua2V5OiAke2tleX1gKTsKICAgIHJldHVybiBydDsKfQp2YXIgTm9kZUtpbmQ7CihmdW5jdGlvbihOb2RlS2luZDEpIHsKICAgIE5vZGVLaW5kMVtOb2RlS2luZDFbIlNjYWxhciJdID0gMV0gPSAiU2NhbGFyIjsKICAgIE5vZGVLaW5kMVtOb2RlS2luZDFbIk9iamVjdCJdID0gMl0gPSAiT2JqZWN0IjsKfSkoTm9kZUtpbmQgfHwgKE5vZGVLaW5kID0ge30pKTsKY2xhc3MgTm9kZTEgewogICAga2luZDsKICAgIHF1ZXJ5ID0gW107CiAgICBjb25zdHJ1Y3RvcihraW5kKXsKICAgICAgICB0aGlzLmtpbmQgPSBraW5kOwogICAgfQp9CmNsYXNzIENmR3FsQ2xpZW50IHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwogICAgcHJvZmlsZTsKICAgIGNvbnN0cnVjdG9yKHByb2ZpbGUpewogICAgICAgIHRoaXMucHJvZmlsZSA9IHByb2ZpbGU7CiAgICB9CiAgICBhc3luYyBnZXREdXJhYmxlT2JqZWN0UGVyaW9kaWNNZXRyaWNzQnlEYXRlKHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSkgewogICAgICAgIHJldHVybiBhd2FpdCBfZ2V0RHVyYWJsZU9iamVjdFBlcmlvZGljTWV0cmljc0J5RGF0ZSh0aGlzLnByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSk7CiAgICB9CiAgICBhc3luYyBnZXREdXJhYmxlT2JqZWN0U3RvcmFnZUJ5RGF0ZShzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgICAgICByZXR1cm4gYXdhaXQgX2dldER1cmFibGVPYmplY3RTdG9yYWdlQnlEYXRlKHRoaXMucHJvZmlsZSwgc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKTsKICAgIH0KICAgIGFzeW5jIGdldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZShzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgICAgICByZXR1cm4gYXdhaXQgX2dldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZSh0aGlzLnByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSk7CiAgICB9Cn0KYXN5bmMgZnVuY3Rpb24gcXVlcnkocHJvZmlsZSwgcXVlcnlGbiwgdmFyaWFibGVzKSB7CiAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgIGNvbnN0IHEgPSBHcmFwaHFsUXVlcnkuY3JlYXRlKCkuc2NhbGFyKCdjb3N0Jykub2JqZWN0KCd2aWV3ZXInKS5zY2FsYXIoJ2J1ZGdldCcpLm9iamVjdCgnYWNjb3VudHMnKS5hcmdPYmplY3QoJ2ZpbHRlcicsICdhY2NvdW50VGFnJywgYWNjb3VudElkKS5zY2FsYXIoJ2FjY291bnRUYWcnKTsKICAgIHF1ZXJ5Rm4ocSk7CiAgICBjb25zdCBxdWVyeTEgPSBxLnRvcCgpLnRvU3RyaW5nKCk7CiAgICBpZiAoQ2ZHcWxDbGllbnQuREVCVUcpIGNvbnNvbGUubG9nKHF1ZXJ5MSk7CiAgICBjb25zdCByZXFPYmogPSB7CiAgICAgICAgcXVlcnk6IHF1ZXJ5MSwKICAgICAgICB2YXJpYWJsZXMKICAgIH07CiAgICBjb25zdCBib2R5ID0gSlNPTi5zdHJpbmdpZnkocmVxT2JqKTsKICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgIGNvbnN0IHVybCA9IENmR3FsQ2xpZW50LlVSTF9UUkFOU0ZPUk1FUignaHR0cHM6Ly9hcGkuY2xvdWRmbGFyZS5jb20vY2xpZW50L3Y0L2dyYXBocWwnKTsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCwgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JywKICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YXBpVG9rZW59YAogICAgICAgIH0sCiAgICAgICAgYm9keQogICAgfSk7CiAgICBjb25zdCBmZXRjaE1pbGxpcyA9IERhdGUubm93KCkgLSBzdGFydDsKICAgIGlmIChDZkdxbENsaWVudC5ERUJVRykgY29uc29sZS5sb2cocmVzKTsKICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHRocm93IG5ldyBFcnJvcihgQmFkIHJlcy5zdGF0dXM6ICR7cmVzLnN0YXR1c30sIGV4cGVjdGVkIDIwMCwgdGV4dD0ke2F3YWl0IHJlcy50ZXh0KCl9YCk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlcy5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyk7CiAgICBpZiAoY29udGVudFR5cGUgIT09ICdhcHBsaWNhdGlvbi9qc29uJykgdGhyb3cgbmV3IEVycm9yKGBCYWQgcmVzLmNvbnRlbnRUeXBlOiAke2NvbnRlbnRUeXBlfSwgZXhwZWN0ZWQgYXBwbGljYXRpb24vanNvbiwgZm91bmQgJHtjb250ZW50VHlwZX0sIHRleHQ9JHthd2FpdCByZXMudGV4dCgpfWApOwogICAgY29uc3QgcmVzT2JqID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIHJlc09iai5mZXRjaE1pbGxpcyA9IGZldGNoTWlsbGlzOwogICAgaWYgKENmR3FsQ2xpZW50LkRFQlVHKSBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXNPYmosIHVuZGVmaW5lZCwgMikpOwogICAgaWYgKGlzR3FsRXJyb3JSZXNwb25zZShyZXNPYmopKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc09iai5lcnJvcnMubWFwKGNvbXB1dGVHcWxFcnJvclN0cmluZykuam9pbignLCAnKSk7CiAgICB9CiAgICByZXR1cm4gcmVzT2JqOwp9CmZ1bmN0aW9uIGlzR3FsRXJyb3JSZXNwb25zZShvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmouZGF0YSA9PT0gbnVsbCAmJiBBcnJheS5pc0FycmF5KG9iai5lcnJvcnMpOwp9CmZ1bmN0aW9uIGNvbXB1dGVHcWxFcnJvclN0cmluZyhlcnJvcikgewogICAgY29uc3QgcGllY2VzID0gWwogICAgICAgIGVycm9yLm1lc3NhZ2UKICAgIF07CiAgICBpZiAoZXJyb3IucGF0aCkgcGllY2VzLnB1c2goYCgke2Vycm9yLnBhdGguam9pbignLycpfSlgKTsKICAgIGlmIChlcnJvci5leHRlbnNpb25zLmNvZGUpIHBpZWNlcy5wdXNoKGAoY29kZT0ke2Vycm9yLmV4dGVuc2lvbnMuY29kZX0pYCk7CiAgICByZXR1cm4gcGllY2VzLmpvaW4oJyAnKTsKfQphc3luYyBmdW5jdGlvbiBfZ2V0RHVyYWJsZU9iamVjdFBlcmlvZGljTWV0cmljc0J5RGF0ZShwcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgIGNvbnN0IHJlc09iaiA9IGF3YWl0IHF1ZXJ5KHByb2ZpbGUsIChxKT0+cS5vYmplY3QoJ2R1cmFibGVPYmplY3RzUGVyaW9kaWNHcm91cHMnKS5hcmdMb25nKCdsaW1pdCcsIDEwMDAwKS5hcmdSYXcoJ2ZpbHRlcicsIGB7ZGF0ZV9nZXE6ICRzdGFydCwgZGF0ZV9sZXE6ICRlbmR9YCkuYXJnUmF3KCdvcmRlckJ5JywgYFtkYXRlX0FTQ11gKS5vYmplY3QoJ2RpbWVuc2lvbnMnKS5zY2FsYXIoJ2RhdGUnKS5zY2FsYXIoJ25hbWVzcGFjZUlkJykuZW5kKCkub2JqZWN0KCdtYXgnKS5zY2FsYXIoJ2FjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zJykuZW5kKCkub2JqZWN0KCdzdW0nKS5zY2FsYXIoJ2FjdGl2ZVRpbWUnKS5zY2FsYXIoJ2NwdVRpbWUnKS5zY2FsYXIoJ2V4Y2VlZGVkQ3B1RXJyb3JzJykuc2NhbGFyKCdleGNlZWRlZE1lbW9yeUVycm9ycycpLnNjYWxhcignZmF0YWxJbnRlcm5hbEVycm9ycycpLnNjYWxhcignaW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50Jykuc2NhbGFyKCdvdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50Jykuc2NhbGFyKCdzdG9yYWdlRGVsZXRlcycpLnNjYWxhcignc3RvcmFnZVJlYWRVbml0cycpLnNjYWxhcignc3RvcmFnZVdyaXRlVW5pdHMnKS5zY2FsYXIoJ3N1YnJlcXVlc3RzJykKICAgICwgewogICAgICAgIHN0YXJ0OiBzdGFydERhdGVJbmNsdXNpdmUsCiAgICAgICAgZW5kOiBlbmREYXRlSW5jbHVzaXZlCiAgICB9KTsKICAgIGNvbnN0IGZldGNoTWlsbGlzID0gcmVzT2JqLmZldGNoTWlsbGlzOwogICAgY29uc3QgcmVzID0gcmVzT2JqOwogICAgY29uc3QgY29zdCA9IHJlcy5kYXRhLmNvc3Q7CiAgICBjb25zdCBidWRnZXQgPSByZXMuZGF0YS52aWV3ZXIuYnVkZ2V0OwogICAgY29uc3Qgcm93cyA9IFtdOwogICAgZm9yIChjb25zdCBhY2NvdW50IG9mIHJlcy5kYXRhLnZpZXdlci5hY2NvdW50cyl7CiAgICAgICAgY2hlY2tFcXVhbCgnYWNjb3VudC5hY2NvdW50VGFnJywgYWNjb3VudC5hY2NvdW50VGFnLCBwcm9maWxlLmFjY291bnRJZCk7CiAgICAgICAgZm9yIChjb25zdCBncm91cCBvZiBhY2NvdW50LmR1cmFibGVPYmplY3RzUGVyaW9kaWNHcm91cHMpewogICAgICAgICAgICBjb25zdCBkYXRlID0gZ3JvdXAuZGltZW5zaW9ucy5kYXRlOwogICAgICAgICAgICBjb25zdCBuYW1lc3BhY2VJZCA9IGdyb3VwLmRpbWVuc2lvbnMubmFtZXNwYWNlSWQ7CiAgICAgICAgICAgIGNvbnN0IG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zID0gZ3JvdXAubWF4LmFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zOwogICAgICAgICAgICBjb25zdCBzdW1BY3RpdmVUaW1lID0gZ3JvdXAuc3VtLmFjdGl2ZVRpbWU7CiAgICAgICAgICAgIGNvbnN0IHN1bUNwdVRpbWUgPSBncm91cC5zdW0uY3B1VGltZTsKICAgICAgICAgICAgY29uc3Qgc3VtRXhjZWVkZWRDcHVFcnJvcnMgPSBncm91cC5zdW0uZXhjZWVkZWRDcHVFcnJvcnM7CiAgICAgICAgICAgIGNvbnN0IHN1bUV4Y2VlZGVkTWVtb3J5RXJyb3JzID0gZ3JvdXAuc3VtLmV4Y2VlZGVkTWVtb3J5RXJyb3JzOwogICAgICAgICAgICBjb25zdCBzdW1GYXRhbEludGVybmFsRXJyb3JzID0gZ3JvdXAuc3VtLmZhdGFsSW50ZXJuYWxFcnJvcnM7CiAgICAgICAgICAgIGNvbnN0IHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCA9IGdyb3VwLnN1bS5pbmJvdW5kV2Vic29ja2V0TXNnQ291bnQ7CiAgICAgICAgICAgIGNvbnN0IHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQgPSBncm91cC5zdW0ub3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudDsKICAgICAgICAgICAgY29uc3Qgc3VtU3RvcmFnZURlbGV0ZXMgPSBncm91cC5zdW0uc3RvcmFnZURlbGV0ZXM7CiAgICAgICAgICAgIGNvbnN0IHN1bVN0b3JhZ2VSZWFkVW5pdHMgPSBncm91cC5zdW0uc3RvcmFnZVJlYWRVbml0czsKICAgICAgICAgICAgY29uc3Qgc3VtU3RvcmFnZVdyaXRlVW5pdHMgPSBncm91cC5zdW0uc3RvcmFnZVdyaXRlVW5pdHM7CiAgICAgICAgICAgIGNvbnN0IHN1bVN1YnJlcXVlc3RzID0gZ3JvdXAuc3VtLnN1YnJlcXVlc3RzOwogICAgICAgICAgICByb3dzLnB1c2goewogICAgICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgICAgIG5hbWVzcGFjZUlkLAogICAgICAgICAgICAgICAgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgICAgICAgICBzdW1BY3RpdmVUaW1lLAogICAgICAgICAgICAgICAgc3VtQ3B1VGltZSwKICAgICAgICAgICAgICAgIHN1bUV4Y2VlZGVkQ3B1RXJyb3JzLAogICAgICAgICAgICAgICAgc3VtRXhjZWVkZWRNZW1vcnlFcnJvcnMsCiAgICAgICAgICAgICAgICBzdW1GYXRhbEludGVybmFsRXJyb3JzLAogICAgICAgICAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgICAgICAgICAgc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzLAogICAgICAgICAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICAgICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzLAogICAgICAgICAgICAgICAgc3VtU3VicmVxdWVzdHMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBpbmZvOiB7CiAgICAgICAgICAgIGZldGNoTWlsbGlzLAogICAgICAgICAgICBjb3N0LAogICAgICAgICAgICBidWRnZXQKICAgICAgICB9LAogICAgICAgIHJvd3MKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gX2dldER1cmFibGVPYmplY3RTdG9yYWdlQnlEYXRlKHByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSkgewogICAgY29uc3QgcmVzT2JqID0gYXdhaXQgcXVlcnkocHJvZmlsZSwgKHEpPT5xLm9iamVjdCgnZHVyYWJsZU9iamVjdHNTdG9yYWdlR3JvdXBzJykuYXJnTG9uZygnbGltaXQnLCAxMDAwMCkuYXJnUmF3KCdmaWx0ZXInLCBge2RhdGVfZ2VxOiAkc3RhcnQsIGRhdGVfbGVxOiAkZW5kfWApLmFyZ1Jhdygnb3JkZXJCeScsIGBbZGF0ZV9BU0NdYCkub2JqZWN0KCdkaW1lbnNpb25zJykuc2NhbGFyKCdkYXRlJykuZW5kKCkub2JqZWN0KCdtYXgnKS5zY2FsYXIoJ3N0b3JlZEJ5dGVzJykuZW5kKCkKICAgICwgewogICAgICAgIHN0YXJ0OiBzdGFydERhdGVJbmNsdXNpdmUsCiAgICAgICAgZW5kOiBlbmREYXRlSW5jbHVzaXZlCiAgICB9KTsKICAgIGNvbnN0IGZldGNoTWlsbGlzID0gcmVzT2JqLmZldGNoTWlsbGlzOwogICAgY29uc3QgcmVzID0gcmVzT2JqOwogICAgY29uc3QgY29zdCA9IHJlcy5kYXRhLmNvc3Q7CiAgICBjb25zdCBidWRnZXQgPSByZXMuZGF0YS52aWV3ZXIuYnVkZ2V0OwogICAgY29uc3Qgcm93cyA9IFtdOwogICAgZm9yIChjb25zdCBhY2NvdW50IG9mIHJlcy5kYXRhLnZpZXdlci5hY2NvdW50cyl7CiAgICAgICAgY2hlY2tFcXVhbCgnYWNjb3VudC5hY2NvdW50VGFnJywgYWNjb3VudC5hY2NvdW50VGFnLCBwcm9maWxlLmFjY291bnRJZCk7CiAgICAgICAgZm9yIChjb25zdCBncm91cCBvZiBhY2NvdW50LmR1cmFibGVPYmplY3RzU3RvcmFnZUdyb3Vwcyl7CiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBncm91cC5kaW1lbnNpb25zLmRhdGU7CiAgICAgICAgICAgIGNvbnN0IG1heFN0b3JlZEJ5dGVzID0gZ3JvdXAubWF4LnN0b3JlZEJ5dGVzOwogICAgICAgICAgICByb3dzLnB1c2goewogICAgICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgICAgIG1heFN0b3JlZEJ5dGVzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgaW5mbzogewogICAgICAgICAgICBmZXRjaE1pbGxpcywKICAgICAgICAgICAgY29zdCwKICAgICAgICAgICAgYnVkZ2V0CiAgICAgICAgfSwKICAgICAgICByb3dzCiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIF9nZXREdXJhYmxlT2JqZWN0SW52b2NhdGlvbnNCeURhdGUocHJvZmlsZSwgc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKSB7CiAgICBjb25zdCByZXNPYmogPSBhd2FpdCBxdWVyeShwcm9maWxlLCAocSk9PnEub2JqZWN0KCdkdXJhYmxlT2JqZWN0c0ludm9jYXRpb25zQWRhcHRpdmVHcm91cHMnKS5hcmdMb25nKCdsaW1pdCcsIDEwMDAwKS5hcmdSYXcoJ2ZpbHRlcicsIGB7ZGF0ZV9nZXE6ICRzdGFydCwgZGF0ZV9sZXE6ICRlbmR9YCkuYXJnUmF3KCdvcmRlckJ5JywgYFtkYXRlX0FTQ11gKS5vYmplY3QoJ2RpbWVuc2lvbnMnKS5zY2FsYXIoJ2RhdGUnKS5zY2FsYXIoJ25hbWVzcGFjZUlkJykuZW5kKCkub2JqZWN0KCdhdmcnKS5zY2FsYXIoJ3NhbXBsZUludGVydmFsJykuZW5kKCkub2JqZWN0KCdzdW0nKS5zY2FsYXIoJ3JlcXVlc3RzJykuZW5kKCkKICAgICwgewogICAgICAgIHN0YXJ0OiBzdGFydERhdGVJbmNsdXNpdmUsCiAgICAgICAgZW5kOiBlbmREYXRlSW5jbHVzaXZlCiAgICB9KTsKICAgIGNvbnN0IGZldGNoTWlsbGlzID0gcmVzT2JqLmZldGNoTWlsbGlzOwogICAgY29uc3QgcmVzID0gcmVzT2JqOwogICAgY29uc3QgY29zdCA9IHJlcy5kYXRhLmNvc3Q7CiAgICBjb25zdCBidWRnZXQgPSByZXMuZGF0YS52aWV3ZXIuYnVkZ2V0OwogICAgY29uc3Qgcm93cyA9IFtdOwogICAgZm9yIChjb25zdCBhY2NvdW50IG9mIHJlcy5kYXRhLnZpZXdlci5hY2NvdW50cyl7CiAgICAgICAgY2hlY2tFcXVhbCgnYWNjb3VudC5hY2NvdW50VGFnJywgYWNjb3VudC5hY2NvdW50VGFnLCBwcm9maWxlLmFjY291bnRJZCk7CiAgICAgICAgZm9yIChjb25zdCBncm91cCBvZiBhY2NvdW50LmR1cmFibGVPYmplY3RzSW52b2NhdGlvbnNBZGFwdGl2ZUdyb3Vwcyl7CiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBncm91cC5kaW1lbnNpb25zLmRhdGU7CiAgICAgICAgICAgIGNvbnN0IG5hbWVzcGFjZUlkID0gZ3JvdXAuZGltZW5zaW9ucy5uYW1lc3BhY2VJZDsKICAgICAgICAgICAgY29uc3QgYXZnU2FtcGxlSW50ZXJ2YWwgPSBncm91cC5hdmcuc2FtcGxlSW50ZXJ2YWw7CiAgICAgICAgICAgIGNvbnN0IHN1bVJlcXVlc3RzID0gZ3JvdXAuc3VtLnJlcXVlc3RzOwogICAgICAgICAgICByb3dzLnB1c2goewogICAgICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgICAgIG5hbWVzcGFjZUlkLAogICAgICAgICAgICAgICAgYXZnU2FtcGxlSW50ZXJ2YWwsCiAgICAgICAgICAgICAgICBzdW1SZXF1ZXN0cwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGluZm86IHsKICAgICAgICAgICAgZmV0Y2hNaWxsaXMsCiAgICAgICAgICAgIGNvc3QsCiAgICAgICAgICAgIGJ1ZGdldAogICAgICAgIH0sCiAgICAgICAgcm93cwogICAgfTsKfQphc3luYyBmdW5jdGlvbiBsaXN0RHVyYWJsZU9iamVjdHNOYW1lc3BhY2VzKGFjY291bnRJZCwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybDEoYWNjb3VudElkKX0vd29ya2Vycy9kdXJhYmxlX29iamVjdHMvbmFtZXNwYWNlc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUxKCdsaXN0RHVyYWJsZU9iamVjdHNOYW1lc3BhY2VzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KY2xhc3MgQ2xvdWRmbGFyZUFwaTEgewogICAgc3RhdGljIERFQlVHID0gZmFsc2U7CiAgICBzdGF0aWMgVVJMX1RSQU5TRk9STUVSID0gKHYpPT52CiAgICA7Cn0KY29uc3QgQVBQTElDQVRJT05fSlNPTjEgPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGODEgPSAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD1VVEYtOCc7CmNvbnN0IEFQUExJQ0FUSU9OX09DVEVUX1NUUkVBTTEgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJzsKZnVuY3Rpb24gY29tcHV0ZUFjY291bnRCYXNlVXJsMShhY2NvdW50SWQpIHsKICAgIHJldHVybiBDbG91ZGZsYXJlQXBpMS5VUkxfVFJBTlNGT1JNRVIoYGh0dHBzOi8vYXBpLmNsb3VkZmxhcmUuY29tL2NsaWVudC92NC9hY2NvdW50cy8ke2FjY291bnRJZH1gKTsKfQphc3luYyBmdW5jdGlvbiBleGVjdXRlMShvcCwgbWV0aG9kLCB1cmwsIGFwaVRva2VuLCBib2R5LCByZXNwb25zZVR5cGUgPSAnanNvbicpIHsKICAgIGlmIChDbG91ZGZsYXJlQXBpMS5ERUJVRykgY29uc29sZS5sb2coYCR7b3B9OiAke21ldGhvZH0gJHt1cmx9YCk7CiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoewogICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaVRva2VufWAKICAgIH0pOwogICAgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykgewogICAgICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBBUFBMSUNBVElPTl9KU09OX1VURjgxKTsKICAgICAgICBpZiAoQ2xvdWRmbGFyZUFwaTEuREVCVUcpIGNvbnNvbGUubG9nKGJvZHkpOwogICAgfQogICAgY29uc3QgZmV0Y2hSZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwgewogICAgICAgIG1ldGhvZCwKICAgICAgICBoZWFkZXJzLAogICAgICAgIGJvZHkKICAgIH0pOwogICAgY29uc3QgY29udGVudFR5cGUgPSBmZXRjaFJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKSB8fCAnJzsKICAgIGlmICgocmVzcG9uc2VUeXBlID09PSAnYnl0ZXMnIHx8IHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzPycpICYmIGNvbnRlbnRUeXBlID09PSBBUFBMSUNBVElPTl9PQ1RFVF9TVFJFQU0xKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4MSwKICAgICAgICBBUFBMSUNBVElPTl9KU09OMQogICAgXS5pbmNsdWRlcyhjb250ZW50VHlwZSkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgY29udGVudC10eXBlOiAke2NvbnRlbnRUeXBlfSwgIGZldGNoUmVzcG9uc2U9JHtmZXRjaFJlc3BvbnNlfSwgYm9keT0ke2F3YWl0IGZldGNoUmVzcG9uc2UudGV4dCgpfWApOwogICAgfQogICAgY29uc3QgYXBpUmVzcG9uc2UgPSBhd2FpdCBmZXRjaFJlc3BvbnNlLmpzb24oKTsKICAgIGlmIChDbG91ZGZsYXJlQXBpMS5ERUJVRykgY29uc29sZS5sb2coYXBpUmVzcG9uc2UpOwogICAgaWYgKCFhcGlSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgaWYgKGZldGNoUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgJiYgcmVzcG9uc2VUeXBlID09PSAnYnl0ZXM/JykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB0aHJvdyBuZXcgQ2xvdWRmbGFyZUFwaUVycm9yMShgJHtvcH0gZmFpbGVkOiBzdGF0dXM9JHtmZXRjaFJlc3BvbnNlLnN0YXR1c30sIGVycm9ycz0ke2FwaVJlc3BvbnNlLmVycm9ycy5tYXAoKHYpPT5gJHt2LmNvZGV9ICR7di5tZXNzYWdlfWAKICAgICAgICApLmpvaW4oJywgJyl9YCwgZmV0Y2hSZXNwb25zZS5zdGF0dXMsIGFwaVJlc3BvbnNlLmVycm9ycyk7CiAgICB9CiAgICByZXR1cm4gYXBpUmVzcG9uc2U7Cn0KY2xhc3MgQ2xvdWRmbGFyZUFwaUVycm9yMSBleHRlbmRzIEVycm9yIHsKICAgIHN0YXR1czsKICAgIGVycm9yczsKICAgIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIHN0YXR1cywgZXJyb3JzKXsKICAgICAgICBzdXBlcihtZXNzYWdlKTsKICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgIH0KfQphc3luYyBmdW5jdGlvbiBjb21wdXRlRHVyYWJsZU9iamVjdHNDb3N0c1RhYmxlKGNsaWVudCwgb3B0cykgewogICAgY29uc3QgeyBzdGFydDogc3RhcnQxICwgZW5kOiBlbmQxICB9ID0gKCgpPT57CiAgICAgICAgaWYgKCdsb29rYmFja0RheXMnIGluIG9wdHMpIHsKICAgICAgICAgICAgY29uc3QgZW5kID0gdXRjQ3VycmVudERhdGUoKTsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBhZGREYXlzVG9EYXRlKGVuZCwgLW9wdHMubG9va2JhY2tEYXlzKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICAgICAgZW5kCiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgeyBzdGFydCAsIGVuZCAgfSA9IG9wdHM7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgICAgIGVuZAogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pKCk7CiAgICBjb25zdCBbc3RvcmFnZSwgcGVyaW9kaWMsIGludm9jYXRpb25zLCBuYW1lc3BhY2VzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgICBjbGllbnQuZ2V0RHVyYWJsZU9iamVjdFN0b3JhZ2VCeURhdGUoc3RhcnQxLCBlbmQxKSwKICAgICAgICBjbGllbnQuZ2V0RHVyYWJsZU9iamVjdFBlcmlvZGljTWV0cmljc0J5RGF0ZShzdGFydDEsIGVuZDEpLAogICAgICAgIGNsaWVudC5nZXREdXJhYmxlT2JqZWN0SW52b2NhdGlvbnNCeURhdGUoc3RhcnQxLCBlbmQxKSwKICAgICAgICB0cnlMaXN0RHVyYWJsZU9iamVjdHNOYW1lc3BhY2VzKGNsaWVudC5wcm9maWxlKSwgCiAgICBdKTsKICAgIGNvbnN0IGdxbFJlc3VsdEluZm9zID0gewogICAgICAgICdzdG9yYWdlJzogc3RvcmFnZS5pbmZvLAogICAgICAgICdwZXJpb2RpYyc6IHBlcmlvZGljLmluZm8sCiAgICAgICAgJ2ludm9jYXRpb25zJzogaW52b2NhdGlvbnMuaW5mbwogICAgfTsKICAgIGNvbnN0IHJvd3NCeU5hbWVzcGFjZSA9IHt9OwogICAgY29uc3Qgcm93c0J5RGF0ZSA9IHt9OwogICAgZm9yIChjb25zdCBwUm93IG9mIHBlcmlvZGljLnJvd3MpewogICAgICAgIGNvbnN0IHsgZGF0ZSAsIG5hbWVzcGFjZUlkICwgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMgLCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ICwgc3VtU3VicmVxdWVzdHMgLCBzdW1BY3RpdmVUaW1lICwgc3VtU3RvcmFnZVJlYWRVbml0cyAsIHN1bVN0b3JhZ2VXcml0ZVVuaXRzICwgc3VtU3RvcmFnZURlbGV0ZXMgLCAgfSA9IHBSb3c7CiAgICAgICAgbGV0IHJvd3MgPSByb3dzQnlOYW1lc3BhY2VbbmFtZXNwYWNlSWRdOwogICAgICAgIGlmICghcm93cykgewogICAgICAgICAgICByb3dzID0gW107CiAgICAgICAgICAgIHJvd3NCeU5hbWVzcGFjZVtuYW1lc3BhY2VJZF0gPSByb3dzOwogICAgICAgIH0KICAgICAgICBsZXQgZGF0ZVJvd3MgPSByb3dzQnlEYXRlW2RhdGVdOwogICAgICAgIGlmICghZGF0ZVJvd3MpIHsKICAgICAgICAgICAgZGF0ZVJvd3MgPSBbXTsKICAgICAgICAgICAgcm93c0J5RGF0ZVtkYXRlXSA9IGRhdGVSb3dzOwogICAgICAgIH0KICAgICAgICBjb25zdCB7IHN1bVJlcXVlc3RzICB9ID0gaW52b2NhdGlvbnMucm93cy5maWx0ZXIoKHYpPT52LmRhdGUgPT09IGRhdGUgJiYgdi5uYW1lc3BhY2VJZCA9PT0gbmFtZXNwYWNlSWQKICAgICAgICApWzBdIHx8IHsKICAgICAgICAgICAgc3VtUmVxdWVzdHM6IDAKICAgICAgICB9OwogICAgICAgIGNvbnN0IHsgcmVxdWVzdHNDb3N0ICwgd2Vic29ja2V0c0Nvc3QgLCBzdWJyZXF1ZXN0c0Nvc3QgLCBhY3RpdmVDb3N0ICwgcmVhZFVuaXRzQ29zdCAsIHdyaXRlVW5pdHNDb3N0ICwgZGVsZXRlc0Nvc3QgLCB0b3RhbENvc3QgLCBhY3RpdmVHYlNlY29uZHMgIH0gPSBjb21wdXRlQ29zdHMoewogICAgICAgICAgICBzdW1SZXF1ZXN0cywKICAgICAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgICAgICBzdW1TdWJyZXF1ZXN0cywKICAgICAgICAgICAgc3VtQWN0aXZlVGltZSwKICAgICAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICAgICAgc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzLAogICAgICAgICAgICBleGNsdWRlRnJlZVVzYWdlOiBmYWxzZSwKICAgICAgICAgICAgc3RvcmFnZUNvc3Q6IDAKICAgICAgICB9KTsKICAgICAgICBjb25zdCByb3cgPSB7CiAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgIHN1bVJlcXVlc3RzLAogICAgICAgICAgICByZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zLAogICAgICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHdlYnNvY2tldHNDb3N0LAogICAgICAgICAgICBzdW1TdWJyZXF1ZXN0cywKICAgICAgICAgICAgc3VicmVxdWVzdHNDb3N0LAogICAgICAgICAgICBzdW1BY3RpdmVUaW1lLAogICAgICAgICAgICBhY3RpdmVHYlNlY29uZHMsCiAgICAgICAgICAgIGFjdGl2ZUNvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHMsCiAgICAgICAgICAgIHJlYWRVbml0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzLAogICAgICAgICAgICB3cml0ZVVuaXRzQ29zdCwKICAgICAgICAgICAgc3VtU3RvcmFnZURlbGV0ZXMsCiAgICAgICAgICAgIGRlbGV0ZXNDb3N0LAogICAgICAgICAgICB0b3RhbENvc3QKICAgICAgICB9OwogICAgICAgIHJvd3MucHVzaChyb3cpOwogICAgICAgIGRhdGVSb3dzLnB1c2gocm93KTsKICAgIH0KICAgIGNvbnN0IG5hbWVzcGFjZVRhYmxlcyA9IHt9OwogICAgZm9yIChjb25zdCBbbmFtZXNwYWNlSWQsIHJvd3NdIG9mIE9iamVjdC5lbnRyaWVzKHJvd3NCeU5hbWVzcGFjZSkpewogICAgICAgIGNvbnN0IGVzdGltYXRlZDMwRGF5Um93ID0gY29tcHV0ZUVzdGltYXRlZDMwRGF5Um93KHJvd3MsIGZhbHNlKTsKICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmZpbmQoKHYpPT52LmlkID09PSBuYW1lc3BhY2VJZAogICAgICAgICk7CiAgICAgICAgbmFtZXNwYWNlVGFibGVzW25hbWVzcGFjZUlkXSA9IHsKICAgICAgICAgICAgcm93cywKICAgICAgICAgICAgZXN0aW1hdGVkMzBEYXlSb3csCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWU6IHVuZGVmaW5lZAogICAgICAgIH07CiAgICB9CiAgICBjb25zdCBhY2NvdW50Um93cyA9IFtdOwogICAgZm9yIChjb25zdCBbZGF0ZSwgZGF0ZVJvd3NdIG9mIE9iamVjdC5lbnRyaWVzKHJvd3NCeURhdGUpKXsKICAgICAgICBjb25zdCB7IG1heFN0b3JlZEJ5dGVzICB9ID0gc3RvcmFnZS5yb3dzLmZpbHRlcigodik9PnYuZGF0ZSA9PT0gZGF0ZQogICAgICAgIClbMF0gfHwgewogICAgICAgICAgICBtYXhTdG9yZWRCeXRlczogMAogICAgICAgIH07CiAgICAgICAgY29uc3Qgc3RvcmFnZUdiID0gbWF4U3RvcmVkQnl0ZXMgLyAxMDI0IC8gMTAyNCAvIDEwMjQ7CiAgICAgICAgY29uc3Qgc3RvcmFnZUNvc3QgPSBzdG9yYWdlR2IgKiAuMjAgLyAzMDsKICAgICAgICBhY2NvdW50Um93cy5wdXNoKGNvbXB1dGVUb3RhbFJvdyhkYXRlLCBkYXRlUm93cywgewogICAgICAgICAgICBzdG9yYWdlR2IsCiAgICAgICAgICAgIHN0b3JhZ2VDb3N0CiAgICAgICAgfSkpOwogICAgfQogICAgY29uc3Qgc3RvcmFnZUNvc3QgPSBhY2NvdW50Um93cy5sZW5ndGggPiAwID8gYWNjb3VudFJvd3MubWFwKCh2KT0+di5zdG9yYWdlQ29zdCB8fCAwCiAgICApLnJlZHVjZSgoYSwgYik9PmEgKyBiCiAgICApIDogMDsKICAgIGNvbnN0IGFjY291bnRPcHRzID0gewogICAgICAgIHN0b3JhZ2VHYjogMCwKICAgICAgICBzdG9yYWdlQ29zdAogICAgfTsKICAgIGNvbnN0IGVzdGltYXRlZDMwRGF5Um93ID0gY29tcHV0ZUVzdGltYXRlZDMwRGF5Um93KGFjY291bnRSb3dzLCBmYWxzZSwgYWNjb3VudE9wdHMpOwogICAgY29uc3QgZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUgPSBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3coYWNjb3VudFJvd3MsIHRydWUsIGFjY291bnRPcHRzKTsKICAgIGNvbnN0IGFjY291bnRUYWJsZSA9IHsKICAgICAgICByb3dzOiBhY2NvdW50Um93cywKICAgICAgICBlc3RpbWF0ZWQzMERheVJvdywKICAgICAgICBlc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZSwKICAgICAgICBuYW1lc3BhY2U6IHVuZGVmaW5lZAogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgYWNjb3VudFRhYmxlLAogICAgICAgIG5hbWVzcGFjZVRhYmxlcywKICAgICAgICBncWxSZXN1bHRJbmZvcwogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlQ29zdHMoaW5wdXQpIHsKICAgIGNvbnN0IHsgc3VtQWN0aXZlVGltZSAsIHN1bVN0b3JhZ2VSZWFkVW5pdHMgLCBzdW1TdG9yYWdlV3JpdGVVbml0cyAsIHN1bVN0b3JhZ2VEZWxldGVzICwgZXhjbHVkZUZyZWVVc2FnZSAsIHN0b3JhZ2VDb3N0ICB9ID0gaW5wdXQ7CiAgICBjb25zdCB7IHN1bVJlcXVlc3RzOiBzdW1SZXF1ZXN0czEgLCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudDEgLCBzdW1TdWJyZXF1ZXN0czogc3VtU3VicmVxdWVzdHMxICB9ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHsgc3VtUmVxdWVzdHMgLCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdW1TdWJyZXF1ZXN0cyAgfSA9IGlucHV0OwogICAgICAgIGlmIChleGNsdWRlRnJlZVVzYWdlKSB7CiAgICAgICAgICAgIGxldCByZW1haW5pbmcgPSAxMDAwMDAwOwogICAgICAgICAgICBsZXQgdGFrZSA9IE1hdGgubWluKHJlbWFpbmluZywgc3VtUmVxdWVzdHMpOwogICAgICAgICAgICBpZiAodGFrZSA+IDApIHsKICAgICAgICAgICAgICAgIHN1bVJlcXVlc3RzIC09IHRha2U7CiAgICAgICAgICAgICAgICByZW1haW5pbmcgLT0gdGFrZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YWtlID0gTWF0aC5taW4ocmVtYWluaW5nLCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQpOwogICAgICAgICAgICBpZiAodGFrZSA+IDApIHsKICAgICAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCAtPSB0YWtlOwogICAgICAgICAgICAgICAgcmVtYWluaW5nIC09IHRha2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFrZSA9IE1hdGgubWluKHJlbWFpbmluZywgc3VtU3VicmVxdWVzdHMpOwogICAgICAgICAgICBpZiAodGFrZSA+IDApIHsKICAgICAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzIC09IHRha2U7CiAgICAgICAgICAgICAgICByZW1haW5pbmcgLT0gdGFrZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdW1SZXF1ZXN0cywKICAgICAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgICAgICBzdW1TdWJyZXF1ZXN0cwogICAgICAgIH07CiAgICB9KCk7CiAgICBjb25zdCByZXF1ZXN0c0Nvc3QgPSBzdW1SZXF1ZXN0czEgLyAxMDAwMDAwICogMC4xNTsKICAgIGNvbnN0IHdlYnNvY2tldHNDb3N0ID0gc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50MSAvIDEwMDAwMDAgKiAwLjE1OwogICAgY29uc3Qgc3VicmVxdWVzdHNDb3N0ID0gc3VtU3VicmVxdWVzdHMxIC8gMTAwMDAwMCAqIDAuMTU7CiAgICBjb25zdCBhY3RpdmVUaW1lU2Vjb25kcyA9IHN1bUFjdGl2ZVRpbWUgLyAxMDAwIC8gMTAwMDsKICAgIGxldCBhY3RpdmVHYlNlY29uZHMgPSBhY3RpdmVUaW1lU2Vjb25kcyAqIDEyOCAvIDEwMjQ7CiAgICBpZiAoZXhjbHVkZUZyZWVVc2FnZSkgewogICAgICAgIGFjdGl2ZUdiU2Vjb25kcyA9IE1hdGgubWF4KDAsIGFjdGl2ZUdiU2Vjb25kcyAtIDQwMDAwMCk7CiAgICB9CiAgICBjb25zdCBhY3RpdmVDb3N0ID0gYWN0aXZlR2JTZWNvbmRzIC8gNDAwMDAwICogMTIuNTA7CiAgICBjb25zdCByZWFkVW5pdHNDb3N0ID0gKGV4Y2x1ZGVGcmVlVXNhZ2UgPyBNYXRoLm1heCgwLCBzdW1TdG9yYWdlUmVhZFVuaXRzIC0gMTAwMDAwMCkgOiBzdW1TdG9yYWdlUmVhZFVuaXRzKSAvIDEwMDAwMDAgKiAuMjA7CiAgICBjb25zdCB3cml0ZVVuaXRzQ29zdCA9IChleGNsdWRlRnJlZVVzYWdlID8gTWF0aC5tYXgoMCwgc3VtU3RvcmFnZVdyaXRlVW5pdHMgLSAxMDAwMDAwKSA6IHN1bVN0b3JhZ2VXcml0ZVVuaXRzKSAvIDEwMDAwMDAgKiAxOwogICAgY29uc3QgZGVsZXRlc0Nvc3QgPSAoZXhjbHVkZUZyZWVVc2FnZSA/IE1hdGgubWF4KDAsIHN1bVN0b3JhZ2VEZWxldGVzIC0gMTAwMDAwMCkgOiBzdW1TdG9yYWdlRGVsZXRlcykgLyAxMDAwMDAwICogMTsKICAgIGxldCBuZXdTdG9yYWdlQ29zdCA9IHN0b3JhZ2VDb3N0IHx8IDA7CiAgICBpZiAoZXhjbHVkZUZyZWVVc2FnZSkgbmV3U3RvcmFnZUNvc3QgPSBNYXRoLm1heCgwLCBuZXdTdG9yYWdlQ29zdCAtIDAuMjApOwogICAgY29uc3QgdG90YWxDb3N0ID0gcmVxdWVzdHNDb3N0ICsgd2Vic29ja2V0c0Nvc3QgKyBzdWJyZXF1ZXN0c0Nvc3QgKyBhY3RpdmVDb3N0ICsgcmVhZFVuaXRzQ29zdCArIHdyaXRlVW5pdHNDb3N0ICsgZGVsZXRlc0Nvc3QgKyBuZXdTdG9yYWdlQ29zdDsKICAgIHJldHVybiB7CiAgICAgICAgcmVxdWVzdHNDb3N0LAogICAgICAgIHdlYnNvY2tldHNDb3N0LAogICAgICAgIHN1YnJlcXVlc3RzQ29zdCwKICAgICAgICBhY3RpdmVDb3N0LAogICAgICAgIHJlYWRVbml0c0Nvc3QsCiAgICAgICAgd3JpdGVVbml0c0Nvc3QsCiAgICAgICAgZGVsZXRlc0Nvc3QsCiAgICAgICAgdG90YWxDb3N0LAogICAgICAgIGFjdGl2ZUdiU2Vjb25kcywKICAgICAgICBuZXdTdG9yYWdlQ29zdAogICAgfTsKfQphc3luYyBmdW5jdGlvbiB0cnlMaXN0RHVyYWJsZU9iamVjdHNOYW1lc3BhY2VzKHByb2ZpbGUpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IGxpc3REdXJhYmxlT2JqZWN0c05hbWVzcGFjZXMocHJvZmlsZS5hY2NvdW50SWQsIHByb2ZpbGUuYXBpVG9rZW4pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUud2FybihlKTsKICAgICAgICByZXR1cm4gW107CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZVRvdGFsUm93KGRhdGUsIHJvd3MsIG9wdHMpIHsKICAgIGxldCBjb21wdXRlZFN0b3JhZ2VDb3N0ID0gZmFsc2U7CiAgICBjb25zdCBjb21wdXRlU3RvcmFnZUNvc3RPbmNlID0gKCk9PnsKICAgICAgICBjb25zdCBydCA9ICFjb21wdXRlZFN0b3JhZ2VDb3N0ID8gb3B0cz8uc3RvcmFnZUNvc3QgfHwgMCA6IDA7CiAgICAgICAgY29tcHV0ZWRTdG9yYWdlQ29zdCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfTsKICAgIHJldHVybiByb3dzLnJlZHVjZSgobGhzLCByaHMpPT4oewogICAgICAgICAgICBkYXRlLAogICAgICAgICAgICBzdW1SZXF1ZXN0czogbGhzLnN1bVJlcXVlc3RzICsgcmhzLnN1bVJlcXVlc3RzLAogICAgICAgICAgICByZXF1ZXN0c0Nvc3Q6IGxocy5yZXF1ZXN0c0Nvc3QgKyByaHMucmVxdWVzdHNDb3N0LAogICAgICAgICAgICBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9uczogbGhzLm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zICsgcmhzLm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zLAogICAgICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IGxocy5zdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgKyByaHMuc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgICAgICBzdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50OiBsaHMuc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCArIHJocy5zdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgICAgICB3ZWJzb2NrZXRzQ29zdDogbGhzLndlYnNvY2tldHNDb3N0ICsgcmhzLndlYnNvY2tldHNDb3N0LAogICAgICAgICAgICBzdW1TdWJyZXF1ZXN0czogbGhzLnN1bVN1YnJlcXVlc3RzICsgcmhzLnN1bVN1YnJlcXVlc3RzLAogICAgICAgICAgICBzdWJyZXF1ZXN0c0Nvc3Q6IGxocy5zdWJyZXF1ZXN0c0Nvc3QgKyByaHMuc3VicmVxdWVzdHNDb3N0LAogICAgICAgICAgICBzdW1BY3RpdmVUaW1lOiBsaHMuc3VtQWN0aXZlVGltZSArIHJocy5zdW1BY3RpdmVUaW1lLAogICAgICAgICAgICBhY3RpdmVHYlNlY29uZHM6IGxocy5hY3RpdmVHYlNlY29uZHMgKyByaHMuYWN0aXZlR2JTZWNvbmRzLAogICAgICAgICAgICBhY3RpdmVDb3N0OiBsaHMuYWN0aXZlQ29zdCArIHJocy5hY3RpdmVDb3N0LAogICAgICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzOiBsaHMuc3VtU3RvcmFnZVJlYWRVbml0cyArIHJocy5zdW1TdG9yYWdlUmVhZFVuaXRzLAogICAgICAgICAgICByZWFkVW5pdHNDb3N0OiBsaHMucmVhZFVuaXRzQ29zdCArIHJocy5yZWFkVW5pdHNDb3N0LAogICAgICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0czogbGhzLnN1bVN0b3JhZ2VXcml0ZVVuaXRzICsgcmhzLnN1bVN0b3JhZ2VXcml0ZVVuaXRzLAogICAgICAgICAgICB3cml0ZVVuaXRzQ29zdDogbGhzLndyaXRlVW5pdHNDb3N0ICsgcmhzLndyaXRlVW5pdHNDb3N0LAogICAgICAgICAgICBzdW1TdG9yYWdlRGVsZXRlczogbGhzLnN1bVN0b3JhZ2VEZWxldGVzICsgcmhzLnN1bVN0b3JhZ2VEZWxldGVzLAogICAgICAgICAgICBkZWxldGVzQ29zdDogbGhzLmRlbGV0ZXNDb3N0ICsgcmhzLmRlbGV0ZXNDb3N0LAogICAgICAgICAgICBzdG9yYWdlR2I6IG9wdHM/LnN0b3JhZ2VHYiwKICAgICAgICAgICAgc3RvcmFnZUNvc3Q6IG9wdHM/LnN0b3JhZ2VDb3N0LAogICAgICAgICAgICB0b3RhbENvc3Q6IGxocy50b3RhbENvc3QgKyByaHMudG90YWxDb3N0ICsgY29tcHV0ZVN0b3JhZ2VDb3N0T25jZSgpCiAgICAgICAgfSkKICAgICk7Cn0KZnVuY3Rpb24gbXVsdGlwbHlSb3cocm93LCBtdWx0aXBsaWVyKSB7CiAgICByZXR1cm4gewogICAgICAgIGRhdGU6ICcnLAogICAgICAgIHN1bVJlcXVlc3RzOiByb3cuc3VtUmVxdWVzdHMgKiBtdWx0aXBsaWVyLAogICAgICAgIHJlcXVlc3RzQ29zdDogcm93LnJlcXVlc3RzQ29zdCAqIG11bHRpcGxpZXIsCiAgICAgICAgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnM6IHJvdy5tYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyAqIG11bHRpcGxpZXIsCiAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50OiByb3cuc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50ICogbXVsdGlwbGllciwKICAgICAgICBzdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50OiByb3cuc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCAqIG11bHRpcGxpZXIsCiAgICAgICAgd2Vic29ja2V0c0Nvc3Q6IHJvdy53ZWJzb2NrZXRzQ29zdCAqIG11bHRpcGxpZXIsCiAgICAgICAgc3VtU3VicmVxdWVzdHM6IHJvdy5zdW1TdWJyZXF1ZXN0cyAqIG11bHRpcGxpZXIsCiAgICAgICAgc3VicmVxdWVzdHNDb3N0OiByb3cuc3VicmVxdWVzdHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1BY3RpdmVUaW1lOiByb3cuc3VtQWN0aXZlVGltZSAqIG11bHRpcGxpZXIsCiAgICAgICAgYWN0aXZlR2JTZWNvbmRzOiByb3cuYWN0aXZlR2JTZWNvbmRzICogbXVsdGlwbGllciwKICAgICAgICBhY3RpdmVDb3N0OiByb3cuYWN0aXZlQ29zdCAqIG11bHRpcGxpZXIsCiAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0czogcm93LnN1bVN0b3JhZ2VSZWFkVW5pdHMgKiBtdWx0aXBsaWVyLAogICAgICAgIHJlYWRVbml0c0Nvc3Q6IHJvdy5yZWFkVW5pdHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0czogcm93LnN1bVN0b3JhZ2VXcml0ZVVuaXRzICogbXVsdGlwbGllciwKICAgICAgICB3cml0ZVVuaXRzQ29zdDogcm93LndyaXRlVW5pdHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1TdG9yYWdlRGVsZXRlczogcm93LnN1bVN0b3JhZ2VEZWxldGVzICogbXVsdGlwbGllciwKICAgICAgICBkZWxldGVzQ29zdDogcm93LmRlbGV0ZXNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdG9yYWdlR2I6IHJvdy5zdG9yYWdlR2IgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHJvdy5zdG9yYWdlR2IgKiBtdWx0aXBsaWVyLAogICAgICAgIHN0b3JhZ2VDb3N0OiByb3cuc3RvcmFnZUNvc3QgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHJvdy5zdG9yYWdlQ29zdCAqIG11bHRpcGxpZXIsCiAgICAgICAgdG90YWxDb3N0OiByb3cudG90YWxDb3N0ICogbXVsdGlwbGllcgogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3cocm93cywgZXhjbHVkZUZyZWVVc2FnZSwgb3B0cykgewogICAgaWYgKHJvd3MubGVuZ3RoIDw9IDEpIHJldHVybiB1bmRlZmluZWQ7CiAgICBjb25zdCBzdW0gPSBjb21wdXRlVG90YWxSb3coJycsIHJvd3Muc2xpY2UoMCwgLTEpLCBvcHRzKTsKICAgIGNvbnN0IGRheXMgPSByb3dzLmxlbmd0aCAtIDE7CiAgICBjb25zdCBlc3RSb3cgPSBtdWx0aXBseVJvdyhzdW0sIDMwIC8gZGF5cyk7CiAgICBjb25zdCB7IHN1bVJlcXVlc3RzICwgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50ICwgc3VtU3VicmVxdWVzdHMgLCBzdW1TdG9yYWdlUmVhZFVuaXRzICwgc3VtU3RvcmFnZVdyaXRlVW5pdHMgLCBzdW1TdG9yYWdlRGVsZXRlcyAsIHN1bUFjdGl2ZVRpbWUgLCBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyAsIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdG9yYWdlR2IgLCBzdG9yYWdlQ29zdCAgfSA9IGVzdFJvdzsKICAgIGNvbnN0IHsgcmVxdWVzdHNDb3N0ICwgd2Vic29ja2V0c0Nvc3QgLCBzdWJyZXF1ZXN0c0Nvc3QgLCBhY3RpdmVDb3N0ICwgcmVhZFVuaXRzQ29zdCAsIHdyaXRlVW5pdHNDb3N0ICwgZGVsZXRlc0Nvc3QgLCB0b3RhbENvc3QgLCBhY3RpdmVHYlNlY29uZHMgLCBuZXdTdG9yYWdlQ29zdCAgfSA9IGNvbXB1dGVDb3N0cyh7CiAgICAgICAgc3VtUmVxdWVzdHMsCiAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgIHN1bVN1YnJlcXVlc3RzLAogICAgICAgIHN1bUFjdGl2ZVRpbWUsCiAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0cywKICAgICAgICBzdW1TdG9yYWdlRGVsZXRlcywKICAgICAgICBleGNsdWRlRnJlZVVzYWdlLAogICAgICAgIHN0b3JhZ2VDb3N0CiAgICB9KTsKICAgIHJldHVybiB7CiAgICAgICAgZGF0ZTogJycsCiAgICAgICAgc3VtUmVxdWVzdHMsCiAgICAgICAgcmVxdWVzdHNDb3N0LAogICAgICAgIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zLAogICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICBzdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgIHdlYnNvY2tldHNDb3N0LAogICAgICAgIHN1bVN1YnJlcXVlc3RzLAogICAgICAgIHN1YnJlcXVlc3RzQ29zdCwKICAgICAgICBzdW1BY3RpdmVUaW1lLAogICAgICAgIGFjdGl2ZUdiU2Vjb25kcywKICAgICAgICBhY3RpdmVDb3N0LAogICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHMsCiAgICAgICAgcmVhZFVuaXRzQ29zdCwKICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0cywKICAgICAgICB3cml0ZVVuaXRzQ29zdCwKICAgICAgICBzdW1TdG9yYWdlRGVsZXRlcywKICAgICAgICBkZWxldGVzQ29zdCwKICAgICAgICBzdG9yYWdlR2IsCiAgICAgICAgc3RvcmFnZUNvc3Q6IG5ld1N0b3JhZ2VDb3N0LAogICAgICAgIHRvdGFsQ29zdAogICAgfTsKfQpmdW5jdGlvbiB1dGNDdXJyZW50RGF0ZSgpIHsKICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3Vic3RyaW5nKDAsIDEwKTsKfQpmdW5jdGlvbiBhZGREYXlzVG9EYXRlKGRhdGUsIGRheXMpIHsKICAgIGNvbnN0IGQgPSBuZXcgRGF0ZShgJHtkYXRlfVQwMDowMDowMFpgKTsKICAgIHJldHVybiBuZXcgRGF0ZShkLmdldEZ1bGxZZWFyKCksIGQuZ2V0TW9udGgoKSwgZC5nZXREYXRlKCkgKyBkYXlzLCBkLmdldEhvdXJzKCksIGQuZ2V0TWludXRlcygpLCBkLmdldFNlY29uZHMoKSwgZC5nZXRNaWxsaXNlY29uZHMoKSkudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMTApOwp9CmNsYXNzIFdlYnRhaWxBcHBWTSB7CiAgICBfcHJvZmlsZXMgPSBbXTsKICAgIGdldCBwcm9maWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnByb2ZpbGVzIDogdGhpcy5fcHJvZmlsZXM7CiAgICB9CiAgICBnZXQgcmVhbFByb2ZpbGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wcm9maWxlczsKICAgIH0KICAgIF9zZWxlY3RlZFByb2ZpbGVJZDsKICAgIGdldCBzZWxlY3RlZFByb2ZpbGVJZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnNlbGVjdGVkUHJvZmlsZUlkIDogdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQ7CiAgICB9CiAgICBzZXQgc2VsZWN0ZWRQcm9maWxlSWQodmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgewogICAgICAgICAgICBEZW1vTW9kZS5zZXRTZWxlY3RlZFByb2ZpbGVJZCh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID09PSB2YWx1ZSkgcmV0dXJuOwogICAgICAgIHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID0gdmFsdWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWQgPSB2YWx1ZTsKICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5maW5kU2NyaXB0cygpOwogICAgfQogICAgX2FuYWx5dGljcyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnZHVyYWJsZS1vYmplY3RzJywKICAgICAgICAgICAgdGV4dDogJ0R1cmFibGUgT2JqZWN0cycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnRGFpbHkgbWV0cmljcyBhbmQgYXNzb2NpYXRlZCBjb3N0cycKICAgICAgICB9CiAgICBdOwogICAgZ2V0IGFuYWx5dGljcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYW5hbHl0aWNzOwogICAgfQogICAgX3NlbGVjdGVkQW5hbHl0aWNJZDsKICAgIGdldCBzZWxlY3RlZEFuYWx5dGljSWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkQW5hbHl0aWNJZDsKICAgIH0KICAgIGFuYWx5dGljc1N0YXRlID0gewogICAgICAgIHF1ZXJ5aW5nOiBmYWxzZQogICAgfTsKICAgIF9zY3JpcHRzID0gW107CiAgICBnZXQgc2NyaXB0cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnNjcmlwdHMgOiB0aGlzLl9zY3JpcHRzOwogICAgfQogICAgX3NlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldCgpOwogICAgZ2V0IHNlbGVjdGVkU2NyaXB0SWRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUuc2VsZWN0ZWRTY3JpcHRJZHMgOiB0aGlzLl9zZWxlY3RlZFNjcmlwdElkczsKICAgIH0KICAgIHNldCBzZWxlY3RlZFNjcmlwdElkcyhzY3JpcHRJZHMpIHsKICAgICAgICBpZiAodGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSB7CiAgICAgICAgICAgIERlbW9Nb2RlLnNldFNlbGVjdGVkU2NyaXB0SWRzKHNjcmlwdElkcyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHNldEVxdWFsKHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzLCBzY3JpcHRJZHMpKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHMgPSBuZXcgU2V0KHNjcmlwdElkcyk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkICYmIHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgaWYgKHByb2ZpbGUpIHsKICAgICAgICAgICAgcHJvZmlsZS5zZWxlY3RlZFNjcmlwdElkcyA9IFsKICAgICAgICAgICAgICAgIC4uLnNjcmlwdElkcwogICAgICAgICAgICBdOwogICAgICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2V0VGFpbHMoKTsKICAgIH0KICAgIHByb2ZpbGVGb3JtID0gbmV3IFByb2ZpbGVGb3JtVk0oKTsKICAgIGZpbHRlckZvcm0gPSBuZXcgRmlsdGVyRm9ybVZNKCk7CiAgICBmaWx0ZXIgPSB7fTsKICAgIGV4dHJhRmllbGRzID0gW107CiAgICBfdGFpbHMgPSBuZXcgU2V0KCk7CiAgICBnZXQgdGFpbHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVtb01vZGUgPyBEZW1vTW9kZS50YWlscyA6IHRoaXMuX3RhaWxzOwogICAgfQogICAgc2V0IHRhaWxzKHRhaWxzKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIERlbW9Nb2RlLnRhaWxzID0gdGFpbHM7CiAgICAgICAgdGhpcy5fdGFpbHMgPSB0YWlsczsKICAgIH0KICAgIHdlbGNvbWVTaG93aW5nID0gZmFsc2U7CiAgICBhYm91dFNob3dpbmcgPSBmYWxzZTsKICAgIHN0YXRlID0gbG9hZFN0YXRlKCk7CiAgICB0YWlsQ29udHJvbGxlcjsKICAgIHRhaWxDb250cm9sbGVyQ2FsbGJhY2tzOwogICAgcXBzQ29udHJvbGxlcjsKICAgIGRlbW9Nb2RlID0gZmFsc2U7CiAgICBvbkNoYW5nZSA9ICgpPT57fTsKICAgIGxvZ2dlciA9ICgpPT57fTsKICAgIG9uUmVzZXRPdXRwdXQgPSAoKT0+e307CiAgICBvblFwc0NoYW5nZSA9ICgpPT57fTsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgICAgY29uc3QgZGlzID0gdGhpczsKICAgICAgICB0aGlzLnFwc0NvbnRyb2xsZXIgPSBuZXcgUXBzQ29udHJvbGxlcigyMCwgewogICAgICAgICAgICBvblFwc0NoYW5nZWQgKHFwcykgewogICAgICAgICAgICAgICAgaWYgKGRpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgZGlzLm9uUXBzQ2hhbmdlKHFwcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjb25zdCBsb2dUYWlsc0NoYW5nZSA9IChhY3Rpb24sIHRhaWxLZXlzKT0+ewogICAgICAgICAgICBpZiAodGFpbEtleXMuc2l6ZSA+IDApIHRoaXMubG9nV2l0aFByZWZpeChgJHthY3Rpb259ICR7WwogICAgICAgICAgICAgICAgLi4udGFpbEtleXMKICAgICAgICAgICAgXS5tYXAoKHYpPT51bnBhY2tUYWlsS2V5KHYpLnNjcmlwdElkCiAgICAgICAgICAgICkuc29ydCgpLmpvaW4oJywgJyl9YCk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBsb2dXaXRoUHJlZml4ID0gdGhpcy5sb2dXaXRoUHJlZml4LmJpbmQodGhpcyk7CiAgICAgICAgY29uc3QgdmVyYm9zZVdpdGhQcmVmaXggPSB0aGlzLnZlcmJvc2VXaXRoUHJlZml4LmJpbmQodGhpcyk7CiAgICAgICAgY29uc3QgY2FsbGJhY2tzID0gewogICAgICAgICAgICBvblRhaWxDcmVhdGluZyAoX2FjY291bnRJZCwgc2NyaXB0SWQpIHsKICAgICAgICAgICAgICAgIHZlcmJvc2VXaXRoUHJlZml4KGBDcmVhdGluZyB0YWlsIGZvciAke3NjcmlwdElkfS4uLmApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDcmVhdGVkIChfYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCkgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENyZWF0ZWQgdGFpbCBmb3IgJHtzY3JpcHRJZH0gaW4gJHt0b29rTWlsbGlzfW1zLCAke0pTT04uc3RyaW5naWZ5KHRhaWwpfWApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uT3BlbiAoX2FjY291bnRJZCwgc2NyaXB0SWQsIF90aW1lU3RhbXAsIHRvb2tNaWxsaXMpIHsKICAgICAgICAgICAgICAgIHZlcmJvc2VXaXRoUHJlZml4KGBPcGVuZWQgdGFpbCBmb3IgJHtzY3JpcHRJZH0gaW4gJHt0b29rTWlsbGlzfW1zYCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25DbG9zZSAoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25UYWlsQ29ubmVjdGlvbkNsb3NlJywgewogICAgICAgICAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgICAgICAgICBzY3JpcHRJZCwKICAgICAgICAgICAgICAgICAgICB0aW1lU3RhbXAsCiAgICAgICAgICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgICAgICAgICByZWFzb24sCiAgICAgICAgICAgICAgICAgICAgd2FzQ2xlYW4KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENsb3NlZCB0YWlsIGZvciAke3NjcmlwdElkfSwgJHtKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgICAgICAgICByZWFzb24sCiAgICAgICAgICAgICAgICAgICAgd2FzQ2xlYW4KICAgICAgICAgICAgICAgIH0pfWApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uRXJyb3IgKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25UYWlsQ29ubmVjdGlvbkVycm9yJywgewogICAgICAgICAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgICAgICAgICBzY3JpcHRJZCwKICAgICAgICAgICAgICAgICAgICB0aW1lU3RhbXAsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JJbmZvCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoYEVycm9yIGluIHRhaWwgZm9yICR7c2NyaXB0SWR9YCwgewogICAgICAgICAgICAgICAgICAgIGVycm9ySW5mbwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25NZXNzYWdlIChfYWNjb3VudElkLCBfc2NyaXB0SWQsIF90aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChjb21wdXRlTWVzc2FnZVBhc3Nlc0ZpbHRlcihtZXNzYWdlLCBkaXMuZmlsdGVyKSkgewogICAgICAgICAgICAgICAgICAgIGR1bXBNZXNzYWdlUHJldHR5KG1lc3NhZ2UsIGRpcy5sb2dnZXIsIGRpcy5jb21wdXRlQWRkaXRpb25hbExvZ3MobWVzc2FnZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgZGlzLnFwc0NvbnRyb2xsZXIuYWRkRXZlbnQobWVzc2FnZS5ldmVudFRpbWVzdGFtcCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UgKF9hY2NvdW50SWQsIHNjcmlwdElkLCBfdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoYFVucGFyc2VkIG1lc3NhZ2UgaW4gdGFpbCBmb3IgJHtzY3JpcHRJZH1gLCBwYXJzZUVycm9yLnN0YWNrIHx8IHBhcnNlRXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbHNDaGFuZ2VkICh0YWlscykgewogICAgICAgICAgICAgICAgaWYgKHNldEVxdWFsKGRpcy50YWlscywgdGFpbHMpKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVkID0gc2V0U3VidHJhY3QoZGlzLnRhaWxzLCB0YWlscyk7CiAgICAgICAgICAgICAgICBsb2dUYWlsc0NoYW5nZSgnVW50YWlsaW5nJywgcmVtb3ZlZCk7CiAgICAgICAgICAgICAgICBjb25zdCBhZGRlZCA9IHNldFN1YnRyYWN0KHRhaWxzLCBkaXMudGFpbHMpOwogICAgICAgICAgICAgICAgbG9nVGFpbHNDaGFuZ2UoJ1RhaWxpbmcnLCBhZGRlZCk7CiAgICAgICAgICAgICAgICBkaXMudGFpbHMgPSB0YWlsczsKICAgICAgICAgICAgICAgIGRpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbk5ldHdvcmtTdGF0dXNDaGFuZ2VkIChvbmxpbmUpIHsKICAgICAgICAgICAgICAgIGlmIChvbmxpbmUpIHsKICAgICAgICAgICAgICAgICAgICBsb2dXaXRoUHJlZml4KCclY09OTElORSVjJywgJ2NvbG9yOiBncmVlbicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsb2dXaXRoUHJlZml4KCclY09GRkxJTkUlYycsICdjb2xvcjogcmVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbEZhaWxlZFRvU3RhcnQgKF9hY2NvdW50SWQsIHNjcmlwdElkLCB0cmlnZ2VyLCBlcnJvcikgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYFRhaWwgZm9yICR7c2NyaXB0SWR9IGZhaWxlZCB0byBzdGFydCAoJHt0cmlnZ2VyfSk6ICR7ZXJyb3IubmFtZX0gJHtlcnJvci5tZXNzYWdlfWApOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25zdCB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzID0gQXBwQ29uc3RhbnRzLldFQlNPQ0tFVF9QSU5HX0lOVEVSVkFMX1NFQ09ORFM7CiAgICAgICAgY29uc3QgaW5hY3RpdmVUYWlsU2Vjb25kcyA9IEFwcENvbnN0YW50cy5JTkFDVElWRV9UQUlMX1NFQ09ORFM7CiAgICAgICAgdGhpcy50YWlsQ29udHJvbGxlciA9IG5ldyBUYWlsQ29udHJvbGxlcihuZXcgU3dpdGNoYWJsZVRhaWxDb250cm9sbGVyQ2FsbGJhY2tzKGNhbGxiYWNrcywgKCk9PiF0aGlzLmRlbW9Nb2RlCiAgICAgICAgKSwgewogICAgICAgICAgICB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzLAogICAgICAgICAgICBpbmFjdGl2ZVRhaWxTZWNvbmRzCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy50YWlsQ29udHJvbGxlckNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICB0aGlzLmV4dHJhRmllbGRzID0gWwogICAgICAgICAgICAuLi50aGlzLnN0YXRlLmV4dHJhRmllbGRzIHx8IFtdCiAgICAgICAgXTsKICAgICAgICB0aGlzLmZpbHRlciA9IHRoaXMuc3RhdGUuZmlsdGVyIHx8IHt9OwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiBmYWxzZQogICAgICAgIH0pOwogICAgfQogICAgc3RhcnQoKSB7CiAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgIHRoaXMucmVjb21wdXRlV2VsY29tZVNob3dpbmcoKTsKICAgICAgICB0aGlzLnBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCk7CiAgICB9CiAgICBuZXdQcm9maWxlKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLndlbGNvbWVTaG93aW5nKSB7fSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCA9IGdlbmVyYXRlVXVpZCgpOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS50aXRsZSA9ICdOZXcgUHJvZmlsZSc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gdGhpcy5fcHJvZmlsZXMubGVuZ3RoID09PSAwID8gJ2RlZmF1bHQnIDogYHByb2ZpbGUke3RoaXMuX3Byb2ZpbGVzLmxlbmd0aCArIDF9YDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSAnJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPSBmYWxzZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFByb2ZpbGUocHJvZmlsZUlkKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdOwogICAgICAgIGlmICghcHJvZmlsZSkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlICR7cHJvZmlsZUlkfSBub3QgZm91bmRgKTsKICAgICAgICB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICBjb25zdCB7IG5hbWUgLCBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5wcm9maWxlSWQgPSBwcm9maWxlSWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnRpdGxlID0gJ0VkaXQgUHJvZmlsZSc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9IGFjY291bnRJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gYXBpVG9rZW47CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZGVsZXRlUHJvZmlsZShwcm9maWxlSWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnZGVsZXRlIHByb2ZpbGUnLCBwcm9maWxlSWQpOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgaWYgKCFwcm9maWxlKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgJHtwcm9maWxlSWR9IG5vdCBmb3VuZGApOwogICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMucmVsb2FkUHJvZmlsZXMoKTsKICAgICAgICB0aGlzLnJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCk7CiAgICAgICAgdGhpcy5wZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpOwogICAgfQogICAgY2FuY2VsUHJvZmlsZSgpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlTmFtZShuYW1lKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVBY2NvdW50SWQoYWNjb3VudElkKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hY2NvdW50SWQgPSBhY2NvdW50SWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlQXBpVG9rZW4oYXBpVG9rZW4pIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gYXBpVG9rZW47CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzYXZlUHJvZmlsZSgpIHsKICAgICAgICBjb25zdCB7IHByb2ZpbGVGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCB7IHByb2ZpbGVJZCAgfSA9IHByb2ZpbGVGb3JtOwogICAgICAgIGNvbnN0IG5ld1Byb2ZpbGUgPSB7CiAgICAgICAgICAgIG5hbWU6IHByb2ZpbGVGb3JtLm5hbWUudHJpbSgpLAogICAgICAgICAgICBhY2NvdW50SWQ6IHByb2ZpbGVGb3JtLmFjY291bnRJZC50cmltKCksCiAgICAgICAgICAgIGFwaVRva2VuOiBwcm9maWxlRm9ybS5hcGlUb2tlbi50cmltKCkKICAgICAgICB9OwogICAgICAgIHRoaXMudHJ5U2F2ZVByb2ZpbGUocHJvZmlsZUlkLCBuZXdQcm9maWxlKTsKICAgIH0KICAgIGVkaXRFdmVudEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0V2ZW50IHR5cGU6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2FsbCcsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQWxsJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2Nyb24nLAogICAgICAgICAgICAgICAgdGV4dDogJ0NST04gdHJpZ2dlcicKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICdodHRwJywKICAgICAgICAgICAgICAgIHRleHQ6ICdIVFRQIHJlcXVlc3QnCiAgICAgICAgICAgIH0sIAogICAgICAgIF07CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpbHRlci5ldmVudDEgPT09ICdodHRwJyA/ICdodHRwJyA6IGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyA/ICdjcm9uJyA6ICdhbGwnOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnQ2hvb3NlIHdoaWNoIHR5cGVzIG9mIGV2ZW50cyB0byBzaG93JzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLmV2ZW50MSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5ldmVudDEgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRDaG9pY2VUZXh0ID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5maW5kKCh2KT0+di5pZCA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlCiAgICAgICAgICAgICkudGV4dDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBFdmVudCB0eXBlIGZpbHRlciBjaGFuZ2VkIHRvOiAke3NlbGVjdGVkQ2hvaWNlVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTdGF0dXNGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdTdGF0dXM6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2FsbCcsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQWxsJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgdGV4dDogJ1N1Y2Nlc3MnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnZXJyb3InLAogICAgICAgICAgICAgICAgdGV4dDogJ0Vycm9yJwogICAgICAgICAgICB9LCAKICAgICAgICBdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnID8gJ3N1Y2Nlc3MnIDogZmlsdGVyLnN0YXR1czEgPT09ICdlcnJvcicgPyAnZXJyb3InIDogJ2FsbCc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdTaG93IGV2ZW50cyB0aGlzIHRoaXMgc3RhdHVzJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLnN0YXR1czEgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc3RhdHVzMSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZENob2ljZVRleHQgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmZpbmQoKHYpPT52LmlkID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUKICAgICAgICAgICAgKS50ZXh0OwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYFN0YXR1cyBmaWx0ZXIgY2hhbmdlZCB0bzogJHtzZWxlY3RlZENob2ljZVRleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0SXBBZGRyZXNzRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBpc1ZhbGlkSXBBZGRyZXNzID0gKGlwQWRkcmVzcyk9PnsKICAgICAgICAgICAgcmV0dXJuIC9eKHNlbGZ8W1xkXC46YS1mXXszLH0pJC8udGVzdChpcEFkZHJlc3MpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY2hlY2tWYWxpZElwQWRkcmVzcyA9IChpcEFkZHJlc3MpPT57CiAgICAgICAgICAgIGlmICghaXNWYWxpZElwQWRkcmVzcyhpcEFkZHJlc3MpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBpcCBhZGRyZXNzOiAke2lwQWRkcmVzc31gKTsKICAgICAgICAgICAgcmV0dXJuIGlwQWRkcmVzczsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVySXBBZGRyZXNzZXNGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYxID0gKGZpZWxkVmFsdWUgfHwgJycpLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHYxID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3QodjEuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKS5tYXAoY2hlY2tWYWxpZElwQWRkcmVzcykpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySXBBZGRyZXNzZXMgPSAoKT0+ewogICAgICAgICAgICByZXR1cm4gZGlzdGluY3QoZmlsdGVyLmlwQWRkcmVzczEgfHwgW10pLmpvaW4oJywgJyk7CiAgICAgICAgfTsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnSVAgYWRkcmVzcyhzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySXBBZGRyZXNzZXMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gYCdzZWxmJyB0byBmaWx0ZXIgeW91ciBvd24gYWRkcmVzcywgY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCBlLmcuIHNlbGYsIDEuMS4xLjFgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJJcEFkZHJlc3Nlc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5pcEFkZHJlc3MxIHx8IFtdKSwgbmV3IFNldChuZXdWYWx1ZSkpKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5pcEFkZHJlc3MxID0gbmV3VmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IG5ld1ZhbHVlLmxlbmd0aCA9PT0gMCA/ICdhbnkgSVAgYWRkcmVzcycgOiBuZXdWYWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYElQIGFkZHJlc3MgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRNZXRob2RGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVyTWV0aG9kc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdjIgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodjIgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2Mi5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpLnRvVXBwZXJDYXNlKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlck1ldGhvZHMgPSAoKT0+ewogICAgICAgICAgICByZXR1cm4gZGlzdGluY3QoZmlsdGVyLm1ldGhvZDEgfHwgW10pLm1hcCgodik9PnYudG9VcHBlckNhc2UoKQogICAgICAgICAgICApLmpvaW4oJywgJyk7CiAgICAgICAgfTsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnSFRUUCBNZXRob2Qocyk6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlck1ldGhvZHMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ2NvbW1hLXNlcGFyYXRlZCBpZiBtdWx0aXBsZSwgZS5nLiBHRVQsIFBPU1QnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJNZXRob2RzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLm1ldGhvZDEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLm1ldGhvZDEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ2FueSBtZXRob2QnIDogbmV3VmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBNZXRob2QgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTYW1wbGluZ1JhdGVGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCBwYXJzZVNhbXBsZVJhdGVGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodiA9PT0gJycpIHJldHVybiAxOwogICAgICAgICAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHYpOwogICAgICAgICAgICBpZiAoIWlzVmFsaWRTYW1wbGluZ1JhdGUobnVtKSkgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJhdGU6ICR7dn1gKTsKICAgICAgICAgICAgcmV0dXJuIG51bTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1NhbXBsaW5nIHJhdGU6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9ICh0eXBlb2YgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPT09ICdudW1iZXInICYmIGlzVmFsaWRTYW1wbGluZ1JhdGUoZmlsdGVyLnNhbXBsaW5nUmF0ZTEpID8gZmlsdGVyLnNhbXBsaW5nUmF0ZTEgOiAxKS50b0ZpeGVkKDIpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnQ2FuIHJhbmdlIGZyb20gMCAoMCUpIHRvIDEgKDEwMCUpJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlU2FtcGxlUmF0ZUZyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gbmV3VmFsdWUpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUgPT09IDEgPyAnbm8gc2FtcGxpbmcnIDogYCR7bmV3VmFsdWV9ICgkeyhuZXdWYWx1ZSAqIDEwMCkudG9GaXhlZCgyKX0lKWA7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU2FtcGxlIHJhdGUgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTZWFyY2hGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdTZWFyY2ggdGV4dDonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyLnNlYXJjaDEgfHwgJyc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdGaWx0ZXIgYnkgYSB0ZXh0IG1hdGNoIGluIGNvbnNvbGUubG9nIG1lc3NhZ2VzJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLnNlYXJjaDEgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc2VhcmNoMSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gKGZpbHRlci5zZWFyY2gxIHx8ICcnKS5sZW5ndGggPT09IDAgPyAnbm8gc2VhcmNoIGZpbHRlcicgOiBgJyR7ZmlsdGVyLnNlYXJjaDF9J2A7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU2VhcmNoIGZpbHRlciBjaGFuZ2VkIHRvOiAke3RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0SGVhZGVyRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBwYXJzZUZpbHRlckhlYWRlcnNGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYzID0gKGZpZWxkVmFsdWUgfHwgJycpLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHYzID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3QodjMuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKQogICAgICAgICAgICApLmZpbHRlcigodik9PnYgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySGVhZGVycyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIuaGVhZGVyMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdIZWFkZXIocyk6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlckhlYWRlcnMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gYCdrZXknLCBvciAna2V5OnF1ZXJ5JywgY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlYDsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlRmlsdGVySGVhZGVyc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5oZWFkZXIxIHx8IFtdKSwgbmV3IFNldChuZXdWYWx1ZSkpKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5oZWFkZXIxID0gbmV3VmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IG5ld1ZhbHVlLmxlbmd0aCA9PT0gMCA/ICdubyBoZWFkZXIgZmlsdGVyJyA6IG5ld1ZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgSGVhZGVyIGZpbHRlciBjaGFuZ2VkIHRvOiAke3RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0TG9ncHJvcEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgcGFyc2VMb2dwcm9wRmlsdGVyc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdjQgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodjQgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2NC5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21Mb2dQcm9wRmlsdGVycyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIubG9ncHJvcDEgfHwgW10pLmpvaW4oJywgJyk7CiAgICAgICAgfTsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnTG9ncHJvcChzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tTG9nUHJvcEZpbHRlcnMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gYCdrZXknLCBvciAna2V5OnZhbHVlJywgY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCB2YWx1ZSBtYXkgaW5jbHVkZSAqYDsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlTG9ncHJvcEZpbHRlcnNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICB0aGlzLnNldExvZ3Byb3BGaWx0ZXIobmV3VmFsdWUpOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2V0TG9ncHJvcEZpbHRlcihsb2dwcm9wRmlsdGVycykgewogICAgICAgIGNvbnN0IHsgZmlsdGVyICB9ID0gdGhpczsKICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIubG9ncHJvcDEgfHwgW10pLCBuZXcgU2V0KGxvZ3Byb3BGaWx0ZXJzKSkpIHJldHVybjsKICAgICAgICBmaWx0ZXIubG9ncHJvcDEgPSBsb2dwcm9wRmlsdGVyczsKICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHRleHQgPSBsb2dwcm9wRmlsdGVycy5sZW5ndGggPT09IDAgPyAnbm8gbG9ncHJvcCBmaWx0ZXInIDogbG9ncHJvcEZpbHRlcnMuam9pbignLCAnKTsKICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYExvZ3Byb3AgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgIH0KICAgIGhhc0FueUZpbHRlcnMoKSB7CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHsgZXZlbnQxICB9ID0gZmlsdGVyOwogICAgICAgIHJldHVybiBjb21wdXRlVGFpbE9wdGlvbnNGb3JGaWx0ZXIoZmlsdGVyKS5maWx0ZXJzLmxlbmd0aCA+IDAgfHwgdHlwZW9mIGV2ZW50MSA9PT0gJ3N0cmluZycgJiYgZXZlbnQxICE9PSAnJyAmJiBldmVudDEgIT09ICdhbGwnOwogICAgfQogICAgcmVzZXRGaWx0ZXJzKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgdGhpcy5maWx0ZXIgPSB7fTsKICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgRmlsdGVycyByZXNldGApOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGNhbmNlbEZpbHRlcigpIHsKICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsRmlsdGVyJyk7CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzYXZlRmlsdGVyKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdzYXZlRmlsdGVyJyk7CiAgICAgICAgY29uc3QgeyBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBmaWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2UgPSAnQ2hlY2tpbmcgZmlsdGVyLi4uJzsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlKCk7CiAgICAgICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9IGBgOwogICAgICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9IGBFcnJvcjogJHtlLm1lc3NhZ2V9YDsKICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICBzZWxlY3RGaWx0ZXJDaG9pY2UoaWQpIHsKICAgICAgICBpZiAodGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPT09IGlkKSByZXR1cm47CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBpZDsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0U2VsZWN0aW9uRmllbGRzKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnQWRkaXRpb25hbCBmaWVsZHM6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IEVYVFJBX0ZJRUxEU19PUFRJT05TOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9ICh0aGlzLmV4dHJhRmllbGRzIHx8IFtdKS5qb2luKCcsJyk7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdTZWxlY3QgYWRkaXRpb25hbCBmaWVsZHMgdG8gc2hvdyBpbiB0aGUgb3V0cHV0JzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZXMgPSBkaXN0aW5jdCgoZmlsdGVyRm9ybS5maWVsZFZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KHRoaXMuZXh0cmFGaWVsZHMgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlcykpKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZXh0cmFGaWVsZHMgPSBuZXdWYWx1ZXM7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgZXh0cmFGaWVsZHNUZXh0ID0gdGhpcy5jb21wdXRlU2VsZWN0aW9uRmllbGRzVGV4dCgpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYE91dHB1dCBmaWVsZHMgY2hhbmdlZCB0bzogJHtleHRyYUZpZWxkc1RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBjb21wdXRlU2VsZWN0aW9uRmllbGRzVGV4dCgpIHsKICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAnc3RhbmRhcmQgZmllbGRzJywKICAgICAgICAgICAgLi4udGhpcy5leHRyYUZpZWxkcy5tYXAoKGlkKT0+RVhUUkFfRklFTERTX09QVElPTlMuZmluZCgodik9PnYuaWQgPT09IGlkCiAgICAgICAgICAgICAgICApPy50ZXh0IHx8IGlkCiAgICAgICAgICAgICkKICAgICAgICBdLmpvaW4oJywgJyk7CiAgICB9CiAgICB0b2dnbGVGaWx0ZXJPcHRpb24oaWQpIHsKICAgICAgICBjb25zdCBleHRyYUZpZWxkcyA9IGRpc3RpbmN0KCh0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSB8fCAnJykuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKQogICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICApKTsKICAgICAgICBjb25zdCBpID0gZXh0cmFGaWVsZHMuaW5kZXhPZihpZCk7CiAgICAgICAgaWYgKGkgPj0gMCkgewogICAgICAgICAgICBleHRyYUZpZWxkcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0cmFGaWVsZHMucHVzaChpZCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpZWxkVmFsdWUgPSBleHRyYUZpZWxkcy5qb2luKCcsJyk7CiAgICAgICAgaWYgKHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlID09PSBmaWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgdGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWVsZFZhbHVlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHRvZ2dsZURlbW9Nb2RlKCkgewogICAgICAgIHRoaXMuc2V0RGVtb01vZGUoIXRoaXMuZGVtb01vZGUpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHJlc2V0T3V0cHV0KCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgdGhpcy5vblJlc2V0T3V0cHV0KCk7CiAgICB9CiAgICBzaG93QWJvdXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmFib3V0U2hvd2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgY2xvc2VBYm91dCgpIHsKICAgICAgICB0aGlzLmFib3V0U2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNob3dBbmFseXRpYyhhbmFseXRpY0lkKSB7CiAgICAgICAgY29uc3QgYW5hbHl0aWMgPSB0aGlzLmFuYWx5dGljcy5maW5kKCh2KT0+di5pZCA9PT0gYW5hbHl0aWNJZAogICAgICAgICk7CiAgICAgICAgaWYgKCFhbmFseXRpYyB8fCBhbmFseXRpYy5pZCA9PT0gdGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgIGlmIChwcm9maWxlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQgPSBhbmFseXRpY0lkOwogICAgICAgIHRoaXMuYW5hbHl0aWNzU3RhdGUucXVlcnlpbmcgPSB0cnVlOwogICAgICAgIHRoaXMuYW5hbHl0aWNzU3RhdGUuZHVyYWJsZU9iamVjdHNDb3N0cyA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLmVycm9yID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICBjb25zdCBjbGllbnQgPSBuZXcgQ2ZHcWxDbGllbnQoewogICAgICAgICAgICBhY2NvdW50SWQsCiAgICAgICAgICAgIGFwaVRva2VuCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5xdWVyeUR1cmFibGVPYmplY3RzQ29zdHMoY2xpZW50KTsKICAgIH0KICAgIHNldERlbW9Nb2RlKGRlbW9Nb2RlKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUgPT09IGRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgdGhpcy5kZW1vTW9kZSA9IGRlbW9Nb2RlOwogICAgICAgIGlmIChkZW1vTW9kZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRW5hYmxlIGRlbW8gbW9kZScpOwogICAgICAgICAgICB0aGlzLm9uUXBzQ2hhbmdlKDEyLjM0KTsKICAgICAgICAgICAgdGhpcy5vblJlc2V0T3V0cHV0KCk7CiAgICAgICAgICAgIERlbW9Nb2RlLmxvZ0Zha2VPdXRwdXQodGhpcy50YWlsQ29udHJvbGxlckNhbGxiYWNrcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0Rpc2FibGUgZGVtbyBtb2RlJyk7CiAgICAgICAgICAgIHRoaXMub25RcHNDaGFuZ2UodGhpcy5xcHNDb250cm9sbGVyLnFwcyk7CiAgICAgICAgICAgIHRoaXMub25SZXNldE91dHB1dCgpOwogICAgICAgIH0KICAgIH0KICAgIGFwcGx5RmlsdGVyKG9wdHMpIHsKICAgICAgICBjb25zdCB7IHNhdmUgIH0gPSBvcHRzOwogICAgICAgIHRoaXMuc3RhdGUuZmlsdGVyID0gdGhpcy5maWx0ZXI7CiAgICAgICAgdGhpcy5zdGF0ZS5leHRyYUZpZWxkcyA9IHRoaXMuZXh0cmFGaWVsZHM7CiAgICAgICAgaWYgKHNhdmUpIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICBjb25zdCB0YWlsT3B0aW9ucyA9IGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcih0aGlzLmZpbHRlcik7CiAgICAgICAgdGhpcy50YWlsQ29udHJvbGxlci5zZXRUYWlsT3B0aW9ucyh0YWlsT3B0aW9ucyk7CiAgICB9CiAgICBsb2dXaXRoUHJlZml4KC4uLmRhdGE1KSB7CiAgICAgICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSk7CiAgICAgICAgaWYgKGRhdGE1Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIGRhdGE1WzBdID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBkYXRhNSA9IFsKICAgICAgICAgICAgICAgIGBbJWMke3RpbWV9JWNdICR7ZGF0YTVbMF19YCwKICAgICAgICAgICAgICAgICdjb2xvcjogZ3JheScsCiAgICAgICAgICAgICAgICAnJywKICAgICAgICAgICAgICAgIC4uLmRhdGE1LnNsaWNlKDEpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMubG9nZ2VyKC4uLmRhdGE1KTsKICAgIH0KICAgIHZlcmJvc2VXaXRoUHJlZml4KG1lc3NhZ2UpIHsKICAgICAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKTsKICAgICAgICB0aGlzLmxvZ2dlcihgWyVjJHt0aW1lfSVjXSAlYyR7bWVzc2FnZX0lY2AsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknKTsKICAgIH0KICAgIHBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCkgewogICAgICAgIGNvbnN0IGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkID0gY29tcHV0ZUluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKHRoaXMuc3RhdGUsIHRoaXMuX3Byb2ZpbGVzKTsKICAgICAgICBpZiAoaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYEluaXRpYWxseSBzZWxlY3RpbmcgcHJvZmlsZTogJHt0aGlzLnN0YXRlLnByb2ZpbGVzW2luaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkXS5uYW1lfWApOwogICAgICAgICAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID0gaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHRyeVNhdmVQcm9maWxlKHByb2ZpbGVJZCwgcHJvZmlsZSkgewogICAgICAgIGNvbnN0IHsgcHJvZmlsZUZvcm0gIH0gPSB0aGlzOwogICAgICAgIHByb2ZpbGVGb3JtLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBwcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPSB0cnVlOwogICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnQ2hlY2tpbmcgcHJvZmlsZS4uLic7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGNhbkxpc3RUYWlscyA9IGF3YWl0IGNvbXB1dGVDYW5MaXN0VGFpbHMocHJvZmlsZS5hY2NvdW50SWQsIHByb2ZpbGUuYXBpVG9rZW4pOwogICAgICAgICAgICBpZiAoY2FuTGlzdFRhaWxzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF0gPSBwcm9maWxlOwogICAgICAgICAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgICAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICcnOwogICAgICAgICAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNvbXB1dGVXZWxjb21lU2hvd2luZygpOwogICAgICAgICAgICAgICAgcHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSBgVGhlc2UgY3JlZGVudGlhbHMgZG8gbm90IGhhdmUgcGVybWlzc2lvbiB0byB0YWlsYDsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9IGBFcnJvcjogJHtlLm1lc3NhZ2V9YDsKICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICBwcm9maWxlRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlbG9hZFByb2ZpbGVzKCkgewogICAgICAgIGNvbnN0IHsgc3RhdGUgIH0gPSB0aGlzOwogICAgICAgIHRoaXMuX3Byb2ZpbGVzLnNwbGljZSgwKTsKICAgICAgICBmb3IgKGNvbnN0IFtwcm9maWxlSWQsIHByb2ZpbGVdIG9mIE9iamVjdC5lbnRyaWVzKHN0YXRlLnByb2ZpbGVzKSl7CiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBwcm9maWxlLm5hbWUgfHwgJyh1bm5hbWVkKSc7CiAgICAgICAgICAgIHRoaXMuX3Byb2ZpbGVzLnB1c2goewogICAgICAgICAgICAgICAgaWQ6IHByb2ZpbGVJZCwKICAgICAgICAgICAgICAgIHRleHQ6IG5hbWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgZmluZFNjcmlwdHMoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICAgICAgaWYgKHByb2ZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICAgICAgdGhpcy52ZXJib3NlV2l0aFByZWZpeChgRmluZGluZyBzY3JpcHRzIGZvciAke3Byb2ZpbGUubmFtZS50b1VwcGVyQ2FzZSgpfS4uLmApOwogICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIGNvbnN0IHNjcmlwdHMgPSBhd2FpdCBsaXN0U2NyaXB0cyhhY2NvdW50SWQsIGFwaVRva2VuKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlbW9Nb2RlKSB0aGlzLnZlcmJvc2VXaXRoUHJlZml4KGBGb3VuZCAke3NjcmlwdHMubGVuZ3RofSBzY3JpcHRzIGluICR7RGF0ZS5ub3coKSAtIHN0YXJ0fW1zYCk7CiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMuc3BsaWNlKDApOwogICAgICAgICAgICBmb3IgKGNvbnN0IHNjcmlwdCBvZiBzY3JpcHRzKXsKICAgICAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IHNjcmlwdC5pZCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBzY3JpcHQuaWQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMuc29ydCgobGhzLCByaHMpPT5saHMudGV4dC5sb2NhbGVDb21wYXJlKHJocy50ZXh0KQogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZFNjcmlwdElkcyA9IHRoaXMuY29tcHV0ZVNlbGVjdGVkU2NyaXB0SWRzQWZ0ZXJGaW5kU2NyaXB0cygpOwogICAgICAgICAgICBpZiAoc2VsZWN0ZWRTY3JpcHRJZHMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRTY3JpcHRJZHMgPSBzZWxlY3RlZFNjcmlwdElkczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuZGVtb01vZGUpIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZW1vTW9kZSkgdGhpcy5sb2dnZXIoYEVycm9yIGluIGZpbmRTY3JpcHRzOiAke2Uuc3RhY2t9YCk7CiAgICAgICAgfQogICAgfQogICAgY29tcHV0ZVNlbGVjdGVkU2NyaXB0SWRzQWZ0ZXJGaW5kU2NyaXB0cygpIHsKICAgICAgICBpZiAodGhpcy5fc2NyaXB0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0luaXRpYWxseSBzZWxlY3Rpbmcgbm8gc2NyaXB0cywgbm8gc2NyaXB0cyB0byBzZWxlY3QnKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkKSB7CiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxQcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICAgICAgaWYgKGluaXRpYWxQcm9maWxlICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY3JpcHRJZHMgPSBuZXcgU2V0KHRoaXMuX3NjcmlwdHMubWFwKCh2KT0+di5pZAogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gc2V0SW50ZXJzZWN0KGN1cnJlbnRTY3JpcHRJZHMsIG5ldyBTZXQoaW5pdGlhbFByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMpKTsKICAgICAgICAgICAgICAgIGlmIChjYW5kaWRhdGVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEluaXRpYWxseSBzZWxlY3Rpbmcgc2NyaXB0JHtjYW5kaWRhdGVzLnNpemUgPT09IDEgPyAnJyA6ICdzJ30gJHtbCiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmNhbmRpZGF0ZXMKICAgICAgICAgICAgICAgICAgICBdLnNvcnQoKS5qb2luKCcsICcpfTogcmVtZW1iZXJlZCBmcm9tIGxhc3QgdGltZWApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYW5kaWRhdGVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpcnN0U2NyaXB0SWQgPSB0aGlzLl9zY3JpcHRzWzBdLmlkOwogICAgICAgIGNvbnNvbGUubG9nKGBJbml0aWFsbHkgc2VsZWN0aW5nIHNjcmlwdCAke2ZpcnN0U2NyaXB0SWR9OiBmaXJzdCBvbmUgaW4gdGhlIGxpc3RgKTsKICAgICAgICByZXR1cm4gbmV3IFNldChbCiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHNbMF0uaWQKICAgICAgICBdKTsKICAgIH0KICAgIGFzeW5jIHNldFRhaWxzKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy50YWlsQ29udHJvbGxlci5zZXRUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuLCB0aGlzLl9zZWxlY3RlZFNjcmlwdElkcyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmxvZ2dlcignRXJyb3IgaW4gc2V0VGFpbHMnLCBlLnN0YWNrIHx8IGUubWVzc2FnZSk7CiAgICAgICAgfQogICAgfQogICAgY29tcHV0ZUFkZGl0aW9uYWxMb2dzKG1lc3NhZ2UpIHsKICAgICAgICBjb25zdCBydCA9IFtdOwogICAgICAgIGNvbnN0IGluY2x1ZGVJcEFkZHJlc3MgPSB0aGlzLmV4dHJhRmllbGRzLmluY2x1ZGVzKCdpcC1hZGRyZXNzJyk7CiAgICAgICAgY29uc3QgaW5jbHVkZVVzZXJBZ2VudCA9IHRoaXMuZXh0cmFGaWVsZHMuaW5jbHVkZXMoJ3VzZXItYWdlbnQnKTsKICAgICAgICBjb25zdCBpbmNsdWRlUmVmZXJlciA9IHRoaXMuZXh0cmFGaWVsZHMuaW5jbHVkZXMoJ3JlZmVyZXInKTsKICAgICAgICBpZiAoaW5jbHVkZUlwQWRkcmVzcyB8fCBpbmNsdWRlVXNlckFnZW50IHx8IGluY2x1ZGVSZWZlcmVyKSB7CiAgICAgICAgICAgIGlmICghaXNUYWlsTWVzc2FnZUNyb25FdmVudChtZXNzYWdlLmV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVJcEFkZHJlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpcEFkZHJlc3MgPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3QuaGVhZGVyc1snY2YtY29ubmVjdGluZy1pcCddIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAoaXBBZGRyZXNzKSBydC5wdXNoKGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZCgnSVAgYWRkcmVzcycsIGlwQWRkcmVzcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVVc2VyQWdlbnQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyQWdlbnQgPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3QuaGVhZGVyc1sndXNlci1hZ2VudCddIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAodXNlckFnZW50KSBydC5wdXNoKGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZCgnVXNlciBhZ2VudCcsIHVzZXJBZ2VudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVSZWZlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlciA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdC5oZWFkZXJzWydyZWZlcmVyJ10gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWZlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZXJVcmwgPSB0cnlQYXJzZVVybChyZWZlcmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxvZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWZlcmVyVXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcXVlc3RVcmwgPSB0cnlQYXJzZVVybChtZXNzYWdlLmV2ZW50LnJlcXVlc3QudXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXF1ZXN0VXJsICYmIHJlcXVlc3RVcmwub3JpZ2luID09PSByZWZlcmVyVXJsLm9yaWdpbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb2cpIHJ0LnB1c2goY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKCdSZWZlcmVyJywgcmVmZXJlcikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICByZWNvbXB1dGVXZWxjb21lU2hvd2luZygpIHsKICAgICAgICBjb25zdCBzaG91bGRTaG93ID0gdGhpcy5wcm9maWxlcy5sZW5ndGggPT09IDA7CiAgICAgICAgaWYgKHNob3VsZFNob3cgPT09IHRoaXMud2VsY29tZVNob3dpbmcpIHJldHVybjsKICAgICAgICB0aGlzLnNldERlbW9Nb2RlKHNob3VsZFNob3cpOwogICAgICAgIHRoaXMud2VsY29tZVNob3dpbmcgPSBzaG91bGRTaG93OwogICAgfQogICAgYXN5bmMgcXVlcnlEdXJhYmxlT2JqZWN0c0Nvc3RzKGNsaWVudCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMuYW5hbHl0aWNzU3RhdGUuZHVyYWJsZU9iamVjdHNDb3N0cyA9IGF3YWl0IGNvbXB1dGVEdXJhYmxlT2JqZWN0c0Nvc3RzVGFibGUoY2xpZW50LCB7CiAgICAgICAgICAgICAgICBsb29rYmFja0RheXM6IDI4CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAodGhpcy5hbmFseXRpY3NTdGF0ZS5kdXJhYmxlT2JqZWN0c0Nvc3RzLmFjY291bnRUYWJsZS5yb3dzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5kdXJhYmxlT2JqZWN0c0Nvc3RzID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBkdXJhYmxlIG9iamVjdCBhbmFseXRpY3MgZm91bmQnKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKGUpOwogICAgICAgICAgICBsZXQgZXJyb3IgPSBgJHtlfWA7CiAgICAgICAgICAgIGlmIChlcnJvci5pbmNsdWRlcygnKGNvZGU9YXV0aHopJykpIHsKICAgICAgICAgICAgICAgIGVycm9yID0gYFRoZSBhdXRoIHRva2VuIGZvciB0aGlzIHByb2ZpbGUgZG9lcyBub3QgaGF2ZSB0aGUgQWNjb3VudCBBbmFseXRpY3M6UmVhZCBwZXJtaXNzaW9uLmA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5lcnJvciA9IGVycm9yOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5xdWVyeWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZChuYW1lLCB2YWx1ZSkgewogICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBbCiAgICAgICAgICAgIGAgJWN8JWMgWyVjJHtuYW1lfSVjXSAke3ZhbHVlfWAsCiAgICAgICAgICAgICdjb2xvcjpncmF5JywKICAgICAgICAgICAgJycsCiAgICAgICAgICAgICdjb2xvcjpncmF5JwogICAgICAgIF0KICAgIH07Cn0KY2xhc3MgUHJvZmlsZUZvcm1WTSB7CiAgICBzaG93aW5nID0gZmFsc2U7CiAgICBlbmFibGVkID0gZmFsc2U7CiAgICBuYW1lID0gJyc7CiAgICBhY2NvdW50SWQgPSAnJzsKICAgIGFwaVRva2VuID0gJyc7CiAgICBkZWxldGVWaXNpYmxlID0gZmFsc2U7CiAgICBzYXZlRW5hYmxlZCA9IGZhbHNlOwogICAgcHJvZmlsZUlkID0gJyc7CiAgICB0aXRsZSA9ICcnOwogICAgcHJvZ3Jlc3NWaXNpYmxlID0gZmFsc2U7CiAgICBvdXRwdXRNZXNzYWdlID0gJyc7CiAgICBjb21wdXRlU2F2ZUVuYWJsZWQoKSB7CiAgICAgICAgdGhpcy5zYXZlRW5hYmxlZCA9IHRoaXMubmFtZS50cmltKCkubGVuZ3RoID4gMCAmJiB0aGlzLmFwaVRva2VuLnRyaW0oKS5sZW5ndGggPiAwICYmIHRoaXMuYWNjb3VudElkLnRyaW0oKS5sZW5ndGggPiAwOwogICAgfQp9CmNsYXNzIEZpbHRlckZvcm1WTSB7CiAgICBzaG93aW5nID0gZmFsc2U7CiAgICBlbmFibGVkID0gZmFsc2U7CiAgICBmaWVsZE5hbWUgPSAnJzsKICAgIGZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICBmaWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgZmllbGRWYWx1ZTsKICAgIGhlbHBUZXh0ID0gJyc7CiAgICBvdXRwdXRNZXNzYWdlID0gJyc7CiAgICBhcHBseVZhbHVlID0gKCk9Pnt9Owp9CmNvbnN0IEVYVFJBX0ZJRUxEU19PUFRJT05TID0gWwogICAgewogICAgICAgIGlkOiAnaXAtYWRkcmVzcycsCiAgICAgICAgdGV4dDogJ0lQIGFkZHJlc3MnCiAgICB9LAogICAgewogICAgICAgIGlkOiAndXNlci1hZ2VudCcsCiAgICAgICAgdGV4dDogJ1VzZXIgYWdlbnQnCiAgICB9LAogICAgewogICAgICAgIGlkOiAncmVmZXJlcicsCiAgICAgICAgdGV4dDogJ1JlZmVyZXInCiAgICB9LCAKXTsKY29uc3QgU1RBVEVfS0VZID0gJ3N0YXRlMSc7CmZ1bmN0aW9uIGxvYWRTdGF0ZSgpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QganNvbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUQVRFX0tFWSkgfHwgdW5kZWZpbmVkOwogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIGNvbnN0IG9iaiA9IEpTT04ucGFyc2UoanNvbik7CiAgICAgICAgICAgIGNvbnN0IHJ0ID0gcGFyc2VTdGF0ZShvYmopOwogICAgICAgICAgICByZXR1cm4gcnQ7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUud2FybignbG9hZFN0YXRlOiBFcnJvciBsb2FkaW5nIHN0YXRlJywgZS5zdGFjayB8fCBlKTsKICAgIH0KICAgIGNvbnNvbGUubG9nKCdsb2FkU3RhdGU6IHJldHVybmluZyBuZXcgc3RhdGUnKTsKICAgIHJldHVybiB7CiAgICAgICAgcHJvZmlsZXM6IHt9CiAgICB9Owp9CmZ1bmN0aW9uIHBhcnNlU3RhdGUocGFyc2VkKSB7CiAgICBpZiAodHlwZW9mIHBhcnNlZCAhPT0gJ29iamVjdCcpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgb2JqZWN0YCk7CiAgICBjb25zdCB7IHByb2ZpbGVzICB9ID0gcGFyc2VkOwogICAgaWYgKHR5cGVvZiBwcm9maWxlcyAhPT0gJ29iamVjdCcpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgcHJvZmlsZXMgb2JqZWN0YCk7CiAgICBmb3IgKGNvbnN0IFtwcm9maWxlSWQsIHByb2ZpbGVTdGF0ZV0gb2YgT2JqZWN0LmVudHJpZXMocHJvZmlsZXMpKXsKICAgICAgICBpZiAodHlwZW9mIHByb2ZpbGVJZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcignUHJvZmlsZSBpZCBtdXN0IGJlIHN0cmluZycpOwogICAgICAgIHBhcnNlUHJvZmlsZVN0YXRlKHByb2ZpbGVTdGF0ZSk7CiAgICB9CiAgICByZXR1cm4gcGFyc2VkOwp9CmZ1bmN0aW9uIHBhcnNlUHJvZmlsZVN0YXRlKHBhcnNlZCkgewogICAgaWYgKHR5cGVvZiBwYXJzZWQgIT09ICdvYmplY3QnIHx8IHBhcnNlZCA9PT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdQcm9maWxlIHN0YXRlIG11c3QgYmUgb2JqZWN0Jyk7CiAgICBjb25zdCB7IG5hbWUgLCBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHBhcnNlZDsKICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycgfHwgbmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgbmFtZSBtdXN0IGV4aXN0YCk7CiAgICBpZiAodHlwZW9mIGFjY291bnRJZCAhPT0gJ3N0cmluZycgfHwgYWNjb3VudElkLnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBhY2NvdW50SWQgbXVzdCBleGlzdGApOwogICAgaWYgKHR5cGVvZiBhcGlUb2tlbiAhPT0gJ3N0cmluZycgfHwgYXBpVG9rZW4udHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIGFwaVRva2VuIG11c3QgZXhpc3RgKTsKICAgIHJldHVybiBwYXJzZWQ7Cn0KZnVuY3Rpb24gc2F2ZVN0YXRlKHN0YXRlKSB7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShTVEFURV9LRVksIEpTT04uc3RyaW5naWZ5KHN0YXRlKSk7Cn0KYXN5bmMgZnVuY3Rpb24gY29tcHV0ZUNhbkxpc3RUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuKSB7CiAgICB0cnkgewogICAgICAgIGF3YWl0IGxpc3RUYWlscyhhY2NvdW50SWQsICcnLCBhcGlUb2tlbik7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBDbG91ZGZsYXJlQXBpRXJyb3IgJiYgZS5zdGF0dXMgPT09IDQwNCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2Uge30KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KZnVuY3Rpb24gaXNWYWxpZFNhbXBsaW5nUmF0ZShzYW1wbGluZ1JhdGUpIHsKICAgIHJldHVybiAhaXNOYU4oc2FtcGxpbmdSYXRlKSAmJiBzYW1wbGluZ1JhdGUgPj0gMCAmJiBzYW1wbGluZ1JhdGUgPD0gMTsKfQpmdW5jdGlvbiBjb21wdXRlSW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQoc3RhdGUsIHByb2ZpbGVzKSB7CiAgICBpZiAoc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWQgJiYgc3RhdGUucHJvZmlsZXNbc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWRdKSByZXR1cm4gc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWQ7CiAgICBpZiAocHJvZmlsZXMubGVuZ3RoID4gMCkgcmV0dXJuIHByb2ZpbGVzWzBdLmlkOwogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBjb21wdXRlVGFpbE9wdGlvbnNGb3JGaWx0ZXIoZmlsdGVyKSB7CiAgICBjb25zdCBmaWx0ZXJzID0gW107CiAgICBpZiAoZmlsdGVyLnN0YXR1czEgPT09ICdlcnJvcicpIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBvdXRjb21lOiBbCiAgICAgICAgICAgICAgICAnZXhjZXB0aW9uJywKICAgICAgICAgICAgICAgICdleGNlZWRlZENwdScsCiAgICAgICAgICAgICAgICAnY2FuY2VsZWQnLAogICAgICAgICAgICAgICAgJ3Vua25vd24nCiAgICAgICAgICAgIF0KICAgICAgICB9KTsKICAgIH0gZWxzZSBpZiAoZmlsdGVyLnN0YXR1czEgPT09ICdzdWNjZXNzJykgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIG91dGNvbWU6IFsKICAgICAgICAgICAgICAgICdvaycKICAgICAgICAgICAgXQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5zYW1wbGluZ1JhdGUxICE9PSB1bmRlZmluZWQgJiYgaXNWYWxpZFNhbXBsaW5nUmF0ZShmaWx0ZXIuc2FtcGxpbmdSYXRlMSkgJiYgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPCAxKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgc2FtcGxpbmdfcmF0ZTogZmlsdGVyLnNhbXBsaW5nUmF0ZTEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuc2VhcmNoMSAhPT0gdW5kZWZpbmVkICYmIGZpbHRlci5zZWFyY2gxLmxlbmd0aCA+IDApIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBxdWVyeTogZmlsdGVyLnNlYXJjaDEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIubWV0aG9kMSAmJiBmaWx0ZXIubWV0aG9kMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgbWV0aG9kOiBmaWx0ZXIubWV0aG9kMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5pcEFkZHJlc3MxICYmIGZpbHRlci5pcEFkZHJlc3MxLmxlbmd0aCA+IDApIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBjbGllbnRfaXA6IGZpbHRlci5pcEFkZHJlc3MxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLmhlYWRlcjEgJiYgZmlsdGVyLmhlYWRlcjEubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoY29uc3QgaGVhZGVyIG9mIGZpbHRlci5oZWFkZXIxKXsKICAgICAgICAgICAgZmlsdGVycy5wdXNoKHBhcnNlSGVhZGVyRmlsdGVyKGhlYWRlcikpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgZmlsdGVycwogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlTWVzc2FnZVBhc3Nlc0ZpbHRlcihtZXNzYWdlLCBmaWx0ZXIpIHsKICAgIGlmICghY29tcHV0ZU1lc3NhZ2VQYXNzZXNMb2dQcm9wRmlsdGVyKG1lc3NhZ2UsIGZpbHRlci5sb2dwcm9wMSkpIHJldHVybiBmYWxzZTsKICAgIGlmIChmaWx0ZXIuZXZlbnQxID09PSAnY3JvbicgfHwgZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnKSB7CiAgICAgICAgY29uc3QgaXNDcm9uID0gaXNUYWlsTWVzc2FnZUNyb25FdmVudChtZXNzYWdlKTsKICAgICAgICByZXR1cm4gaXNDcm9uICYmIGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyB8fCAhaXNDcm9uICYmIGZpbHRlci5ldmVudDEgPT09ICdodHRwJzsKICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIGNvbXB1dGVNZXNzYWdlUGFzc2VzTG9nUHJvcEZpbHRlcihtZXNzYWdlLCBsb2dwcm9wMSkgewogICAgaWYgKGxvZ3Byb3AxID09PSB1bmRlZmluZWQgfHwgbG9ncHJvcDEubGVuZ3RoID09PSAwKSByZXR1cm4gdHJ1ZTsKICAgIGNvbnN0IGxvZ3Byb3BGaWx0ZXJzID0gbG9ncHJvcDEubWFwKHBhcnNlSGVhZGVyRmlsdGVyKTsKICAgIGNvbnN0IHsgcHJvcHMgIH0gPSBwYXJzZUxvZ1Byb3BzKG1lc3NhZ2UubG9ncyk7CiAgICBmb3IgKGNvbnN0IGxvZ3Byb3BGaWx0ZXIgb2YgbG9ncHJvcEZpbHRlcnMpewogICAgICAgIGlmIChjb21wdXRlUHJvcHNQYXNzTG9ncHJvcEZpbHRlcihwcm9wcywgbG9ncHJvcEZpbHRlcikpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGNvbXB1dGVQcm9wc1Bhc3NMb2dwcm9wRmlsdGVyKHByb3BzLCBsb2dwcm9wRmlsdGVyKSB7CiAgICBjb25zdCB2YWwgPSBwcm9wc1tsb2dwcm9wRmlsdGVyLmtleV07CiAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsKICAgIGlmIChsb2dwcm9wRmlsdGVyLnF1ZXJ5ID09PSB1bmRlZmluZWQpIHJldHVybiB0cnVlOwogICAgY29uc3QgcSA9IGxvZ3Byb3BGaWx0ZXIucXVlcnkudHJpbSgpLnJlcGxhY2VBbGwoL1wqKy9nLCAnKicpOwogICAgaWYgKCFxLmluY2x1ZGVzKCcqJykpIHJldHVybiBxID09PSB2YWw7CiAgICBpZiAocSA9PT0gJyonKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0eXBlb2YgdmFsICE9PSAnc3RyaW5nJykgcmV0dXJuIGZhbHNlOwogICAgY29uc3QgcGF0dGVybiA9ICdeJyArIGVzY2FwZUZvclJlZ2V4KHEpLnJlcGxhY2VBbGwoJ1xcKicsICcuKicpICsgJyQnOwogICAgcmV0dXJuIG5ldyBSZWdFeHAocGF0dGVybikudGVzdCh2YWwpOwp9CmZ1bmN0aW9uIGVzY2FwZUZvclJlZ2V4KHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bLVwvXFxeJCorPy4oKXxbXF17fV0vZywgJ1xcJCYnKTsKfQpmdW5jdGlvbiBkaXN0aW5jdCh2YWx1ZXMpIHsKICAgIGNvbnN0IHJ0ID0gW107CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcyl7CiAgICAgICAgaWYgKCFydC5pbmNsdWRlcyh2YWx1ZSkpIHsKICAgICAgICAgICAgcnQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHRyeVBhcnNlVXJsKHVybCkgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gbmV3IFVSTCh1cmwpOwogICAgfSBjYXRjaCAgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9Cn0KY29uc3QgRklMVEVSX0VESVRPUl9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9ImZpbHRlci1mb3JtIiBhdXRvY29tcGxldGU9Im9mZiI+CjxmaWVsZHNldCBpZD0iZmlsdGVyLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS10aXRsZSIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCBmb3JtLXJvdyI+RWRpdCBmaWx0ZXI8L2Rpdj4KCiAgPGxhYmVsIGlkPSJmaWx0ZXItZmllbGQtbGFiZWwiPkZpbHRlciBmaWVsZDo8L2xhYmVsPgogIDxpbnB1dCBpZD0iZmlsdGVyLWZpZWxkLXRleHQiIHR5cGU9InRleHQiPgogIDxkaXYgaWQ9ImZpbHRlci1maWVsZC1jaG9pY2UiPjwvZGl2PgogIDxkaXYgaWQ9ImZpbHRlci1maWVsZC1vcHRpb25zIj48L2Rpdj4KCiAgPGRpdiBpZD0iZmlsdGVyLWZvcm0taGVscCIgY2xhc3M9ImJvZHkyIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij4KICA8L2Rpdj4gIAoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1vdXRwdXQtcm93IiBjbGFzcz0iZm9ybS1yb3ciPgogICAgPG91dHB1dCBpZD0iZmlsdGVyLWZvcm0tb3V0cHV0Ij48L291dHB1dD4KICA8L2Rpdj4KCiAgPGRpdiBpZD0iZmlsdGVyLWZvcm0tYnV0dG9ucyIgY2xhc3M9ImZvcm0tcmhzIj4KICAgIDxidXR0b24gaWQ9ImZpbHRlci1hcHBseSIgdHlwZT0ic3VibWl0Ij5BcHBseTwvYnV0dG9uPjwhLS0gZmlyc3Qgc28gaXQgaXMgZGVmYXVsdCBidXR0b24gb24gcmV0dXJuIC0tPgogICAgPGJ1dHRvbiBpZD0iZmlsdGVyLWNhbmNlbCI+Q2FuY2VsPC9idXR0b24+CiAgPC9kaXY+CjwvZmllbGRzZXQ+CjwvZm9ybT4KYDsKY29uc3QgRklMVEVSX0VESVRPUl9DU1MgPSBjc3NgCgogICAgI2ZpbHRlci1mb3JtLWJ1dHRvbnMgewogICAgICAgIGp1c3RpZnktc2VsZjogZW5kOwogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZmxleC1kaXJlY3Rpb246IHJvdy1yZXZlcnNlOwogICAgICAgIGdhcDogMXJlbTsKICAgIH0KCiAgICAjZmlsdGVyLWZpZWxkLWNob2ljZSB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBnYXA6IDFweDsKICAgIH0KCiAgICAjZmlsdGVyLWZpZWxkLW9wdGlvbnMgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZmxleC13cmFwOiB3cmFwOwogICAgICAgIGdhcDogMXB4OwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtb3B0aW9ucyBidXR0b24gewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBnYXA6IDAuNXJlbTsKICAgIH0KCiAgICAjZmlsdGVyLWZvcm0taGVscCB7CiAgICAgICAgZ3JpZC1jb2x1bW46IDI7CiAgICB9CgogICAgI2ZpbHRlci1mb3JtLW91dHB1dC1yb3cgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBnYXA6IDFyZW07CiAgICAgICAgbWluLWhlaWdodDogMi41cmVtOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1vdXRwdXQtcm93IG91dHB1dCB7CiAgICAgICAgZmxleC1ncm93OiAxOwogICAgfQoKYDsKZnVuY3Rpb24gaW5pdEZpbHRlckVkaXRvcihkb2N1bWVudCwgdm03KSB7CiAgICBjb25zdCBmaWx0ZXJGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGRzZXQnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkTGFiZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWxhYmVsJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZFRleHRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtdGV4dCcpOwogICAgY29uc3QgZmlsdGVyRmllbGRDaG9pY2VEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWNob2ljZScpOwogICAgY29uc3QgZmlsdGVyRmllbGRPcHRpb25zRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZC1vcHRpb25zJyk7CiAgICBjb25zdCBmaWx0ZXJDYW5jZWxCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWNhbmNlbCcpOwogICAgY29uc3QgZmlsdGVyQXBwbHlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWFwcGx5Jyk7CiAgICBjb25zdCBmaWx0ZXJGb3JtT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtLW91dHB1dCcpOwogICAgY29uc3QgZmlsdGVyRm9ybUhlbHBEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZvcm0taGVscCcpOwogICAgZmlsdGVyQ2FuY2VsQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm03LmNhbmNlbEZpbHRlcigpOwogICAgfTsKICAgIGZpbHRlckFwcGx5QnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgY29uc3QgdHlwZSA9IGNvbXB1dGVUeXBlKHZtNyk7CiAgICAgICAgaWYgKHR5cGUgPT09ICd0ZXh0JykgewogICAgICAgICAgICB2bTcuZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyRmllbGRUZXh0SW5wdXQudmFsdWU7CiAgICAgICAgfQogICAgICAgIHZtNy5zYXZlRmlsdGVyKCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gZmlsdGVyRm9ybS5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7CiAgICAgICAgZmlsdGVyRm9ybS5zdHlsZS5kaXNwbGF5ID0gdm03LmZpbHRlckZvcm0uc2hvd2luZyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgZmlsdGVyRmllbGRzZXQuZGlzYWJsZWQgPSAhdm03LmZpbHRlckZvcm0uZW5hYmxlZDsKICAgICAgICBjb25zdCB0eXBlID0gY29tcHV0ZVR5cGUodm03KTsKICAgICAgICBmaWx0ZXJGaWVsZExhYmVsLnRleHRDb250ZW50ID0gdm03LmZpbHRlckZvcm0uZmllbGROYW1lOwogICAgICAgIGZpbHRlckZpZWxkTGFiZWwuaHRtbEZvciA9IHR5cGUgPT0gJ2Nob2ljZScgPyBmaWx0ZXJGaWVsZENob2ljZURpdi5pZCA6IHR5cGUgPT0gJ29wdGlvbnMnID8gZmlsdGVyRmllbGRPcHRpb25zRGl2LmlkIDogZmlsdGVyRmllbGRUZXh0SW5wdXQuaWQ7CiAgICAgICAgZmlsdGVyRmllbGRUZXh0SW5wdXQuc3R5bGUuZGlzcGxheSA9IHR5cGUgPT0gJ3RleHQnID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBmaWx0ZXJGaWVsZENob2ljZURpdi5zdHlsZS5kaXNwbGF5ID0gdHlwZSA9PSAnY2hvaWNlJyA/ICdmbGV4JyA6ICdub25lJzsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihDSE9JQ0VTX0hUTUwodm03KSwgZmlsdGVyRmllbGRDaG9pY2VEaXYpOwogICAgICAgIGZpbHRlckZpZWxkT3B0aW9uc0Rpdi5zdHlsZS5kaXNwbGF5ID0gdHlwZSA9PSAnb3B0aW9ucycgPyAnZmxleCcgOiAnbm9uZSc7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoT1BUSU9OU19IVE1MKHZtNyksIGZpbHRlckZpZWxkT3B0aW9uc0Rpdik7CiAgICAgICAgZmlsdGVyRm9ybUhlbHBEaXYudGV4dENvbnRlbnQgPSB2bTcuZmlsdGVyRm9ybS5oZWxwVGV4dDsKICAgICAgICBmaWx0ZXJGb3JtT3V0cHV0LnRleHRDb250ZW50ID0gdm03LmZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZTsKICAgICAgICBpZiAod2FzSGlkZGVuICYmIHZtNy5maWx0ZXJGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2ZpbHRlciBmb3JtIG9wZW4nKTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd0ZXh0JyAmJiB2bTcuZmlsdGVyRm9ybS5maWVsZFZhbHVlKSBmaWx0ZXJGaWVsZFRleHRJbnB1dC52YWx1ZSA9IHZtNy5maWx0ZXJGb3JtLmZpZWxkVmFsdWU7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIGZpbHRlckZpZWxkVGV4dElucHV0LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5zZWxlY3QoKTsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgfQogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlVHlwZSh2bTgpIHsKICAgIHJldHVybiB2bTguZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5sZW5ndGggPiAwID8gJ2Nob2ljZScgOiB2bTguZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucy5sZW5ndGggPyAnb3B0aW9ucycgOiAndGV4dCc7Cn0KY29uc3QgQ0hPSUNFU19IVE1MID0gKHZtOSk9PnsKICAgIHJldHVybiB2bTkuZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5tYXAoKGNob2ljZSk9Pmh0bWxgPGJ1dHRvbiBjbGFzcz0iJHtjaG9pY2UuaWQgPT09IHZtOS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2bTkuc2VsZWN0RmlsdGVyQ2hvaWNlKGNob2ljZS5pZCk7CiAgICAgICAgfX0gP2Rpc2FibGVkPSIkeyF2bTkuZmlsdGVyRm9ybS5zaG93aW5nfSI+JHtjaG9pY2UudGV4dH08L2J1dHRvbj5gCiAgICApOwp9Owpjb25zdCBPUFRJT05TX0hUTUwgPSAodm0xMCk9PnsKICAgIHJldHVybiB2bTEwLmZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMubWFwKChvcHRpb24pPT57CiAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSBmaWVsZFZhbHVlU2V0KHZtMTApLmhhcyhvcHRpb24uaWQpOwogICAgICAgIHJldHVybiBodG1sYDxidXR0b24gY2xhc3M9IiR7c2VsZWN0ZWQgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2bTEwLnRvZ2dsZUZpbHRlck9wdGlvbihvcHRpb24uaWQpOwogICAgICAgIH19ID9kaXNhYmxlZD0iJHshdm0xMC5maWx0ZXJGb3JtLnNob3dpbmd9Ij4ke3NlbGVjdGVkID8gQ0hFQ0tfQk9YX0NIRUNLRURfSUNPTiA6IENIRUNLX0JPWF9VTkNIRUNLRURfSUNPTn0gJHtvcHRpb24udGV4dH08L2J1dHRvbj5gOwogICAgfSk7Cn07CmZ1bmN0aW9uIGZpZWxkVmFsdWVTZXQodm0xMSkgewogICAgcmV0dXJuIG5ldyBTZXQoKHZtMTEuZmlsdGVyRm9ybS5maWVsZFZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICApLmZpbHRlcigodik9PnYubGVuZ3RoID4gMAogICAgKSk7Cn0KY29uc3QgUFJPRklMRV9FRElUT1JfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJwcm9maWxlLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJwcm9maWxlLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQgZm9ybS1yb3ciPlByb2ZpbGU8L2Rpdj4KCiAgPGxhYmVsIGZvcj0icHJvZmlsZS1uYW1lIj5Qcm9maWxlIG5hbWU6PC9sYWJlbD4KICA8aW5wdXQgaWQ9InByb2ZpbGUtbmFtZSIgdHlwZT0idGV4dCI+CgogIDxsYWJlbCBmb3I9ImFjY291bnQtaWQiPkNsb3VkZmxhcmUgQWNjb3VudCBJRDo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hY2NvdW50LWlkIiB0eXBlPSJ0ZXh0Ij4KCiAgPGxhYmVsIGZvcj0iYXBpLXRva2VuIj5DbG91ZGZsYXJlIEFQSSBUb2tlbjo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hcGktdG9rZW4iIHR5cGU9InRleHQiPgoKICA8ZGV0YWlscyBpZD0icHJvZmlsZS1mb3JtLWhlbHAtcm93IiBjbGFzcz0iZm9ybS1yb3ciPgogICAgPHN1bW1hcnk+VXNlIGEgPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJpbmNpcGxlX29mX2xlYXN0X3ByaXZpbGVnZSIgdGFyZ2V0PSJfYmxhbmsiPmxlYXN0IHByaXZpbGVnZTwvYT4gdG9rZW4gd2l0aCBwZXJtaXNzaW9uOiA8Y29kZT5BY2NvdW50ICZndDsgV29ya2VycyBUYWlsICZndDsgUmVhZDwvY29kZT48L3N1bW1hcnk+CiAgICA8b2w+CiAgICAgICAgPGxpPlNlbGVjdCA8c3BhbiBjbGFzcz0iY2YtYnV0dG9uIj5DcmVhdGUgVG9rZW48L3NwYW4+IG9uIHlvdXIgQ2xvdWRmbGFyZSA8YSBocmVmPSJodHRwczovL2Rhc2guY2xvdWRmbGFyZS5jb20vcHJvZmlsZS9hcGktdG9rZW5zIiB0YXJnZXQ9Il9ibGFuayI+QVBJIFRva2VuczwvYT4gcGFnZS48L2xpPgogICAgICAgIDxsaT5TY3JvbGwgZG93biB0byA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+Q3JlYXRlIEN1c3RvbSBUb2tlbjwvc3Bhbj4sIHRoZW4gPHNwYW4gY2xhc3M9ImNmLWJ1dHRvbiI+R2V0IHN0YXJ0ZWQ8L3NwYW4+PC9saT4KICAgICAgICA8bGk+VW5kZXIgPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPlBlcm1pc3Npb25zPC9zcGFuPiwgZ3JhbnQgeW91ciB0b2tlbiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+QWNjb3VudDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPldvcmtlcnMgVGFpbDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPlJlYWQ8L3NwYW4+PC9saT4KICAgICAgICA8bGk+QWxzbyAoZm9yIGFuYWx5dGljcyksIGdyYW50IHlvdXIgdG9rZW4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPkFjY291bnQ8L3NwYW4+IDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5BY2NvdW50IEFuYWx5dGljczwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPlJlYWQ8L3NwYW4+PC9saT4KICAgICAgICA8bGk+QWxzbyAoZm9yIERPIG5hbWVzKSwgZ3JhbnQgeW91ciB0b2tlbiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+QWNjb3VudDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPldvcmtlciBTY3JpcHRzPC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UmVhZDwvc3Bhbj48L2xpPgogICAgPC9vbD4KICA8L2RldGFpbHM+ICAKCiAgPGRpdiBpZD0icHJvZmlsZS1mb3JtLW91dHB1dC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8b3V0cHV0IGlkPSJwcm9maWxlLWZvcm0tb3V0cHV0Ij48L291dHB1dD4KICAgIDxwcm9ncmVzcyBpZD0icHJvZmlsZS1mb3JtLXByb2dyZXNzIiBjbGFzcz0icHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciI+PC9wcm9ncmVzcz4KICA8L2Rpdj4KCiAgPGRpdiBjbGFzcz0iZm9ybS1saHMiPgogICAgPGJ1dHRvbiBpZD0icHJvZmlsZS1kZWxldGUiPkRlbGV0ZTwvYnV0dG9uPgogIDwvZGl2PgogIDxkaXYgaWQ9InByb2ZpbGUtZm9ybS1idXR0b25zIiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0icHJvZmlsZS1jYW5jZWwiPkNhbmNlbDwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0icHJvZmlsZS1zYXZlIj5TYXZlPC9idXR0b24+CiAgPC9kaXY+CjwvZmllbGRzZXQ+CjwvZm9ybT4KYDsKY29uc3QgUFJPRklMRV9FRElUT1JfQ1NTID0gY3NzYAoKICAgICNwcm9maWxlLWZvcm0tYnV0dG9ucyB7CiAgICAgICAganVzdGlmeS1zZWxmOiBlbmQ7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBnYXA6IDFyZW07CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyB7CiAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgc3VtbWFyeSB7CiAgICAgICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBvbCB7CiAgICAgICAgY3Vyc29yOiBkZWZhdWx0OwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgbGkgewogICAgICAgIHBhZGRpbmc6IDAuNXJlbSAwOwogICAgfQoKICAgIC5jZi1idXR0b24gewogICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiBibHVlOwogICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICBwYWRkaW5nOiAwLjI1cmVtIDAuNXJlbTsKICAgICAgICBib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogICAgfQoKICAgIC5jZi1zZWN0aW9uIHsKICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7CiAgICAgICAgY29sb3I6IGJsYWNrOwogICAgICAgIHBhZGRpbmc6IDAuMjVyZW0gMC41cmVtOwogICAgICAgIG91dGxpbmU6IHNvbGlkIDFweCBncmF5OwogICAgfQoKICAgICNwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMXJlbTsKICAgICAgICBtaW4taGVpZ2h0OiAyLjVyZW07CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1vdXRwdXQtcm93IG91dHB1dCB7CiAgICAgICAgZmxleC1ncm93OiAxOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0tcHJvZ3Jlc3MgewogICAgICAgIGZvbnQtc2l6ZTogMC41cmVtOyAvKiBkZWZhdWx0IDNlbSA9PiAxLjVyZW0gKi8KICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRQcm9maWxlRWRpdG9yKGRvY3VtZW50LCB2bTEyKSB7CiAgICBjb25zdCBwcm9maWxlRm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0nKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtVGl0bGVEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLXRpdGxlJyk7CiAgICBjb25zdCBwcm9maWxlRmllbGRzZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1maWVsZHNldCcpOwogICAgY29uc3QgcHJvZmlsZU5hbWVJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLW5hbWUnKTsKICAgIGNvbnN0IHByb2ZpbGVBY2NvdW50SWRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFjY291bnQtaWQnKTsKICAgIGNvbnN0IHByb2ZpbGVBcGlUb2tlbklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtYXBpLXRva2VuJyk7CiAgICBjb25zdCBwcm9maWxlRGVsZXRlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZGVsZXRlJyk7CiAgICBjb25zdCBwcm9maWxlQ2FuY2VsQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtY2FuY2VsJyk7CiAgICBjb25zdCBwcm9maWxlU2F2ZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLXNhdmUnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtUHJvZ3Jlc3MgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLXByb2dyZXNzJyk7CiAgICBjb25zdCBwcm9maWxlRm9ybU91dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tb3V0cHV0Jyk7CiAgICBjb25zdCBwcm9maWxlRm9ybUhlbHBEZXRhaWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1oZWxwLXJvdycpOwogICAgcHJvZmlsZUNhbmNlbEJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTIuY2FuY2VsUHJvZmlsZSgpOwogICAgfTsKICAgIHByb2ZpbGVOYW1lSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0xMi5zZXRQcm9maWxlTmFtZShwcm9maWxlTmFtZUlucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlQWNjb3VudElkSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0xMi5zZXRQcm9maWxlQWNjb3VudElkKHByb2ZpbGVBY2NvdW50SWRJbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZUFwaVRva2VuSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0xMi5zZXRQcm9maWxlQXBpVG9rZW4ocHJvZmlsZUFwaVRva2VuSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVTYXZlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xMi5zYXZlUHJvZmlsZSgpOwogICAgfTsKICAgIHByb2ZpbGVEZWxldGVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTEyLmRlbGV0ZVByb2ZpbGUodm0xMi5wcm9maWxlRm9ybS5wcm9maWxlSWQpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0hpZGRlbiA9IHByb2ZpbGVGb3JtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJzsKICAgICAgICBwcm9maWxlRm9ybS5zdHlsZS5kaXNwbGF5ID0gdm0xMi5wcm9maWxlRm9ybS5zaG93aW5nID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBwcm9maWxlRmllbGRzZXQuZGlzYWJsZWQgPSAhdm0xMi5wcm9maWxlRm9ybS5lbmFibGVkOwogICAgICAgIHByb2ZpbGVGb3JtVGl0bGVEaXYudGV4dENvbnRlbnQgPSB2bTEyLnByb2ZpbGVGb3JtLnRpdGxlOwogICAgICAgIHByb2ZpbGVOYW1lSW5wdXQudmFsdWUgPSB2bTEyLnByb2ZpbGVGb3JtLm5hbWU7CiAgICAgICAgcHJvZmlsZUFjY291bnRJZElucHV0LnZhbHVlID0gdm0xMi5wcm9maWxlRm9ybS5hY2NvdW50SWQ7CiAgICAgICAgcHJvZmlsZUFwaVRva2VuSW5wdXQudmFsdWUgPSB2bTEyLnByb2ZpbGVGb3JtLmFwaVRva2VuOwogICAgICAgIHByb2ZpbGVEZWxldGVCdXR0b24uc3R5bGUuZGlzcGxheSA9IHZtMTIucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA/ICdpbmxpbmUtYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVTYXZlQnV0dG9uLmRpc2FibGVkID0gIXZtMTIucHJvZmlsZUZvcm0uc2F2ZUVuYWJsZWQ7CiAgICAgICAgcHJvZmlsZUZvcm1Qcm9ncmVzcy5zdHlsZS5kaXNwbGF5ID0gdm0xMi5wcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVGb3JtT3V0cHV0LnRleHRDb250ZW50ID0gdm0xMi5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlOwogICAgICAgIGlmICh3YXNIaWRkZW4gJiYgdm0xMi5wcm9maWxlRm9ybS5zaG93aW5nKSB7CiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxEZXRhaWxzT3BlbiA9IHZtMTIucmVhbFByb2ZpbGVzLmxlbmd0aCA9PT0gMDsKICAgICAgICAgICAgcHJvZmlsZUZvcm1IZWxwRGV0YWlscy5vcGVuID0gaW5pdGlhbERldGFpbHNPcGVuOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LnNlbGVjdCgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IFdFTENPTUVfUEFORUxfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJ3ZWxjb21lLXBhbmVsIiBhdXRvY29tcGxldGU9Im9mZiI+CjxmaWVsZHNldCBpZD0id2VsY29tZS1wYW5lbC1maWVsZHNldCI+CiAgPGRpdiBpZD0id2VsY29tZS1wYW5lbC1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0IGZvcm0tcm93Ij50aXRsZTwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmb3JtLXJvdyBib2R5MiBtZWRpdW0tZW1waGFzaXMtdGV4dCI+CiAgICBXZWxjb21lIHRvIDxzcGFuIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPldlYnRhaWwgZm9yIENsb3VkZmxhcmUgV29ya2Vyczwvc3Bhbj4hCiAgICA8cD5WaWV3IGxpdmUgcmVxdWVzdHMgYW5kIGxvZ3MgZnJvbSA8YSBocmVmPSJodHRwczovL3dvcmtlcnMuY2xvdWRmbGFyZS5jb20vIiB0YXJnZXQ9Il9ibGFuayI+Q2xvdWRmbGFyZSBXb3JrZXJzPC9hPiBmcm9tIHRoZSBjb21mb3J0IG9mIHlvdXIgYnJvd3Nlci4gCiAgICBBIGZldyBlbmhhbmNlbWVudHMgb3ZlciB3aGF0J3MgcHJvdmlkZWQgPGEgaHJlZj0iaHR0cHM6Ly9ibG9nLmNsb3VkZmxhcmUuY29tL2ludHJvZHVjaW5nLXdvcmtlcnMtZGFzaGJvYXJkLWxvZ3MvIiB0YXJnZXQ9Il9ibGFuayI+YnkgZGVmYXVsdDwvYT4gaW4gdGhlIENsb3VkZmxhcmUgZGFzaGJvYXJkOjwvcD4KICAgIDx1bD4KICAgICAgICA8bGk+VGFpbCBtdWx0aXBsZSB3b3JrZXJzIGF0IHRoZSBzYW1lIHRpbWU8L2xpPgogICAgICAgIDxsaT5BZHZhbmNlZCBmaWx0ZXJpbmcgYW5kIG11bHRpLWNvbG9yIG91dHB1dCBzaW1pbGFyIHRvIDxhIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVycy5jbG91ZGZsYXJlLmNvbS93b3JrZXJzL2NsaS13cmFuZ2xlci9jb21tYW5kcyN0YWlsIiB0YXJnZXQ9Il9ibGFuayI+d3JhbmdsZXIgdGFpbDwvYT48L2xpPgogICAgICAgIDxsaT5EdXJhYmxlIG9iamVjdCBjbGFzcy9uYW1lL2lkIGFuZCBjb2xvIGluZm9ybWF0aW9uIGNhbiBiZSBzdXJmYWNlZCB3aXRoIDxhIGhyZWY9Imh0dHBzOi8vZGVub2ZsYXJlLmRldi9leGFtcGxlcy93ZWJ0YWlsI2xvZ3Byb3BzIiB0YXJnZXQ9Il9ibGFuayI+bG9ncHJvcHM8L2E+PC9saT4KICAgICAgICA8bGk+TXVsdGlwbGUgcHJvZmlsZXMsIHN3aXRjaCBlYXNpbHkgYmV0d2VlbiBtdWx0aXBsZSBhY2NvdW50czwvbGk+CiAgICAgICAgPGxpPk5vIG5lZWQgdG8gbG9nIGluIHdpdGggeW91ciBmdWxsIENsb3VkZmxhcmUgY3JlZGVudGlhbHMuICBQcm9maWxlcyBhcmUgc3RvcmVkIGxvY2FsbHkgaW4gdGhlIGJyb3dzZXIsIGFuZCBjYW4gYmUgcGVybWlzc2lvbmVkIG9ubHkgZm9yIHRhaWxpbmcgd29ya2VyczwvbGk+CiAgICAgICAgPGxpPkltcGxlbWVudGVkIGFzIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlL3RyZWUvbWFzdGVyL2V4YW1wbGVzL3dlYnRhaWwtd29ya2VyIiB0YXJnZXQ9Il9ibGFuayI+YW4gb3Blbi1zb3VyY2UgQ2xvdWRmbGFyZSBXb3JrZXI8L2E+LCAKICAgICAgICAgICA8YSBocmVmPSJodHRwczovL2Rlbm9mbGFyZS5kZXYvZXhhbXBsZXMvd2VidGFpbCNkZXBsb3ktaXQtdG8teW91ci1vd24tYWNjb3VudCIgdGFyZ2V0PSJfYmxhbmsiPmRlcGxveSBpdCB0byB5b3VyIG93biBhY2NvdW50PC9hPiwgCiAgICAgICAgICAgIG9yIDxhIGhyZWY9Imh0dHBzOi8vZGVub2ZsYXJlLmRldi9leGFtcGxlcy93ZWJ0YWlsI2hvc3QtaXQtbG9jYWxseSIgdGFyZ2V0PSJfYmxhbmsiPmhvc3QgaXQgbG9jYWxseTwvYT4gd2l0aCA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiPjxjb2RlPmRlbm9mbGFyZTwvY29kZT48L2E+PC9saT4KICAgIDwvdWw+CiAgICA8cCBpZD0id2VsY29tZS1wYW5lbC10cmFpbGVyIj5DcmVhdGUgYSBuZXcgcHJvZmlsZSB0byBnZXQgc3RhcnRlZCE8L3A+CiAgICA8cCBpZD0iYWJvdXQtcGFuZWwtdHJhaWxlciI+SGVhZCBvdmVyIHRvIHRoZSA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiPkRlbm9mbGFyZSBHaXRIdWIgcmVwbzwvYT4gdG8gcmVxdWVzdCBmZWF0dXJlcywgcmVwb3J0IGJ1Z3MsIG9yIGNoZWNrIG91dCB0aGUgY29kZSE8L3A+CiAgPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tcmhzIj4KICAgIDxidXR0b24gaWQ9IndlbGNvbWUtcGFuZWwtbmV3LXByb2ZpbGUiIHR5cGU9InN1Ym1pdCI+TmV3IHByb2ZpbGU8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9IndlbGNvbWUtcGFuZWwtY2xvc2UiIHR5cGU9InN1Ym1pdCI+Q2xvc2U8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBXRUxDT01FX1BBTkVMX0NTUyA9IGNzc2AKCiAgICAjd2VsY29tZS1wYW5lbC1mb3JtLXRpdGxlIHsKICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRXZWxjb21lUGFuZWwoZG9jdW1lbnQsIHZtMTMpIHsKICAgIGNvbnN0IHdlbGNvbWVQYW5lbEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbCcpOwogICAgY29uc3QgdGl0bGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtZm9ybS10aXRsZScpOwogICAgY29uc3Qgd2VsY29tZVRyYWlsZXJFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtdHJhaWxlcicpOwogICAgY29uc3QgYWJvdXRUcmFpbGVyRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhYm91dC1wYW5lbC10cmFpbGVyJyk7CiAgICBjb25zdCBuZXdQcm9maWxlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtbmV3LXByb2ZpbGUnKTsKICAgIGNvbnN0IGNsb3NlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtY2xvc2UnKTsKICAgIG5ld1Byb2ZpbGVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTEzLm5ld1Byb2ZpbGUoKTsKICAgIH07CiAgICBjbG9zZUJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTMuY2xvc2VBYm91dCgpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0hpZGRlbiA9IHdlbGNvbWVQYW5lbEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIGNvbnN0IHNob3cgPSB2bTEzLndlbGNvbWVTaG93aW5nICYmICF2bTEzLnByb2ZpbGVGb3JtLnNob3dpbmcgfHwgdm0xMy5hYm91dFNob3dpbmc7CiAgICAgICAgd2VsY29tZVBhbmVsRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgY29uc3Qgd2VsY29tZSA9IHZtMTMud2VsY29tZVNob3dpbmc7CiAgICAgICAgdGl0bGVFbGVtZW50LnRleHRDb250ZW50ID0gd2VsY29tZSA/ICdIZWxsbyDwn5GLJyA6ICdBYm91dCc7CiAgICAgICAgd2VsY29tZVRyYWlsZXJFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBhYm91dFRyYWlsZXJFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ25vbmUnIDogJ2Jsb2NrJzsKICAgICAgICBuZXdQcm9maWxlQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjbG9zZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gd2VsY29tZSA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiBzaG93KSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3dlbGNvbWUgPyAnd2VsY29tZScgOiAnYWJvdXQnfSBwYW5lbCBvcGVuYCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgICh3ZWxjb21lID8gbmV3UHJvZmlsZUJ1dHRvbiA6IGNsb3NlQnV0dG9uKS5mb2N1cygpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IE1PREFMX0hUTUwgPSBodG1sYAo8ZGl2IGlkPSJtb2RhbCIgY2xhc3M9Im1vZGFsIGhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwiPgogICAgPGRpdiBjbGFzcz0ibW9kYWwtY29udGVudCI+CiAgICAke1dFTENPTUVfUEFORUxfSFRNTH0KICAgICR7UFJPRklMRV9FRElUT1JfSFRNTH0KICAgICR7RklMVEVSX0VESVRPUl9IVE1MfQogICAgPC9kaXY+CjwvZGl2PgpgOwpjb25zdCBNT0RBTF9DU1MgPSBjc3NgCi5tb2RhbCB7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9zaXRpb246IGZpeGVkOwogICAgei1pbmRleDogMTsKICAgIGxlZnQ6IDA7CiAgICB0b3A6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMCwgMCwgMC40KTsKfQoKLm1vZGFsLWNvbnRlbnQgewogICAgbWFyZ2luOiAxMCUgYXV0bzsKICAgIHdpZHRoOiA4MCU7CiAgICBtYXgtd2lkdGg6IDQwcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCkBtZWRpYSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDYwMHB4KSB7CiAgICAubW9kYWwtY29udGVudCB7CiAgICAgICAgbWFyZ2luOiAxMCUgMDsKICAgICAgICB3aWR0aDogMTAwJTsKICAgIH0KfQoKYDsKZnVuY3Rpb24gaW5pdE1vZGFsKGRvY3VtZW50LCB2bTE0KSB7CiAgICBjb25zdCBtb2RhbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb2RhbCcpOwogICAgY29uc3QgdXBkYXRlUHJvZmlsZUVkaXRvciA9IGluaXRQcm9maWxlRWRpdG9yKGRvY3VtZW50LCB2bTE0KTsKICAgIGNvbnN0IHVwZGF0ZUZpbHRlckVkaXRvciA9IGluaXRGaWx0ZXJFZGl0b3IoZG9jdW1lbnQsIHZtMTQpOwogICAgY29uc3QgdXBkYXRlV2VsY29tZVBhbmVsID0gaW5pdFdlbGNvbWVQYW5lbChkb2N1bWVudCwgdm0xNCk7CiAgICBjb25zdCBjbG9zZU1vZGFsID0gKCk9PnsKICAgICAgICBpZiAoIXZtMTQucHJvZmlsZUZvcm0uc2hvd2luZyAmJiAhdm0xNC5maWx0ZXJGb3JtLnNob3dpbmcgJiYgIXZtMTQud2VsY29tZVNob3dpbmcgJiYgIXZtMTQuYWJvdXRTaG93aW5nKSByZXR1cm47CiAgICAgICAgaWYgKHZtMTQucHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlKSByZXR1cm47CiAgICAgICAgdm0xNC5wcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgdm0xNC5maWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bTE0LmFib3V0U2hvd2luZyA9IGZhbHNlOwogICAgICAgIHZtMTQub25DaGFuZ2UoKTsKICAgIH07CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZXZlbnQpPT57CiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCA9PSBtb2RhbCkgewogICAgICAgICAgICBjbG9zZU1vZGFsKCk7CiAgICAgICAgfQogICAgfSk7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGV2ZW50KT0+ewogICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgd2luZG93LmV2ZW50OwogICAgICAgIGlmIChldmVudC5rZXkgPT09ICdFc2NhcGUnKSB7CiAgICAgICAgICAgIGNsb3NlTW9kYWwoKTsKICAgICAgICB9CiAgICB9KTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIHVwZGF0ZVByb2ZpbGVFZGl0b3IoKTsKICAgICAgICB1cGRhdGVGaWx0ZXJFZGl0b3IoKTsKICAgICAgICB1cGRhdGVXZWxjb21lUGFuZWwoKTsKICAgICAgICBtb2RhbC5zdHlsZS5kaXNwbGF5ID0gdm0xNC5wcm9maWxlRm9ybS5zaG93aW5nIHx8IHZtMTQuZmlsdGVyRm9ybS5zaG93aW5nIHx8IHZtMTQud2VsY29tZVNob3dpbmcgfHwgdm0xNC5hYm91dFNob3dpbmcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgfTsKfQpjb25zdCBDSVJDVUxBUl9QUk9HUkVTU19DU1MgPSBjc3NgCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgIC1tb3otYXBwZWFyYW5jZTogbm9uZTsKICAgIGFwcGVhcmFuY2U6IG5vbmU7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcGFkZGluZzogMC4yNWVtOwogICAgd2lkdGg6IDNlbTsKICAgIGhlaWdodDogM2VtOwogICAgY29sb3I6IHZhcigtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2IsIHJnYigzMywgMTUwLCAyNDMpKTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZm9udC1zaXplOiAxNnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6Oi13ZWJraXQtcHJvZ3Jlc3MtYmFyIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50Owp9CgovKiBJbmRldGVybWluYXRlICovCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGUgewogICAgLXdlYmtpdC1tYXNrLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpLCBsaW5lYXItZ3JhZGllbnQodG8gcmlnaHQsIHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKTsKICAgIG1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIDZzIGluZmluaXRlIGN1YmljLWJlemllcigwLjMsIDAuNiwgMSwgMSk7Cn0KCjotbXMtbGFuZyh4KSwgLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICBhbmltYXRpb246IG5vbmU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6OmJlZm9yZSwKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6LXdlYmtpdC1wcm9ncmVzcy12YWx1ZSB7CiAgICBjb250ZW50OiAiIjsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIG1hcmdpbi1ib3R0b206IDAuMjVlbTsKICAgIGJvcmRlcjogc29saWQgMC4yNWVtIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogY3VycmVudENvbG9yOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgd2lkdGg6IDEwMCUgIWltcG9ydGFudDsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbW96LXByb2dyZXNzLWJhciB7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbXMtZmlsbCB7CiAgICBhbmltYXRpb24tbmFtZTogLW1zLXJpbmc7Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7CiAgICB9CiAgICAxMi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAyNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDYzMGRlZyk7CiAgICB9CiAgICAzNy41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoODEwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICA1MCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDEyNjBkZWcpOwogICAgfQogICAgNjIuNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDE0NDBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDc1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTg5MGRlZyk7CiAgICB9CiAgICA4Ny41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjA3MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgMTAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjUyMGRlZyk7CiAgICB9Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhci1wc2V1ZG8gewogICAgMCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKC0zMGRlZyk7CiAgICB9CiAgICAyOS40JSB7CiAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgMjkuNDElIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgfQogICAgNjQuNyUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgNjQuNzElIHsKICAgICAgICBib3JkZXItYm90dG9tLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMjVkZWcpOwogICAgfQp9CmA7CmNvbnN0IENPTlNPTEVfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9ImNvbnNvbGUiPgogICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXIiPgogICAgICAgIDxkaXYgaWQ9ImNvbnNvbGUtaGVhZGVyLWZpbHRlcnMiIGNsYXNzPSJib2R5MiI+PC9kaXY+CiAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItc3RhdHVzIj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItdGFpbHMiIGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCI+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgaWQ9ImNvbnNvbGUtaGVhZGVyLXFwcyIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItY2xlYXIiPjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8Y29kZSBpZD0iY29uc29sZS1sYXN0LWxpbmUiIGNsYXNzPSJsaW5lIj5zcGFjZXI8L2NvZGU+CjwvZGl2PgpgOwpjb25zdCBDT05TT0xFX0NTUyA9IGNzc2AKCiNjb25zb2xlIHsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgaGVpZ2h0OiAxMDB2aDsKICAgIHdpZHRoOiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7CiAgICBvdmVyZmxvdy14OiBoaWRkZW47CiAgICBmbGV4LWdyb3c6IDE7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICB3aWR0aDogMXJlbTsKICAgIGhlaWdodDogM3JlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwp9CgojY29uc29sZTo6LXdlYmtpdC1zY3JvbGxiYXItdGh1bWIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgojY29uc29sZS1oZWFkZXIgewogICAgcG9zaXRpb246IHN0aWNreTsKICAgIHRvcDogMDsKICAgIGhlaWdodDogMy43NXJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgZGlzcGxheTogZmxleDsKICAgIHBhZGRpbmc6IDEuMjVyZW0gMXJlbSAxcmVtIDA7Cn0KCiNjb25zb2xlLWhlYWRlci1maWx0ZXJzIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBmb250LWZhbWlseTogdmFyKC0tc2Fucy1zZXJpZi1mb250LWZhbWlseSk7CgogICAgZGlzcGxheTogLXdlYmtpdC1ib3g7CiAgICAtd2Via2l0LWxpbmUtY2xhbXA6IDM7CiAgICAtd2Via2l0LWJveC1vcmllbnQ6IHZlcnRpY2FsOyAgCiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY29uc29sZS1oZWFkZXItc3RhdHVzIHsKICAgIGhlaWdodDogMXJlbTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgbWluLXdpZHRoOiA2cmVtOwogICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICBwYWRkaW5nLXRvcDogMC4yNXJlbTsKICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwp9CgojY29uc29sZS1oZWFkZXItdGFpbHMgewogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKfQoKI2NvbnNvbGUtaGVhZGVyLWNsZWFyIHsKICAgIG1hcmdpbi1yaWdodDogLTAuNXJlbTsKICAgIG1hcmdpbi1sZWZ0OiAxcmVtOwogICAgdmlzaWJpbGl0eTogaGlkZGVuOwp9CgojY29uc29sZS1oZWFkZXItY2xlYXIgLmFjdGlvbi1pY29uIHsKICAgIHBhZGRpbmctcmlnaHQ6IDAuNXJlbTsKICAgIHBhZGRpbmctbGVmdDogMC41cmVtOwp9CgojY29uc29sZSAubGluZSB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsgLyogMTJweCAqLwogICAgbGluZS1oZWlnaHQ6IDEuMXJlbTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1tb25vc3BhY2UtZm9udC1mYW1pbHkpOwogICAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgojY29uc29sZS1sYXN0LWxpbmUgewogICAgdmlzaWJpbGl0eTogaGlkZGVuOwp9CgpgOwpmdW5jdGlvbiBpbml0Q29uc29sZShkb2N1bWVudCwgdm0xNSkgewogICAgY29uc3QgY29uc29sZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyRmlsdGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1maWx0ZXJzJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyVGFpbHNFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLXRhaWxzJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyUXBzRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1xcHMnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJDbGVhckVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItY2xlYXInKTsKICAgIGNvbnN0IGNvbnNvbGVMYXN0TGluZUVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1sYXN0LWxpbmUnKTsKICAgIGxldCBzaG93aW5nQ2xlYXJCdXR0b24gPSBmYWxzZTsKICAgIHZtMTUubG9nZ2VyID0gKC4uLmRhdGE2KT0+ewogICAgICAgIGNvbnN0IGxpbmVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY29kZScpOwogICAgICAgIGxpbmVFbGVtZW50LmNsYXNzTmFtZSA9ICdsaW5lJzsKICAgICAgICBsZXQgcG9zID0gMDsKICAgICAgICB3aGlsZShwb3MgPCBkYXRhNi5sZW5ndGgpewogICAgICAgICAgICBpZiAocG9zID4gMCkgewogICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJywgJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGRhdGE2W3Bvc107CiAgICAgICAgICAgIGlmICh0eXBlb2YgbXNnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgY29uc3QgdG9rZW5zID0gbXNnLnNwbGl0KCclYycpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVuZGVyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaSA+IDAgJiYgaSA8IHRva2Vucy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZGF0YTZbcG9zICsgaV07CiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uc2V0QXR0cmlidXRlKCdzdHlsZScsIHN0eWxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdHlsZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZS5pbmNsdWRlcygneC0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSAveC1kdXJhYmxlLW9iamVjdC0oY2xhc3N8bmFtZXxpZClccyo6XHMqJyguKj8pJy8uZXhlYyhzdHlsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHlwZSA9IG1bMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gbVsyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9ncHJvcE5hbWUgPSAnZHVyYWJsZU9iamVjdCcgKyB0eXBlLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgdHlwZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuaHJlZiA9ICcjJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5vbmNsaWNrID0gKCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtMTUuc2V0TG9ncHJvcEZpbHRlcihbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9ncHJvcE5hbWUgKyAnOicgKyB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bTE1Lm9uQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodG9rZW5zW2ldKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZW5kZXJlZCkgcmVuZGVyVGV4dEludG9TcGFuKHRva2Vuc1tpXSwgc3Bhbik7CiAgICAgICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb3MgKz0gMSArIHRva2Vucy5sZW5ndGggLSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGluZUVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoSlNPTi5zdHJpbmdpZnkobXNnKSkpOwogICAgICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc29sZURpdi5pbnNlcnRCZWZvcmUobGluZUVsZW1lbnQsIGNvbnNvbGVMYXN0TGluZUVsZW1lbnQpOwogICAgICAgIGNvbnN0IHsgc2Nyb2xsSGVpZ2h0ICwgc2Nyb2xsVG9wICwgY2xpZW50SGVpZ2h0ICB9ID0gY29uc29sZURpdjsKICAgICAgICBjb25zdCBkaWZmID0gc2Nyb2xsSGVpZ2h0IC0gc2Nyb2xsVG9wOwogICAgICAgIGNvbnN0IGF1dG9zY3JvbGwgPSBkaWZmIC0gMTYgKiA0IDw9IGNsaWVudEhlaWdodDsKICAgICAgICBpZiAoYXV0b3Njcm9sbCkgewogICAgICAgICAgICBjb25zb2xlTGFzdExpbmVFbGVtZW50LnNjcm9sbEludG9WaWV3KGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFzaG93aW5nQ2xlYXJCdXR0b24pIHsKICAgICAgICAgICAgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwogICAgICAgICAgICBzaG93aW5nQ2xlYXJCdXR0b24gPSB0cnVlOwogICAgICAgIH0KICAgIH07CiAgICB2bTE1Lm9uUmVzZXRPdXRwdXQgPSAoKT0+ewogICAgICAgIGNvbnN0IGxpbmVzID0gY29uc29sZURpdi5xdWVyeVNlbGVjdG9yQWxsKCcubGluZScpOwogICAgICAgIGxpbmVzLmZvckVhY2goKGxpbmUpPT57CiAgICAgICAgICAgIGlmIChsaW5lLmlkICE9PSAnY29uc29sZS1sYXN0LWxpbmUnKSBjb25zb2xlRGl2LnJlbW92ZUNoaWxkKGxpbmUpOwogICAgICAgIH0pOwogICAgICAgIGNvbnNvbGVIZWFkZXJDbGVhckVsZW1lbnQuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgICAgIHNob3dpbmdDbGVhckJ1dHRvbiA9IGZhbHNlOwogICAgfTsKICAgIGNvbnNvbGVIZWFkZXJRcHNFbGVtZW50LnRleHRDb250ZW50ID0gY29tcHV0ZVFwc1RleHQoMCk7CiAgICB2bTE1Lm9uUXBzQ2hhbmdlID0gKHFwcyk9PnsKICAgICAgICBjb25zb2xlSGVhZGVyUXBzRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbXB1dGVRcHNUZXh0KHFwcyk7CiAgICB9OwogICAgTGl0RWxlbWVudC5yZW5kZXIoYWN0aW9uSWNvbihDTEVBUl9JQ09OLCB7CiAgICAgICAgdGV4dDogJ0NsZWFyJywKICAgICAgICBvbmNsaWNrOiAoKT0+dm0xNS5yZXNldE91dHB1dCgpCiAgICB9KSwgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudCk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zb2xlRGl2LnN0eWxlLmRpc3BsYXkgPSB2bTE1LnNlbGVjdGVkQW5hbHl0aWNJZCA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgY29uc29sZUhlYWRlckZpbHRlcnNEaXYuc3R5bGUudmlzaWJpbGl0eSA9IHZtMTUucHJvZmlsZXMubGVuZ3RoID4gMCA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgIGNvbnNvbGVIZWFkZXJUYWlsc0VsZW1lbnQudGV4dENvbnRlbnQgPSBjb21wdXRlVGFpbHNUZXh0KHZtMTUudGFpbHMuc2l6ZSk7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoRklMVEVSU19IVE1MKHZtMTUpLCBjb25zb2xlSGVhZGVyRmlsdGVyc0Rpdik7CiAgICB9Owp9CmNvbnN0IEZJTFRFUlNfSFRNTCA9ICh2bTE2KT0+ewogICAgcmV0dXJuIGh0bWxgU2hvd2luZyA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5lZGl0U2VsZWN0aW9uRmllbGRzKCk7CiAgICB9fT4ke3ZtMTYuY29tcHV0ZVNlbGVjdGlvbkZpZWxkc1RleHQoKX08L2E+CiAgICAgZm9yIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRFdmVudEZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlRXZlbnRGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+CiAgICAgd2l0aCA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5lZGl0U3RhdHVzRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTdGF0dXNGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+LAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRJcEFkZHJlc3NGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUlwQWRkcmVzc0ZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdE1ldGhvZEZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlTWV0aG9kRmlsdGVyVGV4dCh2bTE2LmZpbHRlcil9PC9hPiwKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5lZGl0U2FtcGxpbmdSYXRlRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTYW1wbGluZ1JhdGVGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+LCAKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5lZGl0U2VhcmNoRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTZWFyY2hGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+LCAKICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRIZWFkZXJGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUhlYWRlckZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sCiAgICAgYW5kIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRMb2dwcm9wRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVMb2dwcm9wRmlsdGVyVGV4dCh2bTE2LmZpbHRlcil9PC9hPi4KICAgICAke3ZtMTYuaGFzQW55RmlsdGVycygpID8gaHRtbGAoPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYucmVzZXRGaWx0ZXJzKCk7CiAgICB9fT5yZXNldDwvYT4pYCA6ICcnfWA7Cn07CmZ1bmN0aW9uIGNvbXB1dGVFdmVudEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCB7IGV2ZW50MSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiBldmVudDEgPT09ICdjcm9uJyA/ICdDUk9OIHRyaWdnZXIgZXZlbnRzJyA6IGV2ZW50MSA9PT0gJ2h0dHAnID8gJ0hUVFAgcmVxdWVzdCBldmVudHMnIDogJ2FsbCBldmVudHMnOwp9CmZ1bmN0aW9uIGNvbXB1dGVTdGF0dXNGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgeyBzdGF0dXMxICB9ID0gZmlsdGVyOwogICAgcmV0dXJuIHN0YXR1czEgPT09ICdlcnJvcicgPyAnZXJyb3Igc3RhdHVzJyA6IHN0YXR1czEgPT09ICdzdWNjZXNzJyA/ICdzdWNjZXNzIHN0YXR1cycgOiAnYW55IHN0YXR1cyc7Cn0KZnVuY3Rpb24gY29tcHV0ZUlwQWRkcmVzc0ZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBpcEFkZHJlc3MxID0gZmlsdGVyLmlwQWRkcmVzczEgfHwgW107CiAgICByZXR1cm4gaXBBZGRyZXNzMS5sZW5ndGggPT09IDAgPyAnYW55IElQIGFkZHJlc3MnIDogaXBBZGRyZXNzMS5sZW5ndGggPT09IDEgPyBgSVAgYWRkcmVzcyBvZiAke2lwQWRkcmVzczFbMF19YCA6IGBJUCBhZGRyZXNzIGluIFske2lwQWRkcmVzczEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlTWV0aG9kRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IG1ldGhvZDEgPSBmaWx0ZXIubWV0aG9kMSB8fCBbXTsKICAgIHJldHVybiBtZXRob2QxLmxlbmd0aCA9PT0gMCA/ICdhbnkgbWV0aG9kJyA6IG1ldGhvZDEubGVuZ3RoID09PSAxID8gYG1ldGhvZCBvZiAke21ldGhvZDFbMF19YCA6IGBtZXRob2QgaW4gWyR7bWV0aG9kMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVTYW1wbGluZ1JhdGVGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3Qgc2FtcGxpbmdSYXRlMSA9IHR5cGVvZiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gJ251bWJlcicgPyBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA6IDE7CiAgICByZXR1cm4gc2FtcGxpbmdSYXRlMSA+PSAxID8gJ25vIHNhbXBsaW5nJyA6IGAkeyhNYXRoLm1heCgwLCBzYW1wbGluZ1JhdGUxKSAqIDEwMCkudG9GaXhlZCgyKX0lIHNhbXBsaW5nIHJhdGVgOwp9CmZ1bmN0aW9uIGNvbXB1dGVTZWFyY2hGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgeyBzZWFyY2gxICB9ID0gZmlsdGVyOwogICAgcmV0dXJuIHR5cGVvZiBzZWFyY2gxID09PSAnc3RyaW5nJyAmJiBzZWFyY2gxLmxlbmd0aCA+IDAgPyBgY29uc29sZSBsb2dzIGNvbnRhaW5pbmcgIiR7c2VhcmNoMX0iYCA6ICdubyBzZWFyY2ggZmlsdGVyJzsKfQpmdW5jdGlvbiBjb21wdXRlSGVhZGVyRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IGhlYWRlcjEgPSBmaWx0ZXIuaGVhZGVyMSB8fCBbXTsKICAgIHJldHVybiBoZWFkZXIxLmxlbmd0aCA9PT0gMCA/ICdubyBoZWFkZXIgZmlsdGVyJyA6IGhlYWRlcjEubGVuZ3RoID09PSAxID8gYGhlYWRlciBmaWx0ZXIgb2YgJHtoZWFkZXIxWzBdfWAgOiBgaGVhZGVyIGZpbHRlcnMgb2YgWyR7aGVhZGVyMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVMb2dwcm9wRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IGxvZ3Byb3AxID0gZmlsdGVyLmxvZ3Byb3AxIHx8IFtdOwogICAgcmV0dXJuIGxvZ3Byb3AxLmxlbmd0aCA9PT0gMCA/ICdubyBsb2dwcm9wIGZpbHRlcicgOiBsb2dwcm9wMS5sZW5ndGggPT09IDEgPyBgbG9ncHJvcCBmaWx0ZXIgb2YgJHtsb2dwcm9wMVswXX1gIDogYGxvZ3Byb3AgZmlsdGVycyBvZiBbJHtsb2dwcm9wMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsc1RleHQodGFpbENvdW50KSB7CiAgICByZXR1cm4gdGFpbENvdW50ID09PSAwID8gJ25vIHRhaWxzJyA6IHRhaWxDb3VudCA9PT0gMSA/ICcxIHRhaWwnIDogYCR7dGFpbENvdW50fSB0YWlsc2A7Cn0KZnVuY3Rpb24gY29tcHV0ZVFwc1RleHQocXBzKSB7CiAgICByZXR1cm4gYCR7cXBzLnRvRml4ZWQoMil9IHFwc2A7Cn0KZnVuY3Rpb24gcmVuZGVyVGV4dEludG9TcGFuKHRleHQsIHNwYW4pIHsKICAgIGNvbnN0IHBhdHRlcm4gPSAvKGh0dHBzOlwvXC9bXlxzKV0rfFxkezEsM31cLlxkezEsM31cLlxkezEsM31cLlxkezEsM318W1xkMC1mXSsoOihbXGQwLWZdezAsNH0pPyl7NSw3fSkvZzsKICAgIGxldCBtOwogICAgbGV0IGkgPSAwOwogICAgd2hpbGUobnVsbCAhPT0gKG0gPSBwYXR0ZXJuLmV4ZWModGV4dCkpKXsKICAgICAgICBpZiAobS5pbmRleCA+IGkpIHsKICAgICAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0LnN1YnN0cmluZyhpLCBtLmluZGV4KSkpOwogICAgICAgIH0KICAgICAgICBjb25zdCB1cmxPcklwID0gbVswXTsKICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGEuaHJlZiA9IHVybE9ySXAuc3RhcnRzV2l0aCgnaHR0cHM6Ly8nKSA/IHVybE9ySXAgOiBgaHR0cHM6Ly9pcGluZm8uaW8vJHt1cmxPcklwfWA7CiAgICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICBhLnJlbCA9ICdub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93JzsKICAgICAgICBhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHVybE9ySXApKTsKICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGEpOwogICAgICAgIGkgPSBtLmluZGV4ICsgdXJsT3JJcC5sZW5ndGg7CiAgICB9CiAgICBpZiAoaSA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0LnN1YnN0cmluZyhpKSkpOwogICAgfQp9CmNvbnN0IEFOQUxZVElDU19IVE1MMSA9IGh0bWxgCjxkaXYgaWQ9ImFuYWx5dGljcyI+CiAgICA8ZGl2IGlkPSJhbmFseXRpY3MtaGVhZGVyIj4KICAgICAgICA8ZGl2IGlkPSJhbmFseXRpY3MtaGVhZGluZyIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCI+PC9kaXY+CiAgICAgICAgPGRpdiBpZD0iYW5hbHl0aWNzLXN1YmhlYWRpbmciIGNsYXNzPSJtZWRpdW0tZW1waGFzaXMtdGV4dCI+PC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1xdWVyeWluZyI+PHByb2dyZXNzIGlkPSJhbmFseXRpY3MtcHJvZ3Jlc3MiIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPjxkaXYgY2xhc3M9Im1lZGl1bS1lbXBoYXNpcy10ZXh0Ij5GZXRjaGluZyBhbmFseXRpY3MuLi48L2Rpdj48L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1lcnJvciIgY2xhc3M9Im1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy10YWJsZSIgY2xhc3M9Im1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1uYW1lc3BhY2VzLXRhYmxlIiAgY2xhc3M9Im1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1mb290bm90ZSIgY2xhc3M9Im1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48c3VwPio8L3N1cD4gRXN0aW1hdGVkIGJhc2VkIG9uIHJlY2VudCB1c2FnZTwvZGl2Pgo8L2Rpdj4KYDsKY29uc3QgQU5BTFlUSUNTX0NTUyA9IGNzc2AKCiNhbmFseXRpY3MgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgd2lkdGg6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIG92ZXJmbG93LXk6IHNjcm9sbDsKICAgIG92ZXJmbG93LXg6IGhpZGRlbjsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCiNhbmFseXRpY3M6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICAgIHdpZHRoOiAxcmVtOwogICAgaGVpZ2h0OiAzcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCiNhbmFseXRpY3M6Oi13ZWJraXQtc2Nyb2xsYmFyLXRodW1iIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKI2FuYWx5dGljcy1oZWFkZXIgewogICAgcG9zaXRpb246IHN0aWNreTsKICAgIHRvcDogMDsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgcGFkZGluZzogMXJlbSAwOwogICAgaGVpZ2h0OiAzcmVtOwp9CgojYW5hbHl0aWNzLXN1YmhlYWRpbmcgewogICAgcGFkZGluZzogMC41cmVtIDA7Cn0KCiNhbmFseXRpY3MtcHJvZ3Jlc3MgewogICAgZm9udC1zaXplOiAwLjVyZW07IC8qIGRlZmF1bHQgM2VtID0+IDEuNXJlbSAqLwp9CgojYW5hbHl0aWNzLXF1ZXJ5aW5nIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgZ2FwOiAwLjVyZW07Cn0KCiNhbmFseXRpY3MgdGFibGUgewogICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICBib3JkZXItc3BhY2luZzogMC4zNzVyZW07CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgojYW5hbHl0aWNzIHRoIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI2FuYWx5dGljcyAuc3BhY2VyIHsKICAgIHdpZHRoOiAwLjc1cmVtOwp9CgojYW5hbHl0aWNzLXRhYmxlIC5lc3RpbWF0ZSB0ZCB7CiAgICBwYWRkaW5nLXRvcDogMXJlbTsKfQoKI2FuYWx5dGljcyAubW9ubyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tbW9ub3NwYWNlLWZvbnQtZmFtaWx5KTsKfQoKI2FuYWx5dGljcy1uYW1lc3BhY2VzLXRhYmxlIHsKICAgIG1hcmdpbi10b3A6IDJyZW07Cn0KCiNhbmFseXRpY3MtbmFtZXNwYWNlcy10YWJsZSBhLnVuc2VsZWN0ZWQgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKQG1lZGlhIChob3ZlcjogaG92ZXIpIHsKICAgICNhbmFseXRpY3MtbmFtZXNwYWNlcy10YWJsZSBhLnVuc2VsZWN0ZWQ6aG92ZXIgewogICAgICAgIGNvbG9yOiB2YXIoLS1wcmltYXJ5LWNvbG9yKTsKICAgIH0KfQoKI2FuYWx5dGljcyAubGVmdC1hbGlnbmVkIHsKICAgIHRleHQtYWxpZ246IGxlZnQ7Cn0KCiNhbmFseXRpY3MtZm9vdG5vdGUgewogICAgbWFyZ2luLXRvcDogMXJlbTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCmA7CmZ1bmN0aW9uIGluaXRBbmFseXRpY3MoZG9jdW1lbnQsIHZtMTcpIHsKICAgIGNvbnN0IGFuYWx5dGljc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MnKTsKICAgIGNvbnN0IGFuYWx5dGljc0hlYWRpbmcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5hbHl0aWNzLWhlYWRpbmcnKTsKICAgIGNvbnN0IGFuYWx5dGljc1N1YmhlYWRpbmcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5hbHl0aWNzLXN1YmhlYWRpbmcnKTsKICAgIGNvbnN0IGFuYWx5dGljc1F1ZXJ5aW5nRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtcXVlcnlpbmcnKTsKICAgIGNvbnN0IGFuYWx5dGljc0Vycm9yRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtZXJyb3InKTsKICAgIGNvbnN0IGFuYWx5dGljc1RhYmxlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtdGFibGUnKTsKICAgIGNvbnN0IGFuYWx5dGljc05hbWVzcGFjZXNUYWJsZUVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5hbHl0aWNzLW5hbWVzcGFjZXMtdGFibGUnKTsKICAgIGNvbnN0IGFuYWx5dGljc0Zvb3Rub3RlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtZm9vdG5vdGUnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGFuYWx5dGljc0Rpdi5zdHlsZS5kaXNwbGF5ID0gdm0xNy5zZWxlY3RlZEFuYWx5dGljSWQgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGlmICghdm0xNy5zZWxlY3RlZEFuYWx5dGljSWQpIHJldHVybjsKICAgICAgICBjb25zdCBzZWxlY3RlZEFuYWx5dGljID0gdm0xNy5hbmFseXRpY3MuZmluZCgodik9PnYuaWQgPT09IHZtMTcuc2VsZWN0ZWRBbmFseXRpY0lkCiAgICAgICAgKTsKICAgICAgICBpZiAoIXNlbGVjdGVkQW5hbHl0aWMpIHJldHVybjsKICAgICAgICBhbmFseXRpY3NIZWFkaW5nLnRleHRDb250ZW50ID0gc2VsZWN0ZWRBbmFseXRpYy50ZXh0OwogICAgICAgIGFuYWx5dGljc1N1YmhlYWRpbmcudGV4dENvbnRlbnQgPSBzZWxlY3RlZEFuYWx5dGljLmRlc2NyaXB0aW9uIHx8ICcnOwogICAgICAgIGNvbnN0IHsgZHVyYWJsZU9iamVjdHNDb3N0cyAsIHF1ZXJ5aW5nICwgZXJyb3IgIH0gPSB2bTE3LmFuYWx5dGljc1N0YXRlOwogICAgICAgIGFuYWx5dGljc1F1ZXJ5aW5nRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gcXVlcnlpbmcgPyAnZmxleCcgOiAnbm9uZSc7CiAgICAgICAgYW5hbHl0aWNzRXJyb3JFbGVtZW50LnRleHRDb250ZW50ID0gZXJyb3IgfHwgJyc7CiAgICAgICAgYW5hbHl0aWNzRm9vdG5vdGVFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBkdXJhYmxlT2JqZWN0c0Nvc3RzID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBpZiAoZHVyYWJsZU9iamVjdHNDb3N0cykgewogICAgICAgICAgICBjb25zdCByZW5kZXJDb3N0cyA9IChuYW1lc3BhY2VJZCk9PnsKICAgICAgICAgICAgICAgIGNvbnN0IHRhYmxlID0gZHVyYWJsZU9iamVjdHNDb3N0cy5uYW1lc3BhY2VUYWJsZXNbbmFtZXNwYWNlSWQgfHwgJyddIHx8IGR1cmFibGVPYmplY3RzQ29zdHMuYWNjb3VudFRhYmxlOwogICAgICAgICAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoQ09TVFNfSFRNTCh0YWJsZSwgbmFtZXNwYWNlSWQpLCBhbmFseXRpY3NUYWJsZUVsZW1lbnQpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZW5kZXJDb3N0cyh1bmRlZmluZWQpOwogICAgICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihOQU1FU1BBQ0VTX0hUTUwoZHVyYWJsZU9iamVjdHNDb3N0cywgcmVuZGVyQ29zdHMpLCBhbmFseXRpY3NOYW1lc3BhY2VzVGFibGVFbGVtZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBMaXRFbGVtZW50LnJlbmRlcih1bmRlZmluZWQsIGFuYWx5dGljc1RhYmxlRWxlbWVudCk7CiAgICAgICAgICAgIExpdEVsZW1lbnQucmVuZGVyKHVuZGVmaW5lZCwgYW5hbHl0aWNzTmFtZXNwYWNlc1RhYmxlRWxlbWVudCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBGSVhFRF8xID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdlbi1VUycsIHsKICAgIG1heGltdW1GcmFjdGlvbkRpZ2l0czogMSwKICAgIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMQp9KTsKY29uc3QgRklYRURfMiA9IG5ldyBJbnRsLk51bWJlckZvcm1hdCgnZW4tVVMnLCB7CiAgICBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDIsCiAgICBtaW5pbXVtRnJhY3Rpb25EaWdpdHM6IDIKfSk7CmZ1bmN0aW9uIGZvcm1hdDEodmFsKSB7CiAgICBpZiAodmFsIDwgMTAwMCkgcmV0dXJuIHZhbC50b1N0cmluZygpOwogICAgcmV0dXJuIGAke0ZJWEVEXzEuZm9ybWF0KHZhbCAvIDEwMDApfWtgOwp9CmZ1bmN0aW9uIGZvcm1hdDIodmFsKSB7CiAgICBpZiAodmFsIDwgMTAwMCkgcmV0dXJuIHZhbC50b0ZpeGVkKDIpOwogICAgcmV0dXJuIGAke0ZJWEVEXzIuZm9ybWF0KHZhbCAvIDEwMDApfWtgOwp9CmZ1bmN0aW9uIGZvcm1hdEdiKHZhbCkgewogICAgaWYgKHZhbCA8IDEpIHJldHVybiBgJHtmb3JtYXQyKHZhbCAqIDEwMjQpfW1iYDsKICAgIHJldHVybiBgJHtmb3JtYXQyKHZhbCl9Z2JgOwp9CmZ1bmN0aW9uIGNsaWNrTmFtZXNwYWNlKGUsIHJlbmRlckNvc3RzKSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBjb25zdCB0ZXh0ID0gZS50YXJnZXQudGV4dENvbnRlbnQgfHwgJyc7CiAgICBjb25zb2xlLmxvZygnY2xpY2tOYW1lc3BhY2UnLCB0ZXh0KTsKICAgIHJlbmRlckNvc3RzKHRleHQuc3RhcnRzV2l0aCgnQWxsJykgPyB1bmRlZmluZWQgOiB0ZXh0KTsKICAgIGNvbnN0IGFuY2hvcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcjYW5hbHl0aWNzLW5hbWVzcGFjZXMtdGFibGUgYScpOwogICAgYW5jaG9ycy5mb3JFYWNoKChhKT0+ewogICAgICAgIGEuY2xhc3NOYW1lID0gYSA9PT0gZS50YXJnZXQgPyAnJyA6ICd1bnNlbGVjdGVkJzsKICAgIH0pOwp9CmNvbnN0IE5BTUVTUEFDRVNfSFRNTCA9ICh0YWJsZSwgcmVuZGVyQ29zdHMpPT5odG1sYAogICAgPHRhYmxlPgogICAgICAgIDx0cj4KICAgICAgICAgICAgPHRoPk5hbWVzcGFjZSBJRDwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aD5TY3JpcHQ8L3RoPgogICAgICAgICAgICA8dGg+Q2xhc3M8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGg+VG90YWw8L3RoPgogICAgICAgIDwvdHI+CiAgICAgICAgPHRyPgogICAgICAgICAgICA8dGQgY2xhc3M9ImxlZnQtYWxpZ25lZCBtb25vIj48YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PmNsaWNrTmFtZXNwYWNlKGUsIHJlbmRlckNvc3RzKQogICAgfT5BbGwgZHVyYWJsZSBvYmplY3RzPC9hPjwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQkeyh0YWJsZS5hY2NvdW50VGFibGUuZXN0aW1hdGVkMzBEYXlSb3c/LnRvdGFsQ29zdCB8fCAwKS50b0ZpeGVkKDIpfTwvdGQ+CiAgICAgICAgPC90cj4KICAgICR7WwogICAgICAgIC4uLk9iamVjdC5lbnRyaWVzKHRhYmxlLm5hbWVzcGFjZVRhYmxlcykKICAgIF0uc29ydCgoYSwgYik9PihiWzFdLmVzdGltYXRlZDMwRGF5Um93Py50b3RhbENvc3QgfHwgMCkgLSAoYVsxXS5lc3RpbWF0ZWQzMERheVJvdz8udG90YWxDb3N0IHx8IDApCiAgICApLm1hcCgodik9PnsKICAgICAgICBjb25zdCBbbmFtZXNwYWNlSWQsIHRdID0gdjsKICAgICAgICByZXR1cm4gaHRtbGA8dHI+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0ibGVmdC1hbGlnbmVkIG1vbm8iPjxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+Y2xpY2tOYW1lc3BhY2UoZSwgcmVuZGVyQ29zdHMpCiAgICAgICAgfSBjbGFzcz0idW5zZWxlY3RlZCI+JHtuYW1lc3BhY2VJZH08L2E+PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJsZWZ0LWFsaWduZWQiPiR7dC5uYW1lc3BhY2U/LnNjcmlwdCB8fCAnJ308L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImxlZnQtYWxpZ25lZCI+JHt0Lm5hbWVzcGFjZT8uY2xhc3MgfHwgJyd9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQkeyh0LmVzdGltYXRlZDMwRGF5Um93Py50b3RhbENvc3QgfHwgMCkudG9GaXhlZCgyKX08L3RkPgogICAgICAgICAgICA8L3RyPmA7CiAgICB9KX0KICAgIDwvdGFibGU+CmAKOwpjb25zdCBDT1NUU19IVE1MID0gKHRhYmxlLCBuYW1lc3BhY2VJZCk9Pmh0bWxgCiAgICA8dGFibGU+CiAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+VVRDIERheTwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj5SZXF1ZXN0czwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSI0Ij5XZWJzb2NrZXRzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPlN1YnJlcXVlc3RzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPkR1cmF0aW9uPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPlJlYWRzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPldyaXRlczwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj5EZWxldGVzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPlN0b3JhZ2U8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGg+VG90YWw8L3RoPgogICAgICAgIDwvdHI+CiAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aD5NYXg8L3RoPgogICAgICAgICAgICA8dGg+SW48L3RoPgogICAgICAgICAgICA8dGg+T3V0PC90aD4KICAgICAgICAgICAgPHRoPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGg+R0Itc2VjPC90aD4KICAgICAgICAgICAgPHRoPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGg+PC90aD4KICAgICAgICA8L3RyPgogICAgICAgICR7dGFibGUucm93cy5tYXAoKHYpPT5odG1sYDx0cj4KICAgICAgICAgICAgPHRkPiR7di5kYXRlfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke2Zvcm1hdDEodi5zdW1SZXF1ZXN0cyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5yZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke2Zvcm1hdDEodi5tYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyl9PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCl9PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQpfTwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYud2Vic29ja2V0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke2Zvcm1hdDEodi5zdW1TdWJyZXF1ZXN0cyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5zdWJyZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke2Zvcm1hdDIodi5hY3RpdmVHYlNlY29uZHMpfTwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYuYWN0aXZlQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVN0b3JhZ2VSZWFkVW5pdHMpfTwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYucmVhZFVuaXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVN0b3JhZ2VXcml0ZVVuaXRzKX08L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LndyaXRlVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtU3RvcmFnZURlbGV0ZXMpfTwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYuZGVsZXRlc0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke3Yuc3RvcmFnZUdiID09PSB1bmRlZmluZWQgPyAnPycgOiBmb3JtYXRHYih2LnN0b3JhZ2VHYil9PC90ZD4KICAgICAgICAgICAgPHRkPiR7di5zdG9yYWdlQ29zdCA9PT0gdW5kZWZpbmVkID8gJycgOiBgJCR7Zm9ybWF0Mih2LnN0b3JhZ2VDb3N0KX1gfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYudG90YWxDb3N0KX08L3RkPgogICAgICAgIDwvdHI+YAogICAgKX0KCiAgICAgICAgJHt0YWJsZS5lc3RpbWF0ZWQzMERheVJvdyA/IGh0bWxgPHRyIGNsYXNzPSJlc3RpbWF0ZSI+CiAgICAgICAgICAgIDx0ZD4zMC1kYXkgYmlsbDxzdXA+Kjwvc3VwPjwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy5yZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93LndlYnNvY2tldHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cuc3VicmVxdWVzdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cuYWN0aXZlQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93LnJlYWRVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy53cml0ZVVuaXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93LmRlbGV0ZXNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cuc3RvcmFnZUNvc3QgfHwgMCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cudG90YWxDb3N0KX08L3RkPgogICAgICAgIDwvdHI+YCA6ICcnfQogICAgICAgICR7dGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUgPyBodG1sYDx0cj4KICAgICAgICAgICAgPHRkPuKIkiBmcmVlIHVzYWdlPC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUud2Vic29ja2V0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS5zdWJyZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS5hY3RpdmVDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUucmVhZFVuaXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLndyaXRlVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUuZGVsZXRlc0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS5zdG9yYWdlQ29zdCB8fCAwKX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS50b3RhbENvc3QpfTwvdGQ+CiAgICAgICAgPC90cj5gIDogJyd9CiAgICA8L3RhYmxlPgpgCjsKY29uc3QgYXBwTW9kdWxlU2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcC1tb2R1bGUtc2NyaXB0Jyk7CmZ1bmN0aW9uIHNldEFwcFN0YXRlKGFwcFN0YXRlKSB7CiAgICBhcHBNb2R1bGVTY3JpcHQuZGF0YXNldC5zdGF0ZSA9IGFwcFN0YXRlOwp9CnNldEFwcFN0YXRlKCdzdGFydGluZycpOwpjb25zdCBhcHBDc3MgPSBjc3NgCgptYWluIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNXJlbTsKfQoKOnJvb3QgewogICAgLS1wdXJlLW1hdGVyaWFsLXByaW1hcnktcmdiOiByZ2IoMTg3LCAxMzQsIDI1Mik7Cn0KCi5oaWRkZW4tdmVydGljYWwtc2Nyb2xsIHsKICAgIHNjcm9sbGJhci13aWR0aDogbm9uZTsgLW1zLW92ZXJmbG93LXN0eWxlOiBub25lOwogICAgb3ZlcmZsb3cteTogc2Nyb2xsOwp9CgouaGlkZGVuLXZlcnRpY2FsLXNjcm9sbDo6LXdlYmtpdC1zY3JvbGxiYXIgewogICAgZGlzcGxheTogbm9uZTsgLyogZm9yIENocm9tZSwgU2FmYXJpLCBhbmQgT3BlcmEgKi8KfQoKYDsKY29uc3QgYXBwSHRtbCA9IGh0bWxgCjxtYWluPgoke1NJREVCQVJfSFRNTH0KJHtDT05TT0xFX0hUTUx9CiR7QU5BTFlUSUNTX0hUTUwxfQoke01PREFMX0hUTUx9CjwvbWFpbj5gOwpmdW5jdGlvbiBhcHBlbmRTdHlsZXNoZWV0cyhjc3NUZXh0cykgewogICAgY29uc3Qgc3R5bGVTaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBzdHlsZVNoZWV0LnR5cGUgPSAndGV4dC9jc3MnOwogICAgc3R5bGVTaGVldC50ZXh0Q29udGVudCA9IGNzc1RleHRzLmpvaW4oJ1xuXG4nKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVTaGVldCk7Cn0KYXBwZW5kU3R5bGVzaGVldHMoWwogICAgTUFURVJJQUxfQ1NTLmNzc1RleHQsCiAgICBhcHBDc3MuY3NzVGV4dCwKICAgIEhFQURFUl9DU1MuY3NzVGV4dCwKICAgIFNJREVCQVJfQ1NTLmNzc1RleHQsCiAgICBDT05TT0xFX0NTUy5jc3NUZXh0LAogICAgQU5BTFlUSUNTX0NTUy5jc3NUZXh0LAogICAgTU9EQUxfQ1NTLmNzc1RleHQsCiAgICBXRUxDT01FX1BBTkVMX0NTUy5jc3NUZXh0LAogICAgUFJPRklMRV9FRElUT1JfQ1NTLmNzc1RleHQsCiAgICBGSUxURVJfRURJVE9SX0NTUy5jc3NUZXh0LAogICAgQ0lSQ1VMQVJfUFJPR1JFU1NfQ1NTLmNzc1RleHQsIApdKTsKTGl0RWxlbWVudC5yZW5kZXIoYXBwSHRtbCwgZG9jdW1lbnQuYm9keSk7CmZ1bmN0aW9uIHBhcnNlU3RhdGljRGF0YSgpIHsKICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0aWMtZGF0YS1zY3JpcHQnKTsKICAgIGNvbnN0IGRhdGExID0gSlNPTi5wYXJzZShzY3JpcHQudGV4dCk7CiAgICBjb25zdCB2ZXJzaW9uID0gdHlwZW9mIGRhdGExLnZlcnNpb24gPT09ICdzdHJpbmcnID8gZGF0YTEudmVyc2lvbiA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGZsYWdzID0gdHlwZW9mIGRhdGExLmZsYWdzID09PSAnc3RyaW5nJyA/IGRhdGExLmZsYWdzIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGZsYWdzCiAgICB9Owp9CmNvbnN0IGRhdGEgPSBwYXJzZVN0YXRpY0RhdGEoKTsKY29uc3Qgdm0gPSBuZXcgV2VidGFpbEFwcFZNKCk7CmNvbnN0IHVwZGF0ZVNpZGViYXIgPSBpbml0U2lkZWJhcihkb2N1bWVudCwgdm0sIGRhdGEpOwpjb25zdCB1cGRhdGVDb25zb2xlID0gaW5pdENvbnNvbGUoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlQW5hbHl0aWNzID0gaW5pdEFuYWx5dGljcyhkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVNb2RhbCA9IGluaXRNb2RhbChkb2N1bWVudCwgdm0pOwp2bS5vbkNoYW5nZSA9ICgpPT57CiAgICB1cGRhdGVTaWRlYmFyKCk7CiAgICB1cGRhdGVDb25zb2xlKCk7CiAgICB1cGRhdGVBbmFseXRpY3MoKTsKICAgIHVwZGF0ZU1vZGFsKCk7Cn07CkNsb3VkZmxhcmVBcGkuVVJMX1RSQU5TRk9STUVSID0gQ2ZHcWxDbGllbnQuVVJMX1RSQU5TRk9STUVSID0gKHYpPT5gL2ZldGNoLyR7di5zdWJzdHJpbmcoJ2h0dHBzOi8vJy5sZW5ndGgpfWAKOwp2bS5zdGFydCgpOwpzZXRBcHBTdGF0ZSgnc3RhcnRlZCcpOwo=';