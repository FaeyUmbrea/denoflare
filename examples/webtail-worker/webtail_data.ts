

export const WEBTAIL_APP_HASH = 'c9c806ffef21a855e7c652e2fa5b85a5bf326545';
export const WEBTAIL_APP_B64 = 'Ly8gZGVuby1mbXQtaWdub3JlLWZpbGUKLy8gZGVuby1saW50LWlnbm9yZS1maWxlCi8vIFRoaXMgY29kZSB3YXMgYnVuZGxlZCB1c2luZyBgZGVubyBidW5kbGVgIGFuZCBpdCdzIG5vdCByZWNvbW1lbmRlZCB0byBlZGl0IGl0IG1hbnVhbGx5Cgpjb25zdCBkaXJlY3RpdmVzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgaXNEaXJlY3RpdmUgPSAobyk9PnsKICAgIHJldHVybiB0eXBlb2YgbyA9PT0gImZ1bmN0aW9uIiAmJiBkaXJlY3RpdmVzLmhhcyhvKTsKfTsKY29uc3QgaXNDRVBvbHlmaWxsID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzICE9IG51bGwgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzLnBvbHlmaWxsV3JhcEZsdXNoQ2FsbGJhY2sgIT09IHZvaWQgMDsKY29uc3QgcmVwYXJlbnROb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsLCBiZWZvcmUgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5pbnNlcnRCZWZvcmUoc3RhcnQsIGJlZm9yZSk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCByZW1vdmVOb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChzdGFydCk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCBub0NoYW5nZSA9IHt9Owpjb25zdCBub3RoaW5nID0ge307CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhMSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICAgIGlmIChkYXRhMS5pbmRleE9mKG1hcmtlcikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdzMiA9IGRhdGExLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7fQp9KSgpOwpjbGFzcyBFdmVudFBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgZXZlbnROYW1lLCBldmVudENvbnRleHQpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgICAgIHRoaXMuZXZlbnRDb250ZXh0ID0gZXZlbnRDb250ZXh0OwogICAgICAgIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50ID0gKGUpPT50aGlzLmhhbmRsZUV2ZW50KGUpCiAgICAgICAgOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy5fX3BlbmRpbmdWYWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fX3BlbmRpbmdWYWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdMaXN0ZW5lciA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgY29uc3Qgb2xkTGlzdGVuZXIgPSB0aGlzLnZhbHVlOwogICAgICAgIGNvbnN0IHNob3VsZFJlbW92ZUxpc3RlbmVyID0gbmV3TGlzdGVuZXIgPT0gbnVsbCB8fCBvbGRMaXN0ZW5lciAhPSBudWxsICYmIChuZXdMaXN0ZW5lci5jYXB0dXJlICE9PSBvbGRMaXN0ZW5lci5jYXB0dXJlIHx8IG5ld0xpc3RlbmVyLm9uY2UgIT09IG9sZExpc3RlbmVyLm9uY2UgfHwgbmV3TGlzdGVuZXIucGFzc2l2ZSAhPT0gb2xkTGlzdGVuZXIucGFzc2l2ZSk7CiAgICAgICAgY29uc3Qgc2hvdWxkQWRkTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciAhPSBudWxsICYmIChvbGRMaXN0ZW5lciA9PSBudWxsIHx8IHNob3VsZFJlbW92ZUxpc3RlbmVyKTsKICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRBZGRMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLl9fb3B0aW9ucyA9IGdldE9wdGlvbnMobmV3TGlzdGVuZXIpOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IG5ld0xpc3RlbmVyOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KICAgIGhhbmRsZUV2ZW50KGV2ZW50KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuY2FsbCh0aGlzLmV2ZW50Q29udGV4dCB8fCB0aGlzLmVsZW1lbnQsIGV2ZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlLmhhbmRsZUV2ZW50KGV2ZW50KTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZ2V0T3B0aW9ucyA9IChvKT0+byAmJiAoZXZlbnRPcHRpb25zU3VwcG9ydGVkID8gewogICAgICAgIGNhcHR1cmU6IG8uY2FwdHVyZSwKICAgICAgICBwYXNzaXZlOiBvLnBhc3NpdmUsCiAgICAgICAgb25jZTogby5vbmNlCiAgICB9IDogby5jYXB0dXJlKQo7CmNsYXNzIERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvciB7CiAgICBoYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhlbGVtZW50LCBuYW1lLCBzdHJpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZVswXTsKICAgICAgICBpZiAocHJlZml4ID09PSAiLiIpIHsKICAgICAgICAgICAgY29uc3QgY29tbWl0dGVyMiA9IG5ldyBQcm9wZXJ0eUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKTsKICAgICAgICAgICAgcmV0dXJuIGNvbW1pdHRlcjIucGFydHM7CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICJAIikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEV2ZW50UGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBvcHRpb25zLmV2ZW50Q29udGV4dCkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIj8iKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgQm9vbGVhbkF0dHJpYnV0ZVBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncykKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tbWl0dGVyID0gbmV3IEF0dHJpYnV0ZUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICByZXR1cm4gY29tbWl0dGVyLnBhcnRzOwogICAgfQogICAgaGFuZGxlVGV4dEV4cHJlc3Npb24ob3B0aW9ucykgewogICAgICAgIHJldHVybiBuZXcgTm9kZVBhcnQob3B0aW9ucyk7CiAgICB9Cn0KY29uc3QgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yID0gbmV3IERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcigpOwpmdW5jdGlvbiB0ZW1wbGF0ZUZhY3RvcnkocmVzdWx0KSB7CiAgICBsZXQgdGVtcGxhdGVDYWNoZSA9IHRlbXBsYXRlQ2FjaGVzLmdldChyZXN1bHQudHlwZSk7CiAgICBpZiAodGVtcGxhdGVDYWNoZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGVDYWNoZSA9IHsKICAgICAgICAgICAgc3RyaW5nc0FycmF5OiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgICBrZXlTdHJpbmc6IG5ldyBNYXAoKQogICAgICAgIH07CiAgICAgICAgdGVtcGxhdGVDYWNoZXMuc2V0KHJlc3VsdC50eXBlLCB0ZW1wbGF0ZUNhY2hlKTsKICAgIH0KICAgIGxldCB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LmdldChyZXN1bHQuc3RyaW5ncyk7CiAgICBpZiAodGVtcGxhdGUgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIGNvbnN0IGtleSA9IHJlc3VsdC5zdHJpbmdzLmpvaW4obWFya2VyKTsKICAgIHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuZ2V0KGtleSk7CiAgICBpZiAodGVtcGxhdGUgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHJlc3VsdCwgcmVzdWx0LmdldFRlbXBsYXRlRWxlbWVudCgpKTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5zZXQoa2V5LCB0ZW1wbGF0ZSk7CiAgICB9CiAgICB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5zZXQocmVzdWx0LnN0cmluZ3MsIHRlbXBsYXRlKTsKICAgIHJldHVybiB0ZW1wbGF0ZTsKfQpjb25zdCB0ZW1wbGF0ZUNhY2hlcyA9IG5ldyBNYXAoKTsKY29uc3QgcGFydHMgPSBuZXcgV2Vha01hcCgpOwpjb25zdCByZW5kZXIgPSAocmVzdWx0LCBjb250YWluZXIsIG9wdGlvbnMpPT57CiAgICBsZXQgcGFydCA9IHBhcnRzLmdldChjb250YWluZXIpOwogICAgaWYgKHBhcnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbW92ZU5vZGVzKGNvbnRhaW5lciwgY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgIHBhcnRzLnNldChjb250YWluZXIsIHBhcnQgPSBuZXcgTm9kZVBhcnQoT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIHRlbXBsYXRlRmFjdG9yeQogICAgICAgIH0sIG9wdGlvbnMpKSk7CiAgICAgICAgcGFydC5hcHBlbmRJbnRvKGNvbnRhaW5lcik7CiAgICB9CiAgICBwYXJ0LnNldFZhbHVlKHJlc3VsdCk7CiAgICBwYXJ0LmNvbW1pdCgpOwp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIxLjQuMSIpOwp9CmNvbnN0IGh0bWwgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFRlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgImh0bWwiLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKY29uc3Qgc3ZnID0gKHN0cmluZ3MsIC4uLnZhbHVlcyk9Pm5ldyBTVkdUZW1wbGF0ZVJlc3VsdChzdHJpbmdzLCB2YWx1ZXMsICJzdmciLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKdmFyIF9hOwp3aW5kb3cuSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSA9IChwcm9wLCBfb2JqKT0+cHJvcAo7CmNvbnN0IGRlZmF1bHRDb252ZXJ0ZXIgPSB7CiAgICB0b0F0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/ICIiIDogbnVsbDsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/IHZhbHVlIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgZnJvbUF0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbDsKICAgICAgICAgICAgY2FzZSBOdW1iZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgPyBudWxsIDogTnVtYmVyKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KfTsKY29uc3Qgbm90RXF1YWwgPSAodmFsdWUsIG9sZCk9PnsKICAgIHJldHVybiBvbGQgIT09IHZhbHVlICYmIChvbGQgPT09IG9sZCB8fCB2YWx1ZSA9PT0gdmFsdWUpOwp9Owpjb25zdCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbiA9IHsKICAgIGF0dHJpYnV0ZTogdHJ1ZSwKICAgIHR5cGU6IFN0cmluZywKICAgIGNvbnZlcnRlcjogZGVmYXVsdENvbnZlcnRlciwKICAgIHJlZmxlY3Q6IGZhbHNlLAogICAgaGFzQ2hhbmdlZDogbm90RXF1YWwKfTsKY29uc3QgU1RBVEVfSEFTX1VQREFURUQgPSAxOwpjb25zdCBTVEFURV9VUERBVEVfUkVRVUVTVEVEID0gMSA8PCAyOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSA9IDEgPDwgMzsKY29uc3QgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSA9IDEgPDwgNDsKY29uc3QgZmluYWxpemVkID0gImZpbmFsaXplZCI7CmNsYXNzIFVwZGF0aW5nRWxlbWVudCBleHRlbmRzIEhUTUxFbGVtZW50IHsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgICAgc3VwZXIoKTsKICAgICAgICB0aGlzLmluaXRpYWxpemUoKTsKICAgIH0KICAgIHN0YXRpYyBnZXQgb2JzZXJ2ZWRBdHRyaWJ1dGVzKCkgewogICAgICAgIHRoaXMuZmluYWxpemUoKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT57CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkocCwgdik7CiAgICAgICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuc2V0KGF0dHIsIHApOwogICAgICAgICAgICAgICAgYXR0cmlidXRlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICBzdGF0aWMgX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX2NsYXNzUHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGNvbnN0IHN1cGVyUHJvcGVydGllcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKS5fY2xhc3NQcm9wZXJ0aWVzOwogICAgICAgICAgICBpZiAoc3VwZXJQcm9wZXJ0aWVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHN1cGVyUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fY2xhc3NQcm9wZXJ0aWVzLnNldChrLCB2KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBjcmVhdGVQcm9wZXJ0eShuYW1lLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm5vQWNjZXNzb3IgfHwgdGhpcy5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSB0eXBlb2YgbmFtZSA9PT0gInN5bWJvbCIgPyBTeW1ib2woKSA6IGBfXyR7bmFtZX1gOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSB0aGlzLmdldFByb3BlcnR5RGVzY3JpcHRvcihuYW1lLCBrZXksIG9wdGlvbnMpOwogICAgICAgIGlmIChkZXNjcmlwdG9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMucHJvdG90eXBlLCBuYW1lLCBkZXNjcmlwdG9yKTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGdldCAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1trZXldOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXNbbmFtZV07CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfTsKICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSkgewogICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgJiYgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmdldChuYW1lKSB8fCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbjsKICAgIH0KICAgIHN0YXRpYyBmaW5hbGl6ZSgpIHsKICAgICAgICBjb25zdCBzdXBlckN0b3IgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7CiAgICAgICAgaWYgKCFzdXBlckN0b3IuaGFzT3duUHJvcGVydHkoZmluYWxpemVkKSkgewogICAgICAgICAgICBzdXBlckN0b3IuZmluYWxpemUoKTsKICAgICAgICB9CiAgICAgICAgdGhpc1tmaW5hbGl6ZWRdID0gdHJ1ZTsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwID0gbmV3IE1hcCgpOwogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoInByb3BlcnRpZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BlcnRpZXM7CiAgICAgICAgICAgIGNvbnN0IHByb3BLZXlzID0gWwogICAgICAgICAgICAgICAgLi4uT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcHMpLAogICAgICAgICAgICAgICAgLi4udHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHByb3BzKSA6IFtdCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiBwcm9wS2V5cyl7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZVByb3BlcnR5KHAsIHByb3BzW3BdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBfYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBvcHRpb25zLmF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlID09PSBmYWxzZSA/IHZvaWQgMCA6IHR5cGVvZiBhdHRyaWJ1dGUgPT09ICJzdHJpbmciID8gYXR0cmlidXRlIDogdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogdm9pZCAwOwogICAgfQogICAgc3RhdGljIF92YWx1ZUhhc0NoYW5nZWQodmFsdWUsIG9sZCwgaGFzQ2hhbmdlZCA9IG5vdEVxdWFsKSB7CiAgICAgICAgcmV0dXJuIGhhc0NoYW5nZWQodmFsdWUsIG9sZCk7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlciB8fCBkZWZhdWx0Q29udmVydGVyOwogICAgICAgIGNvbnN0IGZyb21BdHRyaWJ1dGUgPSB0eXBlb2YgY29udmVydGVyID09PSAiZnVuY3Rpb24iID8gY29udmVydGVyIDogY29udmVydGVyLmZyb21BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGZyb21BdHRyaWJ1dGUgPyBmcm9tQXR0cmlidXRlKHZhbHVlLCB0eXBlKSA6IHZhbHVlOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyOwogICAgICAgIGNvbnN0IHRvQXR0cmlidXRlID0gY29udmVydGVyICYmIGNvbnZlcnRlci50b0F0dHJpYnV0ZSB8fCBkZWZhdWx0Q29udmVydGVyLnRvQXR0cmlidXRlOwogICAgICAgIHJldHVybiB0b0F0dHJpYnV0ZSh2YWx1ZSwgdHlwZSk7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gMDsKICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlcyk9PnRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSByZXMKICAgICAgICApOwogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbCgpOwogICAgfQogICAgX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKF92LCBwKT0+ewogICAgICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW3BdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5zZXQocCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBfYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT50aGlzW3BdID0gdgogICAgICAgICk7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgdGhpcy5lbmFibGVVcGRhdGluZygpOwogICAgfQogICAgZW5hYmxlVXBkYXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyKCk7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSB2b2lkIDA7CiAgICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7fQogICAgYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZCwgdmFsdWUpIHsKICAgICAgICBpZiAob2xkICE9PSB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICBfcHJvcGVydHlUb0F0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3B0aW9ucyA9IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uKSB7CiAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgY29uc3QgYXR0ciA9IGN0b3IuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShuYW1lLCBvcHRpb25zKTsKICAgICAgICBpZiAoYXR0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHJWYWx1ZSA9IGN0b3IuX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKGF0dHIsIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURTsKICAgICAgICB9CiAgICB9CiAgICBfYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgY29uc3QgcHJvcE5hbWUgPSBjdG9yLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwLmdldChuYW1lKTsKICAgICAgICBpZiAocHJvcE5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBvcHRpb25zID0gY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMocHJvcE5hbWUpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICAgICAgdGhpc1twcm9wTmFtZV0gPSBjdG9yLl9wcm9wZXJ0eVZhbHVlRnJvbUF0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICB9CiAgICB9CiAgICByZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBsZXQgc2hvdWxkUmVxdWVzdFVwZGF0ZSA9IHRydWU7CiAgICAgICAgaWYgKG5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwgY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSk7CiAgICAgICAgICAgIGlmIChjdG9yLl92YWx1ZUhhc0NoYW5nZWQodGhpc1tuYW1lXSwgb2xkVmFsdWUsIG9wdGlvbnMuaGFzQ2hhbmdlZCkpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuaGFzKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuc2V0KG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHRydWUgJiYgISh0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLnNldChuYW1lLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNob3VsZFJlcXVlc3RVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSAmJiBzaG91bGRSZXF1ZXN0VXBkYXRlKSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSB0aGlzLl9lbnF1ZXVlVXBkYXRlKCk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZShuYW1lLCBvbGRWYWx1ZSkgewogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVDb21wbGV0ZTsKICAgIH0KICAgIGFzeW5jIF9lbnF1ZXVlVXBkYXRlKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm1VcGRhdGUoKTsKICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgYXdhaXQgcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZTsKICAgIH0KICAgIGdldCBfaGFzUmVxdWVzdGVkVXBkYXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICB9CiAgICBnZXQgaGFzVXBkYXRlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiAxOwogICAgfQogICAgcGVyZm9ybVVwZGF0ZSgpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMpIHsKICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgICAgIGNvbnN0IGNoYW5nZWRQcm9wZXJ0aWVzID0gdGhpcy5fY2hhbmdlZFByb3BlcnRpZXM7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdGhpcy5zaG91bGRVcGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoISh0aGlzLl91cGRhdGVTdGF0ZSAmIDEpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSEFTX1VQREFURUQ7CiAgICAgICAgICAgICAgICB0aGlzLmZpcnN0VXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGVkKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICB9CiAgICB9CiAgICBfbWFya1VwZGF0ZWQoKSB7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IHVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgX2dldFVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldFVwZGF0ZUNvbXBsZXRlKCk7CiAgICB9CiAgICBnZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlUHJvbWlzZTsKICAgIH0KICAgIHNob3VsZFVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBpZiAodGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgIT09IHZvaWQgMCAmJiB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fcHJvcGVydHlUb0F0dHJpYnV0ZShrLCB0aGlzW2tdLCB2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgIH0KICAgIHVwZGF0ZWQoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7fQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykge30KfQpfYSA9IGZpbmFsaXplZDsKVXBkYXRpbmdFbGVtZW50W19hXSA9IHRydWU7CmNvbnN0IEVsZW1lbnRQcm90byA9IEVsZW1lbnQucHJvdG90eXBlOwpFbGVtZW50UHJvdG8ubXNNYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudFByb3RvLndlYmtpdE1hdGNoZXNTZWxlY3RvcjsKY29uc3Qgc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzID0gd2luZG93LlNoYWRvd1Jvb3QgJiYgKHdpbmRvdy5TaGFkeUNTUyA9PT0gdm9pZCAwIHx8IHdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpICYmICJhZG9wdGVkU3R5bGVTaGVldHMiIGluIERvY3VtZW50LnByb3RvdHlwZSAmJiAicmVwbGFjZSIgaW4gQ1NTU3R5bGVTaGVldC5wcm90b3R5cGU7CmNvbnN0IGNvbnN0cnVjdGlvblRva2VuID0gU3ltYm9sKCk7CmNsYXNzIENTU1Jlc3VsdCB7CiAgICBjb25zdHJ1Y3Rvcihjc3NUZXh0LCBzYWZlVG9rZW4pewogICAgICAgIGlmIChzYWZlVG9rZW4gIT09IGNvbnN0cnVjdGlvblRva2VuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ1NTUmVzdWx0IGlzIG5vdCBjb25zdHJ1Y3RhYmxlLiBVc2UgYHVuc2FmZUNTU2Agb3IgYGNzc2AgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgIH0KICAgIGdldCBzdHlsZVNoZWV0KCkgewogICAgICAgIGlmICh0aGlzLl9zdHlsZVNoZWV0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0LnJlcGxhY2VTeW5jKHRoaXMuY3NzVGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmNzc1RleHQ7CiAgICB9Cn0KY29uc3QgdW5zYWZlQ1NTID0gKHZhbHVlKT0+ewogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoU3RyaW5nKHZhbHVlKSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owpjb25zdCB0ZXh0RnJvbUNTU1Jlc3VsdCA9ICh2YWx1ZSk9PnsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENTU1Jlc3VsdCkgewogICAgICAgIHJldHVybiB2YWx1ZS5jc3NUZXh0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZhbHVlIHBhc3NlZCB0byAnY3NzJyBmdW5jdGlvbiBtdXN0IGJlIGEgJ2NzcycgZnVuY3Rpb24gcmVzdWx0OiAke3ZhbHVlfS4gVXNlICd1bnNhZmVDU1MnIHRvIHBhc3Mgbm9uLWxpdGVyYWwgdmFsdWVzLCBidXQKICAgICAgICAgICAgdGFrZSBjYXJlIHRvIGVuc3VyZSBwYWdlIHNlY3VyaXR5LmApOwogICAgfQp9Owpjb25zdCBjc3MgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+ewogICAgY29uc3QgY3NzVGV4dCA9IHZhbHVlcy5yZWR1Y2UoKGFjYywgdiwgaWR4KT0+YWNjICsgdGV4dEZyb21DU1NSZXN1bHQodikgKyBzdHJpbmdzW2lkeCArIDFdCiAgICAsIHN0cmluZ3NbMF0pOwogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoY3NzVGV4dCwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owood2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSB8fCAod2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSA9IFtdKSkucHVzaCgiMi41LjEiKTsKY29uc3QgcmVuZGVyTm90SW1wbGVtZW50ZWQgPSB7fTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKYXN5bmMgZnVuY3Rpb24gbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0c2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RTY3JpcHRzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdFRhaWxzKGFjY291bnRJZCwgc2NyaXB0TmFtZSwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpfS93b3JrZXJzL3NjcmlwdHMvJHtzY3JpcHROYW1lfS90YWlsc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RUYWlscycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnY3JlYXRlVGFpbCcsICdQT1NUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04JzsKY29uc3QgQVBQTElDQVRJT05fT0NURVRfU1RSRUFNID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmNvbnN0IFRFWFRfUExBSU5fVVRGOCA9ICd0ZXh0L3BsYWluOyBjaGFyc2V0PVVURi04JzsKZnVuY3Rpb24gY29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCkgewogICAgcmV0dXJuIENsb3VkZmxhcmVBcGkuVVJMX1RSQU5TRk9STUVSKGBodHRwczovL2FwaS5jbG91ZGZsYXJlLmNvbS9jbGllbnQvdjQvYWNjb3VudHMvJHthY2NvdW50SWR9YCk7Cn0KZnVuY3Rpb24gaXNTdHJpbmdSZWNvcmQob2JqKSB7CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KG9iaikgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3Q7Cn0KYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZShvcCwgbWV0aG9kLCB1cmwsIGFwaVRva2VuLCBib2R5LCByZXNwb25zZVR5cGUgPSAnanNvbicpIHsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhgJHtvcH06ICR7bWV0aG9kfSAke3VybH1gKTsKICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyh7CiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YXBpVG9rZW59YAogICAgfSk7CiAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsIFRFWFRfUExBSU5fVVRGOCk7CiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nUmVjb3JkKGJvZHkpKSB7CiAgICAgICAgaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsIEFQUExJQ0FUSU9OX0pTT05fVVRGOCk7CiAgICAgICAgYm9keSA9IEpTT04uc3RyaW5naWZ5KGJvZHkpOwogICAgICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhib2R5KTsKICAgIH0KICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhgJHtmZXRjaFJlc3BvbnNlLnN0YXR1c30gJHtmZXRjaFJlc3BvbnNlLnVybH1gKTsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhbCiAgICAgICAgLi4uZmV0Y2hSZXNwb25zZS5oZWFkZXJzCiAgICBdLm1hcCgodik9PnYuam9pbignOiAnKQogICAgKS5qb2luKCdcbicpKTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZmV0Y2hSZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJykgfHwgJyc7CiAgICBpZiAoKHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzJyB8fCByZXNwb25zZVR5cGUgPT09ICdieXRlcz8nKSAmJiBjb250ZW50VHlwZSA9PT0gQVBQTElDQVRJT05fT0NURVRfU1RSRUFNKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKHJlc3BvbnNlVHlwZSA9PT0gJ3RleHQ/JyAmJiBjb250ZW50VHlwZS5zdGFydHNXaXRoKCd0ZXh0LycpKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoUmVzcG9uc2UudGV4dCgpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4LAogICAgICAgIEFQUExJQ0FUSU9OX0pTT04KICAgIF0uaW5jbHVkZXMoY29udGVudFR5cGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRlbnQtdHlwZTogJHtjb250ZW50VHlwZX0sIGZldGNoUmVzcG9uc2U9JHtmZXRjaFJlc3BvbnNlfSwgYm9keT0ke2F3YWl0IGZldGNoUmVzcG9uc2UudGV4dCgpfWApOwogICAgfQogICAgY29uc3QgYXBpUmVzcG9uc2UgPSBhd2FpdCBmZXRjaFJlc3BvbnNlLmpzb24oKTsKICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhhcGlSZXNwb25zZSk7CiAgICBpZiAoIWFwaVJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAoZmV0Y2hSZXNwb25zZS5zdGF0dXMgPT09IDQwNCAmJiBbCiAgICAgICAgICAgICdieXRlcz8nLAogICAgICAgICAgICAnanNvbj8nCiAgICAgICAgXS5pbmNsdWRlcyhyZXNwb25zZVR5cGUpKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHRocm93IG5ldyBDbG91ZGZsYXJlQXBpRXJyb3IoYCR7b3B9IGZhaWxlZDogc3RhdHVzPSR7ZmV0Y2hSZXNwb25zZS5zdGF0dXN9LCBlcnJvcnM9JHthcGlSZXNwb25zZS5lcnJvcnMubWFwKCh2KT0+YCR7di5jb2RlfSAke3YubWVzc2FnZX1gCiAgICAgICAgKS5qb2luKCcsICcpfWAsIGZldGNoUmVzcG9uc2Uuc3RhdHVzLCBhcGlSZXNwb25zZS5lcnJvcnMpOwogICAgfQogICAgcmV0dXJuIGFwaVJlc3BvbnNlOwp9CmNsYXNzIENsb3VkZmxhcmVBcGlFcnJvciBleHRlbmRzIEVycm9yIHsKICAgIHN0YXR1czsKICAgIGVycm9yczsKICAgIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIHN0YXR1cywgZXJyb3JzKXsKICAgICAgICBzdXBlcihtZXNzYWdlKTsKICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgIH0KfQpmdW5jdGlvbiBzZXRTdWJ0cmFjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KGxocyk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmhzKXsKICAgICAgICBydC5kZWxldGUoaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0VW5pb24obGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldChsaHMpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIHJocyl7CiAgICAgICAgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldEludGVyc2VjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgbGhzKXsKICAgICAgICBpZiAocmhzLmhhcyhpdGVtKSkgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgZm9yIChjb25zdCBpdGVtMSBvZiByaHMpewogICAgICAgIGlmIChsaHMuaGFzKGl0ZW0xKSkgcnQuYWRkKGl0ZW0xKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBzZXRFcXVhbChsaHMsIHJocykgewogICAgcmV0dXJuIGxocy5zaXplID09PSByaHMuc2l6ZSAmJiBbCiAgICAgICAgLi4ubGhzCiAgICBdLmV2ZXJ5KCh2KT0+cmhzLmhhcyh2KQogICAgKTsKfQpmdW5jdGlvbiBwYXJzZUhlYWRlckZpbHRlcihoZWFkZXIpIHsKICAgIGNvbnN0IGkgPSBoZWFkZXIuaW5kZXhPZignOicpOwogICAgaWYgKGkgPCAwKSByZXR1cm4gewogICAgICAgIGtleTogaGVhZGVyCiAgICB9OwogICAgY29uc3Qga2V5ID0gaGVhZGVyLnN1YnN0cmluZygwLCBpKS50cmltKCk7CiAgICBjb25zdCBxdWVyeTEgPSBoZWFkZXIuc3Vic3RyaW5nKGkgKyAxKS50cmltKCk7CiAgICByZXR1cm4gewogICAgICAgIGtleSwKICAgICAgICBxdWVyeTogcXVlcnkxCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9LRVlTID0gbmV3IFNldChbCiAgICAnb3V0Y29tZScsCiAgICAnc2NyaXB0TmFtZScsCiAgICAnZXhjZXB0aW9ucycsCiAgICAnbG9ncycsCiAgICAnZXZlbnRUaW1lc3RhbXAnLAogICAgJ2V2ZW50JwpdKTsKY29uc3QgS05PV05fT1VUQ09NRVMgPSBuZXcgU2V0KFsKICAgICdvaycsCiAgICAnZXhjZXB0aW9uJywKICAgICdleGNlZWRlZENwdScsCiAgICAnY2FuY2VsZWQnLAogICAgJ3Vua25vd24nCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBvdXRjb21lICwgc2NyaXB0TmFtZSAsIGV2ZW50VGltZXN0YW1wICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoIUtOT1dOX09VVENPTUVTLmhhcyhvdXRjb21lKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgb3V0Y29tZTogZXhwZWN0ZWQgb25lIG9mIFske1sKICAgICAgICAuLi5LTk9XTl9PVVRDT01FUwogICAgXS5qb2luKCcsICcpfV0sIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob3V0Y29tZSl9YCk7CiAgICBpZiAoc2NyaXB0TmFtZSAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgc2NyaXB0TmFtZTogZXhwZWN0ZWQgbnVsbCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShzY3JpcHROYW1lKX1gKTsKICAgIGNvbnN0IGxvZ3MgPSBwYXJzZUxvZ3Mob2JqQXNBbnkubG9ncyk7CiAgICBjb25zdCBleGNlcHRpb25zID0gcGFyc2VFeGNlcHRpb25zKG9iakFzQW55LmV4Y2VwdGlvbnMpOwogICAgaWYgKCEodHlwZW9mIGV2ZW50VGltZXN0YW1wID09PSAnbnVtYmVyJyAmJiBldmVudFRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBldmVudFRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KGV2ZW50VGltZXN0YW1wKX1gKTsKICAgIGNvbnN0IGV2ZW50ID0gb2JqQXNBbnkuZXZlbnQgJiYgb2JqQXNBbnkuZXZlbnQucmVxdWVzdCA/IHBhcnNlVGFpbE1lc3NhZ2VSZXF1ZXN0RXZlbnQob2JqQXNBbnkuZXZlbnQpIDogcGFyc2VUYWlsTWVzc2FnZUNyb25FdmVudChvYmpBc0FueS5ldmVudCk7CiAgICByZXR1cm4gewogICAgICAgIG91dGNvbWUsCiAgICAgICAgc2NyaXB0TmFtZSwKICAgICAgICBleGNlcHRpb25zLAogICAgICAgIGxvZ3MsCiAgICAgICAgZXZlbnRUaW1lc3RhbXAsCiAgICAgICAgZXZlbnQKICAgIH07Cn0KZnVuY3Rpb24gcGFyc2VMb2dzKG9iaikgewogICAgaWYgKCFBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGxvZ3M6IGV4cGVjdGVkIGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICByZXR1cm4gWwogICAgICAgIC4uLm9iagogICAgXS5tYXAocGFyc2VUYWlsTWVzc2FnZUxvZyk7Cn0KZnVuY3Rpb24gcGFyc2VFeGNlcHRpb25zKG9iaikgewogICAgaWYgKCFBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGV4Y2VwdGlvbnM6IGV4cGVjdGVkIGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICByZXR1cm4gWwogICAgICAgIC4uLm9iagogICAgXS5tYXAocGFyc2VUYWlsTWVzc2FnZUV4Y2VwdGlvbik7Cn0KZnVuY3Rpb24gaXNMb2dNZXNzYWdlUGFydCh2YWx1ZSkgewogICAgY29uc3QgdCA9IHR5cGVvZiB2YWx1ZTsKICAgIHJldHVybiB0ID09PSAnc3RyaW5nJyB8fCB0ID09PSAnbnVtYmVyJyB8fCB0ID09PSAnYm9vbGVhbicgfHwgdCA9PT0gJ3VuZGVmaW5lZCcgfHwgdCA9PT0gJ29iamVjdCc7Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0xPR19LRVlTID0gbmV3IFNldChbCiAgICAnbWVzc2FnZScsCiAgICAnbGV2ZWwnLAogICAgJ3RpbWVzdGFtcCcKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VMb2cob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VMb2c6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0xPR19LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgbWVzc2FnZSA9IHBhcnNlTG9nTWVzc2FnZVBhcnRBcnJheShvYmpBc0FueS5tZXNzYWdlLCAnbWVzc2FnZScpOwogICAgY29uc3QgeyBsZXZlbCAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIGxldmVsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGxldmVsOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobGV2ZWwpfWApOwogICAgaWYgKCEodHlwZW9mIHRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgdGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHRpbWVzdGFtcCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG1lc3NhZ2UsCiAgICAgICAgbGV2ZWwsCiAgICAgICAgdGltZXN0YW1wCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FWENFUFRJT05fS0VZUyA9IG5ldyBTZXQoWwogICAgJ25hbWUnLAogICAgJ21lc3NhZ2UnLAogICAgJ3RpbWVzdGFtcCcKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VFeGNlcHRpb24ob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VFeGNlcHRpb246IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VYQ0VQVElPTl9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBuYW1lICwgbWVzc2FnZSAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbmFtZTogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG5hbWUpfWApOwogICAgaWYgKCEodHlwZW9mIG1lc3NhZ2UgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVzc2FnZTogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1lc3NhZ2UpfWApOwogICAgaWYgKCEodHlwZW9mIHRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgdGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHRpbWVzdGFtcCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG5hbWUsCiAgICAgICAgbWVzc2FnZSwKICAgICAgICB0aW1lc3RhbXAKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2Nyb24nLAogICAgJ3NjaGVkdWxlZFRpbWUnCl0pOwpmdW5jdGlvbiBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKG9iaikpOwogICAgcmV0dXJuIHNldEVxdWFsKGtleXMsIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMpOwp9CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VDcm9uRXZlbnQ6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgY3JvbiAsIHNjaGVkdWxlZFRpbWUgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBjcm9uID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGNyb246IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShjcm9uKX1gKTsKICAgIGlmICghKHR5cGVvZiBzY2hlZHVsZWRUaW1lID09PSAnbnVtYmVyJyAmJiBzY2hlZHVsZWRUaW1lID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjaGVkdWxlZFRpbWU6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShzY2hlZHVsZWRUaW1lKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgY3JvbiwKICAgICAgICBzY2hlZHVsZWRUaW1lCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9SRVFVRVNUX0VWRU5UX0tFWVMgPSBuZXcgU2V0KFsKICAgICdyZXF1ZXN0JwpdKTsKY29uc3QgT1BUSU9OQUxfVEFJTF9NRVNTQUdFX1JFUVVFU1RfRVZFTlRfS0VZUyA9IG5ldyBTZXQoWwogICAgJ3Jlc3BvbnNlJwpdKTsKY29uc3QgQUxMX1RBSUxfTUVTU0FHRV9SRVFVRVNUX0VWRU5UX0tFWVMgPSBzZXRVbmlvbihSRVFVSVJFRF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTLCBPUFRJT05BTF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZVJlcXVlc3RFdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZVJlcXVlc3RFdmVudDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTLCBBTExfVEFJTF9NRVNTQUdFX1JFUVVFU1RfRVZFTlRfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHJlcXVlc3QgPSBwYXJzZVRhaWxNZXNzYWdlRXZlbnRSZXF1ZXN0KG9iakFzQW55LnJlcXVlc3QpOwogICAgY29uc3QgcmVzcG9uc2UgPSBwYXJzZVRhaWxNZXNzYWdlRXZlbnRSZXNwb25zZShvYmpBc0FueS5yZXNwb25zZSk7CiAgICByZXR1cm4gewogICAgICAgIHJlcXVlc3QsCiAgICAgICAgcmVzcG9uc2UKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ3VybCcsCiAgICAnbWV0aG9kJywKICAgICdoZWFkZXJzJwpdKTsKY29uc3QgT1BUSU9OQUxfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2NmJwpdKTsKY29uc3QgQUxMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBzZXRVbmlvbihSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBPUFRJT05BTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUV2ZW50UmVxdWVzdChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUV2ZW50UmVxdWVzdDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBBTExfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgdXJsICwgbWV0aG9kICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIHVybDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7CiAgICBpZiAoISh0eXBlb2YgbWV0aG9kID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG1ldGhvZDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1ldGhvZCl9YCk7CiAgICBjb25zdCBoZWFkZXJzID0gcGFyc2VTdHJpbmdSZWNvcmQob2JqQXNBbnkuaGVhZGVycywgJ2hlYWRlcnMnKTsKICAgIGNvbnN0IGNmID0gb2JqQXNBbnkuY2YgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iakFzQW55LmNmKTsKICAgIHJldHVybiB7CiAgICAgICAgdXJsLAogICAgICAgIG1ldGhvZCwKICAgICAgICBoZWFkZXJzLAogICAgICAgIGNmCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVNQT05TRV9LRVlTID0gbmV3IFNldChbCiAgICAnc3RhdHVzJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUV2ZW50UmVzcG9uc2Uob2JqKSB7CiAgICBpZiAob2JqID09PSB1bmRlZmluZWQpIHJldHVybiB1bmRlZmluZWQ7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VFdmVudFJlc3BvbnNlOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVNQT05TRV9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgeyBzdGF0dXMgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBzdGF0dXMgPT09ICdudW1iZXInKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgc3RhdHVzOiBleHBlY3RlZCBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoc3RhdHVzKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgc3RhdHVzCiAgICB9Owp9CmZ1bmN0aW9uIGNoZWNrS2V5cyhvYmosIHJlcXVpcmVkS2V5cywgYWxsS2V5cykgewogICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoT2JqZWN0LmtleXMob2JqKSk7CiAgICBjb25zdCBtaXNzaW5nS2V5cyA9IHNldFN1YnRyYWN0KHJlcXVpcmVkS2V5cywga2V5cyk7CiAgICBpZiAobWlzc2luZ0tleXMuc2l6ZSA+IDApIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBrZXlzOiAke1sKICAgICAgICAuLi5taXNzaW5nS2V5cwogICAgXS5qb2luKCcsICcpfWApOwogICAgY29uc3QgZXh0cmFLZXlzID0gc2V0U3VidHJhY3Qoa2V5cywgYWxsS2V5cyB8fCByZXF1aXJlZEtleXMpOwogICAgaWYgKGV4dHJhS2V5cy5zaXplID4gMCkgdGhyb3cgbmV3IEVycm9yKGBFeHRyYSBrZXlzOiAke1sKICAgICAgICAuLi5leHRyYUtleXMKICAgIF0uam9pbignLCAnKX1gKTsKfQpmdW5jdGlvbiBwYXJzZVN0cmluZ1JlY29yZChvYmosIG5hbWUpIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBzdHJpbmcgcmVjb3JkLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBmb3IgKGNvbnN0IFtfLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqKSl7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IEV4cGVjdGVkIHN0cmluZyByZWNvcmQsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIH0KICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gcGFyc2VMb2dNZXNzYWdlUGFydEFycmF5KG9iaiwgbmFtZSkgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8ICFBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IEV4cGVjdGVkIGxvZyBtZXNzYWdlIHBhcnQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2Ygb2JqKXsKICAgICAgICBpZiAoIWlzTG9nTWVzc2FnZVBhcnQodmFsdWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBsb2cgbWVzc2FnZSBwYXJ0IGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICB9CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGNmOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZSwgbG9nZ2VyLCBhZGRpdGlvbmFsTG9ncyA9IFtdKSB7CiAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZShtZXNzYWdlLmV2ZW50VGltZXN0YW1wKSk7CiAgICBjb25zdCBvdXRjb21lID0gUFJFVFRZX09VVENPTUVTLmdldChtZXNzYWdlLm91dGNvbWUpIHx8IG1lc3NhZ2Uub3V0Y29tZTsKICAgIGNvbnN0IG91dGNvbWVDb2xvciA9IG1lc3NhZ2Uub3V0Y29tZSA9PT0gJ29rJyA/ICdncmVlbicgOiAncmVkJzsKICAgIGNvbnN0IHsgcHJvcHMgLCByZW1haW5pbmdMb2dzICB9ID0gcGFyc2VMb2dQcm9wcyhtZXNzYWdlLmxvZ3MpOwogICAgaWYgKGlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQobWVzc2FnZS5ldmVudCkpIHsKICAgICAgICBjb25zdCBjb2xvID0gcHJvcHMuY29sbyB8fCAnPz8/JzsKICAgICAgICBsb2dnZXIoYFslYyR7dGltZX0lY10gWyVjJHtjb2xvfSVjXSBbJWMke291dGNvbWV9JWNdICVjJHttZXNzYWdlLmV2ZW50LmNyb259YCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6ICR7b3V0Y29tZUNvbG9yfWAsICcnLCAnY29sb3I6IHJlZDsgZm9udC1zdHlsZTogYm9sZDsnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgeyBtZXRob2QgLCB1cmwgLCBjZiAgfSA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdDsKICAgICAgICBjb25zdCB1bnJlZGFjdGVkVXJsID0gdHlwZW9mIHByb3BzLnVybCA9PT0gJ3N0cmluZycgPyBwcm9wcy51cmwgOiB1cmw7CiAgICAgICAgY29uc3QgY29sbyA9IGNmPy5jb2xvIHx8IHByb3BzLmNvbG8gfHwgJz8/Pyc7CiAgICAgICAgaWYgKGNmID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29uc3QgeyBkdXJhYmxlT2JqZWN0Q2xhc3MgLCBkdXJhYmxlT2JqZWN0TmFtZSAsIGR1cmFibGVPYmplY3RJZCAgfSA9IGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcyk7CiAgICAgICAgICAgIGNvbnN0IGRvVGVtcGxhdGVzID0gW107CiAgICAgICAgICAgIGNvbnN0IGRvU3R5bGVzID0gW107CiAgICAgICAgICAgIGlmIChkdXJhYmxlT2JqZWN0Q2xhc3MpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0Q2xhc3N9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWNsYXNzOiAnJHtkdXJhYmxlT2JqZWN0Q2xhc3N9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0TmFtZX0lY2ApOwogICAgICAgICAgICAgICAgZG9TdHlsZXMucHVzaChgY29sb3I6IGdyYXk7IHgtZHVyYWJsZS1vYmplY3QtbmFtZTogJyR7ZHVyYWJsZU9iamVjdE5hbWV9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdElkKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlYyR7Y29tcHV0ZVNob3J0RHVyYWJsZU9iamVjdElkKGR1cmFibGVPYmplY3RJZCl9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWlkOiAnJHtkdXJhYmxlT2JqZWN0SWR9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZG9UZW1wbGF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlY0RPJWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goJ2NvbG9yOiBncmF5JywgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gWyR7ZG9UZW1wbGF0ZXMuam9pbignICcpfV0gJHttZXRob2R9ICVjJHt1bnJlZGFjdGVkVXJsfWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgLi4uZG9TdHlsZXMsICdjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkOycpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gJHttZXRob2R9ICVjJHt1bnJlZGFjdGVkVXJsfWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCB7IGRhdGE6IGRhdGEyICB9IG9mIGFkZGl0aW9uYWxMb2dzKXsKICAgICAgICBsb2dnZXIoLi4uZGF0YTIpOwogICAgfQogICAgZm9yIChjb25zdCB7IGxldmVsICwgbWVzc2FnZTogbG9nTWVzc2FnZSAgfSBvZiByZW1haW5pbmdMb2dzKXsKICAgICAgICBjb25zdCBsZXZlbENvbG9yID0gTE9HX0xFVkVMX0NPTE9SUy5nZXQobGV2ZWwpIHx8ICdncmF5JzsKICAgICAgICBjb25zdCBsb2dNZXNzYWdlcyA9IGxvZ01lc3NhZ2UubWFwKGZvcm1hdExvZ01lc3NhZ2VQYXJ0KS5qb2luKCcsICcpOwogICAgICAgIGxvZ2dlcihgICVjfCVjIFslYyR7bGV2ZWx9JWNdICR7bG9nTWVzc2FnZXN9YCwgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtsZXZlbENvbG9yfWAsICcnKTsKICAgIH0KICAgIGZvciAoY29uc3QgeyBuYW1lICwgbWVzc2FnZTogZXhjZXB0aW9uTWVzc2FnZSAgfSBvZiBtZXNzYWdlLmV4Y2VwdGlvbnMpewogICAgICAgIGxvZ2dlcihgICVjfCVjIFslYyR7bmFtZX0lY10gJWMke2V4Y2VwdGlvbk1lc3NhZ2V9YCwgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkYCwgJycsICdjb2xvcjogcmVkJyk7CiAgICB9CiAgICBpZiAoIWlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQobWVzc2FnZS5ldmVudCkpIHsKICAgICAgICBjb25zdCByZXNwb25zZSA9IG1lc3NhZ2UuZXZlbnQucmVzcG9uc2U7CiAgICAgICAgaWYgKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIGxvZ2dlcihgICVjfCVjIFslY3JlcyVjXSAlYyR7cmVzcG9uc2Uuc3RhdHVzfWAsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6IGdyYXlgLCAnJywgJ2NvbG9yOiBncmF5Jyk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MoZGF0ZSkgewogICAgcmV0dXJuIFsKICAgICAgICBkYXRlLmdldEZ1bGxZZWFyKCksCiAgICAgICAgJy0nLAogICAgICAgIHBhZDIoZGF0ZS5nZXRNb250aCgpICsgMSksCiAgICAgICAgJy0nLAogICAgICAgIHBhZDIoZGF0ZS5nZXREYXRlKCkpLAogICAgICAgICcgJywKICAgICAgICBwYWQyKGRhdGUuZ2V0SG91cnMoKSksCiAgICAgICAgJzonLAogICAgICAgIHBhZDIoZGF0ZS5nZXRNaW51dGVzKCkpLAogICAgICAgICc6JywKICAgICAgICBwYWQyKGRhdGUuZ2V0U2Vjb25kcygpKQogICAgXS5qb2luKCcnKTsKfQpmdW5jdGlvbiBwYXJzZUxvZ1Byb3BzKGxvZ3MpIHsKICAgIGNvbnN0IHJlbWFpbmluZ0xvZ3MgPSBbXTsKICAgIGNvbnN0IHByb3BzID0ge307CiAgICBmb3IgKGNvbnN0IGxvZyBvZiBsb2dzKXsKICAgICAgICBpZiAobG9nLm1lc3NhZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBtc2cgPSBsb2cubWVzc2FnZVswXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnICYmIG1zZy5zdGFydHNXaXRoKCdsb2dwcm9wczonKSkgewogICAgICAgICAgICAgICAgY29uc3QgdHJhaWxlciA9IG1zZy5zdWJzdHJpbmcobXNnLmluZGV4T2YoJzonKSArIDEpOwogICAgICAgICAgICAgICAgY29uc3QgdHJhaWxlclByb3BzID0gdHJ5UGFyc2VQcm9wc0Zyb21Kc29uKHRyYWlsZXIpOwogICAgICAgICAgICAgICAgYXBwZW5kUHJvcHModHJhaWxlclByb3BzLCBwcm9wcyk7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgbG9nLm1lc3NhZ2Uuc2xpY2UoMSkpewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRQcm9wcyA9IHRyeVBhcnNlUHJvcHNGcm9tUGFydChwYXJ0KTsKICAgICAgICAgICAgICAgICAgICBhcHBlbmRQcm9wcyhwYXJ0UHJvcHMsIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlbWFpbmluZ0xvZ3MucHVzaChsb2cpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBwcm9wcywKICAgICAgICByZW1haW5pbmdMb2dzCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcykgewogICAgY29uc3QgZHVyYWJsZU9iamVjdENsYXNzID0gdW5kZWZpbmVkSWZFbXB0eSgodHlwZW9mIHByb3BzLmR1cmFibGVPYmplY3RDbGFzcyA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0Q2xhc3MgOiAnJykudHJpbSgpKTsKICAgIGNvbnN0IGR1cmFibGVPYmplY3RJZCA9IHVuZGVmaW5lZElmRW1wdHkoKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0SWQgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdElkIDogJycpLnRyaW0oKSk7CiAgICBjb25zdCBkdXJhYmxlT2JqZWN0TmFtZSA9IHVuZGVmaW5lZElmRW1wdHkoKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA6ICcnKS50cmltKCkpOwogICAgcmV0dXJuIHsKICAgICAgICBkdXJhYmxlT2JqZWN0Q2xhc3MsCiAgICAgICAgZHVyYWJsZU9iamVjdElkLAogICAgICAgIGR1cmFibGVPYmplY3ROYW1lCiAgICB9Owp9CmZ1bmN0aW9uIHVuZGVmaW5lZElmRW1wdHkoc3RyKSB7CiAgICByZXR1cm4gc3RyID09PSAnJyA/IHVuZGVmaW5lZCA6IHN0cjsKfQpmdW5jdGlvbiBjb21wdXRlU2hvcnREdXJhYmxlT2JqZWN0SWQoaWQpIHsKICAgIHJldHVybiAvXlswLTlhLWZBLUZdezUsfSQvLnRlc3QoaWQpID8gYCR7aWQuc3Vic3RyaW5nKDAsIDQpfeKApmAgOiBpZDsKfQpmdW5jdGlvbiBhcHBlbmRQcm9wcyhzcmMsIGRzdCkgewogICAgaWYgKHNyYykgewogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNyYykpewogICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiB0cnlQYXJzZVByb3BzRnJvbUpzb24odmFsdWUpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgcHJvcHMgPSBKU09OLnBhcnNlKHZhbHVlLnRyaW0oKSk7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wcyA9PT0gJ29iamVjdCcgJiYgcHJvcHMgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wczsKICAgICAgICB9CiAgICB9IGNhdGNoICB7fQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiB0cnlQYXJzZVByb3BzRnJvbVBhcnQocGFydCkgewogICAgdHJ5IHsKICAgICAgICBpZiAodHlwZW9mIHBhcnQgPT09ICdvYmplY3QnICYmIHBhcnQgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkocGFydCkpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnQ7CiAgICAgICAgfQogICAgfSBjYXRjaCAge30KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gZm9ybWF0TG9nTWVzc2FnZVBhcnQocGFydCkgewogICAgaWYgKHR5cGVvZiBwYXJ0ID09PSAnb2JqZWN0JykgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHBhcnQpOwogICAgcmV0dXJuIGAke3BhcnR9YDsKfQpmdW5jdGlvbiBwYWQyKG51bSkgewogICAgcmV0dXJuIG51bS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyk7Cn0KY29uc3QgUFJFVFRZX09VVENPTUVTID0gbmV3IE1hcChbCiAgICBbCiAgICAgICAgJ29rJywKICAgICAgICAnT2snCiAgICBdLAogICAgWwogICAgICAgICdleGNlcHRpb24nLAogICAgICAgICdFcnJvcicKICAgIF0sCiAgICBbCiAgICAgICAgJ2V4Y2VlZGVkQ3B1JywKICAgICAgICAnRXhjZWVkZWQgTGltaXQnCiAgICBdLAogICAgWwogICAgICAgICdjYW5jZWxlZCcsCiAgICAgICAgJ0NhbmNlbGVkJwogICAgXSwKICAgIFsKICAgICAgICAndW5rbm93bicsCiAgICAgICAgJ1Vua25vd24nCiAgICBdLCAKXSk7CmNvbnN0IExPR19MRVZFTF9DT0xPUlMgPSBuZXcgTWFwKFsKICAgIFsKICAgICAgICAndHJhY2UnLAogICAgICAgICdncmF5JwogICAgXSwKICAgIFsKICAgICAgICAnZGVidWcnLAogICAgICAgICdwdXJwbGUnCiAgICBdLAogICAgWwogICAgICAgICdsb2cnLAogICAgICAgICdncmF5JwogICAgXSwKICAgIFsKICAgICAgICAnaW5mbycsCiAgICAgICAgJ2dyYXknCiAgICBdLAogICAgWwogICAgICAgICd3YXJuJywKICAgICAgICAncmVkJwogICAgXSwKICAgIFsKICAgICAgICAnZXJyb3InLAogICAgICAgICdyZWQnCiAgICBdLCAKXSk7CmNsYXNzIFRhaWxDb25uZWN0aW9uIHsKICAgIHN0YXRpYyBWRVJCT1NFID0gZmFsc2U7CiAgICB3czsKICAgIGNhbGxiYWNrczsKICAgIG9wdGlvbnM7CiAgICBoZWFydGJlYXRJZDsKICAgIGNvbnN0cnVjdG9yKHdlYlNvY2tldFVybCwgY2FsbGJhY2tzLCBvcHRzKXsKICAgICAgICB0aGlzLndzID0gbmV3IFdlYlNvY2tldCh3ZWJTb2NrZXRVcmwsICd0cmFjZS12MScpOwogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIGNvbnN0IHsgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcyAgfSA9IG9wdHM7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdvcGVuJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICB0aGlzLnNlbmRPcHRpb25zSWZPcGVuKCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3Mub25PcGVuKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25PcGVuKHRoaXMsIHRpbWVTdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoVGFpbENvbm5lY3Rpb24uVkVSQk9TRSkgY29uc29sZS5sb2coZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKSwgYHNlbmRpbmcgd3MgcGluZyB7fSBldmVyeSAke3dlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHN9YCk7CiAgICAgICAgICAgICAgICB0aGlzLmhlYXJ0YmVhdElkID0gc2V0SW50ZXJ2YWwoKCk9PnsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy53cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoVGFpbENvbm5lY3Rpb24uVkVSQk9TRSkgY29uc29sZS5sb2coZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKSwgYHNlbmRpbmcgd3MgcGluZyB7fWApOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndzLnNlbmQoJ3t9Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcyAqIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdjbG9zZScsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyBjb2RlICwgcmVhc29uICwgd2FzQ2xlYW4gLCB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksICdUYWlsQ29ubmVjdGlvbjogd3MgY2xvc2UnLCB7CiAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgcmVhc29uLAogICAgICAgICAgICAgICAgd2FzQ2xlYW4sCiAgICAgICAgICAgICAgICB0aW1lU3RhbXAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFydGJlYXRJZCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3Mub25DbG9zZSkgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uQ2xvc2UodGhpcywgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGNvbnN0IGVycm9ySW5mbyA9IGNvbXB1dGVFcnJvckluZm8oZXZlbnQpOwogICAgICAgICAgICBpZiAoVGFpbENvbm5lY3Rpb24uVkVSQk9TRSkgY29uc29sZS5sb2coZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKSwgJ1RhaWxDb25uZWN0aW9uOiB3cyBlcnJvcicsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3Mub25FcnJvcikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uRXJyb3IodGhpcywgdGltZVN0YW1wLCBlcnJvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgYXN5bmMgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICBpZiAoZXZlbnQuZGF0YSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCBldmVudC5kYXRhLnRleHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IG9iaiA9IEpTT04ucGFyc2UodGV4dCk7CiAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHBhcnNlVGFpbE1lc3NhZ2Uob2JqKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25VbnBhcnNlZE1lc3NhZ2UodGhpcywgdGltZVN0YW1wLCBvYmosIGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgbWVzc2FnZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25VbnBhcnNlZE1lc3NhZ2UodGhpcywgdGltZVN0YW1wLCBldmVudC5kYXRhLCBuZXcgRXJyb3IoYEV4cGVjdGVkIGV2ZW50LmRhdGEgdG8gYmUgQmxvYmApKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgc2V0T3B0aW9ucyhvcHRpb25zKSB7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICB0aGlzLnNlbmRPcHRpb25zSWZPcGVuKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjbG9zZShjb2RlLCByZWFzb24pIHsKICAgICAgICB0aGlzLndzLmNsb3NlKGNvZGUsIHJlYXNvbik7CiAgICB9CiAgICBzZW5kT3B0aW9uc0lmT3BlbigpIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zICYmIHRoaXMud3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICAgICAgY29uc3QgcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhgc2VuZE9wdGlvbnNJZk9wZW46IHNlbmRpbmcgJHtwYXlsb2FkfWApOwogICAgICAgICAgICB0aGlzLndzLnNlbmQocGF5bG9hZCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVFcnJvckluZm8oZXZlbnQpIHsKICAgIGlmIChldmVudC50eXBlID09PSAnZXJyb3InKSB7CiAgICAgICAgY29uc3QgeyBtZXNzYWdlICwgZmlsZW5hbWUgLCBsaW5lbm8gLCBjb2xubyAsIGVycm9yICB9ID0gZXZlbnQ7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgZmlsZW5hbWUsCiAgICAgICAgICAgIGxpbmVubywKICAgICAgICAgICAgY29sbm8sCiAgICAgICAgICAgIGVycm9yCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVVdWlkKCkgewogICAgY29uc3QgY3J5cHRvQXNBbnkgPSBjcnlwdG87CiAgICBpZiAodHlwZW9mIGNyeXB0b0FzQW55LnJhbmRvbVVVSUQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gY3J5cHRvQXNBbnkucmFuZG9tVVVJRCgpOwogICAgfQogICAgY29uc3Qgcm5kcyA9IGNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQ4QXJyYXkoMTYpKTsKICAgIHJuZHNbNl0gPSBybmRzWzZdICYgMHgwZiB8IDB4NDA7CiAgICBybmRzWzhdID0gcm5kc1s4XSAmIDB4M2YgfCAweDgwOwogICAgcmV0dXJuIGJ5dGVzVG9VdWlkKHJuZHMpOwp9CmZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ5dGVzKSB7CiAgICBjb25zdCBiaXRzID0gWwogICAgICAgIC4uLmJ5dGVzCiAgICBdLm1hcCgoYml0KT0+ewogICAgICAgIGNvbnN0IHMgPSBiaXQudG9TdHJpbmcoMTYpOwogICAgICAgIHJldHVybiBiaXQgPCAweDEwID8gIjAiICsgcyA6IHM7CiAgICB9KTsKICAgIHJldHVybiBbCiAgICAgICAgLi4uYml0cy5zbGljZSgwLCA0KSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSg0LCA2KSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSg2LCA4KSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSg4LCAxMCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoMTAsIDE2KSwgCiAgICBdLmpvaW4oIiIpOwp9CmNsYXNzIE1hdGVyaWFsIHsKICAgIHN0YXRpYyBoaWdoRW1waGFzaXNUZXh0Q29sb3IgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjg3KSc7CiAgICBzdGF0aWMgbWVkaXVtRW1waGFzaXNUZXh0Q29sb3IgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKSc7Cn0KY29uc3QgTUFURVJJQUxfQ1NTID0gY3NzYAoKOnJvb3QgewogIC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yOiByZ2IoMzAuNzUsIDMwLjc1LCAzMC43NSk7CiAgLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3I6IHJnYig0MC45NSwgNDAuOTUsIDQwLjk1KTsKICAtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjg3KTsKICAtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNjApOwogIC0tZGlzYWJsZWQtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjM4KTsKICAtLWJ1dHRvbi1ib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogIC0tcHJpbWFyeS1jb2xvcjogI2JiODZmYzsKICAtLWJhY2tncm91bmQtY29sb3I6ICMxMjEyMTI7CiAgLS1zYW5zLXNlcmlmLWZvbnQtZmFtaWx5OiAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsIGF2ZW5pciBuZXh0LCBhdmVuaXIsIGhlbHZldGljYSBuZXVlLCBoZWx2ZXRpY2EsIFVidW50dSwgcm9ib3RvLCBub3RvLCBzZWdvZSB1aSwgYXJpYWwsIHNhbnMtc2VyaWY7CiAgLS1tb25vc3BhY2UtZm9udC1mYW1pbHk6IE1lbmxvLCBDb25zb2xhcywgdWktbW9ub3NwYWNlLCBtb25vc3BhY2U7Cn0KCi8qKiB0ZXh0IHNpemUgY2xhc3NlcyAqLwoKLmg2IHsKICAgIGZvbnQtc2l6ZTogMS4yNXJlbTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjAwNzUwcmVtOwogICAgZm9udC13ZWlnaHQ6IGJvbGRlcjsKfQoKLmJvZHkyLCBmaWVsZHNldCBsYWJlbCwgZmllbGRzZXQgb3V0cHV0LCBmaWVsZHNldCBkZXRhaWxzIHsKICAgIGZvbnQtc2l6ZTogMC44NzVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMTc4NnJlbTsKICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7CiAgICBsaW5lLWhlaWdodDogMS4yNXJlbTsKfQoKLmJ1dHRvbiwgYnV0dG9uLCAuYWN0aW9uLWljb24gewogICAgZm9udC1zaXplOiAwLjg3NXJlbTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMC4wODkyOXJlbTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkZXI7Cn0KCi5vdmVybGluZSwgdGggewogICAgZm9udC1zaXplOiAwLjYyNXJlbTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMC4xNTAwMHJlbTsKICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7Cn0KCi5jYXB0aW9uIHsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjAzMzMzcmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKfQoKLyogbGlnaHQgdGV4dCBvbiBkYXJrIGJhY2tncm91bmQgY29sb3JzICovCgouaGlnaC1lbXBoYXNpcy10ZXh0IHsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgoubWVkaXVtLWVtcGhhc2lzLXRleHQsIGZpZWxkc2V0IGxhYmVsLCB0aCB7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgouZGlzYWJsZWQtZW1waGFzaXMtdGV4dCB7CiAgICBjb2xvcjogdmFyKC0tZGlzYWJsZWQtdGV4dC1jb2xvcik7Cn0KCi8qKiBlbGV2YXRpb24gYmFja2dyb3VuZHMgKi8KCi5zdXJmYWNlLTAxIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcik7Cn0KCi5zdXJmYWNlLTA0IHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7Cn0KCi8qKiBhY3Rpb24taWNvbiAqLwoKLmFjdGlvbi1pY29uIHsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBtaW4taGVpZ2h0OiAycmVtOwogICAgbWluLXdpZHRoOiAycmVtOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBvcGFjaXR5OiAwLjY5OyAgLyoqIG1lZGl1bS1lbXBoYXNpcyAvIGhpZ2gtZW1waGFzaXMgKi8KICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgLmFjdGlvbi1pY29uOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwogICAgICAgIG9wYWNpdHk6IDE7CiAgICB9Cn0KCi8qKiBidXR0b24gKi8KCmJ1dHRvbiB7CiAgICBib3JkZXI6IG5vbmU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBtaW4td2lkdGg6IDhyZW07CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7Cn0KCmJ1dHRvbi5zZWxlY3RlZCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCkBtZWRpYSAoaG92ZXIpIHsKICAgIGJ1dHRvbjpob3ZlciB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgICAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIH0KfQoKYnV0dG9uOmRpc2FibGVkIHsKICAgIGNvbG9yOiB2YXIoLS1kaXNhYmxlZC10ZXh0LWNvbG9yKTsKfQoKQG1lZGlhIChob3ZlcikgewogICAgYnV0dG9uOmRpc2FibGVkOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwogICAgICAgIGN1cnNvcjogZGVmYXVsdDsKICAgIH0KfQoKLyoqIGFuY2hvcnMgKi8KCmEgewogICAgY29sb3I6IHZhcigtLXByaW1hcnktY29sb3IpOwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjJyZW07CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICBhOmhvdmVyIHsKICAgICAgICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsKICAgIH0KfQoKLyoqIGZvcm1zICovCgpmaWVsZHNldCB7CiAgICBib3JkZXI6IHNvbGlkIDFweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNjApOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtcm93LWdhcDogMXJlbTsKICAgIGdyaWQtY29sdW1uLWdhcDogMXJlbTsKICAgIHBhZGRpbmc6IDFyZW07Cn0KCmxhYmVsIHsKICAgIGdyaWQtY29sdW1uOiAxOwogICAgcGFkZGluZzogMC41cmVtIDA7Cn0KCi5mb3JtLWxocyB7CiAgICBncmlkLWNvbHVtbjogMTsKfQoKaW5wdXQsIC5mb3JtLXJocyB7CiAgICBncmlkLWNvbHVtbjogMjsKICAgIG1pbi13aWR0aDogMDsKfQoKLmZvcm0tcm93IHsKICAgIGdyaWQtY29sdW1uOiAxIC8gc3BhbiAyOwp9CgpmaWVsZHNldCBpbnB1dFt0eXBlPXRleHRdIHsKICAgIHBhZGRpbmc6IDAuNXJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcik7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGJvcmRlcjogc29saWQgMXB4IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKfQoKZmllbGRzZXQgb3V0cHV0IHsKICAgIHBhZGRpbmc6IDAuNXJlbSAwOwogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKZmllbGRzZXQgZGV0YWlscyB7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpgOwpjb25zdCBIRUFERVJfSFRNTCA9IGh0bWxgCjxoZWFkZXIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCI+CiAgICA8ZGl2IGlkPSJoZWFkZXItY29udGVudCI+CiAgICAgICAgV2VidGFpbAogICAgICAgIDxzcGFuIGlkPSJoZWFkZXItdmVyc2lvbiIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L3NwYW4+CiAgICAgICAgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL3NreW1ldGhvZC9kZW5vZmxhcmUiIHRhcmdldD0iX2JsYW5rIiBpZD0iZ2l0aHViLWxvZ28tYW5jaG9yIj48aW1nIGlkPSJnaXRodWItbG9nbyI+PC9hPgogICAgPC9kaXY+CjwvaGVhZGVyPgpgOwpjb25zdCBIRUFERVJfQ1NTID0gY3NzYApoZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIHBhZGRpbmc6IDFyZW0gMDsKICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwp9CgojaGVhZGVyLWNvbnRlbnQgewogICAgZmxleC1ncm93OiAxOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBiYXNlbGluZTsKICAgIHBhZGRpbmctcmlnaHQ6IDIuMnJlbTsKfQoKI2hlYWRlci12ZXJzaW9uIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI2dpdGh1Yi1sb2dvLWFuY2hvciB7CiAgICBsaW5lLWhlaWdodDogMDsKICAgIG9wYWNpdHk6IDAuNTsKfQoKQG1lZGlhIChob3ZlcjogaG92ZXIpIHsKICAgICNnaXRodWItbG9nby1hbmNob3I6aG92ZXIgewogICAgICAgIG9wYWNpdHk6IDAuNzU7CiAgICB9Cn0KCiNnaXRodWItbG9nbyB7CiAgICB3aWR0aDogMXJlbTsKICAgIG1hcmdpbi1ib3R0b206IC0wLjFyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRIZWFkZXIoZG9jdW1lbnQsIHZtMSwgZGF0YTMpIHsKICAgIGNvbnN0IGhlYWRlckNvbnRlbnRFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlYWRlci1jb250ZW50Jyk7CiAgICBpZiAoKGRhdGEzLmZsYWdzIHx8ICcnKS5pbmNsdWRlcygnZGVtby10b2dnbGUnKSkgewogICAgICAgIGhlYWRlckNvbnRlbnRFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RibGNsaWNrJywgKGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdm0xLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBoZWFkZXJWZXJzaW9uU3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFkZXItdmVyc2lvbicpOwogICAgY29uc3QgeyB2ZXJzaW9uICB9ID0gZGF0YTM7CiAgICBoZWFkZXJWZXJzaW9uU3Bhbi50ZXh0Q29udGVudCA9IHZlcnNpb24gPyBgdiR7dmVyc2lvbn1gIDogJyc7CiAgICBjb25zdCBnaXRodWJMb2dvSW1nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dpdGh1Yi1sb2dvJyk7CiAgICBnaXRodWJMb2dvSW1nLnNyYyA9IGNvbXB1dGVHaXRodWJMb2dvRGF0YVVybCgpOwogICAgcmV0dXJuICgpPT57fTsKfQpmdW5jdGlvbiBjb21wdXRlR2l0aHViTG9nb0RhdGFVcmwoKSB7CiAgICBjb25zdCBzdmcxID0gR0lUSFVCX0xPR08ucmVwbGFjZSgnZmlsbDp3aGl0ZTsnLCBgZmlsbDoke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn07YCk7CiAgICByZXR1cm4gJ2RhdGE6aW1hZ2Uvc3ZnK3htbDt1dGY4LCcgKyBzdmcxOwp9CmNvbnN0IEdJVEhVQl9MT0dPID0gYDxzdmcgd2lkdGg9ImF1dG8iIGhlaWdodD0iYXV0byIgdmlld0JveD0iMCAwIDEzNiAxMzMiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgeG1sbnM6c2VyaWY9Imh0dHA6Ly93d3cuc2VyaWYuY29tLyIgc3R5bGU9ImZpbGwtcnVsZTpldmVub2RkO2NsaXAtcnVsZTpldmVub2RkO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDoyOyI+CjxnIHRyYW5zZm9ybT0ibWF0cml4KDQuMTY2NjcsMCwwLDQuMTY2NjcsLTU2OCwtMTM4MS4wNikiPgogICAgPHBhdGggZD0iTTE1Mi42MDgsMzMxLjQ1NUMxNDMuNjE0LDMzMS40NTUgMTM2LjMyLDMzOC43NDggMTM2LjMyLDM0Ny43NDVDMTM2LjMyLDM1NC45NDIgMTQwLjk4NywzNjEuMDQ3IDE0Ny40NiwzNjMuMjAxQzE0OC4yNzUsMzYzLjM1MSAxNDguNTcyLDM2Mi44NDggMTQ4LjU3MiwzNjIuNDE2QzE0OC41NzIsMzYyLjAyOSAxNDguNTU4LDM2MS4wMDUgMTQ4LjU1LDM1OS42NDZDMTQ0LjAxOSwzNjAuNjMgMTQzLjA2MywzNTcuNDYyIDE0My4wNjMsMzU3LjQ2MkMxNDIuMzIyLDM1NS41OCAxNDEuMjU0LDM1NS4wNzkgMTQxLjI1NCwzNTUuMDc5QzEzOS43NzUsMzU0LjA2OSAxNDEuMzY2LDM1NC4wODkgMTQxLjM2NiwzNTQuMDg5QzE0My4wMDEsMzU0LjIwNCAxNDMuODYxLDM1NS43NjggMTQzLjg2MSwzNTUuNzY4QzE0NS4zMTQsMzU4LjI1NyAxNDcuNjc0LDM1Ny41MzggMTQ4LjYwMiwzNTcuMTIxQzE0OC43NSwzNTYuMDY5IDE0OS4xNzEsMzU1LjM1MSAxNDkuNjM2LDM1NC45NDRDMTQ2LjAxOSwzNTQuNTMzIDE0Mi4yMTYsMzUzLjEzNSAxNDIuMjE2LDM0Ni44OTNDMTQyLjIxNiwzNDUuMTE1IDE0Mi44NTEsMzQzLjY2IDE0My44OTMsMzQyLjUyMkMxNDMuNzI1LDM0Mi4xMSAxNDMuMTY2LDM0MC40NTMgMTQ0LjA1MywzMzguMjExQzE0NC4wNTMsMzM4LjIxMSAxNDUuNDIsMzM3Ljc3MyAxNDguNTMyLDMzOS44ODFDMTQ5LjgzMSwzMzkuNTE5IDE1MS4yMjUsMzM5LjMzOSAxNTIuNjEsMzM5LjMzMkMxNTMuOTk0LDMzOS4zMzkgMTU1LjM4NywzMzkuNTE5IDE1Ni42ODgsMzM5Ljg4MUMxNTkuNzk4LDMzNy43NzMgMTYxLjE2MywzMzguMjExIDE2MS4xNjMsMzM4LjIxMUMxNjIuMDUyLDM0MC40NTMgMTYxLjQ5MywzNDIuMTEgMTYxLjMyNiwzNDIuNTIyQzE2Mi4zNywzNDMuNjYgMTYzLDM0NS4xMTUgMTYzLDM0Ni44OTNDMTYzLDM1My4xNTEgMTU5LjE5MSwzNTQuNTI4IDE1NS41NjMsMzU0LjkzMUMxNTYuMTQ3LDM1NS40MzQgMTU2LjY2OCwzNTYuNDI4IDE1Ni42NjgsMzU3Ljk0N0MxNTYuNjY4LDM2MC4xMjUgMTU2LjY0OCwzNjEuODgyIDE1Ni42NDgsMzYyLjQxNkMxNTYuNjQ4LDM2Mi44NTIgMTU2Ljk0MiwzNjMuMzU5IDE1Ny43NjgsMzYzLjJDMTY0LjIzNiwzNjEuMDQxIDE2OC44OTksMzU0Ljk0IDE2OC44OTksMzQ3Ljc0NUMxNjguODk5LDMzOC43NDggMTYxLjYwNSwzMzEuNDU1IDE1Mi42MDgsMzMxLjQ1NVoiIHN0eWxlPSJmaWxsOndoaXRlOyIvPgo8L2c+Cjwvc3ZnPmA7CmZ1bmN0aW9uIGFjdGlvbkljb24oaWNvbiwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IHRleHQgLCBvbmNsaWNrICB9ID0gb3B0czsKICAgIHJldHVybiBodG1sYDxkaXYgY2xhc3M9ImFjdGlvbi1pY29uIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgb25jbGljayAmJiBvbmNsaWNrKCk7CiAgICB9fT4ke2ljb259JHt0ZXh0IHx8ICcnfTwvZGl2PmA7Cn0KY29uc3QgQ0xFQVJfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTUgMTNoMTR2LTJINXYyem0tMiA0aDE0di0ySDN2MnpNNyA3djJoMTRWN0g3eiIvPjwvc3ZnPmA7CmNvbnN0IEVESVRfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE0LjA2IDkuMDJsLjkyLjkyTDUuOTIgMTlINXYtLjkybDkuMDYtOS4wNk0xNy42NiAzYy0uMjUgMC0uNTEuMS0uNy4yOWwtMS44MyAxLjgzIDMuNzUgMy43NSAxLjgzLTEuODNjLjM5LS4zOS4zOS0xLjAyIDAtMS40MWwtMi4zNC0yLjM0Yy0uMi0uMi0uNDUtLjI5LS43MS0uMjl6bS0zLjYgMy4xOUwzIDE3LjI1VjIxaDMuNzVMMTcuODEgOS45NGwtMy43NS0zLjc1eiIvPjwvc3ZnPmA7CmNvbnN0IEFERF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij4+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE5IDEzaC02djZoLTJ2LTZINXYtMmg2VjVoMnY2aDZ2MnoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19CT1hfVU5DSEVDS0VEX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOSA1djE0SDVWNWgxNG0wLTJINWMtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yeiIvPjwvc3ZnPmA7CmNvbnN0IENIRUNLX0JPWF9DSEVDS0VEX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOSAzSDVjLTEuMSAwLTIgLjktMiAydjE0YzAgMS4xLjkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJWNWMwLTEuMS0uOS0yLTItMnptMCAxNkg1VjVoMTR2MTR6TTE3Ljk5IDlsLTEuNDEtMS40Mi02LjU5IDYuNTktMi41OC0yLjU3LTEuNDIgMS40MSA0IDMuOTl6Ii8+PC9zdmc+YDsKY29uc3QgU0lERUJBUl9IVE1MID0gaHRtbGAKPGRpdiBpZD0ic2lkZWJhciI+CiAgICAke0hFQURFUl9IVE1MfQogICAgPGEgaWQ9InNpZGViYXItYWJvdXQiIGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCIgaHJlZj0iIyI+QWJvdXQ8L2E+CiAgICA8ZGl2IGlkPSJwcm9maWxlcyI+PC9kaXY+CiAgICA8ZGl2IGlkPSJzaWRlYmFyLWFuYWx5dGljcyI+PC9kaXY+CiAgICA8ZGl2IGlkPSJzY3JpcHRzIj48L2Rpdj4KPC9kaXY+CmA7CmNvbnN0IFNJREVCQVJfQ1NTID0gY3NzYAoKI3NpZGViYXIgewogICAgbWFyZ2luLWxlZnQ6IDFyZW07CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgbWluLXdpZHRoOiAxNXJlbTsKfQoKI3NpZGViYXItYWJvdXQgewogICAgZGlzcGxheTogYmxvY2s7CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQgewogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDJyZW07CiAgICBncmlkLWdhcDogMXB4OwogICAgbWFyZ2luLWxlZnQ6IDFweDsKICAgIG1hcmdpbi10b3A6IDFyZW07Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZC1uZXcgewogICAgZ3JpZC1jb2x1bW46IDE7CiAgICBtaW4td2lkdGg6IDhyZW07Cn0KCiNzaWRlYmFyIGJ1dHRvbiB7CiAgICBncmlkLWNvbHVtbjogMTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkIC5oaW50IHsKICAgIGdyaWQtY29sdW1uOiAxOyAKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI3NjcmlwdHMtc2Nyb2xsZXIgewogICAgaGVpZ2h0OiBjYWxjKDEwMHZoIC0gMjhyZW0pOwp9Cgojc2lkZWJhciAuZXh0cmEtdG9wLW1hcmdpbiB7CiAgICBtYXJnaW4tdG9wOiAxcmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0U2lkZWJhcihkb2N1bWVudCwgdm0yLCBkYXRhNCkgewogICAgY29uc3QgdXBkYXRlSGVhZGVyID0gaW5pdEhlYWRlcihkb2N1bWVudCwgdm0yLCBkYXRhNCk7CiAgICBjb25zdCBhYm91dEFuY2hvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaWRlYmFyLWFib3V0Jyk7CiAgICBjb25zdCBwcm9maWxlc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlcycpOwogICAgY29uc3QgYW5hbHl0aWNzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZGViYXItYW5hbHl0aWNzJyk7CiAgICBjb25zdCBzY3JpcHRzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmlwdHMnKTsKICAgIGFib3V0QW5jaG9yLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0yLnNob3dBYm91dCgpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIHVwZGF0ZUhlYWRlcigpOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKFBST0ZJTEVTX0hUTUwodm0yKSwgcHJvZmlsZXNEaXYpOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKEFOQUxZVElDU19IVE1MKHZtMiksIGFuYWx5dGljc0Rpdik7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoU0NSSVBUU19IVE1MKHZtMiksIHNjcmlwdHNEaXYpOwogICAgfTsKfQpjb25zdCBQUk9GSUxFU19IVE1MID0gKHZtMyk9Pmh0bWxgCiAgICA8ZGl2IGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCI+UHJvZmlsZXM8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAke3ZtMy5wcm9maWxlcy5tYXAoKHByb2ZpbGUpPT5odG1sYDxidXR0b24gCiAgICAgICAgICAgIGNsYXNzPSIke3Byb2ZpbGUuaWQgPT09IHZtMy5zZWxlY3RlZFByb2ZpbGVJZCA/ICdzZWxlY3RlZCcgOiAnJ30iIAogICAgICAgICAgICBAY2xpY2s9JHsoKT0+ewogICAgICAgICAgICB2bTMuc2VsZWN0ZWRQcm9maWxlSWQgPSBwcm9maWxlLmlkOwogICAgICAgIH19CiAgICAgICAgICAgID9kaXNhYmxlZD0iJHt2bTMucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7cHJvZmlsZS50ZXh0fTwvYnV0dG9uPgogICAgICAgICR7cHJvZmlsZS5pZCA9PT0gdm0zLnNlbGVjdGVkUHJvZmlsZUlkID8gaHRtbGAke2FjdGlvbkljb24oRURJVF9JQ09OLCB7CiAgICAgICAgICAgIG9uY2xpY2s6ICgpPT52bTMuZWRpdFByb2ZpbGUocHJvZmlsZS5pZCkKICAgICAgICB9KX1gIDogJyd9YAogICAgKX0KICAgICAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZC1uZXciPiR7YWN0aW9uSWNvbihBRERfSUNPTiwgewogICAgICAgIHRleHQ6ICdOZXcnLAogICAgICAgIG9uY2xpY2s6ICgpPT52bTMubmV3UHJvZmlsZSgpCiAgICB9KX08L2Rpdj4KICAgIDwvZGl2PgpgCjsKY29uc3QgQU5BTFlUSUNTX0hUTUwgPSAodm00KT0+aHRtbGAKICAgIDxkaXYgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGV4dHJhLXRvcC1tYXJnaW4iPkFuYWx5dGljczwvZGl2PgogICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQiPgogICAgICAgICR7dm00LmFuYWx5dGljcy5tYXAoKGFuYWx5dGljKT0+aHRtbGA8YnV0dG9uCiAgICAgICAgICAgICAgICBjbGFzcz0iJHt2bTQuc2VsZWN0ZWRBbmFseXRpY0lkID09PSBhbmFseXRpYy5pZCA/ICdzZWxlY3RlZCcgOiAnJ30iIAogICAgICAgICAgICAgICAgQGNsaWNrPSR7KCk9PnZtNC5zaG93QW5hbHl0aWMoYW5hbHl0aWMuaWQpCiAgICAgICAgfSAKICAgICAgICAgICAgICAgID9kaXNhYmxlZD0iJHt2bTQucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7YW5hbHl0aWMudGV4dH08L2J1dHRvbj4KICAgICAgICBgCiAgICApfQogICAgPC9kaXY+CmAKOwpjb25zdCBTQ1JJUFRTX0hUTUwgPSAodm01KT0+aHRtbGAKICAgIDxkaXYgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGV4dHJhLXRvcC1tYXJnaW4iPlNjcmlwdHM8L2Rpdj4KICAgIDxkaXYgaWQ9InNjcmlwdHMtc2Nyb2xsZXIiIGNsYXNzPSJoaWRkZW4tdmVydGljYWwtc2Nyb2xsIj4KICAgICAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgICAgICR7dm01LnNjcmlwdHMubWFwKChzY3JpcHQpPT5odG1sYDxidXR0b24KICAgICAgICAgICAgICAgICAgICBjbGFzcz0iJHt2bTUuc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdC5pZCkgPyAnc2VsZWN0ZWQnIDogJyd9IiAKICAgICAgICAgICAgICAgICAgICBAY2xpY2s9JHsoZSk9PmhhbmRsZVNjcmlwdENsaWNrKGUsIHNjcmlwdC5pZCwgdm01KQogICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgP2Rpc2FibGVkPSIke3ZtNS5wcm9maWxlRm9ybS5zaG93aW5nfSI+JHtzY3JpcHQudGV4dH08L2J1dHRvbj4KICAgICAgICAgICAgYAogICAgKX0KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImNhcHRpb24gbWVkaXVtLWVtcGhhc2lzLXRleHQgaGludCI+JHtjb21wdXRlTXVsdGlzZWxlY3RLZXlDaGFyKCl9LWNsaWNrIHRvIG11bHRpc2VsZWN0PC9kaXY+CiAgICA8L2Rpdj4KYAo7CmZ1bmN0aW9uIGNvbXB1dGVNdWx0aXNlbGVjdEtleUNoYXIoKSB7CiAgICByZXR1cm4gaXNNYWNpbnRvc2goKSA/ICfijJgnIDogJ2N0cmwnOwp9CmZ1bmN0aW9uIGlzTWFjaW50b3NoKCkgewogICAgcmV0dXJuIG5hdmlnYXRvci5wbGF0Zm9ybS5pbmRleE9mKCdNYWMnKSA+IC0xOwp9CmZ1bmN0aW9uIGhhbmRsZVNjcmlwdENsaWNrKGUsIHNjcmlwdElkLCB2bTYpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IG5ld1NjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgIHNjcmlwdElkCiAgICBdKTsKICAgIGNvbnN0IG11bHRpID0gaXNNYWNpbnRvc2goKSA/IGUubWV0YUtleSA6IGUuY3RybEtleTsKICAgIHZtNi5zZWxlY3RlZFNjcmlwdElkcyA9IG11bHRpID8gdm02LnNlbGVjdGVkU2NyaXB0SWRzLmhhcyhzY3JpcHRJZCkgPyBzZXRTdWJ0cmFjdCh2bTYuc2VsZWN0ZWRTY3JpcHRJZHMsIG5ld1NjcmlwdElkcykgOiBzZXRVbmlvbih2bTYuc2VsZWN0ZWRTY3JpcHRJZHMsIG5ld1NjcmlwdElkcykgOiBuZXdTY3JpcHRJZHM7Cn0KY2xhc3MgQXBwQ29uc3RhbnRzIHsKICAgIHN0YXRpYyBXRUJTT0NLRVRfUElOR19JTlRFUlZBTF9TRUNPTkRTID0gMTA7CiAgICBzdGF0aWMgSU5BQ1RJVkVfVEFJTF9TRUNPTkRTID0gNTsKfQpjbGFzcyBUYWlsQ29udHJvbGxlciB7CiAgICBjYWxsYmFja3M7CiAgICByZWNvcmRzID0gbmV3IE1hcCgpOwogICAgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kczsKICAgIGluYWN0aXZlVGFpbFNlY29uZHM7CiAgICB0YWlsT3B0aW9ucyA9IHsKICAgICAgICBmaWx0ZXJzOiBbXQogICAgfTsKICAgIG9ubGluZTsKICAgIGNvbnN0cnVjdG9yKGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy53ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzID0gb3B0cy53ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzOwogICAgICAgIHRoaXMuaW5hY3RpdmVUYWlsU2Vjb25kcyA9IG9wdHMuaW5hY3RpdmVUYWlsU2Vjb25kczsKICAgICAgICBjb25zdCBuYXZpZ2F0b3JBc0FueSA9IHdpbmRvdy5uYXZpZ2F0b3I7CiAgICAgICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3JBc0FueS5vbkxpbmUgPT09ICdib29sZWFuJykgewogICAgICAgICAgICB0aGlzLnNldE9ubGluZShuYXZpZ2F0b3JBc0FueS5vbkxpbmUpOwogICAgICAgIH0KICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb25saW5lJywgKCk9PnRoaXMuc2V0T25saW5lKHRydWUpCiAgICAgICAgKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb2ZmbGluZScsICgpPT50aGlzLnNldE9ubGluZShmYWxzZSkKICAgICAgICApOwogICAgfQogICAgc2V0VGFpbE9wdGlvbnModGFpbE9wdGlvbnMpIHsKICAgICAgICBjb25zb2xlLmxvZyhgVGFpbENvbnRyb2xsZXIuc2V0VGFpbE9wdGlvbnMgJHtKU09OLnN0cmluZ2lmeSh0YWlsT3B0aW9ucyl9YCk7CiAgICAgICAgdGhpcy50YWlsT3B0aW9ucyA9IHRhaWxPcHRpb25zOwogICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIHRoaXMucmVjb3Jkcy52YWx1ZXMoKSl7CiAgICAgICAgICAgIGlmIChyZWNvcmQuY29ubmVjdGlvbikgewogICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24uc2V0T3B0aW9ucyh0YWlsT3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBzZXRUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuLCBzY3JpcHRJZHMpIHsKICAgICAgICBjb25zdCBzdG9wS2V5cyA9IHNldFN1YnRyYWN0KHRoaXMuY29tcHV0ZVN0YXJ0aW5nT3JTdGFydGVkVGFpbEtleXMoKSwgbmV3IFNldChbCiAgICAgICAgICAgIC4uLnNjcmlwdElkcwogICAgICAgIF0ubWFwKCh2KT0+cGFja1RhaWxLZXkoYWNjb3VudElkLCB2KQogICAgICAgICkpKTsKICAgICAgICBmb3IgKGNvbnN0IHN0b3BLZXkgb2Ygc3RvcEtleXMpewogICAgICAgICAgICBjb25zdCByZWNvcmQgPSB0aGlzLnJlY29yZHMuZ2V0KHN0b3BLZXkpOwogICAgICAgICAgICByZWNvcmQuc3RhdGUgPSAnaW5hY3RpdmUnOwogICAgICAgICAgICByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnaW5hY3RpdmUnICYmIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZSAmJiBEYXRlLm5vdygpIC0gcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lID49IHRoaXMuaW5hY3RpdmVUYWlsU2Vjb25kcykgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdzdG9wcGluZyc7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN0b3BwaW5nICR7cmVjb3JkLnNjcmlwdElkfSwgaW5hY3RpdmUgZm9yICR7RGF0ZS5ub3coKSAtIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZX1tc2ApOwogICAgICAgICAgICAgICAgICAgIHJlY29yZC5jb25uZWN0aW9uPy5jbG9zZSgxMDAwLCAnbm8gbG9uZ2VyIGludGVyZXN0ZWQnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY29yZHMuZGVsZXRlKHJlY29yZC50YWlsS2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcy5pbmFjdGl2ZVRhaWxTZWNvbmRzICogMTAwMCk7CiAgICAgICAgfQogICAgICAgIGlmIChzdG9wS2V5cy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLmRpc3BhdGNoVGFpbHNDaGFuZ2VkKCk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3Qgc2NyaXB0SWQgb2Ygc2NyaXB0SWRzKXsKICAgICAgICAgICAgY29uc3QgdGFpbEtleSA9IHBhY2tUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQodGFpbEtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ1JlY29yZCkgewogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkLnN0YXRlID09PSAnaW5hY3RpdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFJldml2aW5nIGluYWN0aXZlICR7c2NyaXB0SWR9YCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZC5zdGF0ZSA9ICdzdGFydGVkJzsKICAgICAgICAgICAgICAgIGV4aXN0aW5nUmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkID0gewogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnc3RhcnRpbmcnLAogICAgICAgICAgICAgICAgICAgIHRhaWxLZXksCiAgICAgICAgICAgICAgICAgICAgYXBpVG9rZW4sCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHJldHJ5Q291bnRBZnRlckNsb3NlOiAwCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRzLnNldCh0YWlsS2V5LCByZWNvcmQpOwogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCk7CiAgICAgICAgICAgICAgICByZWNvcmQuc3RhdGUgPSAnc3RhcnRlZCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFRhaWxzQ2hhbmdlZCgpOwogICAgICAgIH0KICAgIH0KICAgIGRpc3BhdGNoVGFpbHNDaGFuZ2VkKCkgewogICAgICAgIGNvbnN0IHRhaWxLZXlzID0gbmV3IFNldChbCiAgICAgICAgICAgIC4uLnRoaXMucmVjb3Jkcy52YWx1ZXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+di5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnCiAgICAgICAgKS5tYXAoKHYpPT52LnRhaWxLZXkKICAgICAgICApKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxzQ2hhbmdlZCh0YWlsS2V5cyk7CiAgICB9CiAgICBjb21wdXRlU3RhcnRpbmdPclN0YXJ0ZWRUYWlsS2V5cygpIHsKICAgICAgICByZXR1cm4gbmV3IFNldChbCiAgICAgICAgICAgIC4uLnRoaXMucmVjb3Jkcy52YWx1ZXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+di5zdGF0ZSA9PT0gJ3N0YXJ0aW5nJyB8fCB2LnN0YXRlID09PSAnc3RhcnRlZCcKICAgICAgICApLm1hcCgodik9PnYudGFpbEtleQogICAgICAgICkpOwogICAgfQogICAgc2V0T25saW5lKG9ubGluZSkgewogICAgICAgIGlmIChvbmxpbmUgPT09IHRoaXMub25saW5lKSByZXR1cm47CiAgICAgICAgY29uc3Qgb2xkT25saW5lID0gdGhpcy5vbmxpbmU7CiAgICAgICAgdGhpcy5vbmxpbmUgPSBvbmxpbmU7CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25OZXR3b3JrU3RhdHVzQ2hhbmdlZChvbmxpbmUpOwogICAgICAgIGlmICh0eXBlb2Ygb2xkT25saW5lID09PSAnYm9vbGVhbicpIHsKICAgICAgICAgICAgaWYgKG9ubGluZSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5yZWNvcmRzLnZhbHVlcygpKXsKICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnc3RhcnRlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBzY3JpcHRJZCAgfSA9IHJlY29yZDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCkuY2F0Y2goKGUpPT50aGlzLmNhbGxiYWNrcy5vblRhaWxGYWlsZWRUb1N0YXJ0KGFjY291bnRJZCwgc2NyaXB0SWQsICdyZXN0YXJ0LWFmdGVyLWNvbWluZy1vbmxpbmUnLCBlKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIHRoaXMucmVjb3Jkcy52YWx1ZXMoKSl7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24/LmNsb3NlKDEwMDAsICdvZmZsaW5lJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBzdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCkgewogICAgICAgIGNvbnN0IGFsbG93ZWRUb1N0YXJ0ID0gcmVjb3JkLnN0YXRlID09PSAnc3RhcnRpbmcnIHx8IHJlY29yZC5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnOwogICAgICAgIGlmICghYWxsb3dlZFRvU3RhcnQpIHJldHVybjsKICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIHNjcmlwdElkICB9ID0gdW5wYWNrVGFpbEtleShyZWNvcmQudGFpbEtleSk7CiAgICAgICAgY29uc3QgeyBhcGlUb2tlbiAgfSA9IHJlY29yZDsKICAgICAgICBpZiAoIXJlY29yZC50YWlsIHx8IERhdGUubm93KCkgPiBuZXcgRGF0ZShyZWNvcmQudGFpbC5leHBpcmVzX2F0KS5nZXRUaW1lKCkgLSAxMDAwICogNjAgKiA1KSB7CiAgICAgICAgICAgIGNvbnN0IHRhaWxDcmVhdGluZ1RpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKTsKICAgICAgICAgICAgY29uc3QgdGFpbCA9IGF3YWl0IGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHRJZCwgYXBpVG9rZW4pOwogICAgICAgICAgICByZWNvcmQudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSAtIHRhaWxDcmVhdGluZ1RpbWUsIHRhaWwpOwogICAgICAgIH0KICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnaW5hY3RpdmUnKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBjYWxsYmFja3MgLCB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzICB9ID0gdGhpczsKICAgICAgICBjb25zdCBkaXMgPSB0aGlzOwogICAgICAgIGNvbnN0IG9wZW5pbmdUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICBjb25zdCB0YWlsQ29ubmVjdGlvbkNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgb25PcGVuIChfY24sIHRpbWVTdGFtcCkgewogICAgICAgICAgICAgICAgcmVjb3JkLnJldHJ5Q291bnRBZnRlckNsb3NlID0gMDsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIERhdGUubm93KCkgLSBvcGVuaW5nVGltZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uQ2xvc2UgKF9jbiwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkNsb3NlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbik7CiAgICAgICAgICAgICAgICByZWNvcmQuY2xvc2VUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdzdGFydGVkJyAmJiBkaXMub25saW5lICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5yZXRyeUNvdW50QWZ0ZXJDbG9zZSsrOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlbGF5U2Vjb25kcyA9IE1hdGgubWluKHJlY29yZC5yZXRyeUNvdW50QWZ0ZXJDbG9zZSAqIDUsIDYwKTsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgV2lsbCBhdHRlbXB0IHRvIHJlc3RhcnQgJHtzY3JpcHRJZH0gaW4gJHtkZWxheVNlY29uZHN9IHNlY29uZHNgKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlID09PSAnc3RhcnRlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGRpcy5zdGFydFRhaWxDb25uZWN0aW9uKHJlY29yZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBkZWxheVNlY29uZHMgKiAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25FcnJvciAoX2NuLCB0aW1lU3RhbXAsIGVycm9ySW5mbykgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25FcnJvcihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbE1lc3NhZ2UgKF9jbiwgdGltZVN0YW1wLCBtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlICE9PSAnc3RhcnRlZCcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblVucGFyc2VkTWVzc2FnZSAoX2NuLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblVucGFyc2VkTWVzc2FnZScsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcik7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZWNvcmQuY29ubmVjdGlvbiA9IG5ldyBUYWlsQ29ubmVjdGlvbihyZWNvcmQudGFpbC51cmwsIHRhaWxDb25uZWN0aW9uQ2FsbGJhY2tzLCB7CiAgICAgICAgICAgIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMKICAgICAgICB9KS5zZXRPcHRpb25zKHRoaXMudGFpbE9wdGlvbnMpOwogICAgfQp9CmZ1bmN0aW9uIHVucGFja1RhaWxLZXkodGFpbEtleSkgewogICAgY29uc3QgbSA9IC9eKFteXHMtXSspLShbXlxzXSspJC8uZXhlYyh0YWlsS2V5KTsKICAgIGlmICghbSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbEtleTogJHt0YWlsS2V5fWApOwogICAgcmV0dXJuIHsKICAgICAgICBhY2NvdW50SWQ6IG1bMV0sCiAgICAgICAgc2NyaXB0SWQ6IG1bMl0KICAgIH07Cn0KZnVuY3Rpb24gcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgcmV0dXJuIGAke2FjY291bnRJZH0tJHtzY3JpcHRJZH1gOwp9CmNsYXNzIFN3aXRjaGFibGVUYWlsQ29udHJvbGxlckNhbGxiYWNrcyB7CiAgICBjYWxsYmFja3M7CiAgICBlbmFibGVkRm47CiAgICBjb25zdHJ1Y3RvcihjYWxsYmFja3MsIGVuYWJsZWRGbil7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5lbmFibGVkRm4gPSBlbmFibGVkRm47CiAgICB9CiAgICBvblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRpbmcoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICB9CiAgICBvblRhaWxDcmVhdGVkKGFjY291bnRJZCwgc2NyaXB0SWQsIHRvb2tNaWxsaXMsIHRhaWwpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGVkKGFjY291bnRJZCwgc2NyaXB0SWQsIHRvb2tNaWxsaXMsIHRhaWwpOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCB0b29rTWlsbGlzKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCB0b29rTWlsbGlzKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25DbG9zZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uQ2xvc2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25FcnJvcihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbykgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25FcnJvcihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcik7CiAgICB9CiAgICBvblRhaWxzQ2hhbmdlZCh0YWlscykgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbHNDaGFuZ2VkKHRhaWxzKTsKICAgIH0KICAgIG9uTmV0d29ya1N0YXR1c0NoYW5nZWQob25saW5lKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25OZXR3b3JrU3RhdHVzQ2hhbmdlZChvbmxpbmUpOwogICAgfQogICAgb25UYWlsRmFpbGVkVG9TdGFydChhY2NvdW50SWQsIHNjcmlwdElkLCB0cmlnZ2VyLCBlcnJvcikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbEZhaWxlZFRvU3RhcnQoYWNjb3VudElkLCBzY3JpcHRJZCwgdHJpZ2dlciwgZXJyb3IpOwogICAgfQp9CmNsYXNzIERlbW9Nb2RlIHsKICAgIHN0YXRpYyBwcm9maWxlcyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAncHJvZmlsZTEnLAogICAgICAgICAgICB0ZXh0OiAnY29ycC1wcm9maWxlJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3Byb2ZpbGUyJywKICAgICAgICAgICAgdGV4dDogJ3BlcnMtcHJvZmlsZScKICAgICAgICB9LCAKICAgIF07CiAgICBzdGF0aWMgc2VsZWN0ZWRQcm9maWxlSWQgPSAncHJvZmlsZTEnOwogICAgc3RhdGljIHNldFNlbGVjdGVkUHJvZmlsZUlkKF92YWx1ZSkge30KICAgIHN0YXRpYyBzY3JpcHRzID0gWwogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQxJywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjEtZGV2JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDInLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMS1wcm9kJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDMnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMi1kZXYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0NCcsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIyLWJldGEnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0NScsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIyLXByb2QnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0NicsCiAgICAgICAgICAgIHRleHQ6ICdkdXJhYmxlLW9iamVjdC1kZW1vJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDcnLAogICAgICAgICAgICB0ZXh0OiAnc2VjcmV0LWFwcCcKICAgICAgICB9LCAKICAgIF07CiAgICBzdGF0aWMgc2VsZWN0ZWRTY3JpcHRJZHMgPSBuZXcgU2V0KFsKICAgICAgICAnc2NyaXB0NycsCiAgICAgICAgJ3NjcmlwdDQnCiAgICBdKTsKICAgIHN0YXRpYyBzZXRTZWxlY3RlZFNjcmlwdElkcyhfc2NyaXB0SWRzKSB7fQogICAgc3RhdGljIHRhaWxzID0gbmV3IFNldCgpOwogICAgc3RhdGljIGxvZ0Zha2VPdXRwdXQoY2FsbGJhY2tzKSB7CiAgICAgICAgY29uc3QgYWNjb3VudElkID0gJzE1YTdmYTNhMzcyNTRmZTRhN2NhZGQxYmIyNzYyODc5JzsKICAgICAgICBjb25zdCBzY3JpcHRJZCA9ICdzZWNyZXQtYXBwJzsKICAgICAgICBjYWxsYmFja3Mub25UYWlsQ3JlYXRpbmcoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgY29uc3QgdGFpbCA9IHsKICAgICAgICAgICAgaWQ6ICdkYjE5ZWI4YmU5ZjQ0NDNhYWI5MWE5MDQyYzBkMzUxNycsCiAgICAgICAgICAgIHVybDogJ3dzczovL3RhaWwuZGV2ZWxvcGVycy53b3JrZXJzLmRldi9kYjE5ZWI4YmU5ZjQ0NDNhYWI5MWE5MDQyYzBkMzUxNycsCiAgICAgICAgICAgICdleHBpcmVzX2F0JzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICAgICAgfTsKICAgICAgICBjYWxsYmFja3Mub25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCAxNTUsIHRhaWwpOwogICAgICAgIGNhbGxiYWNrcy5vblRhaWxzQ2hhbmdlZChuZXcgU2V0KFsKICAgICAgICAgICAgcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCkKICAgICAgICBdKSk7CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25PcGVuKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIDQyKTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgMjsgaSsrKXsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlUmVxdWVzdCgpKTsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlRG9SZXF1ZXN0KCkpOwogICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgY29tcHV0ZUZha2VSZXF1ZXN0V2l0aExvZ3MoKSk7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZVJlcXVlc3RFeGNlZWRpbmdUaW1lTGltaXQoKSk7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IFVTRVJfQUdFTlQgPSAnTW96aWxsYS81LjAgKE1hY2ludG9zaDsgSW50ZWwgTWFjIE9TIFggMTAuMTU7IHJ2OjkxLjApIEdlY2tvLzIwMTAwMTAxIEZpcmVmb3gvOTEuMCc7CmZ1bmN0aW9uIGNvbXB1dGVGYWtlUmVxdWVzdCgpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20vZW5kcG9pbnQnLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnY2YtY29ubmVjdGluZy1pcCc6ICcyMDMuMC4xMTMuMTInLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVVNFUl9BR0VOVAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNmOiB7CiAgICAgICAgICAgICAgICAgICAgY29sbzogJ0RGVycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogW10sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZURvUmVxdWVzdCgpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZmFrZS1ob3N0L3B1dCcsCiAgICAgICAgICAgICAgICBtZXRob2Q6ICdQVVQnLAogICAgICAgICAgICAgICAgaGVhZGVyczoge30KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ2xvZ3Byb3BzOicsCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvOiAnRVdSJywKICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZU9iamVjdENsYXNzOiAnTG9nZ2VyRE8nLAogICAgICAgICAgICAgICAgICAgICAgICBkdXJhYmxlT2JqZWN0SWQ6ICc1MzhmYzdjZTU1YjE0ZTUzYjZiODU1MmJlZmViOWFmNCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGVPYmplY3ROYW1lOiAnbG9nMScKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3RXaXRoTG9ncygpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vbXktd29ya2VyLnN1YmRvbWFpbi53b3JrZXJzLmRldi90ZXN0P2xvZz10cnVlJywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ2NmLWNvbm5lY3RpbmctaXAnOiAnMjAzLjAuMTEzLjEyJywKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFVTRVJfQUdFTlQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjZjogewogICAgICAgICAgICAgICAgICAgIGNvbG86ICdERlcnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdsb2cnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2Vycm9yJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdpbmZvJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICd3YXJuaW5nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdkZWJ1ZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3RFeGNlZWRpbmdUaW1lTGltaXQoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL215LXdvcmtlci5zdWJkb21haW4ud29ya2Vycy5kZXYvY29tcHV0ZS1kaWdpdHMtb2YtcGknLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnY2YtY29ubmVjdGluZy1pcCc6ICcyMDMuMC4xMTMuMTInLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVVNFUl9BR0VOVAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNmOiB7CiAgICAgICAgICAgICAgICAgICAgY29sbzogJ0RGVycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ2J1cm5pbmcgY3B1JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV4Y2VwdGlvbnM6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmFtZTogJ0Vycm9yJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdXb3JrZXIgZXhjZWVkZWQgQ1BVIHRpbWUgbGltaXQuJwogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdleGNlZWRlZENwdScKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KY2xhc3MgUXBzQ29udHJvbGxlciB7CiAgICBzb3J0ZWRFdmVudFRpbWVzID0gW107CiAgICBjYWxsYmFja3M7CiAgICBuOwogICAgX3FwcyA9IDA7CiAgICBnZXQgcXBzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9xcHM7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihuLCBjYWxsYmFja3MpewogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMubiA9IG47CiAgICB9CiAgICBhZGRFdmVudChldmVudFRpbWUpIHsKICAgICAgICBjb25zdCBxcHMgPSBjb21wdXRlUXBzKHRoaXMubiwgdGhpcy5zb3J0ZWRFdmVudFRpbWVzLCBldmVudFRpbWUpOwogICAgICAgIGlmIChxcHMgPT09IHRoaXMuX3FwcykgcmV0dXJuOwogICAgICAgIHRoaXMuX3FwcyA9IHFwczsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblFwc0NoYW5nZWQocXBzKTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlUXBzKG4sIHNvcnRlZEV2ZW50VGltZXMsIGV2ZW50VGltZSkgewogICAgYWRkKGV2ZW50VGltZSwgc29ydGVkRXZlbnRUaW1lcyk7CiAgICB3aGlsZShzb3J0ZWRFdmVudFRpbWVzLmxlbmd0aCA+IG4pewogICAgICAgIHNvcnRlZEV2ZW50VGltZXMuc2hpZnQoKTsKICAgIH0KICAgIGNvbnN0IG51bSA9IHNvcnRlZEV2ZW50VGltZXMubGVuZ3RoOwogICAgaWYgKG51bSA8IDIpIHJldHVybiAwOwogICAgY29uc3QgdGltZURpZmZTZWNvbmRzID0gKHNvcnRlZEV2ZW50VGltZXNbc29ydGVkRXZlbnRUaW1lcy5sZW5ndGggLSAxXSAtIHNvcnRlZEV2ZW50VGltZXNbMF0pIC8gMTAwMDsKICAgIHJldHVybiAobnVtIC0gMSkgLyB0aW1lRGlmZlNlY29uZHM7Cn0KZnVuY3Rpb24gYWRkKGVsLCBhcnIpIHsKICAgIGFyci5zcGxpY2UoZmluZExvYyhlbCwgYXJyKSArIDEsIDAsIGVsKTsKICAgIHJldHVybiBhcnI7Cn0KZnVuY3Rpb24gZmluZExvYyhlbCwgYXJyLCBzdCwgZW4pIHsKICAgIHN0ID0gc3QgfHwgMDsKICAgIGVuID0gZW4gfHwgYXJyLmxlbmd0aDsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspewogICAgICAgIGlmIChhcnJbaV0gPiBlbCkgewogICAgICAgICAgICByZXR1cm4gaSAtIDE7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGVuOwp9CmZ1bmN0aW9uIGNoZWNrRXF1YWwobmFtZSwgdmFsdWUsIGV4cGVjdGVkKSB7CiAgICBpZiAodmFsdWUgIT09IGV4cGVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBleHBlY3RlZCAke2V4cGVjdGVkfSwgZm91bmQgJHt2YWx1ZX1gKTsKfQpmdW5jdGlvbiBjaGVja01hdGNoZXMobmFtZSwgdmFsdWUsIHBhdHRlcm4pIHsKICAgIGlmICghcGF0dGVybi50ZXN0KHZhbHVlKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX1gKTsKICAgIHJldHVybiB2YWx1ZTsKfQpjbGFzcyBHcmFwaHFsUXVlcnkgewogICAgX3BhcmVudDsKICAgIF9ub2RlczsKICAgIF9ub2RlT3JkZXI7CiAgICBfYXJnczsKICAgIF9hcmdPcmRlcjsKICAgIGNvbnN0cnVjdG9yKHBhcmVudCwgbm9kZXMsIG5vZGVPcmRlciwgYXJncywgYXJnT3JkZXIpewogICAgICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudDsKICAgICAgICB0aGlzLl9ub2RlcyA9IG5vZGVzOwogICAgICAgIHRoaXMuX25vZGVPcmRlciA9IG5vZGVPcmRlcjsKICAgICAgICB0aGlzLl9hcmdzID0gYXJnczsKICAgICAgICB0aGlzLl9hcmdPcmRlciA9IGFyZ09yZGVyOwogICAgfQogICAgc3RhdGljIGNyZWF0ZSgpIHsKICAgICAgICByZXR1cm4gbmV3IEdyYXBocWxRdWVyeShbXSwgbmV3IE1hcCgpLCBbXSwgbmV3IE1hcCgpLCBbXSk7CiAgICB9CiAgICBzY2FsYXIobmFtZSkgewogICAgICAgIHRoaXMuYWRkKG5hbWUsIE5vZGVLaW5kLlNjYWxhcik7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBvYmplY3QobmFtZSkgewogICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFkZChuYW1lLCBOb2RlS2luZC5PYmplY3QpOwogICAgICAgIGNvbnN0IHJ0ID0gbmV3IEdyYXBocWxRdWVyeShbCiAgICAgICAgICAgIHRoaXMKICAgICAgICBdLCBuZXcgTWFwKCksIFtdLCBuZXcgTWFwKCksIFtdKTsKICAgICAgICBub2RlLnF1ZXJ5LnB1c2gocnQpOwogICAgICAgIHJldHVybiBydDsKICAgIH0KICAgIG9iamVjdFF1ZXJ5KG5hbWUsIHF1ZXJ5MikgewogICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFkZChuYW1lLCBOb2RlS2luZC5PYmplY3QpOwogICAgICAgIGNvbnN0IHEgPSBxdWVyeTIuY29weVdpdGhQYXJlbnQodGhpcyk7CiAgICAgICAgY29uc3QgcnQgPSBxOwogICAgICAgIG5vZGUucXVlcnkucHVzaChydCk7CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQogICAgYXJnUmF3KG5hbWUsIHJhd1ZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkQXJnKG5hbWUsIHJhd1ZhbHVlKTsKICAgIH0KICAgIGFyZ0Jvb2xlYW4obmFtZSwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgdmFsdWUgPyAndHJ1ZScgOiAnZmFsc2UnKTsKICAgIH0KICAgIGFyZ0xvbmcobmFtZSwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgYCR7dmFsdWV9YCk7CiAgICB9CiAgICBhcmdTdHJpbmcobmFtZSwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgYCIke3ZhbHVlLnJlcGxhY2VBbGwoJyInLCAnXFwiJyl9ImApOwogICAgfQogICAgYXJnT2JqZWN0KG5hbWUsIGZpZWxkTmFtZSwgZmllbGRWYWx1ZSkgewogICAgICAgIHJldHVybiB0aGlzLmFkZEFyZyhuYW1lLCBgeyR7ZmllbGROYW1lfToiJHtmaWVsZFZhbHVlLnJlcGxhY2VBbGwoJyInLCAnXFwiJyl9In1gKTsKICAgIH0KICAgIGFyZ1ZhcmlhYmxlKG5hbWUsIHZhcmlhYmxlTmFtZSkgewogICAgICAgIGNoZWNrTWF0Y2hlcygndmFyaWFibGVOYW1lJywgdmFyaWFibGVOYW1lLCAvXlthLXpdKyQvKTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgYCQke3ZhcmlhYmxlTmFtZX1gKTsKICAgIH0KICAgIGVuZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcGFyZW50Lmxlbmd0aCA+IDAgPyB0aGlzLl9wYXJlbnRbMF0gOiB0aGlzOwogICAgfQogICAgdG9wKCkgewogICAgICAgIGxldCBydCA9IHRoaXM7CiAgICAgICAgd2hpbGUocnQuX3BhcmVudC5sZW5ndGggPiAwKXsKICAgICAgICAgICAgcnQgPSBydC5fcGFyZW50WzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICB0b1N0cmluZygpIHsKICAgICAgICBjb25zdCBsaW5lcyA9IFtdOwogICAgICAgIGxpbmVzLnB1c2goJ3snKTsKICAgICAgICB0aGlzLndyaXRlKGxpbmVzLCAxKTsKICAgICAgICBsaW5lcy5wdXNoKCd9Jyk7CiAgICAgICAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xuJyk7CiAgICB9CiAgICBhZGRBcmcobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fYXJncy5oYXMobmFtZSkpIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIGFyZzogJHtuYW1lfWApOwogICAgICAgIHRoaXMuX2FyZ09yZGVyLnB1c2gobmFtZSk7CiAgICAgICAgdGhpcy5fYXJncy5zZXQobmFtZSwgdmFsdWUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgd3JpdGUobGluZXMsIGxldmVsKSB7CiAgICAgICAgY29uc3QgaW5kZW50ID0gJyAgJy5yZXBlYXQobGV2ZWwpOwogICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMuX25vZGVPcmRlcil7CiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBjaGVja0dldCgnX25vZGVzJywgdGhpcy5fbm9kZXMsIGtleSk7CiAgICAgICAgICAgIGlmIChub2RlLmtpbmQgPT09IE5vZGVLaW5kLlNjYWxhcikgewogICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtpbmRlbnR9JHtrZXl9YCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5raW5kID09PSBOb2RlS2luZC5PYmplY3QpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBub2RlLnF1ZXJ5WzBdOwogICAgICAgICAgICAgICAgbGV0IGxpbmUgPSBgJHtpbmRlbnR9JHtrZXl9YDsKICAgICAgICAgICAgICAgIGlmIChxLl9hcmdPcmRlci5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgbGluZSArPSAnKCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IGogPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgYXJnTmFtZSBvZiBxLl9hcmdPcmRlcil7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID4gMCkgbGluZSArPSAnLCAnOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5lICs9IGAke2FyZ05hbWV9OiAke2NoZWNrR2V0KCdxLl9hcmdzJywgcS5fYXJncywgYXJnTmFtZSl9YDsKICAgICAgICAgICAgICAgICAgICAgICAgaisrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsaW5lICs9ICcpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpbmUgKz0gJyB7JzsKICAgICAgICAgICAgICAgIGxpbmVzLnB1c2gobGluZSk7CiAgICAgICAgICAgICAgICBub2RlLnF1ZXJ5WzBdLndyaXRlKGxpbmVzLCBsZXZlbCArIDEpOwogICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtpbmRlbnR9fWApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbXBsZW1lbnQgbm9kZSBraW5kICR7bm9kZS5raW5kfWApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYWRkKG5hbWUsIGtpbmQpIHsKICAgICAgICBpZiAodGhpcy5fbm9kZXMuaGFzKG5hbWUpKSB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBmaWVsZDogJHtuYW1lfWApOwogICAgICAgIGNvbnN0IHJ0ID0gbmV3IE5vZGUxKGtpbmQpOwogICAgICAgIHRoaXMuX25vZGVzLnNldChuYW1lLCBydCk7CiAgICAgICAgdGhpcy5fbm9kZU9yZGVyLnB1c2gobmFtZSk7CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQogICAgY29weVdpdGhQYXJlbnQocGFyZW50KSB7CiAgICAgICAgY29uc3Qgbm9kZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgY29uc3Qgbm9kZU9yZGVyID0gWwogICAgICAgICAgICAuLi50aGlzLl9ub2RlT3JkZXIKICAgICAgICBdOwogICAgICAgIGNvbnN0IGFyZ3MgPSBuZXcgTWFwKCk7CiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5fYXJncy5lbnRyaWVzKCkpewogICAgICAgICAgICBhcmdzLnNldChrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXJnT3JkZXIgPSBbCiAgICAgICAgICAgIC4uLnRoaXMuX2FyZ09yZGVyCiAgICAgICAgXTsKICAgICAgICBjb25zdCBydCA9IG5ldyBHcmFwaHFsUXVlcnkoWwogICAgICAgICAgICBwYXJlbnQKICAgICAgICBdLCBub2Rlcywgbm9kZU9yZGVyLCBhcmdzLCBhcmdPcmRlcik7CiAgICAgICAgZm9yIChjb25zdCBba2V5MSwgbm9kZV0gb2YgdGhpcy5fbm9kZXMuZW50cmllcygpKXsKICAgICAgICAgICAgY29uc3QgbmV3Tm9kZSA9IG5ldyBOb2RlMShub2RlLmtpbmQpOwogICAgICAgICAgICBpZiAobm9kZS5xdWVyeS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdRdWVyeSA9IG5vZGUucXVlcnlbMF0uY29weVdpdGhQYXJlbnQocnQpOwogICAgICAgICAgICAgICAgbmV3Tm9kZS5xdWVyeS5wdXNoKG5ld1F1ZXJ5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2Rlcy5zZXQoa2V5MSwgbmV3Tm9kZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBydDsKICAgIH0KfQpmdW5jdGlvbiBjaGVja0dldChtYXBOYW1lLCBtYXAsIGtleSkgewogICAgY29uc3QgcnQgPSBtYXAuZ2V0KGtleSk7CiAgICBpZiAoIXJ0KSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke21hcE5hbWV9LmtleTogJHtrZXl9YCk7CiAgICByZXR1cm4gcnQ7Cn0KdmFyIE5vZGVLaW5kOwooZnVuY3Rpb24oTm9kZUtpbmQxKSB7CiAgICBOb2RlS2luZDFbTm9kZUtpbmQxWyJTY2FsYXIiXSA9IDFdID0gIlNjYWxhciI7CiAgICBOb2RlS2luZDFbTm9kZUtpbmQxWyJPYmplY3QiXSA9IDJdID0gIk9iamVjdCI7Cn0pKE5vZGVLaW5kIHx8IChOb2RlS2luZCA9IHt9KSk7CmNsYXNzIE5vZGUxIHsKICAgIGtpbmQ7CiAgICBxdWVyeSA9IFtdOwogICAgY29uc3RydWN0b3Ioa2luZCl7CiAgICAgICAgdGhpcy5raW5kID0ga2luZDsKICAgIH0KfQpjbGFzcyBDZkdxbENsaWVudCB7CiAgICBzdGF0aWMgREVCVUcgPSBmYWxzZTsKICAgIHN0YXRpYyBVUkxfVFJBTlNGT1JNRVIgPSAodik9PnYKICAgIDsKICAgIHByb2ZpbGU7CiAgICBjb25zdHJ1Y3Rvcihwcm9maWxlKXsKICAgICAgICB0aGlzLnByb2ZpbGUgPSBwcm9maWxlOwogICAgfQogICAgYXN5bmMgZ2V0RHVyYWJsZU9iamVjdFBlcmlvZGljTWV0cmljc0J5RGF0ZShzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgICAgICByZXR1cm4gYXdhaXQgX2dldER1cmFibGVPYmplY3RQZXJpb2RpY01ldHJpY3NCeURhdGUodGhpcy5wcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpOwogICAgfQogICAgYXN5bmMgZ2V0RHVyYWJsZU9iamVjdFN0b3JhZ2VCeURhdGUoc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9nZXREdXJhYmxlT2JqZWN0U3RvcmFnZUJ5RGF0ZSh0aGlzLnByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSk7CiAgICB9CiAgICBhc3luYyBnZXREdXJhYmxlT2JqZWN0SW52b2NhdGlvbnNCeURhdGUoc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9nZXREdXJhYmxlT2JqZWN0SW52b2NhdGlvbnNCeURhdGUodGhpcy5wcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpOwogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIHF1ZXJ5KHByb2ZpbGUsIHF1ZXJ5Rm4sIHZhcmlhYmxlcykgewogICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICBjb25zdCBxID0gR3JhcGhxbFF1ZXJ5LmNyZWF0ZSgpLnNjYWxhcignY29zdCcpLm9iamVjdCgndmlld2VyJykuc2NhbGFyKCdidWRnZXQnKS5vYmplY3QoJ2FjY291bnRzJykuYXJnT2JqZWN0KCdmaWx0ZXInLCAnYWNjb3VudFRhZycsIGFjY291bnRJZCkuc2NhbGFyKCdhY2NvdW50VGFnJyk7CiAgICBxdWVyeUZuKHEpOwogICAgY29uc3QgcXVlcnkxID0gcS50b3AoKS50b1N0cmluZygpOwogICAgaWYgKENmR3FsQ2xpZW50LkRFQlVHKSBjb25zb2xlLmxvZyhxdWVyeTEpOwogICAgY29uc3QgcmVxT2JqID0gewogICAgICAgIHF1ZXJ5OiBxdWVyeTEsCiAgICAgICAgdmFyaWFibGVzCiAgICB9OwogICAgY29uc3QgYm9keSA9IEpTT04uc3RyaW5naWZ5KHJlcU9iaik7CiAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICBjb25zdCB1cmwgPSBDZkdxbENsaWVudC5VUkxfVFJBTlNGT1JNRVIoJ2h0dHBzOi8vYXBpLmNsb3VkZmxhcmUuY29tL2NsaWVudC92NC9ncmFwaHFsJyk7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcsCiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaVRva2VufWAKICAgICAgICB9LAogICAgICAgIGJvZHkKICAgIH0pOwogICAgY29uc3QgZmV0Y2hNaWxsaXMgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICBpZiAoQ2ZHcWxDbGllbnQuREVCVUcpIGNvbnNvbGUubG9nKHJlcyk7CiAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCByZXMuc3RhdHVzOiAke3Jlcy5zdGF0dXN9LCBleHBlY3RlZCAyMDAsIHRleHQ9JHthd2FpdCByZXMudGV4dCgpfWApOwogICAgY29uc3QgY29udGVudFR5cGUgPSByZXMuaGVhZGVycy5nZXQoJ2NvbnRlbnQtdHlwZScpOwogICAgaWYgKGNvbnRlbnRUeXBlICE9PSAnYXBwbGljYXRpb24vanNvbicpIHRocm93IG5ldyBFcnJvcihgQmFkIHJlcy5jb250ZW50VHlwZTogJHtjb250ZW50VHlwZX0sIGV4cGVjdGVkIGFwcGxpY2F0aW9uL2pzb24sIGZvdW5kICR7Y29udGVudFR5cGV9LCB0ZXh0PSR7YXdhaXQgcmVzLnRleHQoKX1gKTsKICAgIGNvbnN0IHJlc09iaiA9IGF3YWl0IHJlcy5qc29uKCk7CiAgICByZXNPYmouZmV0Y2hNaWxsaXMgPSBmZXRjaE1pbGxpczsKICAgIGlmIChDZkdxbENsaWVudC5ERUJVRykgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzT2JqLCB1bmRlZmluZWQsIDIpKTsKICAgIGlmIChpc0dxbEVycm9yUmVzcG9uc2UocmVzT2JqKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihyZXNPYmouZXJyb3JzLm1hcChjb21wdXRlR3FsRXJyb3JTdHJpbmcpLmpvaW4oJywgJykpOwogICAgfQogICAgcmV0dXJuIHJlc09iajsKfQpmdW5jdGlvbiBpc0dxbEVycm9yUmVzcG9uc2Uob2JqKSB7CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqLmRhdGEgPT09IG51bGwgJiYgQXJyYXkuaXNBcnJheShvYmouZXJyb3JzKTsKfQpmdW5jdGlvbiBjb21wdXRlR3FsRXJyb3JTdHJpbmcoZXJyb3IpIHsKICAgIGNvbnN0IHBpZWNlcyA9IFsKICAgICAgICBlcnJvci5tZXNzYWdlCiAgICBdOwogICAgaWYgKGVycm9yLnBhdGgpIHBpZWNlcy5wdXNoKGAoJHtlcnJvci5wYXRoLmpvaW4oJy8nKX0pYCk7CiAgICBpZiAoZXJyb3IuZXh0ZW5zaW9ucy5jb2RlKSBwaWVjZXMucHVzaChgKGNvZGU9JHtlcnJvci5leHRlbnNpb25zLmNvZGV9KWApOwogICAgcmV0dXJuIHBpZWNlcy5qb2luKCcgJyk7Cn0KYXN5bmMgZnVuY3Rpb24gX2dldER1cmFibGVPYmplY3RQZXJpb2RpY01ldHJpY3NCeURhdGUocHJvZmlsZSwgc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKSB7CiAgICBjb25zdCByZXNPYmogPSBhd2FpdCBxdWVyeShwcm9maWxlLCAocSk9PnEub2JqZWN0KCdkdXJhYmxlT2JqZWN0c1BlcmlvZGljR3JvdXBzJykuYXJnTG9uZygnbGltaXQnLCAxMDAwMCkuYXJnUmF3KCdmaWx0ZXInLCBge2RhdGVfZ2VxOiAkc3RhcnQsIGRhdGVfbGVxOiAkZW5kfWApLmFyZ1Jhdygnb3JkZXJCeScsIGBbZGF0ZV9BU0NdYCkub2JqZWN0KCdkaW1lbnNpb25zJykuc2NhbGFyKCdkYXRlJykuc2NhbGFyKCduYW1lc3BhY2VJZCcpLmVuZCgpLm9iamVjdCgnbWF4Jykuc2NhbGFyKCdhY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucycpLmVuZCgpLm9iamVjdCgnc3VtJykuc2NhbGFyKCdhY3RpdmVUaW1lJykuc2NhbGFyKCdjcHVUaW1lJykuc2NhbGFyKCdleGNlZWRlZENwdUVycm9ycycpLnNjYWxhcignZXhjZWVkZWRNZW1vcnlFcnJvcnMnKS5zY2FsYXIoJ2ZhdGFsSW50ZXJuYWxFcnJvcnMnKS5zY2FsYXIoJ2luYm91bmRXZWJzb2NrZXRNc2dDb3VudCcpLnNjYWxhcignb3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCcpLnNjYWxhcignc3RvcmFnZURlbGV0ZXMnKS5zY2FsYXIoJ3N0b3JhZ2VSZWFkVW5pdHMnKS5zY2FsYXIoJ3N0b3JhZ2VXcml0ZVVuaXRzJykuc2NhbGFyKCdzdWJyZXF1ZXN0cycpCiAgICAsIHsKICAgICAgICBzdGFydDogc3RhcnREYXRlSW5jbHVzaXZlLAogICAgICAgIGVuZDogZW5kRGF0ZUluY2x1c2l2ZQogICAgfSk7CiAgICBjb25zdCBmZXRjaE1pbGxpcyA9IHJlc09iai5mZXRjaE1pbGxpczsKICAgIGNvbnN0IHJlcyA9IHJlc09iajsKICAgIGNvbnN0IGNvc3QgPSByZXMuZGF0YS5jb3N0OwogICAgY29uc3QgYnVkZ2V0ID0gcmVzLmRhdGEudmlld2VyLmJ1ZGdldDsKICAgIGNvbnN0IHJvd3MgPSBbXTsKICAgIGZvciAoY29uc3QgYWNjb3VudCBvZiByZXMuZGF0YS52aWV3ZXIuYWNjb3VudHMpewogICAgICAgIGNoZWNrRXF1YWwoJ2FjY291bnQuYWNjb3VudFRhZycsIGFjY291bnQuYWNjb3VudFRhZywgcHJvZmlsZS5hY2NvdW50SWQpOwogICAgICAgIGZvciAoY29uc3QgZ3JvdXAgb2YgYWNjb3VudC5kdXJhYmxlT2JqZWN0c1BlcmlvZGljR3JvdXBzKXsKICAgICAgICAgICAgY29uc3QgZGF0ZSA9IGdyb3VwLmRpbWVuc2lvbnMuZGF0ZTsKICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlSWQgPSBncm91cC5kaW1lbnNpb25zLm5hbWVzcGFjZUlkOwogICAgICAgICAgICBjb25zdCBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyA9IGdyb3VwLm1heC5hY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9uczsKICAgICAgICAgICAgY29uc3Qgc3VtQWN0aXZlVGltZSA9IGdyb3VwLnN1bS5hY3RpdmVUaW1lOwogICAgICAgICAgICBjb25zdCBzdW1DcHVUaW1lID0gZ3JvdXAuc3VtLmNwdVRpbWU7CiAgICAgICAgICAgIGNvbnN0IHN1bUV4Y2VlZGVkQ3B1RXJyb3JzID0gZ3JvdXAuc3VtLmV4Y2VlZGVkQ3B1RXJyb3JzOwogICAgICAgICAgICBjb25zdCBzdW1FeGNlZWRlZE1lbW9yeUVycm9ycyA9IGdyb3VwLnN1bS5leGNlZWRlZE1lbW9yeUVycm9yczsKICAgICAgICAgICAgY29uc3Qgc3VtRmF0YWxJbnRlcm5hbEVycm9ycyA9IGdyb3VwLnN1bS5mYXRhbEludGVybmFsRXJyb3JzOwogICAgICAgICAgICBjb25zdCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgPSBncm91cC5zdW0uaW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50OwogICAgICAgICAgICBjb25zdCBzdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ID0gZ3JvdXAuc3VtLm91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ7CiAgICAgICAgICAgIGNvbnN0IHN1bVN0b3JhZ2VEZWxldGVzID0gZ3JvdXAuc3VtLnN0b3JhZ2VEZWxldGVzOwogICAgICAgICAgICBjb25zdCBzdW1TdG9yYWdlUmVhZFVuaXRzID0gZ3JvdXAuc3VtLnN0b3JhZ2VSZWFkVW5pdHM7CiAgICAgICAgICAgIGNvbnN0IHN1bVN0b3JhZ2VXcml0ZVVuaXRzID0gZ3JvdXAuc3VtLnN0b3JhZ2VXcml0ZVVuaXRzOwogICAgICAgICAgICBjb25zdCBzdW1TdWJyZXF1ZXN0cyA9IGdyb3VwLnN1bS5zdWJyZXF1ZXN0czsKICAgICAgICAgICAgcm93cy5wdXNoKHsKICAgICAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgICAgICBuYW1lc3BhY2VJZCwKICAgICAgICAgICAgICAgIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zLAogICAgICAgICAgICAgICAgc3VtQWN0aXZlVGltZSwKICAgICAgICAgICAgICAgIHN1bUNwdVRpbWUsCiAgICAgICAgICAgICAgICBzdW1FeGNlZWRlZENwdUVycm9ycywKICAgICAgICAgICAgICAgIHN1bUV4Y2VlZGVkTWVtb3J5RXJyb3JzLAogICAgICAgICAgICAgICAgc3VtRmF0YWxJbnRlcm5hbEVycm9ycywKICAgICAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgICAgICBzdW1TdG9yYWdlRGVsZXRlcywKICAgICAgICAgICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHMsCiAgICAgICAgICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0cywKICAgICAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgaW5mbzogewogICAgICAgICAgICBmZXRjaE1pbGxpcywKICAgICAgICAgICAgY29zdCwKICAgICAgICAgICAgYnVkZ2V0CiAgICAgICAgfSwKICAgICAgICByb3dzCiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIF9nZXREdXJhYmxlT2JqZWN0U3RvcmFnZUJ5RGF0ZShwcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgIGNvbnN0IHJlc09iaiA9IGF3YWl0IHF1ZXJ5KHByb2ZpbGUsIChxKT0+cS5vYmplY3QoJ2R1cmFibGVPYmplY3RzU3RvcmFnZUdyb3VwcycpLmFyZ0xvbmcoJ2xpbWl0JywgMTAwMDApLmFyZ1JhdygnZmlsdGVyJywgYHtkYXRlX2dlcTogJHN0YXJ0LCBkYXRlX2xlcTogJGVuZH1gKS5hcmdSYXcoJ29yZGVyQnknLCBgW2RhdGVfQVNDXWApLm9iamVjdCgnZGltZW5zaW9ucycpLnNjYWxhcignZGF0ZScpLmVuZCgpLm9iamVjdCgnbWF4Jykuc2NhbGFyKCdzdG9yZWRCeXRlcycpLmVuZCgpCiAgICAsIHsKICAgICAgICBzdGFydDogc3RhcnREYXRlSW5jbHVzaXZlLAogICAgICAgIGVuZDogZW5kRGF0ZUluY2x1c2l2ZQogICAgfSk7CiAgICBjb25zdCBmZXRjaE1pbGxpcyA9IHJlc09iai5mZXRjaE1pbGxpczsKICAgIGNvbnN0IHJlcyA9IHJlc09iajsKICAgIGNvbnN0IGNvc3QgPSByZXMuZGF0YS5jb3N0OwogICAgY29uc3QgYnVkZ2V0ID0gcmVzLmRhdGEudmlld2VyLmJ1ZGdldDsKICAgIGNvbnN0IHJvd3MgPSBbXTsKICAgIGZvciAoY29uc3QgYWNjb3VudCBvZiByZXMuZGF0YS52aWV3ZXIuYWNjb3VudHMpewogICAgICAgIGNoZWNrRXF1YWwoJ2FjY291bnQuYWNjb3VudFRhZycsIGFjY291bnQuYWNjb3VudFRhZywgcHJvZmlsZS5hY2NvdW50SWQpOwogICAgICAgIGZvciAoY29uc3QgZ3JvdXAgb2YgYWNjb3VudC5kdXJhYmxlT2JqZWN0c1N0b3JhZ2VHcm91cHMpewogICAgICAgICAgICBjb25zdCBkYXRlID0gZ3JvdXAuZGltZW5zaW9ucy5kYXRlOwogICAgICAgICAgICBjb25zdCBtYXhTdG9yZWRCeXRlcyA9IGdyb3VwLm1heC5zdG9yZWRCeXRlczsKICAgICAgICAgICAgcm93cy5wdXNoKHsKICAgICAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgICAgICBtYXhTdG9yZWRCeXRlcwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGluZm86IHsKICAgICAgICAgICAgZmV0Y2hNaWxsaXMsCiAgICAgICAgICAgIGNvc3QsCiAgICAgICAgICAgIGJ1ZGdldAogICAgICAgIH0sCiAgICAgICAgcm93cwogICAgfTsKfQphc3luYyBmdW5jdGlvbiBfZ2V0RHVyYWJsZU9iamVjdEludm9jYXRpb25zQnlEYXRlKHByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSkgewogICAgY29uc3QgcmVzT2JqID0gYXdhaXQgcXVlcnkocHJvZmlsZSwgKHEpPT5xLm9iamVjdCgnZHVyYWJsZU9iamVjdHNJbnZvY2F0aW9uc0FkYXB0aXZlR3JvdXBzJykuYXJnTG9uZygnbGltaXQnLCAxMDAwMCkuYXJnUmF3KCdmaWx0ZXInLCBge2RhdGVfZ2VxOiAkc3RhcnQsIGRhdGVfbGVxOiAkZW5kfWApLmFyZ1Jhdygnb3JkZXJCeScsIGBbZGF0ZV9BU0NdYCkub2JqZWN0KCdkaW1lbnNpb25zJykuc2NhbGFyKCdkYXRlJykuc2NhbGFyKCduYW1lc3BhY2VJZCcpLmVuZCgpLm9iamVjdCgnYXZnJykuc2NhbGFyKCdzYW1wbGVJbnRlcnZhbCcpLmVuZCgpLm9iamVjdCgnc3VtJykuc2NhbGFyKCdyZXF1ZXN0cycpLmVuZCgpCiAgICAsIHsKICAgICAgICBzdGFydDogc3RhcnREYXRlSW5jbHVzaXZlLAogICAgICAgIGVuZDogZW5kRGF0ZUluY2x1c2l2ZQogICAgfSk7CiAgICBjb25zdCBmZXRjaE1pbGxpcyA9IHJlc09iai5mZXRjaE1pbGxpczsKICAgIGNvbnN0IHJlcyA9IHJlc09iajsKICAgIGNvbnN0IGNvc3QgPSByZXMuZGF0YS5jb3N0OwogICAgY29uc3QgYnVkZ2V0ID0gcmVzLmRhdGEudmlld2VyLmJ1ZGdldDsKICAgIGNvbnN0IHJvd3MgPSBbXTsKICAgIGZvciAoY29uc3QgYWNjb3VudCBvZiByZXMuZGF0YS52aWV3ZXIuYWNjb3VudHMpewogICAgICAgIGNoZWNrRXF1YWwoJ2FjY291bnQuYWNjb3VudFRhZycsIGFjY291bnQuYWNjb3VudFRhZywgcHJvZmlsZS5hY2NvdW50SWQpOwogICAgICAgIGZvciAoY29uc3QgZ3JvdXAgb2YgYWNjb3VudC5kdXJhYmxlT2JqZWN0c0ludm9jYXRpb25zQWRhcHRpdmVHcm91cHMpewogICAgICAgICAgICBjb25zdCBkYXRlID0gZ3JvdXAuZGltZW5zaW9ucy5kYXRlOwogICAgICAgICAgICBjb25zdCBuYW1lc3BhY2VJZCA9IGdyb3VwLmRpbWVuc2lvbnMubmFtZXNwYWNlSWQ7CiAgICAgICAgICAgIGNvbnN0IGF2Z1NhbXBsZUludGVydmFsID0gZ3JvdXAuYXZnLnNhbXBsZUludGVydmFsOwogICAgICAgICAgICBjb25zdCBzdW1SZXF1ZXN0cyA9IGdyb3VwLnN1bS5yZXF1ZXN0czsKICAgICAgICAgICAgcm93cy5wdXNoKHsKICAgICAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgICAgICBuYW1lc3BhY2VJZCwKICAgICAgICAgICAgICAgIGF2Z1NhbXBsZUludGVydmFsLAogICAgICAgICAgICAgICAgc3VtUmVxdWVzdHMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBpbmZvOiB7CiAgICAgICAgICAgIGZldGNoTWlsbGlzLAogICAgICAgICAgICBjb3N0LAogICAgICAgICAgICBidWRnZXQKICAgICAgICB9LAogICAgICAgIHJvd3MKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdER1cmFibGVPYmplY3RzTmFtZXNwYWNlcyhhY2NvdW50SWQsIGFwaVRva2VuKSB7CiAgICBjb25zdCB1cmwgPSBgJHtjb21wdXRlQWNjb3VudEJhc2VVcmwxKGFjY291bnRJZCl9L3dvcmtlcnMvZHVyYWJsZV9vYmplY3RzL25hbWVzcGFjZXNgOwogICAgcmV0dXJuIChhd2FpdCBleGVjdXRlMSgnbGlzdER1cmFibGVPYmplY3RzTmFtZXNwYWNlcycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmNsYXNzIENsb3VkZmxhcmVBcGkxIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04xID0gJ2FwcGxpY2F0aW9uL2pzb24nOwpjb25zdCBBUFBMSUNBVElPTl9KU09OX1VURjgxID0gJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9VVRGLTgnOwpjb25zdCBBUFBMSUNBVElPTl9PQ1RFVF9TVFJFQU0xID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmNvbnN0IFRFWFRfUExBSU5fVVRGODEgPSAndGV4dC9wbGFpbjsgY2hhcnNldD1VVEYtOCc7CmZ1bmN0aW9uIGNvbXB1dGVBY2NvdW50QmFzZVVybDEoYWNjb3VudElkKSB7CiAgICByZXR1cm4gQ2xvdWRmbGFyZUFwaTEuVVJMX1RSQU5TRk9STUVSKGBodHRwczovL2FwaS5jbG91ZGZsYXJlLmNvbS9jbGllbnQvdjQvYWNjb3VudHMvJHthY2NvdW50SWR9YCk7Cn0KZnVuY3Rpb24gaXNTdHJpbmdSZWNvcmQxKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheShvYmopICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0Owp9CmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUxKG9wLCBtZXRob2QsIHVybCwgYXBpVG9rZW4sIGJvZHksIHJlc3BvbnNlVHlwZSA9ICdqc29uJykgewogICAgaWYgKENsb3VkZmxhcmVBcGkxLkRFQlVHKSBjb25zb2xlLmxvZyhgJHtvcH06ICR7bWV0aG9kfSAke3VybH1gKTsKICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyh7CiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YXBpVG9rZW59YAogICAgfSk7CiAgICBsZXQgYm9keU9iajsKICAgIGlmICh0eXBlb2YgYm9keSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBoZWFkZXJzLnNldCgnQ29udGVudC1UeXBlJywgVEVYVF9QTEFJTl9VVEY4MSk7CiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nUmVjb3JkMShib2R5KSkgewogICAgICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBBUFBMSUNBVElPTl9KU09OX1VURjgxKTsKICAgICAgICBib2R5T2JqID0gYm9keTsKICAgICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoYm9keSk7CiAgICB9CiAgICBpZiAoQ2xvdWRmbGFyZUFwaTEuREVCVUcpIGNvbnNvbGUubG9nKFsKICAgICAgICAuLi5oZWFkZXJzCiAgICBdLm1hcCgodik9PnYuam9pbignOiAnKQogICAgKS5qb2luKCdcbicpKTsKICAgIGlmIChDbG91ZGZsYXJlQXBpMS5ERUJVRyAmJiBib2R5T2JqKSBjb25zb2xlLmxvZyhib2R5T2JqKTsKICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGlmIChDbG91ZGZsYXJlQXBpMS5ERUJVRykgY29uc29sZS5sb2coYCR7ZmV0Y2hSZXNwb25zZS5zdGF0dXN9ICR7ZmV0Y2hSZXNwb25zZS51cmx9YCk7CiAgICBpZiAoQ2xvdWRmbGFyZUFwaTEuREVCVUcpIGNvbnNvbGUubG9nKFsKICAgICAgICAuLi5mZXRjaFJlc3BvbnNlLmhlYWRlcnMKICAgIF0ubWFwKCh2KT0+di5qb2luKCc6ICcpCiAgICApLmpvaW4oJ1xuJykpOwogICAgY29uc3QgY29udGVudFR5cGUgPSBmZXRjaFJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKSB8fCAnJzsKICAgIGlmICgocmVzcG9uc2VUeXBlID09PSAnYnl0ZXMnIHx8IHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzPycpICYmIGNvbnRlbnRUeXBlID09PSBBUFBMSUNBVElPTl9PQ1RFVF9TVFJFQU0xKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKHJlc3BvbnNlVHlwZSA9PT0gJ3RleHQ/JyAmJiBjb250ZW50VHlwZS5zdGFydHNXaXRoKCd0ZXh0LycpKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoUmVzcG9uc2UudGV4dCgpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4MSwKICAgICAgICBBUFBMSUNBVElPTl9KU09OMQogICAgXS5pbmNsdWRlcyhjb250ZW50VHlwZSkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgY29udGVudC10eXBlOiAke2NvbnRlbnRUeXBlfSwgZmV0Y2hSZXNwb25zZT0ke2ZldGNoUmVzcG9uc2V9LCBib2R5PSR7YXdhaXQgZmV0Y2hSZXNwb25zZS50ZXh0KCl9YCk7CiAgICB9CiAgICBjb25zdCBhcGlSZXNwb25zZSA9IGF3YWl0IGZldGNoUmVzcG9uc2UuanNvbigpOwogICAgaWYgKENsb3VkZmxhcmVBcGkxLkRFQlVHKSBjb25zb2xlLmxvZyhhcGlSZXNwb25zZSk7CiAgICBpZiAoIWFwaVJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAoZmV0Y2hSZXNwb25zZS5zdGF0dXMgPT09IDQwNCAmJiBbCiAgICAgICAgICAgICdieXRlcz8nLAogICAgICAgICAgICAnanNvbj8nCiAgICAgICAgXS5pbmNsdWRlcyhyZXNwb25zZVR5cGUpKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHRocm93IG5ldyBDbG91ZGZsYXJlQXBpRXJyb3IxKGAke29wfSBmYWlsZWQ6IHN0YXR1cz0ke2ZldGNoUmVzcG9uc2Uuc3RhdHVzfSwgZXJyb3JzPSR7YXBpUmVzcG9uc2UuZXJyb3JzLm1hcCgodik9PmAke3YuY29kZX0gJHt2Lm1lc3NhZ2V9YAogICAgICAgICkuam9pbignLCAnKX1gLCBmZXRjaFJlc3BvbnNlLnN0YXR1cywgYXBpUmVzcG9uc2UuZXJyb3JzKTsKICAgIH0KICAgIHJldHVybiBhcGlSZXNwb25zZTsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpRXJyb3IxIGV4dGVuZHMgRXJyb3IgewogICAgc3RhdHVzOwogICAgZXJyb3JzOwogICAgY29uc3RydWN0b3IobWVzc2FnZSwgc3RhdHVzLCBlcnJvcnMpewogICAgICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgICAgIHRoaXMuZXJyb3JzID0gZXJyb3JzOwogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVEdXJhYmxlT2JqZWN0c0Nvc3RzVGFibGUoY2xpZW50LCBvcHRzKSB7CiAgICBjb25zdCB7IHN0YXJ0OiBzdGFydDEgLCBlbmQ6IGVuZDEgIH0gPSAoKCk9PnsKICAgICAgICBpZiAoJ2xvb2tiYWNrRGF5cycgaW4gb3B0cykgewogICAgICAgICAgICBjb25zdCBlbmQgPSB1dGNDdXJyZW50RGF0ZSgpOwogICAgICAgICAgICBjb25zdCBzdGFydCA9IGFkZERheXNUb0RhdGUoZW5kLCAtb3B0cy5sb29rYmFja0RheXMpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgICBlbmQKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCB7IHN0YXJ0ICwgZW5kICB9ID0gb3B0czsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICAgICAgZW5kCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSkoKTsKICAgIGNvbnN0IFtzdG9yYWdlLCBwZXJpb2RpYywgaW52b2NhdGlvbnMsIG5hbWVzcGFjZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICAgIGNsaWVudC5nZXREdXJhYmxlT2JqZWN0U3RvcmFnZUJ5RGF0ZShzdGFydDEsIGVuZDEpLAogICAgICAgIGNsaWVudC5nZXREdXJhYmxlT2JqZWN0UGVyaW9kaWNNZXRyaWNzQnlEYXRlKHN0YXJ0MSwgZW5kMSksCiAgICAgICAgY2xpZW50LmdldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZShzdGFydDEsIGVuZDEpLAogICAgICAgIHRyeUxpc3REdXJhYmxlT2JqZWN0c05hbWVzcGFjZXMoY2xpZW50LnByb2ZpbGUpLCAKICAgIF0pOwogICAgY29uc3QgZ3FsUmVzdWx0SW5mb3MgPSB7CiAgICAgICAgJ3N0b3JhZ2UnOiBzdG9yYWdlLmluZm8sCiAgICAgICAgJ3BlcmlvZGljJzogcGVyaW9kaWMuaW5mbywKICAgICAgICAnaW52b2NhdGlvbnMnOiBpbnZvY2F0aW9ucy5pbmZvCiAgICB9OwogICAgY29uc3Qgcm93c0J5TmFtZXNwYWNlID0ge307CiAgICBjb25zdCByb3dzQnlEYXRlID0ge307CiAgICBmb3IgKGNvbnN0IHBSb3cgb2YgcGVyaW9kaWMucm93cyl7CiAgICAgICAgY29uc3QgeyBkYXRlICwgbmFtZXNwYWNlSWQgLCBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyAsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCAsIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdW1TdWJyZXF1ZXN0cyAsIHN1bUFjdGl2ZVRpbWUgLCBzdW1TdG9yYWdlUmVhZFVuaXRzICwgc3VtU3RvcmFnZVdyaXRlVW5pdHMgLCBzdW1TdG9yYWdlRGVsZXRlcyAsICB9ID0gcFJvdzsKICAgICAgICBsZXQgcm93cyA9IHJvd3NCeU5hbWVzcGFjZVtuYW1lc3BhY2VJZF07CiAgICAgICAgaWYgKCFyb3dzKSB7CiAgICAgICAgICAgIHJvd3MgPSBbXTsKICAgICAgICAgICAgcm93c0J5TmFtZXNwYWNlW25hbWVzcGFjZUlkXSA9IHJvd3M7CiAgICAgICAgfQogICAgICAgIGxldCBkYXRlUm93cyA9IHJvd3NCeURhdGVbZGF0ZV07CiAgICAgICAgaWYgKCFkYXRlUm93cykgewogICAgICAgICAgICBkYXRlUm93cyA9IFtdOwogICAgICAgICAgICByb3dzQnlEYXRlW2RhdGVdID0gZGF0ZVJvd3M7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsgc3VtUmVxdWVzdHMgIH0gPSBpbnZvY2F0aW9ucy5yb3dzLmZpbHRlcigodik9PnYuZGF0ZSA9PT0gZGF0ZSAmJiB2Lm5hbWVzcGFjZUlkID09PSBuYW1lc3BhY2VJZAogICAgICAgIClbMF0gfHwgewogICAgICAgICAgICBzdW1SZXF1ZXN0czogMAogICAgICAgIH07CiAgICAgICAgY29uc3QgeyByZXF1ZXN0c0Nvc3QgLCB3ZWJzb2NrZXRzQ29zdCAsIHN1YnJlcXVlc3RzQ29zdCAsIGFjdGl2ZUNvc3QgLCByZWFkVW5pdHNDb3N0ICwgd3JpdGVVbml0c0Nvc3QgLCBkZWxldGVzQ29zdCAsIHRvdGFsQ29zdCAsIGFjdGl2ZUdiU2Vjb25kcyAgfSA9IGNvbXB1dGVDb3N0cyh7CiAgICAgICAgICAgIHN1bVJlcXVlc3RzLAogICAgICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzLAogICAgICAgICAgICBzdW1BY3RpdmVUaW1lLAogICAgICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzLAogICAgICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0cywKICAgICAgICAgICAgc3VtU3RvcmFnZURlbGV0ZXMsCiAgICAgICAgICAgIGV4Y2x1ZGVGcmVlVXNhZ2U6IGZhbHNlLAogICAgICAgICAgICBzdG9yYWdlQ29zdDogMAogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHJvdyA9IHsKICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgc3VtUmVxdWVzdHMsCiAgICAgICAgICAgIHJlcXVlc3RzQ29zdCwKICAgICAgICAgICAgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgd2Vic29ja2V0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzLAogICAgICAgICAgICBzdWJyZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIHN1bUFjdGl2ZVRpbWUsCiAgICAgICAgICAgIGFjdGl2ZUdiU2Vjb25kcywKICAgICAgICAgICAgYWN0aXZlQ29zdCwKICAgICAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICAgICAgcmVhZFVuaXRzQ29zdCwKICAgICAgICAgICAgc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgIHdyaXRlVW5pdHNDb3N0LAogICAgICAgICAgICBzdW1TdG9yYWdlRGVsZXRlcywKICAgICAgICAgICAgZGVsZXRlc0Nvc3QsCiAgICAgICAgICAgIHRvdGFsQ29zdAogICAgICAgIH07CiAgICAgICAgcm93cy5wdXNoKHJvdyk7CiAgICAgICAgZGF0ZVJvd3MucHVzaChyb3cpOwogICAgfQogICAgY29uc3QgbmFtZXNwYWNlVGFibGVzID0ge307CiAgICBmb3IgKGNvbnN0IFtuYW1lc3BhY2VJZCwgcm93c10gb2YgT2JqZWN0LmVudHJpZXMocm93c0J5TmFtZXNwYWNlKSl7CiAgICAgICAgY29uc3QgZXN0aW1hdGVkMzBEYXlSb3cgPSBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3cocm93cywgZmFsc2UpOwogICAgICAgIGNvbnN0IG5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuZmluZCgodik9PnYuaWQgPT09IG5hbWVzcGFjZUlkCiAgICAgICAgKTsKICAgICAgICBuYW1lc3BhY2VUYWJsZXNbbmFtZXNwYWNlSWRdID0gewogICAgICAgICAgICByb3dzLAogICAgICAgICAgICBlc3RpbWF0ZWQzMERheVJvdywKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBlc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZTogdW5kZWZpbmVkCiAgICAgICAgfTsKICAgIH0KICAgIGNvbnN0IGFjY291bnRSb3dzID0gW107CiAgICBmb3IgKGNvbnN0IFtkYXRlLCBkYXRlUm93c10gb2YgT2JqZWN0LmVudHJpZXMocm93c0J5RGF0ZSkpewogICAgICAgIGNvbnN0IHsgbWF4U3RvcmVkQnl0ZXMgIH0gPSBzdG9yYWdlLnJvd3MuZmlsdGVyKCh2KT0+di5kYXRlID09PSBkYXRlCiAgICAgICAgKVswXSB8fCB7CiAgICAgICAgICAgIG1heFN0b3JlZEJ5dGVzOiAwCiAgICAgICAgfTsKICAgICAgICBjb25zdCBzdG9yYWdlR2IgPSBtYXhTdG9yZWRCeXRlcyAvIDEwMjQgLyAxMDI0IC8gMTAyNDsKICAgICAgICBjb25zdCBzdG9yYWdlQ29zdCA9IHN0b3JhZ2VHYiAqIC4yMCAvIDMwOwogICAgICAgIGFjY291bnRSb3dzLnB1c2goY29tcHV0ZVRvdGFsUm93KGRhdGUsIGRhdGVSb3dzLCB7CiAgICAgICAgICAgIHN0b3JhZ2VHYiwKICAgICAgICAgICAgc3RvcmFnZUNvc3QKICAgICAgICB9KSk7CiAgICB9CiAgICBjb25zdCBzdG9yYWdlQ29zdCA9IGFjY291bnRSb3dzLmxlbmd0aCA+IDAgPyBhY2NvdW50Um93cy5tYXAoKHYpPT52LnN0b3JhZ2VDb3N0IHx8IDAKICAgICkucmVkdWNlKChhLCBiKT0+YSArIGIKICAgICkgOiAwOwogICAgY29uc3QgYWNjb3VudE9wdHMgPSB7CiAgICAgICAgc3RvcmFnZUdiOiAwLAogICAgICAgIHN0b3JhZ2VDb3N0CiAgICB9OwogICAgY29uc3QgZXN0aW1hdGVkMzBEYXlSb3cgPSBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3coYWNjb3VudFJvd3MsIGZhbHNlLCBhY2NvdW50T3B0cyk7CiAgICBjb25zdCBlc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZSA9IGNvbXB1dGVFc3RpbWF0ZWQzMERheVJvdyhhY2NvdW50Um93cywgdHJ1ZSwgYWNjb3VudE9wdHMpOwogICAgY29uc3QgYWNjb3VudFRhYmxlID0gewogICAgICAgIHJvd3M6IGFjY291bnRSb3dzLAogICAgICAgIGVzdGltYXRlZDMwRGF5Um93LAogICAgICAgIGVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLAogICAgICAgIG5hbWVzcGFjZTogdW5kZWZpbmVkCiAgICB9OwogICAgcmV0dXJuIHsKICAgICAgICBhY2NvdW50VGFibGUsCiAgICAgICAgbmFtZXNwYWNlVGFibGVzLAogICAgICAgIGdxbFJlc3VsdEluZm9zCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVDb3N0cyhpbnB1dCkgewogICAgY29uc3QgeyBzdW1BY3RpdmVUaW1lICwgc3VtU3RvcmFnZVJlYWRVbml0cyAsIHN1bVN0b3JhZ2VXcml0ZVVuaXRzICwgc3VtU3RvcmFnZURlbGV0ZXMgLCBleGNsdWRlRnJlZVVzYWdlICwgc3RvcmFnZUNvc3QgIH0gPSBpbnB1dDsKICAgIGNvbnN0IHsgc3VtUmVxdWVzdHM6IHN1bVJlcXVlc3RzMSAsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudDogc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50MSAsIHN1bVN1YnJlcXVlc3RzOiBzdW1TdWJyZXF1ZXN0czEgIH0gPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgeyBzdW1SZXF1ZXN0cyAsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCAsIHN1bVN1YnJlcXVlc3RzICB9ID0gaW5wdXQ7CiAgICAgICAgaWYgKGV4Y2x1ZGVGcmVlVXNhZ2UpIHsKICAgICAgICAgICAgbGV0IHJlbWFpbmluZyA9IDEwMDAwMDA7CiAgICAgICAgICAgIGxldCB0YWtlID0gTWF0aC5taW4ocmVtYWluaW5nLCBzdW1SZXF1ZXN0cyk7CiAgICAgICAgICAgIGlmICh0YWtlID4gMCkgewogICAgICAgICAgICAgICAgc3VtUmVxdWVzdHMgLT0gdGFrZTsKICAgICAgICAgICAgICAgIHJlbWFpbmluZyAtPSB0YWtlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRha2UgPSBNYXRoLm1pbihyZW1haW5pbmcsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCk7CiAgICAgICAgICAgIGlmICh0YWtlID4gMCkgewogICAgICAgICAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50IC09IHRha2U7CiAgICAgICAgICAgICAgICByZW1haW5pbmcgLT0gdGFrZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YWtlID0gTWF0aC5taW4ocmVtYWluaW5nLCBzdW1TdWJyZXF1ZXN0cyk7CiAgICAgICAgICAgIGlmICh0YWtlID4gMCkgewogICAgICAgICAgICAgICAgc3VtU3VicmVxdWVzdHMgLT0gdGFrZTsKICAgICAgICAgICAgICAgIHJlbWFpbmluZyAtPSB0YWtlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN1bVJlcXVlc3RzLAogICAgICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzCiAgICAgICAgfTsKICAgIH0oKTsKICAgIGNvbnN0IHJlcXVlc3RzQ29zdCA9IHN1bVJlcXVlc3RzMSAvIDEwMDAwMDAgKiAwLjE1OwogICAgY29uc3Qgd2Vic29ja2V0c0Nvc3QgPSBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQxIC8gMTAwMDAwMCAqIDAuMTU7CiAgICBjb25zdCBzdWJyZXF1ZXN0c0Nvc3QgPSBzdW1TdWJyZXF1ZXN0czEgLyAxMDAwMDAwICogMC4xNTsKICAgIGNvbnN0IGFjdGl2ZVRpbWVTZWNvbmRzID0gc3VtQWN0aXZlVGltZSAvIDEwMDAgLyAxMDAwOwogICAgbGV0IGFjdGl2ZUdiU2Vjb25kcyA9IGFjdGl2ZVRpbWVTZWNvbmRzICogMTI4IC8gMTAyNDsKICAgIGlmIChleGNsdWRlRnJlZVVzYWdlKSB7CiAgICAgICAgYWN0aXZlR2JTZWNvbmRzID0gTWF0aC5tYXgoMCwgYWN0aXZlR2JTZWNvbmRzIC0gNDAwMDAwKTsKICAgIH0KICAgIGNvbnN0IGFjdGl2ZUNvc3QgPSBhY3RpdmVHYlNlY29uZHMgLyA0MDAwMDAgKiAxMi41MDsKICAgIGNvbnN0IHJlYWRVbml0c0Nvc3QgPSAoZXhjbHVkZUZyZWVVc2FnZSA/IE1hdGgubWF4KDAsIHN1bVN0b3JhZ2VSZWFkVW5pdHMgLSAxMDAwMDAwKSA6IHN1bVN0b3JhZ2VSZWFkVW5pdHMpIC8gMTAwMDAwMCAqIC4yMDsKICAgIGNvbnN0IHdyaXRlVW5pdHNDb3N0ID0gKGV4Y2x1ZGVGcmVlVXNhZ2UgPyBNYXRoLm1heCgwLCBzdW1TdG9yYWdlV3JpdGVVbml0cyAtIDEwMDAwMDApIDogc3VtU3RvcmFnZVdyaXRlVW5pdHMpIC8gMTAwMDAwMCAqIDE7CiAgICBjb25zdCBkZWxldGVzQ29zdCA9IChleGNsdWRlRnJlZVVzYWdlID8gTWF0aC5tYXgoMCwgc3VtU3RvcmFnZURlbGV0ZXMgLSAxMDAwMDAwKSA6IHN1bVN0b3JhZ2VEZWxldGVzKSAvIDEwMDAwMDAgKiAxOwogICAgbGV0IG5ld1N0b3JhZ2VDb3N0ID0gc3RvcmFnZUNvc3QgfHwgMDsKICAgIGlmIChleGNsdWRlRnJlZVVzYWdlKSBuZXdTdG9yYWdlQ29zdCA9IE1hdGgubWF4KDAsIG5ld1N0b3JhZ2VDb3N0IC0gMC4yMCk7CiAgICBjb25zdCB0b3RhbENvc3QgPSByZXF1ZXN0c0Nvc3QgKyB3ZWJzb2NrZXRzQ29zdCArIHN1YnJlcXVlc3RzQ29zdCArIGFjdGl2ZUNvc3QgKyByZWFkVW5pdHNDb3N0ICsgd3JpdGVVbml0c0Nvc3QgKyBkZWxldGVzQ29zdCArIG5ld1N0b3JhZ2VDb3N0OwogICAgcmV0dXJuIHsKICAgICAgICByZXF1ZXN0c0Nvc3QsCiAgICAgICAgd2Vic29ja2V0c0Nvc3QsCiAgICAgICAgc3VicmVxdWVzdHNDb3N0LAogICAgICAgIGFjdGl2ZUNvc3QsCiAgICAgICAgcmVhZFVuaXRzQ29zdCwKICAgICAgICB3cml0ZVVuaXRzQ29zdCwKICAgICAgICBkZWxldGVzQ29zdCwKICAgICAgICB0b3RhbENvc3QsCiAgICAgICAgYWN0aXZlR2JTZWNvbmRzLAogICAgICAgIG5ld1N0b3JhZ2VDb3N0CiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIHRyeUxpc3REdXJhYmxlT2JqZWN0c05hbWVzcGFjZXMocHJvZmlsZSkgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gYXdhaXQgbGlzdER1cmFibGVPYmplY3RzTmFtZXNwYWNlcyhwcm9maWxlLmFjY291bnRJZCwgcHJvZmlsZS5hcGlUb2tlbik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKGUpOwogICAgICAgIHJldHVybiBbXTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlVG90YWxSb3coZGF0ZSwgcm93cywgb3B0cykgewogICAgbGV0IGNvbXB1dGVkU3RvcmFnZUNvc3QgPSBmYWxzZTsKICAgIGNvbnN0IGNvbXB1dGVTdG9yYWdlQ29zdE9uY2UgPSAoKT0+ewogICAgICAgIGNvbnN0IHJ0ID0gIWNvbXB1dGVkU3RvcmFnZUNvc3QgPyBvcHRzPy5zdG9yYWdlQ29zdCB8fCAwIDogMDsKICAgICAgICBjb21wdXRlZFN0b3JhZ2VDb3N0ID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9OwogICAgcmV0dXJuIHJvd3MucmVkdWNlKChsaHMsIHJocyk9Pih7CiAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgIHN1bVJlcXVlc3RzOiBsaHMuc3VtUmVxdWVzdHMgKyByaHMuc3VtUmVxdWVzdHMsCiAgICAgICAgICAgIHJlcXVlc3RzQ29zdDogbGhzLnJlcXVlc3RzQ29zdCArIHJocy5yZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zOiBsaHMubWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMgKyByaHMubWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudDogbGhzLnN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCArIHJocy5zdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IGxocy5zdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ICsgcmhzLnN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHdlYnNvY2tldHNDb3N0OiBsaHMud2Vic29ja2V0c0Nvc3QgKyByaHMud2Vic29ja2V0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzOiBsaHMuc3VtU3VicmVxdWVzdHMgKyByaHMuc3VtU3VicmVxdWVzdHMsCiAgICAgICAgICAgIHN1YnJlcXVlc3RzQ29zdDogbGhzLnN1YnJlcXVlc3RzQ29zdCArIHJocy5zdWJyZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIHN1bUFjdGl2ZVRpbWU6IGxocy5zdW1BY3RpdmVUaW1lICsgcmhzLnN1bUFjdGl2ZVRpbWUsCiAgICAgICAgICAgIGFjdGl2ZUdiU2Vjb25kczogbGhzLmFjdGl2ZUdiU2Vjb25kcyArIHJocy5hY3RpdmVHYlNlY29uZHMsCiAgICAgICAgICAgIGFjdGl2ZUNvc3Q6IGxocy5hY3RpdmVDb3N0ICsgcmhzLmFjdGl2ZUNvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHM6IGxocy5zdW1TdG9yYWdlUmVhZFVuaXRzICsgcmhzLnN1bVN0b3JhZ2VSZWFkVW5pdHMsCiAgICAgICAgICAgIHJlYWRVbml0c0Nvc3Q6IGxocy5yZWFkVW5pdHNDb3N0ICsgcmhzLnJlYWRVbml0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzOiBsaHMuc3VtU3RvcmFnZVdyaXRlVW5pdHMgKyByaHMuc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgIHdyaXRlVW5pdHNDb3N0OiBsaHMud3JpdGVVbml0c0Nvc3QgKyByaHMud3JpdGVVbml0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzOiBsaHMuc3VtU3RvcmFnZURlbGV0ZXMgKyByaHMuc3VtU3RvcmFnZURlbGV0ZXMsCiAgICAgICAgICAgIGRlbGV0ZXNDb3N0OiBsaHMuZGVsZXRlc0Nvc3QgKyByaHMuZGVsZXRlc0Nvc3QsCiAgICAgICAgICAgIHN0b3JhZ2VHYjogb3B0cz8uc3RvcmFnZUdiLAogICAgICAgICAgICBzdG9yYWdlQ29zdDogb3B0cz8uc3RvcmFnZUNvc3QsCiAgICAgICAgICAgIHRvdGFsQ29zdDogbGhzLnRvdGFsQ29zdCArIHJocy50b3RhbENvc3QgKyBjb21wdXRlU3RvcmFnZUNvc3RPbmNlKCkKICAgICAgICB9KQogICAgKTsKfQpmdW5jdGlvbiBtdWx0aXBseVJvdyhyb3csIG11bHRpcGxpZXIpIHsKICAgIHJldHVybiB7CiAgICAgICAgZGF0ZTogJycsCiAgICAgICAgc3VtUmVxdWVzdHM6IHJvdy5zdW1SZXF1ZXN0cyAqIG11bHRpcGxpZXIsCiAgICAgICAgcmVxdWVzdHNDb3N0OiByb3cucmVxdWVzdHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9uczogcm93Lm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zICogbXVsdGlwbGllciwKICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IHJvdy5zdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IHJvdy5zdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ICogbXVsdGlwbGllciwKICAgICAgICB3ZWJzb2NrZXRzQ29zdDogcm93LndlYnNvY2tldHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1TdWJyZXF1ZXN0czogcm93LnN1bVN1YnJlcXVlc3RzICogbXVsdGlwbGllciwKICAgICAgICBzdWJyZXF1ZXN0c0Nvc3Q6IHJvdy5zdWJyZXF1ZXN0c0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bUFjdGl2ZVRpbWU6IHJvdy5zdW1BY3RpdmVUaW1lICogbXVsdGlwbGllciwKICAgICAgICBhY3RpdmVHYlNlY29uZHM6IHJvdy5hY3RpdmVHYlNlY29uZHMgKiBtdWx0aXBsaWVyLAogICAgICAgIGFjdGl2ZUNvc3Q6IHJvdy5hY3RpdmVDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzOiByb3cuc3VtU3RvcmFnZVJlYWRVbml0cyAqIG11bHRpcGxpZXIsCiAgICAgICAgcmVhZFVuaXRzQ29zdDogcm93LnJlYWRVbml0c0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzOiByb3cuc3VtU3RvcmFnZVdyaXRlVW5pdHMgKiBtdWx0aXBsaWVyLAogICAgICAgIHdyaXRlVW5pdHNDb3N0OiByb3cud3JpdGVVbml0c0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzOiByb3cuc3VtU3RvcmFnZURlbGV0ZXMgKiBtdWx0aXBsaWVyLAogICAgICAgIGRlbGV0ZXNDb3N0OiByb3cuZGVsZXRlc0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN0b3JhZ2VHYjogcm93LnN0b3JhZ2VHYiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogcm93LnN0b3JhZ2VHYiAqIG11bHRpcGxpZXIsCiAgICAgICAgc3RvcmFnZUNvc3Q6IHJvdy5zdG9yYWdlQ29zdCA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogcm93LnN0b3JhZ2VDb3N0ICogbXVsdGlwbGllciwKICAgICAgICB0b3RhbENvc3Q6IHJvdy50b3RhbENvc3QgKiBtdWx0aXBsaWVyCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVFc3RpbWF0ZWQzMERheVJvdyhyb3dzLCBleGNsdWRlRnJlZVVzYWdlLCBvcHRzKSB7CiAgICBpZiAocm93cy5sZW5ndGggPD0gMSkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IHN1bSA9IGNvbXB1dGVUb3RhbFJvdygnJywgcm93cy5zbGljZSgwLCAtMSksIG9wdHMpOwogICAgY29uc3QgZGF5cyA9IHJvd3MubGVuZ3RoIC0gMTsKICAgIGNvbnN0IGVzdFJvdyA9IG11bHRpcGx5Um93KHN1bSwgMzAgLyBkYXlzKTsKICAgIGNvbnN0IHsgc3VtUmVxdWVzdHMgLCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdW1TdWJyZXF1ZXN0cyAsIHN1bVN0b3JhZ2VSZWFkVW5pdHMgLCBzdW1TdG9yYWdlV3JpdGVVbml0cyAsIHN1bVN0b3JhZ2VEZWxldGVzICwgc3VtQWN0aXZlVGltZSAsIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zICwgc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCAsIHN0b3JhZ2VHYiAsIHN0b3JhZ2VDb3N0ICB9ID0gZXN0Um93OwogICAgY29uc3QgeyByZXF1ZXN0c0Nvc3QgLCB3ZWJzb2NrZXRzQ29zdCAsIHN1YnJlcXVlc3RzQ29zdCAsIGFjdGl2ZUNvc3QgLCByZWFkVW5pdHNDb3N0ICwgd3JpdGVVbml0c0Nvc3QgLCBkZWxldGVzQ29zdCAsIHRvdGFsQ29zdCAsIGFjdGl2ZUdiU2Vjb25kcyAsIG5ld1N0b3JhZ2VDb3N0ICB9ID0gY29tcHV0ZUNvc3RzKHsKICAgICAgICBzdW1SZXF1ZXN0cywKICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgc3VtU3VicmVxdWVzdHMsCiAgICAgICAgc3VtQWN0aXZlVGltZSwKICAgICAgICBzdW1TdG9yYWdlUmVhZFVuaXRzLAogICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzLAogICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzLAogICAgICAgIGV4Y2x1ZGVGcmVlVXNhZ2UsCiAgICAgICAgc3RvcmFnZUNvc3QKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgICBkYXRlOiAnJywKICAgICAgICBzdW1SZXF1ZXN0cywKICAgICAgICByZXF1ZXN0c0Nvc3QsCiAgICAgICAgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50LAogICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgd2Vic29ja2V0c0Nvc3QsCiAgICAgICAgc3VtU3VicmVxdWVzdHMsCiAgICAgICAgc3VicmVxdWVzdHNDb3N0LAogICAgICAgIHN1bUFjdGl2ZVRpbWUsCiAgICAgICAgYWN0aXZlR2JTZWNvbmRzLAogICAgICAgIGFjdGl2ZUNvc3QsCiAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICByZWFkVW5pdHNDb3N0LAogICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzLAogICAgICAgIHdyaXRlVW5pdHNDb3N0LAogICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzLAogICAgICAgIGRlbGV0ZXNDb3N0LAogICAgICAgIHN0b3JhZ2VHYiwKICAgICAgICBzdG9yYWdlQ29zdDogbmV3U3RvcmFnZUNvc3QsCiAgICAgICAgdG90YWxDb3N0CiAgICB9Owp9CmZ1bmN0aW9uIHV0Y0N1cnJlbnREYXRlKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMTApOwp9CmZ1bmN0aW9uIGFkZERheXNUb0RhdGUoZGF0ZSwgZGF5cykgewogICAgY29uc3QgZCA9IG5ldyBEYXRlKGAke2RhdGV9VDAwOjAwOjAwWmApOwogICAgcmV0dXJuIG5ldyBEYXRlKGQuZ2V0RnVsbFllYXIoKSwgZC5nZXRNb250aCgpLCBkLmdldERhdGUoKSArIGRheXMsIGQuZ2V0SG91cnMoKSwgZC5nZXRNaW51dGVzKCksIGQuZ2V0U2Vjb25kcygpLCBkLmdldE1pbGxpc2Vjb25kcygpKS50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLCAxMCk7Cn0KY2xhc3MgV2VidGFpbEFwcFZNIHsKICAgIF9wcm9maWxlcyA9IFtdOwogICAgZ2V0IHByb2ZpbGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUucHJvZmlsZXMgOiB0aGlzLl9wcm9maWxlczsKICAgIH0KICAgIGdldCByZWFsUHJvZmlsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2ZpbGVzOwogICAgfQogICAgX3NlbGVjdGVkUHJvZmlsZUlkOwogICAgZ2V0IHNlbGVjdGVkUHJvZmlsZUlkKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUuc2VsZWN0ZWRQcm9maWxlSWQgOiB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZDsKICAgIH0KICAgIHNldCBzZWxlY3RlZFByb2ZpbGVJZCh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSB7CiAgICAgICAgICAgIERlbW9Nb2RlLnNldFNlbGVjdGVkUHJvZmlsZUlkKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPT09IHZhbHVlKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPSB2YWx1ZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCA9IHZhbHVlOwogICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB0aGlzLmZpbmRTY3JpcHRzKCk7CiAgICB9CiAgICBfYW5hbHl0aWNzID0gWwogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdkdXJhYmxlLW9iamVjdHMnLAogICAgICAgICAgICB0ZXh0OiAnRHVyYWJsZSBPYmplY3RzJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdEYWlseSBtZXRyaWNzIGFuZCBhc3NvY2lhdGVkIGNvc3RzJwogICAgICAgIH0KICAgIF07CiAgICBnZXQgYW5hbHl0aWNzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9hbmFseXRpY3M7CiAgICB9CiAgICBfc2VsZWN0ZWRBbmFseXRpY0lkOwogICAgZ2V0IHNlbGVjdGVkQW5hbHl0aWNJZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkOwogICAgfQogICAgYW5hbHl0aWNzU3RhdGUgPSB7CiAgICAgICAgcXVlcnlpbmc6IGZhbHNlCiAgICB9OwogICAgX3NjcmlwdHMgPSBbXTsKICAgIGdldCBzY3JpcHRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUuc2NyaXB0cyA6IHRoaXMuX3NjcmlwdHM7CiAgICB9CiAgICBfc2VsZWN0ZWRTY3JpcHRJZHMgPSBuZXcgU2V0KCk7CiAgICBnZXQgc2VsZWN0ZWRTY3JpcHRJZHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVtb01vZGUgPyBEZW1vTW9kZS5zZWxlY3RlZFNjcmlwdElkcyA6IHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzOwogICAgfQogICAgc2V0IHNlbGVjdGVkU2NyaXB0SWRzKHNjcmlwdElkcykgewogICAgICAgIGlmICh0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHsKICAgICAgICAgICAgRGVtb01vZGUuc2V0U2VsZWN0ZWRTY3JpcHRJZHMoc2NyaXB0SWRzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoc2V0RXF1YWwodGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHMsIHNjcmlwdElkcykpIHJldHVybjsKICAgICAgICB0aGlzLl9zZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoc2NyaXB0SWRzKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICBpZiAocHJvZmlsZSkgewogICAgICAgICAgICBwcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzID0gWwogICAgICAgICAgICAgICAgLi4uc2NyaXB0SWRzCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXRUYWlscygpOwogICAgfQogICAgcHJvZmlsZUZvcm0gPSBuZXcgUHJvZmlsZUZvcm1WTSgpOwogICAgZmlsdGVyRm9ybSA9IG5ldyBGaWx0ZXJGb3JtVk0oKTsKICAgIGZpbHRlciA9IHt9OwogICAgZXh0cmFGaWVsZHMgPSBbXTsKICAgIF90YWlscyA9IG5ldyBTZXQoKTsKICAgIGdldCB0YWlscygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnRhaWxzIDogdGhpcy5fdGFpbHM7CiAgICB9CiAgICBzZXQgdGFpbHModGFpbHMpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgRGVtb01vZGUudGFpbHMgPSB0YWlsczsKICAgICAgICB0aGlzLl90YWlscyA9IHRhaWxzOwogICAgfQogICAgd2VsY29tZVNob3dpbmcgPSBmYWxzZTsKICAgIGFib3V0U2hvd2luZyA9IGZhbHNlOwogICAgc3RhdGUgPSBsb2FkU3RhdGUoKTsKICAgIHRhaWxDb250cm9sbGVyOwogICAgdGFpbENvbnRyb2xsZXJDYWxsYmFja3M7CiAgICBxcHNDb250cm9sbGVyOwogICAgZGVtb01vZGUgPSBmYWxzZTsKICAgIG9uQ2hhbmdlID0gKCk9Pnt9OwogICAgbG9nZ2VyID0gKCk9Pnt9OwogICAgb25SZXNldE91dHB1dCA9ICgpPT57fTsKICAgIG9uUXBzQ2hhbmdlID0gKCk9Pnt9OwogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBjb25zdCBkaXMgPSB0aGlzOwogICAgICAgIHRoaXMucXBzQ29udHJvbGxlciA9IG5ldyBRcHNDb250cm9sbGVyKDIwLCB7CiAgICAgICAgICAgIG9uUXBzQ2hhbmdlZCAocXBzKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgICAgICBkaXMub25RcHNDaGFuZ2UocXBzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGxvZ1RhaWxzQ2hhbmdlID0gKGFjdGlvbiwgdGFpbEtleXMpPT57CiAgICAgICAgICAgIGlmICh0YWlsS2V5cy5zaXplID4gMCkgdGhpcy5sb2dXaXRoUHJlZml4KGAke2FjdGlvbn0gJHtbCiAgICAgICAgICAgICAgICAuLi50YWlsS2V5cwogICAgICAgICAgICBdLm1hcCgodik9PnVucGFja1RhaWxLZXkodikuc2NyaXB0SWQKICAgICAgICAgICAgKS5zb3J0KCkuam9pbignLCAnKX1gKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGxvZ1dpdGhQcmVmaXggPSB0aGlzLmxvZ1dpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCB2ZXJib3NlV2l0aFByZWZpeCA9IHRoaXMudmVyYm9zZVdpdGhQcmVmaXguYmluZCh0aGlzKTsKICAgICAgICBjb25zdCBjYWxsYmFja3MgPSB7CiAgICAgICAgICAgIG9uVGFpbENyZWF0aW5nIChfYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENyZWF0aW5nIHRhaWwgZm9yICR7c2NyaXB0SWR9Li4uYCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENyZWF0ZWQgKF9hY2NvdW50SWQsIHNjcmlwdElkLCB0b29rTWlsbGlzLCB0YWlsKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ3JlYXRlZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXMsICR7SlNPTi5zdHJpbmdpZnkodGFpbCl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25PcGVuIChfYWNjb3VudElkLCBzY3JpcHRJZCwgX3RpbWVTdGFtcCwgdG9va01pbGxpcykgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYE9wZW5lZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXNgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbkNsb3NlIChhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uQ2xvc2UnLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ2xvc2VkIHRhaWwgZm9yICR7c2NyaXB0SWR9LCAke0pTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25FcnJvciAoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uRXJyb3InLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBlcnJvckluZm8KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgRXJyb3IgaW4gdGFpbCBmb3IgJHtzY3JpcHRJZH1gLCB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JJbmZvCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UgKF9hY2NvdW50SWQsIF9zY3JpcHRJZCwgX3RpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgaWYgKGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UsIGRpcy5maWx0ZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZSwgZGlzLmxvZ2dlciwgZGlzLmNvbXB1dGVBZGRpdGlvbmFsTG9ncyhtZXNzYWdlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgICAgICBkaXMucXBzQ29udHJvbGxlci5hZGRFdmVudChtZXNzYWdlLmV2ZW50VGltZXN0YW1wKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZSAoX2FjY291bnRJZCwgc2NyaXB0SWQsIF90aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgVW5wYXJzZWQgbWVzc2FnZSBpbiB0YWlsIGZvciAke3NjcmlwdElkfWAsIHBhcnNlRXJyb3Iuc3RhY2sgfHwgcGFyc2VFcnJvci5tZXNzYWdlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsc0NoYW5nZWQgKHRhaWxzKSB7CiAgICAgICAgICAgICAgICBpZiAoc2V0RXF1YWwoZGlzLnRhaWxzLCB0YWlscykpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92ZWQgPSBzZXRTdWJ0cmFjdChkaXMudGFpbHMsIHRhaWxzKTsKICAgICAgICAgICAgICAgIGxvZ1RhaWxzQ2hhbmdlKCdVbnRhaWxpbmcnLCByZW1vdmVkKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFkZGVkID0gc2V0U3VidHJhY3QodGFpbHMsIGRpcy50YWlscyk7CiAgICAgICAgICAgICAgICBsb2dUYWlsc0NoYW5nZSgnVGFpbGluZycsIGFkZGVkKTsKICAgICAgICAgICAgICAgIGRpcy50YWlscyA9IHRhaWxzOwogICAgICAgICAgICAgICAgZGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTmV0d29ya1N0YXR1c0NoYW5nZWQgKG9ubGluZSkgewogICAgICAgICAgICAgICAgaWYgKG9ubGluZSkgewogICAgICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoJyVjT05MSU5FJWMnLCAnY29sb3I6IGdyZWVuJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxvZ1dpdGhQcmVmaXgoJyVjT0ZGTElORSVjJywgJ2NvbG9yOiByZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsRmFpbGVkVG9TdGFydCAoX2FjY291bnRJZCwgc2NyaXB0SWQsIHRyaWdnZXIsIGVycm9yKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgVGFpbCBmb3IgJHtzY3JpcHRJZH0gZmFpbGVkIHRvIHN0YXJ0ICgke3RyaWdnZXJ9KTogJHtlcnJvci5uYW1lfSAke2Vycm9yLm1lc3NhZ2V9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgPSBBcHBDb25zdGFudHMuV0VCU09DS0VUX1BJTkdfSU5URVJWQUxfU0VDT05EUzsKICAgICAgICBjb25zdCBpbmFjdGl2ZVRhaWxTZWNvbmRzID0gQXBwQ29uc3RhbnRzLklOQUNUSVZFX1RBSUxfU0VDT05EUzsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyID0gbmV3IFRhaWxDb250cm9sbGVyKG5ldyBTd2l0Y2hhYmxlVGFpbENvbnRyb2xsZXJDYWxsYmFja3MoY2FsbGJhY2tzLCAoKT0+IXRoaXMuZGVtb01vZGUKICAgICAgICApLCB7CiAgICAgICAgICAgIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMsCiAgICAgICAgICAgIGluYWN0aXZlVGFpbFNlY29uZHMKICAgICAgICB9KTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMuZXh0cmFGaWVsZHMgPSBbCiAgICAgICAgICAgIC4uLnRoaXMuc3RhdGUuZXh0cmFGaWVsZHMgfHwgW10KICAgICAgICBdOwogICAgICAgIHRoaXMuZmlsdGVyID0gdGhpcy5zdGF0ZS5maWx0ZXIgfHwge307CiAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgIHNhdmU6IGZhbHNlCiAgICAgICAgfSk7CiAgICB9CiAgICBzdGFydCgpIHsKICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgdGhpcy5yZWNvbXB1dGVXZWxjb21lU2hvd2luZygpOwogICAgICAgIHRoaXMucGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKTsKICAgIH0KICAgIG5ld1Byb2ZpbGUoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMud2VsY29tZVNob3dpbmcpIHt9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ucHJvZmlsZUlkID0gZ2VuZXJhdGVVdWlkKCk7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnRpdGxlID0gJ05ldyBQcm9maWxlJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSB0aGlzLl9wcm9maWxlcy5sZW5ndGggPT09IDAgPyAnZGVmYXVsdCcgOiBgcHJvZmlsZSR7dGhpcy5fcHJvZmlsZXMubGVuZ3RoICsgMX1gOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hcGlUb2tlbiA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA9IGZhbHNlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0UHJvZmlsZShwcm9maWxlSWQpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgaWYgKCFwcm9maWxlKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgJHtwcm9maWxlSWR9IG5vdCBmb3VuZGApOwogICAgICAgIHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgIGNvbnN0IHsgbmFtZSAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0udGl0bGUgPSAnRWRpdCBQcm9maWxlJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gYWNjb3VudElkOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSBhcGlUb2tlbjsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBkZWxldGVQcm9maWxlKHByb2ZpbGVJZCkgewogICAgICAgIGNvbnNvbGUubG9nKCdkZWxldGUgcHJvZmlsZScsIHByb2ZpbGVJZCk7CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBpZiAoIXByb2ZpbGUpIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSAke3Byb2ZpbGVJZH0gbm90IGZvdW5kYCk7CiAgICAgICAgZGVsZXRlIHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgIHRoaXMucmVjb21wdXRlV2VsY29tZVNob3dpbmcoKTsKICAgICAgICB0aGlzLnBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCk7CiAgICB9CiAgICBjYW5jZWxQcm9maWxlKCkgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVOYW1lKG5hbWUpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2V0UHJvZmlsZUFjY291bnRJZChhY2NvdW50SWQpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9IGFjY291bnRJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVBcGlUb2tlbihhcGlUb2tlbikgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSBhcGlUb2tlbjsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNhdmVQcm9maWxlKCkgewogICAgICAgIGNvbnN0IHsgcHJvZmlsZUZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHsgcHJvZmlsZUlkICB9ID0gcHJvZmlsZUZvcm07CiAgICAgICAgY29uc3QgbmV3UHJvZmlsZSA9IHsKICAgICAgICAgICAgbmFtZTogcHJvZmlsZUZvcm0ubmFtZS50cmltKCksCiAgICAgICAgICAgIGFjY291bnRJZDogcHJvZmlsZUZvcm0uYWNjb3VudElkLnRyaW0oKSwKICAgICAgICAgICAgYXBpVG9rZW46IHByb2ZpbGVGb3JtLmFwaVRva2VuLnRyaW0oKQogICAgICAgIH07CiAgICAgICAgdGhpcy50cnlTYXZlUHJvZmlsZShwcm9maWxlSWQsIG5ld1Byb2ZpbGUpOwogICAgfQogICAgZWRpdEV2ZW50RmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnRXZlbnQgdHlwZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnY3JvbicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQ1JPTiB0cmlnZ2VyJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2h0dHAnLAogICAgICAgICAgICAgICAgdGV4dDogJ0hUVFAgcmVxdWVzdCcKICAgICAgICAgICAgfSwgCiAgICAgICAgXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnID8gJ2h0dHAnIDogZmlsdGVyLmV2ZW50MSA9PT0gJ2Nyb24nID8gJ2Nyb24nIDogJ2FsbCc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdDaG9vc2Ugd2hpY2ggdHlwZXMgb2YgZXZlbnRzIHRvIHNob3cnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuZXZlbnQxID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmV2ZW50MSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZENob2ljZVRleHQgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmZpbmQoKHYpPT52LmlkID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUKICAgICAgICAgICAgKS50ZXh0OwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYEV2ZW50IHR5cGUgZmlsdGVyIGNoYW5nZWQgdG86ICR7c2VsZWN0ZWRDaG9pY2VUZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFN0YXR1c0ZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1N0YXR1czonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnc3VjY2VzcycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnU3VjY2VzcycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICdlcnJvcicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnRXJyb3InCiAgICAgICAgICAgIH0sIAogICAgICAgIF07CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpbHRlci5zdGF0dXMxID09PSAnc3VjY2VzcycgPyAnc3VjY2VzcycgOiBmaWx0ZXIuc3RhdHVzMSA9PT0gJ2Vycm9yJyA/ICdlcnJvcicgOiAnYWxsJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ1Nob3cgZXZlbnRzIHRoaXMgdGhpcyBzdGF0dXMnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5zdGF0dXMxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQ2hvaWNlVGV4dCA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMuZmluZCgodik9PnYuaWQgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZQogICAgICAgICAgICApLnRleHQ7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU3RhdHVzIGZpbHRlciBjaGFuZ2VkIHRvOiAke3NlbGVjdGVkQ2hvaWNlVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRJcEFkZHJlc3NGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGlzVmFsaWRJcEFkZHJlc3MgPSAoaXBBZGRyZXNzKT0+ewogICAgICAgICAgICByZXR1cm4gL14oc2VsZnxbXGRcLjphLWZdezMsfSkkLy50ZXN0KGlwQWRkcmVzcyk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjaGVja1ZhbGlkSXBBZGRyZXNzID0gKGlwQWRkcmVzcyk9PnsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkSXBBZGRyZXNzKGlwQWRkcmVzcykpIHRocm93IG5ldyBFcnJvcihgQmFkIGlwIGFkZHJlc3M6ICR7aXBBZGRyZXNzfWApOwogICAgICAgICAgICByZXR1cm4gaXBBZGRyZXNzOwogICAgICAgIH07CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJJcEFkZHJlc3Nlc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdjEgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodjEgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2MS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApLm1hcChjaGVja1ZhbGlkSXBBZGRyZXNzKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJJcEFkZHJlc3NlcyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIuaXBBZGRyZXNzMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdJUCBhZGRyZXNzKHMpOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJJcEFkZHJlc3NlcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ3NlbGYnIHRvIGZpbHRlciB5b3VyIG93biBhZGRyZXNzLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGUsIGUuZy4gc2VsZiwgMS4xLjEuMWA7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlcklwQWRkcmVzc2VzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLmlwQWRkcmVzczEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmlwQWRkcmVzczEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ2FueSBJUCBhZGRyZXNzJyA6IG5ld1ZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgSVAgYWRkcmVzcyBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdE1ldGhvZEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJNZXRob2RzRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2MiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2MiA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHYyLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkudG9VcHBlckNhc2UoKQogICAgICAgICAgICApLmZpbHRlcigodik9PnYgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIubWV0aG9kMSB8fCBbXSkubWFwKCh2KT0+di50b1VwcGVyQ2FzZSgpCiAgICAgICAgICAgICkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdIVFRQIE1ldGhvZChzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCBlLmcuIEdFVCwgUE9TVCc7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlck1ldGhvZHNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIubWV0aG9kMSB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWUpKSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIubWV0aG9kMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZS5sZW5ndGggPT09IDAgPyAnYW55IG1ldGhvZCcgOiBuZXdWYWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYE1ldGhvZCBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNhbXBsaW5nUmF0ZUZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHBhcnNlU2FtcGxlUmF0ZUZyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIDE7CiAgICAgICAgICAgIGNvbnN0IG51bSA9IHBhcnNlRmxvYXQodik7CiAgICAgICAgICAgIGlmICghaXNWYWxpZFNhbXBsaW5nUmF0ZShudW0pKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcmF0ZTogJHt2fWApOwogICAgICAgICAgICByZXR1cm4gbnVtOwogICAgICAgIH07CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnU2FtcGxpbmcgcmF0ZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gKHR5cGVvZiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gJ251bWJlcicgJiYgaXNWYWxpZFNhbXBsaW5nUmF0ZShmaWx0ZXIuc2FtcGxpbmdSYXRlMSkgPyBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA6IDEpLnRvRml4ZWQoMik7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdDYW4gcmFuZ2UgZnJvbSAwICgwJSkgdG8gMSAoMTAwJSknOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VTYW1wbGVSYXRlRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKGZpbHRlci5zYW1wbGluZ1JhdGUxID09PSBuZXdWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZSA9PT0gMSA/ICdubyBzYW1wbGluZycgOiBgJHtuZXdWYWx1ZX0gKCR7KG5ld1ZhbHVlICogMTAwKS50b0ZpeGVkKDIpfSUpYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTYW1wbGUgcmF0ZSBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNlYXJjaEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1NlYXJjaCB0ZXh0Oic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuc2VhcmNoMSB8fCAnJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ0ZpbHRlciBieSBhIHRleHQgbWF0Y2ggaW4gY29uc29sZS5sb2cgbWVzc2FnZXMnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc2VhcmNoMSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5zZWFyY2gxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSAoZmlsdGVyLnNlYXJjaDEgfHwgJycpLmxlbmd0aCA9PT0gMCA/ICdubyBzZWFyY2ggZmlsdGVyJyA6IGAnJHtmaWx0ZXIuc2VhcmNoMX0nYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTZWFyY2ggZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRIZWFkZXJGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVySGVhZGVyc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdjMgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodjMgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2My5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJIZWFkZXJzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5oZWFkZXIxIHx8IFtdKS5qb2luKCcsICcpOwogICAgICAgIH07CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0hlYWRlcihzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySGVhZGVycygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ2tleScsIG9yICdrZXk6cXVlcnknLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGVgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJIZWFkZXJzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLmhlYWRlcjEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmhlYWRlcjEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ25vIGhlYWRlciBmaWx0ZXInIDogbmV3VmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBIZWFkZXIgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRMb2dwcm9wRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBwYXJzZUxvZ3Byb3BGaWx0ZXJzRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2NCA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2NCA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHY0LnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUxvZ1Byb3BGaWx0ZXJzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5sb2dwcm9wMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdMb2dwcm9wKHMpOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21Mb2dQcm9wRmlsdGVycygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ2tleScsIG9yICdrZXk6dmFsdWUnLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGUsIHZhbHVlIG1heSBpbmNsdWRlICpgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VMb2dwcm9wRmlsdGVyc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMuc2V0TG9ncHJvcEZpbHRlcihuZXdWYWx1ZSk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRMb2dwcm9wRmlsdGVyKGxvZ3Byb3BGaWx0ZXJzKSB7CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgIH0gPSB0aGlzOwogICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5sb2dwcm9wMSB8fCBbXSksIG5ldyBTZXQobG9ncHJvcEZpbHRlcnMpKSkgcmV0dXJuOwogICAgICAgIGZpbHRlci5sb2dwcm9wMSA9IGxvZ3Byb3BGaWx0ZXJzOwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgdGV4dCA9IGxvZ3Byb3BGaWx0ZXJzLmxlbmd0aCA9PT0gMCA/ICdubyBsb2dwcm9wIGZpbHRlcicgOiBsb2dwcm9wRmlsdGVycy5qb2luKCcsICcpOwogICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgTG9ncHJvcCBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgfQogICAgaGFzQW55RmlsdGVycygpIHsKICAgICAgICBjb25zdCB7IGZpbHRlciAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgeyBldmVudDEgIH0gPSBmaWx0ZXI7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpLmZpbHRlcnMubGVuZ3RoID4gMCB8fCB0eXBlb2YgZXZlbnQxID09PSAnc3RyaW5nJyAmJiBldmVudDEgIT09ICcnICYmIGV2ZW50MSAhPT0gJ2FsbCc7CiAgICB9CiAgICByZXNldEZpbHRlcnMoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlciA9IHt9OwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBGaWx0ZXJzIHJlc2V0YCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgY2FuY2VsRmlsdGVyKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdjYW5jZWxGaWx0ZXInKTsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNhdmVGaWx0ZXIoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ3NhdmVGaWx0ZXInKTsKICAgICAgICBjb25zdCB7IGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9ICdDaGVja2luZyBmaWx0ZXIuLi4nOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUoKTsKICAgICAgICAgICAgZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlID0gYGA7CiAgICAgICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlID0gYEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIHNlbGVjdEZpbHRlckNob2ljZShpZCkgewogICAgICAgIGlmICh0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9PT0gaWQpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGlkOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTZWxlY3Rpb25GaWVsZHMoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdBZGRpdGlvbmFsIGZpZWxkczonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gRVhUUkFfRklFTERTX09QVElPTlM7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gKHRoaXMuZXh0cmFGaWVsZHMgfHwgW10pLmpvaW4oJywnKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ1NlbGVjdCBhZGRpdGlvbmFsIGZpZWxkcyB0byBzaG93IGluIHRoZSBvdXRwdXQnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlcyA9IGRpc3RpbmN0KChmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgfHwgJycpLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQodGhpcy5leHRyYUZpZWxkcyB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWVzKSkpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5leHRyYUZpZWxkcyA9IG5ld1ZhbHVlczsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBleHRyYUZpZWxkc1RleHQgPSB0aGlzLmNvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KCk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgT3V0cHV0IGZpZWxkcyBjaGFuZ2VkIHRvOiAke2V4dHJhRmllbGRzVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGNvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KCkgewogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICdzdGFuZGFyZCBmaWVsZHMnLAogICAgICAgICAgICAuLi50aGlzLmV4dHJhRmllbGRzLm1hcCgoaWQpPT5FWFRSQV9GSUVMRFNfT1BUSU9OUy5maW5kKCh2KT0+di5pZCA9PT0gaWQKICAgICAgICAgICAgICAgICk/LnRleHQgfHwgaWQKICAgICAgICAgICAgKQogICAgICAgIF0uam9pbignLCAnKTsKICAgIH0KICAgIHRvZ2dsZUZpbHRlck9wdGlvbihpZCkgewogICAgICAgIGNvbnN0IGV4dHJhRmllbGRzID0gZGlzdGluY3QoKHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICkpOwogICAgICAgIGNvbnN0IGkgPSBleHRyYUZpZWxkcy5pbmRleE9mKGlkKTsKICAgICAgICBpZiAoaSA+PSAwKSB7CiAgICAgICAgICAgIGV4dHJhRmllbGRzLnNwbGljZShpLCAxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHRyYUZpZWxkcy5wdXNoKGlkKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZmllbGRWYWx1ZSA9IGV4dHJhRmllbGRzLmpvaW4oJywnKTsKICAgICAgICBpZiAodGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPT09IGZpZWxkVmFsdWUpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpZWxkVmFsdWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgdGhpcy5zZXREZW1vTW9kZSghdGhpcy5kZW1vTW9kZSk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgcmVzZXRPdXRwdXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgIH0KICAgIHNob3dBYm91dCgpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIHRoaXMuYWJvdXRTaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBjbG9zZUFib3V0KCkgewogICAgICAgIHRoaXMuYWJvdXRTaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2hvd0FuYWx5dGljKGFuYWx5dGljSWQpIHsKICAgICAgICBjb25zdCBhbmFseXRpYyA9IHRoaXMuYW5hbHl0aWNzLmZpbmQoKHYpPT52LmlkID09PSBhbmFseXRpY0lkCiAgICAgICAgKTsKICAgICAgICBpZiAoIWFuYWx5dGljIHx8IGFuYWx5dGljLmlkID09PSB0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQpIHJldHVybjsKICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgaWYgKHByb2ZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgIHRoaXMuX3NlbGVjdGVkQW5hbHl0aWNJZCA9IGFuYWx5dGljSWQ7CiAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5xdWVyeWluZyA9IHRydWU7CiAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5kdXJhYmxlT2JqZWN0c0Nvc3RzID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuYW5hbHl0aWNzU3RhdGUuZXJyb3IgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBDZkdxbENsaWVudCh7CiAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgYXBpVG9rZW4KICAgICAgICB9KTsKICAgICAgICB0aGlzLnF1ZXJ5RHVyYWJsZU9iamVjdHNDb3N0cyhjbGllbnQpOwogICAgfQogICAgc2V0RGVtb01vZGUoZGVtb01vZGUpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSA9PT0gZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmRlbW9Nb2RlID0gZGVtb01vZGU7CiAgICAgICAgaWYgKGRlbW9Nb2RlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFbmFibGUgZGVtbyBtb2RlJyk7CiAgICAgICAgICAgIHRoaXMub25RcHNDaGFuZ2UoMTIuMzQpOwogICAgICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgICAgICAgICAgRGVtb01vZGUubG9nRmFrZU91dHB1dCh0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRGlzYWJsZSBkZW1vIG1vZGUnKTsKICAgICAgICAgICAgdGhpcy5vblFwc0NoYW5nZSh0aGlzLnFwc0NvbnRyb2xsZXIucXBzKTsKICAgICAgICAgICAgdGhpcy5vblJlc2V0T3V0cHV0KCk7CiAgICAgICAgfQogICAgfQogICAgYXBwbHlGaWx0ZXIob3B0cykgewogICAgICAgIGNvbnN0IHsgc2F2ZSAgfSA9IG9wdHM7CiAgICAgICAgdGhpcy5zdGF0ZS5maWx0ZXIgPSB0aGlzLmZpbHRlcjsKICAgICAgICB0aGlzLnN0YXRlLmV4dHJhRmllbGRzID0gdGhpcy5leHRyYUZpZWxkczsKICAgICAgICBpZiAoc2F2ZSkgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIGNvbnN0IHRhaWxPcHRpb25zID0gY29tcHV0ZVRhaWxPcHRpb25zRm9yRmlsdGVyKHRoaXMuZmlsdGVyKTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyLnNldFRhaWxPcHRpb25zKHRhaWxPcHRpb25zKTsKICAgIH0KICAgIGxvZ1dpdGhQcmVmaXgoLi4uZGF0YTUpIHsKICAgICAgICBjb25zdCB0aW1lID0gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhuZXcgRGF0ZSgpKTsKICAgICAgICBpZiAoZGF0YTUubGVuZ3RoID4gMCAmJiB0eXBlb2YgZGF0YTVbMF0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGRhdGE1ID0gWwogICAgICAgICAgICAgICAgYFslYyR7dGltZX0lY10gJHtkYXRhNVswXX1gLAogICAgICAgICAgICAgICAgJ2NvbG9yOiBncmF5JywKICAgICAgICAgICAgICAgICcnLAogICAgICAgICAgICAgICAgLi4uZGF0YTUuc2xpY2UoMSkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sb2dnZXIoLi4uZGF0YTUpOwogICAgfQogICAgdmVyYm9zZVdpdGhQcmVmaXgobWVzc2FnZSkgewogICAgICAgIGNvbnN0IHRpbWUgPSBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpOwogICAgICAgIHRoaXMubG9nZ2VyKGBbJWMke3RpbWV9JWNdICVjJHttZXNzYWdlfSVjYCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScpOwogICAgfQogICAgcGVyZm9ybUluaXRpYWxTZWxlY3Rpb24oKSB7CiAgICAgICAgY29uc3QgaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQgPSBjb21wdXRlSW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWQodGhpcy5zdGF0ZSwgdGhpcy5fcHJvZmlsZXMpOwogICAgICAgIGlmIChpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBwcm9maWxlOiAke3RoaXMuc3RhdGUucHJvZmlsZXNbaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWRdLm5hbWV9YCk7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPSBpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgdHJ5U2F2ZVByb2ZpbGUocHJvZmlsZUlkLCBwcm9maWxlKSB7CiAgICAgICAgY29uc3QgeyBwcm9maWxlRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgcHJvZmlsZUZvcm0uZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA9IHRydWU7CiAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICdDaGVja2luZyBwcm9maWxlLi4uJzsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgY2FuTGlzdFRhaWxzID0gYXdhaXQgY29tcHV0ZUNhbkxpc3RUYWlscyhwcm9maWxlLmFjY291bnRJZCwgcHJvZmlsZS5hcGlUb2tlbik7CiAgICAgICAgICAgIGlmIChjYW5MaXN0VGFpbHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXSA9IHByb2ZpbGU7CiAgICAgICAgICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCk7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9IGBUaGVzZSBjcmVkZW50aWFscyBkbyBub3QgaGF2ZSBwZXJtaXNzaW9uIHRvIHRhaWxgOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gYEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgcHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgcmVsb2FkUHJvZmlsZXMoKSB7CiAgICAgICAgY29uc3QgeyBzdGF0ZSAgfSA9IHRoaXM7CiAgICAgICAgdGhpcy5fcHJvZmlsZXMuc3BsaWNlKDApOwogICAgICAgIGZvciAoY29uc3QgW3Byb2ZpbGVJZCwgcHJvZmlsZV0gb2YgT2JqZWN0LmVudHJpZXMoc3RhdGUucHJvZmlsZXMpKXsKICAgICAgICAgICAgY29uc3QgbmFtZSA9IHByb2ZpbGUubmFtZSB8fCAnKHVubmFtZWQpJzsKICAgICAgICAgICAgdGhpcy5fcHJvZmlsZXMucHVzaCh7CiAgICAgICAgICAgICAgICBpZDogcHJvZmlsZUlkLAogICAgICAgICAgICAgICAgdGV4dDogbmFtZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyBmaW5kU2NyaXB0cygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgICAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgICAgICB0aGlzLnZlcmJvc2VXaXRoUHJlZml4KGBGaW5kaW5nIHNjcmlwdHMgZm9yICR7cHJvZmlsZS5uYW1lLnRvVXBwZXJDYXNlKCl9Li4uYCk7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgY29uc3Qgc2NyaXB0cyA9IGF3YWl0IGxpc3RTY3JpcHRzKGFjY291bnRJZCwgYXBpVG9rZW4pOwogICAgICAgICAgICBpZiAoIXRoaXMuZGVtb01vZGUpIHRoaXMudmVyYm9zZVdpdGhQcmVmaXgoYEZvdW5kICR7c2NyaXB0cy5sZW5ndGh9IHNjcmlwdHMgaW4gJHtEYXRlLm5vdygpIC0gc3RhcnR9bXNgKTsKICAgICAgICAgICAgdGhpcy5fc2NyaXB0cy5zcGxpY2UoMCk7CiAgICAgICAgICAgIGZvciAoY29uc3Qgc2NyaXB0IG9mIHNjcmlwdHMpewogICAgICAgICAgICAgICAgdGhpcy5fc2NyaXB0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogc2NyaXB0LmlkLAogICAgICAgICAgICAgICAgICAgIHRleHQ6IHNjcmlwdC5pZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fc2NyaXB0cy5zb3J0KChsaHMsIHJocyk9Pmxocy50ZXh0LmxvY2FsZUNvbXBhcmUocmhzLnRleHQpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkU2NyaXB0SWRzID0gdGhpcy5jb21wdXRlU2VsZWN0ZWRTY3JpcHRJZHNBZnRlckZpbmRTY3JpcHRzKCk7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZFNjcmlwdElkcy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFNjcmlwdElkcyA9IHNlbGVjdGVkU2NyaXB0SWRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGhpcy5kZW1vTW9kZSkgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlbW9Nb2RlKSB0aGlzLmxvZ2dlcihgRXJyb3IgaW4gZmluZFNjcmlwdHM6ICR7ZS5zdGFja31gKTsKICAgICAgICB9CiAgICB9CiAgICBjb21wdXRlU2VsZWN0ZWRTY3JpcHRJZHNBZnRlckZpbmRTY3JpcHRzKCkgewogICAgICAgIGlmICh0aGlzLl9zY3JpcHRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnSW5pdGlhbGx5IHNlbGVjdGluZyBubyBzY3JpcHRzLCBubyBzY3JpcHRzIHRvIHNlbGVjdCcpOwogICAgICAgICAgICByZXR1cm4gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkICYmIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWQpIHsKICAgICAgICAgICAgY29uc3QgaW5pdGlhbFByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgICAgICBpZiAoaW5pdGlhbFByb2ZpbGUgJiYgaW5pdGlhbFByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMgJiYgaW5pdGlhbFByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjcmlwdElkcyA9IG5ldyBTZXQodGhpcy5fc2NyaXB0cy5tYXAoKHYpPT52LmlkCiAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBzZXRJbnRlcnNlY3QoY3VycmVudFNjcmlwdElkcywgbmV3IFNldChpbml0aWFsUHJvZmlsZS5zZWxlY3RlZFNjcmlwdElkcykpOwogICAgICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBzY3JpcHQke2NhbmRpZGF0ZXMuc2l6ZSA9PT0gMSA/ICcnIDogJ3MnfSAke1sKICAgICAgICAgICAgICAgICAgICAgICAgLi4uY2FuZGlkYXRlcwogICAgICAgICAgICAgICAgICAgIF0uc29ydCgpLmpvaW4oJywgJyl9OiByZW1lbWJlcmVkIGZyb20gbGFzdCB0aW1lYCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZmlyc3RTY3JpcHRJZCA9IHRoaXMuX3NjcmlwdHNbMF0uaWQ7CiAgICAgICAgY29uc29sZS5sb2coYEluaXRpYWxseSBzZWxlY3Rpbmcgc2NyaXB0ICR7Zmlyc3RTY3JpcHRJZH06IGZpcnN0IG9uZSBpbiB0aGUgbGlzdGApOwogICAgICAgIHJldHVybiBuZXcgU2V0KFsKICAgICAgICAgICAgdGhpcy5fc2NyaXB0c1swXS5pZAogICAgICAgIF0pOwogICAgfQogICAgYXN5bmMgc2V0VGFpbHMoKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgIGlmIChwcm9maWxlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLnRhaWxDb250cm9sbGVyLnNldFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4sIHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHRoaXMubG9nZ2VyKCdFcnJvciBpbiBzZXRUYWlscycsIGUuc3RhY2sgfHwgZS5tZXNzYWdlKTsKICAgICAgICB9CiAgICB9CiAgICBjb21wdXRlQWRkaXRpb25hbExvZ3MobWVzc2FnZSkgewogICAgICAgIGNvbnN0IHJ0ID0gW107CiAgICAgICAgY29uc3QgaW5jbHVkZUlwQWRkcmVzcyA9IHRoaXMuZXh0cmFGaWVsZHMuaW5jbHVkZXMoJ2lwLWFkZHJlc3MnKTsKICAgICAgICBjb25zdCBpbmNsdWRlVXNlckFnZW50ID0gdGhpcy5leHRyYUZpZWxkcy5pbmNsdWRlcygndXNlci1hZ2VudCcpOwogICAgICAgIGNvbnN0IGluY2x1ZGVSZWZlcmVyID0gdGhpcy5leHRyYUZpZWxkcy5pbmNsdWRlcygncmVmZXJlcicpOwogICAgICAgIGlmIChpbmNsdWRlSXBBZGRyZXNzIHx8IGluY2x1ZGVVc2VyQWdlbnQgfHwgaW5jbHVkZVJlZmVyZXIpIHsKICAgICAgICAgICAgaWYgKCFpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UuZXZlbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZUlwQWRkcmVzcykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlwQWRkcmVzcyA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdC5oZWFkZXJzWydjZi1jb25uZWN0aW5nLWlwJ10gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGlmIChpcEFkZHJlc3MpIHJ0LnB1c2goY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKCdJUCBhZGRyZXNzJywgaXBBZGRyZXNzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZVVzZXJBZ2VudCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJBZ2VudCA9IG1lc3NhZ2UuZXZlbnQucmVxdWVzdC5oZWFkZXJzWyd1c2VyLWFnZW50J10gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGlmICh1c2VyQWdlbnQpIHJ0LnB1c2goY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKCdVc2VyIGFnZW50JywgdXNlckFnZW50KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZVJlZmVyZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZWZlcmVyID0gbWVzc2FnZS5ldmVudC5yZXF1ZXN0LmhlYWRlcnNbJ3JlZmVyZXInXSB8fCB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlZmVyZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlclVybCA9IHRyeVBhcnNlVXJsKHJlZmVyZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbG9nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlZmVyZXJVcmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdFVybCA9IHRyeVBhcnNlVXJsKG1lc3NhZ2UuZXZlbnQucmVxdWVzdC51cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcXVlc3RVcmwgJiYgcmVxdWVzdFVybC5vcmlnaW4gPT09IHJlZmVyZXJVcmwub3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvZykgcnQucHVzaChjb21wdXRlQWRkaXRpb25hbExvZ0ZvckV4dHJhRmllbGQoJ1JlZmVyZXInLCByZWZlcmVyKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBydDsKICAgIH0KICAgIHJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCkgewogICAgICAgIGNvbnN0IHNob3VsZFNob3cgPSB0aGlzLnByb2ZpbGVzLmxlbmd0aCA9PT0gMDsKICAgICAgICBpZiAoc2hvdWxkU2hvdyA9PT0gdGhpcy53ZWxjb21lU2hvd2luZykgcmV0dXJuOwogICAgICAgIHRoaXMuc2V0RGVtb01vZGUoc2hvdWxkU2hvdyk7CiAgICAgICAgdGhpcy53ZWxjb21lU2hvd2luZyA9IHNob3VsZFNob3c7CiAgICB9CiAgICBhc3luYyBxdWVyeUR1cmFibGVPYmplY3RzQ29zdHMoY2xpZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5kdXJhYmxlT2JqZWN0c0Nvc3RzID0gYXdhaXQgY29tcHV0ZUR1cmFibGVPYmplY3RzQ29zdHNUYWJsZShjbGllbnQsIHsKICAgICAgICAgICAgICAgIGxvb2tiYWNrRGF5czogMjgKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICh0aGlzLmFuYWx5dGljc1N0YXRlLmR1cmFibGVPYmplY3RzQ29zdHMuYWNjb3VudFRhYmxlLnJvd3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLmR1cmFibGVPYmplY3RzQ29zdHMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGR1cmFibGUgb2JqZWN0IGFuYWx5dGljcyBmb3VuZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oZSk7CiAgICAgICAgICAgIGxldCBlcnJvciA9IGAke2V9YDsKICAgICAgICAgICAgaWYgKGVycm9yLmluY2x1ZGVzKCcoY29kZT1hdXRoeiknKSkgewogICAgICAgICAgICAgICAgZXJyb3IgPSBgVGhlIGF1dGggdG9rZW4gZm9yIHRoaXMgcHJvZmlsZSBkb2VzIG5vdCBoYXZlIHRoZSBBY2NvdW50IEFuYWx5dGljczpSZWFkIHBlcm1pc3Npb24uYDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLmVycm9yID0gZXJyb3I7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLnF1ZXJ5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gewogICAgICAgIGRhdGE6IFsKICAgICAgICAgICAgYCAlY3wlYyBbJWMke25hbWV9JWNdICR7dmFsdWV9YCwKICAgICAgICAgICAgJ2NvbG9yOmdyYXknLAogICAgICAgICAgICAnJywKICAgICAgICAgICAgJ2NvbG9yOmdyYXknCiAgICAgICAgXQogICAgfTsKfQpjbGFzcyBQcm9maWxlRm9ybVZNIHsKICAgIHNob3dpbmcgPSBmYWxzZTsKICAgIGVuYWJsZWQgPSBmYWxzZTsKICAgIG5hbWUgPSAnJzsKICAgIGFjY291bnRJZCA9ICcnOwogICAgYXBpVG9rZW4gPSAnJzsKICAgIGRlbGV0ZVZpc2libGUgPSBmYWxzZTsKICAgIHNhdmVFbmFibGVkID0gZmFsc2U7CiAgICBwcm9maWxlSWQgPSAnJzsKICAgIHRpdGxlID0gJyc7CiAgICBwcm9ncmVzc1Zpc2libGUgPSBmYWxzZTsKICAgIG91dHB1dE1lc3NhZ2UgPSAnJzsKICAgIGNvbXB1dGVTYXZlRW5hYmxlZCgpIHsKICAgICAgICB0aGlzLnNhdmVFbmFibGVkID0gdGhpcy5uYW1lLnRyaW0oKS5sZW5ndGggPiAwICYmIHRoaXMuYXBpVG9rZW4udHJpbSgpLmxlbmd0aCA+IDAgJiYgdGhpcy5hY2NvdW50SWQudHJpbSgpLmxlbmd0aCA+IDA7CiAgICB9Cn0KY2xhc3MgRmlsdGVyRm9ybVZNIHsKICAgIHNob3dpbmcgPSBmYWxzZTsKICAgIGVuYWJsZWQgPSBmYWxzZTsKICAgIGZpZWxkTmFtZSA9ICcnOwogICAgZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgIGZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICBmaWVsZFZhbHVlOwogICAgaGVscFRleHQgPSAnJzsKICAgIG91dHB1dE1lc3NhZ2UgPSAnJzsKICAgIGFwcGx5VmFsdWUgPSAoKT0+e307Cn0KY29uc3QgRVhUUkFfRklFTERTX09QVElPTlMgPSBbCiAgICB7CiAgICAgICAgaWQ6ICdpcC1hZGRyZXNzJywKICAgICAgICB0ZXh0OiAnSVAgYWRkcmVzcycKICAgIH0sCiAgICB7CiAgICAgICAgaWQ6ICd1c2VyLWFnZW50JywKICAgICAgICB0ZXh0OiAnVXNlciBhZ2VudCcKICAgIH0sCiAgICB7CiAgICAgICAgaWQ6ICdyZWZlcmVyJywKICAgICAgICB0ZXh0OiAnUmVmZXJlcicKICAgIH0sIApdOwpjb25zdCBTVEFURV9LRVkgPSAnc3RhdGUxJzsKZnVuY3Rpb24gbG9hZFN0YXRlKCkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBqc29uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RBVEVfS0VZKSB8fCB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGpzb24pIHsKICAgICAgICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZShqc29uKTsKICAgICAgICAgICAgY29uc3QgcnQgPSBwYXJzZVN0YXRlKG9iaik7CiAgICAgICAgICAgIHJldHVybiBydDsKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdsb2FkU3RhdGU6IEVycm9yIGxvYWRpbmcgc3RhdGUnLCBlLnN0YWNrIHx8IGUpOwogICAgfQogICAgY29uc29sZS5sb2coJ2xvYWRTdGF0ZTogcmV0dXJuaW5nIG5ldyBzdGF0ZScpOwogICAgcmV0dXJuIHsKICAgICAgICBwcm9maWxlczoge30KICAgIH07Cn0KZnVuY3Rpb24gcGFyc2VTdGF0ZShwYXJzZWQpIHsKICAgIGlmICh0eXBlb2YgcGFyc2VkICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBvYmplY3RgKTsKICAgIGNvbnN0IHsgcHJvZmlsZXMgIH0gPSBwYXJzZWQ7CiAgICBpZiAodHlwZW9mIHByb2ZpbGVzICE9PSAnb2JqZWN0JykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwcm9maWxlcyBvYmplY3RgKTsKICAgIGZvciAoY29uc3QgW3Byb2ZpbGVJZCwgcHJvZmlsZVN0YXRlXSBvZiBPYmplY3QuZW50cmllcyhwcm9maWxlcykpewogICAgICAgIGlmICh0eXBlb2YgcHJvZmlsZUlkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKCdQcm9maWxlIGlkIG11c3QgYmUgc3RyaW5nJyk7CiAgICAgICAgcGFyc2VQcm9maWxlU3RhdGUocHJvZmlsZVN0YXRlKTsKICAgIH0KICAgIHJldHVybiBwYXJzZWQ7Cn0KZnVuY3Rpb24gcGFyc2VQcm9maWxlU3RhdGUocGFyc2VkKSB7CiAgICBpZiAodHlwZW9mIHBhcnNlZCAhPT0gJ29iamVjdCcgfHwgcGFyc2VkID09PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2ZpbGUgc3RhdGUgbXVzdCBiZSBvYmplY3QnKTsKICAgIGNvbnN0IHsgbmFtZSAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcGFyc2VkOwogICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJyB8fCBuYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBuYW1lIG11c3QgZXhpc3RgKTsKICAgIGlmICh0eXBlb2YgYWNjb3VudElkICE9PSAnc3RyaW5nJyB8fCBhY2NvdW50SWQudHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIGFjY291bnRJZCBtdXN0IGV4aXN0YCk7CiAgICBpZiAodHlwZW9mIGFwaVRva2VuICE9PSAnc3RyaW5nJyB8fCBhcGlUb2tlbi50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgYXBpVG9rZW4gbXVzdCBleGlzdGApOwogICAgcmV0dXJuIHBhcnNlZDsKfQpmdW5jdGlvbiBzYXZlU3RhdGUoc3RhdGUpIHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUQVRFX0tFWSwgSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTsKfQphc3luYyBmdW5jdGlvbiBjb21wdXRlQ2FuTGlzdFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4pIHsKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbGlzdFRhaWxzKGFjY291bnRJZCwgJycsIGFwaVRva2VuKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIENsb3VkZmxhcmVBcGlFcnJvciAmJiBlLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQpmdW5jdGlvbiBpc1ZhbGlkU2FtcGxpbmdSYXRlKHNhbXBsaW5nUmF0ZSkgewogICAgcmV0dXJuICFpc05hTihzYW1wbGluZ1JhdGUpICYmIHNhbXBsaW5nUmF0ZSA+PSAwICYmIHNhbXBsaW5nUmF0ZSA8PSAxOwp9CmZ1bmN0aW9uIGNvbXB1dGVJbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZChzdGF0ZSwgcHJvZmlsZXMpIHsKICAgIGlmIChzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCAmJiBzdGF0ZS5wcm9maWxlc1tzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZF0pIHJldHVybiBzdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZDsKICAgIGlmIChwcm9maWxlcy5sZW5ndGggPiAwKSByZXR1cm4gcHJvZmlsZXNbMF0uaWQ7CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpIHsKICAgIGNvbnN0IGZpbHRlcnMgPSBbXTsKICAgIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ2Vycm9yJykgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIG91dGNvbWU6IFsKICAgICAgICAgICAgICAgICdleGNlcHRpb24nLAogICAgICAgICAgICAgICAgJ2V4Y2VlZGVkQ3B1JywKICAgICAgICAgICAgICAgICdjYW5jZWxlZCcsCiAgICAgICAgICAgICAgICAndW5rbm93bicKICAgICAgICAgICAgXQogICAgICAgIH0pOwogICAgfSBlbHNlIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgb3V0Y29tZTogWwogICAgICAgICAgICAgICAgJ29rJwogICAgICAgICAgICBdCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLnNhbXBsaW5nUmF0ZTEgIT09IHVuZGVmaW5lZCAmJiBpc1ZhbGlkU2FtcGxpbmdSYXRlKGZpbHRlci5zYW1wbGluZ1JhdGUxKSAmJiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA8IDEpIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBzYW1wbGluZ19yYXRlOiBmaWx0ZXIuc2FtcGxpbmdSYXRlMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5zZWFyY2gxICE9PSB1bmRlZmluZWQgJiYgZmlsdGVyLnNlYXJjaDEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIHF1ZXJ5OiBmaWx0ZXIuc2VhcmNoMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5tZXRob2QxICYmIGZpbHRlci5tZXRob2QxLmxlbmd0aCA+IDApIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBtZXRob2Q6IGZpbHRlci5tZXRob2QxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLmlwQWRkcmVzczEgJiYgZmlsdGVyLmlwQWRkcmVzczEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIGNsaWVudF9pcDogZmlsdGVyLmlwQWRkcmVzczEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuaGVhZGVyMSAmJiBmaWx0ZXIuaGVhZGVyMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChjb25zdCBoZWFkZXIgb2YgZmlsdGVyLmhlYWRlcjEpewogICAgICAgICAgICBmaWx0ZXJzLnB1c2gocGFyc2VIZWFkZXJGaWx0ZXIoaGVhZGVyKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBmaWx0ZXJzCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UsIGZpbHRlcikgewogICAgaWYgKCFjb21wdXRlTWVzc2FnZVBhc3Nlc0xvZ1Byb3BGaWx0ZXIobWVzc2FnZSwgZmlsdGVyLmxvZ3Byb3AxKSkgcmV0dXJuIGZhbHNlOwogICAgaWYgKGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyB8fCBmaWx0ZXIuZXZlbnQxID09PSAnaHR0cCcpIHsKICAgICAgICBjb25zdCBpc0Nyb24gPSBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UpOwogICAgICAgIHJldHVybiBpc0Nyb24gJiYgZmlsdGVyLmV2ZW50MSA9PT0gJ2Nyb24nIHx8ICFpc0Nyb24gJiYgZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY29tcHV0ZU1lc3NhZ2VQYXNzZXNMb2dQcm9wRmlsdGVyKG1lc3NhZ2UsIGxvZ3Byb3AxKSB7CiAgICBpZiAobG9ncHJvcDEgPT09IHVuZGVmaW5lZCB8fCBsb2dwcm9wMS5sZW5ndGggPT09IDApIHJldHVybiB0cnVlOwogICAgY29uc3QgbG9ncHJvcEZpbHRlcnMgPSBsb2dwcm9wMS5tYXAocGFyc2VIZWFkZXJGaWx0ZXIpOwogICAgY29uc3QgeyBwcm9wcyAgfSA9IHBhcnNlTG9nUHJvcHMobWVzc2FnZS5sb2dzKTsKICAgIGZvciAoY29uc3QgbG9ncHJvcEZpbHRlciBvZiBsb2dwcm9wRmlsdGVycyl7CiAgICAgICAgaWYgKGNvbXB1dGVQcm9wc1Bhc3NMb2dwcm9wRmlsdGVyKHByb3BzLCBsb2dwcm9wRmlsdGVyKSkgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gY29tcHV0ZVByb3BzUGFzc0xvZ3Byb3BGaWx0ZXIocHJvcHMsIGxvZ3Byb3BGaWx0ZXIpIHsKICAgIGNvbnN0IHZhbCA9IHByb3BzW2xvZ3Byb3BGaWx0ZXIua2V5XTsKICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKGxvZ3Byb3BGaWx0ZXIucXVlcnkgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7CiAgICBjb25zdCBxID0gbG9ncHJvcEZpbHRlci5xdWVyeS50cmltKCkucmVwbGFjZUFsbCgvXCorL2csICcqJyk7CiAgICBpZiAoIXEuaW5jbHVkZXMoJyonKSkgcmV0dXJuIHEgPT09IHZhbDsKICAgIGlmIChxID09PSAnKicpIHJldHVybiB0cnVlOwogICAgaWYgKHR5cGVvZiB2YWwgIT09ICdzdHJpbmcnKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBwYXR0ZXJuID0gJ14nICsgZXNjYXBlRm9yUmVnZXgocSkucmVwbGFjZUFsbCgnXFwqJywgJy4qJykgKyAnJCc7CiAgICByZXR1cm4gbmV3IFJlZ0V4cChwYXR0ZXJuKS50ZXN0KHZhbCk7Cn0KZnVuY3Rpb24gZXNjYXBlRm9yUmVnZXgoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1stXC9cXF4kKis/LigpfFtcXXt9XS9nLCAnXFwkJicpOwp9CmZ1bmN0aW9uIGRpc3RpbmN0KHZhbHVlcykgewogICAgY29uc3QgcnQgPSBbXTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKXsKICAgICAgICBpZiAoIXJ0LmluY2x1ZGVzKHZhbHVlKSkgewogICAgICAgICAgICBydC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gdHJ5UGFyc2VVcmwodXJsKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKHVybCk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpjb25zdCBGSUxURVJfRURJVE9SX0hUTUwgPSBodG1sYAo8Zm9ybSBpZD0iZmlsdGVyLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJmaWx0ZXItZmllbGRzZXQiPgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0IGZvcm0tcm93Ij5FZGl0IGZpbHRlcjwvZGl2PgoKICA8bGFiZWwgaWQ9ImZpbHRlci1maWVsZC1sYWJlbCI+RmlsdGVyIGZpZWxkOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJmaWx0ZXItZmllbGQtdGV4dCIgdHlwZT0idGV4dCI+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLWNob2ljZSI+PC9kaXY+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLW9wdGlvbnMiPjwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1oZWxwIiBjbGFzcz0iYm9keTIgbWVkaXVtLWVtcGhhc2lzLXRleHQiPgogIDwvZGl2PiAgCgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLW91dHB1dC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8b3V0cHV0IGlkPSJmaWx0ZXItZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogIDwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1idXR0b25zIiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0iZmlsdGVyLWFwcGx5IiB0eXBlPSJzdWJtaXQiPkFwcGx5PC9idXR0b24+PCEtLSBmaXJzdCBzbyBpdCBpcyBkZWZhdWx0IGJ1dHRvbiBvbiByZXR1cm4gLS0+CiAgICA8YnV0dG9uIGlkPSJmaWx0ZXItY2FuY2VsIj5DYW5jZWw8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBGSUxURVJfRURJVE9SX0NTUyA9IGNzc2AKCiAgICAjZmlsdGVyLWZvcm0tYnV0dG9ucyB7CiAgICAgICAganVzdGlmeS1zZWxmOiBlbmQ7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtY2hvaWNlIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXB4OwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtb3B0aW9ucyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgZ2FwOiAxcHg7CiAgICB9CgogICAgI2ZpbHRlci1maWVsZC1vcHRpb25zIGJ1dHRvbiB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMC41cmVtOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1oZWxwIHsKICAgICAgICBncmlkLWNvbHVtbjogMjsKICAgIH0KCiAgICAjZmlsdGVyLWZvcm0tb3V0cHV0LXJvdyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMXJlbTsKICAgICAgICBtaW4taGVpZ2h0OiAyLjVyZW07CiAgICB9CgogICAgI2ZpbHRlci1mb3JtLW91dHB1dC1yb3cgb3V0cHV0IHsKICAgICAgICBmbGV4LWdyb3c6IDE7CiAgICB9CgpgOwpmdW5jdGlvbiBpbml0RmlsdGVyRWRpdG9yKGRvY3VtZW50LCB2bTcpIHsKICAgIGNvbnN0IGZpbHRlckZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZvcm0nKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkc2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZHNldCcpOwogICAgY29uc3QgZmlsdGVyRmllbGRMYWJlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtbGFiZWwnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkVGV4dElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZC10ZXh0Jyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZENob2ljZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtY2hvaWNlJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZE9wdGlvbnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLW9wdGlvbnMnKTsKICAgIGNvbnN0IGZpbHRlckNhbmNlbEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItY2FuY2VsJyk7CiAgICBjb25zdCBmaWx0ZXJBcHBseUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItYXBwbHknKTsKICAgIGNvbnN0IGZpbHRlckZvcm1PdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZvcm0tb3V0cHV0Jyk7CiAgICBjb25zdCBmaWx0ZXJGb3JtSGVscERpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZm9ybS1oZWxwJyk7CiAgICBmaWx0ZXJDYW5jZWxCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTcuY2FuY2VsRmlsdGVyKCk7CiAgICB9OwogICAgZmlsdGVyQXBwbHlCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBjb25zdCB0eXBlID0gY29tcHV0ZVR5cGUodm03KTsKICAgICAgICBpZiAodHlwZSA9PT0gJ3RleHQnKSB7CiAgICAgICAgICAgIHZtNy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXJGaWVsZFRleHRJbnB1dC52YWx1ZTsKICAgICAgICB9CiAgICAgICAgdm03LnNhdmVGaWx0ZXIoKTsKICAgIH07CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB3YXNIaWRkZW4gPSBmaWx0ZXJGb3JtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJzsKICAgICAgICBmaWx0ZXJGb3JtLnN0eWxlLmRpc3BsYXkgPSB2bTcuZmlsdGVyRm9ybS5zaG93aW5nID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBmaWx0ZXJGaWVsZHNldC5kaXNhYmxlZCA9ICF2bTcuZmlsdGVyRm9ybS5lbmFibGVkOwogICAgICAgIGNvbnN0IHR5cGUgPSBjb21wdXRlVHlwZSh2bTcpOwogICAgICAgIGZpbHRlckZpZWxkTGFiZWwudGV4dENvbnRlbnQgPSB2bTcuZmlsdGVyRm9ybS5maWVsZE5hbWU7CiAgICAgICAgZmlsdGVyRmllbGRMYWJlbC5odG1sRm9yID0gdHlwZSA9PSAnY2hvaWNlJyA/IGZpbHRlckZpZWxkQ2hvaWNlRGl2LmlkIDogdHlwZSA9PSAnb3B0aW9ucycgPyBmaWx0ZXJGaWVsZE9wdGlvbnNEaXYuaWQgOiBmaWx0ZXJGaWVsZFRleHRJbnB1dC5pZDsKICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5zdHlsZS5kaXNwbGF5ID0gdHlwZSA9PSAndGV4dCcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGZpbHRlckZpZWxkQ2hvaWNlRGl2LnN0eWxlLmRpc3BsYXkgPSB0eXBlID09ICdjaG9pY2UnID8gJ2ZsZXgnIDogJ25vbmUnOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKENIT0lDRVNfSFRNTCh2bTcpLCBmaWx0ZXJGaWVsZENob2ljZURpdik7CiAgICAgICAgZmlsdGVyRmllbGRPcHRpb25zRGl2LnN0eWxlLmRpc3BsYXkgPSB0eXBlID09ICdvcHRpb25zJyA/ICdmbGV4JyA6ICdub25lJzsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihPUFRJT05TX0hUTUwodm03KSwgZmlsdGVyRmllbGRPcHRpb25zRGl2KTsKICAgICAgICBmaWx0ZXJGb3JtSGVscERpdi50ZXh0Q29udGVudCA9IHZtNy5maWx0ZXJGb3JtLmhlbHBUZXh0OwogICAgICAgIGZpbHRlckZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bTcuZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlOwogICAgICAgIGlmICh3YXNIaWRkZW4gJiYgdm03LmZpbHRlckZvcm0uc2hvd2luZykgewogICAgICAgICAgICBjb25zb2xlLmxvZygnZmlsdGVyIGZvcm0gb3BlbicpOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3RleHQnICYmIHZtNy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUpIGZpbHRlckZpZWxkVGV4dElucHV0LnZhbHVlID0gdm03LmZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgZmlsdGVyRmllbGRUZXh0SW5wdXQuZm9jdXMoKTsKICAgICAgICAgICAgICAgIGZpbHRlckZpZWxkVGV4dElucHV0LnNlbGVjdCgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVUeXBlKHZtOCkgewogICAgcmV0dXJuIHZtOC5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmxlbmd0aCA+IDAgPyAnY2hvaWNlJyA6IHZtOC5maWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zLmxlbmd0aCA/ICdvcHRpb25zJyA6ICd0ZXh0JzsKfQpjb25zdCBDSE9JQ0VTX0hUTUwgPSAodm05KT0+ewogICAgcmV0dXJuIHZtOS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLm1hcCgoY2hvaWNlKT0+aHRtbGA8YnV0dG9uIGNsYXNzPSIke2Nob2ljZS5pZCA9PT0gdm05LmZpbHRlckZvcm0uZmllbGRWYWx1ZSA/ICdzZWxlY3RlZCcgOiAnJ30iIEBjbGljaz0keyhlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtOS5zZWxlY3RGaWx0ZXJDaG9pY2UoY2hvaWNlLmlkKTsKICAgICAgICB9fSA/ZGlzYWJsZWQ9IiR7IXZtOS5maWx0ZXJGb3JtLnNob3dpbmd9Ij4ke2Nob2ljZS50ZXh0fTwvYnV0dG9uPmAKICAgICk7Cn07CmNvbnN0IE9QVElPTlNfSFRNTCA9ICh2bTEwKT0+ewogICAgcmV0dXJuIHZtMTAuZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucy5tYXAoKG9wdGlvbik9PnsKICAgICAgICBjb25zdCBzZWxlY3RlZCA9IGZpZWxkVmFsdWVTZXQodm0xMCkuaGFzKG9wdGlvbi5pZCk7CiAgICAgICAgcmV0dXJuIGh0bWxgPGJ1dHRvbiBjbGFzcz0iJHtzZWxlY3RlZCA/ICdzZWxlY3RlZCcgOiAnJ30iIEBjbGljaz0keyhlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtMTAudG9nZ2xlRmlsdGVyT3B0aW9uKG9wdGlvbi5pZCk7CiAgICAgICAgfX0gP2Rpc2FibGVkPSIkeyF2bTEwLmZpbHRlckZvcm0uc2hvd2luZ30iPiR7c2VsZWN0ZWQgPyBDSEVDS19CT1hfQ0hFQ0tFRF9JQ09OIDogQ0hFQ0tfQk9YX1VOQ0hFQ0tFRF9JQ09OfSAke29wdGlvbi50ZXh0fTwvYnV0dG9uPmA7CiAgICB9KTsKfTsKZnVuY3Rpb24gZmllbGRWYWx1ZVNldCh2bTExKSB7CiAgICByZXR1cm4gbmV3IFNldCgodm0xMS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgfHwgJycpLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICkuZmlsdGVyKCh2KT0+di5sZW5ndGggPiAwCiAgICApKTsKfQpjb25zdCBQUk9GSUxFX0VESVRPUl9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9InByb2ZpbGUtZm9ybSIgYXV0b2NvbXBsZXRlPSJvZmYiPgo8ZmllbGRzZXQgaWQ9InByb2ZpbGUtZmllbGRzZXQiPgogIDxkaXYgaWQ9InByb2ZpbGUtZm9ybS10aXRsZSIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCBmb3JtLXJvdyI+UHJvZmlsZTwvZGl2PgoKICA8bGFiZWwgZm9yPSJwcm9maWxlLW5hbWUiPlByb2ZpbGUgbmFtZTo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1uYW1lIiB0eXBlPSJ0ZXh0Ij4KCiAgPGxhYmVsIGZvcj0iYWNjb3VudC1pZCI+Q2xvdWRmbGFyZSBBY2NvdW50IElEOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJwcm9maWxlLWFjY291bnQtaWQiIHR5cGU9InRleHQiPgoKICA8bGFiZWwgZm9yPSJhcGktdG9rZW4iPkNsb3VkZmxhcmUgQVBJIFRva2VuOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJwcm9maWxlLWFwaS10b2tlbiIgdHlwZT0idGV4dCI+CgogIDxkZXRhaWxzIGlkPSJwcm9maWxlLWZvcm0taGVscC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8c3VtbWFyeT5Vc2UgYSA8YSBocmVmPSJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9QcmluY2lwbGVfb2ZfbGVhc3RfcHJpdmlsZWdlIiB0YXJnZXQ9Il9ibGFuayI+bGVhc3QgcHJpdmlsZWdlPC9hPiB0b2tlbiB3aXRoIHBlcm1pc3Npb246IDxjb2RlPkFjY291bnQgJmd0OyBXb3JrZXJzIFRhaWwgJmd0OyBSZWFkPC9jb2RlPjwvc3VtbWFyeT4KICAgIDxvbD4KICAgICAgICA8bGk+U2VsZWN0IDxzcGFuIGNsYXNzPSJjZi1idXR0b24iPkNyZWF0ZSBUb2tlbjwvc3Bhbj4gb24geW91ciBDbG91ZGZsYXJlIDxhIGhyZWY9Imh0dHBzOi8vZGFzaC5jbG91ZGZsYXJlLmNvbS9wcm9maWxlL2FwaS10b2tlbnMiIHRhcmdldD0iX2JsYW5rIj5BUEkgVG9rZW5zPC9hPiBwYWdlLjwvbGk+CiAgICAgICAgPGxpPlNjcm9sbCBkb3duIHRvIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5DcmVhdGUgQ3VzdG9tIFRva2VuPC9zcGFuPiwgdGhlbiA8c3BhbiBjbGFzcz0iY2YtYnV0dG9uIj5HZXQgc3RhcnRlZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5VbmRlciA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UGVybWlzc2lvbnM8L3NwYW4+LCBncmFudCB5b3VyIHRva2VuIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5BY2NvdW50PC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+V29ya2VycyBUYWlsPC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UmVhZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5BbHNvIChmb3IgYW5hbHl0aWNzKSwgZ3JhbnQgeW91ciB0b2tlbiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+QWNjb3VudDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPkFjY291bnQgQW5hbHl0aWNzPC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UmVhZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5BbHNvIChmb3IgRE8gbmFtZXMpLCBncmFudCB5b3VyIHRva2VuIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5BY2NvdW50PC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+V29ya2VyIFNjcmlwdHM8L3NwYW4+IDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5SZWFkPC9zcGFuPjwvbGk+CiAgICA8L29sPgogIDwvZGV0YWlscz4gIAoKICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyIgY2xhc3M9ImZvcm0tcm93Ij4KICAgIDxvdXRwdXQgaWQ9InByb2ZpbGUtZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogICAgPHByb2dyZXNzIGlkPSJwcm9maWxlLWZvcm0tcHJvZ3Jlc3MiIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmb3JtLWxocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWRlbGV0ZSI+RGVsZXRlPC9idXR0b24+CiAgPC9kaXY+CiAgPGRpdiBpZD0icHJvZmlsZS1mb3JtLWJ1dHRvbnMiIGNsYXNzPSJmb3JtLXJocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWNhbmNlbCI+Q2FuY2VsPC9idXR0b24+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLXNhdmUiPlNhdmU8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBQUk9GSUxFX0VESVRPUl9DU1MgPSBjc3NgCgogICAgI3Byb2ZpbGUtZm9ybS1idXR0b25zIHsKICAgICAgICBqdXN0aWZ5LXNlbGY6IGVuZDsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXJlbTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IHsKICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBzdW1tYXJ5IHsKICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IG9sIHsKICAgICAgICBjdXJzb3I6IGRlZmF1bHQ7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBsaSB7CiAgICAgICAgcGFkZGluZzogMC41cmVtIDA7CiAgICB9CgogICAgLmNmLWJ1dHRvbiB7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IGJsdWU7CiAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIHBhZGRpbmc6IDAuMjVyZW0gMC41cmVtOwogICAgICAgIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgICB9CgogICAgLmNmLXNlY3Rpb24gewogICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICAgcGFkZGluZzogMC4yNXJlbSAwLjVyZW07CiAgICAgICAgb3V0bGluZTogc29saWQgMXB4IGdyYXk7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1vdXRwdXQtcm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgICAgIG1pbi1oZWlnaHQ6IDIuNXJlbTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLW91dHB1dC1yb3cgb3V0cHV0IHsKICAgICAgICBmbGV4LWdyb3c6IDE7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1wcm9ncmVzcyB7CiAgICAgICAgZm9udC1zaXplOiAwLjVyZW07IC8qIGRlZmF1bHQgM2VtID0+IDEuNXJlbSAqLwogICAgfQoKYDsKZnVuY3Rpb24gaW5pdFByb2ZpbGVFZGl0b3IoZG9jdW1lbnQsIHZtMTIpIHsKICAgIGNvbnN0IHByb2ZpbGVGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1UaXRsZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tdGl0bGUnKTsKICAgIGNvbnN0IHByb2ZpbGVGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZpZWxkc2V0Jyk7CiAgICBjb25zdCBwcm9maWxlTmFtZUlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtbmFtZScpOwogICAgY29uc3QgcHJvZmlsZUFjY291bnRJZElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtYWNjb3VudC1pZCcpOwogICAgY29uc3QgcHJvZmlsZUFwaVRva2VuSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1hcGktdG9rZW4nKTsKICAgIGNvbnN0IHByb2ZpbGVEZWxldGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1kZWxldGUnKTsKICAgIGNvbnN0IHByb2ZpbGVDYW5jZWxCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1jYW5jZWwnKTsKICAgIGNvbnN0IHByb2ZpbGVTYXZlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtc2F2ZScpOwogICAgY29uc3QgcHJvZmlsZUZvcm1Qcm9ncmVzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tcHJvZ3Jlc3MnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1vdXRwdXQnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtSGVscERldGFpbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLWhlbHAtcm93Jyk7CiAgICBwcm9maWxlQ2FuY2VsQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xMi5jYW5jZWxQcm9maWxlKCk7CiAgICB9OwogICAgcHJvZmlsZU5hbWVJbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bTEyLnNldFByb2ZpbGVOYW1lKHByb2ZpbGVOYW1lSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVBY2NvdW50SWRJbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bTEyLnNldFByb2ZpbGVBY2NvdW50SWQocHJvZmlsZUFjY291bnRJZElucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bTEyLnNldFByb2ZpbGVBcGlUb2tlbihwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZVNhdmVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTEyLnNhdmVQcm9maWxlKCk7CiAgICB9OwogICAgcHJvZmlsZURlbGV0ZUJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTIuZGVsZXRlUHJvZmlsZSh2bTEyLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gcHJvZmlsZUZvcm0uc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIHByb2ZpbGVGb3JtLnN0eWxlLmRpc3BsYXkgPSB2bTEyLnByb2ZpbGVGb3JtLnNob3dpbmcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVGaWVsZHNldC5kaXNhYmxlZCA9ICF2bTEyLnByb2ZpbGVGb3JtLmVuYWJsZWQ7CiAgICAgICAgcHJvZmlsZUZvcm1UaXRsZURpdi50ZXh0Q29udGVudCA9IHZtMTIucHJvZmlsZUZvcm0udGl0bGU7CiAgICAgICAgcHJvZmlsZU5hbWVJbnB1dC52YWx1ZSA9IHZtMTIucHJvZmlsZUZvcm0ubmFtZTsKICAgICAgICBwcm9maWxlQWNjb3VudElkSW5wdXQudmFsdWUgPSB2bTEyLnByb2ZpbGVGb3JtLmFjY291bnRJZDsKICAgICAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSA9IHZtMTIucHJvZmlsZUZvcm0uYXBpVG9rZW47CiAgICAgICAgcHJvZmlsZURlbGV0ZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gdm0xMi5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID8gJ2lubGluZS1ibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZVNhdmVCdXR0b24uZGlzYWJsZWQgPSAhdm0xMi5wcm9maWxlRm9ybS5zYXZlRW5hYmxlZDsKICAgICAgICBwcm9maWxlRm9ybVByb2dyZXNzLnN0eWxlLmRpc3BsYXkgPSB2bTEyLnByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZUZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bTEyLnByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2U7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiB2bTEyLnByb2ZpbGVGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc3QgaW5pdGlhbERldGFpbHNPcGVuID0gdm0xMi5yZWFsUHJvZmlsZXMubGVuZ3RoID09PSAwOwogICAgICAgICAgICBwcm9maWxlRm9ybUhlbHBEZXRhaWxzLm9wZW4gPSBpbml0aWFsRGV0YWlsc09wZW47CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIHByb2ZpbGVOYW1lSW5wdXQuZm9jdXMoKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVOYW1lSW5wdXQuc2VsZWN0KCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgV0VMQ09NRV9QQU5FTF9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9IndlbGNvbWUtcGFuZWwiIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJ3ZWxjb21lLXBhbmVsLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJ3ZWxjb21lLXBhbmVsLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQgZm9ybS1yb3ciPnRpdGxlPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tcm93IGJvZHkyIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij4KICAgIFdlbGNvbWUgdG8gPHNwYW4gY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+V2VidGFpbCBmb3IgQ2xvdWRmbGFyZSBXb3JrZXJzPC9zcGFuPiEKICAgIDxwPlZpZXcgbGl2ZSByZXF1ZXN0cyBhbmQgbG9ncyBmcm9tIDxhIGhyZWY9Imh0dHBzOi8vd29ya2Vycy5jbG91ZGZsYXJlLmNvbS8iIHRhcmdldD0iX2JsYW5rIj5DbG91ZGZsYXJlIFdvcmtlcnM8L2E+IGZyb20gdGhlIGNvbWZvcnQgb2YgeW91ciBicm93c2VyLiAKICAgIEEgZmV3IGVuaGFuY2VtZW50cyBvdmVyIHdoYXQncyBwcm92aWRlZCA8YSBocmVmPSJodHRwczovL2Jsb2cuY2xvdWRmbGFyZS5jb20vaW50cm9kdWNpbmctd29ya2Vycy1kYXNoYm9hcmQtbG9ncy8iIHRhcmdldD0iX2JsYW5rIj5ieSBkZWZhdWx0PC9hPiBpbiB0aGUgQ2xvdWRmbGFyZSBkYXNoYm9hcmQ6PC9wPgogICAgPHVsPgogICAgICAgIDxsaT5UYWlsIG11bHRpcGxlIHdvcmtlcnMgYXQgdGhlIHNhbWUgdGltZTwvbGk+CiAgICAgICAgPGxpPkFkdmFuY2VkIGZpbHRlcmluZyBhbmQgbXVsdGktY29sb3Igb3V0cHV0IHNpbWlsYXIgdG8gPGEgaHJlZj0iaHR0cHM6Ly9kZXZlbG9wZXJzLmNsb3VkZmxhcmUuY29tL3dvcmtlcnMvY2xpLXdyYW5nbGVyL2NvbW1hbmRzI3RhaWwiIHRhcmdldD0iX2JsYW5rIj53cmFuZ2xlciB0YWlsPC9hPjwvbGk+CiAgICAgICAgPGxpPkR1cmFibGUgb2JqZWN0IGNsYXNzL25hbWUvaWQgYW5kIGNvbG8gaW5mb3JtYXRpb24gY2FuIGJlIHN1cmZhY2VkIHdpdGggPGEgaHJlZj0iaHR0cHM6Ly9kZW5vZmxhcmUuZGV2L2V4YW1wbGVzL3dlYnRhaWwjbG9ncHJvcHMiIHRhcmdldD0iX2JsYW5rIj5sb2dwcm9wczwvYT48L2xpPgogICAgICAgIDxsaT5NdWx0aXBsZSBwcm9maWxlcywgc3dpdGNoIGVhc2lseSBiZXR3ZWVuIG11bHRpcGxlIGFjY291bnRzPC9saT4KICAgICAgICA8bGk+Tm8gbmVlZCB0byBsb2cgaW4gd2l0aCB5b3VyIGZ1bGwgQ2xvdWRmbGFyZSBjcmVkZW50aWFscy4gIFByb2ZpbGVzIGFyZSBzdG9yZWQgbG9jYWxseSBpbiB0aGUgYnJvd3NlciwgYW5kIGNhbiBiZSBwZXJtaXNzaW9uZWQgb25seSBmb3IgdGFpbGluZyB3b3JrZXJzPC9saT4KICAgICAgICA8bGk+SW1wbGVtZW50ZWQgYXMgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL3NreW1ldGhvZC9kZW5vZmxhcmUvdHJlZS9tYXN0ZXIvZXhhbXBsZXMvd2VidGFpbC13b3JrZXIiIHRhcmdldD0iX2JsYW5rIj5hbiBvcGVuLXNvdXJjZSBDbG91ZGZsYXJlIFdvcmtlcjwvYT4sIAogICAgICAgICAgIDxhIGhyZWY9Imh0dHBzOi8vZGVub2ZsYXJlLmRldi9leGFtcGxlcy93ZWJ0YWlsI2RlcGxveS1pdC10by15b3VyLW93bi1hY2NvdW50IiB0YXJnZXQ9Il9ibGFuayI+ZGVwbG95IGl0IHRvIHlvdXIgb3duIGFjY291bnQ8L2E+LCAKICAgICAgICAgICAgb3IgPGEgaHJlZj0iaHR0cHM6Ly9kZW5vZmxhcmUuZGV2L2V4YW1wbGVzL3dlYnRhaWwjaG9zdC1pdC1sb2NhbGx5IiB0YXJnZXQ9Il9ibGFuayI+aG9zdCBpdCBsb2NhbGx5PC9hPiB3aXRoIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayI+PGNvZGU+ZGVub2ZsYXJlPC9jb2RlPjwvYT48L2xpPgogICAgPC91bD4KICAgIDxwIGlkPSJ3ZWxjb21lLXBhbmVsLXRyYWlsZXIiPkNyZWF0ZSBhIG5ldyBwcm9maWxlIHRvIGdldCBzdGFydGVkITwvcD4KICAgIDxwIGlkPSJhYm91dC1wYW5lbC10cmFpbGVyIj5IZWFkIG92ZXIgdG8gdGhlIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayI+RGVub2ZsYXJlIEdpdEh1YiByZXBvPC9hPiB0byByZXF1ZXN0IGZlYXR1cmVzLCByZXBvcnQgYnVncywgb3IgY2hlY2sgb3V0IHRoZSBjb2RlITwvcD4KICA8L2Rpdj4KCiAgPGRpdiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0id2VsY29tZS1wYW5lbC1uZXctcHJvZmlsZSIgdHlwZT0ic3VibWl0Ij5OZXcgcHJvZmlsZTwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0id2VsY29tZS1wYW5lbC1jbG9zZSIgdHlwZT0ic3VibWl0Ij5DbG9zZTwvYnV0dG9uPgogIDwvZGl2Pgo8L2ZpZWxkc2V0Pgo8L2Zvcm0+CmA7CmNvbnN0IFdFTENPTUVfUEFORUxfQ1NTID0gY3NzYAoKICAgICN3ZWxjb21lLXBhbmVsLWZvcm0tdGl0bGUgewogICAgICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgfQoKYDsKZnVuY3Rpb24gaW5pdFdlbGNvbWVQYW5lbChkb2N1bWVudCwgdm0xMykgewogICAgY29uc3Qgd2VsY29tZVBhbmVsRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWxjb21lLXBhbmVsJyk7CiAgICBjb25zdCB0aXRsZUVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC1mb3JtLXRpdGxlJyk7CiAgICBjb25zdCB3ZWxjb21lVHJhaWxlckVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC10cmFpbGVyJyk7CiAgICBjb25zdCBhYm91dFRyYWlsZXJFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Fib3V0LXBhbmVsLXRyYWlsZXInKTsKICAgIGNvbnN0IG5ld1Byb2ZpbGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC1uZXctcHJvZmlsZScpOwogICAgY29uc3QgY2xvc2VCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbC1jbG9zZScpOwogICAgbmV3UHJvZmlsZUJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTMubmV3UHJvZmlsZSgpOwogICAgfTsKICAgIGNsb3NlQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xMy5jbG9zZUFib3V0KCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gd2VsY29tZVBhbmVsRWxlbWVudC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7CiAgICAgICAgY29uc3Qgc2hvdyA9IHZtMTMud2VsY29tZVNob3dpbmcgJiYgIXZtMTMucHJvZmlsZUZvcm0uc2hvd2luZyB8fCB2bTEzLmFib3V0U2hvd2luZzsKICAgICAgICB3ZWxjb21lUGFuZWxFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjb25zdCB3ZWxjb21lID0gdm0xMy53ZWxjb21lU2hvd2luZzsKICAgICAgICB0aXRsZUVsZW1lbnQudGV4dENvbnRlbnQgPSB3ZWxjb21lID8gJ0hlbGxvIPCfkYsnIDogJ0Fib3V0JzsKICAgICAgICB3ZWxjb21lVHJhaWxlckVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IHdlbGNvbWUgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGFib3V0VHJhaWxlckVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IHdlbGNvbWUgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgIG5ld1Byb2ZpbGVCdXR0b24uc3R5bGUuZGlzcGxheSA9IHdlbGNvbWUgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGNsb3NlQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ25vbmUnIDogJ2Jsb2NrJzsKICAgICAgICBpZiAod2FzSGlkZGVuICYmIHNob3cpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7d2VsY29tZSA/ICd3ZWxjb21lJyA6ICdhYm91dCd9IHBhbmVsIG9wZW5gKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgKHdlbGNvbWUgPyBuZXdQcm9maWxlQnV0dG9uIDogY2xvc2VCdXR0b24pLmZvY3VzKCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgTU9EQUxfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9Im1vZGFsIiBjbGFzcz0ibW9kYWwgaGlkZGVuLXZlcnRpY2FsLXNjcm9sbCI+CiAgICA8ZGl2IGNsYXNzPSJtb2RhbC1jb250ZW50Ij4KICAgICR7V0VMQ09NRV9QQU5FTF9IVE1MfQogICAgJHtQUk9GSUxFX0VESVRPUl9IVE1MfQogICAgJHtGSUxURVJfRURJVE9SX0hUTUx9CiAgICA8L2Rpdj4KPC9kaXY+CmA7CmNvbnN0IE1PREFMX0NTUyA9IGNzc2AKLm1vZGFsIHsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICB6LWluZGV4OiAxOwogICAgbGVmdDogMDsKICAgIHRvcDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjQpOwp9CgoubW9kYWwtY29udGVudCB7CiAgICBtYXJnaW46IDEwJSBhdXRvOwogICAgd2lkdGg6IDgwJTsKICAgIG1heC13aWR0aDogNDByZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKQG1lZGlhIHNjcmVlbiBhbmQgKG1heC13aWR0aDogNjAwcHgpIHsKICAgIC5tb2RhbC1jb250ZW50IHsKICAgICAgICBtYXJnaW46IDEwJSAwOwogICAgICAgIHdpZHRoOiAxMDAlOwogICAgfQp9CgpgOwpmdW5jdGlvbiBpbml0TW9kYWwoZG9jdW1lbnQsIHZtMTQpIHsKICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsJyk7CiAgICBjb25zdCB1cGRhdGVQcm9maWxlRWRpdG9yID0gaW5pdFByb2ZpbGVFZGl0b3IoZG9jdW1lbnQsIHZtMTQpOwogICAgY29uc3QgdXBkYXRlRmlsdGVyRWRpdG9yID0gaW5pdEZpbHRlckVkaXRvcihkb2N1bWVudCwgdm0xNCk7CiAgICBjb25zdCB1cGRhdGVXZWxjb21lUGFuZWwgPSBpbml0V2VsY29tZVBhbmVsKGRvY3VtZW50LCB2bTE0KTsKICAgIGNvbnN0IGNsb3NlTW9kYWwgPSAoKT0+ewogICAgICAgIGlmICghdm0xNC5wcm9maWxlRm9ybS5zaG93aW5nICYmICF2bTE0LmZpbHRlckZvcm0uc2hvd2luZyAmJiAhdm0xNC53ZWxjb21lU2hvd2luZyAmJiAhdm0xNC5hYm91dFNob3dpbmcpIHJldHVybjsKICAgICAgICBpZiAodm0xNC5wcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUpIHJldHVybjsKICAgICAgICB2bTE0LnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bTE0LmZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHZtMTQuYWJvdXRTaG93aW5nID0gZmFsc2U7CiAgICAgICAgdm0xNC5vbkNoYW5nZSgpOwogICAgfTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudCk9PnsKICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09IG1vZGFsKSB7CiAgICAgICAgICAgIGNsb3NlTW9kYWwoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZXZlbnQpPT57CiAgICAgICAgZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7CiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gJ0VzY2FwZScpIHsKICAgICAgICAgICAgY2xvc2VNb2RhbCgpOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgdXBkYXRlUHJvZmlsZUVkaXRvcigpOwogICAgICAgIHVwZGF0ZUZpbHRlckVkaXRvcigpOwogICAgICAgIHVwZGF0ZVdlbGNvbWVQYW5lbCgpOwogICAgICAgIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSB2bTE0LnByb2ZpbGVGb3JtLnNob3dpbmcgfHwgdm0xNC5maWx0ZXJGb3JtLnNob3dpbmcgfHwgdm0xNC53ZWxjb21lU2hvd2luZyB8fCB2bTE0LmFib3V0U2hvd2luZyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKY29uc3QgQ09OU09MRV9IVE1MID0gaHRtbGAKPGRpdiBpZD0iY29uc29sZSI+CiAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlciI+CiAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItZmlsdGVycyIgY2xhc3M9ImJvZHkyIj48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1zdGF0dXMiPgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci10YWlscyIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItcXBzIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1jbGVhciI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxjb2RlIGlkPSJjb25zb2xlLWxhc3QtbGluZSIgY2xhc3M9ImxpbmUiPnNwYWNlcjwvY29kZT4KPC9kaXY+CmA7CmNvbnN0IENPTlNPTEVfQ1NTID0gY3NzYAoKI2NvbnNvbGUgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgd2lkdGg6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIG92ZXJmbG93LXk6IHNjcm9sbDsKICAgIG92ZXJmbG93LXg6IGhpZGRlbjsKICAgIGZsZXgtZ3JvdzogMTsKfQoKI2NvbnNvbGU6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICAgIHdpZHRoOiAxcmVtOwogICAgaGVpZ2h0OiAzcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCiNjb25zb2xlLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgaGVpZ2h0OiAzLjc1cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMS4yNXJlbSAxcmVtIDFyZW0gMDsKfQoKI2NvbnNvbGUtaGVhZGVyLWZpbHRlcnMgewogICAgZmxleC1ncm93OiAxOwogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1zYW5zLXNlcmlmLWZvbnQtZmFtaWx5KTsKCiAgICBkaXNwbGF5OiAtd2Via2l0LWJveDsKICAgIC13ZWJraXQtbGluZS1jbGFtcDogMzsKICAgIC13ZWJraXQtYm94LW9yaWVudDogdmVydGljYWw7ICAKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1zdGF0dXMgewogICAgaGVpZ2h0OiAxcmVtOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtaW4td2lkdGg6IDZyZW07CiAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgIHBhZGRpbmctdG9wOiAwLjI1cmVtOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCiNjb25zb2xlLWhlYWRlci10YWlscyB7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgojY29uc29sZS1oZWFkZXItY2xlYXIgewogICAgbWFyZ2luLXJpZ2h0OiAtMC41cmVtOwogICAgbWFyZ2luLWxlZnQ6IDFyZW07CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1jbGVhciAuYWN0aW9uLWljb24gewogICAgcGFkZGluZy1yaWdodDogMC41cmVtOwogICAgcGFkZGluZy1sZWZ0OiAwLjVyZW07Cn0KCiNjb25zb2xlIC5saW5lIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1zaXplOiAwLjc1cmVtOyAvKiAxMnB4ICovCiAgICBsaW5lLWhlaWdodDogMS4xcmVtOwogICAgZm9udC1mYW1pbHk6IHZhcigtLW1vbm9zcGFjZS1mb250LWZhbWlseSk7CiAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCiNjb25zb2xlLWxhc3QtbGluZSB7CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCmA7CmZ1bmN0aW9uIGluaXRDb25zb2xlKGRvY3VtZW50LCB2bTE1KSB7CiAgICBjb25zdCBjb25zb2xlRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJGaWx0ZXJzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLWZpbHRlcnMnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJUYWlsc0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItdGFpbHMnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJRcHNFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLXFwcycpOwogICAgY29uc3QgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1jbGVhcicpOwogICAgY29uc3QgY29uc29sZUxhc3RMaW5lRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWxhc3QtbGluZScpOwogICAgbGV0IHNob3dpbmdDbGVhckJ1dHRvbiA9IGZhbHNlOwogICAgdm0xNS5sb2dnZXIgPSAoLi4uZGF0YTYpPT57CiAgICAgICAgY29uc3QgbGluZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjb2RlJyk7CiAgICAgICAgbGluZUVsZW1lbnQuY2xhc3NOYW1lID0gJ2xpbmUnOwogICAgICAgIGxldCBwb3MgPSAwOwogICAgICAgIHdoaWxlKHBvcyA8IGRhdGE2Lmxlbmd0aCl7CiAgICAgICAgICAgIGlmIChwb3MgPiAwKSB7CiAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnLCAnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgbXNnID0gZGF0YTZbcG9zXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0b2tlbnMgPSBtc2cuc3BsaXQoJyVjJyk7CiAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgICAgICAgICAgICAgICAgIGxldCByZW5kZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChpID4gMCAmJiBpIDwgdG9rZW5zLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkYXRhNltwb3MgKyBpXTsKICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlLmluY2x1ZGVzKCd4LScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IC94LWR1cmFibGUtb2JqZWN0LShjbGFzc3xuYW1lfGlkKVxzKjpccyonKC4qPyknLy5leGVjKHN0eWxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gbVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBtWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2dwcm9wTmFtZSA9ICdkdXJhYmxlT2JqZWN0JyArIHR5cGUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyB0eXBlLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5ocmVmID0gJyMnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLm9uY2xpY2sgPSAoKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm0xNS5zZXRMb2dwcm9wRmlsdGVyKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dwcm9wTmFtZSArICc6JyArIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtMTUub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0b2tlbnNbaV0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbmRlcmVkKSByZW5kZXJUZXh0SW50b1NwYW4odG9rZW5zW2ldLCBzcGFuKTsKICAgICAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvcyArPSAxICsgdG9rZW5zLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShKU09OLnN0cmluZ2lmeShtc2cpKSk7CiAgICAgICAgICAgICAgICBwb3MrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zb2xlRGl2Lmluc2VydEJlZm9yZShsaW5lRWxlbWVudCwgY29uc29sZUxhc3RMaW5lRWxlbWVudCk7CiAgICAgICAgY29uc3QgeyBzY3JvbGxIZWlnaHQgLCBzY3JvbGxUb3AgLCBjbGllbnRIZWlnaHQgIH0gPSBjb25zb2xlRGl2OwogICAgICAgIGNvbnN0IGRpZmYgPSBzY3JvbGxIZWlnaHQgLSBzY3JvbGxUb3A7CiAgICAgICAgY29uc3QgYXV0b3Njcm9sbCA9IGRpZmYgLSAxNiAqIDQgPD0gY2xpZW50SGVpZ2h0OwogICAgICAgIGlmIChhdXRvc2Nyb2xsKSB7CiAgICAgICAgICAgIGNvbnNvbGVMYXN0TGluZUVsZW1lbnQuc2Nyb2xsSW50b1ZpZXcoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZiAoIXNob3dpbmdDbGVhckJ1dHRvbikgewogICAgICAgICAgICBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgICAgICAgIHNob3dpbmdDbGVhckJ1dHRvbiA9IHRydWU7CiAgICAgICAgfQogICAgfTsKICAgIHZtMTUub25SZXNldE91dHB1dCA9ICgpPT57CiAgICAgICAgY29uc3QgbGluZXMgPSBjb25zb2xlRGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJy5saW5lJyk7CiAgICAgICAgbGluZXMuZm9yRWFjaCgobGluZSk9PnsKICAgICAgICAgICAgaWYgKGxpbmUuaWQgIT09ICdjb25zb2xlLWxhc3QtbGluZScpIGNvbnNvbGVEaXYucmVtb3ZlQ2hpbGQobGluZSk7CiAgICAgICAgfSk7CiAgICAgICAgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CiAgICAgICAgc2hvd2luZ0NsZWFyQnV0dG9uID0gZmFsc2U7CiAgICB9OwogICAgY29uc29sZUhlYWRlclFwc0VsZW1lbnQudGV4dENvbnRlbnQgPSBjb21wdXRlUXBzVGV4dCgwKTsKICAgIHZtMTUub25RcHNDaGFuZ2UgPSAocXBzKT0+ewogICAgICAgIGNvbnNvbGVIZWFkZXJRcHNFbGVtZW50LnRleHRDb250ZW50ID0gY29tcHV0ZVFwc1RleHQocXBzKTsKICAgIH07CiAgICBMaXRFbGVtZW50LnJlbmRlcihhY3Rpb25JY29uKENMRUFSX0lDT04sIHsKICAgICAgICB0ZXh0OiAnQ2xlYXInLAogICAgICAgIG9uY2xpY2s6ICgpPT52bTE1LnJlc2V0T3V0cHV0KCkKICAgIH0pLCBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50KTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnNvbGVEaXYuc3R5bGUuZGlzcGxheSA9IHZtMTUuc2VsZWN0ZWRBbmFseXRpY0lkID8gJ25vbmUnIDogJ2Jsb2NrJzsKICAgICAgICBjb25zb2xlSGVhZGVyRmlsdGVyc0Rpdi5zdHlsZS52aXNpYmlsaXR5ID0gdm0xNS5wcm9maWxlcy5sZW5ndGggPiAwID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgY29uc29sZUhlYWRlclRhaWxzRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbXB1dGVUYWlsc1RleHQodm0xNS50YWlscy5zaXplKTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihGSUxURVJTX0hUTUwodm0xNSksIGNvbnNvbGVIZWFkZXJGaWx0ZXJzRGl2KTsKICAgIH07Cn0KY29uc3QgRklMVEVSU19IVE1MID0gKHZtMTYpPT57CiAgICByZXR1cm4gaHRtbGBTaG93aW5nIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTZWxlY3Rpb25GaWVsZHMoKTsKICAgIH19PiR7dm0xNi5jb21wdXRlU2VsZWN0aW9uRmllbGRzVGV4dCgpfTwvYT4KICAgICBmb3IgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdEV2ZW50RmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVFdmVudEZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4KICAgICB3aXRoIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTdGF0dXNGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVN0YXR1c0ZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdElwQWRkcmVzc0ZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSXBBZGRyZXNzRmlsdGVyVGV4dCh2bTE2LmZpbHRlcil9PC9hPiwKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5lZGl0TWV0aG9kRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVNZXRob2RGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+LAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTYW1wbGluZ1JhdGVGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVNhbXBsaW5nUmF0ZUZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sIAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bTE2LmVkaXRTZWFyY2hGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVNlYXJjaEZpbHRlclRleHQodm0xNi5maWx0ZXIpfTwvYT4sIAogICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdEhlYWRlckZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSGVhZGVyRmlsdGVyVGV4dCh2bTE2LmZpbHRlcil9PC9hPiwKICAgICBhbmQgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtMTYuZWRpdExvZ3Byb3BGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUxvZ3Byb3BGaWx0ZXJUZXh0KHZtMTYuZmlsdGVyKX08L2E+LgogICAgICR7dm0xNi5oYXNBbnlGaWx0ZXJzKCkgPyBodG1sYCg8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0xNi5yZXNldEZpbHRlcnMoKTsKICAgIH19PnJlc2V0PC9hPilgIDogJyd9YDsKfTsKZnVuY3Rpb24gY29tcHV0ZUV2ZW50RmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgZXZlbnQxICB9ID0gZmlsdGVyOwogICAgcmV0dXJuIGV2ZW50MSA9PT0gJ2Nyb24nID8gJ0NST04gdHJpZ2dlciBldmVudHMnIDogZXZlbnQxID09PSAnaHR0cCcgPyAnSFRUUCByZXF1ZXN0IGV2ZW50cycgOiAnYWxsIGV2ZW50cyc7Cn0KZnVuY3Rpb24gY29tcHV0ZVN0YXR1c0ZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCB7IHN0YXR1czEgIH0gPSBmaWx0ZXI7CiAgICByZXR1cm4gc3RhdHVzMSA9PT0gJ2Vycm9yJyA/ICdlcnJvciBzdGF0dXMnIDogc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnID8gJ3N1Y2Nlc3Mgc3RhdHVzJyA6ICdhbnkgc3RhdHVzJzsKfQpmdW5jdGlvbiBjb21wdXRlSXBBZGRyZXNzRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IGlwQWRkcmVzczEgPSBmaWx0ZXIuaXBBZGRyZXNzMSB8fCBbXTsKICAgIHJldHVybiBpcEFkZHJlc3MxLmxlbmd0aCA9PT0gMCA/ICdhbnkgSVAgYWRkcmVzcycgOiBpcEFkZHJlc3MxLmxlbmd0aCA9PT0gMSA/IGBJUCBhZGRyZXNzIG9mICR7aXBBZGRyZXNzMVswXX1gIDogYElQIGFkZHJlc3MgaW4gWyR7aXBBZGRyZXNzMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVNZXRob2RGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgbWV0aG9kMSA9IGZpbHRlci5tZXRob2QxIHx8IFtdOwogICAgcmV0dXJuIG1ldGhvZDEubGVuZ3RoID09PSAwID8gJ2FueSBtZXRob2QnIDogbWV0aG9kMS5sZW5ndGggPT09IDEgPyBgbWV0aG9kIG9mICR7bWV0aG9kMVswXX1gIDogYG1ldGhvZCBpbiBbJHttZXRob2QxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZVNhbXBsaW5nUmF0ZUZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBzYW1wbGluZ1JhdGUxID0gdHlwZW9mIGZpbHRlci5zYW1wbGluZ1JhdGUxID09PSAnbnVtYmVyJyA/IGZpbHRlci5zYW1wbGluZ1JhdGUxIDogMTsKICAgIHJldHVybiBzYW1wbGluZ1JhdGUxID49IDEgPyAnbm8gc2FtcGxpbmcnIDogYCR7KE1hdGgubWF4KDAsIHNhbXBsaW5nUmF0ZTEpICogMTAwKS50b0ZpeGVkKDIpfSUgc2FtcGxpbmcgcmF0ZWA7Cn0KZnVuY3Rpb24gY29tcHV0ZVNlYXJjaEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCB7IHNlYXJjaDEgIH0gPSBmaWx0ZXI7CiAgICByZXR1cm4gdHlwZW9mIHNlYXJjaDEgPT09ICdzdHJpbmcnICYmIHNlYXJjaDEubGVuZ3RoID4gMCA/IGBjb25zb2xlIGxvZ3MgY29udGFpbmluZyAiJHtzZWFyY2gxfSJgIDogJ25vIHNlYXJjaCBmaWx0ZXInOwp9CmZ1bmN0aW9uIGNvbXB1dGVIZWFkZXJGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgaGVhZGVyMSA9IGZpbHRlci5oZWFkZXIxIHx8IFtdOwogICAgcmV0dXJuIGhlYWRlcjEubGVuZ3RoID09PSAwID8gJ25vIGhlYWRlciBmaWx0ZXInIDogaGVhZGVyMS5sZW5ndGggPT09IDEgPyBgaGVhZGVyIGZpbHRlciBvZiAke2hlYWRlcjFbMF19YCA6IGBoZWFkZXIgZmlsdGVycyBvZiBbJHtoZWFkZXIxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZUxvZ3Byb3BGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgbG9ncHJvcDEgPSBmaWx0ZXIubG9ncHJvcDEgfHwgW107CiAgICByZXR1cm4gbG9ncHJvcDEubGVuZ3RoID09PSAwID8gJ25vIGxvZ3Byb3AgZmlsdGVyJyA6IGxvZ3Byb3AxLmxlbmd0aCA9PT0gMSA/IGBsb2dwcm9wIGZpbHRlciBvZiAke2xvZ3Byb3AxWzBdfWAgOiBgbG9ncHJvcCBmaWx0ZXJzIG9mIFske2xvZ3Byb3AxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZVRhaWxzVGV4dCh0YWlsQ291bnQpIHsKICAgIHJldHVybiB0YWlsQ291bnQgPT09IDAgPyAnbm8gdGFpbHMnIDogdGFpbENvdW50ID09PSAxID8gJzEgdGFpbCcgOiBgJHt0YWlsQ291bnR9IHRhaWxzYDsKfQpmdW5jdGlvbiBjb21wdXRlUXBzVGV4dChxcHMpIHsKICAgIHJldHVybiBgJHtxcHMudG9GaXhlZCgyKX0gcXBzYDsKfQpmdW5jdGlvbiByZW5kZXJUZXh0SW50b1NwYW4odGV4dCwgc3BhbikgewogICAgY29uc3QgcGF0dGVybiA9IC8oaHR0cHM6XC9cL1teXHMpXSt8XGR7MSwzfVwuXGR7MSwzfVwuXGR7MSwzfVwuXGR7MSwzfXxbXGQwLWZdKyg6KFtcZDAtZl17MCw0fSk/KXs1LDd9KS9nOwogICAgbGV0IG07CiAgICBsZXQgaSA9IDA7CiAgICB3aGlsZShudWxsICE9PSAobSA9IHBhdHRlcm4uZXhlYyh0ZXh0KSkpewogICAgICAgIGlmIChtLmluZGV4ID4gaSkgewogICAgICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQuc3Vic3RyaW5nKGksIG0uaW5kZXgpKSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVybE9ySXAgPSBtWzBdOwogICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsT3JJcC5zdGFydHNXaXRoKCdodHRwczovLycpID8gdXJsT3JJcCA6IGBodHRwczovL2lwaW5mby5pby8ke3VybE9ySXB9YDsKICAgICAgICBhLnRhcmdldCA9ICdfYmxhbmsnOwogICAgICAgIGEucmVsID0gJ25vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3cnOwogICAgICAgIGEuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodXJsT3JJcCkpOwogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgaSA9IG0uaW5kZXggKyB1cmxPcklwLmxlbmd0aDsKICAgIH0KICAgIGlmIChpIDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQuc3Vic3RyaW5nKGkpKSk7CiAgICB9Cn0KY29uc3QgQU5BTFlUSUNTX0hUTUwxID0gaHRtbGAKPGRpdiBpZD0iYW5hbHl0aWNzIj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1oZWFkZXIiPgogICAgICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1oZWFkaW5nIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJhbmFseXRpY3Mtc3ViaGVhZGluZyIgY2xhc3M9Im1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLXF1ZXJ5aW5nIj48cHJvZ3Jlc3MgaWQ9ImFuYWx5dGljcy1wcm9ncmVzcyIgY2xhc3M9InB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIiPjwvcHJvZ3Jlc3M+PGRpdiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPkZldGNoaW5nIGFuYWx5dGljcy4uLjwvZGl2PjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLWVycm9yIiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLXRhYmxlIiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLW5hbWVzcGFjZXMtdGFibGUiICBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgPGRpdiBpZD0iYW5hbHl0aWNzLWZvb3Rub3RlIiBjbGFzcz0ibWVkaXVtLWVtcGhhc2lzLXRleHQiPjxzdXA+Kjwvc3VwPiBFc3RpbWF0ZWQgYmFzZWQgb24gcmVjZW50IHVzYWdlPC9kaXY+CjwvZGl2PgpgOwpjb25zdCBBTkFMWVRJQ1NfQ1NTID0gY3NzYAoKI2FuYWx5dGljcyB7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGhlaWdodDogMTAwdmg7CiAgICB3aWR0aDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgb3ZlcmZsb3cteTogc2Nyb2xsOwogICAgb3ZlcmZsb3cteDogaGlkZGVuOwogICAgZmxleC1ncm93OiAxOwogICAgZGlzcGxheTogbm9uZTsKfQoKI2FuYWx5dGljczo6LXdlYmtpdC1zY3JvbGxiYXIgewogICAgd2lkdGg6IDFyZW07CiAgICBoZWlnaHQ6IDNyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKI2FuYWx5dGljczo6LXdlYmtpdC1zY3JvbGxiYXItdGh1bWIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgojYW5hbHl0aWNzLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBwYWRkaW5nOiAxcmVtIDA7CiAgICBoZWlnaHQ6IDNyZW07Cn0KCiNhbmFseXRpY3Mtc3ViaGVhZGluZyB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKfQoKI2FuYWx5dGljcy1wcm9ncmVzcyB7CiAgICBmb250LXNpemU6IDAuNXJlbTsgLyogZGVmYXVsdCAzZW0gPT4gMS41cmVtICovCn0KCiNhbmFseXRpY3MtcXVlcnlpbmcgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBnYXA6IDAuNXJlbTsKfQoKI2FuYWx5dGljcyB0YWJsZSB7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgIGJvcmRlci1zcGFjaW5nOiAwLjM3NXJlbTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7Cn0KCiNhbmFseXRpY3MgdGggewogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgojYW5hbHl0aWNzIC5zcGFjZXIgewogICAgd2lkdGg6IDAuNzVyZW07Cn0KCiNhbmFseXRpY3MtdGFibGUgLmVzdGltYXRlIHRkIHsKICAgIHBhZGRpbmctdG9wOiAxcmVtOwp9CgojYW5hbHl0aWNzIC5tb25vIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1tb25vc3BhY2UtZm9udC1mYW1pbHkpOwp9CgojYW5hbHl0aWNzLW5hbWVzcGFjZXMtdGFibGUgewogICAgbWFyZ2luLXRvcDogMnJlbTsKfQoKI2FuYWx5dGljcy1uYW1lc3BhY2VzLXRhYmxlIGEudW5zZWxlY3RlZCB7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgI2FuYWx5dGljcy1uYW1lc3BhY2VzLXRhYmxlIGEudW5zZWxlY3RlZDpob3ZlciB7CiAgICAgICAgY29sb3I6IHZhcigtLXByaW1hcnktY29sb3IpOwogICAgfQp9CgojYW5hbHl0aWNzIC5sZWZ0LWFsaWduZWQgewogICAgdGV4dC1hbGlnbjogbGVmdDsKfQoKI2FuYWx5dGljcy1mb290bm90ZSB7CiAgICBtYXJnaW4tdG9wOiAxcmVtOwogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgZGlzcGxheTogbm9uZTsKfQoKYDsKZnVuY3Rpb24gaW5pdEFuYWx5dGljcyhkb2N1bWVudCwgdm0xNykgewogICAgY29uc3QgYW5hbHl0aWNzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcycpOwogICAgY29uc3QgYW5hbHl0aWNzSGVhZGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtaGVhZGluZycpOwogICAgY29uc3QgYW5hbHl0aWNzU3ViaGVhZGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3Mtc3ViaGVhZGluZycpOwogICAgY29uc3QgYW5hbHl0aWNzUXVlcnlpbmdFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy1xdWVyeWluZycpOwogICAgY29uc3QgYW5hbHl0aWNzRXJyb3JFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy1lcnJvcicpOwogICAgY29uc3QgYW5hbHl0aWNzVGFibGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy10YWJsZScpOwogICAgY29uc3QgYW5hbHl0aWNzTmFtZXNwYWNlc1RhYmxlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtbmFtZXNwYWNlcy10YWJsZScpOwogICAgY29uc3QgYW5hbHl0aWNzRm9vdG5vdGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FuYWx5dGljcy1mb290bm90ZScpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgYW5hbHl0aWNzRGl2LnN0eWxlLmRpc3BsYXkgPSB2bTE3LnNlbGVjdGVkQW5hbHl0aWNJZCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgaWYgKCF2bTE3LnNlbGVjdGVkQW5hbHl0aWNJZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHNlbGVjdGVkQW5hbHl0aWMgPSB2bTE3LmFuYWx5dGljcy5maW5kKCh2KT0+di5pZCA9PT0gdm0xNy5zZWxlY3RlZEFuYWx5dGljSWQKICAgICAgICApOwogICAgICAgIGlmICghc2VsZWN0ZWRBbmFseXRpYykgcmV0dXJuOwogICAgICAgIGFuYWx5dGljc0hlYWRpbmcudGV4dENvbnRlbnQgPSBzZWxlY3RlZEFuYWx5dGljLnRleHQ7CiAgICAgICAgYW5hbHl0aWNzU3ViaGVhZGluZy50ZXh0Q29udGVudCA9IHNlbGVjdGVkQW5hbHl0aWMuZGVzY3JpcHRpb24gfHwgJyc7CiAgICAgICAgY29uc3QgeyBkdXJhYmxlT2JqZWN0c0Nvc3RzICwgcXVlcnlpbmcgLCBlcnJvciAgfSA9IHZtMTcuYW5hbHl0aWNzU3RhdGU7CiAgICAgICAgYW5hbHl0aWNzUXVlcnlpbmdFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBxdWVyeWluZyA/ICdmbGV4JyA6ICdub25lJzsKICAgICAgICBhbmFseXRpY3NFcnJvckVsZW1lbnQudGV4dENvbnRlbnQgPSBlcnJvciB8fCAnJzsKICAgICAgICBhbmFseXRpY3NGb290bm90ZUVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IGR1cmFibGVPYmplY3RzQ29zdHMgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGlmIChkdXJhYmxlT2JqZWN0c0Nvc3RzKSB7CiAgICAgICAgICAgIGNvbnN0IHJlbmRlckNvc3RzID0gKG5hbWVzcGFjZUlkKT0+ewogICAgICAgICAgICAgICAgY29uc3QgdGFibGUgPSBkdXJhYmxlT2JqZWN0c0Nvc3RzLm5hbWVzcGFjZVRhYmxlc1tuYW1lc3BhY2VJZCB8fCAnJ10gfHwgZHVyYWJsZU9iamVjdHNDb3N0cy5hY2NvdW50VGFibGU7CiAgICAgICAgICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihDT1NUU19IVE1MKHRhYmxlLCBuYW1lc3BhY2VJZCksIGFuYWx5dGljc1RhYmxlRWxlbWVudCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJlbmRlckNvc3RzKHVuZGVmaW5lZCk7CiAgICAgICAgICAgIExpdEVsZW1lbnQucmVuZGVyKE5BTUVTUEFDRVNfSFRNTChkdXJhYmxlT2JqZWN0c0Nvc3RzLCByZW5kZXJDb3N0cyksIGFuYWx5dGljc05hbWVzcGFjZXNUYWJsZUVsZW1lbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIExpdEVsZW1lbnQucmVuZGVyKHVuZGVmaW5lZCwgYW5hbHl0aWNzVGFibGVFbGVtZW50KTsKICAgICAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIodW5kZWZpbmVkLCBhbmFseXRpY3NOYW1lc3BhY2VzVGFibGVFbGVtZW50KTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IEZJWEVEXzEgPSBuZXcgSW50bC5OdW1iZXJGb3JtYXQoJ2VuLVVTJywgewogICAgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAxLAogICAgbWluaW11bUZyYWN0aW9uRGlnaXRzOiAxCn0pOwpjb25zdCBGSVhFRF8yID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdlbi1VUycsIHsKICAgIG1heGltdW1GcmFjdGlvbkRpZ2l0czogMiwKICAgIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMgp9KTsKZnVuY3Rpb24gZm9ybWF0MSh2YWwpIHsKICAgIGlmICh2YWwgPCAxMDAwKSByZXR1cm4gdmFsLnRvU3RyaW5nKCk7CiAgICByZXR1cm4gYCR7RklYRURfMS5mb3JtYXQodmFsIC8gMTAwMCl9a2A7Cn0KZnVuY3Rpb24gZm9ybWF0Mih2YWwpIHsKICAgIGlmICh2YWwgPCAxMDAwKSByZXR1cm4gdmFsLnRvRml4ZWQoMik7CiAgICByZXR1cm4gYCR7RklYRURfMi5mb3JtYXQodmFsIC8gMTAwMCl9a2A7Cn0KZnVuY3Rpb24gZm9ybWF0R2IodmFsKSB7CiAgICBpZiAodmFsIDwgMSkgcmV0dXJuIGAke2Zvcm1hdDIodmFsICogMTAyNCl9bWJgOwogICAgcmV0dXJuIGAke2Zvcm1hdDIodmFsKX1nYmA7Cn0KZnVuY3Rpb24gY2xpY2tOYW1lc3BhY2UoZSwgcmVuZGVyQ29zdHMpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IHRleHQgPSBlLnRhcmdldC50ZXh0Q29udGVudCB8fCAnJzsKICAgIGNvbnNvbGUubG9nKCdjbGlja05hbWVzcGFjZScsIHRleHQpOwogICAgcmVuZGVyQ29zdHModGV4dC5zdGFydHNXaXRoKCdBbGwnKSA/IHVuZGVmaW5lZCA6IHRleHQpOwogICAgY29uc3QgYW5jaG9ycyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJyNhbmFseXRpY3MtbmFtZXNwYWNlcy10YWJsZSBhJyk7CiAgICBhbmNob3JzLmZvckVhY2goKGEpPT57CiAgICAgICAgYS5jbGFzc05hbWUgPSBhID09PSBlLnRhcmdldCA/ICcnIDogJ3Vuc2VsZWN0ZWQnOwogICAgfSk7Cn0KY29uc3QgTkFNRVNQQUNFU19IVE1MID0gKHRhYmxlLCByZW5kZXJDb3N0cyk9Pmh0bWxgCiAgICA8dGFibGU+CiAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+TmFtZXNwYWNlIElEPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoPlNjcmlwdDwvdGg+CiAgICAgICAgICAgIDx0aD5DbGFzczwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aD5Ub3RhbDwvdGg+CiAgICAgICAgPC90cj4KICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0ibGVmdC1hbGlnbmVkIG1vbm8iPjxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+Y2xpY2tOYW1lc3BhY2UoZSwgcmVuZGVyQ29zdHMpCiAgICB9PkFsbCBkdXJhYmxlIG9iamVjdHM8L2E+PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7KHRhYmxlLmFjY291bnRUYWJsZS5lc3RpbWF0ZWQzMERheVJvdz8udG90YWxDb3N0IHx8IDApLnRvRml4ZWQoMil9PC90ZD4KICAgICAgICA8L3RyPgogICAgJHtbCiAgICAgICAgLi4uT2JqZWN0LmVudHJpZXModGFibGUubmFtZXNwYWNlVGFibGVzKQogICAgXS5zb3J0KChhLCBiKT0+KGJbMV0uZXN0aW1hdGVkMzBEYXlSb3c/LnRvdGFsQ29zdCB8fCAwKSAtIChhWzFdLmVzdGltYXRlZDMwRGF5Um93Py50b3RhbENvc3QgfHwgMCkKICAgICkubWFwKCh2KT0+ewogICAgICAgIGNvbnN0IFtuYW1lc3BhY2VJZCwgdF0gPSB2OwogICAgICAgIHJldHVybiBodG1sYDx0cj4KICAgICAgICAgICAgPHRkIGNsYXNzPSJsZWZ0LWFsaWduZWQgbW9ubyI+PGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT5jbGlja05hbWVzcGFjZShlLCByZW5kZXJDb3N0cykKICAgICAgICB9IGNsYXNzPSJ1bnNlbGVjdGVkIj4ke25hbWVzcGFjZUlkfTwvYT48L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImxlZnQtYWxpZ25lZCI+JHt0Lm5hbWVzcGFjZT8uc2NyaXB0IHx8ICcnfTwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0ibGVmdC1hbGlnbmVkIj4ke3QubmFtZXNwYWNlPy5jbGFzcyB8fCAnJ308L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7KHQuZXN0aW1hdGVkMzBEYXlSb3c/LnRvdGFsQ29zdCB8fCAwKS50b0ZpeGVkKDIpfTwvdGQ+CiAgICAgICAgICAgIDwvdHI+YDsKICAgIH0pfQogICAgPC90YWJsZT4KYAo7CmNvbnN0IENPU1RTX0hUTUwgPSAodGFibGUsIG5hbWVzcGFjZUlkKT0+aHRtbGAKICAgIDx0YWJsZT4KICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5VVEMgRGF5PC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPlJlcXVlc3RzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjQiPldlYnNvY2tldHM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+U3VicmVxdWVzdHM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+RHVyYXRpb248L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+UmVhZHM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+V3JpdGVzPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPkRlbGV0ZXM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+U3RvcmFnZTwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aD5Ub3RhbDwvdGg+CiAgICAgICAgPC90cj4KICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoPk1heDwvdGg+CiAgICAgICAgICAgIDx0aD5JbjwvdGg+CiAgICAgICAgICAgIDx0aD5PdXQ8L3RoPgogICAgICAgICAgICA8dGg+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aD5HQi1zZWM8L3RoPgogICAgICAgICAgICA8dGg+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aD48L3RoPgogICAgICAgIDwvdHI+CiAgICAgICAgJHt0YWJsZS5yb3dzLm1hcCgodik9Pmh0bWxgPHRyPgogICAgICAgICAgICA8dGQ+JHt2LmRhdGV9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVJlcXVlc3RzKX08L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2Lm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zKX08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50KX08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi53ZWJzb2NrZXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVN1YnJlcXVlc3RzKX08L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LnN1YnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0Mih2LmFjdGl2ZUdiU2Vjb25kcyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5hY3RpdmVDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtU3RvcmFnZVJlYWRVbml0cyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5yZWFkVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtU3RvcmFnZVdyaXRlVW5pdHMpfTwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYud3JpdGVVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke2Zvcm1hdDEodi5zdW1TdG9yYWdlRGVsZXRlcyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5kZWxldGVzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7di5zdG9yYWdlR2IgPT09IHVuZGVmaW5lZCA/ICc/JyA6IGZvcm1hdEdiKHYuc3RvcmFnZUdiKX08L3RkPgogICAgICAgICAgICA8dGQ+JHt2LnN0b3JhZ2VDb3N0ID09PSB1bmRlZmluZWQgPyAnJyA6IGAkJHtmb3JtYXQyKHYuc3RvcmFnZUNvc3QpfWB9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi50b3RhbENvc3QpfTwvdGQ+CiAgICAgICAgPC90cj5gCiAgICApfQoKICAgICAgICAke3RhYmxlLmVzdGltYXRlZDMwRGF5Um93ID8gaHRtbGA8dHIgY2xhc3M9ImVzdGltYXRlIj4KICAgICAgICAgICAgPHRkPjMwLWRheSBiaWxsPHN1cD4qPC9zdXA+PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93LnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cud2Vic29ja2V0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy5zdWJyZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy5hY3RpdmVDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cucmVhZFVuaXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93LndyaXRlVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3cuZGVsZXRlc0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy5zdG9yYWdlQ29zdCB8fCAwKX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvdy50b3RhbENvc3QpfTwvdGQ+CiAgICAgICAgPC90cj5gIDogJyd9CiAgICAgICAgJHt0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZSA/IGh0bWxgPHRyPgogICAgICAgICAgICA8dGQ+4oiSIGZyZWUgdXNhZ2U8L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUucmVxdWVzdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS53ZWJzb2NrZXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLnN1YnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLmFjdGl2ZUNvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS5yZWFkVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuZXN0aW1hdGVkMzBEYXlSb3dNaW51c0ZyZWUud3JpdGVVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5lc3RpbWF0ZWQzMERheVJvd01pbnVzRnJlZS5kZWxldGVzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLnN0b3JhZ2VDb3N0IHx8IDApfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmVzdGltYXRlZDMwRGF5Um93TWludXNGcmVlLnRvdGFsQ29zdCl9PC90ZD4KICAgICAgICA8L3RyPmAgOiAnJ30KICAgIDwvdGFibGU+CmAKOwpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKCm1haW4gewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41cmVtOwp9Cgo6cm9vdCB7CiAgICAtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2I6IHJnYigxODcsIDEzNCwgMjUyKTsKfQoKLmhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwgewogICAgc2Nyb2xsYmFyLXdpZHRoOiBub25lOyAtbXMtb3ZlcmZsb3ctc3R5bGU6IG5vbmU7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7Cn0KCi5oaWRkZW4tdmVydGljYWwtc2Nyb2xsOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICBkaXNwbGF5OiBub25lOyAvKiBmb3IgQ2hyb21lLCBTYWZhcmksIGFuZCBPcGVyYSAqLwp9CgpgOwpjb25zdCBhcHBIdG1sID0gaHRtbGAKPG1haW4+CiR7U0lERUJBUl9IVE1MfQoke0NPTlNPTEVfSFRNTH0KJHtBTkFMWVRJQ1NfSFRNTDF9CiR7TU9EQUxfSFRNTH0KPC9tYWluPmA7CmZ1bmN0aW9uIGFwcGVuZFN0eWxlc2hlZXRzKGNzc1RleHRzKSB7CiAgICBjb25zdCBzdHlsZVNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgIHN0eWxlU2hlZXQudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgICBzdHlsZVNoZWV0LnRleHRDb250ZW50ID0gY3NzVGV4dHMuam9pbignXG5cbicpOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZVNoZWV0KTsKfQphcHBlbmRTdHlsZXNoZWV0cyhbCiAgICBNQVRFUklBTF9DU1MuY3NzVGV4dCwKICAgIGFwcENzcy5jc3NUZXh0LAogICAgSEVBREVSX0NTUy5jc3NUZXh0LAogICAgU0lERUJBUl9DU1MuY3NzVGV4dCwKICAgIENPTlNPTEVfQ1NTLmNzc1RleHQsCiAgICBBTkFMWVRJQ1NfQ1NTLmNzc1RleHQsCiAgICBNT0RBTF9DU1MuY3NzVGV4dCwKICAgIFdFTENPTUVfUEFORUxfQ1NTLmNzc1RleHQsCiAgICBQUk9GSUxFX0VESVRPUl9DU1MuY3NzVGV4dCwKICAgIEZJTFRFUl9FRElUT1JfQ1NTLmNzc1RleHQsCiAgICBDSVJDVUxBUl9QUk9HUkVTU19DU1MuY3NzVGV4dCwgCl0pOwpMaXRFbGVtZW50LnJlbmRlcihhcHBIdG1sLCBkb2N1bWVudC5ib2R5KTsKZnVuY3Rpb24gcGFyc2VTdGF0aWNEYXRhKCkgewogICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRpYy1kYXRhLXNjcmlwdCcpOwogICAgY29uc3QgZGF0YTEgPSBKU09OLnBhcnNlKHNjcmlwdC50ZXh0KTsKICAgIGNvbnN0IHZlcnNpb24gPSB0eXBlb2YgZGF0YTEudmVyc2lvbiA9PT0gJ3N0cmluZycgPyBkYXRhMS52ZXJzaW9uIDogdW5kZWZpbmVkOwogICAgY29uc3QgZmxhZ3MgPSB0eXBlb2YgZGF0YTEuZmxhZ3MgPT09ICdzdHJpbmcnID8gZGF0YTEuZmxhZ3MgOiB1bmRlZmluZWQ7CiAgICByZXR1cm4gewogICAgICAgIHZlcnNpb24sCiAgICAgICAgZmxhZ3MKICAgIH07Cn0KY29uc3QgZGF0YSA9IHBhcnNlU3RhdGljRGF0YSgpOwpjb25zdCB2bSA9IG5ldyBXZWJ0YWlsQXBwVk0oKTsKY29uc3QgdXBkYXRlU2lkZWJhciA9IGluaXRTaWRlYmFyKGRvY3VtZW50LCB2bSwgZGF0YSk7CmNvbnN0IHVwZGF0ZUNvbnNvbGUgPSBpbml0Q29uc29sZShkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVBbmFseXRpY3MgPSBpbml0QW5hbHl0aWNzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZU1vZGFsID0gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSk7CnZtLm9uQ2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZVNpZGViYXIoKTsKICAgIHVwZGF0ZUNvbnNvbGUoKTsKICAgIHVwZGF0ZUFuYWx5dGljcygpOwogICAgdXBkYXRlTW9kYWwoKTsKfTsKQ2xvdWRmbGFyZUFwaS5VUkxfVFJBTlNGT1JNRVIgPSBDZkdxbENsaWVudC5VUkxfVFJBTlNGT1JNRVIgPSAodik9PmAvZmV0Y2gvJHt2LnN1YnN0cmluZygnaHR0cHM6Ly8nLmxlbmd0aCl9YAo7CnZtLnN0YXJ0KCk7CnNldEFwcFN0YXRlKCdzdGFydGVkJyk7Cg==';