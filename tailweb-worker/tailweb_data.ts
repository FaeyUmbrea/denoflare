

export const TAILWEB_APP_HASH = 'c6c13a328dd4f0a3544710ff4f585817d232c9f5';
export const TAILWEB_APP_B64 = 'YXN5bmMgZnVuY3Rpb24gbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0c2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RTY3JpcHRzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdFRhaWxzKGFjY291bnRJZCwgc2NyaXB0TmFtZSwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpfS93b3JrZXJzL3NjcmlwdHMvJHtzY3JpcHROYW1lfS90YWlsc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RUYWlscycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnY3JlYXRlVGFpbCcsICdQT1NUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04JzsKY29uc3QgQVBQTElDQVRJT05fT0NURVRfU1RSRUFNID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmZ1bmN0aW9uIGNvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpIHsKICAgIHJldHVybiBDbG91ZGZsYXJlQXBpLlVSTF9UUkFOU0ZPUk1FUihgaHR0cHM6Ly9hcGkuY2xvdWRmbGFyZS5jb20vY2xpZW50L3Y0L2FjY291bnRzLyR7YWNjb3VudElkfWApOwp9CmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUob3AsIG1ldGhvZCwgdXJsLCBhcGlUb2tlbiwgYm9keSwgcmVzcG9uc2VUeXBlID0gJ2pzb24nKSB7CiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoewogICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaVRva2VufWAKICAgIH0pOwogICAgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykgewogICAgICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBBUFBMSUNBVElPTl9KU09OX1VURjgpOwogICAgICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhib2R5KTsKICAgIH0KICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZmV0Y2hSZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJykgfHwgJyc7CiAgICBpZiAoKHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzJyB8fCByZXNwb25zZVR5cGUgPT09ICdieXRlcz8nKSAmJiBjb250ZW50VHlwZSA9PT0gQVBQTElDQVRJT05fT0NURVRfU1RSRUFNKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4LAogICAgICAgIEFQUExJQ0FUSU9OX0pTT04KICAgIF0uaW5jbHVkZXMoY29udGVudFR5cGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRlbnQtdHlwZTogJHtjb250ZW50VHlwZX0sICBmZXRjaFJlc3BvbnNlPSR7ZmV0Y2hSZXNwb25zZX0sIGJvZHk9JHthd2FpdCBmZXRjaFJlc3BvbnNlLnRleHQoKX1gKTsKICAgIH0KICAgIGNvbnN0IGFwaVJlc3BvbnNlID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5qc29uKCk7CiAgICBpZiAoQ2xvdWRmbGFyZUFwaS5ERUJVRykgY29uc29sZS5sb2coYXBpUmVzcG9uc2UpOwogICAgaWYgKCFhcGlSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgaWYgKGZldGNoUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgJiYgcmVzcG9uc2VUeXBlID09PSAnYnl0ZXM/JykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB0aHJvdyBuZXcgQ2xvdWRmbGFyZUFwaUVycm9yKGAke29wfSBmYWlsZWQ6IHN0YXR1cz0ke2ZldGNoUmVzcG9uc2Uuc3RhdHVzfSwgZXJyb3JzPSR7YXBpUmVzcG9uc2UuZXJyb3JzLm1hcCgodik9PmAke3YuY29kZX0gJHt2Lm1lc3NhZ2V9YAogICAgICAgICkuam9pbignLCAnKX1gLCBmZXRjaFJlc3BvbnNlLnN0YXR1cywgYXBpUmVzcG9uc2UuZXJyb3JzKTsKICAgIH0KICAgIHJldHVybiBhcGlSZXNwb25zZTsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBzdGF0dXM7CiAgICBlcnJvcnM7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlMSwgc3RhdHVzLCBlcnJvcnMpewogICAgICAgIHN1cGVyKG1lc3NhZ2UxKTsKICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgIH0KfQpmdW5jdGlvbiBzZXRTdWJ0cmFjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KGxocyk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmhzKXsKICAgICAgICBydC5kZWxldGUoaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0VW5pb24obGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldChsaHMpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIHJocyl7CiAgICAgICAgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldEludGVyc2VjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgbGhzKXsKICAgICAgICBpZiAocmhzLmhhcyhpdGVtKSkgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgZm9yIChjb25zdCBpdGVtMSBvZiByaHMpewogICAgICAgIGlmIChsaHMuaGFzKGl0ZW0xKSkgcnQuYWRkKGl0ZW0xKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBzZXRFcXVhbChsaHMsIHJocykgewogICAgcmV0dXJuIGxocy5zaXplID09PSByaHMuc2l6ZSAmJiBbCiAgICAgICAgLi4ubGhzCiAgICBdLmV2ZXJ5KCh2KT0+cmhzLmhhcyh2KQogICAgKTsKfQpjb25zdCBkaXJlY3RpdmVzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgZGlyZWN0aXZlID0gKGYpPT4oLi4uYXJncyk9PnsKICAgICAgICBjb25zdCBkID0gZiguLi5hcmdzKTsKICAgICAgICBkaXJlY3RpdmVzLnNldChkLCB0cnVlKTsKICAgICAgICByZXR1cm4gZDsKICAgIH0KOwpjb25zdCBpc0RpcmVjdGl2ZSA9IChvKT0+ewogICAgcmV0dXJuIHR5cGVvZiBvID09PSAiZnVuY3Rpb24iICYmIGRpcmVjdGl2ZXMuaGFzKG8pOwp9Owpjb25zdCBpc0NFUG9seWZpbGwgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuY3VzdG9tRWxlbWVudHMgIT0gbnVsbCAmJiB3aW5kb3cuY3VzdG9tRWxlbWVudHMucG9seWZpbGxXcmFwRmx1c2hDYWxsYmFjayAhPT0gdm9pZCAwOwpjb25zdCByZXBhcmVudE5vZGVzID0gKGNvbnRhaW5lciwgc3RhcnQsIGVuZCA9IG51bGwsIGJlZm9yZSA9IG51bGwpPT57CiAgICB3aGlsZShzdGFydCAhPT0gZW5kKXsKICAgICAgICBjb25zdCBuID0gc3RhcnQubmV4dFNpYmxpbmc7CiAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShzdGFydCwgYmVmb3JlKTsKICAgICAgICBzdGFydCA9IG47CiAgICB9Cn07CmNvbnN0IHJlbW92ZU5vZGVzID0gKGNvbnRhaW5lciwgc3RhcnQsIGVuZCA9IG51bGwpPT57CiAgICB3aGlsZShzdGFydCAhPT0gZW5kKXsKICAgICAgICBjb25zdCBuID0gc3RhcnQubmV4dFNpYmxpbmc7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHN0YXJ0KTsKICAgICAgICBzdGFydCA9IG47CiAgICB9Cn07CmNvbnN0IG5vQ2hhbmdlID0gewp9Owpjb25zdCBub3RoaW5nID0gewp9Owpjb25zdCBtYXJrZXIgPSBge3tsaXQtJHtTdHJpbmcoTWF0aC5yYW5kb20oKSkuc2xpY2UoMil9fX1gOwpjb25zdCBub2RlTWFya2VyID0gYDwhLS0ke21hcmtlcn0tLT5gOwpjb25zdCBtYXJrZXJSZWdleCA9IG5ldyBSZWdFeHAoYCR7bWFya2VyfXwke25vZGVNYXJrZXJ9YCk7CmNvbnN0IGJvdW5kQXR0cmlidXRlU3VmZml4ID0gIiRsaXQkIjsKY2xhc3MgVGVtcGxhdGUgewogICAgY29uc3RydWN0b3IocmVzdWx0LCBlbGVtZW50NSl7CiAgICAgICAgdGhpcy5wYXJ0cyA9IFtdOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ1OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudDUuY29udGVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IGxhc3RQYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpbmRleCA9IC0xOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IHsgc3RyaW5nczogc3RyaW5nczUgLCB2YWx1ZXM6IHsgbGVuZ3RoICB9ICB9ID0gcmVzdWx0OwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IGxlbmd0aCl7CiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB3YWxrZXIubmV4dE5vZGUoKTsKICAgICAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IHN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZXMoKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBub2RlLmF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBsZW5ndGg6IGxlbmd0aDIgIH0gPSBhdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbmd0aDI7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbmRzV2l0aChhdHRyaWJ1dGVzW2ldLm5hbWUsIGJvdW5kQXR0cmlidXRlU3VmZml4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB3aGlsZShjb3VudC0tID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmluZ0ZvclBhcnQgPSBzdHJpbmdzNVtwYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4xIG9mIG5vZGVzVG9SZW1vdmUpewogICAgICAgICAgICBuMS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG4xKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleDEgPSBzdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aDsKICAgIHJldHVybiBpbmRleDEgPj0gMCAmJiBzdHIuc2xpY2UoaW5kZXgxKSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9uczIpewogICAgICAgIHRoaXMuX19wYXJ0cyA9IFtdOwogICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB0aGlzLnByb2Nlc3NvciA9IHByb2Nlc3NvcjsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zMjsKICAgIH0KICAgIHVwZGF0ZSh2YWx1ZXMpIHsKICAgICAgICBsZXQgaSA9IDA7CiAgICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBhcnQuc2V0VmFsdWUodmFsdWVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgcGFydDEgb2YgdGhpcy5fX3BhcnRzKXsKICAgICAgICAgICAgaWYgKHBhcnQxICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBhcnQxLmNvbW1pdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgX2Nsb25lKCkgewogICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaXNDRVBvbHlmaWxsID8gdGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpIDogZG9jdW1lbnQuaW1wb3J0Tm9kZSh0aGlzLnRlbXBsYXRlLmVsZW1lbnQuY29udGVudCwgdHJ1ZSk7CiAgICAgICAgY29uc3Qgc3RhY2sxID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIxID0gZG9jdW1lbnQuY3JlYXRlVHJlZVdhbGtlcihmcmFnbWVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IHBhcnRJbmRleDEgPSAwOwogICAgICAgIGxldCBub2RlSW5kZXggPSAwOwogICAgICAgIGxldCBwYXJ0OwogICAgICAgIGxldCBub2RlID0gd2Fsa2VyMS5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleDEgPCBwYXJ0czIubGVuZ3RoKXsKICAgICAgICAgICAgcGFydCA9IHBhcnRzMltwYXJ0SW5kZXgxXTsKICAgICAgICAgICAgaWYgKCFpc1RlbXBsYXRlUGFydEFjdGl2ZShwYXJ0KSkgewogICAgICAgICAgICAgICAgdGhpcy5fX3BhcnRzLnB1c2godm9pZCAwKTsKICAgICAgICAgICAgICAgIHBhcnRJbmRleDErKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrMS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlcjEuY3VycmVudE5vZGUgPSBub2RlLmNvbnRlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKG5vZGUgPSB3YWxrZXIxLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyMS5jdXJyZW50Tm9kZSA9IHN0YWNrMS5wb3AoKTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gd2Fsa2VyMS5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgxKys7CiAgICAgICAgfQogICAgICAgIGlmIChpc0NFUG9seWZpbGwpIHsKICAgICAgICAgICAgZG9jdW1lbnQuYWRvcHROb2RlKGZyYWdtZW50KTsKICAgICAgICAgICAgY3VzdG9tRWxlbWVudHMudXBncmFkZShmcmFnbWVudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmcmFnbWVudDsKICAgIH0KfQpjb25zdCBwb2xpY3kgPSB3aW5kb3cudHJ1c3RlZFR5cGVzICYmIHRydXN0ZWRUeXBlcy5jcmVhdGVQb2xpY3koImxpdC1odG1sIiwgewogICAgY3JlYXRlSFRNTDogKHMpPT5zCn0pOwpjb25zdCBjb21tZW50TWFya2VyID0gYCAke21hcmtlcn0gYDsKY2xhc3MgVGVtcGxhdGVSZXN1bHQgewogICAgY29uc3RydWN0b3Ioc3RyaW5nczEsIHZhbHVlcywgdHlwZTEsIHByb2Nlc3NvcjEpewogICAgICAgIHRoaXMuc3RyaW5ncyA9IHN0cmluZ3MxOwogICAgICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogICAgICAgIHRoaXMudHlwZSA9IHR5cGUxOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yMTsKICAgIH0KICAgIGdldEhUTUwoKSB7CiAgICAgICAgY29uc3QgbCA9IHRoaXMuc3RyaW5ncy5sZW5ndGggLSAxOwogICAgICAgIGxldCBodG1sMiA9ICIiOwogICAgICAgIGxldCBpc0NvbW1lbnRCaW5kaW5nID0gZmFsc2U7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIGNvbnN0IHMgPSB0aGlzLnN0cmluZ3NbaV07CiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnRPcGVuID0gcy5sYXN0SW5kZXhPZigiPCEtLSIpOwogICAgICAgICAgICBpc0NvbW1lbnRCaW5kaW5nID0gKGNvbW1lbnRPcGVuID4gLTEgfHwgaXNDb21tZW50QmluZGluZykgJiYgcy5pbmRleE9mKCItLT4iLCBjb21tZW50T3BlbiArIDEpID09PSAtMTsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlTWF0Y2ggPSBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4LmV4ZWMocyk7CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVNYXRjaCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcyArIChpc0NvbW1lbnRCaW5kaW5nID8gY29tbWVudE1hcmtlciA6IG5vZGVNYXJrZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcy5zdWJzdHIoMCwgYXR0cmlidXRlTWF0Y2guaW5kZXgpICsgYXR0cmlidXRlTWF0Y2hbMV0gKyBhdHRyaWJ1dGVNYXRjaFsyXSArIGJvdW5kQXR0cmlidXRlU3VmZml4ICsgYXR0cmlidXRlTWF0Y2hbM10gKyBtYXJrZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaHRtbDIgKz0gdGhpcy5zdHJpbmdzW2xdOwogICAgICAgIHJldHVybiBodG1sMjsKICAgIH0KICAgIGdldFRlbXBsYXRlRWxlbWVudCgpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZTEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZW1wbGF0ZSIpOwogICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZ2V0SFRNTCgpOwogICAgICAgIGlmIChwb2xpY3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YWx1ZSA9IHBvbGljeS5jcmVhdGVIVE1MKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGUxLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTE7CiAgICB9Cn0KY2xhc3MgU1ZHVGVtcGxhdGVSZXN1bHQgZXh0ZW5kcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBnZXRIVE1MKCkgewogICAgICAgIHJldHVybiBgPHN2Zz4ke3N1cGVyLmdldEhUTUwoKX08L3N2Zz5gOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlMSA9IHN1cGVyLmdldFRlbXBsYXRlRWxlbWVudCgpOwogICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0ZW1wbGF0ZTEuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTE7CiAgICB9Cn0KY29uc3QgaXNQcmltaXRpdmUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgISh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIik7Cn07CmNvbnN0IGlzSXRlcmFibGUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgISEodmFsdWUgJiYgdmFsdWVbU3ltYm9sLml0ZXJhdG9yXSk7Cn07CmNsYXNzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50MSwgbmFtZTMsIHN0cmluZ3MyKXsKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50MTsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lMzsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzMjsKICAgICAgICB0aGlzLnBhcnRzID0gW107CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHN0cmluZ3MyLmxlbmd0aCAtIDE7IGkrKyl7CiAgICAgICAgICAgIHRoaXMucGFydHNbaV0gPSB0aGlzLl9jcmVhdGVQYXJ0KCk7CiAgICAgICAgfQogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBdHRyaWJ1dGVQYXJ0KHRoaXMpOwogICAgfQogICAgX2dldFZhbHVlKCkgewogICAgICAgIGNvbnN0IHN0cmluZ3MzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzMy5sZW5ndGggLSAxOwogICAgICAgIGNvbnN0IHBhcnRzMiA9IHRoaXMucGFydHM7CiAgICAgICAgaWYgKGwgPT09IDEgJiYgc3RyaW5nczNbMF0gPT09ICIiICYmIHN0cmluZ3MzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpMSA9IDA7IGkxIDwgbDsgaTErKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nczNbaTFdOwogICAgICAgICAgICBjb25zdCBwYXJ0ID0gcGFydHMyW2kxXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3MzW2xdOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsIHRoaXMuX2dldFZhbHVlKCkpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBBdHRyaWJ1dGVQYXJ0IHsKICAgIGNvbnN0cnVjdG9yKGNvbW1pdHRlcil7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmNvbW1pdHRlciA9IGNvbW1pdHRlcjsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBub0NoYW5nZSAmJiAoIWlzUHJpbWl0aXZlKHZhbHVlKSB8fCB2YWx1ZSAhPT0gdGhpcy52YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoIWlzRGlyZWN0aXZlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhpcy5jb21taXR0ZXIuZGlydHkgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMudmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMudmFsdWU7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5jb21taXR0ZXIuY29tbWl0KCk7CiAgICB9Cn0KY2xhc3MgTm9kZVBhcnQgewogICAgY29uc3RydWN0b3Iob3B0aW9uczEpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zMTsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUxID0gdGhpcy5vcHRpb25zLnRlbXBsYXRlRmFjdG9yeSh2YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZUluc3RhbmNlICYmIHRoaXMudmFsdWUudGVtcGxhdGUgPT09IHRlbXBsYXRlMSkgewogICAgICAgICAgICB0aGlzLnZhbHVlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gbmV3IFRlbXBsYXRlSW5zdGFuY2UodGVtcGxhdGUxLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXgxID0gMDsKICAgICAgICBsZXQgaXRlbVBhcnQ7CiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbHVlKXsKICAgICAgICAgICAgaXRlbVBhcnQgPSBpdGVtUGFydHNbcGFydEluZGV4MV07CiAgICAgICAgICAgIGlmIChpdGVtUGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpdGVtUGFydCA9IG5ldyBOb2RlUGFydCh0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgaXRlbVBhcnRzLnB1c2goaXRlbVBhcnQpOwogICAgICAgICAgICAgICAgaWYgKHBhcnRJbmRleDEgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXgxIC0gMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGl0ZW1QYXJ0LnNldFZhbHVlKGl0ZW0pOwogICAgICAgICAgICBpdGVtUGFydC5jb21taXQoKTsKICAgICAgICAgICAgcGFydEluZGV4MSsrOwogICAgICAgIH0KICAgICAgICBpZiAocGFydEluZGV4MSA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDE7CiAgICAgICAgICAgIHRoaXMuY2xlYXIoaXRlbVBhcnQgJiYgaXRlbVBhcnQuZW5kTm9kZSk7CiAgICAgICAgfQogICAgfQogICAgY2xlYXIoc3RhcnROb2RlID0gdGhpcy5zdGFydE5vZGUpIHsKICAgICAgICByZW1vdmVOb2Rlcyh0aGlzLnN0YXJ0Tm9kZS5wYXJlbnROb2RlLCBzdGFydE5vZGUubmV4dFNpYmxpbmcsIHRoaXMuZW5kTm9kZSk7CiAgICB9Cn0KY2xhc3MgQm9vbGVhbkF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudDIsIG5hbWUxLCBzdHJpbmdzMyl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIGlmIChzdHJpbmdzMy5sZW5ndGggIT09IDIgfHwgc3RyaW5nczNbMF0gIT09ICIiIHx8IHN0cmluZ3MzWzFdICE9PSAiIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJvb2xlYW4gYXR0cmlidXRlcyBjYW4gb25seSBjb250YWluIGEgc2luZ2xlIGV4cHJlc3Npb24iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDI7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTE7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczM7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZhbHVlID0gISF0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUodGhpcy5uYW1lLCAiIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICB9Cn0KY2xhc3MgUHJvcGVydHlDb21taXR0ZXIgZXh0ZW5kcyBBdHRyaWJ1dGVDb21taXR0ZXIgewogICAgY29uc3RydWN0b3IoZWxlbWVudDMsIG5hbWUyLCBzdHJpbmdzNCl7CiAgICAgICAgc3VwZXIoZWxlbWVudDMsIG5hbWUyLCBzdHJpbmdzNCk7CiAgICAgICAgdGhpcy5zaW5nbGUgPSBzdHJpbmdzNC5sZW5ndGggPT09IDIgJiYgc3RyaW5nczRbMF0gPT09ICIiICYmIHN0cmluZ3M0WzFdID09PSAiIjsKICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgUHJvcGVydHlQYXJ0KHRoaXMpOwogICAgfQogICAgX2dldFZhbHVlKCkgewogICAgICAgIGlmICh0aGlzLnNpbmdsZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJ0c1swXS52YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRWYWx1ZSgpOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50W3RoaXMubmFtZV0gPSB0aGlzLl9nZXRWYWx1ZSgpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBQcm9wZXJ0eVBhcnQgZXh0ZW5kcyBBdHRyaWJ1dGVQYXJ0IHsKfQpsZXQgZXZlbnRPcHRpb25zU3VwcG9ydGVkID0gZmFsc2U7CigoKT0+ewogICAgdHJ5IHsKICAgICAgICBjb25zdCBvcHRpb25zMiA9IHsKICAgICAgICAgICAgZ2V0IGNhcHR1cmUgKCkgewogICAgICAgICAgICAgICAgZXZlbnRPcHRpb25zU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zMiwgb3B0aW9uczIpOwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9uczIsIG9wdGlvbnMyKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50NCwgZXZlbnROYW1lLCBldmVudENvbnRleHQpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50NDsKICAgICAgICB0aGlzLmV2ZW50TmFtZSA9IGV2ZW50TmFtZTsKICAgICAgICB0aGlzLmV2ZW50Q29udGV4dCA9IGV2ZW50Q29udGV4dDsKICAgICAgICB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCA9IChlKT0+dGhpcy5oYW5kbGVFdmVudChlKQogICAgICAgIDsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmV3TGlzdGVuZXIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGNvbnN0IG9sZExpc3RlbmVyID0gdGhpcy52YWx1ZTsKICAgICAgICBjb25zdCBzaG91bGRSZW1vdmVMaXN0ZW5lciA9IG5ld0xpc3RlbmVyID09IG51bGwgfHwgb2xkTGlzdGVuZXIgIT0gbnVsbCAmJiAobmV3TGlzdGVuZXIuY2FwdHVyZSAhPT0gb2xkTGlzdGVuZXIuY2FwdHVyZSB8fCBuZXdMaXN0ZW5lci5vbmNlICE9PSBvbGRMaXN0ZW5lci5vbmNlIHx8IG5ld0xpc3RlbmVyLnBhc3NpdmUgIT09IG9sZExpc3RlbmVyLnBhc3NpdmUpOwogICAgICAgIGNvbnN0IHNob3VsZEFkZExpc3RlbmVyID0gbmV3TGlzdGVuZXIgIT0gbnVsbCAmJiAob2xkTGlzdGVuZXIgPT0gbnVsbCB8fCBzaG91bGRSZW1vdmVMaXN0ZW5lcik7CiAgICAgICAgaWYgKHNob3VsZFJlbW92ZUxpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkQWRkTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5fX29wdGlvbnMgPSBnZXRPcHRpb25zKG5ld0xpc3RlbmVyKTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWUgPSBuZXdMaXN0ZW5lcjsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICB9CiAgICBoYW5kbGVFdmVudChldmVudCkgewogICAgICAgIGlmICh0eXBlb2YgdGhpcy52YWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLnZhbHVlLmNhbGwodGhpcy5ldmVudENvbnRleHQgfHwgdGhpcy5lbGVtZW50LCBldmVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5oYW5kbGVFdmVudChldmVudCk7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGdldE9wdGlvbnMgPSAobyk9Pm8gJiYgKGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA/IHsKICAgICAgICBjYXB0dXJlOiBvLmNhcHR1cmUsCiAgICAgICAgcGFzc2l2ZTogby5wYXNzaXZlLAogICAgICAgIG9uY2U6IG8ub25jZQogICAgfSA6IG8uY2FwdHVyZSkKOwpjbGFzcyBEZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgewogICAgaGFuZGxlQXR0cmlidXRlRXhwcmVzc2lvbnMoZWxlbWVudCwgbmFtZSwgc3RyaW5ncywgb3B0aW9ucykgewogICAgICAgIGNvbnN0IHByZWZpeCA9IG5hbWVbMF07CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIi4iKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbW1pdHRlcjIgPSBuZXcgUHJvcGVydHlDb21taXR0ZXIoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncyk7CiAgICAgICAgICAgIHJldHVybiBjb21taXR0ZXIyLnBhcnRzOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiQCIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBFdmVudFBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgb3B0aW9ucy5ldmVudENvbnRleHQpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICI/IikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEJvb2xlYW5BdHRyaWJ1dGVQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbW1pdHRlcjEgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIxLnBhcnRzOwogICAgfQogICAgaGFuZGxlVGV4dEV4cHJlc3Npb24ob3B0aW9ucykgewogICAgICAgIHJldHVybiBuZXcgTm9kZVBhcnQob3B0aW9ucyk7CiAgICB9Cn0KY29uc3QgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yID0gbmV3IERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcigpOwpmdW5jdGlvbiB0ZW1wbGF0ZUZhY3RvcnkocmVzdWx0MSkgewogICAgbGV0IHRlbXBsYXRlQ2FjaGUgPSB0ZW1wbGF0ZUNhY2hlcy5nZXQocmVzdWx0MS50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0MS50eXBlLCB0ZW1wbGF0ZUNhY2hlKTsKICAgIH0KICAgIGxldCB0ZW1wbGF0ZTEgPSB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5nZXQocmVzdWx0MS5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZTEgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiB0ZW1wbGF0ZTE7CiAgICB9CiAgICBjb25zdCBrZXkgPSByZXN1bHQxLnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUxID0gdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuZ2V0KGtleSk7CiAgICBpZiAodGVtcGxhdGUxID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZTEgPSBuZXcgVGVtcGxhdGUocmVzdWx0MSwgcmVzdWx0MS5nZXRUZW1wbGF0ZUVsZW1lbnQoKSk7CiAgICAgICAgdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuc2V0KGtleSwgdGVtcGxhdGUxKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQxLnN0cmluZ3MsIHRlbXBsYXRlMSk7CiAgICByZXR1cm4gdGVtcGxhdGUxOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQxLCBjb250YWluZXIsIG9wdGlvbnMzKT0+ewogICAgbGV0IHBhcnQgPSBwYXJ0cy5nZXQoY29udGFpbmVyKTsKICAgIGlmIChwYXJ0ID09PSB2b2lkIDApIHsKICAgICAgICByZW1vdmVOb2Rlcyhjb250YWluZXIsIGNvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICBwYXJ0cy5zZXQoY29udGFpbmVyLCBwYXJ0ID0gbmV3IE5vZGVQYXJ0KE9iamVjdC5hc3NpZ24oewogICAgICAgICAgICB0ZW1wbGF0ZUZhY3RvcnkKICAgICAgICB9LCBvcHRpb25zMykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0MSk7CiAgICBwYXJ0LmNvbW1pdCgpOwp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIxLjQuMSIpOwp9CmNvbnN0IGh0bWwgPSAoc3RyaW5nczYsIC4uLnZhbHVlczEpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5nczYsIHZhbHVlczEsICJodG1sIiwgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKQo7CmNvbnN0IHN2ZyA9IChzdHJpbmdzNiwgLi4udmFsdWVzMSk9Pm5ldyBTVkdUZW1wbGF0ZVJlc3VsdChzdHJpbmdzNiwgdmFsdWVzMSwgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcyksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHNbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlMiA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlciB8fCBkZWZhdWx0Q29udmVydGVyOwogICAgICAgIGNvbnN0IGZyb21BdHRyaWJ1dGUgPSB0eXBlb2YgY29udmVydGVyID09PSAiZnVuY3Rpb24iID8gY29udmVydGVyIDogY29udmVydGVyLmZyb21BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGZyb21BdHRyaWJ1dGUgPyBmcm9tQXR0cmlidXRlKHZhbHVlLCB0eXBlMikgOiB2YWx1ZTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKG9wdGlvbnMucmVmbGVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHlwZTIgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlMik7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gMDsKICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlcyk9PnRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSByZXMKICAgICAgICApOwogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbCgpOwogICAgfQogICAgX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKF92LCBwKT0+ewogICAgICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW3BdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5zZXQocCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBfYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT50aGlzW3BdID0gdgogICAgICAgICk7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgdGhpcy5lbmFibGVVcGRhdGluZygpOwogICAgfQogICAgZW5hYmxlVXBkYXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyKCk7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSB2b2lkIDA7CiAgICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICB9CiAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkLCB2YWx1ZSkgewogICAgICAgIGlmIChvbGQgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9wcm9wZXJ0eVRvQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBhdHRyID0gY3Rvci5fYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgYXR0clZhbHVlID0gY3Rvci5fcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKGF0dHIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoYXR0ciwgYXR0clZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgIH0KICAgIH0KICAgIF9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBwcm9wTmFtZSA9IGN0b3IuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuZ2V0KG5hbWUpOwogICAgICAgIGlmIChwcm9wTmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMzID0gY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMocHJvcE5hbWUpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICAgICAgdGhpc1twcm9wTmFtZV0gPSBjdG9yLl9wcm9wZXJ0eVZhbHVlRnJvbUF0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9uczMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0MSA9IHRoaXMucGVyZm9ybVVwZGF0ZSgpOwogICAgICAgIGlmIChyZXN1bHQxICE9IG51bGwpIHsKICAgICAgICAgICAgYXdhaXQgcmVzdWx0MTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgbGVnYWN5Q3VzdG9tRWxlbWVudCA9ICh0YWdOYW1lLCBjbGF6eik9PnsKICAgIHdpbmRvdy5jdXN0b21FbGVtZW50cy5kZWZpbmUodGFnTmFtZSwgY2xhenopOwogICAgcmV0dXJuIGNsYXp6Owp9Owpjb25zdCBzdGFuZGFyZEN1c3RvbUVsZW1lbnQgPSAodGFnTmFtZSwgZGVzY3JpcHRvcik9PnsKICAgIGNvbnN0IHsga2luZCAsIGVsZW1lbnRzICB9ID0gZGVzY3JpcHRvcjsKICAgIHJldHVybiB7CiAgICAgICAga2luZCwKICAgICAgICBlbGVtZW50cywKICAgICAgICBmaW5pc2hlciAoY2xhenopIHsKICAgICAgICAgICAgd2luZG93LmN1c3RvbUVsZW1lbnRzLmRlZmluZSh0YWdOYW1lLCBjbGF6eik7CiAgICAgICAgfQogICAgfTsKfTsKY29uc3Qgc3RhbmRhcmRQcm9wZXJ0eSA9IChvcHRpb25zMywgZWxlbWVudDYpPT57CiAgICBpZiAoZWxlbWVudDYua2luZCA9PT0gIm1ldGhvZCIgJiYgZWxlbWVudDYuZGVzY3JpcHRvciAmJiAhKCJ2YWx1ZSIgaW4gZWxlbWVudDYuZGVzY3JpcHRvcikpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHsKICAgICAgICB9LCBlbGVtZW50NiksIHsKICAgICAgICAgICAgZmluaXNoZXIgKGNsYXp6KSB7CiAgICAgICAgICAgICAgICBjbGF6ei5jcmVhdGVQcm9wZXJ0eShlbGVtZW50Ni5rZXksIG9wdGlvbnMzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBraW5kOiAiZmllbGQiLAogICAgICAgICAgICBrZXk6IFN5bWJvbCgpLAogICAgICAgICAgICBwbGFjZW1lbnQ6ICJvd24iLAogICAgICAgICAgICBkZXNjcmlwdG9yOiB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGluaXRpYWxpemVyICgpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudDYuaW5pdGlhbGl6ZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzW2VsZW1lbnQ2LmtleV0gPSBlbGVtZW50Ni5pbml0aWFsaXplci5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBmaW5pc2hlciAoY2xhenopIHsKICAgICAgICAgICAgICAgIGNsYXp6LmNyZWF0ZVByb3BlcnR5KGVsZW1lbnQ2LmtleSwgb3B0aW9uczMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KfTsKY29uc3QgbGVnYWN5UHJvcGVydHkgPSAob3B0aW9uczMsIHByb3RvLCBuYW1lNCk9PnsKICAgIHByb3RvLmNvbnN0cnVjdG9yLmNyZWF0ZVByb3BlcnR5KG5hbWU0LCBvcHRpb25zMyk7Cn07CmNvbnN0IGxlZ2FjeVF1ZXJ5ID0gKGRlc2NyaXB0b3IsIHByb3RvLCBuYW1lNCk9PnsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywgbmFtZTQsIGRlc2NyaXB0b3IpOwp9Owpjb25zdCBzdGFuZGFyZEV2ZW50T3B0aW9ucyA9IChvcHRpb25zMywgZWxlbWVudDYpPT57CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHsKICAgIH0sIGVsZW1lbnQ2KSwgewogICAgICAgIGZpbmlzaGVyIChjbGF6eikgewogICAgICAgICAgICBPYmplY3QuYXNzaWduKGNsYXp6LnByb3RvdHlwZVtlbGVtZW50Ni5rZXldLCBvcHRpb25zMyk7CiAgICAgICAgfQogICAgfSk7Cn07CmNvbnN0IGxlZ2FjeUV2ZW50T3B0aW9ucyA9IChvcHRpb25zMywgcHJvdG8sIG5hbWU0KT0+ewogICAgT2JqZWN0LmFzc2lnbihwcm90b1tuYW1lNF0sIG9wdGlvbnMzKTsKfTsKY29uc3Qgc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzID0gd2luZG93LlNoYWRvd1Jvb3QgJiYgKHdpbmRvdy5TaGFkeUNTUyA9PT0gdm9pZCAwIHx8IHdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpICYmICJhZG9wdGVkU3R5bGVTaGVldHMiIGluIERvY3VtZW50LnByb3RvdHlwZSAmJiAicmVwbGFjZSIgaW4gQ1NTU3R5bGVTaGVldC5wcm90b3R5cGU7CmNvbnN0IGNvbnN0cnVjdGlvblRva2VuID0gU3ltYm9sKCk7CmNsYXNzIENTU1Jlc3VsdCB7CiAgICBjb25zdHJ1Y3Rvcihjc3NUZXh0LCBzYWZlVG9rZW4pewogICAgICAgIGlmIChzYWZlVG9rZW4gIT09IGNvbnN0cnVjdGlvblRva2VuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ1NTUmVzdWx0IGlzIG5vdCBjb25zdHJ1Y3RhYmxlLiBVc2UgYHVuc2FmZUNTU2Agb3IgYGNzc2AgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgIH0KICAgIGdldCBzdHlsZVNoZWV0KCkgewogICAgICAgIGlmICh0aGlzLl9zdHlsZVNoZWV0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0LnJlcGxhY2VTeW5jKHRoaXMuY3NzVGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmNzc1RleHQ7CiAgICB9Cn0KY29uc3QgdW5zYWZlQ1NTID0gKHZhbHVlKT0+ewogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoU3RyaW5nKHZhbHVlKSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owpjb25zdCB0ZXh0RnJvbUNTU1Jlc3VsdCA9ICh2YWx1ZSk9PnsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENTU1Jlc3VsdCkgewogICAgICAgIHJldHVybiB2YWx1ZS5jc3NUZXh0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZhbHVlIHBhc3NlZCB0byAnY3NzJyBmdW5jdGlvbiBtdXN0IGJlIGEgJ2NzcycgZnVuY3Rpb24gcmVzdWx0OiAke3ZhbHVlfS4gVXNlICd1bnNhZmVDU1MnIHRvIHBhc3Mgbm9uLWxpdGVyYWwgdmFsdWVzLCBidXQKICAgICAgICAgICAgdGFrZSBjYXJlIHRvIGVuc3VyZSBwYWdlIHNlY3VyaXR5LmApOwogICAgfQp9Owpjb25zdCBjc3MgPSAoc3RyaW5nczYsIC4uLnZhbHVlczEpPT57CiAgICBjb25zdCBjc3NUZXh0MSA9IHZhbHVlczEucmVkdWNlKChhY2MsIHYsIGlkeCk9PmFjYyArIHRleHRGcm9tQ1NTUmVzdWx0KHYpICsgc3RyaW5nczZbaWR4ICsgMV0KICAgICwgc3RyaW5nczZbMF0pOwogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoY3NzVGV4dDEsIGNvbnN0cnVjdGlvblRva2VuKTsKfTsKKHdpbmRvd1sibGl0RWxlbWVudFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0RWxlbWVudFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjIuNS4xIik7CmNvbnN0IHJlbmRlck5vdEltcGxlbWVudGVkID0gewp9OwpjbGFzcyBMaXRFbGVtZW50IGV4dGVuZHMgVXBkYXRpbmdFbGVtZW50IHsKICAgIHN0YXRpYyBnZXRTdHlsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3R5bGVzOwogICAgfQogICAgc3RhdGljIF9nZXRVbmlxdWVTdHlsZXMoKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX3N0eWxlcyIsIHRoaXMpKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVzZXJTdHlsZXMgPSB0aGlzLmdldFN0eWxlcygpOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHVzZXJTdHlsZXMpKSB7CiAgICAgICAgICAgIGNvbnN0IGFkZFN0eWxlcyA9IChzdHlsZXMyLCBzZXQyKT0+c3R5bGVzMi5yZWR1Y2VSaWdodCgoc2V0Mywgcyk9PkFycmF5LmlzQXJyYXkocykgPyBhZGRTdHlsZXMocywgc2V0MykgOiAoc2V0My5hZGQocyksIHNldDMpCiAgICAgICAgICAgICAgICAsIHNldDIpCiAgICAgICAgICAgIDsKICAgICAgICAgICAgY29uc3Qgc2V0ID0gYWRkU3R5bGVzKHVzZXJTdHlsZXMsIG5ldyBTZXQoKSk7CiAgICAgICAgICAgIGNvbnN0IHN0eWxlcyA9IFtdOwogICAgICAgICAgICBzZXQuZm9yRWFjaCgodik9PnN0eWxlcy51bnNoaWZ0KHYpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlcyA9IHN0eWxlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSB1c2VyU3R5bGVzID09PSB2b2lkIDAgPyBbXSA6IFsKICAgICAgICAgICAgICAgIHVzZXJTdHlsZXMKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fc3R5bGVzID0gdGhpcy5fc3R5bGVzLm1hcCgocyk9PnsKICAgICAgICAgICAgaWYgKHMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ICYmICFzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1RleHQxID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gczsKICAgICAgICB9KTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgc3VwZXIuaW5pdGlhbGl6ZSgpOwogICAgICAgIHRoaXMuY29uc3RydWN0b3IuX2dldFVuaXF1ZVN0eWxlcygpOwogICAgICAgIHRoaXMucmVuZGVyUm9vdCA9IHRoaXMuY3JlYXRlUmVuZGVyUm9vdCgpOwogICAgICAgIGlmICh3aW5kb3cuU2hhZG93Um9vdCAmJiB0aGlzLnJlbmRlclJvb3QgaW5zdGFuY2VvZiB3aW5kb3cuU2hhZG93Um9vdCkgewogICAgICAgICAgICB0aGlzLmFkb3B0U3R5bGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY3JlYXRlUmVuZGVyUm9vdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hTaGFkb3codGhpcy5jb25zdHJ1Y3Rvci5zaGFkb3dSb290T3B0aW9ucyk7CiAgICB9CiAgICBhZG9wdFN0eWxlcygpIHsKICAgICAgICBjb25zdCBzdHlsZXMgPSB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXM7CiAgICAgICAgaWYgKHN0eWxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAod2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDAgJiYgIXdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLlNjb3BpbmdTaGltLnByZXBhcmVBZG9wdGVkQ3NzVGV4dChzdHlsZXMubWFwKChzKT0+cy5jc3NUZXh0CiAgICAgICAgICAgICksIHRoaXMubG9jYWxOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYWRvcHRlZFN0eWxlU2hlZXRzID0gc3R5bGVzLm1hcCgocyk9PnMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ID8gcyA6IHMuc3R5bGVTaGVldAogICAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IHRydWU7CiAgICAgICAgfQogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgc3VwZXIuY29ubmVjdGVkQ2FsbGJhY2soKTsKICAgICAgICBpZiAodGhpcy5oYXNVcGRhdGVkICYmIHdpbmRvdy5TaGFkeUNTUyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHdpbmRvdy5TaGFkeUNTUy5zdHlsZUVsZW1lbnQodGhpcyk7CiAgICAgICAgfQogICAgfQogICAgdXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGVSZXN1bHQgPSB0aGlzLnJlbmRlcigpOwogICAgICAgIHN1cGVyLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgaWYgKHRlbXBsYXRlUmVzdWx0ICE9PSByZW5kZXJOb3RJbXBsZW1lbnRlZCkgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnJlbmRlcih0ZW1wbGF0ZVJlc3VsdCwgdGhpcy5yZW5kZXJSb290LCB7CiAgICAgICAgICAgICAgICBzY29wZU5hbWU6IHRoaXMubG9jYWxOYW1lLAogICAgICAgICAgICAgICAgZXZlbnRDb250ZXh0OiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXMuZm9yRWFjaCgocyk9PnsKICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICAgICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcy5jc3NUZXh0OwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJSb290LmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmVuZGVyKCkgewogICAgICAgIHJldHVybiByZW5kZXJOb3RJbXBsZW1lbnRlZDsKICAgIH0KfQpMaXRFbGVtZW50WyJmaW5hbGl6ZWQiXSA9IHRydWU7CkxpdEVsZW1lbnQucmVuZGVyID0gcmVuZGVyOwpMaXRFbGVtZW50LnNoYWRvd1Jvb3RPcHRpb25zID0gewogICAgbW9kZTogIm9wZW4iCn07CmNsYXNzIE1hdGVyaWFsIHsKICAgIHN0YXRpYyBoaWdoRW1waGFzaXNUZXh0Q29sb3IgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjg3KSc7CiAgICBzdGF0aWMgbWVkaXVtRW1waGFzaXNUZXh0Q29sb3IgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKSc7Cn0KY29uc3QgTUFURVJJQUxfQ1NTID0gY3NzYAoKOnJvb3QgewogIC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yOiByZ2IoMzAuNzUsIDMwLjc1LCAzMC43NSk7CiAgLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3I6IHJnYig0MC45NSwgNDAuOTUsIDQwLjk1KTsKICAtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjg3KTsKICAtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNjApOwogIC0tZGlzYWJsZWQtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjM4KTsKICAtLWJ1dHRvbi1ib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogIC0tcHJpbWFyeS1jb2xvcjogI2JiODZmYzsKICAtLWJhY2tncm91bmQtY29sb3I6ICMxMjEyMTI7CiAgLS1zYW5zLXNlcmlmLWZvbnQtZmFtaWx5OiAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsIGF2ZW5pciBuZXh0LCBhdmVuaXIsIGhlbHZldGljYSBuZXVlLCBoZWx2ZXRpY2EsIFVidW50dSwgcm9ib3RvLCBub3RvLCBzZWdvZSB1aSwgYXJpYWwsIHNhbnMtc2VyaWY7CiAgLS1tb25vc3BhY2UtZm9udC1mYW1pbHk6IE1lbmxvLCBDb25zb2xhcywgdWktbW9ub3NwYWNlLCBtb25vc3BhY2U7Cn0KCi8qKiB0ZXh0IHNpemUgY2xhc3NlcyAqLwoKLmg2IHsKICAgIGZvbnQtc2l6ZTogMS4yNXJlbTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjAwNzUwcmVtOwogICAgZm9udC13ZWlnaHQ6IGJvbGRlcjsKfQoKLmJvZHkyLCBmaWVsZHNldCBsYWJlbCwgZmllbGRzZXQgb3V0cHV0LCBmaWVsZHNldCBkZXRhaWxzIHsKICAgIGZvbnQtc2l6ZTogMC44NzVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMTc4NnJlbTsKICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7CiAgICBsaW5lLWhlaWdodDogMS4yNXJlbTsKfQoKLmJ1dHRvbiwgYnV0dG9uLCAuYWN0aW9uLWljb24gewogICAgZm9udC1zaXplOiAwLjg3NXJlbTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMC4wODkyOXJlbTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkZXI7Cn0KCi5vdmVybGluZSB7CiAgICBmb250LXNpemU6IDAuNjI1cmVtOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjE1MDAwcmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKfQoKLmNhcHRpb24gewogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDMzMzNyZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwp9CgovKiBsaWdodCB0ZXh0IG9uIGRhcmsgYmFja2dyb3VuZCBjb2xvcnMgKi8KCi5oaWdoLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCi5tZWRpdW0tZW1waGFzaXMtdGV4dCwgZmllbGRzZXQgbGFiZWwgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKLmRpc2FibGVkLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgovKiogZWxldmF0aW9uIGJhY2tncm91bmRzICovCgouc3VyZmFjZS0wMSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwp9Cgouc3VyZmFjZS0wNCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwp9CgovKiogYWN0aW9uLWljb24gKi8KCi5hY3Rpb24taWNvbiB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgbWluLWhlaWdodDogMnJlbTsKICAgIG1pbi13aWR0aDogMnJlbTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgb3BhY2l0eTogMC42OTsgIC8qKiBtZWRpdW0tZW1waGFzaXMgLyBoaWdoLWVtcGhhc2lzICovCiAgICB1c2VyLXNlbGVjdDogbm9uZTsKfQoKLmFjdGlvbi1pY29uOmhvdmVyIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICBvcGFjaXR5OiAxOwp9CgovKiogYnV0dG9uICovCgpidXR0b24gewogICAgYm9yZGVyOiBub25lOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHVzZXItc2VsZWN0OiBub25lOwogICAgbWluLXdpZHRoOiA4cmVtOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpidXR0b24uc2VsZWN0ZWQgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpidXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpidXR0b246ZGlzYWJsZWQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgpidXR0b246ZGlzYWJsZWQ6aG92ZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGN1cnNvcjogZGVmYXVsdDsKfQoKLyoqIGFuY2hvcnMgKi8KCmEgewogICAgY29sb3I6IHZhcigtLXByaW1hcnktY29sb3IpOwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjJyZW07CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7Cn0KCmE6aG92ZXIgewogICAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7Cn0KCi8qKiBmb3JtcyAqLwoKZmllbGRzZXQgewogICAgYm9yZGVyOiBzb2xpZCAxcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXJvdy1nYXA6IDFyZW07CiAgICBncmlkLWNvbHVtbi1nYXA6IDFyZW07CiAgICBwYWRkaW5nOiAxcmVtOwp9CgpsYWJlbCB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIC8qIGJhY2tncm91bmQtY29sb3I6IHJlZDsgKi8KICAgIHBhZGRpbmc6IDAuNXJlbSAwOwp9CgouZm9ybS1saHMgewogICAgZ3JpZC1jb2x1bW46IDE7Cn0KCmlucHV0LCAuZm9ybS1yaHMgewogICAgZ3JpZC1jb2x1bW46IDI7Cn0KCi5mb3JtLXJvdyB7CiAgICBncmlkLWNvbHVtbjogMSAvIHNwYW4gMjsKfQoKZmllbGRzZXQgaW5wdXRbdHlwZT10ZXh0XSB7CiAgICBwYWRkaW5nOiAwLjVyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXI6IHNvbGlkIDFweCB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7Cn0KCmZpZWxkc2V0IG91dHB1dCB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCmZpZWxkc2V0IGRldGFpbHMgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKYDsKY29uc3QgSEVBREVSX0hUTUwgPSBodG1sYAo8aGVhZGVyIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQiPgogICAgPGRpdiBpZD0iaGVhZGVyLWNvbnRlbnQiPgogICAgICAgIERlbm9mbGFyZSBUYWlsCiAgICAgICAgPHNwYW4gaWQ9ImhlYWRlci12ZXJzaW9uIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvc3Bhbj4KICAgICAgICA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vc2t5bWV0aG9kL2Rlbm9mbGFyZSIgdGFyZ2V0PSJfYmxhbmsiIGlkPSJnaXRodWItbG9nby1hbmNob3IiPjxpbWcgaWQ9ImdpdGh1Yi1sb2dvIj48L2E+CiAgICA8L2Rpdj4KPC9oZWFkZXI+CmA7CmNvbnN0IEhFQURFUl9DU1MgPSBjc3NgCmhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMXJlbSAwOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCiNoZWFkZXItY29udGVudCB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGJhc2VsaW5lOwogICAgcGFkZGluZy1yaWdodDogMi4ycmVtOwp9CgojaGVhZGVyLXZlcnNpb24gewogICAgZmxleC1ncm93OiAxOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgojZ2l0aHViLWxvZ28tYW5jaG9yIHsKICAgIGxpbmUtaGVpZ2h0OiAwOwogICAgb3BhY2l0eTogMC41Owp9CgojZ2l0aHViLWxvZ28tYW5jaG9yOmhvdmVyIHsKICAgIG9wYWNpdHk6IDAuNzU7Cn0KCiNnaXRodWItbG9nbyB7CiAgICB3aWR0aDogMXJlbTsKICAgIG1hcmdpbi1ib3R0b206IC0wLjFyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRIZWFkZXIoZG9jdW1lbnQsIHZtLCBkYXRhKSB7CiAgICBjb25zdCBoZWFkZXJDb250ZW50RWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFkZXItY29udGVudCcpOwogICAgaWYgKChkYXRhLmZsYWdzIHx8ICcnKS5pbmNsdWRlcygnZGVtby10b2dnbGUnKSkgewogICAgICAgIGhlYWRlckNvbnRlbnRFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RibGNsaWNrJywgKGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdm0udG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGhlYWRlclZlcnNpb25TcGFuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlYWRlci12ZXJzaW9uJyk7CiAgICBjb25zdCB7IHZlcnNpb24gIH0gPSBkYXRhOwogICAgaGVhZGVyVmVyc2lvblNwYW4udGV4dENvbnRlbnQgPSB2ZXJzaW9uID8gYHYke3ZlcnNpb259YCA6ICcnOwogICAgY29uc3QgZ2l0aHViTG9nb0ltZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnaXRodWItbG9nbycpOwogICAgZ2l0aHViTG9nb0ltZy5zcmMgPSBjb21wdXRlR2l0aHViTG9nb0RhdGFVcmwoKTsKICAgIHJldHVybiAoKT0+ewogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlR2l0aHViTG9nb0RhdGFVcmwoKSB7CiAgICBjb25zdCBzdmcxID0gR0lUSFVCX0xPR08ucmVwbGFjZSgnZmlsbDp3aGl0ZTsnLCBgZmlsbDoke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn07YCk7CiAgICByZXR1cm4gJ2RhdGE6aW1hZ2Uvc3ZnK3htbDt1dGY4LCcgKyBzdmcxOwp9CmNvbnN0IEdJVEhVQl9MT0dPID0gYDxzdmcgd2lkdGg9ImF1dG8iIGhlaWdodD0iYXV0byIgdmlld0JveD0iMCAwIDEzNiAxMzMiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgeG1sbnM6c2VyaWY9Imh0dHA6Ly93d3cuc2VyaWYuY29tLyIgc3R5bGU9ImZpbGwtcnVsZTpldmVub2RkO2NsaXAtcnVsZTpldmVub2RkO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDoyOyI+CjxnIHRyYW5zZm9ybT0ibWF0cml4KDQuMTY2NjcsMCwwLDQuMTY2NjcsLTU2OCwtMTM4MS4wNikiPgogICAgPHBhdGggZD0iTTE1Mi42MDgsMzMxLjQ1NUMxNDMuNjE0LDMzMS40NTUgMTM2LjMyLDMzOC43NDggMTM2LjMyLDM0Ny43NDVDMTM2LjMyLDM1NC45NDIgMTQwLjk4NywzNjEuMDQ3IDE0Ny40NiwzNjMuMjAxQzE0OC4yNzUsMzYzLjM1MSAxNDguNTcyLDM2Mi44NDggMTQ4LjU3MiwzNjIuNDE2QzE0OC41NzIsMzYyLjAyOSAxNDguNTU4LDM2MS4wMDUgMTQ4LjU1LDM1OS42NDZDMTQ0LjAxOSwzNjAuNjMgMTQzLjA2MywzNTcuNDYyIDE0My4wNjMsMzU3LjQ2MkMxNDIuMzIyLDM1NS41OCAxNDEuMjU0LDM1NS4wNzkgMTQxLjI1NCwzNTUuMDc5QzEzOS43NzUsMzU0LjA2OSAxNDEuMzY2LDM1NC4wODkgMTQxLjM2NiwzNTQuMDg5QzE0My4wMDEsMzU0LjIwNCAxNDMuODYxLDM1NS43NjggMTQzLjg2MSwzNTUuNzY4QzE0NS4zMTQsMzU4LjI1NyAxNDcuNjc0LDM1Ny41MzggMTQ4LjYwMiwzNTcuMTIxQzE0OC43NSwzNTYuMDY5IDE0OS4xNzEsMzU1LjM1MSAxNDkuNjM2LDM1NC45NDRDMTQ2LjAxOSwzNTQuNTMzIDE0Mi4yMTYsMzUzLjEzNSAxNDIuMjE2LDM0Ni44OTNDMTQyLjIxNiwzNDUuMTE1IDE0Mi44NTEsMzQzLjY2IDE0My44OTMsMzQyLjUyMkMxNDMuNzI1LDM0Mi4xMSAxNDMuMTY2LDM0MC40NTMgMTQ0LjA1MywzMzguMjExQzE0NC4wNTMsMzM4LjIxMSAxNDUuNDIsMzM3Ljc3MyAxNDguNTMyLDMzOS44ODFDMTQ5LjgzMSwzMzkuNTE5IDE1MS4yMjUsMzM5LjMzOSAxNTIuNjEsMzM5LjMzMkMxNTMuOTk0LDMzOS4zMzkgMTU1LjM4NywzMzkuNTE5IDE1Ni42ODgsMzM5Ljg4MUMxNTkuNzk4LDMzNy43NzMgMTYxLjE2MywzMzguMjExIDE2MS4xNjMsMzM4LjIxMUMxNjIuMDUyLDM0MC40NTMgMTYxLjQ5MywzNDIuMTEgMTYxLjMyNiwzNDIuNTIyQzE2Mi4zNywzNDMuNjYgMTYzLDM0NS4xMTUgMTYzLDM0Ni44OTNDMTYzLDM1My4xNTEgMTU5LjE5MSwzNTQuNTI4IDE1NS41NjMsMzU0LjkzMUMxNTYuMTQ3LDM1NS40MzQgMTU2LjY2OCwzNTYuNDI4IDE1Ni42NjgsMzU3Ljk0N0MxNTYuNjY4LDM2MC4xMjUgMTU2LjY0OCwzNjEuODgyIDE1Ni42NDgsMzYyLjQxNkMxNTYuNjQ4LDM2Mi44NTIgMTU2Ljk0MiwzNjMuMzU5IDE1Ny43NjgsMzYzLjJDMTY0LjIzNiwzNjEuMDQxIDE2OC44OTksMzU0Ljk0IDE2OC44OTksMzQ3Ljc0NUMxNjguODk5LDMzOC43NDggMTYxLjYwNSwzMzEuNDU1IDE1Mi42MDgsMzMxLjQ1NVoiIHN0eWxlPSJmaWxsOndoaXRlOyIvPgo8L2c+Cjwvc3ZnPmA7CmZ1bmN0aW9uIGFjdGlvbkljb24oaWNvbiwgb3B0cyA9IHsKfSkgewogICAgY29uc3QgeyB0ZXh0ICwgb25jbGljayAgfSA9IG9wdHM7CiAgICByZXR1cm4gaHRtbGA8ZGl2IGNsYXNzPSJhY3Rpb24taWNvbiIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIG9uY2xpY2sgJiYgb25jbGljaygpOwogICAgfX0+JHtpY29ufSR7dGV4dCB8fCAnJ308L2Rpdj5gOwp9CmNvbnN0IENMRUFSX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik01IDEzaDE0di0ySDV2MnptLTIgNGgxNHYtMkgzdjJ6TTcgN3YyaDE0VjdIN3oiLz48L3N2Zz5gOwpjb25zdCBFRElUX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xNC4wNiA5LjAybC45Mi45Mkw1LjkyIDE5SDV2LS45Mmw5LjA2LTkuMDZNMTcuNjYgM2MtLjI1IDAtLjUxLjEtLjcuMjlsLTEuODMgMS44MyAzLjc1IDMuNzUgMS44My0xLjgzYy4zOS0uMzkuMzktMS4wMiAwLTEuNDFsLTIuMzQtMi4zNGMtLjItLjItLjQ1LS4yOS0uNzEtLjI5em0tMy42IDMuMTlMMyAxNy4yNVYyMWgzLjc1TDE3LjgxIDkuOTRsLTMuNzUtMy43NXoiLz48L3N2Zz5gOwpjb25zdCBBRERfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOSAxM2gtNnY2aC0ydi02SDV2LTJoNlY1aDJ2Nmg2djJ6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tfQk9YX1VOQ0hFQ0tFRF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTkgNXYxNEg1VjVoMTRtMC0ySDVjLTEuMSAwLTIgLjktMiAydjE0YzAgMS4xLjkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJWNWMwLTEuMS0uOS0yLTItMnoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19CT1hfQ0hFQ0tFRF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTkgM0g1Yy0xLjEgMC0yIC45LTIgMnYxNGMwIDEuMS45IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjVjMC0xLjEtLjktMi0yLTJ6bTAgMTZINVY1aDE0djE0ek0xNy45OSA5bC0xLjQxLTEuNDItNi41OSA2LjU5LTIuNTgtMi41Ny0xLjQyIDEuNDEgNCAzLjk5eiIvPjwvc3ZnPmA7CmNvbnN0IFNJREVCQVJfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9InNpZGViYXIiPgogICAgJHtIRUFERVJfSFRNTH0KICAgIDxkaXYgaWQ9InByb2ZpbGVzIj48L2Rpdj4KICAgIDxkaXYgaWQ9InNjcmlwdHMiPjwvZGl2Pgo8L2Rpdj4KYDsKY29uc3QgU0lERUJBUl9DU1MgPSBjc3NgCgojc2lkZWJhciB7CiAgICBtYXJnaW4tbGVmdDogMXJlbTsKICAgIGhlaWdodDogMTAwdmg7CiAgICBvdmVyZmxvdy15OiBoaWRkZW47CiAgICBtaW4td2lkdGg6IDE1cmVtOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQgewogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDJyZW07CiAgICBncmlkLWdhcDogMXB4OwogICAgbWFyZ2luLWxlZnQ6IDFweDsKICAgIG1hcmdpbi10b3A6IDFyZW07Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZC1uZXcgewogICAgZ3JpZC1jb2x1bW46IDE7CiAgICBtaW4td2lkdGg6IDhyZW07Cn0KCiNzaWRlYmFyIGJ1dHRvbiB7CiAgICBncmlkLWNvbHVtbjogMTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkIC5oaW50IHsKICAgIGdyaWQtY29sdW1uOiAxOyAKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi10b3A6IDAuNXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdFNpZGViYXIoZG9jdW1lbnQsIHZtLCBkYXRhKSB7CiAgICBjb25zdCB1cGRhdGVIZWFkZXIgPSBpbml0SGVhZGVyKGRvY3VtZW50LCB2bSwgZGF0YSk7CiAgICBjb25zdCBwcm9maWxlc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlcycpOwogICAgY29uc3Qgc2NyaXB0c0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY3JpcHRzJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICB1cGRhdGVIZWFkZXIoKTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihQUk9GSUxFU19IVE1MKHZtKSwgcHJvZmlsZXNEaXYpOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKFNDUklQVFNfSFRNTCh2bSksIHNjcmlwdHNEaXYpOwogICAgfTsKfQpjb25zdCBQUk9GSUxFU19IVE1MID0gKHZtKT0+aHRtbGAKICAgIDxkaXYgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij5Qcm9maWxlczwvZGl2PgogICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQiPgogICAgICAgICR7dm0ucHJvZmlsZXMubWFwKChwcm9maWxlKT0+aHRtbGA8YnV0dG9uIGNsYXNzPSIke3Byb2ZpbGUuaWQgPT09IHZtLnNlbGVjdGVkUHJvZmlsZUlkID8gJ3NlbGVjdGVkJyA6ICcnfSIgQGNsaWNrPSR7KCk9PnsKICAgICAgICAgICAgdm0uc2VsZWN0ZWRQcm9maWxlSWQgPSBwcm9maWxlLmlkOwogICAgICAgIH19ID9kaXNhYmxlZD0iJHt2bS5wcm9maWxlRm9ybS5zaG93aW5nfSI+JHtwcm9maWxlLnRleHR9PC9idXR0b24+CiAgICAgICAgJHtwcm9maWxlLmlkID09PSB2bS5zZWxlY3RlZFByb2ZpbGVJZCA/IGh0bWxgJHthY3Rpb25JY29uKEVESVRfSUNPTiwgewogICAgICAgICAgICBvbmNsaWNrOiAoKT0+dm0uZWRpdFByb2ZpbGUocHJvZmlsZS5pZCkKICAgICAgICB9KX1gIDogJyd9YAogICAgKX0KICAgICAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZC1uZXciPiR7YWN0aW9uSWNvbihBRERfSUNPTiwgewogICAgICAgIHRleHQ6ICdOZXcnLAogICAgICAgIG9uY2xpY2s6ICgpPT52bS5uZXdQcm9maWxlKCkKICAgIH0pfTwvZGl2PgogICAgPC9kaXY+CmAKOwpjb25zdCBTQ1JJUFRTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPlNjcmlwdHM8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAke3ZtLnNjcmlwdHMubWFwKChzY3JpcHQpPT5odG1sYDxidXR0b24gY2xhc3M9IiR7dm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdC5pZCkgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PmhhbmRsZVNjcmlwdENsaWNrKGUsIHNjcmlwdC5pZCwgdm0pCiAgICAgICAgfSA/ZGlzYWJsZWQ9IiR7dm0ucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7c2NyaXB0LnRleHR9PC9idXR0b24+CiAgICAgICAgYAogICAgKX0KICAgICAgICA8ZGl2IGNsYXNzPSJjYXB0aW9uIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGhpbnQiPiR7Y29tcHV0ZU1ldGFLZXlDaGFyKCl9LWNsaWNrIHRvIG11bHRpc2VsZWN0PC9kaXY+CiAgICA8L2Rpdj4KYAo7CmZ1bmN0aW9uIGNvbXB1dGVNZXRhS2V5Q2hhcigpIHsKICAgIHJldHVybiBpc01hY2ludG9zaCgpID8gJ+KMmCcgOiBpc1dpbmRvd3MoKSA/ICfiip4nIDogJ21ldGEnOwp9CmZ1bmN0aW9uIGlzTWFjaW50b3NoKCkgewogICAgcmV0dXJuIG5hdmlnYXRvci5wbGF0Zm9ybS5pbmRleE9mKCdNYWMnKSA+IC0xOwp9CmZ1bmN0aW9uIGlzV2luZG93cygpIHsKICAgIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm0uaW5kZXhPZignV2luJykgPiAtMTsKfQpmdW5jdGlvbiBoYW5kbGVTY3JpcHRDbGljayhlLCBzY3JpcHRJZCwgdm0pIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IG5ld1NjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgIHNjcmlwdElkCiAgICBdKTsKICAgIHZtLnNlbGVjdGVkU2NyaXB0SWRzID0gZS5tZXRhS2V5ID8gdm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdElkKSA/IHNldFN1YnRyYWN0KHZtLnNlbGVjdGVkU2NyaXB0SWRzLCBuZXdTY3JpcHRJZHMpIDogc2V0VW5pb24odm0uc2VsZWN0ZWRTY3JpcHRJZHMsIG5ld1NjcmlwdElkcykgOiBuZXdTY3JpcHRJZHM7Cn0KZnVuY3Rpb24gcGFyc2VIZWFkZXJGaWx0ZXIoaGVhZGVyKSB7CiAgICBjb25zdCBpMSA9IGhlYWRlci5pbmRleE9mKCc6Jyk7CiAgICBpZiAoaTEgPCAwKSByZXR1cm4gewogICAgICAgIGtleTogaGVhZGVyCiAgICB9OwogICAgY29uc3Qga2V5ID0gaGVhZGVyLnN1YnN0cmluZygwLCBpMSkudHJpbSgpOwogICAgY29uc3QgcXVlcnkgPSBoZWFkZXIuc3Vic3RyaW5nKGkxICsgMSkudHJpbSgpOwogICAgcmV0dXJuIHsKICAgICAgICBrZXksCiAgICAgICAgcXVlcnkKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0tFWVMgPSBuZXcgU2V0KFsKICAgICdvdXRjb21lJywKICAgICdzY3JpcHROYW1lJywKICAgICdleGNlcHRpb25zJywKICAgICdsb2dzJywKICAgICdldmVudFRpbWVzdGFtcCcsCiAgICAnZXZlbnQnCl0pOwpjb25zdCBLTk9XTl9PVVRDT01FUyA9IG5ldyBTZXQoWwogICAgJ29rJywKICAgICdleGNlcHRpb24nLAogICAgJ2V4Y2VlZGVkQ3B1JywKICAgICdjYW5jZWxlZCcsCiAgICAndW5rbm93bicKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2Uob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2U6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCB7IG91dGNvbWUgLCBzY3JpcHROYW1lICwgZXZlbnRUaW1lc3RhbXAgIH0gPSBvYmpBc0FueTsKICAgIGlmICghS05PV05fT1VUQ09NRVMuaGFzKG91dGNvbWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBvdXRjb21lOiBleHBlY3RlZCBvbmUgb2YgWyR7WwogICAgICAgIC4uLktOT1dOX09VVENPTUVTCiAgICBdLmpvaW4oJywgJyl9XSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvdXRjb21lKX1gKTsKICAgIGlmIChzY3JpcHROYW1lICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBzY3JpcHROYW1lOiBleHBlY3RlZCBudWxsLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHNjcmlwdE5hbWUpfWApOwogICAgY29uc3QgbG9ncyA9IHBhcnNlTG9ncyhvYmpBc0FueS5sb2dzKTsKICAgIGNvbnN0IGV4Y2VwdGlvbnMgPSBwYXJzZUV4Y2VwdGlvbnMob2JqQXNBbnkuZXhjZXB0aW9ucyk7CiAgICBpZiAoISh0eXBlb2YgZXZlbnRUaW1lc3RhbXAgPT09ICdudW1iZXInICYmIGV2ZW50VGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIGV2ZW50VGltZXN0YW1wOiBleHBlY3RlZCBwb3NpdGl2ZSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoZXZlbnRUaW1lc3RhbXApfWApOwogICAgY29uc3QgZXZlbnQgPSBvYmpBc0FueS5ldmVudCAmJiBvYmpBc0FueS5ldmVudC5yZXF1ZXN0ID8gcGFyc2VUYWlsTWVzc2FnZVJlcXVlc3RFdmVudChvYmpBc0FueS5ldmVudCkgOiBwYXJzZVRhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iakFzQW55LmV2ZW50KTsKICAgIHJldHVybiB7CiAgICAgICAgb3V0Y29tZSwKICAgICAgICBzY3JpcHROYW1lLAogICAgICAgIGV4Y2VwdGlvbnMsCiAgICAgICAgbG9ncywKICAgICAgICBldmVudFRpbWVzdGFtcCwKICAgICAgICBldmVudAogICAgfTsKfQpmdW5jdGlvbiBwYXJzZUxvZ3Mob2JqKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbG9nczogZXhwZWN0ZWQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBbCiAgICAgICAgLi4ub2JqCiAgICBdLm1hcChwYXJzZVRhaWxNZXNzYWdlTG9nKTsKfQpmdW5jdGlvbiBwYXJzZUV4Y2VwdGlvbnMob2JqKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgZXhjZXB0aW9uczogZXhwZWN0ZWQgYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBbCiAgICAgICAgLi4ub2JqCiAgICBdLm1hcChwYXJzZVRhaWxNZXNzYWdlRXhjZXB0aW9uKTsKfQpmdW5jdGlvbiBpc0xvZ01lc3NhZ2VQYXJ0KHZhbHVlKSB7CiAgICBjb25zdCB0ID0gdHlwZW9mIHZhbHVlOwogICAgcmV0dXJuIHQgPT09ICdzdHJpbmcnIHx8IHQgPT09ICdudW1iZXInIHx8IHQgPT09ICdib29sZWFuJyB8fCB0ID09PSAndW5kZWZpbmVkJyB8fCB0ID09PSAnb2JqZWN0JzsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfTE9HX0tFWVMgPSBuZXcgU2V0KFsKICAgICdtZXNzYWdlJywKICAgICdsZXZlbCcsCiAgICAndGltZXN0YW1wJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUxvZyhvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUxvZzogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfTE9HX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCBtZXNzYWdlMSA9IHBhcnNlTG9nTWVzc2FnZVBhcnRBcnJheShvYmpBc0FueS5tZXNzYWdlLCAnbWVzc2FnZScpOwogICAgY29uc3QgeyBsZXZlbCAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIGxldmVsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGxldmVsOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobGV2ZWwpfWApOwogICAgaWYgKCEodHlwZW9mIHRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgdGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHRpbWVzdGFtcCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UxLAogICAgICAgIGxldmVsLAogICAgICAgIHRpbWVzdGFtcAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVhDRVBUSU9OX0tFWVMgPSBuZXcgU2V0KFsKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlRXhjZXB0aW9uKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlRXhjZXB0aW9uOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FWENFUFRJT05fS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgbmFtZTogbmFtZTQgLCBtZXNzYWdlOiBtZXNzYWdlMSAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIG5hbWU0ID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG5hbWU6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShuYW1lNCl9YCk7CiAgICBpZiAoISh0eXBlb2YgbWVzc2FnZTEgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVzc2FnZTogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1lc3NhZ2UxKX1gKTsKICAgIGlmICghKHR5cGVvZiB0aW1lc3RhbXAgPT09ICdudW1iZXInICYmIHRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0aW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh0aW1lc3RhbXApfWApOwogICAgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lNCwKICAgICAgICBtZXNzYWdlOiBtZXNzYWdlMSwKICAgICAgICB0aW1lc3RhbXAKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2Nyb24nLAogICAgJ3NjaGVkdWxlZFRpbWUnCl0pOwpmdW5jdGlvbiBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKG9iaikpOwogICAgcmV0dXJuIHNldEVxdWFsKGtleXMsIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMpOwp9CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VDcm9uRXZlbnQ6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgY3JvbiAsIHNjaGVkdWxlZFRpbWUgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBjcm9uID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGNyb246IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShjcm9uKX1gKTsKICAgIGlmICghKHR5cGVvZiBzY2hlZHVsZWRUaW1lID09PSAnbnVtYmVyJyAmJiBzY2hlZHVsZWRUaW1lID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjaGVkdWxlZFRpbWU6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShzY2hlZHVsZWRUaW1lKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgY3JvbiwKICAgICAgICBzY2hlZHVsZWRUaW1lCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9SRVFVRVNUX0VWRU5UX0tFWVMgPSBuZXcgU2V0KFsKICAgICdyZXF1ZXN0JwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZVJlcXVlc3RFdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZVJlcXVlc3RFdmVudDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgcmVxdWVzdCA9IHBhcnNlVGFpbE1lc3NhZ2VFdmVudFJlcXVlc3Qob2JqQXNBbnkucmVxdWVzdCk7CiAgICByZXR1cm4gewogICAgICAgIHJlcXVlc3QKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ3VybCcsCiAgICAnbWV0aG9kJywKICAgICdoZWFkZXJzJwpdKTsKY29uc3QgT1BUSU9OQUxfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2NmJwpdKTsKY29uc3QgQUxMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBzZXRVbmlvbihSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBPUFRJT05BTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUV2ZW50UmVxdWVzdChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUV2ZW50UmVxdWVzdDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBBTExfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgdXJsICwgbWV0aG9kICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIHVybDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7CiAgICBpZiAoISh0eXBlb2YgbWV0aG9kID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG1ldGhvZDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1ldGhvZCl9YCk7CiAgICBjb25zdCBoZWFkZXJzID0gcGFyc2VTdHJpbmdSZWNvcmQob2JqQXNBbnkuaGVhZGVycywgJ2hlYWRlcnMnKTsKICAgIGNvbnN0IGNmID0gb2JqQXNBbnkuY2YgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iakFzQW55LmNmKTsKICAgIHJldHVybiB7CiAgICAgICAgdXJsLAogICAgICAgIG1ldGhvZCwKICAgICAgICBoZWFkZXJzLAogICAgICAgIGNmCiAgICB9Owp9CmZ1bmN0aW9uIGNoZWNrS2V5cyhvYmosIHJlcXVpcmVkS2V5cywgYWxsS2V5cykgewogICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoT2JqZWN0LmtleXMob2JqKSk7CiAgICBjb25zdCBtaXNzaW5nS2V5cyA9IHNldFN1YnRyYWN0KHJlcXVpcmVkS2V5cywga2V5cyk7CiAgICBpZiAobWlzc2luZ0tleXMuc2l6ZSA+IDApIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBrZXlzOiAke1sKICAgICAgICAuLi5taXNzaW5nS2V5cwogICAgXS5qb2luKCcsICcpfWApOwogICAgY29uc3QgZXh0cmFLZXlzID0gc2V0U3VidHJhY3Qoa2V5cywgYWxsS2V5cyB8fCByZXF1aXJlZEtleXMpOwogICAgaWYgKGV4dHJhS2V5cy5zaXplID4gMCkgdGhyb3cgbmV3IEVycm9yKGBFeHRyYSBrZXlzOiAke1sKICAgICAgICAuLi5leHRyYUtleXMKICAgIF0uam9pbignLCAnKX1gKTsKfQpmdW5jdGlvbiBwYXJzZVN0cmluZ1JlY29yZChvYmosIG5hbWU0KSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lNH06IEV4cGVjdGVkIHN0cmluZyByZWNvcmQsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGZvciAoY29uc3QgW18sIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKXsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lNH06IEV4cGVjdGVkIHN0cmluZyByZWNvcmQsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIH0KICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gcGFyc2VMb2dNZXNzYWdlUGFydEFycmF5KG9iaiwgbmFtZTQpIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCAhQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWU0fTogRXhwZWN0ZWQgbG9nIG1lc3NhZ2UgcGFydCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiBvYmopewogICAgICAgIGlmICghaXNMb2dNZXNzYWdlUGFydCh2YWx1ZSkpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZTR9OiBFeHBlY3RlZCBsb2cgbWVzc2FnZSBwYXJ0IGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICB9CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGNmOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZTEsIGxvZ2dlciwgYWRkaXRpb25hbExvZ3MgPSBbXSkgewogICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUobWVzc2FnZTEuZXZlbnRUaW1lc3RhbXApKTsKICAgIGNvbnN0IG91dGNvbWUgPSBQUkVUVFlfT1VUQ09NRVMuZ2V0KG1lc3NhZ2UxLm91dGNvbWUpIHx8IG1lc3NhZ2UxLm91dGNvbWU7CiAgICBjb25zdCBvdXRjb21lQ29sb3IgPSBtZXNzYWdlMS5vdXRjb21lID09PSAnb2snID8gJ2dyZWVuJyA6ICdyZWQnOwogICAgY29uc3QgeyBwcm9wcyAsIHJlbWFpbmluZ0xvZ3MgIH0gPSBwYXJzZUxvZ1Byb3BzKG1lc3NhZ2UxLmxvZ3MpOwogICAgaWYgKGlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQobWVzc2FnZTEuZXZlbnQpKSB7CiAgICAgICAgY29uc3QgY29sbyA9IHByb3BzLmNvbG8gfHwgJz8/Pyc7CiAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSAlYyR7bWVzc2FnZTEuZXZlbnQuY3Jvbn1gLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtvdXRjb21lQ29sb3J9YCwgJycsICdjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkOycpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCB7IG1ldGhvZCAsIHVybCAsIGNmICB9ID0gbWVzc2FnZTEuZXZlbnQucmVxdWVzdDsKICAgICAgICBjb25zdCBjb2xvID0gY2Y/LmNvbG8gfHwgcHJvcHMuY29sbyB8fCAnPz8/JzsKICAgICAgICBpZiAoY2YgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb25zdCBkdXJhYmxlT2JqZWN0SW5mbyA9IGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcyk7CiAgICAgICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gWyVjJHtkdXJhYmxlT2JqZWN0SW5mb30lY10gJHttZXRob2R9ICVjJHt1cmx9YCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6ICR7b3V0Y29tZUNvbG9yfWAsICcnLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSAke21ldGhvZH0gJWMke3VybH1gLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtvdXRjb21lQ29sb3J9YCwgJycsICdjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkOycpOwogICAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgeyBkYXRhICB9IG9mIGFkZGl0aW9uYWxMb2dzKXsKICAgICAgICBsb2dnZXIoLi4uZGF0YSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsgbGV2ZWwgLCBtZXNzYWdlOiBsb2dNZXNzYWdlICB9IG9mIHJlbWFpbmluZ0xvZ3MpewogICAgICAgIGNvbnN0IGxldmVsQ29sb3IgPSBMT0dfTEVWRUxfQ09MT1JTLmdldChsZXZlbCkgfHwgJ2dyYXknOwogICAgICAgIGNvbnN0IGxvZ01lc3NhZ2VzID0gbG9nTWVzc2FnZS5tYXAoZm9ybWF0TG9nTWVzc2FnZVBhcnQpLmpvaW4oJywgJyk7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtsZXZlbH0lY10gJHtsb2dNZXNzYWdlc31gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke2xldmVsQ29sb3J9YCwgJycpOwogICAgfQogICAgZm9yIChjb25zdCB7IG5hbWU6IG5hbWU0ICwgbWVzc2FnZTogZXhjZXB0aW9uTWVzc2FnZSAgfSBvZiBtZXNzYWdlMS5leGNlcHRpb25zKXsKICAgICAgICBsb2dnZXIoYCAlY3wlYyBbJWMke25hbWU0fSVjXSAlYyR7ZXhjZXB0aW9uTWVzc2FnZX1gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGRgLCAnJywgJ2NvbG9yOiByZWQnKTsKICAgIH0KfQpmdW5jdGlvbiBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKGRhdGUpIHsKICAgIHJldHVybiBbCiAgICAgICAgZGF0ZS5nZXRGdWxsWWVhcigpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0TW9udGgoKSArIDEpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0RGF0ZSgpKSwKICAgICAgICAnICcsCiAgICAgICAgcGFkMihkYXRlLmdldEhvdXJzKCkpLAogICAgICAgICc6JywKICAgICAgICBwYWQyKGRhdGUuZ2V0TWludXRlcygpKSwKICAgICAgICAnOicsCiAgICAgICAgcGFkMihkYXRlLmdldFNlY29uZHMoKSkKICAgIF0uam9pbignJyk7Cn0KZnVuY3Rpb24gY29tcHV0ZUR1cmFibGVPYmplY3RJbmZvKHByb3BzKSB7CiAgICBjb25zdCBkdXJhYmxlT2JqZWN0Q2xhc3MgPSAodHlwZW9mIHByb3BzLmR1cmFibGVPYmplY3RDbGFzcyA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0Q2xhc3MgOiAnJykudHJpbSgpOwogICAgY29uc3QgZHVyYWJsZU9iamVjdElkID0gKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0SWQgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdElkIDogJycpLnRyaW0oKTsKICAgIGNvbnN0IGR1cmFibGVPYmplY3ROYW1lID0gKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA6ICcnKS50cmltKCk7CiAgICBjb25zdCBydCA9IFtdOwogICAgaWYgKGR1cmFibGVPYmplY3RDbGFzcy5sZW5ndGggPiAwKSBydC5wdXNoKGR1cmFibGVPYmplY3RDbGFzcyk7CiAgICBpZiAoZHVyYWJsZU9iamVjdE5hbWUubGVuZ3RoID4gMCkgcnQucHVzaChkdXJhYmxlT2JqZWN0TmFtZSk7CiAgICBpZiAoZHVyYWJsZU9iamVjdElkLmxlbmd0aCA+IDApIHJ0LnB1c2goY29tcHV0ZVNob3J0RHVyYWJsZU9iamVjdElkKGR1cmFibGVPYmplY3RJZCkpOwogICAgcmV0dXJuIHJ0Lmxlbmd0aCA+IDAgPyBydC5qb2luKCcgJykgOiAnRE8nOwp9CmZ1bmN0aW9uIGNvbXB1dGVTaG9ydER1cmFibGVPYmplY3RJZChpZCkgewogICAgcmV0dXJuIC9eWzAtOWEtZkEtRl17NSx9JC8udGVzdChpZCkgPyBgJHtpZC5zdWJzdHJpbmcoMCwgNCl94oCmYCA6IGlkOwp9CmZ1bmN0aW9uIHBhcnNlTG9nUHJvcHMobG9ncykgewogICAgY29uc3QgcmVtYWluaW5nTG9ncyA9IFtdOwogICAgY29uc3QgcHJvcHMgPSB7CiAgICB9OwogICAgZm9yIChjb25zdCBsb2cgb2YgbG9ncyl7CiAgICAgICAgaWYgKGxvZy5tZXNzYWdlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgbXNnID0gbG9nLm1lc3NhZ2VbMF07CiAgICAgICAgICAgIGlmICh0eXBlb2YgbXNnID09PSAnc3RyaW5nJyAmJiBtc2cuc3RhcnRzV2l0aCgnbG9ncHJvcHM6JykpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsZXIgPSBtc2cuc3Vic3RyaW5nKG1zZy5pbmRleE9mKCc6JykgKyAxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsZXJQcm9wcyA9IHRyeVBhcnNlUHJvcHNGcm9tSnNvbih0cmFpbGVyKTsKICAgICAgICAgICAgICAgIGFwcGVuZFByb3BzKHRyYWlsZXJQcm9wcywgcHJvcHMpOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIGxvZy5tZXNzYWdlLnNsaWNlKDEpKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJ0UHJvcHMgPSB0cnlQYXJzZVByb3BzRnJvbVBhcnQocGFydCk7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kUHJvcHMocGFydFByb3BzLCBwcm9wcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZW1haW5pbmdMb2dzLnB1c2gobG9nKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgcHJvcHMsCiAgICAgICAgcmVtYWluaW5nTG9ncwogICAgfTsKfQpmdW5jdGlvbiBhcHBlbmRQcm9wcyhzcmMsIGRzdCkgewogICAgaWYgKHNyYykgewogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNyYykpewogICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiB0cnlQYXJzZVByb3BzRnJvbUpzb24odmFsdWUpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgcHJvcHMgPSBKU09OLnBhcnNlKHZhbHVlLnRyaW0oKSk7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wcyA9PT0gJ29iamVjdCcgJiYgcHJvcHMgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wczsKICAgICAgICB9CiAgICB9IGNhdGNoICB7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHRyeVBhcnNlUHJvcHNGcm9tUGFydChwYXJ0KSB7CiAgICB0cnkgewogICAgICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcgJiYgcGFydCAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheShwYXJ0KSkgewogICAgICAgICAgICByZXR1cm4gcGFydDsKICAgICAgICB9CiAgICB9IGNhdGNoICB7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGZvcm1hdExvZ01lc3NhZ2VQYXJ0KHBhcnQpIHsKICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcpIHJldHVybiBKU09OLnN0cmluZ2lmeShwYXJ0KTsKICAgIHJldHVybiBgJHtwYXJ0fWA7Cn0KZnVuY3Rpb24gcGFkMihudW0pIHsKICAgIHJldHVybiBudW0udG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpOwp9CmNvbnN0IFBSRVRUWV9PVVRDT01FUyA9IG5ldyBNYXAoWwogICAgWwogICAgICAgICdvaycsCiAgICAgICAgJ09rJwogICAgXSwKICAgIFsKICAgICAgICAnZXhjZXB0aW9uJywKICAgICAgICAnRXJyb3InCiAgICBdLAogICAgWwogICAgICAgICdleGNlZWRlZENwdScsCiAgICAgICAgJ0V4Y2VlZGVkIExpbWl0JwogICAgXSwKICAgIFsKICAgICAgICAnY2FuY2VsZWQnLAogICAgICAgICdDYW5jZWxlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ3Vua25vd24nLAogICAgICAgICdVbmtub3duJwogICAgXSwgCl0pOwpjb25zdCBMT0dfTEVWRUxfQ09MT1JTID0gbmV3IE1hcChbCiAgICBbCiAgICAgICAgJ3RyYWNlJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2RlYnVnJywKICAgICAgICAncHVycGxlJwogICAgXSwKICAgIFsKICAgICAgICAnbG9nJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2luZm8nLAogICAgICAgICdncmF5JwogICAgXSwKICAgIFsKICAgICAgICAnd2FybicsCiAgICAgICAgJ3JlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ2Vycm9yJywKICAgICAgICAncmVkJwogICAgXSwgCl0pOwpmdW5jdGlvbiBnZW5lcmF0ZVV1aWQoKSB7CiAgICBjb25zdCBjcnlwdG9Bc0FueSA9IGNyeXB0bzsKICAgIGlmICh0eXBlb2YgY3J5cHRvQXNBbnkucmFuZG9tVVVJRCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBjcnlwdG9Bc0FueS5yYW5kb21VVUlEKCk7CiAgICB9CiAgICBjb25zdCBybmRzID0gY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDhBcnJheSgxNikpOwogICAgcm5kc1s2XSA9IHJuZHNbNl0gJiAxNSB8IDY0OwogICAgcm5kc1s4XSA9IHJuZHNbOF0gJiA2MyB8IDEyODsKICAgIHJldHVybiBieXRlc1RvVXVpZChybmRzKTsKfQpmdW5jdGlvbiBieXRlc1RvVXVpZChieXRlcykgewogICAgY29uc3QgYml0cyA9IFsKICAgICAgICAuLi5ieXRlcwogICAgXS5tYXAoKGJpdCk9PnsKICAgICAgICBjb25zdCBzID0gYml0LnRvU3RyaW5nKDE2KTsKICAgICAgICByZXR1cm4gYml0IDwgMTYgPyAiMCIgKyBzIDogczsKICAgIH0pOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5iaXRzLnNsaWNlKDAsIDQpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDQsIDYpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDYsIDgpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDgsIDEwKSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSgxMCwgMTYpLCAKICAgIF0uam9pbigiIik7Cn0KY2xhc3MgVGFpbENvbm5lY3Rpb24gewogICAgc3RhdGljIFZFUkJPU0UgPSBmYWxzZTsKICAgIHdzOwogICAgY2FsbGJhY2tzOwogICAgb3B0aW9uczsKICAgIGNvbnN0cnVjdG9yKHdlYlNvY2tldFVybCwgY2FsbGJhY2tzMSl7CiAgICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQod2ViU29ja2V0VXJsLCAndHJhY2UtdjEnKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczE7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdvcGVuJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICB0aGlzLnNlbmRPcHRpb25zSWZPcGVuKCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3MxLm9uT3BlbikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vbk9wZW4odGhpcywgdGltZVN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignY2xvc2UnLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgY29kZSAsIHJlYXNvbiAsIHdhc0NsZWFuICwgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3MxLm9uQ2xvc2UpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25DbG9zZSh0aGlzLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgY29uc3QgZXJyb3JJbmZvID0gY29tcHV0ZUVycm9ySW5mbyhldmVudCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3MxLm9uRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25FcnJvcih0aGlzLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBhc3luYyAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChldmVudC5kYXRhIGluc3RhbmNlb2YgQmxvYikgewogICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IGV2ZW50LmRhdGEudGV4dCgpOwogICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZSh0ZXh0KTsKICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlMTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTEgPSBwYXJzZVRhaWxNZXNzYWdlKG9iaik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vblVucGFyc2VkTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIG9iaiwgZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vblRhaWxNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgbWVzc2FnZTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vblVucGFyc2VkTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIGV2ZW50LmRhdGEsIG5ldyBFcnJvcihgRXhwZWN0ZWQgZXZlbnQuZGF0YSB0byBiZSBCbG9iYCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBzZXRPcHRpb25zKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgIHRoaXMuc2VuZE9wdGlvbnNJZk9wZW4oKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNsb3NlKGNvZGUsIHJlYXNvbikgewogICAgICAgIHRoaXMud3MuY2xvc2UoY29kZSwgcmVhc29uKTsKICAgIH0KICAgIHNlbmRPcHRpb25zSWZPcGVuKCkgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMgJiYgdGhpcy53cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikgewogICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGBzZW5kT3B0aW9uc0lmT3Blbjogc2VuZGluZyAke3BheWxvYWR9YCk7CiAgICAgICAgICAgIHRoaXMud3Muc2VuZChwYXlsb2FkKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUVycm9ySW5mbyhldmVudCkgewogICAgaWYgKGV2ZW50LnR5cGUgPT09ICdlcnJvcicpIHsKICAgICAgICBjb25zdCB7IG1lc3NhZ2U6IG1lc3NhZ2UxICwgZmlsZW5hbWUgLCBsaW5lbm8gLCBjb2xubyAsIGVycm9yICB9ID0gZXZlbnQ7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZTEsCiAgICAgICAgICAgIGZpbGVuYW1lLAogICAgICAgICAgICBsaW5lbm8sCiAgICAgICAgICAgIGNvbG5vLAogICAgICAgICAgICBlcnJvcgogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmNsYXNzIFRhaWxDb250cm9sbGVyIHsKICAgIGNhbGxiYWNrczsKICAgIHJlY29yZHMgPSBuZXcgTWFwKCk7CiAgICB0YWlsT3B0aW9ucyA9IHsKICAgICAgICBmaWx0ZXJzOiBbXQogICAgfTsKICAgIGNvbnN0cnVjdG9yKGNhbGxiYWNrczIpewogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzMjsKICAgIH0KICAgIHNldFRhaWxPcHRpb25zKHRhaWxPcHRpb25zKSB7CiAgICAgICAgY29uc29sZS5sb2coYFRhaWxDb250cm9sbGVyLnNldFRhaWxPcHRpb25zICR7SlNPTi5zdHJpbmdpZnkodGFpbE9wdGlvbnMpfWApOwogICAgICAgIHRoaXMudGFpbE9wdGlvbnMgPSB0YWlsT3B0aW9uczsKICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiB0aGlzLnJlY29yZHMudmFsdWVzKCkpewogICAgICAgICAgICBpZiAocmVjb3JkLmNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgICAgIHJlY29yZC5jb25uZWN0aW9uLnNldE9wdGlvbnModGFpbE9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgc2V0VGFpbHMoYWNjb3VudElkLCBhcGlUb2tlbiwgc2NyaXB0SWRzKSB7CiAgICAgICAgY29uc3Qgc3RvcEtleXMgPSBzZXRTdWJ0cmFjdCh0aGlzLmNvbXB1dGVTdGFydGluZ09yU3RhcnRlZFRhaWxLZXlzKCksIG5ldyBTZXQoWwogICAgICAgICAgICAuLi5zY3JpcHRJZHMKICAgICAgICBdLm1hcCgodik9PnBhY2tUYWlsS2V5KGFjY291bnRJZCwgdikKICAgICAgICApKSk7CiAgICAgICAgZm9yIChjb25zdCBzdG9wS2V5IG9mIHN0b3BLZXlzKXsKICAgICAgICAgICAgY29uc3QgcmVjb3JkID0gdGhpcy5yZWNvcmRzLmdldChzdG9wS2V5KTsKICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gJ2luYWN0aXZlJzsKICAgICAgICAgICAgcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSA9PT0gJ2luYWN0aXZlJyAmJiByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgJiYgRGF0ZS5ub3coKSAtIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZSA+PSA1MDAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gJ2Nsb3NpbmcnOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDbG9zaW5nICR7dW5wYWNrVGFpbEtleShyZWNvcmQudGFpbEtleSkuc2NyaXB0SWR9LCBpbmFjdGl2ZSBmb3IgJHtEYXRlLm5vdygpIC0gcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lfW1zYCk7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24/LmNsb3NlKDEwMDAsICdubyBsb25nZXIgaW50ZXJlc3RlZCcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkcy5kZWxldGUocmVjb3JkLnRhaWxLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCA1MDAwKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0b3BLZXlzLnNpemUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKTsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBzY3JpcHRJZCBvZiBzY3JpcHRJZHMpewogICAgICAgICAgICBjb25zdCB0YWlsS2V5ID0gcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nUmVjb3JkID0gdGhpcy5yZWNvcmRzLmdldCh0YWlsS2V5KTsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkKSB7CiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdSZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUmV2aXZpbmcgaW5hY3RpdmUgJHtzY3JpcHRJZH1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGV4aXN0aW5nUmVjb3JkLnN0YXRlID0gJ3N0YXJ0ZWQnOwogICAgICAgICAgICAgICAgZXhpc3RpbmdSZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCByZWNvcmQgPSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGU6ICdzdGFydGluZycsCiAgICAgICAgICAgICAgICAgICAgdGFpbEtleQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkcy5zZXQodGFpbEtleSwgcmVjb3JkKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhaWxDcmVhdGluZ1RpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRpbmcoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YWlsID0gYXdhaXQgY3JlYXRlVGFpbChhY2NvdW50SWQsIHNjcmlwdElkLCBhcGlUb2tlbik7CiAgICAgICAgICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGVkKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCkgLSB0YWlsQ3JlYXRpbmdUaW1lLCB0YWlsKTsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgIT09ICdzdGFydGluZycpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHsgY2FsbGJhY2tzOiBjYWxsYmFja3MzICB9ID0gdGhpczsKICAgICAgICAgICAgICAgIGNvbnN0IG9wZW5pbmdUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhaWxDb25uZWN0aW9uQ2FsbGJhY2tzID0gewogICAgICAgICAgICAgICAgICAgIG9uT3BlbiAoX2NuLCB0aW1lU3RhbXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIERhdGUubm93KCkgLSBvcGVuaW5nVGltZSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvbkNsb3NlIChfY24sIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MzLm9uVGFpbENvbm5lY3Rpb25DbG9zZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb25FcnJvciAoX2NuLCB0aW1lU3RhbXAsIGVycm9ySW5mbykgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MzLm9uVGFpbENvbm5lY3Rpb25FcnJvcihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvblRhaWxNZXNzYWdlIChfY24sIHRpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnN0YXRlICE9PSAnc3RhcnRlZCcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb25VbnBhcnNlZE1lc3NhZ2UgKF9jbiwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrczMub25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZWNvcmQuY29ubmVjdGlvbiA9IG5ldyBUYWlsQ29ubmVjdGlvbih0YWlsLnVybCwgdGFpbENvbm5lY3Rpb25DYWxsYmFja3MpLnNldE9wdGlvbnModGhpcy50YWlsT3B0aW9ucyk7CiAgICAgICAgICAgICAgICByZWNvcmQuc3RhdGUgPSAnc3RhcnRlZCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFRhaWxzQ2hhbmdlZCgpOwogICAgICAgIH0KICAgIH0KICAgIGRpc3BhdGNoVGFpbHNDaGFuZ2VkKCkgewogICAgICAgIGNvbnN0IHRhaWxLZXlzID0gbmV3IFNldChbCiAgICAgICAgICAgIC4uLnRoaXMucmVjb3Jkcy52YWx1ZXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+di5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnCiAgICAgICAgKS5tYXAoKHYpPT52LnRhaWxLZXkKICAgICAgICApKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxzQ2hhbmdlZCh0YWlsS2V5cyk7CiAgICB9CiAgICBjb21wdXRlU3RhcnRpbmdPclN0YXJ0ZWRUYWlsS2V5cygpIHsKICAgICAgICByZXR1cm4gbmV3IFNldChbCiAgICAgICAgICAgIC4uLnRoaXMucmVjb3Jkcy52YWx1ZXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+di5zdGF0ZSA9PT0gJ3N0YXJ0aW5nJyB8fCB2LnN0YXRlID09PSAnc3RhcnRlZCcKICAgICAgICApLm1hcCgodik9PnYudGFpbEtleQogICAgICAgICkpOwogICAgfQp9CmZ1bmN0aW9uIHVucGFja1RhaWxLZXkodGFpbEtleSkgewogICAgY29uc3QgbSA9IC9eKFteXHMtXSspLShbXlxzXSspJC8uZXhlYyh0YWlsS2V5KTsKICAgIGlmICghbSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbEtleTogJHt0YWlsS2V5fWApOwogICAgcmV0dXJuIHsKICAgICAgICBhY2NvdW50SWQ6IG1bMV0sCiAgICAgICAgc2NyaXB0SWQ6IG1bMl0KICAgIH07Cn0KZnVuY3Rpb24gcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgcmV0dXJuIGAke2FjY291bnRJZH0tJHtzY3JpcHRJZH1gOwp9CmNsYXNzIFN3aXRjaGFibGVUYWlsQ29udHJvbGxlckNhbGxiYWNrcyB7CiAgICBjYWxsYmFja3M7CiAgICBlbmFibGVkRm47CiAgICBjb25zdHJ1Y3RvcihjYWxsYmFja3MzLCBlbmFibGVkRm4pewogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzMzsKICAgICAgICB0aGlzLmVuYWJsZWRGbiA9IGVuYWJsZWRGbjsKICAgIH0KICAgIG9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKTsKICAgIH0KICAgIG9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIHRvb2tNaWxsaXMpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIHRvb2tNaWxsaXMpOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbkNsb3NlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25DbG9zZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgIH0KICAgIG9uVGFpbHNDaGFuZ2VkKHRhaWxzKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsc0NoYW5nZWQodGFpbHMpOwogICAgfQp9CmNsYXNzIERlbW9Nb2RlIHsKICAgIHN0YXRpYyBwcm9maWxlcyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAncHJvZmlsZTEnLAogICAgICAgICAgICB0ZXh0OiAnY29ycC1wcm9maWxlJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3Byb2ZpbGUyJywKICAgICAgICAgICAgdGV4dDogJ3BlcnMtcHJvZmlsZScKICAgICAgICB9LCAKICAgIF07CiAgICBzdGF0aWMgc2VsZWN0ZWRQcm9maWxlSWQgPSAncHJvZmlsZTEnOwogICAgc3RhdGljIHNldFNlbGVjdGVkUHJvZmlsZUlkKF92YWx1ZSkgewogICAgfQogICAgc3RhdGljIHNjcmlwdHMgPSBbCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDEnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMS1kZXYnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MicsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIxLXByb2QnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MycsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIyLWRldicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ0JywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItYmV0YScKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ1JywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItcHJvZCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ2JywKICAgICAgICAgICAgdGV4dDogJ2R1cmFibGUtb2JqZWN0LWRlbW8nCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0NycsCiAgICAgICAgICAgIHRleHQ6ICdzZWNyZXQtYXBwJwogICAgICAgIH0sIAogICAgXTsKICAgIHN0YXRpYyBzZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgICdzY3JpcHQ3JywKICAgICAgICAnc2NyaXB0NCcKICAgIF0pOwogICAgc3RhdGljIHNldFNlbGVjdGVkU2NyaXB0SWRzKF9zY3JpcHRJZHMpIHsKICAgIH0KICAgIHN0YXRpYyB0YWlscyA9IG5ldyBTZXQoKTsKICAgIHN0YXRpYyBsb2dGYWtlT3V0cHV0KGNhbGxiYWNrcykgewogICAgICAgIGNvbnN0IGFjY291bnRJZCA9ICcxNWE3ZmEzYTM3MjU0ZmU0YTdjYWRkMWJiMjc2Mjg3OSc7CiAgICAgICAgY29uc3Qgc2NyaXB0SWQgPSAnc2VjcmV0LWFwcCc7CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgIGNvbnN0IHRhaWwgPSB7CiAgICAgICAgICAgIGlkOiAnZGIxOWViOGJlOWY0NDQzYWFiOTFhOTA0MmMwZDM1MTcnLAogICAgICAgICAgICB1cmw6ICd3c3M6Ly90YWlsLmRldmVsb3BlcnMud29ya2Vycy5kZXYvZGIxOWViOGJlOWY0NDQzYWFiOTFhOTA0MmMwZDM1MTcnLAogICAgICAgICAgICAnZXhwaXJlc19hdCc6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgICAgIH07CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgMTU1LCB0YWlsKTsKICAgICAgICBjYWxsYmFja3Mub25UYWlsc0NoYW5nZWQobmV3IFNldChbCiAgICAgICAgICAgIHBhY2tUYWlsS2V5KGFjY291bnRJZCwgc2NyaXB0SWQpCiAgICAgICAgXSkpOwogICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCA0Mik7CiAgICAgICAgZm9yKGxldCBpMSA9IDA7IGkxIDwgMjsgaTErKyl7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZVJlcXVlc3QoKSk7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZURvUmVxdWVzdCgpKTsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlUmVxdWVzdFdpdGhMb2dzKCkpOwogICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgY29tcHV0ZUZha2VSZXF1ZXN0RXhjZWVkaW5nVGltZUxpbWl0KCkpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBVU0VSX0FHRU5UID0gJ01vemlsbGEvNS4wIChNYWNpbnRvc2g7IEludGVsIE1hYyBPUyBYIDEwLjE1OyBydjo5MS4wKSBHZWNrby8yMDEwMDEwMSBGaXJlZm94LzkxLjAnOwpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3QoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2V4YW1wbGUuY29tL2VuZHBvaW50JywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ2NmLWNvbm5lY3RpbmctaXAnOiAnMjAzLjAuMTEzLjEyJywKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFVTRVJfQUdFTlQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjZjogewogICAgICAgICAgICAgICAgICAgIGNvbG86ICdERlcnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFtdLAogICAgICAgIGV4Y2VwdGlvbnM6IFtdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdvaycKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUZha2VEb1JlcXVlc3QoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2Zha2UtaG9zdC9wdXQnLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnUFVUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ2xvZ3Byb3BzOicsCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvOiAnRVdSJywKICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZU9iamVjdENsYXNzOiAnTG9nZ2VyRE8nLAogICAgICAgICAgICAgICAgICAgICAgICBkdXJhYmxlT2JqZWN0SWQ6ICc1MzhmYzdjZTU1YjE0ZTUzYjZiODU1MmJlZmViOWFmNCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGVPYmplY3ROYW1lOiAnbG9nMScKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3RXaXRoTG9ncygpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vbXktd29ya2VyLnN1YmRvbWFpbi53b3JrZXJzLmRldi90ZXN0P2xvZz10cnVlJywKICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ2NmLWNvbm5lY3RpbmctaXAnOiAnMjAzLjAuMTEzLjEyJywKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFVTRVJfQUdFTlQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjZjogewogICAgICAgICAgICAgICAgICAgIGNvbG86ICdERlcnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvZ3M6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdsb2cnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2Vycm9yJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdpbmZvJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICd3YXJuaW5nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV2ZWw6ICdkZWJ1ZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZVJlcXVlc3RFeGNlZWRpbmdUaW1lTGltaXQoKSB7CiAgICBjb25zdCBydCA9IHsKICAgICAgICBldmVudDogewogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL215LXdvcmtlci5zdWJkb21haW4ud29ya2Vycy5kZXYvY29tcHV0ZS1kaWdpdHMtb2YtcGknLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnY2YtY29ubmVjdGluZy1pcCc6ICcyMDMuMC4xMTMuMTInLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVVNFUl9BR0VOVAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNmOiB7CiAgICAgICAgICAgICAgICAgICAgY29sbzogJ0RGVycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ2J1cm5pbmcgY3B1JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV4Y2VwdGlvbnM6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmFtZTogJ0Vycm9yJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdXb3JrZXIgZXhjZWVkZWQgQ1BVIHRpbWUgbGltaXQuJwogICAgICAgICAgICB9LCAKICAgICAgICBdLAogICAgICAgIGV2ZW50VGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgIG91dGNvbWU6ICdleGNlZWRlZENwdScKICAgIH07CiAgICByZXR1cm4gcnQ7Cn0KY2xhc3MgUXBzQ29udHJvbGxlciB7CiAgICBzb3J0ZWRFdmVudFRpbWVzID0gW107CiAgICBjYWxsYmFja3M7CiAgICBuOwogICAgX3FwcyA9IDA7CiAgICBnZXQgcXBzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9xcHM7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihuMiwgY2FsbGJhY2tzNCl7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M0OwogICAgICAgIHRoaXMubiA9IG4yOwogICAgfQogICAgYWRkRXZlbnQoZXZlbnRUaW1lKSB7CiAgICAgICAgY29uc3QgcXBzID0gY29tcHV0ZVFwcyh0aGlzLm4sIHRoaXMuc29ydGVkRXZlbnRUaW1lcywgZXZlbnRUaW1lKTsKICAgICAgICBpZiAocXBzID09PSB0aGlzLl9xcHMpIHJldHVybjsKICAgICAgICB0aGlzLl9xcHMgPSBxcHM7CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25RcHNDaGFuZ2VkKHFwcyk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZVFwcyhuMywgc29ydGVkRXZlbnRUaW1lcywgZXZlbnRUaW1lKSB7CiAgICBhZGQoZXZlbnRUaW1lLCBzb3J0ZWRFdmVudFRpbWVzKTsKICAgIHdoaWxlKHNvcnRlZEV2ZW50VGltZXMubGVuZ3RoID4gbjMpewogICAgICAgIHNvcnRlZEV2ZW50VGltZXMuc2hpZnQoKTsKICAgIH0KICAgIGNvbnN0IG51bSA9IHNvcnRlZEV2ZW50VGltZXMubGVuZ3RoOwogICAgaWYgKG51bSA8IDIpIHJldHVybiAwOwogICAgY29uc3QgdGltZURpZmZTZWNvbmRzID0gKHNvcnRlZEV2ZW50VGltZXNbc29ydGVkRXZlbnRUaW1lcy5sZW5ndGggLSAxXSAtIHNvcnRlZEV2ZW50VGltZXNbMF0pIC8gMTAwMDsKICAgIHJldHVybiAobnVtIC0gMSkgLyB0aW1lRGlmZlNlY29uZHM7Cn0KZnVuY3Rpb24gYWRkKGVsLCBhcnIpIHsKICAgIGFyci5zcGxpY2UoZmluZExvYyhlbCwgYXJyKSArIDEsIDAsIGVsKTsKICAgIHJldHVybiBhcnI7Cn0KZnVuY3Rpb24gZmluZExvYyhlbCwgYXJyLCBzdCwgZW4pIHsKICAgIHN0ID0gc3QgfHwgMDsKICAgIGVuID0gZW4gfHwgYXJyLmxlbmd0aDsKICAgIGZvcihsZXQgaTEgPSAwOyBpMSA8IGFyci5sZW5ndGg7IGkxKyspewogICAgICAgIGlmIChhcnJbaTFdID4gZWwpIHsKICAgICAgICAgICAgcmV0dXJuIGkxIC0gMTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gZW47Cn0KY2xhc3MgVGFpbHdlYkFwcFZNIHsKICAgIF9wcm9maWxlcyA9IFtdOwogICAgZ2V0IHByb2ZpbGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUucHJvZmlsZXMgOiB0aGlzLl9wcm9maWxlczsKICAgIH0KICAgIGdldCByZWFsUHJvZmlsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2ZpbGVzOwogICAgfQogICAgX3NlbGVjdGVkUHJvZmlsZUlkOwogICAgZ2V0IHNlbGVjdGVkUHJvZmlsZUlkKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUuc2VsZWN0ZWRQcm9maWxlSWQgOiB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZDsKICAgIH0KICAgIHNldCBzZWxlY3RlZFByb2ZpbGVJZCh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSB7CiAgICAgICAgICAgIERlbW9Nb2RlLnNldFNlbGVjdGVkUHJvZmlsZUlkKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPT09IHZhbHVlKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPSB2YWx1ZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCA9IHZhbHVlOwogICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB0aGlzLmZpbmRTY3JpcHRzKCk7CiAgICB9CiAgICBfc2NyaXB0cyA9IFtdOwogICAgZ2V0IHNjcmlwdHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVtb01vZGUgPyBEZW1vTW9kZS5zY3JpcHRzIDogdGhpcy5fc2NyaXB0czsKICAgIH0KICAgIF9zZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoKTsKICAgIGdldCBzZWxlY3RlZFNjcmlwdElkcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnNlbGVjdGVkU2NyaXB0SWRzIDogdGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHM7CiAgICB9CiAgICBzZXQgc2VsZWN0ZWRTY3JpcHRJZHMoc2NyaXB0SWRzKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHsKICAgICAgICAgICAgRGVtb01vZGUuc2V0U2VsZWN0ZWRTY3JpcHRJZHMoc2NyaXB0SWRzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoc2V0RXF1YWwodGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHMsIHNjcmlwdElkcykpIHJldHVybjsKICAgICAgICB0aGlzLl9zZWxlY3RlZFNjcmlwdElkcyA9IG5ldyBTZXQoc2NyaXB0SWRzKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICBpZiAocHJvZmlsZSkgewogICAgICAgICAgICBwcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzID0gWwogICAgICAgICAgICAgICAgLi4uc2NyaXB0SWRzCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXRUYWlscygpOwogICAgfQogICAgcHJvZmlsZUZvcm0gPSBuZXcgUHJvZmlsZUZvcm1WTSgpOwogICAgZmlsdGVyRm9ybSA9IG5ldyBGaWx0ZXJGb3JtVk0oKTsKICAgIGZpbHRlciA9IHsKICAgIH07CiAgICBleHRyYUZpZWxkcyA9IFtdOwogICAgX3RhaWxzID0gbmV3IFNldCgpOwogICAgZ2V0IHRhaWxzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUudGFpbHMgOiB0aGlzLl90YWlsczsKICAgIH0KICAgIHNldCB0YWlscyh0YWlscykgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSBEZW1vTW9kZS50YWlscyA9IHRhaWxzOwogICAgICAgIHRoaXMuX3RhaWxzID0gdGFpbHM7CiAgICB9CiAgICB3ZWxjb21lU2hvd2luZyA9IGZhbHNlOwogICAgc3RhdGUgPSBsb2FkU3RhdGUoKTsKICAgIHRhaWxDb250cm9sbGVyOwogICAgdGFpbENvbnRyb2xsZXJDYWxsYmFja3M7CiAgICBxcHNDb250cm9sbGVyOwogICAgZGVtb01vZGUgPSBmYWxzZTsKICAgIG9uQ2hhbmdlID0gKCk9PnsKICAgIH07CiAgICBsb2dnZXIgPSAoKT0+ewogICAgfTsKICAgIG9uUmVzZXRPdXRwdXQgPSAoKT0+ewogICAgfTsKICAgIG9uUXBzQ2hhbmdlID0gKCk9PnsKICAgIH07CiAgICBjb25zdHJ1Y3RvcigpewogICAgICAgIGNvbnN0IGRpcyA9IHRoaXM7CiAgICAgICAgdGhpcy5xcHNDb250cm9sbGVyID0gbmV3IFFwc0NvbnRyb2xsZXIoMjAsIHsKICAgICAgICAgICAgb25RcHNDaGFuZ2VkIChxcHMpIHsKICAgICAgICAgICAgICAgIGlmIChkaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGRpcy5vblFwc0NoYW5nZShxcHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgbG9nVGFpbHNDaGFuZ2UgPSAoYWN0aW9uLCB0YWlsS2V5cyk9PnsKICAgICAgICAgICAgaWYgKHRhaWxLZXlzLnNpemUgPiAwKSB0aGlzLmxvZ1dpdGhQcmVmaXgoYCR7YWN0aW9ufSAke1sKICAgICAgICAgICAgICAgIC4uLnRhaWxLZXlzCiAgICAgICAgICAgIF0ubWFwKCh2KT0+dW5wYWNrVGFpbEtleSh2KS5zY3JpcHRJZAogICAgICAgICAgICApLnNvcnQoKS5qb2luKCcsICcpfWApOwogICAgICAgIH07CiAgICAgICAgY29uc3QgbG9nV2l0aFByZWZpeCA9IHRoaXMubG9nV2l0aFByZWZpeC5iaW5kKHRoaXMpOwogICAgICAgIGNvbnN0IHZlcmJvc2VXaXRoUHJlZml4ID0gdGhpcy52ZXJib3NlV2l0aFByZWZpeC5iaW5kKHRoaXMpOwogICAgICAgIGNvbnN0IGNhbGxiYWNrczUgPSB7CiAgICAgICAgICAgIG9uVGFpbENyZWF0aW5nIChfYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYENyZWF0aW5nIHRhaWwgZm9yICR7c2NyaXB0SWR9Li4uYCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENyZWF0ZWQgKF9hY2NvdW50SWQsIHNjcmlwdElkLCB0b29rTWlsbGlzLCB0YWlsKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ3JlYXRlZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXMsICR7SlNPTi5zdHJpbmdpZnkodGFpbCl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25PcGVuIChfYWNjb3VudElkLCBzY3JpcHRJZCwgX3RpbWVTdGFtcCwgdG9va01pbGxpcykgewogICAgICAgICAgICAgICAgdmVyYm9zZVdpdGhQcmVmaXgoYE9wZW5lZCB0YWlsIGZvciAke3NjcmlwdElkfSBpbiAke3Rvb2tNaWxsaXN9bXNgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbkNsb3NlIChhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uQ2xvc2UnLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ2xvc2VkIHRhaWwgZm9yICR7c2NyaXB0SWR9LCAke0pTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSl9YCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25FcnJvciAoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uRXJyb3InLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBlcnJvckluZm8KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgRXJyb3IgaW4gdGFpbCBmb3IgJHtzY3JpcHRJZH1gLCB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JJbmZvCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UgKF9hY2NvdW50SWQsIF9zY3JpcHRJZCwgX3RpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgaWYgKGNvbXB1dGVNZXNzYWdlUGFzc2VzRmlsdGVyKG1lc3NhZ2UsIGRpcy5maWx0ZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZSwgZGlzLmxvZ2dlciwgZGlzLmNvbXB1dGVBZGRpdGlvbmFsTG9ncyhtZXNzYWdlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgICAgICBkaXMucXBzQ29udHJvbGxlci5hZGRFdmVudChtZXNzYWdlLmV2ZW50VGltZXN0YW1wKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvblVucGFyc2VkTWVzc2FnZSAoX2FjY291bnRJZCwgc2NyaXB0SWQsIF90aW1lU3RhbXAsIG1lc3NhZ2UsIHBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeChgVW5wYXJzZWQgbWVzc2FnZSBpbiB0YWlsIGZvciAke3NjcmlwdElkfWAsIHBhcnNlRXJyb3Iuc3RhY2sgfHwgcGFyc2VFcnJvci5tZXNzYWdlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsc0NoYW5nZWQgKHRhaWxzKSB7CiAgICAgICAgICAgICAgICBpZiAoc2V0RXF1YWwoZGlzLnRhaWxzLCB0YWlscykpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92ZWQgPSBzZXRTdWJ0cmFjdChkaXMudGFpbHMsIHRhaWxzKTsKICAgICAgICAgICAgICAgIGxvZ1RhaWxzQ2hhbmdlKCdVbnRhaWxpbmcnLCByZW1vdmVkKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFkZGVkID0gc2V0U3VidHJhY3QodGFpbHMsIGRpcy50YWlscyk7CiAgICAgICAgICAgICAgICBsb2dUYWlsc0NoYW5nZSgnVGFpbGluZycsIGFkZGVkKTsKICAgICAgICAgICAgICAgIGRpcy50YWlscyA9IHRhaWxzOwogICAgICAgICAgICAgICAgZGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHRoaXMudGFpbENvbnRyb2xsZXIgPSBuZXcgVGFpbENvbnRyb2xsZXIobmV3IFN3aXRjaGFibGVUYWlsQ29udHJvbGxlckNhbGxiYWNrcyhjYWxsYmFja3M1LCAoKT0+IXRoaXMuZGVtb01vZGUKICAgICAgICApKTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzID0gY2FsbGJhY2tzNTsKICAgICAgICB0aGlzLmV4dHJhRmllbGRzID0gWwogICAgICAgICAgICAuLi50aGlzLnN0YXRlLmV4dHJhRmllbGRzIHx8IFtdCiAgICAgICAgXTsKICAgICAgICB0aGlzLmZpbHRlciA9IHRoaXMuc3RhdGUuZmlsdGVyIHx8IHsKICAgICAgICB9OwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiBmYWxzZQogICAgICAgIH0pOwogICAgfQogICAgc3RhcnQoKSB7CiAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgIHRoaXMucmVjb21wdXRlV2VsY29tZVNob3dpbmcoKTsKICAgICAgICB0aGlzLnBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCk7CiAgICB9CiAgICBuZXdQcm9maWxlKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLndlbGNvbWVTaG93aW5nKSB7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5wcm9maWxlSWQgPSBnZW5lcmF0ZVV1aWQoKTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0udGl0bGUgPSAnTmV3IFByb2ZpbGUnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ubmFtZSA9IHRoaXMuX3Byb2ZpbGVzLmxlbmd0aCA9PT0gMCA/ICdkZWZhdWx0JyA6IGBwcm9maWxlJHt0aGlzLl9wcm9maWxlcy5sZW5ndGggKyAxfWA7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hY2NvdW50SWQgPSAnJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID0gZmFsc2U7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRQcm9maWxlKHByb2ZpbGVJZCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBpZiAoIXByb2ZpbGUpIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSAke3Byb2ZpbGVJZH0gbm90IGZvdW5kYCk7CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQgPSBwcm9maWxlSWQ7CiAgICAgICAgY29uc3QgeyBuYW1lOiBuYW1lNCAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0udGl0bGUgPSAnRWRpdCBQcm9maWxlJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSBuYW1lNDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9IGFjY291bnRJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gYXBpVG9rZW47CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZGVsZXRlUHJvZmlsZShwcm9maWxlSWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnZGVsZXRlIHByb2ZpbGUnLCBwcm9maWxlSWQpOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgaWYgKCFwcm9maWxlKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgJHtwcm9maWxlSWR9IG5vdCBmb3VuZGApOwogICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMucmVsb2FkUHJvZmlsZXMoKTsKICAgICAgICB0aGlzLnJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCk7CiAgICAgICAgdGhpcy5wZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpOwogICAgfQogICAgY2FuY2VsUHJvZmlsZSgpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlTmFtZShuYW1lKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVBY2NvdW50SWQoYWNjb3VudElkKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hY2NvdW50SWQgPSBhY2NvdW50SWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlQXBpVG9rZW4oYXBpVG9rZW4pIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gYXBpVG9rZW47CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzYXZlUHJvZmlsZSgpIHsKICAgICAgICBjb25zdCB7IHByb2ZpbGVGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCB7IHByb2ZpbGVJZCAgfSA9IHByb2ZpbGVGb3JtOwogICAgICAgIGNvbnN0IG5ld1Byb2ZpbGUgPSB7CiAgICAgICAgICAgIG5hbWU6IHByb2ZpbGVGb3JtLm5hbWUudHJpbSgpLAogICAgICAgICAgICBhY2NvdW50SWQ6IHByb2ZpbGVGb3JtLmFjY291bnRJZC50cmltKCksCiAgICAgICAgICAgIGFwaVRva2VuOiBwcm9maWxlRm9ybS5hcGlUb2tlbi50cmltKCkKICAgICAgICB9OwogICAgICAgIHRoaXMudHJ5U2F2ZVByb2ZpbGUocHJvZmlsZUlkLCBuZXdQcm9maWxlKTsKICAgIH0KICAgIGVkaXRFdmVudEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0V2ZW50IHR5cGU6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2FsbCcsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQWxsJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2Nyb24nLAogICAgICAgICAgICAgICAgdGV4dDogJ0NST04gdHJpZ2dlcicKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICdodHRwJywKICAgICAgICAgICAgICAgIHRleHQ6ICdIVFRQIHJlcXVlc3QnCiAgICAgICAgICAgIH0sIAogICAgICAgIF07CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpbHRlci5ldmVudDEgPT09ICdodHRwJyA/ICdodHRwJyA6IGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyA/ICdjcm9uJyA6ICdhbGwnOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnQ2hvb3NlIHdoaWNoIHR5cGVzIG9mIGV2ZW50cyB0byBzaG93JzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLmV2ZW50MSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5ldmVudDEgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRDaG9pY2VUZXh0ID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5maW5kKCh2KT0+di5pZCA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlCiAgICAgICAgICAgICkudGV4dDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBFdmVudCB0eXBlIGZpbHRlciBjaGFuZ2VkIHRvOiAke3NlbGVjdGVkQ2hvaWNlVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTdGF0dXNGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdTdGF0dXM6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2FsbCcsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQWxsJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgdGV4dDogJ1N1Y2Nlc3MnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnZXJyb3InLAogICAgICAgICAgICAgICAgdGV4dDogJ0Vycm9yJwogICAgICAgICAgICB9LCAKICAgICAgICBdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuc3RhdHVzMSA9PT0gJ3N1Y2Nlc3MnID8gJ3N1Y2Nlc3MnIDogZmlsdGVyLnN0YXR1czEgPT09ICdlcnJvcicgPyAnZXJyb3InIDogJ2FsbCc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdTaG93IGV2ZW50cyB0aGlzIHRoaXMgc3RhdHVzJzsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBpZiAoZmlsdGVyLnN0YXR1czEgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc3RhdHVzMSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZENob2ljZVRleHQgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmZpbmQoKHYpPT52LmlkID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUKICAgICAgICAgICAgKS50ZXh0OwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYFN0YXR1cyBmaWx0ZXIgY2hhbmdlZCB0bzogJHtzZWxlY3RlZENob2ljZVRleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0SXBBZGRyZXNzRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBpc1ZhbGlkSXBBZGRyZXNzID0gKGlwQWRkcmVzcyk9PnsKICAgICAgICAgICAgcmV0dXJuIC9eKHNlbGZ8W1xkXC46YS1mXXszLH0pJC8udGVzdChpcEFkZHJlc3MpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY2hlY2tWYWxpZElwQWRkcmVzcyA9IChpcEFkZHJlc3MpPT57CiAgICAgICAgICAgIGlmICghaXNWYWxpZElwQWRkcmVzcyhpcEFkZHJlc3MpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBpcCBhZGRyZXNzOiAke2lwQWRkcmVzc31gKTsKICAgICAgICAgICAgcmV0dXJuIGlwQWRkcmVzczsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVySXBBZGRyZXNzZXNGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodiA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHYuc3BsaXQoJywnKS5tYXAoKHYxKT0+djEudHJpbSgpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYxKT0+djEgIT09ICcnCiAgICAgICAgICAgICkubWFwKGNoZWNrVmFsaWRJcEFkZHJlc3MpKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlcklwQWRkcmVzc2VzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5pcEFkZHJlc3MxIHx8IFtdKS5qb2luKCcsICcpOwogICAgICAgIH07CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0lQIGFkZHJlc3Mocyk6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlcklwQWRkcmVzc2VzKCk7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9IGAnc2VsZicgdG8gZmlsdGVyIHlvdXIgb3duIGFkZHJlc3MsIGNvbW1hLXNlcGFyYXRlZCBpZiBtdWx0aXBsZSwgZS5nLiBzZWxmLCAxLjEuMS4xYDsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlRmlsdGVySXBBZGRyZXNzZXNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIuaXBBZGRyZXNzMSB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWUpKSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuaXBBZGRyZXNzMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZS5sZW5ndGggPT09IDAgPyAnYW55IElQIGFkZHJlc3MnIDogbmV3VmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBJUCBhZGRyZXNzIGZpbHRlciBjaGFuZ2VkIHRvOiAke3RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0TWV0aG9kRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBwYXJzZUZpbHRlck1ldGhvZHNGcm9tRmllbGRWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IHsgZmllbGRWYWx1ZSAgfSA9IGZpbHRlckZvcm07CiAgICAgICAgICAgIGNvbnN0IHYgPSAoZmllbGRWYWx1ZSB8fCAnJykudHJpbSgpOwogICAgICAgICAgICBpZiAodiA9PT0gJycpIHJldHVybiBbXTsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KHYuc3BsaXQoJywnKS5tYXAoKHYxKT0+djEudHJpbSgpLnRvVXBwZXJDYXNlKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYxKT0+djEgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIubWV0aG9kMSB8fCBbXSkubWFwKCh2KT0+di50b1VwcGVyQ2FzZSgpCiAgICAgICAgICAgICkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdIVFRQIE1ldGhvZChzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCBlLmcuIEdFVCwgUE9TVCc7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlck1ldGhvZHNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIubWV0aG9kMSB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWUpKSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIubWV0aG9kMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZS5sZW5ndGggPT09IDAgPyAnYW55IG1ldGhvZCcgOiBuZXdWYWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYE1ldGhvZCBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNhbXBsaW5nUmF0ZUZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHBhcnNlU2FtcGxlUmF0ZUZyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIDE7CiAgICAgICAgICAgIGNvbnN0IG51bSA9IHBhcnNlRmxvYXQodik7CiAgICAgICAgICAgIGlmICghaXNWYWxpZFNhbXBsaW5nUmF0ZShudW0pKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcmF0ZTogJHt2fWApOwogICAgICAgICAgICByZXR1cm4gbnVtOwogICAgICAgIH07CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnU2FtcGxpbmcgcmF0ZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gKHR5cGVvZiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gJ251bWJlcicgJiYgaXNWYWxpZFNhbXBsaW5nUmF0ZShmaWx0ZXIuc2FtcGxpbmdSYXRlMSkgPyBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA6IDEpLnRvRml4ZWQoMik7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdDYW4gcmFuZ2UgZnJvbSAwICgwJSkgdG8gMSAoMTAwJSknOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VTYW1wbGVSYXRlRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKGZpbHRlci5zYW1wbGluZ1JhdGUxID09PSBuZXdWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZSA9PT0gMSA/ICdubyBzYW1wbGluZycgOiBgJHtuZXdWYWx1ZX0gKCR7KG5ld1ZhbHVlICogMTAwKS50b0ZpeGVkKDIpfSUpYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTYW1wbGUgcmF0ZSBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNlYXJjaEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1NlYXJjaCB0ZXh0Oic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuc2VhcmNoMSB8fCAnJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ0ZpbHRlciBieSBhIHRleHQgbWF0Y2ggaW4gY29uc29sZS5sb2cgbWVzc2FnZXMnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc2VhcmNoMSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5zZWFyY2gxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSAoZmlsdGVyLnNlYXJjaDEgfHwgJycpLmxlbmd0aCA9PT0gMCA/ICdubyBzZWFyY2ggZmlsdGVyJyA6IGAnJHtmaWx0ZXIuc2VhcmNoMX0nYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTZWFyY2ggZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRIZWFkZXJGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVySGVhZGVyc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3Qodi5zcGxpdCgnLCcpLm1hcCgodjEpPT52MS50cmltKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYxKT0+djEgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySGVhZGVycyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIuaGVhZGVyMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdIZWFkZXIocyk6JzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUZpbHRlckhlYWRlcnMoKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gYCdrZXknLCBvciAna2V5OnF1ZXJ5JywgY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlYDsKICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlRmlsdGVySGVhZGVyc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5oZWFkZXIxIHx8IFtdKSwgbmV3IFNldChuZXdWYWx1ZSkpKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5oZWFkZXIxID0gbmV3VmFsdWU7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICAgICAgc2F2ZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IG5ld1ZhbHVlLmxlbmd0aCA9PT0gMCA/ICdubyBoZWFkZXIgZmlsdGVyJyA6IG5ld1ZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgSGVhZGVyIGZpbHRlciBjaGFuZ2VkIHRvOiAke3RleHR9YCk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBoYXNBbnlGaWx0ZXJzKCkgewogICAgICAgIGNvbnN0IHsgZmlsdGVyICB9ID0gdGhpczsKICAgICAgICBjb25zdCB7IGV2ZW50MSAgfSA9IGZpbHRlcjsKICAgICAgICByZXR1cm4gY29tcHV0ZVRhaWxPcHRpb25zRm9yRmlsdGVyKGZpbHRlcikuZmlsdGVycy5sZW5ndGggPiAwIHx8IHR5cGVvZiBldmVudDEgPT09ICdzdHJpbmcnICYmIGV2ZW50MSAhPT0gJycgJiYgZXZlbnQxICE9PSAnYWxsJzsKICAgIH0KICAgIHJlc2V0RmlsdGVycygpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIHRoaXMuZmlsdGVyID0gewogICAgICAgIH07CiAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICB9KTsKICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYEZpbHRlcnMgcmVzZXRgKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBjYW5jZWxGaWx0ZXIoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ2NhbmNlbEZpbHRlcicpOwogICAgICAgIHRoaXMuZmlsdGVyRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2F2ZUZpbHRlcigpIHsKICAgICAgICBjb25zb2xlLmxvZygnc2F2ZUZpbHRlcicpOwogICAgICAgIGNvbnN0IHsgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlID0gJ0NoZWNraW5nIGZpbHRlci4uLic7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSgpOwogICAgICAgICAgICBmaWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2UgPSBgYDsKICAgICAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBmaWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2UgPSBgRXJyb3I6ICR7ZS5tZXNzYWdlfWA7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgc2VsZWN0RmlsdGVyQ2hvaWNlKGlkKSB7CiAgICAgICAgaWYgKHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlID09PSBpZCkgcmV0dXJuOwogICAgICAgIHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gaWQ7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNlbGVjdGlvbkZpZWxkcygpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0FkZGl0aW9uYWwgZmllbGRzOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBFWFRSQV9GSUVMRFNfT1BUSU9OUzsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSAodGhpcy5leHRyYUZpZWxkcyB8fCBbXSkuam9pbignLCcpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnU2VsZWN0IGFkZGl0aW9uYWwgZmllbGRzIHRvIHNob3cgaW4gdGhlIG91dHB1dCc7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWVzID0gZGlzdGluY3QoKGZpbHRlckZvcm0uZmllbGRWYWx1ZSB8fCAnJykuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKQogICAgICAgICAgICApLmZpbHRlcigodik9PnYgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldCh0aGlzLmV4dHJhRmllbGRzIHx8IFtdKSwgbmV3IFNldChuZXdWYWx1ZXMpKSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmV4dHJhRmllbGRzID0gbmV3VmFsdWVzOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGV4dHJhRmllbGRzVGV4dCA9IHRoaXMuY29tcHV0ZVNlbGVjdGlvbkZpZWxkc1RleHQoKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBPdXRwdXQgZmllbGRzIGNoYW5nZWQgdG86ICR7ZXh0cmFGaWVsZHNUZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgY29tcHV0ZVNlbGVjdGlvbkZpZWxkc1RleHQoKSB7CiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgJ3N0YW5kYXJkIGZpZWxkcycsCiAgICAgICAgICAgIC4uLnRoaXMuZXh0cmFGaWVsZHMubWFwKChpZCk9PkVYVFJBX0ZJRUxEU19PUFRJT05TLmZpbmQoKHYpPT52LmlkID09PSBpZAogICAgICAgICAgICAgICAgKT8udGV4dCB8fCBpZAogICAgICAgICAgICApCiAgICAgICAgXS5qb2luKCcsICcpOwogICAgfQogICAgdG9nZ2xlRmlsdGVyT3B0aW9uKGlkKSB7CiAgICAgICAgY29uc3QgZXh0cmFGaWVsZHMgPSBkaXN0aW5jdCgodGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgfHwgJycpLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICAgICApLmZpbHRlcigodik9PnYgIT09ICcnCiAgICAgICAgKSk7CiAgICAgICAgY29uc3QgaTEgPSBleHRyYUZpZWxkcy5pbmRleE9mKGlkKTsKICAgICAgICBpZiAoaTEgPj0gMCkgewogICAgICAgICAgICBleHRyYUZpZWxkcy5zcGxpY2UoaTEsIDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4dHJhRmllbGRzLnB1c2goaWQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBmaWVsZFZhbHVlID0gZXh0cmFGaWVsZHMuam9pbignLCcpOwogICAgICAgIGlmICh0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9PT0gZmllbGRWYWx1ZSkgcmV0dXJuOwogICAgICAgIHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmllbGRWYWx1ZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICB0b2dnbGVEZW1vTW9kZSgpIHsKICAgICAgICB0aGlzLnNldERlbW9Nb2RlKCF0aGlzLmRlbW9Nb2RlKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICByZXNldE91dHB1dCgpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIHRoaXMub25SZXNldE91dHB1dCgpOwogICAgfQogICAgc2V0RGVtb01vZGUoZGVtb01vZGUpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSA9PT0gZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmRlbW9Nb2RlID0gZGVtb01vZGU7CiAgICAgICAgaWYgKGRlbW9Nb2RlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFbmFibGUgZGVtbyBtb2RlJyk7CiAgICAgICAgICAgIHRoaXMub25RcHNDaGFuZ2UoMTIuMzQpOwogICAgICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgICAgICAgICAgRGVtb01vZGUubG9nRmFrZU91dHB1dCh0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRGlzYWJsZSBkZW1vIG1vZGUnKTsKICAgICAgICAgICAgdGhpcy5vblFwc0NoYW5nZSh0aGlzLnFwc0NvbnRyb2xsZXIucXBzKTsKICAgICAgICAgICAgdGhpcy5vblJlc2V0T3V0cHV0KCk7CiAgICAgICAgfQogICAgfQogICAgYXBwbHlGaWx0ZXIob3B0cykgewogICAgICAgIGNvbnN0IHsgc2F2ZSAgfSA9IG9wdHM7CiAgICAgICAgdGhpcy5zdGF0ZS5maWx0ZXIgPSB0aGlzLmZpbHRlcjsKICAgICAgICB0aGlzLnN0YXRlLmV4dHJhRmllbGRzID0gdGhpcy5leHRyYUZpZWxkczsKICAgICAgICBpZiAoc2F2ZSkgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIGNvbnN0IHRhaWxPcHRpb25zID0gY29tcHV0ZVRhaWxPcHRpb25zRm9yRmlsdGVyKHRoaXMuZmlsdGVyKTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyLnNldFRhaWxPcHRpb25zKHRhaWxPcHRpb25zKTsKICAgIH0KICAgIGxvZ1dpdGhQcmVmaXgoLi4uZGF0YSkgewogICAgICAgIGNvbnN0IHRpbWUgPSBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpOwogICAgICAgIGlmIChkYXRhLmxlbmd0aCA+IDAgJiYgdHlwZW9mIGRhdGFbMF0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGRhdGEgPSBbCiAgICAgICAgICAgICAgICBgWyVjJHt0aW1lfSVjXSAke2RhdGFbMF19YCwKICAgICAgICAgICAgICAgICdjb2xvcjogZ3JheScsCiAgICAgICAgICAgICAgICAnJywKICAgICAgICAgICAgICAgIC4uLmRhdGEuc2xpY2UoMSkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sb2dnZXIoLi4uZGF0YSk7CiAgICB9CiAgICB2ZXJib3NlV2l0aFByZWZpeChtZXNzYWdlKSB7CiAgICAgICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSk7CiAgICAgICAgdGhpcy5sb2dnZXIoYFslYyR7dGltZX0lY10gJWMke21lc3NhZ2V9JWNgLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5Jyk7CiAgICB9CiAgICBwZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpIHsKICAgICAgICBjb25zdCBpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZCA9IGNvbXB1dGVJbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZCh0aGlzLnN0YXRlLCB0aGlzLl9wcm9maWxlcyk7CiAgICAgICAgaWYgKGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJbml0aWFsbHkgc2VsZWN0aW5nIHByb2ZpbGU6ICR7dGhpcy5zdGF0ZS5wcm9maWxlc1tpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZF0ubmFtZX1gKTsKICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9IGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyB0cnlTYXZlUHJvZmlsZShwcm9maWxlSWQsIHByb2ZpbGUpIHsKICAgICAgICBjb25zdCB7IHByb2ZpbGVGb3JtICB9ID0gdGhpczsKICAgICAgICBwcm9maWxlRm9ybS5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgcHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlID0gdHJ1ZTsKICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJ0NoZWNraW5nIHByb2ZpbGUuLi4nOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBjYW5MaXN0VGFpbHMgPSBhd2FpdCBjb21wdXRlQ2FuTGlzdFRhaWxzKHByb2ZpbGUuYWNjb3VudElkLCBwcm9maWxlLmFwaVRva2VuKTsKICAgICAgICAgICAgaWYgKGNhbkxpc3RUYWlscykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdID0gcHJvZmlsZTsKICAgICAgICAgICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnJzsKICAgICAgICAgICAgICAgIHRoaXMucmVsb2FkUHJvZmlsZXMoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjb21wdXRlV2VsY29tZVNob3dpbmcoKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPSBwcm9maWxlSWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gYFRoZXNlIGNyZWRlbnRpYWxzIGRvIG5vdCBoYXZlIHBlcm1pc3Npb24gdG8gdGFpbGA7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSBgRXJyb3I6ICR7ZS5tZXNzYWdlfWA7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICBwcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgcHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICByZWxvYWRQcm9maWxlcygpIHsKICAgICAgICBjb25zdCB7IHN0YXRlICB9ID0gdGhpczsKICAgICAgICB0aGlzLl9wcm9maWxlcy5zcGxpY2UoMCk7CiAgICAgICAgZm9yIChjb25zdCBbcHJvZmlsZUlkLCBwcm9maWxlXSBvZiBPYmplY3QuZW50cmllcyhzdGF0ZS5wcm9maWxlcykpewogICAgICAgICAgICBjb25zdCBuYW1lNCA9IHByb2ZpbGUubmFtZSB8fCAnKHVubmFtZWQpJzsKICAgICAgICAgICAgdGhpcy5fcHJvZmlsZXMucHVzaCh7CiAgICAgICAgICAgICAgICBpZDogcHJvZmlsZUlkLAogICAgICAgICAgICAgICAgdGV4dDogbmFtZTQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgZmluZFNjcmlwdHMoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICAgICAgaWYgKHByb2ZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICAgICAgdGhpcy52ZXJib3NlV2l0aFByZWZpeChgRmluZGluZyBzY3JpcHRzIGZvciAke3Byb2ZpbGUubmFtZS50b1VwcGVyQ2FzZSgpfS4uLmApOwogICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIGNvbnN0IHNjcmlwdHMgPSBhd2FpdCBsaXN0U2NyaXB0cyhhY2NvdW50SWQsIGFwaVRva2VuKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlbW9Nb2RlKSB0aGlzLnZlcmJvc2VXaXRoUHJlZml4KGBGb3VuZCAke3NjcmlwdHMubGVuZ3RofSBzY3JpcHRzIGluICR7RGF0ZS5ub3coKSAtIHN0YXJ0fW1zYCk7CiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMuc3BsaWNlKDApOwogICAgICAgICAgICBmb3IgKGNvbnN0IHNjcmlwdCBvZiBzY3JpcHRzKXsKICAgICAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaWQ6IHNjcmlwdC5pZCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBzY3JpcHQuaWQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHMuc29ydCgobGhzLCByaHMpPT5saHMudGV4dC5sb2NhbGVDb21wYXJlKHJocy50ZXh0KQogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZFNjcmlwdElkcyA9IHRoaXMuY29tcHV0ZVNlbGVjdGVkU2NyaXB0SWRzQWZ0ZXJGaW5kU2NyaXB0cygpOwogICAgICAgICAgICBpZiAoc2VsZWN0ZWRTY3JpcHRJZHMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRTY3JpcHRJZHMgPSBzZWxlY3RlZFNjcmlwdElkczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuZGVtb01vZGUpIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZW1vTW9kZSkgdGhpcy5sb2dnZXIoYEVycm9yIGluIGZpbmRTY3JpcHRzOiAke2Uuc3RhY2t9YCk7CiAgICAgICAgfQogICAgfQogICAgY29tcHV0ZVNlbGVjdGVkU2NyaXB0SWRzQWZ0ZXJGaW5kU2NyaXB0cygpIHsKICAgICAgICBpZiAodGhpcy5fc2NyaXB0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0luaXRpYWxseSBzZWxlY3Rpbmcgbm8gc2NyaXB0cywgbm8gc2NyaXB0cyB0byBzZWxlY3QnKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCAmJiB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkKSB7CiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxQcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICAgICAgaWYgKGluaXRpYWxQcm9maWxlICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzICYmIGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY3JpcHRJZHMgPSBuZXcgU2V0KHRoaXMuX3NjcmlwdHMubWFwKCh2KT0+di5pZAogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gc2V0SW50ZXJzZWN0KGN1cnJlbnRTY3JpcHRJZHMsIG5ldyBTZXQoaW5pdGlhbFByb2ZpbGUuc2VsZWN0ZWRTY3JpcHRJZHMpKTsKICAgICAgICAgICAgICAgIGlmIChjYW5kaWRhdGVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEluaXRpYWxseSBzZWxlY3Rpbmcgc2NyaXB0JHtjYW5kaWRhdGVzLnNpemUgPT09IDEgPyAnJyA6ICdzJ30gJHtbCiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmNhbmRpZGF0ZXMKICAgICAgICAgICAgICAgICAgICBdLnNvcnQoKS5qb2luKCcsICcpfTogcmVtZW1iZXJlZCBmcm9tIGxhc3QgdGltZWApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYW5kaWRhdGVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpcnN0U2NyaXB0SWQgPSB0aGlzLl9zY3JpcHRzWzBdLmlkOwogICAgICAgIGNvbnNvbGUubG9nKGBJbml0aWFsbHkgc2VsZWN0aW5nIHNjcmlwdCAke2ZpcnN0U2NyaXB0SWR9OiBmaXJzdCBvbmUgaW4gdGhlIGxpc3RgKTsKICAgICAgICByZXR1cm4gbmV3IFNldChbCiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHNbMF0uaWQKICAgICAgICBdKTsKICAgIH0KICAgIGFzeW5jIHNldFRhaWxzKCkgewogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1t0aGlzLnNlbGVjdGVkUHJvZmlsZUlkXTsKICAgICAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy50YWlsQ29udHJvbGxlci5zZXRUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuLCB0aGlzLl9zZWxlY3RlZFNjcmlwdElkcyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmxvZ2dlcignRXJyb3IgaW4gc2V0VGFpbHMnLCBlLnN0YWNrIHx8IGUubWVzc2FnZSk7CiAgICAgICAgfQogICAgfQogICAgY29tcHV0ZUFkZGl0aW9uYWxMb2dzKG1lc3NhZ2UpIHsKICAgICAgICBjb25zdCBydCA9IFtdOwogICAgICAgIGNvbnN0IGluY2x1ZGVJcEFkZHJlc3MgPSB0aGlzLmV4dHJhRmllbGRzLmluY2x1ZGVzKCdpcC1hZGRyZXNzJyk7CiAgICAgICAgY29uc3QgaW5jbHVkZVVzZXJBZ2VudCA9IHRoaXMuZXh0cmFGaWVsZHMuaW5jbHVkZXMoJ3VzZXItYWdlbnQnKTsKICAgICAgICBpZiAoaW5jbHVkZUlwQWRkcmVzcyB8fCBpbmNsdWRlVXNlckFnZW50KSB7CiAgICAgICAgICAgIGlmICghaXNUYWlsTWVzc2FnZUNyb25FdmVudChtZXNzYWdlLmV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVJcEFkZHJlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpcEFkZHJlc3MgPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3QuaGVhZGVyc1snY2YtY29ubmVjdGluZy1pcCddIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAoaXBBZGRyZXNzKSBydC5wdXNoKGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZCgnSVAgYWRkcmVzcycsIGlwQWRkcmVzcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVVc2VyQWdlbnQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyQWdlbnQgPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3QuaGVhZGVyc1sndXNlci1hZ2VudCddIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAodXNlckFnZW50KSBydC5wdXNoKGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZCgnVXNlciBhZ2VudCcsIHVzZXJBZ2VudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBydDsKICAgIH0KICAgIHJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCkgewogICAgICAgIGNvbnN0IHNob3VsZFNob3cgPSB0aGlzLnByb2ZpbGVzLmxlbmd0aCA9PT0gMDsKICAgICAgICBpZiAoc2hvdWxkU2hvdyA9PT0gdGhpcy53ZWxjb21lU2hvd2luZykgcmV0dXJuOwogICAgICAgIHRoaXMuc2V0RGVtb01vZGUoc2hvdWxkU2hvdyk7CiAgICAgICAgdGhpcy53ZWxjb21lU2hvd2luZyA9IHNob3VsZFNob3c7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKG5hbWU0LCB2YWx1ZSkgewogICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBbCiAgICAgICAgICAgIGAgJWN8JWMgWyVjJHtuYW1lNH0lY10gJHt2YWx1ZX1gLAogICAgICAgICAgICAnY29sb3I6Z3JheScsCiAgICAgICAgICAgICcnLAogICAgICAgICAgICAnY29sb3I6Z3JheScKICAgICAgICBdCiAgICB9Owp9CmNsYXNzIFByb2ZpbGVGb3JtVk0gewogICAgc2hvd2luZyA9IGZhbHNlOwogICAgZW5hYmxlZCA9IGZhbHNlOwogICAgbmFtZSA9ICcnOwogICAgYWNjb3VudElkID0gJyc7CiAgICBhcGlUb2tlbiA9ICcnOwogICAgZGVsZXRlVmlzaWJsZSA9IGZhbHNlOwogICAgc2F2ZUVuYWJsZWQgPSBmYWxzZTsKICAgIHByb2ZpbGVJZCA9ICcnOwogICAgdGl0bGUgPSAnJzsKICAgIHByb2dyZXNzVmlzaWJsZSA9IGZhbHNlOwogICAgb3V0cHV0TWVzc2FnZSA9ICcnOwogICAgY29tcHV0ZVNhdmVFbmFibGVkKCkgewogICAgICAgIHRoaXMuc2F2ZUVuYWJsZWQgPSB0aGlzLm5hbWUudHJpbSgpLmxlbmd0aCA+IDAgJiYgdGhpcy5hcGlUb2tlbi50cmltKCkubGVuZ3RoID4gMCAmJiB0aGlzLmFjY291bnRJZC50cmltKCkubGVuZ3RoID4gMDsKICAgIH0KfQpjbGFzcyBGaWx0ZXJGb3JtVk0gewogICAgc2hvd2luZyA9IGZhbHNlOwogICAgZW5hYmxlZCA9IGZhbHNlOwogICAgZmllbGROYW1lID0gJyc7CiAgICBmaWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgIGZpZWxkVmFsdWU7CiAgICBoZWxwVGV4dCA9ICcnOwogICAgb3V0cHV0TWVzc2FnZSA9ICcnOwogICAgYXBwbHlWYWx1ZSA9ICgpPT57CiAgICB9Owp9CmNvbnN0IEVYVFJBX0ZJRUxEU19PUFRJT05TID0gWwogICAgewogICAgICAgIGlkOiAnaXAtYWRkcmVzcycsCiAgICAgICAgdGV4dDogJ0lQIGFkZHJlc3MnCiAgICB9LAogICAgewogICAgICAgIGlkOiAndXNlci1hZ2VudCcsCiAgICAgICAgdGV4dDogJ1VzZXIgYWdlbnQnCiAgICB9LCAKXTsKY29uc3QgU1RBVEVfS0VZID0gJ3N0YXRlMSc7CmZ1bmN0aW9uIGxvYWRTdGF0ZSgpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QganNvbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUQVRFX0tFWSkgfHwgdW5kZWZpbmVkOwogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIGNvbnN0IG9iaiA9IEpTT04ucGFyc2UoanNvbik7CiAgICAgICAgICAgIGNvbnN0IHJ0ID0gcGFyc2VTdGF0ZShvYmopOwogICAgICAgICAgICByZXR1cm4gcnQ7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUud2FybignbG9hZFN0YXRlOiBFcnJvciBsb2FkaW5nIHN0YXRlJywgZSk7CiAgICB9CiAgICBjb25zb2xlLmxvZygnbG9hZFN0YXRlOiByZXR1cm5pbmcgbmV3IHN0YXRlJyk7CiAgICByZXR1cm4gewogICAgICAgIHByb2ZpbGVzOiB7CiAgICAgICAgfQogICAgfTsKfQpmdW5jdGlvbiBwYXJzZVN0YXRlKHBhcnNlZCkgewogICAgaWYgKHR5cGVvZiBwYXJzZWQgIT09ICdvYmplY3QnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIG9iamVjdGApOwogICAgY29uc3QgeyBwcm9maWxlcyAgfSA9IHBhcnNlZDsKICAgIGlmICh0eXBlb2YgcHJvZmlsZXMgIT09ICdvYmplY3QnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHByb2ZpbGVzIG9iamVjdGApOwogICAgZm9yIChjb25zdCBbcHJvZmlsZUlkLCBwcm9maWxlU3RhdGVdIG9mIE9iamVjdC5lbnRyaWVzKHByb2ZpbGVzKSl7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9maWxlSWQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2ZpbGUgaWQgbXVzdCBiZSBzdHJpbmcnKTsKICAgICAgICBwYXJzZVByb2ZpbGVTdGF0ZShwcm9maWxlU3RhdGUpOwogICAgfQogICAgcmV0dXJuIHBhcnNlZDsKfQpmdW5jdGlvbiBwYXJzZVByb2ZpbGVTdGF0ZShwYXJzZWQpIHsKICAgIGlmICh0eXBlb2YgcGFyc2VkICE9PSAnb2JqZWN0JyB8fCBwYXJzZWQgPT09IG51bGwpIHRocm93IG5ldyBFcnJvcignUHJvZmlsZSBzdGF0ZSBtdXN0IGJlIG9iamVjdCcpOwogICAgY29uc3QgeyBuYW1lOiBuYW1lNCAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcGFyc2VkOwogICAgaWYgKHR5cGVvZiBuYW1lNCAhPT0gJ3N0cmluZycgfHwgbmFtZTQudHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIG5hbWUgbXVzdCBleGlzdGApOwogICAgaWYgKHR5cGVvZiBhY2NvdW50SWQgIT09ICdzdHJpbmcnIHx8IGFjY291bnRJZC50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgYWNjb3VudElkIG11c3QgZXhpc3RgKTsKICAgIGlmICh0eXBlb2YgYXBpVG9rZW4gIT09ICdzdHJpbmcnIHx8IGFwaVRva2VuLnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBhcGlUb2tlbiBtdXN0IGV4aXN0YCk7CiAgICByZXR1cm4gcGFyc2VkOwp9CmZ1bmN0aW9uIHNhdmVTdGF0ZShzdGF0ZSkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RBVEVfS0VZLCBKU09OLnN0cmluZ2lmeShzdGF0ZSkpOwp9CmFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVDYW5MaXN0VGFpbHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgdHJ5IHsKICAgICAgICBhd2FpdCBsaXN0VGFpbHMoYWNjb3VudElkLCAnJywgYXBpVG9rZW4pOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChlIGluc3RhbmNlb2YgQ2xvdWRmbGFyZUFwaUVycm9yICYmIGUuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9CmZ1bmN0aW9uIGlzVmFsaWRTYW1wbGluZ1JhdGUoc2FtcGxpbmdSYXRlKSB7CiAgICByZXR1cm4gIWlzTmFOKHNhbXBsaW5nUmF0ZSkgJiYgc2FtcGxpbmdSYXRlID49IDAgJiYgc2FtcGxpbmdSYXRlIDw9IDE7Cn0KZnVuY3Rpb24gY29tcHV0ZUluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKHN0YXRlLCBwcm9maWxlcykgewogICAgaWYgKHN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkICYmIHN0YXRlLnByb2ZpbGVzW3N0YXRlLnNlbGVjdGVkUHJvZmlsZUlkXSkgcmV0dXJuIHN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkOwogICAgaWYgKHByb2ZpbGVzLmxlbmd0aCA+IDApIHJldHVybiBwcm9maWxlc1swXS5pZDsKICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gY29tcHV0ZVRhaWxPcHRpb25zRm9yRmlsdGVyKGZpbHRlcikgewogICAgY29uc3QgZmlsdGVycyA9IFtdOwogICAgaWYgKGZpbHRlci5zdGF0dXMxID09PSAnZXJyb3InKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgb3V0Y29tZTogWwogICAgICAgICAgICAgICAgJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgICAgICAnZXhjZWVkZWRDcHUnLAogICAgICAgICAgICAgICAgJ2NhbmNlbGVkJywKICAgICAgICAgICAgICAgICd1bmtub3duJwogICAgICAgICAgICBdCiAgICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGZpbHRlci5zdGF0dXMxID09PSAnc3VjY2VzcycpIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBvdXRjb21lOiBbCiAgICAgICAgICAgICAgICAnb2snCiAgICAgICAgICAgIF0KICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuc2FtcGxpbmdSYXRlMSAhPT0gdW5kZWZpbmVkICYmIGlzVmFsaWRTYW1wbGluZ1JhdGUoZmlsdGVyLnNhbXBsaW5nUmF0ZTEpICYmIGZpbHRlci5zYW1wbGluZ1JhdGUxIDwgMSkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIHNhbXBsaW5nX3JhdGU6IGZpbHRlci5zYW1wbGluZ1JhdGUxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLnNlYXJjaDEgIT09IHVuZGVmaW5lZCAmJiBmaWx0ZXIuc2VhcmNoMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgcXVlcnk6IGZpbHRlci5zZWFyY2gxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLm1ldGhvZDEgJiYgZmlsdGVyLm1ldGhvZDEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIG1ldGhvZDogZmlsdGVyLm1ldGhvZDEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuaXBBZGRyZXNzMSAmJiBmaWx0ZXIuaXBBZGRyZXNzMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgY2xpZW50X2lwOiBmaWx0ZXIuaXBBZGRyZXNzMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5oZWFkZXIxICYmIGZpbHRlci5oZWFkZXIxLmxlbmd0aCA+IDApIHsKICAgICAgICBmb3IgKGNvbnN0IGhlYWRlciBvZiBmaWx0ZXIuaGVhZGVyMSl7CiAgICAgICAgICAgIGZpbHRlcnMucHVzaChwYXJzZUhlYWRlckZpbHRlcihoZWFkZXIpKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGZpbHRlcnMKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZU1lc3NhZ2VQYXNzZXNGaWx0ZXIobWVzc2FnZTIsIGZpbHRlcikgewogICAgaWYgKGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyB8fCBmaWx0ZXIuZXZlbnQxID09PSAnaHR0cCcpIHsKICAgICAgICBjb25zdCBpc0Nyb24gPSBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UyKTsKICAgICAgICByZXR1cm4gaXNDcm9uICYmIGZpbHRlci5ldmVudDEgPT09ICdjcm9uJyB8fCAhaXNDcm9uICYmIGZpbHRlci5ldmVudDEgPT09ICdodHRwJzsKICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIGRpc3RpbmN0KHZhbHVlczEpIHsKICAgIGNvbnN0IHJ0ID0gW107CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlczEpewogICAgICAgIGlmICghcnQuaW5jbHVkZXModmFsdWUpKSB7CiAgICAgICAgICAgIHJ0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBydDsKfQpjb25zdCBGSUxURVJfRURJVE9SX0hUTUwgPSBodG1sYAo8Zm9ybSBpZD0iZmlsdGVyLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJmaWx0ZXItZmllbGRzZXQiPgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0IGZvcm0tcm93Ij5FZGl0IGZpbHRlcjwvZGl2PgoKICA8bGFiZWwgaWQ9ImZpbHRlci1maWVsZC1sYWJlbCI+RmlsdGVyIGZpZWxkOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJmaWx0ZXItZmllbGQtdGV4dCIgdHlwZT0idGV4dCI+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLWNob2ljZSI+PC9kaXY+CiAgPGRpdiBpZD0iZmlsdGVyLWZpZWxkLW9wdGlvbnMiPjwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1oZWxwIiBjbGFzcz0iYm9keTIgbWVkaXVtLWVtcGhhc2lzLXRleHQiPgogIDwvZGl2PiAgCgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLW91dHB1dC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8b3V0cHV0IGlkPSJmaWx0ZXItZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogIDwvZGl2PgoKICA8ZGl2IGlkPSJmaWx0ZXItZm9ybS1idXR0b25zIiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0iZmlsdGVyLWFwcGx5IiB0eXBlPSJzdWJtaXQiPkFwcGx5PC9idXR0b24+PCEtLSBmaXJzdCBzbyBpdCBpcyBkZWZhdWx0IGJ1dHRvbiBvbiByZXR1cm4gLS0+CiAgICA8YnV0dG9uIGlkPSJmaWx0ZXItY2FuY2VsIj5DYW5jZWw8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBGSUxURVJfRURJVE9SX0NTUyA9IGNzc2AKCiAgICAjZmlsdGVyLWZvcm0tYnV0dG9ucyB7CiAgICAgICAganVzdGlmeS1zZWxmOiBlbmQ7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtY2hvaWNlIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXB4OwogICAgfQoKICAgICNmaWx0ZXItZmllbGQtb3B0aW9ucyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBnYXA6IDFweDsKICAgIH0KCiAgICAjZmlsdGVyLWZpZWxkLW9wdGlvbnMgYnV0dG9uIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAwLjVyZW07CiAgICB9CgogICAgI2ZpbHRlci1mb3JtLWhlbHAgewogICAgICAgIGdyaWQtY29sdW1uOiAyOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1vdXRwdXQtcm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgICAgIG1pbi1oZWlnaHQ6IDIuNXJlbTsKICAgIH0KCiAgICAjZmlsdGVyLWZvcm0tb3V0cHV0LXJvdyBvdXRwdXQgewogICAgICAgIGZsZXgtZ3JvdzogMTsKICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRGaWx0ZXJFZGl0b3IoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBmaWx0ZXJGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGRzZXQnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkTGFiZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWxhYmVsJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZFRleHRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtdGV4dCcpOwogICAgY29uc3QgZmlsdGVyRmllbGRDaG9pY2VEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWNob2ljZScpOwogICAgY29uc3QgZmlsdGVyRmllbGRPcHRpb25zRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZC1vcHRpb25zJyk7CiAgICBjb25zdCBmaWx0ZXJDYW5jZWxCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWNhbmNlbCcpOwogICAgY29uc3QgZmlsdGVyQXBwbHlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWFwcGx5Jyk7CiAgICBjb25zdCBmaWx0ZXJGb3JtT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtLW91dHB1dCcpOwogICAgY29uc3QgZmlsdGVyRm9ybUhlbHBEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZvcm0taGVscCcpOwogICAgZmlsdGVyQ2FuY2VsQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uY2FuY2VsRmlsdGVyKCk7CiAgICB9OwogICAgZmlsdGVyQXBwbHlCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBjb25zdCB0eXBlMiA9IGNvbXB1dGVUeXBlKHZtKTsKICAgICAgICBpZiAodHlwZTIgPT09ICd0ZXh0JykgewogICAgICAgICAgICB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXJGaWVsZFRleHRJbnB1dC52YWx1ZTsKICAgICAgICB9CiAgICAgICAgdm0uc2F2ZUZpbHRlcigpOwogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0hpZGRlbiA9IGZpbHRlckZvcm0uc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIGZpbHRlckZvcm0uc3R5bGUuZGlzcGxheSA9IHZtLmZpbHRlckZvcm0uc2hvd2luZyA/ICdncmlkJyA6ICdub25lJzsKICAgICAgICBmaWx0ZXJGaWVsZHNldC5kaXNhYmxlZCA9ICF2bS5maWx0ZXJGb3JtLmVuYWJsZWQ7CiAgICAgICAgY29uc3QgdHlwZTIgPSBjb21wdXRlVHlwZSh2bSk7CiAgICAgICAgZmlsdGVyRmllbGRMYWJlbC50ZXh0Q29udGVudCA9IHZtLmZpbHRlckZvcm0uZmllbGROYW1lOwogICAgICAgIGZpbHRlckZpZWxkTGFiZWwuaHRtbEZvciA9IHR5cGUyID09ICdjaG9pY2UnID8gZmlsdGVyRmllbGRDaG9pY2VEaXYuaWQgOiB0eXBlMiA9PSAnb3B0aW9ucycgPyBmaWx0ZXJGaWVsZE9wdGlvbnNEaXYuaWQgOiBmaWx0ZXJGaWVsZFRleHRJbnB1dC5pZDsKICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5zdHlsZS5kaXNwbGF5ID0gdHlwZTIgPT0gJ3RleHQnID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBmaWx0ZXJGaWVsZENob2ljZURpdi5zdHlsZS5kaXNwbGF5ID0gdHlwZTIgPT0gJ2Nob2ljZScgPyAnZmxleCcgOiAnbm9uZSc7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoQ0hPSUNFU19IVE1MKHZtKSwgZmlsdGVyRmllbGRDaG9pY2VEaXYpOwogICAgICAgIGZpbHRlckZpZWxkT3B0aW9uc0Rpdi5zdHlsZS5kaXNwbGF5ID0gdHlwZTIgPT0gJ29wdGlvbnMnID8gJ2ZsZXgnIDogJ25vbmUnOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKE9QVElPTlNfSFRNTCh2bSksIGZpbHRlckZpZWxkT3B0aW9uc0Rpdik7CiAgICAgICAgZmlsdGVyRm9ybUhlbHBEaXYudGV4dENvbnRlbnQgPSB2bS5maWx0ZXJGb3JtLmhlbHBUZXh0OwogICAgICAgIGZpbHRlckZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bS5maWx0ZXJGb3JtLm91dHB1dE1lc3NhZ2U7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiB2bS5maWx0ZXJGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2ZpbHRlciBmb3JtIG9wZW4nKTsKICAgICAgICAgICAgaWYgKHR5cGUyID09PSAndGV4dCcgJiYgdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlKSBmaWx0ZXJGaWVsZFRleHRJbnB1dC52YWx1ZSA9IHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgICAgICAgICAgZmlsdGVyRmllbGRUZXh0SW5wdXQuZm9jdXMoKTsKICAgICAgICAgICAgICAgIGZpbHRlckZpZWxkVGV4dElucHV0LnNlbGVjdCgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVUeXBlKHZtKSB7CiAgICByZXR1cm4gdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5sZW5ndGggPiAwID8gJ2Nob2ljZScgOiB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zLmxlbmd0aCA/ICdvcHRpb25zJyA6ICd0ZXh0JzsKfQpjb25zdCBDSE9JQ0VTX0hUTUwgPSAodm0pPT57CiAgICByZXR1cm4gdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcy5tYXAoKGNob2ljZSk9Pmh0bWxgPGJ1dHRvbiBjbGFzcz0iJHtjaG9pY2UuaWQgPT09IHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA/ICdzZWxlY3RlZCcgOiAnJ30iIEBjbGljaz0keyhlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtLnNlbGVjdEZpbHRlckNob2ljZShjaG9pY2UuaWQpOwogICAgICAgIH19ID9kaXNhYmxlZD0iJHshdm0uZmlsdGVyRm9ybS5zaG93aW5nfSI+JHtjaG9pY2UudGV4dH08L2J1dHRvbj5gCiAgICApOwp9Owpjb25zdCBPUFRJT05TX0hUTUwgPSAodm0pPT57CiAgICByZXR1cm4gdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucy5tYXAoKG9wdGlvbik9PnsKICAgICAgICBjb25zdCBzZWxlY3RlZCA9IGZpZWxkVmFsdWVTZXQodm0pLmhhcyhvcHRpb24uaWQpOwogICAgICAgIHJldHVybiBodG1sYDxidXR0b24gY2xhc3M9IiR7c2VsZWN0ZWQgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2bS50b2dnbGVGaWx0ZXJPcHRpb24ob3B0aW9uLmlkKTsKICAgICAgICB9fSA/ZGlzYWJsZWQ9IiR7IXZtLmZpbHRlckZvcm0uc2hvd2luZ30iPiR7c2VsZWN0ZWQgPyBDSEVDS19CT1hfQ0hFQ0tFRF9JQ09OIDogQ0hFQ0tfQk9YX1VOQ0hFQ0tFRF9JQ09OfSAke29wdGlvbi50ZXh0fTwvYnV0dG9uPmA7CiAgICB9KTsKfTsKZnVuY3Rpb24gZmllbGRWYWx1ZVNldCh2bSkgewogICAgcmV0dXJuIG5ldyBTZXQoKHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZSB8fCAnJykuc3BsaXQoJywnKS5tYXAoKHYpPT52LnRyaW0oKQogICAgKS5maWx0ZXIoKHYpPT52Lmxlbmd0aCA+IDAKICAgICkpOwp9CmNvbnN0IFBST0ZJTEVfRURJVE9SX0hUTUwgPSBodG1sYAo8Zm9ybSBpZD0icHJvZmlsZS1mb3JtIiBhdXRvY29tcGxldGU9Im9mZiI+CjxmaWVsZHNldCBpZD0icHJvZmlsZS1maWVsZHNldCI+CiAgPGRpdiBpZD0icHJvZmlsZS1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0Ij5Qcm9maWxlPC9kaXY+CgogIDxsYWJlbCBmb3I9InByb2ZpbGUtbmFtZSI+UHJvZmlsZSBuYW1lOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJwcm9maWxlLW5hbWUiIHR5cGU9InRleHQiPgoKICA8bGFiZWwgZm9yPSJhY2NvdW50LWlkIj5DbG91ZGZsYXJlIEFjY291bnQgSUQ6PC9sYWJlbD4KICA8aW5wdXQgaWQ9InByb2ZpbGUtYWNjb3VudC1pZCIgdHlwZT0idGV4dCI+CgogIDxsYWJlbCBmb3I9ImFwaS10b2tlbiI+Q2xvdWRmbGFyZSBBUEkgVG9rZW46PC9sYWJlbD4KICA8aW5wdXQgaWQ9InByb2ZpbGUtYXBpLXRva2VuIiB0eXBlPSJ0ZXh0Ij4KCiAgPGRldGFpbHMgaWQ9InByb2ZpbGUtZm9ybS1oZWxwLXJvdyIgY2xhc3M9ImZvcm0tcm93Ij4KICAgIDxzdW1tYXJ5PlVzZSBhIDxhIGhyZWY9Imh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1ByaW5jaXBsZV9vZl9sZWFzdF9wcml2aWxlZ2UiIHRhcmdldD0iX2JsYW5rIj5sZWFzdCBwcml2aWxlZ2U8L2E+IHRva2VuIHdpdGggcGVybWlzc2lvbjogPGNvZGU+QWNjb3VudCAmZ3Q7IFdvcmtlcnMgVGFpbCAmZ3Q7IFJlYWQ8L2NvZGU+PC9zdW1tYXJ5PgogICAgPG9sPgogICAgICAgIDxsaT5TZWxlY3QgPHNwYW4gY2xhc3M9ImNmLWJ1dHRvbiI+Q3JlYXRlIFRva2VuPC9zcGFuPiBvbiB5b3VyIENsb3VkZmxhcmUgPGEgaHJlZj0iaHR0cHM6Ly9kYXNoLmNsb3VkZmxhcmUuY29tL3Byb2ZpbGUvYXBpLXRva2VucyIgdGFyZ2V0PSJfYmxhbmsiPkFQSSBUb2tlbnM8L2E+IHBhZ2UuPC9saT4KICAgICAgICA8bGk+U2Nyb2xsIGRvd24gdG8gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPkNyZWF0ZSBDdXN0b20gVG9rZW48L3NwYW4+LCB0aGVuIDxzcGFuIGNsYXNzPSJjZi1idXR0b24iPkdldCBzdGFydGVkPC9zcGFuPjwvbGk+CiAgICAgICAgPGxpPlVuZGVyIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5QZXJtaXNzaW9uczwvc3Bhbj4sIGdyYW50IHlvdXIgdG9rZW4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPkFjY291bnQ8L3NwYW4+IDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5Xb3JrZXJzIFRhaWw8L3NwYW4+IDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5SZWFkPC9zcGFuPjwvbGk+CiAgICA8L29sPgogIDwvZGV0YWlscz4gIAoKICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyIgY2xhc3M9ImZvcm0tcm93Ij4KICAgIDxvdXRwdXQgaWQ9InByb2ZpbGUtZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogICAgPHByb2dyZXNzIGlkPSJwcm9maWxlLWZvcm0tcHJvZ3Jlc3MiIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmb3JtLWxocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWRlbGV0ZSI+RGVsZXRlPC9idXR0b24+CiAgPC9kaXY+CiAgPGRpdiBpZD0icHJvZmlsZS1mb3JtLWJ1dHRvbnMiIGNsYXNzPSJmb3JtLXJocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWNhbmNlbCI+Q2FuY2VsPC9idXR0b24+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLXNhdmUiPlNhdmU8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBQUk9GSUxFX0VESVRPUl9DU1MgPSBjc3NgCgogICAgI3Byb2ZpbGUtZm9ybS1idXR0b25zIHsKICAgICAgICBqdXN0aWZ5LXNlbGY6IGVuZDsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXJlbTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IHsKICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBzdW1tYXJ5IHsKICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IG9sIHsKICAgICAgICBjdXJzb3I6IGRlZmF1bHQ7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBsaSB7CiAgICAgICAgcGFkZGluZzogMC41cmVtIDA7CiAgICB9CgogICAgLmNmLWJ1dHRvbiB7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IGJsdWU7CiAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIHBhZGRpbmc6IDAuMjVyZW0gMC41cmVtOwogICAgICAgIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgICB9CgogICAgLmNmLXNlY3Rpb24gewogICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICAgcGFkZGluZzogMC4yNXJlbSAwLjVyZW07CiAgICAgICAgb3V0bGluZTogc29saWQgMXB4IGdyYXk7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1vdXRwdXQtcm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgICAgIG1pbi1oZWlnaHQ6IDIuNXJlbTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLW91dHB1dC1yb3cgb3V0cHV0IHsKICAgICAgICBmbGV4LWdyb3c6IDE7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1wcm9ncmVzcyB7CiAgICAgICAgZm9udC1zaXplOiAwLjVyZW07IC8qIGRlZmF1bHQgM2VtID0+IDEuNXJlbSAqLwogICAgfQoKYDsKZnVuY3Rpb24gaW5pdFByb2ZpbGVFZGl0b3IoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBwcm9maWxlRm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0nKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtVGl0bGVEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLXRpdGxlJyk7CiAgICBjb25zdCBwcm9maWxlRmllbGRzZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1maWVsZHNldCcpOwogICAgY29uc3QgcHJvZmlsZU5hbWVJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLW5hbWUnKTsKICAgIGNvbnN0IHByb2ZpbGVBY2NvdW50SWRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFjY291bnQtaWQnKTsKICAgIGNvbnN0IHByb2ZpbGVBcGlUb2tlbklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtYXBpLXRva2VuJyk7CiAgICBjb25zdCBwcm9maWxlRGVsZXRlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZGVsZXRlJyk7CiAgICBjb25zdCBwcm9maWxlQ2FuY2VsQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtY2FuY2VsJyk7CiAgICBjb25zdCBwcm9maWxlU2F2ZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLXNhdmUnKTsKICAgIGNvbnN0IHByb2ZpbGVGb3JtUHJvZ3Jlc3MgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLXByb2dyZXNzJyk7CiAgICBjb25zdCBwcm9maWxlRm9ybU91dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0tb3V0cHV0Jyk7CiAgICBjb25zdCBwcm9maWxlRm9ybUhlbHBEZXRhaWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1oZWxwLXJvdycpOwogICAgcHJvZmlsZUNhbmNlbEJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmNhbmNlbFByb2ZpbGUoKTsKICAgIH07CiAgICBwcm9maWxlTmFtZUlucHV0Lm9uaW5wdXQgPSAoKT0+ewogICAgICAgIHZtLnNldFByb2ZpbGVOYW1lKHByb2ZpbGVOYW1lSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVBY2NvdW50SWRJbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bS5zZXRQcm9maWxlQWNjb3VudElkKHByb2ZpbGVBY2NvdW50SWRJbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZUFwaVRva2VuSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0uc2V0UHJvZmlsZUFwaVRva2VuKHByb2ZpbGVBcGlUb2tlbklucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlU2F2ZUJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLnNhdmVQcm9maWxlKCk7CiAgICB9OwogICAgcHJvZmlsZURlbGV0ZUJ1dHRvbi5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmRlbGV0ZVByb2ZpbGUodm0ucHJvZmlsZUZvcm0ucHJvZmlsZUlkKTsKICAgIH07CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB3YXNIaWRkZW4gPSBwcm9maWxlRm9ybS5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7CiAgICAgICAgcHJvZmlsZUZvcm0uc3R5bGUuZGlzcGxheSA9IHZtLnByb2ZpbGVGb3JtLnNob3dpbmcgPyAnZ3JpZCcgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZUZpZWxkc2V0LmRpc2FibGVkID0gIXZtLnByb2ZpbGVGb3JtLmVuYWJsZWQ7CiAgICAgICAgcHJvZmlsZUZvcm1UaXRsZURpdi50ZXh0Q29udGVudCA9IHZtLnByb2ZpbGVGb3JtLnRpdGxlOwogICAgICAgIHByb2ZpbGVOYW1lSW5wdXQudmFsdWUgPSB2bS5wcm9maWxlRm9ybS5uYW1lOwogICAgICAgIHByb2ZpbGVBY2NvdW50SWRJbnB1dC52YWx1ZSA9IHZtLnByb2ZpbGVGb3JtLmFjY291bnRJZDsKICAgICAgICBwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSA9IHZtLnByb2ZpbGVGb3JtLmFwaVRva2VuOwogICAgICAgIHByb2ZpbGVEZWxldGVCdXR0b24uc3R5bGUuZGlzcGxheSA9IHZtLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPyAnaW5saW5lLWJsb2NrJyA6ICdub25lJzsKICAgICAgICBwcm9maWxlU2F2ZUJ1dHRvbi5kaXNhYmxlZCA9ICF2bS5wcm9maWxlRm9ybS5zYXZlRW5hYmxlZDsKICAgICAgICBwcm9maWxlRm9ybVByb2dyZXNzLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVGb3JtT3V0cHV0LnRleHRDb250ZW50ID0gdm0ucHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZTsKICAgICAgICBpZiAod2FzSGlkZGVuICYmIHZtLnByb2ZpbGVGb3JtLnNob3dpbmcpIHsKICAgICAgICAgICAgY29uc3QgaW5pdGlhbERldGFpbHNPcGVuID0gdm0ucmVhbFByb2ZpbGVzLmxlbmd0aCA9PT0gMDsKICAgICAgICAgICAgcHJvZmlsZUZvcm1IZWxwRGV0YWlscy5vcGVuID0gaW5pdGlhbERldGFpbHNPcGVuOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LnNlbGVjdCgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IFdFTENPTUVfUEFORUxfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJ3ZWxjb21lLXBhbmVsIiBhdXRvY29tcGxldGU9Im9mZiI+CjxmaWVsZHNldCBpZD0id2VsY29tZS1wYW5lbC1maWVsZHNldCI+CiAgPGRpdiBpZD0id2VsY29tZS1wYW5lbC1mb3JtLXRpdGxlIiBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0IGZvcm0tcm93Ij5IZWxsbyDwn5GLPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tcm93IGJvZHkyIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij4KICAgIFdlbGNvbWUgdG8gPHNwYW4gY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+RGVub2ZsYXJlIFRhaWw8L3NwYW4+IQogICAgPHA+VmlldyByZWFsLXRpbWUgcmVxdWVzdHMgYW5kIGxvZ3MgZnJvbSA8YSBocmVmPSJodHRwczovL3dvcmtlcnMuY2xvdWRmbGFyZS5jb20vIiB0YXJnZXQ9Il9ibGFuayI+Q2xvdWRmbGFyZSBXb3JrZXJzPC9hPiBmcm9tIHRoZSBjb21mb3J0IG9mIHlvdXIgYnJvd3Nlci4gCiAgICBBIGZldyBlbmhhbmNlbWVudHMgb3ZlciB3aGF0J3MgcHJvdmlkZWQgPGEgaHJlZj0iaHR0cHM6Ly9ibG9nLmNsb3VkZmxhcmUuY29tL2ludHJvZHVjaW5nLXdvcmtlcnMtZGFzaGJvYXJkLWxvZ3MvIiB0YXJnZXQ9Il9ibGFuayI+YnkgZGVmYXVsdDwvYT4gaW4gdGhlIENsb3VkZmxhcmUgZGFzaGJvYXJkOjwvcD4KICAgIDx1bD4KICAgICAgICA8bGk+VGFpbCBtdWx0aXBsZSB3b3JrZXJzIGF0IHRoZSBzYW1lIHRpbWU8L2xpPgogICAgICAgIDxsaT5BZHZhbmNlZCBmaWx0ZXJpbmcgYW5kIG11bHRpLWNvbG9yIG91dHB1dCBzaW1pbGFyIHRvIDxhIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVycy5jbG91ZGZsYXJlLmNvbS93b3JrZXJzL2NsaS13cmFuZ2xlci9jb21tYW5kcyN0YWlsIiB0YXJnZXQ9Il9ibGFuayI+d3JhbmdsZXIgdGFpbDwvYT48L2xpPgogICAgICAgIDxsaT5EdXJhYmxlIG9iamVjdCBjbGFzcy9uYW1lL2lkIGFuZCBjb2xvIGluZm9ybWF0aW9uIGNhbiBiZSBzdXJmYWNlZCB3aXRoIDxhIGhyZWY9IlRPRE8iIHRhcmdldD0iX2JsYW5rIj5sb2dwcm9wczwvYT48L2xpPgogICAgICAgIDxsaT5NdWx0aXBsZSBwcm9maWxlcywgc3dpdGNoIGVhc2lseSBiZXR3ZWVuIG11bHRpcGxlIGFjY291bnRzPC9saT4KICAgICAgICA8bGk+Tm8gbmVlZCB0byBsb2cgaW4gd2l0aCB5b3VyIGZ1bGwgQ2xvdWRmbGFyZSBjcmVkZW50aWFscy4gIFByb2ZpbGVzIGFyZSBzdG9yZWQgbG9jYWxseSBpbiB0aGUgYnJvd3NlciwgYW5kIGNhbiBiZSBwZXJtaXNzaW9uZWQgb25seSBmb3IgdGFpbGluZyB3b3JrZXJzPC9saT4KICAgICAgICA8bGk+SW1wbGVtZW50ZWQgYXMgYSBzdGFuZGFyZCBvcGVuIHNvdXJjZSBDbG91ZGZsYXJlIFdvcmtlciwgPGEgaHJlZj0iVE9ETyIgdGFyZ2V0PSJfYmxhbmsiPmRlcGxveSBpdCB0byB5b3VyIG93biBhY2NvdW50PC9hPiwgCiAgICAgICAgICAgIG9yIDxhIGhyZWY9IlRPRE8iIHRhcmdldD0iX2JsYW5rIj5ob3N0IGl0IGxvY2FsbHk8L2E+IHdpdGggPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL3NreW1ldGhvZC9kZW5vZmxhcmUiIHRhcmdldD0iX2JsYW5rIj48Y29kZT5kZW5vZmxhcmU8L2NvZGU+PC9hPjwvbGk+CiAgICA8L3VsPgogICAgPHA+Q3JlYXRlIGEgbmV3IHByb2ZpbGUgdG8gZ2V0IHN0YXJ0ZWQhPC9wPgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmb3JtLXJocyI+CiAgICA8YnV0dG9uIGlkPSJ3ZWxjb21lLXBhbmVsLW5ldy1wcm9maWxlIiB0eXBlPSJzdWJtaXQiPk5ldyBwcm9maWxlPC9idXR0b24+CiAgPC9kaXY+CjwvZmllbGRzZXQ+CjwvZm9ybT4KYDsKY29uc3QgV0VMQ09NRV9QQU5FTF9DU1MgPSBjc3NgCgogICAgI3dlbGNvbWUtcGFuZWwtZm9ybS10aXRsZSB7CiAgICAgICAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgICB9CgpgOwpmdW5jdGlvbiBpbml0V2VsY29tZVBhbmVsKGRvY3VtZW50LCB2bSkgewogICAgY29uc3Qgd2VsY29tZVBhbmVsRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3ZWxjb21lLXBhbmVsJyk7CiAgICBjb25zdCBuZXdQcm9maWxlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtbmV3LXByb2ZpbGUnKTsKICAgIG5ld1Byb2ZpbGVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5uZXdQcm9maWxlKCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gd2VsY29tZVBhbmVsRWxlbWVudC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7CiAgICAgICAgY29uc3Qgc2hvdyA9IHZtLndlbGNvbWVTaG93aW5nICYmICF2bS5wcm9maWxlRm9ybS5zaG93aW5nOwogICAgICAgIHdlbGNvbWVQYW5lbEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IHNob3cgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGlmICh3YXNIaWRkZW4gJiYgc2hvdykgewogICAgICAgICAgICBjb25zb2xlLmxvZygnd2VsY29tZSBwYW5lbCBvcGVuJyk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIG5ld1Byb2ZpbGVCdXR0b24uZm9jdXMoKTsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBNT0RBTF9IVE1MID0gaHRtbGAKPGRpdiBpZD0ibW9kYWwiIGNsYXNzPSJtb2RhbCI+CiAgICA8ZGl2IGNsYXNzPSJtb2RhbC1jb250ZW50Ij4KICAgICR7V0VMQ09NRV9QQU5FTF9IVE1MfQogICAgJHtQUk9GSUxFX0VESVRPUl9IVE1MfQogICAgJHtGSUxURVJfRURJVE9SX0hUTUx9CiAgICA8L2Rpdj4KPC9kaXY+CmA7CmNvbnN0IE1PREFMX0NTUyA9IGNzc2AKLm1vZGFsIHsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICB6LWluZGV4OiAxOwogICAgbGVmdDogMDsKICAgIHRvcDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMCwgMCwgMC40KTsKfQoKLm1vZGFsLWNvbnRlbnQgewogICAgbWFyZ2luOiAxNSUgYXV0bzsKICAgIHdpZHRoOiA4MCU7CiAgICBtYXgtd2lkdGg6IDQwcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KYDsKZnVuY3Rpb24gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgbW9kYWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kYWwnKTsKICAgIGNvbnN0IHVwZGF0ZVByb2ZpbGVFZGl0b3IgPSBpbml0UHJvZmlsZUVkaXRvcihkb2N1bWVudCwgdm0pOwogICAgY29uc3QgdXBkYXRlRmlsdGVyRWRpdG9yID0gaW5pdEZpbHRlckVkaXRvcihkb2N1bWVudCwgdm0pOwogICAgY29uc3QgdXBkYXRlV2VsY29tZVBhbmVsID0gaW5pdFdlbGNvbWVQYW5lbChkb2N1bWVudCwgdm0pOwogICAgY29uc3QgY2xvc2VNb2RhbCA9ICgpPT57CiAgICAgICAgaWYgKCF2bS5wcm9maWxlRm9ybS5zaG93aW5nICYmICF2bS5maWx0ZXJGb3JtLnNob3dpbmcgJiYgIXZtLndlbGNvbWVTaG93aW5nKSByZXR1cm47CiAgICAgICAgaWYgKHZtLnByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSkgcmV0dXJuOwogICAgICAgIHZtLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bS5maWx0ZXJGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB2bS5vbkNoYW5nZSgpOwogICAgfTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudCk9PnsKICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09IG1vZGFsKSB7CiAgICAgICAgICAgIGNsb3NlTW9kYWwoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZXZlbnQpPT57CiAgICAgICAgZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7CiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gJ0VzY2FwZScpIHsKICAgICAgICAgICAgY2xvc2VNb2RhbCgpOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgdXBkYXRlUHJvZmlsZUVkaXRvcigpOwogICAgICAgIHVwZGF0ZUZpbHRlckVkaXRvcigpOwogICAgICAgIHVwZGF0ZVdlbGNvbWVQYW5lbCgpOwogICAgICAgIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5zaG93aW5nIHx8IHZtLmZpbHRlckZvcm0uc2hvd2luZyB8fCB2bS53ZWxjb21lU2hvd2luZyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKY29uc3QgQ09OU09MRV9IVE1MID0gaHRtbGAKPGRpdiBpZD0iY29uc29sZSI+CiAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlciI+CiAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItZmlsdGVycyIgY2xhc3M9ImJvZHkyIj48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1zdGF0dXMiPgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci10YWlscyIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItcXBzIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1jbGVhciI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxjb2RlIGlkPSJjb25zb2xlLWxhc3QtbGluZSIgY2xhc3M9ImxpbmUiPnNwYWNlcjwvY29kZT4KPC9kaXY+CmA7CmNvbnN0IENPTlNPTEVfQ1NTID0gY3NzYAoKI2NvbnNvbGUgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgd2lkdGg6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIG92ZXJmbG93LXk6IHNjcm9sbDsKICAgIG92ZXJmbG93LXg6IGhpZGRlbjsKICAgIGZsZXgtZ3JvdzogMTsKfQoKI2NvbnNvbGU6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICAgIHdpZHRoOiAxcmVtOwogICAgaGVpZ2h0OiAzcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCiNjb25zb2xlLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgaGVpZ2h0OiAzLjc1cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMS4yNXJlbSAxcmVtIDFyZW0gMDsKfQoKI2NvbnNvbGUtaGVhZGVyLWZpbHRlcnMgewogICAgZmxleC1ncm93OiAxOwogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1zYW5zLXNlcmlmLWZvbnQtZmFtaWx5KTsKCiAgICBkaXNwbGF5OiAtd2Via2l0LWJveDsKICAgIC13ZWJraXQtbGluZS1jbGFtcDogMzsKICAgIC13ZWJraXQtYm94LW9yaWVudDogdmVydGljYWw7ICAKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1zdGF0dXMgewogICAgaGVpZ2h0OiAxcmVtOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtaW4td2lkdGg6IDZyZW07CiAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgIHBhZGRpbmctdG9wOiAwLjI1cmVtOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCiNjb25zb2xlLWhlYWRlci10YWlscyB7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgojY29uc29sZS1oZWFkZXItY2xlYXIgewogICAgbWFyZ2luLXJpZ2h0OiAtMC41cmVtOwogICAgbWFyZ2luLWxlZnQ6IDFyZW07CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1jbGVhciAuYWN0aW9uLWljb24gewogICAgcGFkZGluZy1yaWdodDogMC41cmVtOwogICAgcGFkZGluZy1sZWZ0OiAwLjVyZW07Cn0KCiNjb25zb2xlIC5saW5lIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1zaXplOiAwLjc1cmVtOyAvKiAxMnB4ICovCiAgICBsaW5lLWhlaWdodDogMS4xcmVtOwogICAgZm9udC1mYW1pbHk6IHZhcigtLW1vbm9zcGFjZS1mb250LWZhbWlseSk7CiAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCiNjb25zb2xlLWxhc3QtbGluZSB7CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCmA7CmZ1bmN0aW9uIGluaXRDb25zb2xlKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgY29uc29sZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyRmlsdGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1maWx0ZXJzJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyVGFpbHNFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLXRhaWxzJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyUXBzRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1xcHMnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJDbGVhckVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItY2xlYXInKTsKICAgIGNvbnN0IGNvbnNvbGVMYXN0TGluZUVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1sYXN0LWxpbmUnKTsKICAgIGxldCBzaG93aW5nQ2xlYXJCdXR0b24gPSBmYWxzZTsKICAgIHZtLmxvZ2dlciA9ICguLi5kYXRhKT0+ewogICAgICAgIGNvbnN0IGxpbmVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY29kZScpOwogICAgICAgIGxpbmVFbGVtZW50LmNsYXNzTmFtZSA9ICdsaW5lJzsKICAgICAgICBsZXQgcG9zID0gMDsKICAgICAgICB3aGlsZShwb3MgPCBkYXRhLmxlbmd0aCl7CiAgICAgICAgICAgIGlmIChwb3MgPiAwKSB7CiAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnLCAnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgbXNnID0gZGF0YVtwb3NdOwogICAgICAgICAgICBpZiAodHlwZW9mIG1zZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRva2VucyA9IG1zZy5zcGxpdCgnJWMnKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaTEgPSAwOyBpMSA8IHRva2Vucy5sZW5ndGg7IGkxKyspewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGkxID4gMCAmJiBpMSA8IHRva2Vucy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZGF0YVtwb3MgKyBpMV07CiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uc2V0QXR0cmlidXRlKCdzdHlsZScsIHN0eWxlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyVGV4dEludG9TcGFuKHRva2Vuc1tpMV0sIHNwYW4pOwogICAgICAgICAgICAgICAgICAgIGxpbmVFbGVtZW50LmFwcGVuZENoaWxkKHNwYW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcG9zICs9IDEgKyB0b2tlbnMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxpbmVFbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKEpTT04uc3RyaW5naWZ5KG1zZykpKTsKICAgICAgICAgICAgICAgIHBvcysrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnNvbGVEaXYuaW5zZXJ0QmVmb3JlKGxpbmVFbGVtZW50LCBjb25zb2xlTGFzdExpbmVFbGVtZW50KTsKICAgICAgICBjb25zdCB7IHNjcm9sbEhlaWdodCAsIHNjcm9sbFRvcCAsIGNsaWVudEhlaWdodCAgfSA9IGNvbnNvbGVEaXY7CiAgICAgICAgY29uc3QgZGlmZiA9IHNjcm9sbEhlaWdodCAtIHNjcm9sbFRvcDsKICAgICAgICBjb25zdCBhdXRvc2Nyb2xsID0gZGlmZiAtIDE2ICogNCA8PSBjbGllbnRIZWlnaHQ7CiAgICAgICAgaWYgKGF1dG9zY3JvbGwpIHsKICAgICAgICAgICAgY29uc29sZUxhc3RMaW5lRWxlbWVudC5zY3JvbGxJbnRvVmlldyhmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGlmICghc2hvd2luZ0NsZWFyQnV0dG9uKSB7CiAgICAgICAgICAgIGNvbnNvbGVIZWFkZXJDbGVhckVsZW1lbnQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICAgICAgc2hvd2luZ0NsZWFyQnV0dG9uID0gdHJ1ZTsKICAgICAgICB9CiAgICB9OwogICAgdm0ub25SZXNldE91dHB1dCA9ICgpPT57CiAgICAgICAgY29uc3QgbGluZXMgPSBjb25zb2xlRGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJy5saW5lJyk7CiAgICAgICAgbGluZXMuZm9yRWFjaCgobGluZSk9PnsKICAgICAgICAgICAgaWYgKGxpbmUuaWQgIT09ICdjb25zb2xlLWxhc3QtbGluZScpIGNvbnNvbGVEaXYucmVtb3ZlQ2hpbGQobGluZSk7CiAgICAgICAgfSk7CiAgICAgICAgY29uc29sZUhlYWRlckNsZWFyRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CiAgICAgICAgc2hvd2luZ0NsZWFyQnV0dG9uID0gZmFsc2U7CiAgICB9OwogICAgY29uc29sZUhlYWRlclFwc0VsZW1lbnQudGV4dENvbnRlbnQgPSBjb21wdXRlUXBzVGV4dCgwKTsKICAgIHZtLm9uUXBzQ2hhbmdlID0gKHFwcyk9PnsKICAgICAgICBjb25zb2xlSGVhZGVyUXBzRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbXB1dGVRcHNUZXh0KHFwcyk7CiAgICB9OwogICAgTGl0RWxlbWVudC5yZW5kZXIoYWN0aW9uSWNvbihDTEVBUl9JQ09OLCB7CiAgICAgICAgdGV4dDogJ0NsZWFyJywKICAgICAgICBvbmNsaWNrOiAoKT0+dm0ucmVzZXRPdXRwdXQoKQogICAgfSksIGNvbnNvbGVIZWFkZXJDbGVhckVsZW1lbnQpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc29sZUhlYWRlckZpbHRlcnNEaXYuc3R5bGUudmlzaWJpbGl0eSA9IHZtLnByb2ZpbGVzLmxlbmd0aCA+IDAgPyAndmlzaWJsZScgOiAnaGlkZGVuJzsKICAgICAgICBjb25zb2xlSGVhZGVyVGFpbHNFbGVtZW50LnRleHRDb250ZW50ID0gY29tcHV0ZVRhaWxzVGV4dCh2bS50YWlscy5zaXplKTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihGSUxURVJTX0hUTUwodm0pLCBjb25zb2xlSGVhZGVyRmlsdGVyc0Rpdik7CiAgICB9Owp9CmNvbnN0IEZJTFRFUlNfSFRNTCA9ICh2bSk9PnsKICAgIHJldHVybiBodG1sYFNob3dpbmcgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRTZWxlY3Rpb25GaWVsZHMoKTsKICAgIH19PiR7dm0uY29tcHV0ZVNlbGVjdGlvbkZpZWxkc1RleHQoKX08L2E+CiAgICAgZm9yIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0RXZlbnRGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUV2ZW50RmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4KICAgICB3aXRoIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U3RhdHVzRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTdGF0dXNGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZWRpdElwQWRkcmVzc0ZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSXBBZGRyZXNzRmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4sCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRNZXRob2RGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZU1ldGhvZEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U2FtcGxpbmdSYXRlRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTYW1wbGluZ1JhdGVGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwgCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRTZWFyY2hGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVNlYXJjaEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LCAKICAgICBhbmQgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRIZWFkZXJGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUhlYWRlckZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LgogICAgICR7dm0uaGFzQW55RmlsdGVycygpID8gaHRtbGAoPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLnJlc2V0RmlsdGVycygpOwogICAgfX0+cmVzZXQ8L2E+KWAgOiAnJ31gOwp9OwpmdW5jdGlvbiBjb21wdXRlRXZlbnRGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgeyBldmVudDEgIH0gPSBmaWx0ZXI7CiAgICByZXR1cm4gZXZlbnQxID09PSAnY3JvbicgPyAnQ1JPTiB0cmlnZ2VyIGV2ZW50cycgOiBldmVudDEgPT09ICdodHRwJyA/ICdIVFRQIHJlcXVlc3QgZXZlbnRzJyA6ICdhbGwgZXZlbnRzJzsKfQpmdW5jdGlvbiBjb21wdXRlU3RhdHVzRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgc3RhdHVzMSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiBzdGF0dXMxID09PSAnZXJyb3InID8gJ2Vycm9yIHN0YXR1cycgOiBzdGF0dXMxID09PSAnc3VjY2VzcycgPyAnc3VjY2VzcyBzdGF0dXMnIDogJ2FueSBzdGF0dXMnOwp9CmZ1bmN0aW9uIGNvbXB1dGVJcEFkZHJlc3NGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgaXBBZGRyZXNzMSA9IGZpbHRlci5pcEFkZHJlc3MxIHx8IFtdOwogICAgcmV0dXJuIGlwQWRkcmVzczEubGVuZ3RoID09PSAwID8gJ2FueSBJUCBhZGRyZXNzJyA6IGlwQWRkcmVzczEubGVuZ3RoID09PSAxID8gYElQIGFkZHJlc3Mgb2YgJHtpcEFkZHJlc3MxWzBdfWAgOiBgSVAgYWRkcmVzcyBpbiBbJHtpcEFkZHJlc3MxLmpvaW4oJywgJyl9XWA7Cn0KZnVuY3Rpb24gY29tcHV0ZU1ldGhvZEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBtZXRob2QxID0gZmlsdGVyLm1ldGhvZDEgfHwgW107CiAgICByZXR1cm4gbWV0aG9kMS5sZW5ndGggPT09IDAgPyAnYW55IG1ldGhvZCcgOiBtZXRob2QxLmxlbmd0aCA9PT0gMSA/IGBtZXRob2Qgb2YgJHttZXRob2QxWzBdfWAgOiBgbWV0aG9kIGluIFske21ldGhvZDEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlU2FtcGxpbmdSYXRlRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHNhbXBsaW5nUmF0ZTEgPSB0eXBlb2YgZmlsdGVyLnNhbXBsaW5nUmF0ZTEgPT09ICdudW1iZXInID8gZmlsdGVyLnNhbXBsaW5nUmF0ZTEgOiAxOwogICAgcmV0dXJuIHNhbXBsaW5nUmF0ZTEgPj0gMSA/ICdubyBzYW1wbGluZycgOiBgJHsoTWF0aC5tYXgoMCwgc2FtcGxpbmdSYXRlMSkgKiAxMDApLnRvRml4ZWQoMil9JSBzYW1wbGluZyByYXRlYDsKfQpmdW5jdGlvbiBjb21wdXRlU2VhcmNoRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IHsgc2VhcmNoMSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiB0eXBlb2Ygc2VhcmNoMSA9PT0gJ3N0cmluZycgJiYgc2VhcmNoMS5sZW5ndGggPiAwID8gYGNvbnNvbGUgbG9ncyBjb250YWluaW5nICIke3NlYXJjaDF9ImAgOiAnbm8gc2VhcmNoIGZpbHRlcic7Cn0KZnVuY3Rpb24gY29tcHV0ZUhlYWRlckZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBoZWFkZXIxID0gZmlsdGVyLmhlYWRlcjEgfHwgW107CiAgICByZXR1cm4gaGVhZGVyMS5sZW5ndGggPT09IDAgPyAnbm8gaGVhZGVyIGZpbHRlcicgOiBoZWFkZXIxLmxlbmd0aCA9PT0gMSA/IGBoZWFkZXIgZmlsdGVyIG9mICR7aGVhZGVyMVswXX1gIDogYGhlYWRlciBmaWx0ZXJzIG9mIFske2hlYWRlcjEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlVGFpbHNUZXh0KHRhaWxDb3VudCkgewogICAgcmV0dXJuIHRhaWxDb3VudCA9PT0gMCA/ICdubyB0YWlscycgOiB0YWlsQ291bnQgPT09IDEgPyAnMSB0YWlsJyA6IGAke3RhaWxDb3VudH0gdGFpbHNgOwp9CmZ1bmN0aW9uIGNvbXB1dGVRcHNUZXh0KHFwcykgewogICAgcmV0dXJuIGAke3Fwcy50b0ZpeGVkKDIpfSBxcHNgOwp9CmZ1bmN0aW9uIHJlbmRlclRleHRJbnRvU3Bhbih0ZXh0LCBzcGFuKSB7CiAgICBjb25zdCBwYXR0ZXJuID0gLyhodHRwczpcL1wvW15ccyldK3xcZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9KS9nOwogICAgbGV0IG07CiAgICBsZXQgaTEgPSAwOwogICAgd2hpbGUobnVsbCAhPT0gKG0gPSBwYXR0ZXJuLmV4ZWModGV4dCkpKXsKICAgICAgICBpZiAobS5pbmRleCA+IGkxKSB7CiAgICAgICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dC5zdWJzdHJpbmcoaTEsIG0uaW5kZXgpKSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVybE9ySXAgPSBtWzBdOwogICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsT3JJcC5zdGFydHNXaXRoKCdodHRwczovLycpID8gdXJsT3JJcCA6IGBodHRwczovL2lwaW5mby5pby8ke3VybE9ySXB9YDsKICAgICAgICBhLnRhcmdldCA9ICdfYmxhbmsnOwogICAgICAgIGEucmVsID0gJ25vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3cnOwogICAgICAgIGEuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodXJsT3JJcCkpOwogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgaTEgPSBtLmluZGV4ICsgdXJsT3JJcC5sZW5ndGg7CiAgICB9CiAgICBpZiAoaTEgPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dC5zdWJzdHJpbmcoaTEpKSk7CiAgICB9Cn0KY29uc3QgYXBwQ3NzID0gY3NzYAoKbWFpbiB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZ2FwOiAwLjVyZW07Cn0KCjpyb290IHsKICAgIC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYjogcmdiKDE4NywgMTM0LCAyNTIpOwp9CmA7CmNvbnN0IGFwcEh0bWwgPSBodG1sYAo8bWFpbj4KJHtTSURFQkFSX0hUTUx9CiR7Q09OU09MRV9IVE1MfQoke01PREFMX0hUTUx9CjwvbWFpbj5gOwpmdW5jdGlvbiBhcHBlbmRTdHlsZXNoZWV0cyhjc3NUZXh0cykgewogICAgY29uc3Qgc3R5bGVTaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBzdHlsZVNoZWV0LnR5cGUgPSAndGV4dC9jc3MnOwogICAgc3R5bGVTaGVldC50ZXh0Q29udGVudCA9IGNzc1RleHRzLmpvaW4oJ1xuXG4nKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVTaGVldCk7Cn0KYXBwZW5kU3R5bGVzaGVldHMoWwogICAgTUFURVJJQUxfQ1NTLmNzc1RleHQsCiAgICBhcHBDc3MuY3NzVGV4dCwKICAgIEhFQURFUl9DU1MuY3NzVGV4dCwKICAgIFNJREVCQVJfQ1NTLmNzc1RleHQsCiAgICBDT05TT0xFX0NTUy5jc3NUZXh0LAogICAgTU9EQUxfQ1NTLmNzc1RleHQsCiAgICBXRUxDT01FX1BBTkVMX0NTUy5jc3NUZXh0LAogICAgUFJPRklMRV9FRElUT1JfQ1NTLmNzc1RleHQsCiAgICBGSUxURVJfRURJVE9SX0NTUy5jc3NUZXh0LAogICAgQ0lSQ1VMQVJfUFJPR1JFU1NfQ1NTLmNzc1RleHQsIApdKTsKTGl0RWxlbWVudC5yZW5kZXIoYXBwSHRtbCwgZG9jdW1lbnQuYm9keSk7CmZ1bmN0aW9uIHBhcnNlU3RhdGljRGF0YSgpIHsKICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0aWMtZGF0YS1zY3JpcHQnKTsKICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHNjcmlwdC50ZXh0KTsKICAgIGNvbnN0IHZlcnNpb24gPSB0eXBlb2YgZGF0YS52ZXJzaW9uID09PSAnc3RyaW5nJyA/IGRhdGEudmVyc2lvbiA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGZsYWdzID0gdHlwZW9mIGRhdGEuZmxhZ3MgPT09ICdzdHJpbmcnID8gZGF0YS5mbGFncyA6IHVuZGVmaW5lZDsKICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbiwKICAgICAgICBmbGFncwogICAgfTsKfQpjb25zdCBkYXRhID0gcGFyc2VTdGF0aWNEYXRhKCk7CmNvbnN0IHZtID0gbmV3IFRhaWx3ZWJBcHBWTSgpOwpjb25zdCB1cGRhdGVTaWRlYmFyID0gaW5pdFNpZGViYXIoZG9jdW1lbnQsIHZtLCBkYXRhKTsKY29uc3QgdXBkYXRlQ29uc29sZSA9IGluaXRDb25zb2xlKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZU1vZGFsID0gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSk7CnZtLm9uQ2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZVNpZGViYXIoKTsKICAgIHVwZGF0ZUNvbnNvbGUoKTsKICAgIHVwZGF0ZU1vZGFsKCk7Cn07CkNsb3VkZmxhcmVBcGkuVVJMX1RSQU5TRk9STUVSID0gKHYpPT5gL2ZldGNoLyR7di5zdWJzdHJpbmcoJ2h0dHBzOi8vJy5sZW5ndGgpfWAKOwp2bS5zdGFydCgpOwo=';