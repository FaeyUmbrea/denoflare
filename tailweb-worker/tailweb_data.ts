

export const TAILWEB_APP_HASH = '30f9091648a4835898d0d86ef64c29f02ea3089e';
export const TAILWEB_APP_B64 = 'YXN5bmMgZnVuY3Rpb24gbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0c2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RTY3JpcHRzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdFRhaWxzKGFjY291bnRJZCwgc2NyaXB0TmFtZSwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpfS93b3JrZXJzL3NjcmlwdHMvJHtzY3JpcHROYW1lfS90YWlsc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RUYWlscycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnY3JlYXRlVGFpbCcsICdQT1NUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04JzsKY29uc3QgQVBQTElDQVRJT05fT0NURVRfU1RSRUFNID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmZ1bmN0aW9uIGNvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpIHsKICAgIHJldHVybiBDbG91ZGZsYXJlQXBpLlVSTF9UUkFOU0ZPUk1FUihgaHR0cHM6Ly9hcGkuY2xvdWRmbGFyZS5jb20vY2xpZW50L3Y0L2FjY291bnRzLyR7YWNjb3VudElkfWApOwp9CmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUob3AsIG1ldGhvZCwgdXJsLCBhcGlUb2tlbiwgYm9keSwgcmVzcG9uc2VUeXBlID0gJ2pzb24nKSB7CiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoewogICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaVRva2VufWAKICAgIH0pOwogICAgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykgewogICAgICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBBUFBMSUNBVElPTl9KU09OX1VURjgpOwogICAgICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhib2R5KTsKICAgIH0KICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZmV0Y2hSZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJykgfHwgJyc7CiAgICBpZiAoKHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzJyB8fCByZXNwb25zZVR5cGUgPT09ICdieXRlcz8nKSAmJiBjb250ZW50VHlwZSA9PT0gQVBQTElDQVRJT05fT0NURVRfU1RSRUFNKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4LAogICAgICAgIEFQUExJQ0FUSU9OX0pTT04KICAgIF0uaW5jbHVkZXMoY29udGVudFR5cGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRlbnQtdHlwZTogJHtjb250ZW50VHlwZX0sICBmZXRjaFJlc3BvbnNlPSR7ZmV0Y2hSZXNwb25zZX0sIGJvZHk9JHthd2FpdCBmZXRjaFJlc3BvbnNlLnRleHQoKX1gKTsKICAgIH0KICAgIGNvbnN0IGFwaVJlc3BvbnNlID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5qc29uKCk7CiAgICBpZiAoQ2xvdWRmbGFyZUFwaS5ERUJVRykgY29uc29sZS5sb2coYXBpUmVzcG9uc2UpOwogICAgaWYgKCFhcGlSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgaWYgKGZldGNoUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgJiYgcmVzcG9uc2VUeXBlID09PSAnYnl0ZXM/JykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB0aHJvdyBuZXcgQ2xvdWRmbGFyZUFwaUVycm9yKGAke29wfSBmYWlsZWQ6IHN0YXR1cz0ke2ZldGNoUmVzcG9uc2Uuc3RhdHVzfSwgZXJyb3JzPSR7YXBpUmVzcG9uc2UuZXJyb3JzLm1hcCgodik9PmAke3YuY29kZX0gJHt2Lm1lc3NhZ2V9YAogICAgICAgICkuam9pbignLCAnKX1gLCBmZXRjaFJlc3BvbnNlLnN0YXR1cywgYXBpUmVzcG9uc2UuZXJyb3JzKTsKICAgIH0KICAgIHJldHVybiBhcGlSZXNwb25zZTsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBzdGF0dXM7CiAgICBlcnJvcnM7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlMSwgc3RhdHVzLCBlcnJvcnMpewogICAgICAgIHN1cGVyKG1lc3NhZ2UxKTsKICAgICAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgIH0KfQpmdW5jdGlvbiBzZXRTdWJ0cmFjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KGxocyk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmhzKXsKICAgICAgICBydC5kZWxldGUoaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0VW5pb24obGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldChsaHMpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIHJocyl7CiAgICAgICAgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldEVxdWFsKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLnNpemUgPT09IHJocy5zaXplICYmIFsKICAgICAgICAuLi5saHMKICAgIF0uZXZlcnkoKHYpPT5yaHMuaGFzKHYpCiAgICApOwp9CmNvbnN0IGRpcmVjdGl2ZXMgPSBuZXcgV2Vha01hcCgpOwpjb25zdCBkaXJlY3RpdmUgPSAoZik9PiguLi5hcmdzKT0+ewogICAgICAgIGNvbnN0IGQgPSBmKC4uLmFyZ3MpOwogICAgICAgIGRpcmVjdGl2ZXMuc2V0KGQsIHRydWUpOwogICAgICAgIHJldHVybiBkOwogICAgfQo7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7Cn07CmNvbnN0IG5vdGhpbmcgPSB7Cn07CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQ1KXsKICAgICAgICB0aGlzLnBhcnRzID0gW107CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDU7CiAgICAgICAgY29uc3Qgbm9kZXNUb1JlbW92ZSA9IFtdOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3Qgd2Fsa2VyID0gZG9jdW1lbnQuY3JlYXRlVHJlZVdhbGtlcihlbGVtZW50NS5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzOiBzdHJpbmdzNSAsIHZhbHVlczogeyBsZW5ndGggIH0gIH0gPSByZXN1bHQ7CiAgICAgICAgd2hpbGUocGFydEluZGV4IDwgbGVuZ3RoKXsKICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlcygpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5vZGUuYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGxlbmd0aDogbGVuZ3RoMiAgfSA9IGF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVuZ3RoMjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZHNXaXRoKGF0dHJpYnV0ZXNbaV0ubmFtZSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHdoaWxlKGNvdW50LS0gPiAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nRm9yUGFydCA9IHN0cmluZ3M1W3BhcnRJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4LmV4ZWMoc3RyaW5nRm9yUGFydClbMl07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZUxvb2t1cE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCkgKyBib3VuZEF0dHJpYnV0ZVN1ZmZpeDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlVmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVMb29rdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRpY3MgPSBhdHRyaWJ1dGVWYWx1ZS5zcGxpdChtYXJrZXJSZWdleCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiYXR0cmlidXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ3M6IHN0YXRpY3MKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBzdGF0aWNzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5vZGUudGFnTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5pbmRleE9mKG1hcmtlcikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdzMiA9IGRhdGEuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IHN0cmluZ3MyLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxhc3RJbmRleDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluc2VydDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHMgPSBzdHJpbmdzMltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnQgPSBjcmVhdGVNYXJrZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoICE9PSBudWxsICYmIGVuZHNXaXRoKG1hdGNoWzJdLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gcy5zbGljZSgwLCBtYXRjaC5pbmRleCkgKyBtYXRjaFsxXSArIG1hdGNoWzJdLnNsaWNlKDAsIC1ib3VuZEF0dHJpYnV0ZVN1ZmZpeC5sZW5ndGgpICsgbWF0Y2hbM107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGluc2VydCwgbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogKytpbmRleAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cmluZ3MyW2xhc3RJbmRleF0gPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUoY3JlYXRlTWFya2VyKCksIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5kYXRhID0gc3RyaW5nczJbbGFzdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFydEluZGV4ICs9IGxhc3RJbmRleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSA4KSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5kYXRhID09PSBtYXJrZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUucHJldmlvdXNTaWJsaW5nID09PSBudWxsIHx8IGluZGV4ID09PSBsYXN0UGFydEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUoY3JlYXRlTWFya2VyKCksIG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsYXN0UGFydEluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICBpbmRleAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9ICIiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzVG9SZW1vdmUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgtLTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxldCBpID0gLTE7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoKGkgPSBub2RlLmRhdGEuaW5kZXhPZihtYXJrZXIsIGkgKyAxKSkgIT09IC0xKXsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiAtMQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgbiBvZiBub2Rlc1RvUmVtb3ZlKXsKICAgICAgICAgICAgbi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG4pOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBlbmRzV2l0aCA9IChzdHIsIHN1ZmZpeCk9PnsKICAgIGNvbnN0IGluZGV4MSA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4MSA+PSAwICYmIHN0ci5zbGljZShpbmRleDEpID09PSBzdWZmaXg7Cn07CmNvbnN0IGlzVGVtcGxhdGVQYXJ0QWN0aXZlID0gKHBhcnQpPT5wYXJ0LmluZGV4ICE9PSAtMQo7CmNvbnN0IGNyZWF0ZU1hcmtlciA9ICgpPT5kb2N1bWVudC5jcmVhdGVDb21tZW50KCIiKQo7CmNvbnN0IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXggPSAvKFsgXHgwOVx4MGFceDBjXHgwZF0pKFteXDAtXHgxRlx4N0YtXHg5RiAiJz49L10rKShbIFx4MDlceDBhXHgwY1x4MGRdKj1bIFx4MDlceDBhXHgwY1x4MGRdKig/OlteIFx4MDlceDBhXHgwY1x4MGQiJ2A8Pj1dKnwiW14iXSp8J1teJ10qKSkkLzsKY2xhc3MgVGVtcGxhdGVJbnN0YW5jZSB7CiAgICBjb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgcHJvY2Vzc29yLCBvcHRpb25zMil7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMyOwogICAgfQogICAgdXBkYXRlKHZhbHVlcykgewogICAgICAgIGxldCBpID0gMDsKICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgdGhpcy5fX3BhcnRzKXsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcGFydC5zZXRWYWx1ZSh2YWx1ZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBwYXJ0MSBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydDEgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcGFydDEuY29tbWl0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBfY2xvbmUoKSB7CiAgICAgICAgY29uc3QgZnJhZ21lbnQgPSBpc0NFUG9seWZpbGwgPyB0aGlzLnRlbXBsYXRlLmVsZW1lbnQuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkgOiBkb2N1bWVudC5pbXBvcnROb2RlKHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LCB0cnVlKTsKICAgICAgICBjb25zdCBzdGFjazEgPSBbXTsKICAgICAgICBjb25zdCBwYXJ0czIgPSB0aGlzLnRlbXBsYXRlLnBhcnRzOwogICAgICAgIGNvbnN0IHdhbGtlcjEgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4MSA9IDA7CiAgICAgICAgbGV0IG5vZGVJbmRleCA9IDA7CiAgICAgICAgbGV0IHBhcnQ7CiAgICAgICAgbGV0IG5vZGUgPSB3YWxrZXIxLm5leHROb2RlKCk7CiAgICAgICAgd2hpbGUocGFydEluZGV4MSA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleDFdOwogICAgICAgICAgICBpZiAoIWlzVGVtcGxhdGVQYXJ0QWN0aXZlKHBhcnQpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9fcGFydHMucHVzaCh2b2lkIDApOwogICAgICAgICAgICAgICAgcGFydEluZGV4MSsrOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUobm9kZUluZGV4IDwgcGFydC5pbmRleCl7CiAgICAgICAgICAgICAgICBub2RlSW5kZXgrKzsKICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVOYW1lID09PSAiVEVNUExBVEUiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhY2sxLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyMS5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgobm9kZSA9IHdhbGtlcjEubmV4dE5vZGUoKSkgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB3YWxrZXIxLmN1cnJlbnROb2RlID0gc3RhY2sxLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUgPSB3YWxrZXIxLm5leHROb2RlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcnQudHlwZSA9PT0gIm5vZGUiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYXJ0MiA9IHRoaXMucHJvY2Vzc29yLmhhbmRsZVRleHRFeHByZXNzaW9uKHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgICAgICBwYXJ0Mi5pbnNlcnRBZnRlck5vZGUobm9kZS5wcmV2aW91c1NpYmxpbmcpOwogICAgICAgICAgICAgICAgdGhpcy5fX3BhcnRzLnB1c2gocGFydDIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fX3BhcnRzLnB1c2goLi4udGhpcy5wcm9jZXNzb3IuaGFuZGxlQXR0cmlidXRlRXhwcmVzc2lvbnMobm9kZSwgcGFydC5uYW1lLCBwYXJ0LnN0cmluZ3MsIHRoaXMub3B0aW9ucykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcnRJbmRleDErKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzMSwgdmFsdWVzLCB0eXBlMSwgcHJvY2Vzc29yMSl7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczE7CiAgICAgICAgdGhpcy52YWx1ZXMgPSB2YWx1ZXM7CiAgICAgICAgdGhpcy50eXBlID0gdHlwZTE7CiAgICAgICAgdGhpcy5wcm9jZXNzb3IgPSBwcm9jZXNzb3IxOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlMSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRlbXBsYXRlIik7CiAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5nZXRIVE1MKCk7CiAgICAgICAgaWYgKHBvbGljeSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhbHVlID0gcG9saWN5LmNyZWF0ZUhUTUwodmFsdWUpOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZTEuaW5uZXJIVE1MID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlMTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUxID0gc3VwZXIuZ2V0VGVtcGxhdGVFbGVtZW50KCk7CiAgICAgICAgY29uc3QgY29udGVudCA9IHRlbXBsYXRlMS5jb250ZW50OwogICAgICAgIGNvbnN0IHN2Z0VsZW1lbnQgPSBjb250ZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgY29udGVudC5yZW1vdmVDaGlsZChzdmdFbGVtZW50KTsKICAgICAgICByZXBhcmVudE5vZGVzKGNvbnRlbnQsIHN2Z0VsZW1lbnQuZmlyc3RDaGlsZCk7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlMTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQxLCBuYW1lMywgc3RyaW5nczIpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQxOwogICAgICAgIHRoaXMubmFtZSA9IG5hbWUzOwogICAgICAgIHRoaXMuc3RyaW5ncyA9IHN0cmluZ3MyOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5nczIubGVuZ3RoIC0gMTsgaSsrKXsKICAgICAgICAgICAgdGhpcy5wYXJ0c1tpXSA9IHRoaXMuX2NyZWF0ZVBhcnQoKTsKICAgICAgICB9CiAgICB9CiAgICBfY3JlYXRlUGFydCgpIHsKICAgICAgICByZXR1cm4gbmV3IEF0dHJpYnV0ZVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgY29uc3Qgc3RyaW5nczMgPSB0aGlzLnN0cmluZ3M7CiAgICAgICAgY29uc3QgbCA9IHN0cmluZ3MzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzM1swXSA9PT0gIiIgJiYgc3RyaW5nczNbMV0gPT09ICIiKSB7CiAgICAgICAgICAgIGNvbnN0IHYgPSBwYXJ0czJbMF0udmFsdWU7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN5bWJvbCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcodik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAic3RyaW5nIiB8fCAhaXNJdGVyYWJsZSh2KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHRleHQgPSAiIjsKICAgICAgICBmb3IobGV0IGkxID0gMDsgaTEgPCBsOyBpMSsrKXsKICAgICAgICAgICAgdGV4dCArPSBzdHJpbmdzM1tpMV07CiAgICAgICAgICAgIGNvbnN0IHBhcnQgPSBwYXJ0czJbaTFdOwogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2ID0gcGFydC52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChpc1ByaW1pdGl2ZSh2KSB8fCAhaXNJdGVyYWJsZSh2KSkgewogICAgICAgICAgICAgICAgICAgIHRleHQgKz0gdHlwZW9mIHYgPT09ICJzdHJpbmciID8gdiA6IFN0cmluZyh2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCB0IG9mIHYpewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB0ID09PSAic3RyaW5nIiA/IHQgOiBTdHJpbmcodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRleHQgKz0gc3RyaW5nczNbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zMSl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMxOwogICAgfQogICAgYXBwZW5kSW50byhjb250YWluZXIpIHsKICAgICAgICB0aGlzLnN0YXJ0Tm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgdGhpcy5lbmROb2RlID0gY29udGFpbmVyLmFwcGVuZENoaWxkKGNyZWF0ZU1hcmtlcigpKTsKICAgIH0KICAgIGluc2VydEFmdGVyTm9kZShyZWYpIHsKICAgICAgICB0aGlzLnN0YXJ0Tm9kZSA9IHJlZjsKICAgICAgICB0aGlzLmVuZE5vZGUgPSByZWYubmV4dFNpYmxpbmc7CiAgICB9CiAgICBhcHBlbmRJbnRvUGFydChwYXJ0KSB7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLnN0YXJ0Tm9kZSA9IGNyZWF0ZU1hcmtlcigpKTsKICAgICAgICBwYXJ0Ll9faW5zZXJ0KHRoaXMuZW5kTm9kZSA9IGNyZWF0ZU1hcmtlcigpKTsKICAgIH0KICAgIGluc2VydEFmdGVyUGFydChyZWYpIHsKICAgICAgICByZWYuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLmVuZE5vZGU7CiAgICAgICAgcmVmLmVuZE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZTsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLnN0YXJ0Tm9kZS5wYXJlbnROb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy5fX3BlbmRpbmdWYWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChpc1ByaW1pdGl2ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLnZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9fY29tbWl0VGV4dCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGVSZXN1bHQpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgTm9kZSkgewogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmIChpc0l0ZXJhYmxlKHZhbHVlKSkgewogICAgICAgICAgICB0aGlzLl9fY29tbWl0SXRlcmFibGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IG5vdGhpbmcpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vdGhpbmc7CiAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9fY29tbWl0VGV4dCh2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX19pbnNlcnQobm9kZSkgewogICAgICAgIHRoaXMuZW5kTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlLCB0aGlzLmVuZE5vZGUpOwogICAgfQogICAgX19jb21taXROb2RlKHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09IHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIHRoaXMuX19pbnNlcnQodmFsdWUpOwogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIF9fY29tbWl0VGV4dCh2YWx1ZSkgewogICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLnN0YXJ0Tm9kZS5uZXh0U2libGluZzsKICAgICAgICB2YWx1ZSA9IHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlOwogICAgICAgIGNvbnN0IHZhbHVlQXNTdHJpbmcgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciID8gdmFsdWUgOiBTdHJpbmcodmFsdWUpOwogICAgICAgIGlmIChub2RlID09PSB0aGlzLmVuZE5vZGUucHJldmlvdXNTaWJsaW5nICYmIG5vZGUubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgbm9kZS5kYXRhID0gdmFsdWVBc1N0cmluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh2YWx1ZUFzU3RyaW5nKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIF9fY29tbWl0VGVtcGxhdGVSZXN1bHQodmFsdWUpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZTEgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUxKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUudXBkYXRlKHZhbHVlLnZhbHVlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBuZXcgVGVtcGxhdGVJbnN0YW5jZSh0ZW1wbGF0ZTEsIHZhbHVlLnByb2Nlc3NvciwgdGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgY29uc3QgZnJhZ21lbnQgPSBpbnN0YW5jZS5fY2xvbmUoKTsKICAgICAgICAgICAgaW5zdGFuY2UudXBkYXRlKHZhbHVlLnZhbHVlcyk7CiAgICAgICAgICAgIHRoaXMuX19jb21taXROb2RlKGZyYWdtZW50KTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IGluc3RhbmNlOwogICAgICAgIH0KICAgIH0KICAgIF9fY29tbWl0SXRlcmFibGUodmFsdWUpIHsKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodGhpcy52YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IFtdOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGl0ZW1QYXJ0cyA9IHRoaXMudmFsdWU7CiAgICAgICAgbGV0IHBhcnRJbmRleDEgPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXgxXTsKICAgICAgICAgICAgaWYgKGl0ZW1QYXJ0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0ID0gbmV3IE5vZGVQYXJ0KHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpdGVtUGFydHMucHVzaChpdGVtUGFydCk7CiAgICAgICAgICAgICAgICBpZiAocGFydEluZGV4MSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGl0ZW1QYXJ0LmFwcGVuZEludG9QYXJ0KHRoaXMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5pbnNlcnRBZnRlclBhcnQoaXRlbVBhcnRzW3BhcnRJbmRleDEgLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgxKys7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJ0SW5kZXgxIDwgaXRlbVBhcnRzLmxlbmd0aCkgewogICAgICAgICAgICBpdGVtUGFydHMubGVuZ3RoID0gcGFydEluZGV4MTsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50MiwgbmFtZTEsIHN0cmluZ3MzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MzLmxlbmd0aCAhPT0gMiB8fCBzdHJpbmdzM1swXSAhPT0gIiIgfHwgc3RyaW5nczNbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50MjsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lMTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzMzsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50MywgbmFtZTIsIHN0cmluZ3M0KXsKICAgICAgICBzdXBlcihlbGVtZW50MywgbmFtZTIsIHN0cmluZ3M0KTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3M0Lmxlbmd0aCA9PT0gMiAmJiBzdHJpbmdzNFswXSA9PT0gIiIgJiYgc3RyaW5nczRbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMyID0gewogICAgICAgICAgICBnZXQgY2FwdHVyZSAoKSB7CiAgICAgICAgICAgICAgICBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMyLCBvcHRpb25zMik7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zMiwgb3B0aW9uczIpOwogICAgfSBjYXRjaCAoX2UpIHsKICAgIH0KfSkoKTsKY2xhc3MgRXZlbnRQYXJ0IHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQ0LCBldmVudE5hbWUsIGV2ZW50Q29udGV4dCl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ0OwogICAgICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgICAgIHRoaXMuZXZlbnRDb250ZXh0ID0gZXZlbnRDb250ZXh0OwogICAgICAgIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50ID0gKGUpPT50aGlzLmhhbmRsZUV2ZW50KGUpCiAgICAgICAgOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy5fX3BlbmRpbmdWYWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fX3BlbmRpbmdWYWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdMaXN0ZW5lciA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgY29uc3Qgb2xkTGlzdGVuZXIgPSB0aGlzLnZhbHVlOwogICAgICAgIGNvbnN0IHNob3VsZFJlbW92ZUxpc3RlbmVyID0gbmV3TGlzdGVuZXIgPT0gbnVsbCB8fCBvbGRMaXN0ZW5lciAhPSBudWxsICYmIChuZXdMaXN0ZW5lci5jYXB0dXJlICE9PSBvbGRMaXN0ZW5lci5jYXB0dXJlIHx8IG5ld0xpc3RlbmVyLm9uY2UgIT09IG9sZExpc3RlbmVyLm9uY2UgfHwgbmV3TGlzdGVuZXIucGFzc2l2ZSAhPT0gb2xkTGlzdGVuZXIucGFzc2l2ZSk7CiAgICAgICAgY29uc3Qgc2hvdWxkQWRkTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciAhPSBudWxsICYmIChvbGRMaXN0ZW5lciA9PSBudWxsIHx8IHNob3VsZFJlbW92ZUxpc3RlbmVyKTsKICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRBZGRMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLl9fb3B0aW9ucyA9IGdldE9wdGlvbnMobmV3TGlzdGVuZXIpOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IG5ld0xpc3RlbmVyOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KICAgIGhhbmRsZUV2ZW50KGV2ZW50KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuY2FsbCh0aGlzLmV2ZW50Q29udGV4dCB8fCB0aGlzLmVsZW1lbnQsIGV2ZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlLmhhbmRsZUV2ZW50KGV2ZW50KTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZ2V0T3B0aW9ucyA9IChvKT0+byAmJiAoZXZlbnRPcHRpb25zU3VwcG9ydGVkID8gewogICAgICAgIGNhcHR1cmU6IG8uY2FwdHVyZSwKICAgICAgICBwYXNzaXZlOiBvLnBhc3NpdmUsCiAgICAgICAgb25jZTogby5vbmNlCiAgICB9IDogby5jYXB0dXJlKQo7CmNsYXNzIERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvciB7CiAgICBoYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhlbGVtZW50LCBuYW1lLCBzdHJpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZVswXTsKICAgICAgICBpZiAocHJlZml4ID09PSAiLiIpIHsKICAgICAgICAgICAgY29uc3QgY29tbWl0dGVyMiA9IG5ldyBQcm9wZXJ0eUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKTsKICAgICAgICAgICAgcmV0dXJuIGNvbW1pdHRlcjIucGFydHM7CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICJAIikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEV2ZW50UGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBvcHRpb25zLmV2ZW50Q29udGV4dCkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIj8iKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgQm9vbGVhbkF0dHJpYnV0ZVBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncykKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tbWl0dGVyMSA9IG5ldyBBdHRyaWJ1dGVDb21taXR0ZXIoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyk7CiAgICAgICAgcmV0dXJuIGNvbW1pdHRlcjEucGFydHM7CiAgICB9CiAgICBoYW5kbGVUZXh0RXhwcmVzc2lvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBOb2RlUGFydChvcHRpb25zKTsKICAgIH0KfQpjb25zdCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgPSBuZXcgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKCk7CmZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShyZXN1bHQxKSB7CiAgICBsZXQgdGVtcGxhdGVDYWNoZSA9IHRlbXBsYXRlQ2FjaGVzLmdldChyZXN1bHQxLnR5cGUpOwogICAgaWYgKHRlbXBsYXRlQ2FjaGUgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlQ2FjaGUgPSB7CiAgICAgICAgICAgIHN0cmluZ3NBcnJheTogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICAga2V5U3RyaW5nOiBuZXcgTWFwKCkKICAgICAgICB9OwogICAgICAgIHRlbXBsYXRlQ2FjaGVzLnNldChyZXN1bHQxLnR5cGUsIHRlbXBsYXRlQ2FjaGUpOwogICAgfQogICAgbGV0IHRlbXBsYXRlMSA9IHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LmdldChyZXN1bHQxLnN0cmluZ3MpOwogICAgaWYgKHRlbXBsYXRlMSAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlMTsKICAgIH0KICAgIGNvbnN0IGtleSA9IHJlc3VsdDEuc3RyaW5ncy5qb2luKG1hcmtlcik7CiAgICB0ZW1wbGF0ZTEgPSB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5nZXQoa2V5KTsKICAgIGlmICh0ZW1wbGF0ZTEgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlMSA9IG5ldyBUZW1wbGF0ZShyZXN1bHQxLCByZXN1bHQxLmdldFRlbXBsYXRlRWxlbWVudCgpKTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5zZXQoa2V5LCB0ZW1wbGF0ZTEpOwogICAgfQogICAgdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuc2V0KHJlc3VsdDEuc3RyaW5ncywgdGVtcGxhdGUxKTsKICAgIHJldHVybiB0ZW1wbGF0ZTE7Cn0KY29uc3QgdGVtcGxhdGVDYWNoZXMgPSBuZXcgTWFwKCk7CmNvbnN0IHBhcnRzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgcmVuZGVyID0gKHJlc3VsdDEsIGNvbnRhaW5lciwgb3B0aW9uczMpPT57CiAgICBsZXQgcGFydCA9IHBhcnRzLmdldChjb250YWluZXIpOwogICAgaWYgKHBhcnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbW92ZU5vZGVzKGNvbnRhaW5lciwgY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgIHBhcnRzLnNldChjb250YWluZXIsIHBhcnQgPSBuZXcgTm9kZVBhcnQoT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIHRlbXBsYXRlRmFjdG9yeQogICAgICAgIH0sIG9wdGlvbnMzKSkpOwogICAgICAgIHBhcnQuYXBwZW5kSW50byhjb250YWluZXIpOwogICAgfQogICAgcGFydC5zZXRWYWx1ZShyZXN1bHQxKTsKICAgIHBhcnQuY29tbWl0KCk7Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogICAgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjEuNC4xIik7Cn0KY29uc3QgaHRtbCA9IChzdHJpbmdzNiwgLi4udmFsdWVzMSk9Pm5ldyBUZW1wbGF0ZVJlc3VsdChzdHJpbmdzNiwgdmFsdWVzMSwgImh0bWwiLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKY29uc3Qgc3ZnID0gKHN0cmluZ3M2LCAuLi52YWx1ZXMxKT0+bmV3IFNWR1RlbXBsYXRlUmVzdWx0KHN0cmluZ3M2LCB2YWx1ZXMxLCAic3ZnIiwgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKQo7CnZhciBfYTsKd2luZG93LkpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkgPSAocHJvcCwgX29iaik9PnByb3AKOwpjb25zdCBkZWZhdWx0Q29udmVydGVyID0gewogICAgdG9BdHRyaWJ1dGUgKHZhbHVlLCB0eXBlKSB7CiAgICAgICAgc3dpdGNoKHR5cGUpewogICAgICAgICAgICBjYXNlIEJvb2xlYW46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPyAiIiA6IG51bGw7CiAgICAgICAgICAgIGNhc2UgT2JqZWN0OgogICAgICAgICAgICBjYXNlIEFycmF5OgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyB2YWx1ZSA6IEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKICAgIGZyb21BdHRyaWJ1dGUgKHZhbHVlLCB0eXBlKSB7CiAgICAgICAgc3dpdGNoKHR5cGUpewogICAgICAgICAgICBjYXNlIEJvb2xlYW46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgIT09IG51bGw7CiAgICAgICAgICAgIGNhc2UgTnVtYmVyOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSBudWxsID8gbnVsbCA6IE51bWJlcih2YWx1ZSk7CiAgICAgICAgICAgIGNhc2UgT2JqZWN0OgogICAgICAgICAgICBjYXNlIEFycmF5OgogICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9Cn07CmNvbnN0IG5vdEVxdWFsID0gKHZhbHVlLCBvbGQpPT57CiAgICByZXR1cm4gb2xkICE9PSB2YWx1ZSAmJiAob2xkID09PSBvbGQgfHwgdmFsdWUgPT09IHZhbHVlKTsKfTsKY29uc3QgZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24gPSB7CiAgICBhdHRyaWJ1dGU6IHRydWUsCiAgICB0eXBlOiBTdHJpbmcsCiAgICBjb252ZXJ0ZXI6IGRlZmF1bHRDb252ZXJ0ZXIsCiAgICByZWZsZWN0OiBmYWxzZSwKICAgIGhhc0NoYW5nZWQ6IG5vdEVxdWFsCn07CmNvbnN0IFNUQVRFX0hBU19VUERBVEVEID0gMTsKY29uc3QgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRCA9IDEgPDwgMjsKY29uc3QgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEUgPSAxIDw8IDM7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFkgPSAxIDw8IDQ7CmNvbnN0IGZpbmFsaXplZCA9ICJmaW5hbGl6ZWQiOwpjbGFzcyBVcGRhdGluZ0VsZW1lbnQgZXh0ZW5kcyBIVE1MRWxlbWVudCB7CiAgICBjb25zdHJ1Y3RvcigpewogICAgICAgIHN1cGVyKCk7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7CiAgICB9CiAgICBzdGF0aWMgZ2V0IG9ic2VydmVkQXR0cmlidXRlcygpIHsKICAgICAgICB0aGlzLmZpbmFsaXplKCk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IFtdOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5mb3JFYWNoKCh2LCBwKT0+ewogICAgICAgICAgICBjb25zdCBhdHRyID0gdGhpcy5fYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KHAsIHYpOwogICAgICAgICAgICBpZiAoYXR0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwLnNldChhdHRyLCBwKTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXMucHVzaChhdHRyKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGVzOwogICAgfQogICAgc3RhdGljIF9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKSB7CiAgICAgICAgaWYgKCF0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9jbGFzc1Byb3BlcnRpZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICBjb25zdCBzdXBlclByb3BlcnRpZXMgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcykuX2NsYXNzUHJvcGVydGllczsKICAgICAgICAgICAgaWYgKHN1cGVyUHJvcGVydGllcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBzdXBlclByb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQoaywgdikKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgY3JlYXRlUHJvcGVydHkobmFtZSwgb3B0aW9ucyA9IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uKSB7CiAgICAgICAgdGhpcy5fZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCk7CiAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLnNldChuYW1lLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy5ub0FjY2Vzc29yIHx8IHRoaXMucHJvdG90eXBlLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3Qga2V5ID0gdHlwZW9mIG5hbWUgPT09ICJzeW1ib2wiID8gU3ltYm9sKCkgOiBgX18ke25hbWV9YDsKICAgICAgICBjb25zdCBkZXNjcmlwdG9yID0gdGhpcy5nZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKTsKICAgICAgICBpZiAoZGVzY3JpcHRvciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLnByb3RvdHlwZSwgbmFtZSwgZGVzY3JpcHRvcik7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5RGVzY3JpcHRvcihuYW1lLCBrZXksIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBnZXQgKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNba2V5XTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0ICh2YWx1ZSkgewogICAgICAgICAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzW25hbWVdOwogICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgIH07CiAgICB9CiAgICBzdGF0aWMgZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY2xhc3NQcm9wZXJ0aWVzICYmIHRoaXMuX2NsYXNzUHJvcGVydGllcy5nZXQobmFtZSkgfHwgZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb247CiAgICB9CiAgICBzdGF0aWMgZmluYWxpemUoKSB7CiAgICAgICAgY29uc3Qgc3VwZXJDdG9yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpOwogICAgICAgIGlmICghc3VwZXJDdG9yLmhhc093blByb3BlcnR5KGZpbmFsaXplZCkpIHsKICAgICAgICAgICAgc3VwZXJDdG9yLmZpbmFsaXplKCk7CiAgICAgICAgfQogICAgICAgIHRoaXNbZmluYWxpemVkXSA9IHRydWU7CiAgICAgICAgdGhpcy5fZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCk7CiAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcCA9IG5ldyBNYXAoKTsKICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJwcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIGNvbnN0IHByb3BzID0gdGhpcy5wcm9wZXJ0aWVzOwogICAgICAgICAgICBjb25zdCBwcm9wS2V5cyA9IFsKICAgICAgICAgICAgICAgIC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BzKSwKICAgICAgICAgICAgICAgIC4uLnR5cGVvZiBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzID09PSAiZnVuY3Rpb24iID8gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhwcm9wcykgOiBbXQogICAgICAgICAgICBdOwogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgcHJvcEtleXMpewogICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVQcm9wZXJ0eShwLCBwcm9wc1twXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShuYW1lLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gb3B0aW9ucy5hdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZSA9PT0gZmFsc2UgPyB2b2lkIDAgOiB0eXBlb2YgYXR0cmlidXRlID09PSAic3RyaW5nIiA/IGF0dHJpYnV0ZSA6IHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiA/IG5hbWUudG9Mb3dlckNhc2UoKSA6IHZvaWQgMDsKICAgIH0KICAgIHN0YXRpYyBfdmFsdWVIYXNDaGFuZ2VkKHZhbHVlLCBvbGQsIGhhc0NoYW5nZWQgPSBub3RFcXVhbCkgewogICAgICAgIHJldHVybiBoYXNDaGFuZ2VkKHZhbHVlLCBvbGQpOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlRnJvbUF0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IHR5cGUyID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyIHx8IGRlZmF1bHRDb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgZnJvbUF0dHJpYnV0ZSA9IHR5cGVvZiBjb252ZXJ0ZXIgPT09ICJmdW5jdGlvbiIgPyBjb252ZXJ0ZXIgOiBjb252ZXJ0ZXIuZnJvbUF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gZnJvbUF0dHJpYnV0ZSA/IGZyb21BdHRyaWJ1dGUodmFsdWUsIHR5cGUyKSA6IHZhbHVlOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB0eXBlMiA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlcjsKICAgICAgICBjb25zdCB0b0F0dHJpYnV0ZSA9IGNvbnZlcnRlciAmJiBjb252ZXJ0ZXIudG9BdHRyaWJ1dGUgfHwgZGVmYXVsdENvbnZlcnRlci50b0F0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gdG9BdHRyaWJ1dGUodmFsdWUsIHR5cGUyKTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKT0+dGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHJlcwogICAgICAgICk7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fc2F2ZUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKCk7CiAgICB9CiAgICBfc2F2ZUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgoX3YsIHApPT57CiAgICAgICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNbcF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1twXTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLnNldChwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9hcHBseUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnRoaXNbcF0gPSB2CiAgICAgICAgKTsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSB2b2lkIDA7CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICB0aGlzLmVuYWJsZVVwZGF0aW5nKCk7CiAgICB9CiAgICBlbmFibGVVcGRhdGluZygpIHsKICAgICAgICBpZiAodGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIoKTsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHZvaWQgMDsKICAgICAgICB9CiAgICB9CiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgIH0KICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG9sZCAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX3Byb3BlcnR5VG9BdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IGF0dHIgPSBjdG9yLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBhdHRyVmFsdWUgPSBjdG9yLl9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgfQogICAgfQogICAgX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHByb3BOYW1lID0gY3Rvci5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5nZXQobmFtZSk7CiAgICAgICAgaWYgKHByb3BOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9uczMgPSBjdG9yLmdldFByb3BlcnR5T3B0aW9ucyhwcm9wTmFtZSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZOwogICAgICAgICAgICB0aGlzW3Byb3BOYW1lXSA9IGN0b3IuX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zMyk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWTsKICAgICAgICB9CiAgICB9CiAgICByZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBsZXQgc2hvdWxkUmVxdWVzdFVwZGF0ZSA9IHRydWU7CiAgICAgICAgaWYgKG5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwgY3Rvci5nZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSk7CiAgICAgICAgICAgIGlmIChjdG9yLl92YWx1ZUhhc0NoYW5nZWQodGhpc1tuYW1lXSwgb2xkVmFsdWUsIG9wdGlvbnMuaGFzQ2hhbmdlZCkpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuaGFzKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMuc2V0KG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHRydWUgJiYgISh0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLnNldChuYW1lLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNob3VsZFJlcXVlc3RVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSAmJiBzaG91bGRSZXF1ZXN0VXBkYXRlKSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSB0aGlzLl9lbnF1ZXVlVXBkYXRlKCk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZShuYW1lLCBvbGRWYWx1ZSkgewogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlKTsKICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVDb21wbGV0ZTsKICAgIH0KICAgIGFzeW5jIF9lbnF1ZXVlVXBkYXRlKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgICAgICBjb25zdCByZXN1bHQxID0gdGhpcy5wZXJmb3JtVXBkYXRlKCk7CiAgICAgICAgaWYgKHJlc3VsdDEgIT0gbnVsbCkgewogICAgICAgICAgICBhd2FpdCByZXN1bHQxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZTsKICAgIH0KICAgIGdldCBfaGFzUmVxdWVzdGVkVXBkYXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVTdGF0ZSAmIFNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICB9CiAgICBnZXQgaGFzVXBkYXRlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiAxOwogICAgfQogICAgcGVyZm9ybVVwZGF0ZSgpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1JlcXVlc3RlZFVwZGF0ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMpIHsKICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgICAgIGNvbnN0IGNoYW5nZWRQcm9wZXJ0aWVzID0gdGhpcy5fY2hhbmdlZFByb3BlcnRpZXM7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdGhpcy5zaG91bGRVcGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoISh0aGlzLl91cGRhdGVTdGF0ZSAmIDEpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSEFTX1VQREFURUQ7CiAgICAgICAgICAgICAgICB0aGlzLmZpcnN0VXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGVkKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICB9CiAgICB9CiAgICBfbWFya1VwZGF0ZWQoKSB7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IHVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgX2dldFVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldFVwZGF0ZUNvbXBsZXRlKCk7CiAgICB9CiAgICBnZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlUHJvbWlzZTsKICAgIH0KICAgIHNob3VsZFVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHVwZGF0ZShfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBpZiAodGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgIT09IHZvaWQgMCAmJiB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fcHJvcGVydHlUb0F0dHJpYnV0ZShrLCB0aGlzW2tdLCB2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgIH0KICAgIHVwZGF0ZWQoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICB9CiAgICBmaXJzdFVwZGF0ZWQoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICB9Cn0KX2EgPSBmaW5hbGl6ZWQ7ClVwZGF0aW5nRWxlbWVudFtfYV0gPSB0cnVlOwpjb25zdCBsZWdhY3lDdXN0b21FbGVtZW50ID0gKHRhZ05hbWUsIGNsYXp6KT0+ewogICAgd2luZG93LmN1c3RvbUVsZW1lbnRzLmRlZmluZSh0YWdOYW1lLCBjbGF6eik7CiAgICByZXR1cm4gY2xheno7Cn07CmNvbnN0IHN0YW5kYXJkQ3VzdG9tRWxlbWVudCA9ICh0YWdOYW1lLCBkZXNjcmlwdG9yKT0+ewogICAgY29uc3QgeyBraW5kICwgZWxlbWVudHMgIH0gPSBkZXNjcmlwdG9yOwogICAgcmV0dXJuIHsKICAgICAgICBraW5kLAogICAgICAgIGVsZW1lbnRzLAogICAgICAgIGZpbmlzaGVyIChjbGF6eikgewogICAgICAgICAgICB3aW5kb3cuY3VzdG9tRWxlbWVudHMuZGVmaW5lKHRhZ05hbWUsIGNsYXp6KTsKICAgICAgICB9CiAgICB9Owp9Owpjb25zdCBzdGFuZGFyZFByb3BlcnR5ID0gKG9wdGlvbnMzLCBlbGVtZW50Nik9PnsKICAgIGlmIChlbGVtZW50Ni5raW5kID09PSAibWV0aG9kIiAmJiBlbGVtZW50Ni5kZXNjcmlwdG9yICYmICEoInZhbHVlIiBpbiBlbGVtZW50Ni5kZXNjcmlwdG9yKSkgewogICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oewogICAgICAgIH0sIGVsZW1lbnQ2KSwgewogICAgICAgICAgICBmaW5pc2hlciAoY2xhenopIHsKICAgICAgICAgICAgICAgIGNsYXp6LmNyZWF0ZVByb3BlcnR5KGVsZW1lbnQ2LmtleSwgb3B0aW9uczMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGtpbmQ6ICJmaWVsZCIsCiAgICAgICAgICAgIGtleTogU3ltYm9sKCksCiAgICAgICAgICAgIHBsYWNlbWVudDogIm93biIsCiAgICAgICAgICAgIGRlc2NyaXB0b3I6IHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5pdGlhbGl6ZXIgKCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50Ni5pbml0aWFsaXplciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHRoaXNbZWxlbWVudDYua2V5XSA9IGVsZW1lbnQ2LmluaXRpYWxpemVyLmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZpbmlzaGVyIChjbGF6eikgewogICAgICAgICAgICAgICAgY2xhenouY3JlYXRlUHJvcGVydHkoZWxlbWVudDYua2V5LCBvcHRpb25zMyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQp9Owpjb25zdCBsZWdhY3lQcm9wZXJ0eSA9IChvcHRpb25zMywgcHJvdG8sIG5hbWU0KT0+ewogICAgcHJvdG8uY29uc3RydWN0b3IuY3JlYXRlUHJvcGVydHkobmFtZTQsIG9wdGlvbnMzKTsKfTsKY29uc3QgbGVnYWN5UXVlcnkgPSAoZGVzY3JpcHRvciwgcHJvdG8sIG5hbWU0KT0+ewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCBuYW1lNCwgZGVzY3JpcHRvcik7Cn07CmNvbnN0IHN0YW5kYXJkRXZlbnRPcHRpb25zID0gKG9wdGlvbnMzLCBlbGVtZW50Nik9PnsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oewogICAgfSwgZWxlbWVudDYpLCB7CiAgICAgICAgZmluaXNoZXIgKGNsYXp6KSB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY2xhenoucHJvdG90eXBlW2VsZW1lbnQ2LmtleV0sIG9wdGlvbnMzKTsKICAgICAgICB9CiAgICB9KTsKfTsKY29uc3QgbGVnYWN5RXZlbnRPcHRpb25zID0gKG9wdGlvbnMzLCBwcm90bywgbmFtZTQpPT57CiAgICBPYmplY3QuYXNzaWduKHByb3RvW25hbWU0XSwgb3B0aW9uczMpOwp9Owpjb25zdCBzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMgPSB3aW5kb3cuU2hhZG93Um9vdCAmJiAod2luZG93LlNoYWR5Q1NTID09PSB2b2lkIDAgfHwgd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgJiYgImFkb3B0ZWRTdHlsZVNoZWV0cyIgaW4gRG9jdW1lbnQucHJvdG90eXBlICYmICJyZXBsYWNlIiBpbiBDU1NTdHlsZVNoZWV0LnByb3RvdHlwZTsKY29uc3QgY29uc3RydWN0aW9uVG9rZW4gPSBTeW1ib2woKTsKY2xhc3MgQ1NTUmVzdWx0IHsKICAgIGNvbnN0cnVjdG9yKGNzc1RleHQsIHNhZmVUb2tlbil7CiAgICAgICAgaWYgKHNhZmVUb2tlbiAhPT0gY29uc3RydWN0aW9uVG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDU1NSZXN1bHQgaXMgbm90IGNvbnN0cnVjdGFibGUuIFVzZSBgdW5zYWZlQ1NTYCBvciBgY3NzYCBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgfQogICAgZ2V0IHN0eWxlU2hlZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0eWxlU2hlZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbmV3IENTU1N0eWxlU2hlZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQucmVwbGFjZVN5bmModGhpcy5jc3NUZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3NzVGV4dDsKICAgIH0KfQpjb25zdCB1bnNhZmVDU1MgPSAodmFsdWUpPT57CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChTdHJpbmcodmFsdWUpLCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07CmNvbnN0IHRleHRGcm9tQ1NTUmVzdWx0ID0gKHZhbHVlKT0+ewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ1NTUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLmNzc1RleHQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsdWUgcGFzc2VkIHRvICdjc3MnIGZ1bmN0aW9uIG11c3QgYmUgYSAnY3NzJyBmdW5jdGlvbiByZXN1bHQ6ICR7dmFsdWV9LiBVc2UgJ3Vuc2FmZUNTUycgdG8gcGFzcyBub24tbGl0ZXJhbCB2YWx1ZXMsIGJ1dAogICAgICAgICAgICB0YWtlIGNhcmUgdG8gZW5zdXJlIHBhZ2Ugc2VjdXJpdHkuYCk7CiAgICB9Cn07CmNvbnN0IGNzcyA9IChzdHJpbmdzNiwgLi4udmFsdWVzMSk9PnsKICAgIGNvbnN0IGNzc1RleHQxID0gdmFsdWVzMS5yZWR1Y2UoKGFjYywgdiwgaWR4KT0+YWNjICsgdGV4dEZyb21DU1NSZXN1bHQodikgKyBzdHJpbmdzNltpZHggKyAxXQogICAgLCBzdHJpbmdzNlswXSk7CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChjc3NUZXh0MSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owood2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSB8fCAod2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSA9IFtdKSkucHVzaCgiMi41LjEiKTsKY29uc3QgcmVuZGVyTm90SW1wbGVtZW50ZWQgPSB7Cn07CmNsYXNzIExpdEVsZW1lbnQgZXh0ZW5kcyBVcGRhdGluZ0VsZW1lbnQgewogICAgc3RhdGljIGdldFN0eWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdHlsZXM7CiAgICB9CiAgICBzdGF0aWMgX2dldFVuaXF1ZVN0eWxlcygpIHsKICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfc3R5bGVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXNlclN0eWxlcyA9IHRoaXMuZ2V0U3R5bGVzKCk7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodXNlclN0eWxlcykpIHsKICAgICAgICAgICAgY29uc3QgYWRkU3R5bGVzID0gKHN0eWxlczIsIHNldDIpPT5zdHlsZXMyLnJlZHVjZVJpZ2h0KChzZXQzLCBzKT0+QXJyYXkuaXNBcnJheShzKSA/IGFkZFN0eWxlcyhzLCBzZXQzKSA6IChzZXQzLmFkZChzKSwgc2V0MykKICAgICAgICAgICAgICAgICwgc2V0MikKICAgICAgICAgICAgOwogICAgICAgICAgICBjb25zdCBzZXQgPSBhZGRTdHlsZXModXNlclN0eWxlcywgbmV3IFNldCgpKTsKICAgICAgICAgICAgY29uc3Qgc3R5bGVzID0gW107CiAgICAgICAgICAgIHNldC5mb3JFYWNoKCh2KT0+c3R5bGVzLnVuc2hpZnQodikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gc3R5bGVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlcyA9IHVzZXJTdHlsZXMgPT09IHZvaWQgMCA/IFtdIDogWwogICAgICAgICAgICAgICAgdXNlclN0eWxlcwogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zdHlsZXMgPSB0aGlzLl9zdHlsZXMubWFwKChzKT0+ewogICAgICAgICAgICBpZiAocyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgJiYgIXN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgY29uc3QgY3NzVGV4dDEgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChzLmNzc1J1bGVzKS5yZWR1Y2UoKGNzczIsIHJ1bGUpPT5jc3MyICsgcnVsZS5jc3NUZXh0CiAgICAgICAgICAgICAgICAsICIiKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bnNhZmVDU1MoY3NzVGV4dDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKY2xhc3MgTWF0ZXJpYWwgewogICAgc3RhdGljIGhpZ2hFbXBoYXNpc1RleHRDb2xvciA9ICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuODcpJzsKICAgIHN0YXRpYyBtZWRpdW1FbXBoYXNpc1RleHRDb2xvciA9ICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNjApJzsKfQpjb25zdCBNQVRFUklBTF9DU1MgPSBjc3NgCgo6cm9vdCB7CiAgLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3I6IHJnYigzMC43NSwgMzAuNzUsIDMwLjc1KTsKICAtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcjogcmdiKDQwLjk1LCA0MC45NSwgNDAuOTUpOwogIC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuODcpOwogIC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCk7CiAgLS1kaXNhYmxlZC10ZXh0LWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMzgpOwogIC0tYnV0dG9uLWJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgLS1wcmltYXJ5LWNvbG9yOiAjYmI4NmZjOwogIC0tYmFja2dyb3VuZC1jb2xvcjogIzEyMTIxMjsKfQoKLyoqIHRleHQgc2l6ZSBjbGFzc2VzICovCgouaDYgewogICAgZm9udC1zaXplOiAxLjI1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDA3NTByZW07CiAgICBmb250LXdlaWdodDogYm9sZGVyOwp9CgouYm9keTIsIGZpZWxkc2V0IGxhYmVsLCBmaWVsZHNldCBvdXRwdXQsIGZpZWxkc2V0IGRldGFpbHMgewogICAgZm9udC1zaXplOiAwLjg3NXJlbTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjAxNzg2cmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKfQoKLmJ1dHRvbiwgYnV0dG9uLCAuYWN0aW9uLWljb24gewogICAgZm9udC1zaXplOiAwLjg3NXJlbTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMC4wODkyOXJlbTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkZXI7Cn0KCi5vdmVybGluZSB7CiAgICBmb250LXNpemU6IDAuNjI1cmVtOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAwLjE1MDAwcmVtOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKfQoKLmNhcHRpb24gewogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDMzMzNyZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwp9CgovKiBsaWdodCB0ZXh0IG9uIGRhcmsgYmFja2dyb3VuZCBjb2xvcnMgKi8KCi5oaWdoLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCi5tZWRpdW0tZW1waGFzaXMtdGV4dCwgZmllbGRzZXQgbGFiZWwgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKLmRpc2FibGVkLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgovKiogZWxldmF0aW9uIGJhY2tncm91bmRzICovCgouc3VyZmFjZS0wMSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwp9Cgouc3VyZmFjZS0wNCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwp9CgovKiogYWN0aW9uLWljb24gKi8KCi5hY3Rpb24taWNvbiB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgbWluLWhlaWdodDogMnJlbTsKICAgIG1pbi13aWR0aDogMnJlbTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgb3BhY2l0eTogMC42OTsgIC8qKiBtZWRpdW0tZW1waGFzaXMgLyBoaWdoLWVtcGhhc2lzICovCiAgICB1c2VyLXNlbGVjdDogbm9uZTsKfQoKLmFjdGlvbi1pY29uOmhvdmVyIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICBvcGFjaXR5OiAxOwp9CgovKiogYnV0dG9uICovCgpidXR0b24gewogICAgYm9yZGVyOiBub25lOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHVzZXItc2VsZWN0OiBub25lOwogICAgbWluLXdpZHRoOiA4cmVtOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpidXR0b24uc2VsZWN0ZWQgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpidXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpidXR0b246ZGlzYWJsZWQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgpidXR0b246ZGlzYWJsZWQ6aG92ZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGN1cnNvcjogZGVmYXVsdDsKfQoKLyoqIGFuY2hvcnMgKi8KCmEgewogICAgY29sb3I6IHZhcigtLXByaW1hcnktY29sb3IpOwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjI1cmVtOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwp9CgphOmhvdmVyIHsKICAgIHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOwp9CgovKiogZm9ybXMgKi8KCmZpZWxkc2V0IHsKICAgIGJvcmRlcjogc29saWQgMXB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCk7CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC1yb3ctZ2FwOiAxcmVtOwogICAgZ3JpZC1jb2x1bW4tZ2FwOiAxcmVtOwogICAgcGFkZGluZzogMXJlbTsKfQoKbGFiZWwgewogICAgZ3JpZC1jb2x1bW46IDE7CiAgICAvKiBiYWNrZ3JvdW5kLWNvbG9yOiByZWQ7ICovCiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKfQoKLmZvcm0tbGhzIHsKICAgIGdyaWQtY29sdW1uOiAxOwp9CgppbnB1dCwgLmZvcm0tcmhzIHsKICAgIGdyaWQtY29sdW1uOiAyOwp9CgouZm9ybS1yb3cgewogICAgZ3JpZC1jb2x1bW46IDEgLyBzcGFuIDI7Cn0KCmZpZWxkc2V0IGlucHV0W3R5cGU9dGV4dF0gewogICAgcGFkZGluZzogMC41cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgYm9yZGVyOiBzb2xpZCAxcHggdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpmaWVsZHNldCBvdXRwdXQgewogICAgcGFkZGluZzogMC41cmVtIDA7CiAgICBjb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpmaWVsZHNldCBkZXRhaWxzIHsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCmA7CmNvbnN0IEhFQURFUl9IVE1MID0gaHRtbGAKPGhlYWRlciBjbGFzcz0iaDYgaGlnaC1lbXBoYXNpcy10ZXh0Ij4KICAgIDxkaXYgc3R5bGU9ImZsZXgtZ3JvdzogMTsiPkRlbm9mbGFyZSBUYWlsPC9kaXY+CjwvaGVhZGVyPgpgOwpjb25zdCBIRUFERVJfQ1NTID0gY3NzYApoZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIHBhZGRpbmc6IDFyZW0gMDsKfQpgOwpmdW5jdGlvbiBpbml0SGVhZGVyKF9kb2N1bWVudCwgX3ZtKSB7CiAgICByZXR1cm4gKCk9PnsKICAgIH07Cn0KY29uc3QgU0lERUJBUl9IVE1MID0gaHRtbGAKPGRpdiBpZD0ic2lkZWJhciI+CiAgICAke0hFQURFUl9IVE1MfQogICAgPGRpdiBpZD0icHJvZmlsZXMiPjwvZGl2PgogICAgPGRpdiBpZD0ic2NyaXB0cyI+PC9kaXY+CjwvZGl2PgpgOwpjb25zdCBTSURFQkFSX0NTUyA9IGNzc2AKCiNzaWRlYmFyIHsKICAgIG1hcmdpbi1sZWZ0OiAxcmVtOwogICAgaGVpZ2h0OiAxMDB2aDsKICAgIG92ZXJmbG93LXk6IGhpZGRlbjsKICAgIG1pbi13aWR0aDogMTVyZW07Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZCB7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMnJlbTsKICAgIGdyaWQtZ2FwOiAxcHg7CiAgICBtYXJnaW4tbGVmdDogMXB4OwogICAgbWFyZ2luLXRvcDogMXJlbTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkLW5ldyB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIG1pbi13aWR0aDogOHJlbTsKfQoKI3NpZGViYXIgYnV0dG9uIHsKICAgIGdyaWQtY29sdW1uOiAxOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQgLmhpbnQgewogICAgZ3JpZC1jb2x1bW46IDE7IAogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLXRvcDogMC41cmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0U2lkZWJhcihkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHVwZGF0ZUhlYWRlciA9IGluaXRIZWFkZXIoZG9jdW1lbnQsIHZtKTsKICAgIGNvbnN0IHByb2ZpbGVzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGVzJyk7CiAgICBjb25zdCBzY3JpcHRzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmlwdHMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIHVwZGF0ZUhlYWRlcigpOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKFBST0ZJTEVTX0hUTUwodm0pLCBwcm9maWxlc0Rpdik7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoU0NSSVBUU19IVE1MKHZtKSwgc2NyaXB0c0Rpdik7CiAgICB9Owp9CmNvbnN0IFBST0ZJTEVTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPlByb2ZpbGVzPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZCI+CiAgICAgICAgJHt2bS5wcm9maWxlcy5tYXAoKHByb2ZpbGUpPT5odG1sYDxidXR0b24gY2xhc3M9IiR7cHJvZmlsZS5pZCA9PT0gdm0uc2VsZWN0ZWRQcm9maWxlSWQgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoKT0+ewogICAgICAgICAgICB2bS5zZWxlY3RlZFByb2ZpbGVJZCA9IHByb2ZpbGUuaWQ7CiAgICAgICAgfX0gP2Rpc2FibGVkPSIke3ZtLnByb2ZpbGVGb3JtLnNob3dpbmd9Ij4ke3Byb2ZpbGUudGV4dH08L2J1dHRvbj4KICAgICAgICAke3Byb2ZpbGUuaWQgPT09IHZtLnNlbGVjdGVkUHJvZmlsZUlkID8gaHRtbGAke2FjdGlvbkljb24oZWRpdEljb24sIHsKICAgICAgICAgICAgb25jbGljazogKCk9PnZtLmVkaXRQcm9maWxlKHByb2ZpbGUuaWQpCiAgICAgICAgfSl9YCA6ICcnfWAKICAgICl9CiAgICAgICAgPGRpdiBjbGFzcz0iYnV0dG9uLWdyaWQtbmV3Ij4ke2FjdGlvbkljb24oYWRkSWNvbiwgewogICAgICAgIHRleHQ6ICdOZXcnLAogICAgICAgIG9uY2xpY2s6ICgpPT52bS5uZXdQcm9maWxlKCkKICAgIH0pfTwvZGl2PgogICAgPC9kaXY+CmAKOwpjb25zdCBTQ1JJUFRTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPlNjcmlwdHM8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAke3ZtLnNjcmlwdHMubWFwKChzY3JpcHQpPT5odG1sYDxidXR0b24gY2xhc3M9IiR7dm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdC5pZCkgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PmhhbmRsZVNjcmlwdENsaWNrKGUsIHNjcmlwdC5pZCwgdm0pCiAgICAgICAgfSA/ZGlzYWJsZWQ9IiR7dm0ucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7c2NyaXB0LnRleHR9PC9idXR0b24+CiAgICAgICAgYAogICAgKX0KICAgICAgICA8ZGl2IGNsYXNzPSJjYXB0aW9uIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGhpbnQiPiR7Y29tcHV0ZU1ldGFLZXlDaGFyKCl9LWNsaWNrIHRvIG11bHRpc2VsZWN0PC9kaXY+CiAgICA8L2Rpdj4KYAo7CmZ1bmN0aW9uIGNvbXB1dGVNZXRhS2V5Q2hhcigpIHsKICAgIHJldHVybiBpc01hY2ludG9zaCgpID8gJ+KMmCcgOiBpc1dpbmRvd3MoKSA/ICfiip4nIDogJ21ldGEnOwp9CmZ1bmN0aW9uIGlzTWFjaW50b3NoKCkgewogICAgcmV0dXJuIG5hdmlnYXRvci5wbGF0Zm9ybS5pbmRleE9mKCdNYWMnKSA+IC0xOwp9CmZ1bmN0aW9uIGlzV2luZG93cygpIHsKICAgIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm0uaW5kZXhPZignV2luJykgPiAtMTsKfQpmdW5jdGlvbiBoYW5kbGVTY3JpcHRDbGljayhlLCBzY3JpcHRJZCwgdm0pIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IG5ld1NjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgIHNjcmlwdElkCiAgICBdKTsKICAgIHZtLnNlbGVjdGVkU2NyaXB0SWRzID0gZS5tZXRhS2V5ID8gdm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdElkKSA/IHNldFN1YnRyYWN0KHZtLnNlbGVjdGVkU2NyaXB0SWRzLCBuZXdTY3JpcHRJZHMpIDogc2V0VW5pb24odm0uc2VsZWN0ZWRTY3JpcHRJZHMsIG5ld1NjcmlwdElkcykgOiBuZXdTY3JpcHRJZHM7Cn0KZnVuY3Rpb24gYWN0aW9uSWNvbihpY29uLCBvcHRzID0gewp9KSB7CiAgICBjb25zdCB7IHRleHQgLCBvbmNsaWNrICB9ID0gb3B0czsKICAgIHJldHVybiBodG1sYDxkaXYgY2xhc3M9ImFjdGlvbi1pY29uIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgb25jbGljayAmJiBvbmNsaWNrKCk7CiAgICB9fT4ke2ljb259JHt0ZXh0IHx8ICcnfTwvZGl2PmA7Cn0KY29uc3QgZWRpdEljb24gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xNC4wNiA5LjAybC45Mi45Mkw1LjkyIDE5SDV2LS45Mmw5LjA2LTkuMDZNMTcuNjYgM2MtLjI1IDAtLjUxLjEtLjcuMjlsLTEuODMgMS44MyAzLjc1IDMuNzUgMS44My0xLjgzYy4zOS0uMzkuMzktMS4wMiAwLTEuNDFsLTIuMzQtMi4zNGMtLjItLjItLjQ1LS4yOS0uNzEtLjI5em0tMy42IDMuMTlMMyAxNy4yNVYyMWgzLjc1TDE3LjgxIDkuOTRsLTMuNzUtMy43NXoiLz48L3N2Zz5gOwpjb25zdCBhZGRJY29uID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij4+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE5IDEzaC02djZoLTJ2LTZINXYtMmg2VjVoMnY2aDZ2MnoiLz48L3N2Zz5gOwpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyA9IG5ldyBTZXQoWwogICAgJ291dGNvbWUnLAogICAgJ3NjcmlwdE5hbWUnLAogICAgJ2V4Y2VwdGlvbnMnLAogICAgJ2xvZ3MnLAogICAgJ2V2ZW50VGltZXN0YW1wJywKICAgICdldmVudCcKXSk7CmNvbnN0IEtOT1dOX09VVENPTUVTID0gbmV3IFNldChbCiAgICAnb2snLAogICAgJ2V4Y2VwdGlvbicsCiAgICAnZXhjZWVkZWRDcHUnLAogICAgJ2NhbmNlbGVkJywKICAgICd1bmtub3duJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZShvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZTogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgb3V0Y29tZSAsIHNjcmlwdE5hbWUgLCBldmVudFRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCFLTk9XTl9PVVRDT01FUy5oYXMob3V0Y29tZSkpIHRocm93IG5ldyBFcnJvcihgQmFkIG91dGNvbWU6IGV4cGVjdGVkIG9uZSBvZiBbJHtbCiAgICAgICAgLi4uS05PV05fT1VUQ09NRVMKICAgIF0uam9pbignLCAnKX1dLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG91dGNvbWUpfWApOwogICAgaWYgKHNjcmlwdE5hbWUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjcmlwdE5hbWU6IGV4cGVjdGVkIG51bGwsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoc2NyaXB0TmFtZSl9YCk7CiAgICBjb25zdCBsb2dzID0gcGFyc2VMb2dzKG9iakFzQW55LmxvZ3MpOwogICAgY29uc3QgZXhjZXB0aW9ucyA9IHBhcnNlRXhjZXB0aW9ucyhvYmpBc0FueS5leGNlcHRpb25zKTsKICAgIGlmICghKHR5cGVvZiBldmVudFRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgZXZlbnRUaW1lc3RhbXAgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgZXZlbnRUaW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShldmVudFRpbWVzdGFtcCl9YCk7CiAgICBjb25zdCBldmVudCA9IG9iakFzQW55LmV2ZW50ICYmIG9iakFzQW55LmV2ZW50LnJlcXVlc3QgPyBwYXJzZVRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50KG9iakFzQW55LmV2ZW50KSA6IHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqQXNBbnkuZXZlbnQpOwogICAgcmV0dXJuIHsKICAgICAgICBvdXRjb21lLAogICAgICAgIHNjcmlwdE5hbWUsCiAgICAgICAgZXhjZXB0aW9ucywKICAgICAgICBsb2dzLAogICAgICAgIGV2ZW50VGltZXN0YW1wLAogICAgICAgIGV2ZW50CiAgICB9Owp9CmZ1bmN0aW9uIHBhcnNlTG9ncyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBsb2dzOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VMb2cpOwp9CmZ1bmN0aW9uIHBhcnNlRXhjZXB0aW9ucyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBleGNlcHRpb25zOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VFeGNlcHRpb24pOwp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyA9IG5ldyBTZXQoWwogICAgJ21lc3NhZ2UnLAogICAgJ2xldmVsJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlTG9nKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlTG9nOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IG1lc3NhZ2UxID0gcGFyc2VTdHJpbmdBcnJheShvYmpBc0FueS5tZXNzYWdlLCAnbWVzc2FnZScpOwogICAgY29uc3QgeyBsZXZlbCAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIGxldmVsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGxldmVsOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkobGV2ZWwpfWApOwogICAgaWYgKCEodHlwZW9mIHRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgdGltZXN0YW1wID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHRpbWVzdGFtcDogZXhwZWN0ZWQgcG9zaXRpdmUgbnVtYmVyLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHRpbWVzdGFtcCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UxLAogICAgICAgIGxldmVsLAogICAgICAgIHRpbWVzdGFtcAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVhDRVBUSU9OX0tFWVMgPSBuZXcgU2V0KFsKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlRXhjZXB0aW9uKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlRXhjZXB0aW9uOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FWENFUFRJT05fS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgbmFtZTogbmFtZTQgLCBtZXNzYWdlOiBtZXNzYWdlMSAsIHRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIG5hbWU0ID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG5hbWU6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShuYW1lNCl9YCk7CiAgICBpZiAoISh0eXBlb2YgbWVzc2FnZTEgPT09ICdzdHJpbmcnKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgbWVzc2FnZTogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1lc3NhZ2UxKX1gKTsKICAgIGlmICghKHR5cGVvZiB0aW1lc3RhbXAgPT09ICdudW1iZXInICYmIHRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0aW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh0aW1lc3RhbXApfWApOwogICAgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lNCwKICAgICAgICBtZXNzYWdlOiBtZXNzYWdlMSwKICAgICAgICB0aW1lc3RhbXAKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2Nyb24nLAogICAgJ3NjaGVkdWxlZFRpbWUnCl0pOwpmdW5jdGlvbiBpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKG9iaikpOwogICAgcmV0dXJuIHNldEVxdWFsKGtleXMsIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMpOwp9CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VDcm9uRXZlbnQ6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0NST05fRVZFTlRfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgY3JvbiAsIHNjaGVkdWxlZFRpbWUgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBjcm9uID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGNyb246IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShjcm9uKX1gKTsKICAgIGlmICghKHR5cGVvZiBzY2hlZHVsZWRUaW1lID09PSAnbnVtYmVyJyAmJiBzY2hlZHVsZWRUaW1lID4gMCkpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjaGVkdWxlZFRpbWU6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShzY2hlZHVsZWRUaW1lKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgY3JvbiwKICAgICAgICBzY2hlZHVsZWRUaW1lCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9SRVFVRVNUX0VWRU5UX0tFWVMgPSBuZXcgU2V0KFsKICAgICdyZXF1ZXN0JwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZVJlcXVlc3RFdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZVJlcXVlc3RFdmVudDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTKTsKICAgIGNvbnN0IG9iakFzQW55ID0gb2JqOwogICAgY29uc3QgcmVxdWVzdCA9IHBhcnNlVGFpbE1lc3NhZ2VFdmVudFJlcXVlc3Qob2JqQXNBbnkucmVxdWVzdCk7CiAgICByZXR1cm4gewogICAgICAgIHJlcXVlc3QKICAgIH07Cn0KY29uc3QgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ3VybCcsCiAgICAnbWV0aG9kJywKICAgICdoZWFkZXJzJwpdKTsKY29uc3QgT1BUSU9OQUxfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyA9IG5ldyBTZXQoWwogICAgJ2NmJwpdKTsKY29uc3QgQUxMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBzZXRVbmlvbihSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBPUFRJT05BTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZUV2ZW50UmVxdWVzdChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZUV2ZW50UmVxdWVzdDogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTLCBBTExfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgdXJsICwgbWV0aG9kICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIHVybDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7CiAgICBpZiAoISh0eXBlb2YgbWV0aG9kID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG1ldGhvZDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG1ldGhvZCl9YCk7CiAgICBjb25zdCBoZWFkZXJzID0gcGFyc2VTdHJpbmdSZWNvcmQob2JqQXNBbnkuaGVhZGVycywgJ2hlYWRlcnMnKTsKICAgIGNvbnN0IGNmID0gb2JqQXNBbnkuY2YgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iakFzQW55LmNmKTsKICAgIHJldHVybiB7CiAgICAgICAgdXJsLAogICAgICAgIG1ldGhvZCwKICAgICAgICBoZWFkZXJzLAogICAgICAgIGNmCiAgICB9Owp9CmZ1bmN0aW9uIGNoZWNrS2V5cyhvYmosIHJlcXVpcmVkS2V5cywgYWxsS2V5cykgewogICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoT2JqZWN0LmtleXMob2JqKSk7CiAgICBjb25zdCBtaXNzaW5nS2V5cyA9IHNldFN1YnRyYWN0KHJlcXVpcmVkS2V5cywga2V5cyk7CiAgICBpZiAobWlzc2luZ0tleXMuc2l6ZSA+IDApIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBrZXlzOiAke1sKICAgICAgICAuLi5taXNzaW5nS2V5cwogICAgXS5qb2luKCcsICcpfWApOwogICAgY29uc3QgZXh0cmFLZXlzID0gc2V0U3VidHJhY3Qoa2V5cywgYWxsS2V5cyB8fCByZXF1aXJlZEtleXMpOwogICAgaWYgKGV4dHJhS2V5cy5zaXplID4gMCkgdGhyb3cgbmV3IEVycm9yKGBFeHRyYSBrZXlzOiAke1sKICAgICAgICAuLi5leHRyYUtleXMKICAgIF0uam9pbignLCAnKX1gKTsKfQpmdW5jdGlvbiBwYXJzZVN0cmluZ1JlY29yZChvYmosIG5hbWU0KSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lNH06IEV4cGVjdGVkIHN0cmluZyByZWNvcmQsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGZvciAoY29uc3QgW18sIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKXsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lNH06IEV4cGVjdGVkIHN0cmluZyByZWNvcmQsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIH0KICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gcGFyc2VTdHJpbmdBcnJheShvYmosIG5hbWU0KSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgIUFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lNH06IEV4cGVjdGVkIHN0cmluZyBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiBvYmopewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWU0fTogRXhwZWN0ZWQgc3RyaW5nIGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICB9CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIHBhcnNlSW5jb21pbmdSZXF1ZXN0Q2ZQcm9wZXJ0aWVzKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIGNmOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZTEsIGxvZ2dlcikgewogICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUobWVzc2FnZTEuZXZlbnRUaW1lc3RhbXApKTsKICAgIGNvbnN0IG91dGNvbWUgPSBQUkVUVFlfT1VUQ09NRVMuZ2V0KG1lc3NhZ2UxLm91dGNvbWUpIHx8IG1lc3NhZ2UxLm91dGNvbWU7CiAgICBjb25zdCBvdXRjb21lQ29sb3IgPSBtZXNzYWdlMS5vdXRjb21lID09PSAnb2snID8gJ2dyZWVuJyA6ICdyZWQnOwogICAgaWYgKGlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQobWVzc2FnZTEuZXZlbnQpKSB7CiAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYz8/PyVjXSBbJWMke291dGNvbWV9JWNdICVjJHttZXNzYWdlMS5ldmVudC5jcm9ufWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHsgbWV0aG9kICwgdXJsICwgY2YgIH0gPSBtZXNzYWdlMS5ldmVudC5yZXF1ZXN0OwogICAgICAgIGNvbnN0IGNvbG8gPSBjZj8uY29sbyB8fCAnPz8/JzsKICAgICAgICBsb2dnZXIoYFslYyR7dGltZX0lY10gWyVjJHtjb2xvfSVjXSBbJWMke291dGNvbWV9JWNdICR7bWV0aG9kfSAlYyR7dXJsfWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsgbGV2ZWwgLCBtZXNzYWdlOiBsb2dNZXNzYWdlICB9IG9mIG1lc3NhZ2UxLmxvZ3MpewogICAgICAgIGNvbnN0IGxldmVsQ29sb3IgPSBMT0dfTEVWRUxfQ09MT1JTLmdldChsZXZlbCkgfHwgJ2dyYXknOwogICAgICAgIGxvZ2dlcihgICVjfCVjIFslYyR7bGV2ZWx9JWNdICR7bG9nTWVzc2FnZX1gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke2xldmVsQ29sb3J9YCwgJycpOwogICAgfQogICAgZm9yIChjb25zdCB7IG5hbWU6IG5hbWU0ICwgbWVzc2FnZTogZXhjZXB0aW9uTWVzc2FnZSAgfSBvZiBtZXNzYWdlMS5leGNlcHRpb25zKXsKICAgICAgICBsb2dnZXIoYCAlY3wlYyBbJWMke25hbWU0fSVjXSAlYyR7ZXhjZXB0aW9uTWVzc2FnZX1gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGRgLCAnJywgJ2NvbG9yOiByZWQnKTsKICAgIH0KfQpmdW5jdGlvbiBwYWQyKG51bSkgewogICAgcmV0dXJuIG51bS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyk7Cn0KZnVuY3Rpb24gZm9ybWF0TG9jYWxZeXl5TW1EZEhoTW1TcyhkYXRlKSB7CiAgICByZXR1cm4gWwogICAgICAgIGRhdGUuZ2V0RnVsbFllYXIoKSwKICAgICAgICAnLScsCiAgICAgICAgcGFkMihkYXRlLmdldE1vbnRoKCkgKyAxKSwKICAgICAgICAnLScsCiAgICAgICAgcGFkMihkYXRlLmdldERhdGUoKSksCiAgICAgICAgJyAnLAogICAgICAgIHBhZDIoZGF0ZS5nZXRIb3VycygpKSwKICAgICAgICAnOicsCiAgICAgICAgcGFkMihkYXRlLmdldE1pbnV0ZXMoKSksCiAgICAgICAgJzonLAogICAgICAgIHBhZDIoZGF0ZS5nZXRTZWNvbmRzKCkpCiAgICBdLmpvaW4oJycpOwp9CmNvbnN0IFBSRVRUWV9PVVRDT01FUyA9IG5ldyBNYXAoWwogICAgWwogICAgICAgICdvaycsCiAgICAgICAgJ09rJwogICAgXSwKICAgIFsKICAgICAgICAnZXhjZXB0aW9uJywKICAgICAgICAnRXJyb3InCiAgICBdLAogICAgWwogICAgICAgICdleGNlZWRlZENwdScsCiAgICAgICAgJ0V4Y2VlZGVkIExpbWl0JwogICAgXSwKICAgIFsKICAgICAgICAnY2FuY2VsZWQnLAogICAgICAgICdDYW5jZWxlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ3Vua25vd24nLAogICAgICAgICdVbmtub3duJwogICAgXSwgCl0pOwpjb25zdCBMT0dfTEVWRUxfQ09MT1JTID0gbmV3IE1hcChbCiAgICBbCiAgICAgICAgJ3RyYWNlJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2RlYnVnJywKICAgICAgICAncHVycGxlJwogICAgXSwKICAgIFsKICAgICAgICAnbG9nJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2luZm8nLAogICAgICAgICdncmF5JwogICAgXSwKICAgIFsKICAgICAgICAnd2FybicsCiAgICAgICAgJ3JlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ2Vycm9yJywKICAgICAgICAncmVkJwogICAgXSwgCl0pOwpmdW5jdGlvbiBnZW5lcmF0ZVV1aWQoKSB7CiAgICBjb25zdCBjcnlwdG9Bc0FueSA9IGNyeXB0bzsKICAgIGlmICh0eXBlb2YgY3J5cHRvQXNBbnkucmFuZG9tVVVJRCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBjcnlwdG9Bc0FueS5yYW5kb21VVUlEKCk7CiAgICB9CiAgICBjb25zdCBybmRzID0gY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDhBcnJheSgxNikpOwogICAgcm5kc1s2XSA9IHJuZHNbNl0gJiAxNSB8IDY0OwogICAgcm5kc1s4XSA9IHJuZHNbOF0gJiA2MyB8IDEyODsKICAgIHJldHVybiBieXRlc1RvVXVpZChybmRzKTsKfQpmdW5jdGlvbiBieXRlc1RvVXVpZChieXRlcykgewogICAgY29uc3QgYml0cyA9IFsKICAgICAgICAuLi5ieXRlcwogICAgXS5tYXAoKGJpdCk9PnsKICAgICAgICBjb25zdCBzID0gYml0LnRvU3RyaW5nKDE2KTsKICAgICAgICByZXR1cm4gYml0IDwgMTYgPyAiMCIgKyBzIDogczsKICAgIH0pOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5iaXRzLnNsaWNlKDAsIDQpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDQsIDYpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDYsIDgpLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDgsIDEwKSwKICAgICAgICAiLSIsCiAgICAgICAgLi4uYml0cy5zbGljZSgxMCwgMTYpLCAKICAgIF0uam9pbigiIik7Cn0KY2xhc3MgVGFpbENvbm5lY3Rpb24gewogICAgc3RhdGljIFZFUkJPU0UgPSBmYWxzZTsKICAgIHdzOwogICAgY2FsbGJhY2tzOwogICAgb3B0aW9uczsKICAgIGNvbnN0cnVjdG9yKHdlYlNvY2tldFVybCwgY2FsbGJhY2tzMSl7CiAgICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQod2ViU29ja2V0VXJsLCAndHJhY2UtdjEnKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczE7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdvcGVuJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICB0aGlzLnNlbmRPcHRpb25zSWZPcGVuKCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3MxLm9uT3BlbikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vbk9wZW4odGhpcywgdGltZVN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignY2xvc2UnLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgY29kZSAsIHJlYXNvbiAsIHdhc0NsZWFuICwgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3MxLm9uQ2xvc2UpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25DbG9zZSh0aGlzLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy53cy5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgY29uc3QgZXJyb3JJbmZvID0gY29tcHV0ZUVycm9ySW5mbyhldmVudCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3MxLm9uRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrczEub25FcnJvcih0aGlzLCB0aW1lU3RhbXAsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBhc3luYyAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChldmVudC5kYXRhIGluc3RhbmNlb2YgQmxvYikgewogICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IGV2ZW50LmRhdGEudGV4dCgpOwogICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZSh0ZXh0KTsKICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlMTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTEgPSBwYXJzZVRhaWxNZXNzYWdlKG9iaik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vblVucGFyc2VkTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIG9iaiwgZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vblRhaWxNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgbWVzc2FnZTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzMS5vblVucGFyc2VkTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIGV2ZW50LmRhdGEsIG5ldyBFcnJvcihgRXhwZWN0ZWQgZXZlbnQuZGF0YSB0byBiZSBCbG9iYCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBzZXRPcHRpb25zKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgIHRoaXMuc2VuZE9wdGlvbnNJZk9wZW4oKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNsb3NlKGNvZGUsIHJlYXNvbikgewogICAgICAgIHRoaXMud3MuY2xvc2UoY29kZSwgcmVhc29uKTsKICAgIH0KICAgIHNlbmRPcHRpb25zSWZPcGVuKCkgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMgJiYgdGhpcy53cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikgewogICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGBzZW5kT3B0aW9uc0lmT3Blbjogc2VuZGluZyAke3BheWxvYWR9YCk7CiAgICAgICAgICAgIHRoaXMud3Muc2VuZChwYXlsb2FkKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUVycm9ySW5mbyhldmVudCkgewogICAgaWYgKGV2ZW50LnR5cGUgPT09ICdlcnJvcicpIHsKICAgICAgICBjb25zdCB7IG1lc3NhZ2U6IG1lc3NhZ2UxICwgZmlsZW5hbWUgLCBsaW5lbm8gLCBjb2xubyAsIGVycm9yICB9ID0gZXZlbnQ7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZTEsCiAgICAgICAgICAgIGZpbGVuYW1lLAogICAgICAgICAgICBsaW5lbm8sCiAgICAgICAgICAgIGNvbG5vLAogICAgICAgICAgICBlcnJvcgogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmNsYXNzIFRhaWxDb250cm9sbGVyIHsKICAgIGNhbGxiYWNrczsKICAgIHJlY29yZHMgPSBuZXcgTWFwKCk7CiAgICBjb25zdHJ1Y3RvcihjYWxsYmFja3MyKXsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczI7CiAgICB9CiAgICBhc3luYyBzZXRUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuLCBzY3JpcHRJZHMpIHsKICAgICAgICBjb25zdCBzdG9wS2V5cyA9IG5ldyBTZXQodGhpcy5yZWNvcmRzLmtleXMoKSk7CiAgICAgICAgZm9yIChjb25zdCBzY3JpcHRJZCBvZiBzY3JpcHRJZHMpewogICAgICAgICAgICBjb25zdCB0YWlsS2V5ID0gY29tcHV0ZVRhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgICAgIHN0b3BLZXlzLmRlbGV0ZSh0YWlsS2V5KTsKICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdSZWNvcmQgPSB0aGlzLnJlY29yZHMuZ2V0KHRhaWxLZXkpOwogICAgICAgICAgICBpZiAoZXhpc3RpbmdSZWNvcmQpIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nUmVjb3JkLnN0YXRlID0gJ3N0YXJ0ZWQnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkID0gewogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnc3RhcnRpbmcnLAogICAgICAgICAgICAgICAgICAgIHRhaWxLZXkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLnJlY29yZHMuc2V0KHRhaWxLZXksIHJlY29yZCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YWlsQ3JlYXRpbmdUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgICAgICAgICAgY29uc3QgdGFpbCA9IGF3YWl0IGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHRJZCwgYXBpVG9rZW4pOwogICAgICAgICAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpIC0gdGFpbENyZWF0aW5nVGltZSwgdGFpbCk7CiAgICAgICAgICAgICAgICBjb25zdCB7IGNhbGxiYWNrczogY2FsbGJhY2tzMyAgfSA9IHRoaXM7CiAgICAgICAgICAgICAgICBjb25zdCBvcGVuaW5nVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YWlsQ29ubmVjdGlvbkNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgICAgICAgICBvbk9wZW4gKF9jbiwgdGltZVN0YW1wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrczMub25UYWlsQ29ubmVjdGlvbk9wZW4oYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBEYXRlLm5vdygpIC0gb3BlbmluZ1RpbWUpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb25DbG9zZSAoX2NuLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMy5vblRhaWxDb25uZWN0aW9uQ2xvc2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG9uRXJyb3IgKF9jbiwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzMy5vblRhaWxDb25uZWN0aW9uRXJyb3IoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb25UYWlsTWVzc2FnZSAoX2NuLCB0aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSAhPT0gJ3N0YXJ0ZWQnKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrczMub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG9uVW5wYXJzZWRNZXNzYWdlIChfY24sIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MzLm9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24gPSBuZXcgVGFpbENvbm5lY3Rpb24odGFpbC51cmwsIHRhaWxDb25uZWN0aW9uQ2FsbGJhY2tzKTsKICAgICAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdzdGFydGVkJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRpc3BhdGNoVGFpbHNDaGFuZ2VkKCk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3Qgc3RvcEtleSBvZiBzdG9wS2V5cyl7CiAgICAgICAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQoc3RvcEtleSk7CiAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdzdG9wcGluZyc7CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKTsKICAgICAgICB9CiAgICB9CiAgICBkaXNwYXRjaFRhaWxzQ2hhbmdlZCgpIHsKICAgICAgICBjb25zdCB0YWlsS2V5cyA9IG5ldyBTZXQoWwogICAgICAgICAgICAuLi50aGlzLnJlY29yZHMudmFsdWVzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYuc3RhdGUgPT09ICdzdGFydGVkJwogICAgICAgICkubWFwKCh2KT0+di50YWlsS2V5CiAgICAgICAgKSk7CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsc0NoYW5nZWQodGFpbEtleXMpOwogICAgfQp9CmZ1bmN0aW9uIHVucGFja1RhaWxLZXkodGFpbEtleSkgewogICAgY29uc3QgbSA9IC9eKFteXHMtXSspLShbXlxzXSspJC8uZXhlYyh0YWlsS2V5KTsKICAgIGlmICghbSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbEtleTogJHt0YWlsS2V5fWApOwogICAgcmV0dXJuIHsKICAgICAgICBhY2NvdW50SWQ6IG1bMV0sCiAgICAgICAgc2NyaXB0SWQ6IG1bMl0KICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZVRhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgcmV0dXJuIGAke2FjY291bnRJZH0tJHtzY3JpcHRJZH1gOwp9CmNsYXNzIFRhaWx3ZWJBcHBWTSB7CiAgICBwcm9maWxlcyA9IFtdOwogICAgZ2V0IHNlbGVjdGVkUHJvZmlsZUlkKCkgewogICAgICAgIHJldHVybiB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZDsKICAgIH0KICAgIHNldCBzZWxlY3RlZFByb2ZpbGVJZCh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdmFsdWUpIHJldHVybjsKICAgICAgICB0aGlzLl9zZWxlY3RlZFByb2ZpbGVJZCA9IHZhbHVlOwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkID0gdmFsdWU7CiAgICAgICAgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIHRoaXMuZmluZFNjcmlwdHMoKTsKICAgIH0KICAgIHNjcmlwdHMgPSBbXTsKICAgIGdldCBzZWxlY3RlZFNjcmlwdElkcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHM7CiAgICB9CiAgICBzZXQgc2VsZWN0ZWRTY3JpcHRJZHMoc2NyaXB0SWRzKSB7CiAgICAgICAgaWYgKHNldEVxdWFsKHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzLCBzY3JpcHRJZHMpKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHMgPSBuZXcgU2V0KHNjcmlwdElkcyk7CiAgICAgICAgdGhpcy5vbmNoYW5nZSgpOwogICAgICAgIHRoaXMuc2V0VGFpbHMoKTsKICAgIH0KICAgIHByb2ZpbGVGb3JtID0gbmV3IFByb2ZpbGVGb3JtVk0oKTsKICAgIHRhaWxzID0gbmV3IFNldCgpOwogICAgc3RhdGUgPSBsb2FkU3RhdGUoKTsKICAgIHRhaWxDb250cm9sbGVyOwogICAgX3NlbGVjdGVkUHJvZmlsZUlkOwogICAgX3NlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldCgpOwogICAgb25jaGFuZ2UgPSAoKT0+ewogICAgfTsKICAgIGxvZ2dlciA9ICgpPT57CiAgICB9OwogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBjb25zdCBkaXMgPSB0aGlzOwogICAgICAgIGNvbnN0IGxvZ1RhaWxzQ2hhbmdlID0gKGFjdGlvbiwgdGFpbEtleXMpPT57CiAgICAgICAgICAgIGlmICh0YWlsS2V5cy5zaXplID4gMCkgZGlzLmxvZ2dlcihgJHthY3Rpb259ICR7WwogICAgICAgICAgICAgICAgLi4udGFpbEtleXMKICAgICAgICAgICAgXS5tYXAoKHYpPT51bnBhY2tUYWlsS2V5KHYpLnNjcmlwdElkCiAgICAgICAgICAgICkuam9pbignLCAnKX1gKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGNhbGxiYWNrczMgPSB7CiAgICAgICAgICAgIG9uVGFpbENyZWF0aW5nIChfYWNjb3VudElkLCBzY3JpcHRJZCkgewogICAgICAgICAgICAgICAgZGlzLmxvZ2dlcihgQ3JlYXRpbmcgdGFpbCBmb3IgJHtzY3JpcHRJZH0uLi5gKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ3JlYXRlZCAoX2FjY291bnRJZCwgc2NyaXB0SWQsIHRvb2tNaWxsaXMsIHRhaWwpIHsKICAgICAgICAgICAgICAgIGRpcy5sb2dnZXIoYENyZWF0ZWQgdGFpbCBmb3IgJHtzY3JpcHRJZH0gaW4gJHt0b29rTWlsbGlzfW1zYCwgdGFpbCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25PcGVuIChfYWNjb3VudElkLCBzY3JpcHRJZCwgX3RpbWVTdGFtcCwgdG9va01pbGxpcykgewogICAgICAgICAgICAgICAgZGlzLmxvZ2dlcihgT3BlbmVkIHRhaWwgZm9yICR7c2NyaXB0SWR9IGluICR7dG9va01pbGxpc31tc2ApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uQ2xvc2UgKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbikgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29uVGFpbENvbm5lY3Rpb25DbG9zZScsIHsKICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQsCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0SWQsCiAgICAgICAgICAgICAgICAgICAgdGltZVN0YW1wLAogICAgICAgICAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgICAgICAgICAgcmVhc29uLAogICAgICAgICAgICAgICAgICAgIHdhc0NsZWFuCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGRpcy5sb2dnZXIoYENsb3NlZCB0YWlsIGZvciAke3NjcmlwdElkfWAsIHsKICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICB3YXNDbGVhbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25FcnJvciAoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBlcnJvckluZm8pIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvblRhaWxDb25uZWN0aW9uRXJyb3InLCB7CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkLAogICAgICAgICAgICAgICAgICAgIHNjcmlwdElkLAogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgICAgICBlcnJvckluZm8KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGlzLmxvZ2dlcihgRXJyb3IgaW4gdGFpbCBmb3IgJHtzY3JpcHRJZH1gLCB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JJbmZvCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UgKF9hY2NvdW50SWQsIF9zY3JpcHRJZCwgX3RpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgZHVtcE1lc3NhZ2VQcmV0dHkobWVzc2FnZSwgZGlzLmxvZ2dlcik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UgKF9hY2NvdW50SWQsIHNjcmlwdElkLCBfdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGRpcy5sb2dnZXIoYFVucGFyc2VkIG1lc3NhZ2UgaW4gdGFpbCBmb3IgJHtzY3JpcHRJZH1gLCBwYXJzZUVycm9yLnN0YWNrIHx8IHBhcnNlRXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVGFpbHNDaGFuZ2VkICh0YWlscykgewogICAgICAgICAgICAgICAgaWYgKHNldEVxdWFsKGRpcy50YWlscywgdGFpbHMpKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVkID0gc2V0U3VidHJhY3QoZGlzLnRhaWxzLCB0YWlscyk7CiAgICAgICAgICAgICAgICBsb2dUYWlsc0NoYW5nZSgnUmVtb3ZlZCcsIHJlbW92ZWQpOwogICAgICAgICAgICAgICAgY29uc3QgYWRkZWQgPSBzZXRTdWJ0cmFjdCh0YWlscywgZGlzLnRhaWxzKTsKICAgICAgICAgICAgICAgIGxvZ1RhaWxzQ2hhbmdlKCdBZGRlZCcsIGFkZGVkKTsKICAgICAgICAgICAgICAgIGRpcy50YWlscyA9IHRhaWxzOwogICAgICAgICAgICAgICAgZGlzLm9uY2hhbmdlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHRoaXMudGFpbENvbnRyb2xsZXIgPSBuZXcgVGFpbENvbnRyb2xsZXIoY2FsbGJhY2tzMyk7CiAgICB9CiAgICBzdGFydCgpIHsKICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgdGhpcy5wZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpOwogICAgfQogICAgbmV3UHJvZmlsZSgpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCA9IGdlbmVyYXRlVXVpZCgpOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS50aXRsZSA9ICdOZXcgUHJvZmlsZSc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gdGhpcy5wcm9maWxlcy5sZW5ndGggPT09IDAgPyAnZGVmYXVsdCcgOiBgcHJvZmlsZSR7dGhpcy5wcm9maWxlcy5sZW5ndGggKyAxfWA7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hY2NvdW50SWQgPSAnJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID0gZmFsc2U7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRQcm9maWxlKHByb2ZpbGVJZCkgewogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgaWYgKCFwcm9maWxlKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgJHtwcm9maWxlSWR9IG5vdCBmb3VuZGApOwogICAgICAgIHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgIGNvbnN0IHsgbmFtZTogbmFtZTQgLCBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5wcm9maWxlSWQgPSBwcm9maWxlSWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnRpdGxlID0gJ0VkaXQgUHJvZmlsZSc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gbmFtZTQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hY2NvdW50SWQgPSBhY2NvdW50SWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hcGlUb2tlbiA9IGFwaVRva2VuOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgIH0KICAgIGRlbGV0ZVByb2ZpbGUocHJvZmlsZUlkKSB7CiAgICAgICAgY29uc29sZS5sb2coJ2RlbGV0ZSBwcm9maWxlJywgcHJvZmlsZUlkKTsKICAgICAgICBjb25zdCBwcm9maWxlID0gdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdOwogICAgICAgIGlmICghcHJvZmlsZSkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlICR7cHJvZmlsZUlkfSBub3QgZm91bmRgKTsKICAgICAgICBkZWxldGUgdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdOwogICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgdGhpcy5wZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpOwogICAgfQogICAgY2FuY2VsUHJvZmlsZSgpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlTmFtZShuYW1lKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVBY2NvdW50SWQoYWNjb3VudElkKSB7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hY2NvdW50SWQgPSBhY2NvdW50SWQ7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBzZXRQcm9maWxlQXBpVG9rZW4oYXBpVG9rZW4pIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFwaVRva2VuID0gYXBpVG9rZW47CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICB9CiAgICBzYXZlUHJvZmlsZSgpIHsKICAgICAgICBjb25zdCB7IHByb2ZpbGVGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCB7IHByb2ZpbGVJZCAgfSA9IHByb2ZpbGVGb3JtOwogICAgICAgIGNvbnN0IG5ld1Byb2ZpbGUgPSB7CiAgICAgICAgICAgIG5hbWU6IHByb2ZpbGVGb3JtLm5hbWUudHJpbSgpLAogICAgICAgICAgICBhY2NvdW50SWQ6IHByb2ZpbGVGb3JtLmFjY291bnRJZC50cmltKCksCiAgICAgICAgICAgIGFwaVRva2VuOiBwcm9maWxlRm9ybS5hcGlUb2tlbi50cmltKCkKICAgICAgICB9OwogICAgICAgIHRoaXMudHJ5U2F2ZVByb2ZpbGUocHJvZmlsZUlkLCBuZXdQcm9maWxlKTsKICAgIH0KICAgIHBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCkgewogICAgICAgIGNvbnN0IGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkID0gY29tcHV0ZUluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKHRoaXMuc3RhdGUsIHRoaXMucHJvZmlsZXMpOwogICAgICAgIGlmIChpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBwcm9maWxlOiAke3RoaXMuc3RhdGUucHJvZmlsZXNbaW5pdGlhbGx5U2VsZWN0ZWRQcm9maWxlSWRdLm5hbWV9YCk7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPSBpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgdHJ5U2F2ZVByb2ZpbGUocHJvZmlsZUlkLCBwcm9maWxlKSB7CiAgICAgICAgY29uc3QgeyBwcm9maWxlRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgcHJvZmlsZUZvcm0uZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA9IHRydWU7CiAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9ICdDaGVja2luZyBwcm9maWxlLi4uJzsKICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgY2FuTGlzdFRhaWxzID0gYXdhaXQgY29tcHV0ZUNhbkxpc3RUYWlscyhwcm9maWxlLmFjY291bnRJZCwgcHJvZmlsZS5hcGlUb2tlbik7CiAgICAgICAgICAgIGlmIChjYW5MaXN0VGFpbHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXSA9IHByb2ZpbGU7CiAgICAgICAgICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgICAgICAgICB0aGlzLnJlbG9hZFByb2ZpbGVzKCk7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJvZmlsZUZvcm0ub3V0cHV0TWVzc2FnZSA9IGBUaGVzZSBjcmVkZW50aWFscyBkbyBub3QgaGF2ZSBwZXJtaXNzaW9uIHRvIHRhaWxgOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gYEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgcHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLm9uY2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgcmVsb2FkUHJvZmlsZXMoKSB7CiAgICAgICAgY29uc3QgeyBzdGF0ZSAgfSA9IHRoaXM7CiAgICAgICAgdGhpcy5wcm9maWxlcy5zcGxpY2UoMCk7CiAgICAgICAgZm9yIChjb25zdCBbcHJvZmlsZUlkLCBwcm9maWxlXSBvZiBPYmplY3QuZW50cmllcyhzdGF0ZS5wcm9maWxlcykpewogICAgICAgICAgICBjb25zdCBuYW1lNCA9IHByb2ZpbGUubmFtZSB8fCAnKHVubmFtZWQpJzsKICAgICAgICAgICAgdGhpcy5wcm9maWxlcy5wdXNoKHsKICAgICAgICAgICAgICAgIGlkOiBwcm9maWxlSWQsCiAgICAgICAgICAgICAgICB0ZXh0OiBuYW1lNAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyBmaW5kU2NyaXB0cygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgICAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgICAgICBjb25zdCBzY3JpcHRzID0gYXdhaXQgbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbik7CiAgICAgICAgICAgIHRoaXMubG9nZ2VyKGBGb3VuZCAke3NjcmlwdHMubGVuZ3RofSBzY3JpcHRzYCk7CiAgICAgICAgICAgIHRoaXMuc2NyaXB0cy5zcGxpY2UoMCk7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRTY3JpcHRJZHMgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgIGZvciAoY29uc3Qgc2NyaXB0IG9mIHNjcmlwdHMpewogICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIoYEZvdW5kIHNjcmlwdCAke3NjcmlwdC5pZH1gKTsKICAgICAgICAgICAgICAgIHRoaXMuc2NyaXB0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpZDogc2NyaXB0LmlkLAogICAgICAgICAgICAgICAgICAgIHRleHQ6IHNjcmlwdC5pZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zY3JpcHRzLnNvcnQoKGxocywgcmhzKT0+bGhzLnRleHQubG9jYWxlQ29tcGFyZShyaHMudGV4dCkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKHRoaXMuc2NyaXB0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldChbCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY3JpcHRzWzBdLmlkCiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMub25jaGFuZ2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgdGhpcy5sb2dnZXIoYEVycm9yIGluIGZpbmRTY3JpcHRzOiAke2Uuc3RhY2t9YCk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgc2V0VGFpbHMoKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3RoaXMuc2VsZWN0ZWRQcm9maWxlSWRdOwogICAgICAgIGlmIChwcm9maWxlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLnRhaWxDb250cm9sbGVyLnNldFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4sIHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHRoaXMubG9nZ2VyKCdFcnJvciBpbiBzZXRUYWlscycsIGUuc3RhY2sgfHwgZS5tZXNzYWdlKTsKICAgICAgICB9CiAgICB9Cn0KY2xhc3MgUHJvZmlsZUZvcm1WTSB7CiAgICBzaG93aW5nID0gZmFsc2U7CiAgICBlbmFibGVkID0gZmFsc2U7CiAgICBuYW1lID0gJyc7CiAgICBhY2NvdW50SWQgPSAnJzsKICAgIGFwaVRva2VuID0gJyc7CiAgICBkZWxldGVWaXNpYmxlID0gZmFsc2U7CiAgICBzYXZlRW5hYmxlZCA9IGZhbHNlOwogICAgcHJvZmlsZUlkID0gJyc7CiAgICB0aXRsZSA9ICcnOwogICAgcHJvZ3Jlc3NWaXNpYmxlID0gZmFsc2U7CiAgICBvdXRwdXRNZXNzYWdlID0gJyc7CiAgICBjb21wdXRlU2F2ZUVuYWJsZWQoKSB7CiAgICAgICAgdGhpcy5zYXZlRW5hYmxlZCA9IHRoaXMubmFtZS50cmltKCkubGVuZ3RoID4gMCAmJiB0aGlzLmFwaVRva2VuLnRyaW0oKS5sZW5ndGggPiAwICYmIHRoaXMuYWNjb3VudElkLnRyaW0oKS5sZW5ndGggPiAwOwogICAgfQp9CmNvbnN0IFNUQVRFX0tFWSA9ICdzdGF0ZTEnOwpmdW5jdGlvbiBsb2FkU3RhdGUoKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IGpzb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVEFURV9LRVkpIHx8IHVuZGVmaW5lZDsKICAgICAgICBpZiAoanNvbikgewogICAgICAgICAgICBjb25zdCBydCA9IEpTT04ucGFyc2UoanNvbik7CiAgICAgICAgICAgIHJldHVybiBwYXJzZVN0YXRlKHJ0KTsKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdsb2FkU3RhdGU6IEVycm9yIGxvYWRpbmcgc3RhdGUnLCBlKTsKICAgIH0KICAgIGNvbnNvbGUubG9nKCdsb2FkU3RhdGU6IHJldHVybmluZyBuZXcgc3RhdGUnKTsKICAgIHJldHVybiB7CiAgICAgICAgcHJvZmlsZXM6IHsKICAgICAgICB9CiAgICB9Owp9CmZ1bmN0aW9uIHBhcnNlU3RhdGUocGFyc2VkKSB7CiAgICBpZiAodHlwZW9mIHBhcnNlZCAhPT0gJ29iamVjdCcpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgb2JqZWN0YCk7CiAgICBjb25zdCB7IHByb2ZpbGVzICB9ID0gcGFyc2VkOwogICAgaWYgKHR5cGVvZiBwcm9maWxlcyAhPT0gJ29iamVjdCcpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgcHJvZmlsZXMgb2JqZWN0YCk7CiAgICBmb3IgKGNvbnN0IFtwcm9maWxlSWQsIHByb2ZpbGVTdGF0ZV0gb2YgT2JqZWN0LmVudHJpZXMocHJvZmlsZXMpKXsKICAgICAgICBpZiAodHlwZW9mIHByb2ZpbGVJZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcignUHJvZmlsZSBpZCBtdXN0IGJlIHN0cmluZycpOwogICAgICAgIHBhcnNlUHJvZmlsZVN0YXRlKHByb2ZpbGVTdGF0ZSk7CiAgICB9CiAgICByZXR1cm4gcGFyc2VkOwp9CmZ1bmN0aW9uIHBhcnNlUHJvZmlsZVN0YXRlKHBhcnNlZCkgewogICAgaWYgKHR5cGVvZiBwYXJzZWQgIT09ICdvYmplY3QnIHx8IHBhcnNlZCA9PT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdQcm9maWxlIHN0YXRlIG11c3QgYmUgb2JqZWN0Jyk7CiAgICBjb25zdCB7IG5hbWU6IG5hbWU0ICwgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwYXJzZWQ7CiAgICBpZiAodHlwZW9mIG5hbWU0ICE9PSAnc3RyaW5nJyB8fCBuYW1lNC50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgbmFtZSBtdXN0IGV4aXN0YCk7CiAgICBpZiAodHlwZW9mIGFjY291bnRJZCAhPT0gJ3N0cmluZycgfHwgYWNjb3VudElkLnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBhY2NvdW50SWQgbXVzdCBleGlzdGApOwogICAgaWYgKHR5cGVvZiBhcGlUb2tlbiAhPT0gJ3N0cmluZycgfHwgYXBpVG9rZW4udHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIGFwaVRva2VuIG11c3QgZXhpc3RgKTsKICAgIHJldHVybiBwYXJzZWQ7Cn0KZnVuY3Rpb24gc2F2ZVN0YXRlKHN0YXRlKSB7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShTVEFURV9LRVksIEpTT04uc3RyaW5naWZ5KHN0YXRlKSk7Cn0KYXN5bmMgZnVuY3Rpb24gY29tcHV0ZUNhbkxpc3RUYWlscyhhY2NvdW50SWQsIGFwaVRva2VuKSB7CiAgICB0cnkgewogICAgICAgIGF3YWl0IGxpc3RUYWlscyhhY2NvdW50SWQsICcnLCBhcGlUb2tlbik7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBDbG91ZGZsYXJlQXBpRXJyb3IgJiYgZS5zdGF0dXMgPT09IDQwNCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKHN0YXRlLCBwcm9maWxlcykgewogICAgaWYgKHN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkICYmIHN0YXRlLnByb2ZpbGVzW3N0YXRlLnNlbGVjdGVkUHJvZmlsZUlkXSkgcmV0dXJuIHN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkOwogICAgaWYgKHByb2ZpbGVzLmxlbmd0aCA+IDApIHJldHVybiBwcm9maWxlc1swXS5pZDsKICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KY29uc3QgUFJPRklMRV9FRElUT1JfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJwcm9maWxlLWZvcm0iIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJwcm9maWxlLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQiPlByb2ZpbGU8L2Rpdj4KCiAgPGxhYmVsIGZvcj0icHJvZmlsZS1uYW1lIj5Qcm9maWxlIG5hbWU6PC9sYWJlbD4KICA8aW5wdXQgaWQ9InByb2ZpbGUtbmFtZSIgdHlwZT0idGV4dCI+CgogIDxsYWJlbCBmb3I9ImFjY291bnQtaWQiPkNsb3VkZmxhcmUgQWNjb3VudCBJRDo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hY2NvdW50LWlkIiB0eXBlPSJ0ZXh0Ij4KCiAgPGxhYmVsIGZvcj0iYXBpLXRva2VuIj5DbG91ZGZsYXJlIEFQSSBUb2tlbjo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1hcGktdG9rZW4iIHR5cGU9InRleHQiPgoKICA8ZGV0YWlscyBpZD0icHJvZmlsZS1mb3JtLWhlbHAtcm93IiBjbGFzcz0iZm9ybS1yb3ciPgogICAgPHN1bW1hcnk+VXNlIGEgPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJpbmNpcGxlX29mX2xlYXN0X3ByaXZpbGVnZSIgdGFyZ2V0PSJfYmxhbmsiPmxlYXN0IHByaXZpbGVnZTwvYT4gdG9rZW4gd2l0aCA8Y29kZT5BY2NvdW50ICZndDsgV29ya2VycyBUYWlsICZndDsgUmVhZDwvY29kZT48L3N1bW1hcnk+CiAgICA8ZGl2Pk1hbmFnZSB0b2tlbnMgb24gdGhlIENsb3VkZmxhcmUgZGFzaGJvYXJkIDxhIGhyZWY9Imh0dHBzOi8vZGFzaC5jbG91ZGZsYXJlLmNvbS9wcm9maWxlL2FwaS10b2tlbnMiIHRhcmdldD0iX2JsYW5rIj5BUEkgVG9rZW5zPC9hPiBwYWdlLjwvZGl2PgogIDwvZGV0YWlscz4gIAoKICA8ZGl2IGlkPSJwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyIgY2xhc3M9ImZvcm0tcm93Ij4KICAgIDxvdXRwdXQgaWQ9InByb2ZpbGUtZm9ybS1vdXRwdXQiPjwvb3V0cHV0PgogICAgPHByb2dyZXNzIGlkPSJwcm9maWxlLWZvcm0tcHJvZ3Jlc3MiIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmb3JtLWxocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWRlbGV0ZSI+RGVsZXRlPC9idXR0b24+CiAgPC9kaXY+CiAgPGRpdiBpZD0icHJvZmlsZS1mb3JtLWJ1dHRvbnMiIGNsYXNzPSJmb3JtLXJocyI+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLWNhbmNlbCI+Q2FuY2VsPC9idXR0b24+CiAgICA8YnV0dG9uIGlkPSJwcm9maWxlLXNhdmUiPlNhdmU8L2J1dHRvbj4KICA8L2Rpdj4KPC9maWVsZHNldD4KPC9mb3JtPgpgOwpjb25zdCBQUk9GSUxFX0VESVRPUl9DU1MgPSBjc3NgCgogICAgI3Byb2ZpbGUtZm9ybS1idXR0b25zIHsKICAgICAgICBqdXN0aWZ5LXNlbGY6IGVuZDsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogMXJlbTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IHsKICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBzdW1tYXJ5IHsKICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIH0KCiAgICAjcHJvZmlsZS1mb3JtLWhlbHAtcm93IGRpdiB7CiAgICAgICAgbWFyZ2luOiAxcmVtOwogICAgICAgIGN1cnNvcjogZGVmYXVsdAogICAgfQoKICAgICNwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMXJlbTsKICAgICAgICBtaW4taGVpZ2h0OiAyLjVyZW07CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1vdXRwdXQtcm93IG91dHB1dCB7CiAgICAgICAgZmxleC1ncm93OiAxOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0tcHJvZ3Jlc3MgewogICAgICAgIGZvbnQtc2l6ZTogMC41cmVtOyAvKiBkZWZhdWx0IDNlbSA9PiAxLjVyZW0gKi8KICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRQcm9maWxlRWRpdG9yKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgcHJvZmlsZUZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtJyk7CiAgICBjb25zdCBwcm9maWxlRm9ybVRpdGxlRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS10aXRsZScpOwogICAgY29uc3QgcHJvZmlsZUZpZWxkc2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZmllbGRzZXQnKTsKICAgIGNvbnN0IHByb2ZpbGVOYW1lSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1uYW1lJyk7CiAgICBjb25zdCBwcm9maWxlQWNjb3VudElkSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1hY2NvdW50LWlkJyk7CiAgICBjb25zdCBwcm9maWxlQXBpVG9rZW5JbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFwaS10b2tlbicpOwogICAgY29uc3QgcHJvZmlsZURlbGV0ZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWRlbGV0ZScpOwogICAgY29uc3QgcHJvZmlsZUNhbmNlbEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWNhbmNlbCcpOwogICAgY29uc3QgcHJvZmlsZVNhdmVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1zYXZlJyk7CiAgICBjb25zdCBwcm9maWxlRm9ybVByb2dyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1wcm9ncmVzcycpOwogICAgY29uc3QgcHJvZmlsZUZvcm1PdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLW91dHB1dCcpOwogICAgY29uc3QgcHJvZmlsZUZvcm1IZWxwRGV0YWlscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0taGVscC1yb3cnKTsKICAgIHByb2ZpbGVDYW5jZWxCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5jYW5jZWxQcm9maWxlKCk7CiAgICB9OwogICAgcHJvZmlsZU5hbWVJbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bS5zZXRQcm9maWxlTmFtZShwcm9maWxlTmFtZUlucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlQWNjb3VudElkSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0uc2V0UHJvZmlsZUFjY291bnRJZChwcm9maWxlQWNjb3VudElkSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVBcGlUb2tlbklucHV0Lm9uaW5wdXQgPSAoKT0+ewogICAgICAgIHZtLnNldFByb2ZpbGVBcGlUb2tlbihwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZVNhdmVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5zYXZlUHJvZmlsZSgpOwogICAgfTsKICAgIHByb2ZpbGVEZWxldGVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5kZWxldGVQcm9maWxlKHZtLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gcHJvZmlsZUZvcm0uc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIHByb2ZpbGVGb3JtLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5zaG93aW5nID8gJ2dyaWQnIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVGaWVsZHNldC5kaXNhYmxlZCA9ICF2bS5wcm9maWxlRm9ybS5lbmFibGVkOwogICAgICAgIHByb2ZpbGVGb3JtVGl0bGVEaXYudGV4dENvbnRlbnQgPSB2bS5wcm9maWxlRm9ybS50aXRsZTsKICAgICAgICBwcm9maWxlTmFtZUlucHV0LnZhbHVlID0gdm0ucHJvZmlsZUZvcm0ubmFtZTsKICAgICAgICBwcm9maWxlQWNjb3VudElkSW5wdXQudmFsdWUgPSB2bS5wcm9maWxlRm9ybS5hY2NvdW50SWQ7CiAgICAgICAgcHJvZmlsZUFwaVRva2VuSW5wdXQudmFsdWUgPSB2bS5wcm9maWxlRm9ybS5hcGlUb2tlbjsKICAgICAgICBwcm9maWxlRGVsZXRlQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5kZWxldGVWaXNpYmxlID8gJ2lubGluZS1ibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZVNhdmVCdXR0b24uZGlzYWJsZWQgPSAhdm0ucHJvZmlsZUZvcm0uc2F2ZUVuYWJsZWQ7CiAgICAgICAgcHJvZmlsZUZvcm1Qcm9ncmVzcy5zdHlsZS5kaXNwbGF5ID0gdm0ucHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBwcm9maWxlRm9ybU91dHB1dC50ZXh0Q29udGVudCA9IHZtLnByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2U7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiB2bS5wcm9maWxlRm9ybS5zaG93aW5nKSB7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtSGVscERldGFpbHMub3BlbiA9IGZhbHNlOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZUlucHV0LnNlbGVjdCgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IE1PREFMX0hUTUwgPSBodG1sYAo8ZGl2IGlkPSJtb2RhbCIgY2xhc3M9Im1vZGFsIj4KICAgIDxkaXYgY2xhc3M9Im1vZGFsLWNvbnRlbnQiPgogICAgJHtQUk9GSUxFX0VESVRPUl9IVE1MfQogICAgPC9kaXY+CjwvZGl2PgpgOwpjb25zdCBNT0RBTF9DU1MgPSBjc3NgCi5tb2RhbCB7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9zaXRpb246IGZpeGVkOwogICAgei1pbmRleDogMTsKICAgIGxlZnQ6IDA7CiAgICB0b3A6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIG92ZXJmbG93OiBhdXRvOwogICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjQpOwp9CgoubW9kYWwtY29udGVudCB7CiAgICBtYXJnaW46IDE1JSBhdXRvOwogICAgd2lkdGg6IDgwJTsKICAgIG1heC13aWR0aDogNDByZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQpgOwpmdW5jdGlvbiBpbml0TW9kYWwoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBtb2RhbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb2RhbCcpOwogICAgY29uc3QgdXBkYXRlUHJvZmlsZUVkaXRvciA9IGluaXRQcm9maWxlRWRpdG9yKGRvY3VtZW50LCB2bSk7CiAgICBjb25zdCBjbG9zZU1vZGFsID0gKCk9PnsKICAgICAgICBpZiAoIXZtLnByb2ZpbGVGb3JtLnNob3dpbmcpIHJldHVybjsKICAgICAgICBpZiAodm0ucHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlKSByZXR1cm47CiAgICAgICAgdm0ucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHZtLm9uY2hhbmdlKCk7CiAgICB9OwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2ZW50KT0+ewogICAgICAgIGlmIChldmVudC50YXJnZXQgPT0gbW9kYWwpIHsKICAgICAgICAgICAgY2xvc2VNb2RhbCgpOwogICAgICAgIH0KICAgIH0pOwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChldmVudCk9PnsKICAgICAgICBldmVudCA9IGV2ZW50IHx8IHdpbmRvdy5ldmVudDsKICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAnRXNjYXBlJykgewogICAgICAgICAgICBjbG9zZU1vZGFsKCk7CiAgICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICB1cGRhdGVQcm9maWxlRWRpdG9yKCk7CiAgICAgICAgbW9kYWwuc3R5bGUuZGlzcGxheSA9IHZtLnByb2ZpbGVGb3JtLnNob3dpbmcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgfTsKfQpjb25zdCBDSVJDVUxBUl9QUk9HUkVTU19DU1MgPSBjc3NgCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgIC1tb3otYXBwZWFyYW5jZTogbm9uZTsKICAgIGFwcGVhcmFuY2U6IG5vbmU7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcGFkZGluZzogMC4yNWVtOwogICAgd2lkdGg6IDNlbTsKICAgIGhlaWdodDogM2VtOwogICAgY29sb3I6IHZhcigtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2IsIHJnYigzMywgMTUwLCAyNDMpKTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZm9udC1zaXplOiAxNnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6Oi13ZWJraXQtcHJvZ3Jlc3MtYmFyIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50Owp9CgovKiBJbmRldGVybWluYXRlICovCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGUgewogICAgLXdlYmtpdC1tYXNrLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpLCBsaW5lYXItZ3JhZGllbnQodG8gcmlnaHQsIHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKTsKICAgIG1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIDZzIGluZmluaXRlIGN1YmljLWJlemllcigwLjMsIDAuNiwgMSwgMSk7Cn0KCjotbXMtbGFuZyh4KSwgLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICBhbmltYXRpb246IG5vbmU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6OmJlZm9yZSwKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6LXdlYmtpdC1wcm9ncmVzcy12YWx1ZSB7CiAgICBjb250ZW50OiAiIjsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIG1hcmdpbi1ib3R0b206IDAuMjVlbTsKICAgIGJvcmRlcjogc29saWQgMC4yNWVtIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogY3VycmVudENvbG9yOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgd2lkdGg6IDEwMCUgIWltcG9ydGFudDsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbW96LXByb2dyZXNzLWJhciB7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbXMtZmlsbCB7CiAgICBhbmltYXRpb24tbmFtZTogLW1zLXJpbmc7Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7CiAgICB9CiAgICAxMi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAyNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDYzMGRlZyk7CiAgICB9CiAgICAzNy41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoODEwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICA1MCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDEyNjBkZWcpOwogICAgfQogICAgNjIuNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDE0NDBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDc1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTg5MGRlZyk7CiAgICB9CiAgICA4Ny41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjA3MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgMTAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjUyMGRlZyk7CiAgICB9Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhci1wc2V1ZG8gewogICAgMCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKC0zMGRlZyk7CiAgICB9CiAgICAyOS40JSB7CiAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgMjkuNDElIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgfQogICAgNjQuNyUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgNjQuNzElIHsKICAgICAgICBib3JkZXItYm90dG9tLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMjVkZWcpOwogICAgfQp9CmA7CmNvbnN0IENPTlNPTEVfSFRNTCA9IGh0bWxgCjxkaXYgaWQ9ImNvbnNvbGUiPgogICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXIiPgogICAgICAgIDxkaXYgaWQ9ImNvbnNvbGUtaGVhZGVyLWZpbHRlcnMiPjwvZGl2PgogICAgICAgIDxkaXYgaWQ9ImNvbnNvbGUtaGVhZGVyLXRhaWxzIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJjb25zb2xlLWxhc3QtbGluZSIgY2xhc3M9ImxpbmUiPnNwYWNlcjwvZGl2Pgo8L2Rpdj4KCmA7CmNvbnN0IENPTlNPTEVfQ1NTID0gY3NzYAoKI2NvbnNvbGUgewogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgaGVpZ2h0OiAxMDB2aDsKICAgIHdpZHRoOiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7CiAgICBvdmVyZmxvdy14OiBoaWRkZW47CiAgICBmbGV4LWdyb3c6IDE7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICB3aWR0aDogMXJlbTsKICAgIGhlaWdodDogM3JlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwp9CgojY29uc29sZTo6LXdlYmtpdC1zY3JvbGxiYXItdGh1bWIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgojY29uc29sZS1oZWFkZXIgewogICAgcG9zaXRpb246IHN0aWNreTsKICAgIHRvcDogMDsKICAgIGhlaWdodDogNXJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgZGlzcGxheTogZmxleDsKICAgIHBhZGRpbmc6IDFyZW07Cn0KCiNjb25zb2xlLWhlYWRlci1maWx0ZXJzIHsKICAgIGZsZXgtZ3JvdzogMTsKfQoKI2NvbnNvbGUgLmxpbmUgewogICAgcGFkZGluZzogMC4xcmVtIDA7CiAgICB3aGl0ZS1zcGFjZTogcHJlOwp9CgojY29uc29sZS1sYXN0LWxpbmUgewogICAgdmlzaWJpbGl0eTogaGlkZGVuOwp9CgpgOwpmdW5jdGlvbiBpbml0Q29uc29sZShkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IGNvbnNvbGVEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZScpOwogICAgY29uc3QgY29uc29sZUhlYWRlclRhaWxzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLXRhaWxzJyk7CiAgICBjb25zdCBjb25zb2xlTGFzdExpbmVEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1sYXN0LWxpbmUnKTsKICAgIHZtLmxvZ2dlciA9ICguLi5kYXRhKT0+ewogICAgICAgIGNvbnN0IGxpbmVEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBsaW5lRGl2LmNsYXNzTmFtZSA9ICdsaW5lJzsKICAgICAgICBsZXQgcG9zID0gMDsKICAgICAgICB3aGlsZShwb3MgPCBkYXRhLmxlbmd0aCl7CiAgICAgICAgICAgIGlmIChwb3MgPiAwKSB7CiAgICAgICAgICAgICAgICBsaW5lRGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcsICcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBtc2cgPSBkYXRhW3Bvc107CiAgICAgICAgICAgIGlmICh0eXBlb2YgbXNnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgY29uc3QgdG9rZW5zID0gbXNnLnNwbGl0KCclYycpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpMSA9IDA7IGkxIDwgdG9rZW5zLmxlbmd0aDsgaTErKyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaTEgPiAwICYmIGkxIDwgdG9rZW5zLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkYXRhW3BvcyArIGkxXTsKICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZW5kZXJUZXh0SW50b1NwYW4odG9rZW5zW2kxXSwgc3Bhbik7CiAgICAgICAgICAgICAgICAgICAgbGluZURpdi5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvcyArPSAxICsgdG9rZW5zLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5lRGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKEpTT04uc3RyaW5naWZ5KG1zZykpKTsKICAgICAgICAgICAgICAgIHBvcysrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnNvbGVEaXYuaW5zZXJ0QmVmb3JlKGxpbmVEaXYsIGNvbnNvbGVMYXN0TGluZURpdik7CiAgICAgICAgY29uc3QgeyBzY3JvbGxIZWlnaHQgLCBzY3JvbGxUb3AgLCBjbGllbnRIZWlnaHQgIH0gPSBjb25zb2xlRGl2OwogICAgICAgIGNvbnN0IGRpZmYgPSBzY3JvbGxIZWlnaHQgLSBzY3JvbGxUb3A7CiAgICAgICAgY29uc3QgYXV0b3Njcm9sbCA9IGRpZmYgLSAxNiAqIDQgPD0gY2xpZW50SGVpZ2h0OwogICAgICAgIGlmIChhdXRvc2Nyb2xsKSB7CiAgICAgICAgICAgIGNvbnNvbGVMYXN0TGluZURpdi5zY3JvbGxJbnRvVmlldyhmYWxzZSk7CiAgICAgICAgfQogICAgfTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnNvbGVIZWFkZXJUYWlsc0Rpdi50ZXh0Q29udGVudCA9IGNvbXB1dGVUYWlsc1RleHQodm0udGFpbHMuc2l6ZSk7CiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsc1RleHQodGFpbENvdW50KSB7CiAgICByZXR1cm4gdGFpbENvdW50ID09PSAwID8gJ25vIHRhaWxzJyA6IHRhaWxDb3VudCA9PT0gMSA/ICcxIHRhaWwnIDogYCR7dGFpbENvdW50fSB0YWlsc2A7Cn0KZnVuY3Rpb24gcmVuZGVyVGV4dEludG9TcGFuKHRleHQsIHNwYW4pIHsKICAgIGNvbnN0IHBhdHRlcm4gPSAvaHR0cHM6XC9cL1teXHNdKy9nOwogICAgbGV0IG07CiAgICBsZXQgaTEgPSAwOwogICAgd2hpbGUobnVsbCAhPT0gKG0gPSBwYXR0ZXJuLmV4ZWModGV4dCkpKXsKICAgICAgICBpZiAobS5pbmRleCA+IGkxKSB7CiAgICAgICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dC5zdWJzdHJpbmcoaTEsIG0uaW5kZXgpKSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVybCA9IG1bMF07CiAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBhLmhyZWYgPSB1cmw7CiAgICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICBhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHVybCkpOwogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgaTEgPSBtLmluZGV4ICsgdXJsLmxlbmd0aDsKICAgIH0KICAgIGlmIChpMSA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0LnN1YnN0cmluZyhpMSkpKTsKICAgIH0KfQpjb25zdCBhcHBDc3MgPSBjc3NgCgptYWluIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNXJlbTsKfQoKOnJvb3QgewogICAgLS1wdXJlLW1hdGVyaWFsLXByaW1hcnktcmdiOiByZ2IoMTg3LCAxMzQsIDI1Mik7Cn0KYDsKY29uc3QgYXBwSHRtbCA9IGh0bWxgCjxtYWluPgoke1NJREVCQVJfSFRNTH0KJHtDT05TT0xFX0hUTUx9CiR7TU9EQUxfSFRNTH0KPC9tYWluPmA7CmZ1bmN0aW9uIGFwcGVuZFN0eWxlc2hlZXRzKGNzc1RleHRzKSB7CiAgICBjb25zdCBzdHlsZVNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgIHN0eWxlU2hlZXQudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgICBzdHlsZVNoZWV0LnRleHRDb250ZW50ID0gY3NzVGV4dHMuam9pbignXG5cbicpOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZVNoZWV0KTsKfQphcHBlbmRTdHlsZXNoZWV0cyhbCiAgICBNQVRFUklBTF9DU1MuY3NzVGV4dCwKICAgIGFwcENzcy5jc3NUZXh0LAogICAgSEVBREVSX0NTUy5jc3NUZXh0LAogICAgU0lERUJBUl9DU1MuY3NzVGV4dCwKICAgIENPTlNPTEVfQ1NTLmNzc1RleHQsCiAgICBNT0RBTF9DU1MuY3NzVGV4dCwKICAgIFBST0ZJTEVfRURJVE9SX0NTUy5jc3NUZXh0LAogICAgQ0lSQ1VMQVJfUFJPR1JFU1NfQ1NTLmNzc1RleHQsIApdKTsKTGl0RWxlbWVudC5yZW5kZXIoYXBwSHRtbCwgZG9jdW1lbnQuYm9keSk7CmNvbnN0IHZtID0gbmV3IFRhaWx3ZWJBcHBWTSgpOwpjb25zdCB1cGRhdGVTaWRlYmFyID0gaW5pdFNpZGViYXIoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlQ29uc29sZSA9IGluaXRDb25zb2xlKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZU1vZGFsID0gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSk7CnZtLm9uY2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZVNpZGViYXIoKTsKICAgIHVwZGF0ZUNvbnNvbGUoKTsKICAgIHVwZGF0ZU1vZGFsKCk7Cn07CkNsb3VkZmxhcmVBcGkuVVJMX1RSQU5TRk9STUVSID0gKHYpPT5gL2ZldGNoLyR7di5zdWJzdHJpbmcoJ2h0dHBzOi8vJy5sZW5ndGgpfWAKOwp2bS5zdGFydCgpOwo=';