

export const WEBTAIL_APP_HASH = '30154f758b74182b12b7e4fa56bb991fb465b556';
export const WEBTAIL_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7Cn07CmNvbnN0IG5vdGhpbmcgPSB7Cn07CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50Q29udGV4dCl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICAgICAgdGhpcy5ldmVudENvbnRleHQgPSBldmVudENvbnRleHQ7CiAgICAgICAgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQgPSAoZSk9PnRoaXMuaGFuZGxlRXZlbnQoZSkKICAgICAgICA7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBjb25zdCBvbGRMaXN0ZW5lciA9IHRoaXMudmFsdWU7CiAgICAgICAgY29uc3Qgc2hvdWxkUmVtb3ZlTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciA9PSBudWxsIHx8IG9sZExpc3RlbmVyICE9IG51bGwgJiYgKG5ld0xpc3RlbmVyLmNhcHR1cmUgIT09IG9sZExpc3RlbmVyLmNhcHR1cmUgfHwgbmV3TGlzdGVuZXIub25jZSAhPT0gb2xkTGlzdGVuZXIub25jZSB8fCBuZXdMaXN0ZW5lci5wYXNzaXZlICE9PSBvbGRMaXN0ZW5lci5wYXNzaXZlKTsKICAgICAgICBjb25zdCBzaG91bGRBZGRMaXN0ZW5lciA9IG5ld0xpc3RlbmVyICE9IG51bGwgJiYgKG9sZExpc3RlbmVyID09IG51bGwgfHwgc2hvdWxkUmVtb3ZlTGlzdGVuZXIpOwogICAgICAgIGlmIChzaG91bGRSZW1vdmVMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZEFkZExpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX19vcHRpb25zID0gZ2V0T3B0aW9ucyhuZXdMaXN0ZW5lcik7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gbmV3TGlzdGVuZXI7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgfQogICAgaGFuZGxlRXZlbnQoZXZlbnQpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMudmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5jYWxsKHRoaXMuZXZlbnRDb250ZXh0IHx8IHRoaXMuZWxlbWVudCwgZXZlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuaGFuZGxlRXZlbnQoZXZlbnQpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBnZXRPcHRpb25zID0gKG8pPT5vICYmIChldmVudE9wdGlvbnNTdXBwb3J0ZWQgPyB7CiAgICAgICAgY2FwdHVyZTogby5jYXB0dXJlLAogICAgICAgIHBhc3NpdmU6IG8ucGFzc2l2ZSwKICAgICAgICBvbmNlOiBvLm9uY2UKICAgIH0gOiBvLmNhcHR1cmUpCjsKY2xhc3MgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yIHsKICAgIGhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBwcmVmaXggPSBuYW1lWzBdOwogICAgICAgIGlmIChwcmVmaXggPT09ICIuIikgewogICAgICAgICAgICBjb25zdCBjb21taXR0ZXIyID0gbmV3IFByb3BlcnR5Q29tbWl0dGVyKGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpOwogICAgICAgICAgICByZXR1cm4gY29tbWl0dGVyMi5wYXJ0czsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIkAiKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgRXZlbnRQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIG9wdGlvbnMuZXZlbnRDb250ZXh0KQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiPyIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBCb29sZWFuQXR0cmlidXRlUGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21taXR0ZXIgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIucGFydHM7CiAgICB9CiAgICBoYW5kbGVUZXh0RXhwcmVzc2lvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBOb2RlUGFydChvcHRpb25zKTsKICAgIH0KfQpjb25zdCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgPSBuZXcgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKCk7CmZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShyZXN1bHQpIHsKICAgIGxldCB0ZW1wbGF0ZUNhY2hlID0gdGVtcGxhdGVDYWNoZXMuZ2V0KHJlc3VsdC50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0LnR5cGUsIHRlbXBsYXRlQ2FjaGUpOwogICAgfQogICAgbGV0IHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuZ2V0KHJlc3VsdC5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfQogICAgY29uc3Qga2V5ID0gcmVzdWx0LnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5nZXQoa2V5KTsKICAgIGlmICh0ZW1wbGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUocmVzdWx0LCByZXN1bHQuZ2V0VGVtcGxhdGVFbGVtZW50KCkpOwogICAgICAgIHRlbXBsYXRlQ2FjaGUua2V5U3RyaW5nLnNldChrZXksIHRlbXBsYXRlKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQuc3RyaW5ncywgdGVtcGxhdGUpOwogICAgcmV0dXJuIHRlbXBsYXRlOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQsIGNvbnRhaW5lciwgb3B0aW9ucyk9PnsKICAgIGxldCBwYXJ0ID0gcGFydHMuZ2V0KGNvbnRhaW5lcik7CiAgICBpZiAocGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZXMoY29udGFpbmVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgcGFydHMuc2V0KGNvbnRhaW5lciwgcGFydCA9IG5ldyBOb2RlUGFydChPYmplY3QuYXNzaWduKHsKICAgICAgICAgICAgdGVtcGxhdGVGYWN0b3J5CiAgICAgICAgfSwgb3B0aW9ucykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0KTsKICAgIHBhcnQuY29tbWl0KCk7Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogICAgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjEuNC4xIik7Cn0KY29uc3QgaHRtbCA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5ncywgdmFsdWVzLCAiaHRtbCIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwpjb25zdCBzdmcgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFNWR1RlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcyksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHNbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyIHx8IGRlZmF1bHRDb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgZnJvbUF0dHJpYnV0ZSA9IHR5cGVvZiBjb252ZXJ0ZXIgPT09ICJmdW5jdGlvbiIgPyBjb252ZXJ0ZXIgOiBjb252ZXJ0ZXIuZnJvbUF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gZnJvbUF0dHJpYnV0ZSA/IGZyb21BdHRyaWJ1dGUodmFsdWUsIHR5cGUpIDogdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlKTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKT0+dGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHJlcwogICAgICAgICk7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fc2F2ZUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKCk7CiAgICB9CiAgICBfc2F2ZUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgoX3YsIHApPT57CiAgICAgICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNbcF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1twXTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLnNldChwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9hcHBseUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnRoaXNbcF0gPSB2CiAgICAgICAgKTsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSB2b2lkIDA7CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICB0aGlzLmVuYWJsZVVwZGF0aW5nKCk7CiAgICB9CiAgICBlbmFibGVVcGRhdGluZygpIHsKICAgICAgICBpZiAodGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIoKTsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHZvaWQgMDsKICAgICAgICB9CiAgICB9CiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgIH0KICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG9sZCAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX3Byb3BlcnR5VG9BdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IGF0dHIgPSBjdG9yLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBhdHRyVmFsdWUgPSBjdG9yLl9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgfQogICAgfQogICAgX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHByb3BOYW1lID0gY3Rvci5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5nZXQobmFtZSk7CiAgICAgICAgaWYgKHByb3BOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKHByb3BOYW1lKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgICAgIHRoaXNbcHJvcE5hbWVdID0gY3Rvci5fcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtVXBkYXRlKCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIGF3YWl0IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgRWxlbWVudFByb3RvID0gRWxlbWVudC5wcm90b3R5cGU7CkVsZW1lbnRQcm90by5tc01hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50UHJvdG8ud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwpjb25zdCBzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMgPSB3aW5kb3cuU2hhZG93Um9vdCAmJiAod2luZG93LlNoYWR5Q1NTID09PSB2b2lkIDAgfHwgd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgJiYgImFkb3B0ZWRTdHlsZVNoZWV0cyIgaW4gRG9jdW1lbnQucHJvdG90eXBlICYmICJyZXBsYWNlIiBpbiBDU1NTdHlsZVNoZWV0LnByb3RvdHlwZTsKY29uc3QgY29uc3RydWN0aW9uVG9rZW4gPSBTeW1ib2woKTsKY2xhc3MgQ1NTUmVzdWx0IHsKICAgIGNvbnN0cnVjdG9yKGNzc1RleHQsIHNhZmVUb2tlbil7CiAgICAgICAgaWYgKHNhZmVUb2tlbiAhPT0gY29uc3RydWN0aW9uVG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDU1NSZXN1bHQgaXMgbm90IGNvbnN0cnVjdGFibGUuIFVzZSBgdW5zYWZlQ1NTYCBvciBgY3NzYCBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgfQogICAgZ2V0IHN0eWxlU2hlZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0eWxlU2hlZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbmV3IENTU1N0eWxlU2hlZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQucmVwbGFjZVN5bmModGhpcy5jc3NUZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3NzVGV4dDsKICAgIH0KfQpjb25zdCB1bnNhZmVDU1MgPSAodmFsdWUpPT57CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChTdHJpbmcodmFsdWUpLCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07CmNvbnN0IHRleHRGcm9tQ1NTUmVzdWx0ID0gKHZhbHVlKT0+ewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ1NTUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLmNzc1RleHQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsdWUgcGFzc2VkIHRvICdjc3MnIGZ1bmN0aW9uIG11c3QgYmUgYSAnY3NzJyBmdW5jdGlvbiByZXN1bHQ6ICR7dmFsdWV9LiBVc2UgJ3Vuc2FmZUNTUycgdG8gcGFzcyBub24tbGl0ZXJhbCB2YWx1ZXMsIGJ1dAogICAgICAgICAgICB0YWtlIGNhcmUgdG8gZW5zdXJlIHBhZ2Ugc2VjdXJpdHkuYCk7CiAgICB9Cn07CmNvbnN0IGNzcyA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT57CiAgICBjb25zdCBjc3NUZXh0ID0gdmFsdWVzLnJlZHVjZSgoYWNjLCB2LCBpZHgpPT5hY2MgKyB0ZXh0RnJvbUNTU1Jlc3VsdCh2KSArIHN0cmluZ3NbaWR4ICsgMV0KICAgICwgc3RyaW5nc1swXSk7CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChjc3NUZXh0LCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07Cih3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIyLjUuMSIpOwpjb25zdCByZW5kZXJOb3RJbXBsZW1lbnRlZCA9IHsKfTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKYXN5bmMgZnVuY3Rpb24gbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0c2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RTY3JpcHRzJywgJ0dFVCcsIHVybCwgYXBpVG9rZW4pKS5yZXN1bHQ7Cn0KYXN5bmMgZnVuY3Rpb24gbGlzdFRhaWxzKGFjY291bnRJZCwgc2NyaXB0TmFtZSwgYXBpVG9rZW4pIHsKICAgIGNvbnN0IHVybCA9IGAke2NvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpfS93b3JrZXJzL3NjcmlwdHMvJHtzY3JpcHROYW1lfS90YWlsc2A7CiAgICByZXR1cm4gKGF3YWl0IGV4ZWN1dGUoJ2xpc3RUYWlscycsICdHRVQnLCB1cmwsIGFwaVRva2VuKSkucmVzdWx0Owp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhaWwoYWNjb3VudElkLCBzY3JpcHROYW1lLCBhcGlUb2tlbikgewogICAgY29uc3QgdXJsID0gYCR7Y29tcHV0ZUFjY291bnRCYXNlVXJsKGFjY291bnRJZCl9L3dvcmtlcnMvc2NyaXB0cy8ke3NjcmlwdE5hbWV9L3RhaWxzYDsKICAgIHJldHVybiAoYXdhaXQgZXhlY3V0ZSgnY3JlYXRlVGFpbCcsICdQT1NUJywgdXJsLCBhcGlUb2tlbikpLnJlc3VsdDsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpIHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04JzsKY29uc3QgQVBQTElDQVRJT05fT0NURVRfU1RSRUFNID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7CmZ1bmN0aW9uIGNvbXB1dGVBY2NvdW50QmFzZVVybChhY2NvdW50SWQpIHsKICAgIHJldHVybiBDbG91ZGZsYXJlQXBpLlVSTF9UUkFOU0ZPUk1FUihgaHR0cHM6Ly9hcGkuY2xvdWRmbGFyZS5jb20vY2xpZW50L3Y0L2FjY291bnRzLyR7YWNjb3VudElkfWApOwp9CmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUob3AsIG1ldGhvZCwgdXJsLCBhcGlUb2tlbiwgYm9keSwgcmVzcG9uc2VUeXBlID0gJ2pzb24nKSB7CiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoewogICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaVRva2VufWAKICAgIH0pOwogICAgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykgewogICAgICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBBUFBMSUNBVElPTl9KU09OX1VURjgpOwogICAgICAgIGlmIChDbG91ZGZsYXJlQXBpLkRFQlVHKSBjb25zb2xlLmxvZyhib2R5KTsKICAgIH0KICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5CiAgICB9KTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZmV0Y2hSZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJykgfHwgJyc7CiAgICBpZiAoKHJlc3BvbnNlVHlwZSA9PT0gJ2J5dGVzJyB8fCByZXNwb25zZVR5cGUgPT09ICdieXRlcz8nKSAmJiBjb250ZW50VHlwZSA9PT0gQVBQTElDQVRJT05fT0NURVRfU1RSRUFNKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgfQogICAgaWYgKCFbCiAgICAgICAgQVBQTElDQVRJT05fSlNPTl9VVEY4LAogICAgICAgIEFQUExJQ0FUSU9OX0pTT04KICAgIF0uaW5jbHVkZXMoY29udGVudFR5cGUpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRlbnQtdHlwZTogJHtjb250ZW50VHlwZX0sICBmZXRjaFJlc3BvbnNlPSR7ZmV0Y2hSZXNwb25zZX0sIGJvZHk9JHthd2FpdCBmZXRjaFJlc3BvbnNlLnRleHQoKX1gKTsKICAgIH0KICAgIGNvbnN0IGFwaVJlc3BvbnNlID0gYXdhaXQgZmV0Y2hSZXNwb25zZS5qc29uKCk7CiAgICBpZiAoQ2xvdWRmbGFyZUFwaS5ERUJVRykgY29uc29sZS5sb2coYXBpUmVzcG9uc2UpOwogICAgaWYgKCFhcGlSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgaWYgKGZldGNoUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgJiYgcmVzcG9uc2VUeXBlID09PSAnYnl0ZXM/JykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB0aHJvdyBuZXcgQ2xvdWRmbGFyZUFwaUVycm9yKGAke29wfSBmYWlsZWQ6IHN0YXR1cz0ke2ZldGNoUmVzcG9uc2Uuc3RhdHVzfSwgZXJyb3JzPSR7YXBpUmVzcG9uc2UuZXJyb3JzLm1hcCgodik9PmAke3YuY29kZX0gJHt2Lm1lc3NhZ2V9YAogICAgICAgICkuam9pbignLCAnKX1gLCBmZXRjaFJlc3BvbnNlLnN0YXR1cywgYXBpUmVzcG9uc2UuZXJyb3JzKTsKICAgIH0KICAgIHJldHVybiBhcGlSZXNwb25zZTsKfQpjbGFzcyBDbG91ZGZsYXJlQXBpRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBzdGF0dXM7CiAgICBlcnJvcnM7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBzdGF0dXMsIGVycm9ycyl7CiAgICAgICAgc3VwZXIobWVzc2FnZSk7CiAgICAgICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgdGhpcy5lcnJvcnMgPSBlcnJvcnM7CiAgICB9Cn0KZnVuY3Rpb24gc2V0U3VidHJhY3QobGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldChsaHMpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIHJocyl7CiAgICAgICAgcnQuZGVsZXRlKGl0ZW0pOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIHNldFVuaW9uKGxocywgcmhzKSB7CiAgICBjb25zdCBydCA9IG5ldyBTZXQobGhzKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiByaHMpewogICAgICAgIHJ0LmFkZChpdGVtKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBzZXRJbnRlcnNlY3QobGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldCgpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIGxocyl7CiAgICAgICAgaWYgKHJocy5oYXMoaXRlbSkpIHJ0LmFkZChpdGVtKTsKICAgIH0KICAgIGZvciAoY29uc3QgaXRlbTEgb2YgcmhzKXsKICAgICAgICBpZiAobGhzLmhhcyhpdGVtMSkpIHJ0LmFkZChpdGVtMSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gc2V0RXF1YWwobGhzLCByaHMpIHsKICAgIHJldHVybiBsaHMuc2l6ZSA9PT0gcmhzLnNpemUgJiYgWwogICAgICAgIC4uLmxocwogICAgXS5ldmVyeSgodik9PnJocy5oYXModikKICAgICk7Cn0KZnVuY3Rpb24gcGFyc2VIZWFkZXJGaWx0ZXIoaGVhZGVyKSB7CiAgICBjb25zdCBpID0gaGVhZGVyLmluZGV4T2YoJzonKTsKICAgIGlmIChpIDwgMCkgcmV0dXJuIHsKICAgICAgICBrZXk6IGhlYWRlcgogICAgfTsKICAgIGNvbnN0IGtleSA9IGhlYWRlci5zdWJzdHJpbmcoMCwgaSkudHJpbSgpOwogICAgY29uc3QgcXVlcnkgPSBoZWFkZXIuc3Vic3RyaW5nKGkgKyAxKS50cmltKCk7CiAgICByZXR1cm4gewogICAgICAgIGtleSwKICAgICAgICBxdWVyeQogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyA9IG5ldyBTZXQoWwogICAgJ291dGNvbWUnLAogICAgJ3NjcmlwdE5hbWUnLAogICAgJ2V4Y2VwdGlvbnMnLAogICAgJ2xvZ3MnLAogICAgJ2V2ZW50VGltZXN0YW1wJywKICAgICdldmVudCcKXSk7CmNvbnN0IEtOT1dOX09VVENPTUVTID0gbmV3IFNldChbCiAgICAnb2snLAogICAgJ2V4Y2VwdGlvbicsCiAgICAnZXhjZWVkZWRDcHUnLAogICAgJ2NhbmNlbGVkJywKICAgICd1bmtub3duJwpdKTsKZnVuY3Rpb24gcGFyc2VUYWlsTWVzc2FnZShvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsTWVzc2FnZTogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBjaGVja0tleXMob2JqLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgb3V0Y29tZSAsIHNjcmlwdE5hbWUgLCBldmVudFRpbWVzdGFtcCAgfSA9IG9iakFzQW55OwogICAgaWYgKCFLTk9XTl9PVVRDT01FUy5oYXMob3V0Y29tZSkpIHRocm93IG5ldyBFcnJvcihgQmFkIG91dGNvbWU6IGV4cGVjdGVkIG9uZSBvZiBbJHtbCiAgICAgICAgLi4uS05PV05fT1VUQ09NRVMKICAgIF0uam9pbignLCAnKX1dLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG91dGNvbWUpfWApOwogICAgaWYgKHNjcmlwdE5hbWUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcihgQmFkIHNjcmlwdE5hbWU6IGV4cGVjdGVkIG51bGwsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoc2NyaXB0TmFtZSl9YCk7CiAgICBjb25zdCBsb2dzID0gcGFyc2VMb2dzKG9iakFzQW55LmxvZ3MpOwogICAgY29uc3QgZXhjZXB0aW9ucyA9IHBhcnNlRXhjZXB0aW9ucyhvYmpBc0FueS5leGNlcHRpb25zKTsKICAgIGlmICghKHR5cGVvZiBldmVudFRpbWVzdGFtcCA9PT0gJ251bWJlcicgJiYgZXZlbnRUaW1lc3RhbXAgPiAwKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgZXZlbnRUaW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShldmVudFRpbWVzdGFtcCl9YCk7CiAgICBjb25zdCBldmVudCA9IG9iakFzQW55LmV2ZW50ICYmIG9iakFzQW55LmV2ZW50LnJlcXVlc3QgPyBwYXJzZVRhaWxNZXNzYWdlUmVxdWVzdEV2ZW50KG9iakFzQW55LmV2ZW50KSA6IHBhcnNlVGFpbE1lc3NhZ2VDcm9uRXZlbnQob2JqQXNBbnkuZXZlbnQpOwogICAgcmV0dXJuIHsKICAgICAgICBvdXRjb21lLAogICAgICAgIHNjcmlwdE5hbWUsCiAgICAgICAgZXhjZXB0aW9ucywKICAgICAgICBsb2dzLAogICAgICAgIGV2ZW50VGltZXN0YW1wLAogICAgICAgIGV2ZW50CiAgICB9Owp9CmZ1bmN0aW9uIHBhcnNlTG9ncyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBsb2dzOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VMb2cpOwp9CmZ1bmN0aW9uIHBhcnNlRXhjZXB0aW9ucyhvYmopIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBleGNlcHRpb25zOiBleHBlY3RlZCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgcmV0dXJuIFsKICAgICAgICAuLi5vYmoKICAgIF0ubWFwKHBhcnNlVGFpbE1lc3NhZ2VFeGNlcHRpb24pOwp9CmZ1bmN0aW9uIGlzTG9nTWVzc2FnZVBhcnQodmFsdWUpIHsKICAgIGNvbnN0IHQgPSB0eXBlb2YgdmFsdWU7CiAgICByZXR1cm4gdCA9PT0gJ3N0cmluZycgfHwgdCA9PT0gJ251bWJlcicgfHwgdCA9PT0gJ2Jvb2xlYW4nIHx8IHQgPT09ICd1bmRlZmluZWQnIHx8IHQgPT09ICdvYmplY3QnOwp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyA9IG5ldyBTZXQoWwogICAgJ21lc3NhZ2UnLAogICAgJ2xldmVsJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlTG9nKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlTG9nOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9MT0dfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IG1lc3NhZ2UgPSBwYXJzZUxvZ01lc3NhZ2VQYXJ0QXJyYXkob2JqQXNBbnkubWVzc2FnZSwgJ21lc3NhZ2UnKTsKICAgIGNvbnN0IHsgbGV2ZWwgLCB0aW1lc3RhbXAgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBsZXZlbCA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBsZXZlbDogZXhwZWN0ZWQgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KGxldmVsKX1gKTsKICAgIGlmICghKHR5cGVvZiB0aW1lc3RhbXAgPT09ICdudW1iZXInICYmIHRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0aW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh0aW1lc3RhbXApfWApOwogICAgcmV0dXJuIHsKICAgICAgICBtZXNzYWdlLAogICAgICAgIGxldmVsLAogICAgICAgIHRpbWVzdGFtcAogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfRVhDRVBUSU9OX0tFWVMgPSBuZXcgU2V0KFsKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICd0aW1lc3RhbXAnCl0pOwpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlRXhjZXB0aW9uKG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlRXhjZXB0aW9uOiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FWENFUFRJT05fS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHsgbmFtZSAsIG1lc3NhZ2UgLCB0aW1lc3RhbXAgIH0gPSBvYmpBc0FueTsKICAgIGlmICghKHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG5hbWU6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShuYW1lKX1gKTsKICAgIGlmICghKHR5cGVvZiBtZXNzYWdlID09PSAnc3RyaW5nJykpIHRocm93IG5ldyBFcnJvcihgQmFkIG1lc3NhZ2U6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShtZXNzYWdlKX1gKTsKICAgIGlmICghKHR5cGVvZiB0aW1lc3RhbXAgPT09ICdudW1iZXInICYmIHRpbWVzdGFtcCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0aW1lc3RhbXA6IGV4cGVjdGVkIHBvc2l0aXZlIG51bWJlciwgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh0aW1lc3RhbXApfWApOwogICAgcmV0dXJuIHsKICAgICAgICBuYW1lLAogICAgICAgIG1lc3NhZ2UsCiAgICAgICAgdGltZXN0YW1wCiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMgPSBuZXcgU2V0KFsKICAgICdjcm9uJywKICAgICdzY2hlZHVsZWRUaW1lJwpdKTsKZnVuY3Rpb24gaXNUYWlsTWVzc2FnZUNyb25FdmVudChvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBrZXlzID0gbmV3IFNldChPYmplY3Qua2V5cyhvYmopKTsKICAgIHJldHVybiBzZXRFcXVhbChrZXlzLCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfQ1JPTl9FVkVOVF9LRVlTKTsKfQpmdW5jdGlvbiBwYXJzZVRhaWxNZXNzYWdlQ3JvbkV2ZW50KG9iaikgewogICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KG9iaikpIHRocm93IG5ldyBFcnJvcihgQmFkIHRhaWxNZXNzYWdlQ3JvbkV2ZW50OiBFeHBlY3RlZCBvYmplY3QsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIGNoZWNrS2V5cyhvYmosIFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9DUk9OX0VWRU5UX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCB7IGNyb24gLCBzY2hlZHVsZWRUaW1lICB9ID0gb2JqQXNBbnk7CiAgICBpZiAoISh0eXBlb2YgY3JvbiA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBjcm9uOiBleHBlY3RlZCBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoY3Jvbil9YCk7CiAgICBpZiAoISh0eXBlb2Ygc2NoZWR1bGVkVGltZSA9PT0gJ251bWJlcicgJiYgc2NoZWR1bGVkVGltZSA+IDApKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBzY2hlZHVsZWRUaW1lOiBleHBlY3RlZCBwb3NpdGl2ZSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoc2NoZWR1bGVkVGltZSl9YCk7CiAgICByZXR1cm4gewogICAgICAgIGNyb24sCiAgICAgICAgc2NoZWR1bGVkVGltZQogICAgfTsKfQpjb25zdCBSRVFVSVJFRF9UQUlMX01FU1NBR0VfUkVRVUVTVF9FVkVOVF9LRVlTID0gbmV3IFNldChbCiAgICAncmVxdWVzdCcKXSk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VSZXF1ZXN0RXZlbnQob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VSZXF1ZXN0RXZlbnQ6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX1JFUVVFU1RfRVZFTlRfS0VZUyk7CiAgICBjb25zdCBvYmpBc0FueSA9IG9iajsKICAgIGNvbnN0IHJlcXVlc3QgPSBwYXJzZVRhaWxNZXNzYWdlRXZlbnRSZXF1ZXN0KG9iakFzQW55LnJlcXVlc3QpOwogICAgcmV0dXJuIHsKICAgICAgICByZXF1ZXN0CiAgICB9Owp9CmNvbnN0IFJFUVVJUkVEX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBuZXcgU2V0KFsKICAgICd1cmwnLAogICAgJ21ldGhvZCcsCiAgICAnaGVhZGVycycKXSk7CmNvbnN0IE9QVElPTkFMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMgPSBuZXcgU2V0KFsKICAgICdjZicKXSk7CmNvbnN0IEFMTF9UQUlMX01FU1NBR0VfRVZFTlRfUkVRVUVTVF9LRVlTID0gc2V0VW5pb24oUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUywgT1BUSU9OQUxfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUyk7CmZ1bmN0aW9uIHBhcnNlVGFpbE1lc3NhZ2VFdmVudFJlcXVlc3Qob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdGFpbE1lc3NhZ2VFdmVudFJlcXVlc3Q6IEV4cGVjdGVkIG9iamVjdCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgY2hlY2tLZXlzKG9iaiwgUkVRVUlSRURfVEFJTF9NRVNTQUdFX0VWRU5UX1JFUVVFU1RfS0VZUywgQUxMX1RBSUxfTUVTU0FHRV9FVkVOVF9SRVFVRVNUX0tFWVMpOwogICAgY29uc3Qgb2JqQXNBbnkgPSBvYmo7CiAgICBjb25zdCB7IHVybCAsIG1ldGhvZCAgfSA9IG9iakFzQW55OwogICAgaWYgKCEodHlwZW9mIHVybCA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB1cmw6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeSh1cmwpfWApOwogICAgaWYgKCEodHlwZW9mIG1ldGhvZCA9PT0gJ3N0cmluZycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBtZXRob2Q6IGV4cGVjdGVkIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShtZXRob2QpfWApOwogICAgY29uc3QgaGVhZGVycyA9IHBhcnNlU3RyaW5nUmVjb3JkKG9iakFzQW55LmhlYWRlcnMsICdoZWFkZXJzJyk7CiAgICBjb25zdCBjZiA9IG9iakFzQW55LmNmID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBwYXJzZUluY29taW5nUmVxdWVzdENmUHJvcGVydGllcyhvYmpBc0FueS5jZik7CiAgICByZXR1cm4gewogICAgICAgIHVybCwKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVycywKICAgICAgICBjZgogICAgfTsKfQpmdW5jdGlvbiBjaGVja0tleXMob2JqLCByZXF1aXJlZEtleXMsIGFsbEtleXMpIHsKICAgIGNvbnN0IGtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKG9iaikpOwogICAgY29uc3QgbWlzc2luZ0tleXMgPSBzZXRTdWJ0cmFjdChyZXF1aXJlZEtleXMsIGtleXMpOwogICAgaWYgKG1pc3NpbmdLZXlzLnNpemUgPiAwKSB0aHJvdyBuZXcgRXJyb3IoYE1pc3Npbmcga2V5czogJHtbCiAgICAgICAgLi4ubWlzc2luZ0tleXMKICAgIF0uam9pbignLCAnKX1gKTsKICAgIGNvbnN0IGV4dHJhS2V5cyA9IHNldFN1YnRyYWN0KGtleXMsIGFsbEtleXMgfHwgcmVxdWlyZWRLZXlzKTsKICAgIGlmIChleHRyYUtleXMuc2l6ZSA+IDApIHRocm93IG5ldyBFcnJvcihgRXh0cmEga2V5czogJHtbCiAgICAgICAgLi4uZXh0cmFLZXlzCiAgICBdLmpvaW4oJywgJyl9YCk7Cn0KZnVuY3Rpb24gcGFyc2VTdHJpbmdSZWNvcmQob2JqLCBuYW1lKSB7CiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogRXhwZWN0ZWQgc3RyaW5nIHJlY29yZCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgZm9yIChjb25zdCBbXywgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBzdHJpbmcgcmVjb3JkLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICB9CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIHBhcnNlTG9nTWVzc2FnZVBhcnRBcnJheShvYmosIG5hbWUpIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCAhQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiBFeHBlY3RlZCBsb2cgbWVzc2FnZSBwYXJ0IGFycmF5LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIG9iail7CiAgICAgICAgaWYgKCFpc0xvZ01lc3NhZ2VQYXJ0KHZhbHVlKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogRXhwZWN0ZWQgbG9nIG1lc3NhZ2UgcGFydCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgfQogICAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBwYXJzZUluY29taW5nUmVxdWVzdENmUHJvcGVydGllcyhvYmopIHsKICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShvYmopKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBjZjogRXhwZWN0ZWQgb2JqZWN0LCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIGR1bXBNZXNzYWdlUHJldHR5KG1lc3NhZ2UsIGxvZ2dlciwgYWRkaXRpb25hbExvZ3MgPSBbXSkgewogICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUobWVzc2FnZS5ldmVudFRpbWVzdGFtcCkpOwogICAgY29uc3Qgb3V0Y29tZSA9IFBSRVRUWV9PVVRDT01FUy5nZXQobWVzc2FnZS5vdXRjb21lKSB8fCBtZXNzYWdlLm91dGNvbWU7CiAgICBjb25zdCBvdXRjb21lQ29sb3IgPSBtZXNzYWdlLm91dGNvbWUgPT09ICdvaycgPyAnZ3JlZW4nIDogJ3JlZCc7CiAgICBjb25zdCB7IHByb3BzICwgcmVtYWluaW5nTG9ncyAgfSA9IHBhcnNlTG9nUHJvcHMobWVzc2FnZS5sb2dzKTsKICAgIGlmIChpc1RhaWxNZXNzYWdlQ3JvbkV2ZW50KG1lc3NhZ2UuZXZlbnQpKSB7CiAgICAgICAgY29uc3QgY29sbyA9IHByb3BzLmNvbG8gfHwgJz8/Pyc7CiAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSAlYyR7bWVzc2FnZS5ldmVudC5jcm9ufWAsICdjb2xvcjogZ3JheScsICcnLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke291dGNvbWVDb2xvcn1gLCAnJywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHsgbWV0aG9kICwgdXJsICwgY2YgIH0gPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3Q7CiAgICAgICAgY29uc3QgY29sbyA9IGNmPy5jb2xvIHx8IHByb3BzLmNvbG8gfHwgJz8/Pyc7CiAgICAgICAgaWYgKGNmID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29uc3QgeyBkdXJhYmxlT2JqZWN0Q2xhc3MgLCBkdXJhYmxlT2JqZWN0TmFtZSAsIGR1cmFibGVPYmplY3RJZCAgfSA9IGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcyk7CiAgICAgICAgICAgIGNvbnN0IGRvVGVtcGxhdGVzID0gW107CiAgICAgICAgICAgIGNvbnN0IGRvU3R5bGVzID0gW107CiAgICAgICAgICAgIGlmIChkdXJhYmxlT2JqZWN0Q2xhc3MpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0Q2xhc3N9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWNsYXNzOiAnJHtkdXJhYmxlT2JqZWN0Q2xhc3N9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGRvVGVtcGxhdGVzLnB1c2goYCVjJHtkdXJhYmxlT2JqZWN0TmFtZX0lY2ApOwogICAgICAgICAgICAgICAgZG9TdHlsZXMucHVzaChgY29sb3I6IGdyYXk7IHgtZHVyYWJsZS1vYmplY3QtbmFtZTogJyR7ZHVyYWJsZU9iamVjdE5hbWV9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHVyYWJsZU9iamVjdElkKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlYyR7Y29tcHV0ZVNob3J0RHVyYWJsZU9iamVjdElkKGR1cmFibGVPYmplY3RJZCl9JWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goYGNvbG9yOiBncmF5OyB4LWR1cmFibGUtb2JqZWN0LWlkOiAnJHtkdXJhYmxlT2JqZWN0SWR9J2AsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZG9UZW1wbGF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBkb1RlbXBsYXRlcy5wdXNoKGAlY0RPJWNgKTsKICAgICAgICAgICAgICAgIGRvU3R5bGVzLnB1c2goJ2NvbG9yOiBncmF5JywgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvZ2dlcihgWyVjJHt0aW1lfSVjXSBbJWMke2NvbG99JWNdIFslYyR7b3V0Y29tZX0lY10gWyR7ZG9UZW1wbGF0ZXMuam9pbignICcpfV0gJHttZXRob2R9ICVjJHt1cmx9YCwgJ2NvbG9yOiBncmF5JywgJycsICdjb2xvcjogZ3JheScsICcnLCBgY29sb3I6ICR7b3V0Y29tZUNvbG9yfWAsICcnLCAuLi5kb1N0eWxlcywgJ2NvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGQ7Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9nZ2VyKGBbJWMke3RpbWV9JWNdIFslYyR7Y29sb30lY10gWyVjJHtvdXRjb21lfSVjXSAke21ldGhvZH0gJWMke3VybH1gLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5JywgJycsIGBjb2xvcjogJHtvdXRjb21lQ29sb3J9YCwgJycsICdjb2xvcjogcmVkOyBmb250LXN0eWxlOiBib2xkOycpOwogICAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgeyBkYXRhICB9IG9mIGFkZGl0aW9uYWxMb2dzKXsKICAgICAgICBsb2dnZXIoLi4uZGF0YSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsgbGV2ZWwgLCBtZXNzYWdlOiBsb2dNZXNzYWdlICB9IG9mIHJlbWFpbmluZ0xvZ3MpewogICAgICAgIGNvbnN0IGxldmVsQ29sb3IgPSBMT0dfTEVWRUxfQ09MT1JTLmdldChsZXZlbCkgfHwgJ2dyYXknOwogICAgICAgIGNvbnN0IGxvZ01lc3NhZ2VzID0gbG9nTWVzc2FnZS5tYXAoZm9ybWF0TG9nTWVzc2FnZVBhcnQpLmpvaW4oJywgJyk7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtsZXZlbH0lY10gJHtsb2dNZXNzYWdlc31gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiAke2xldmVsQ29sb3J9YCwgJycpOwogICAgfQogICAgZm9yIChjb25zdCB7IG5hbWUgLCBtZXNzYWdlOiBleGNlcHRpb25NZXNzYWdlICB9IG9mIG1lc3NhZ2UuZXhjZXB0aW9ucyl7CiAgICAgICAgbG9nZ2VyKGAgJWN8JWMgWyVjJHtuYW1lfSVjXSAlYyR7ZXhjZXB0aW9uTWVzc2FnZX1gLCAnY29sb3I6IGdyYXknLCAnJywgYGNvbG9yOiByZWQ7IGZvbnQtc3R5bGU6IGJvbGRgLCAnJywgJ2NvbG9yOiByZWQnKTsKICAgIH0KfQpmdW5jdGlvbiBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKGRhdGUpIHsKICAgIHJldHVybiBbCiAgICAgICAgZGF0ZS5nZXRGdWxsWWVhcigpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0TW9udGgoKSArIDEpLAogICAgICAgICctJywKICAgICAgICBwYWQyKGRhdGUuZ2V0RGF0ZSgpKSwKICAgICAgICAnICcsCiAgICAgICAgcGFkMihkYXRlLmdldEhvdXJzKCkpLAogICAgICAgICc6JywKICAgICAgICBwYWQyKGRhdGUuZ2V0TWludXRlcygpKSwKICAgICAgICAnOicsCiAgICAgICAgcGFkMihkYXRlLmdldFNlY29uZHMoKSkKICAgIF0uam9pbignJyk7Cn0KZnVuY3Rpb24gcGFyc2VMb2dQcm9wcyhsb2dzKSB7CiAgICBjb25zdCByZW1haW5pbmdMb2dzID0gW107CiAgICBjb25zdCBwcm9wcyA9IHsKICAgIH07CiAgICBmb3IgKGNvbnN0IGxvZyBvZiBsb2dzKXsKICAgICAgICBpZiAobG9nLm1lc3NhZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBtc2cgPSBsb2cubWVzc2FnZVswXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnICYmIG1zZy5zdGFydHNXaXRoKCdsb2dwcm9wczonKSkgewogICAgICAgICAgICAgICAgY29uc3QgdHJhaWxlciA9IG1zZy5zdWJzdHJpbmcobXNnLmluZGV4T2YoJzonKSArIDEpOwogICAgICAgICAgICAgICAgY29uc3QgdHJhaWxlclByb3BzID0gdHJ5UGFyc2VQcm9wc0Zyb21Kc29uKHRyYWlsZXIpOwogICAgICAgICAgICAgICAgYXBwZW5kUHJvcHModHJhaWxlclByb3BzLCBwcm9wcyk7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgbG9nLm1lc3NhZ2Uuc2xpY2UoMSkpewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRQcm9wcyA9IHRyeVBhcnNlUHJvcHNGcm9tUGFydChwYXJ0KTsKICAgICAgICAgICAgICAgICAgICBhcHBlbmRQcm9wcyhwYXJ0UHJvcHMsIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlbWFpbmluZ0xvZ3MucHVzaChsb2cpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBwcm9wcywKICAgICAgICByZW1haW5pbmdMb2dzCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVEdXJhYmxlT2JqZWN0SW5mbyhwcm9wcykgewogICAgY29uc3QgZHVyYWJsZU9iamVjdENsYXNzID0gdW5kZWZpbmVkSWZFbXB0eSgodHlwZW9mIHByb3BzLmR1cmFibGVPYmplY3RDbGFzcyA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0Q2xhc3MgOiAnJykudHJpbSgpKTsKICAgIGNvbnN0IGR1cmFibGVPYmplY3RJZCA9IHVuZGVmaW5lZElmRW1wdHkoKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0SWQgPT09ICdzdHJpbmcnID8gcHJvcHMuZHVyYWJsZU9iamVjdElkIDogJycpLnRyaW0oKSk7CiAgICBjb25zdCBkdXJhYmxlT2JqZWN0TmFtZSA9IHVuZGVmaW5lZElmRW1wdHkoKHR5cGVvZiBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA9PT0gJ3N0cmluZycgPyBwcm9wcy5kdXJhYmxlT2JqZWN0TmFtZSA6ICcnKS50cmltKCkpOwogICAgcmV0dXJuIHsKICAgICAgICBkdXJhYmxlT2JqZWN0Q2xhc3MsCiAgICAgICAgZHVyYWJsZU9iamVjdElkLAogICAgICAgIGR1cmFibGVPYmplY3ROYW1lCiAgICB9Owp9CmZ1bmN0aW9uIHVuZGVmaW5lZElmRW1wdHkoc3RyKSB7CiAgICByZXR1cm4gc3RyID09PSAnJyA/IHVuZGVmaW5lZCA6IHN0cjsKfQpmdW5jdGlvbiBjb21wdXRlU2hvcnREdXJhYmxlT2JqZWN0SWQoaWQpIHsKICAgIHJldHVybiAvXlswLTlhLWZBLUZdezUsfSQvLnRlc3QoaWQpID8gYCR7aWQuc3Vic3RyaW5nKDAsIDQpfeKApmAgOiBpZDsKfQpmdW5jdGlvbiBhcHBlbmRQcm9wcyhzcmMsIGRzdCkgewogICAgaWYgKHNyYykgewogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNyYykpewogICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiB0cnlQYXJzZVByb3BzRnJvbUpzb24odmFsdWUpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgcHJvcHMgPSBKU09OLnBhcnNlKHZhbHVlLnRyaW0oKSk7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wcyA9PT0gJ29iamVjdCcgJiYgcHJvcHMgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wczsKICAgICAgICB9CiAgICB9IGNhdGNoICB7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHRyeVBhcnNlUHJvcHNGcm9tUGFydChwYXJ0KSB7CiAgICB0cnkgewogICAgICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcgJiYgcGFydCAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheShwYXJ0KSkgewogICAgICAgICAgICByZXR1cm4gcGFydDsKICAgICAgICB9CiAgICB9IGNhdGNoICB7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGZvcm1hdExvZ01lc3NhZ2VQYXJ0KHBhcnQpIHsKICAgIGlmICh0eXBlb2YgcGFydCA9PT0gJ29iamVjdCcpIHJldHVybiBKU09OLnN0cmluZ2lmeShwYXJ0KTsKICAgIHJldHVybiBgJHtwYXJ0fWA7Cn0KZnVuY3Rpb24gcGFkMihudW0pIHsKICAgIHJldHVybiBudW0udG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpOwp9CmNvbnN0IFBSRVRUWV9PVVRDT01FUyA9IG5ldyBNYXAoWwogICAgWwogICAgICAgICdvaycsCiAgICAgICAgJ09rJwogICAgXSwKICAgIFsKICAgICAgICAnZXhjZXB0aW9uJywKICAgICAgICAnRXJyb3InCiAgICBdLAogICAgWwogICAgICAgICdleGNlZWRlZENwdScsCiAgICAgICAgJ0V4Y2VlZGVkIExpbWl0JwogICAgXSwKICAgIFsKICAgICAgICAnY2FuY2VsZWQnLAogICAgICAgICdDYW5jZWxlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ3Vua25vd24nLAogICAgICAgICdVbmtub3duJwogICAgXSwgCl0pOwpjb25zdCBMT0dfTEVWRUxfQ09MT1JTID0gbmV3IE1hcChbCiAgICBbCiAgICAgICAgJ3RyYWNlJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2RlYnVnJywKICAgICAgICAncHVycGxlJwogICAgXSwKICAgIFsKICAgICAgICAnbG9nJywKICAgICAgICAnZ3JheScKICAgIF0sCiAgICBbCiAgICAgICAgJ2luZm8nLAogICAgICAgICdncmF5JwogICAgXSwKICAgIFsKICAgICAgICAnd2FybicsCiAgICAgICAgJ3JlZCcKICAgIF0sCiAgICBbCiAgICAgICAgJ2Vycm9yJywKICAgICAgICAncmVkJwogICAgXSwgCl0pOwpjbGFzcyBUYWlsQ29ubmVjdGlvbiB7CiAgICBzdGF0aWMgVkVSQk9TRSA9IGZhbHNlOwogICAgd3M7CiAgICBjYWxsYmFja3M7CiAgICBvcHRpb25zOwogICAgaGVhcnRiZWF0SWQ7CiAgICBjb25zdHJ1Y3Rvcih3ZWJTb2NrZXRVcmwsIGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQod2ViU29ja2V0VXJsLCAndHJhY2UtdjEnKTsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICBjb25zdCB7IHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgIH0gPSBvcHRzOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignb3BlbicsIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgdGhpcy5zZW5kT3B0aW9uc0lmT3BlbigpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uT3BlbikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uT3Blbih0aGlzLCB0aW1lU3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzID4gMCkgewogICAgICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksIGBzZW5kaW5nIHdzIHBpbmcge30gZXZlcnkgJHt3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzfWApOwogICAgICAgICAgICAgICAgdGhpcy5oZWFydGJlYXRJZCA9IHNldEludGVydmFsKCgpPT57CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMud3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksIGBzZW5kaW5nIHdzIHBpbmcge31gKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53cy5zZW5kKCd7fScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgKiAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignY2xvc2UnLCAoZXZlbnQpPT57CiAgICAgICAgICAgIGNvbnN0IHsgY29kZSAsIHJlYXNvbiAsIHdhc0NsZWFuICwgdGltZVN0YW1wICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGlmIChUYWlsQ29ubmVjdGlvbi5WRVJCT1NFKSBjb25zb2xlLmxvZyhmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpLCAnVGFpbENvbm5lY3Rpb246IHdzIGNsb3NlJywgewogICAgICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgICAgIHdhc0NsZWFuLAogICAgICAgICAgICAgICAgdGltZVN0YW1wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0SWQpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uQ2xvc2UpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbkNsb3NlKHRoaXMsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLndzLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgKGV2ZW50KT0+ewogICAgICAgICAgICBjb25zdCB7IHRpbWVTdGFtcCAgfSA9IGV2ZW50OwogICAgICAgICAgICBjb25zdCBlcnJvckluZm8gPSBjb21wdXRlRXJyb3JJbmZvKGV2ZW50KTsKICAgICAgICAgICAgaWYgKFRhaWxDb25uZWN0aW9uLlZFUkJPU0UpIGNvbnNvbGUubG9nKGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSksICdUYWlsQ29ubmVjdGlvbjogd3MgZXJyb3InLCBlcnJvckluZm8pOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbkVycm9yKHRoaXMsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMud3MuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGFzeW5jIChldmVudCk9PnsKICAgICAgICAgICAgY29uc3QgeyB0aW1lU3RhbXAgIH0gPSBldmVudDsKICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEgaW5zdGFuY2VvZiBCbG9iKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgZXZlbnQuZGF0YS50ZXh0KCk7CiAgICAgICAgICAgICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKHRleHQpOwogICAgICAgICAgICAgICAgbGV0IG1lc3NhZ2U7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBwYXJzZVRhaWxNZXNzYWdlKG9iaik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVW5wYXJzZWRNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgb2JqLCBlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsTWVzc2FnZSh0aGlzLCB0aW1lU3RhbXAsIG1lc3NhZ2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVW5wYXJzZWRNZXNzYWdlKHRoaXMsIHRpbWVTdGFtcCwgZXZlbnQuZGF0YSwgbmV3IEVycm9yKGBFeHBlY3RlZCBldmVudC5kYXRhIHRvIGJlIEJsb2JgKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIHNldE9wdGlvbnMob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgdGhpcy5zZW5kT3B0aW9uc0lmT3BlbigpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2xvc2UoY29kZSwgcmVhc29uKSB7CiAgICAgICAgdGhpcy53cy5jbG9zZShjb2RlLCByZWFzb24pOwogICAgfQogICAgc2VuZE9wdGlvbnNJZk9wZW4oKSB7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucyAmJiB0aGlzLndzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7CiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICBpZiAoVGFpbENvbm5lY3Rpb24uVkVSQk9TRSkgY29uc29sZS5sb2coYHNlbmRPcHRpb25zSWZPcGVuOiBzZW5kaW5nICR7cGF5bG9hZH1gKTsKICAgICAgICAgICAgdGhpcy53cy5zZW5kKHBheWxvYWQpOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlRXJyb3JJbmZvKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ2Vycm9yJykgewogICAgICAgIGNvbnN0IHsgbWVzc2FnZSAsIGZpbGVuYW1lICwgbGluZW5vICwgY29sbm8gLCBlcnJvciAgfSA9IGV2ZW50OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgIGZpbGVuYW1lLAogICAgICAgICAgICBsaW5lbm8sCiAgICAgICAgICAgIGNvbG5vLAogICAgICAgICAgICBlcnJvcgogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGdlbmVyYXRlVXVpZCgpIHsKICAgIGNvbnN0IGNyeXB0b0FzQW55ID0gY3J5cHRvOwogICAgaWYgKHR5cGVvZiBjcnlwdG9Bc0FueS5yYW5kb21VVUlEID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGNyeXB0b0FzQW55LnJhbmRvbVVVSUQoKTsKICAgIH0KICAgIGNvbnN0IHJuZHMgPSBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKG5ldyBVaW50OEFycmF5KDE2KSk7CiAgICBybmRzWzZdID0gcm5kc1s2XSAmIDE1IHwgNjQ7CiAgICBybmRzWzhdID0gcm5kc1s4XSAmIDYzIHwgMTI4OwogICAgcmV0dXJuIGJ5dGVzVG9VdWlkKHJuZHMpOwp9CmZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ5dGVzKSB7CiAgICBjb25zdCBiaXRzID0gWwogICAgICAgIC4uLmJ5dGVzCiAgICBdLm1hcCgoYml0KT0+ewogICAgICAgIGNvbnN0IHMgPSBiaXQudG9TdHJpbmcoMTYpOwogICAgICAgIHJldHVybiBiaXQgPCAxNiA/ICIwIiArIHMgOiBzOwogICAgfSk7CiAgICByZXR1cm4gWwogICAgICAgIC4uLmJpdHMuc2xpY2UoMCwgNCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoNCwgNiksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoNiwgOCksCiAgICAgICAgIi0iLAogICAgICAgIC4uLmJpdHMuc2xpY2UoOCwgMTApLAogICAgICAgICItIiwKICAgICAgICAuLi5iaXRzLnNsaWNlKDEwLCAxNiksIAogICAgXS5qb2luKCIiKTsKfQpjbGFzcyBNYXRlcmlhbCB7CiAgICBzdGF0aWMgaGlnaEVtcGhhc2lzVGV4dENvbG9yID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC44NyknOwogICAgc3RhdGljIG1lZGl1bUVtcGhhc2lzVGV4dENvbG9yID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC42MCknOwp9CmNvbnN0IE1BVEVSSUFMX0NTUyA9IGNzc2AKCjpyb290IHsKICAtLXN1cmZhY2UtMDEtYmFja2dyb3VuZC1jb2xvcjogcmdiKDMwLjc1LCAzMC43NSwgMzAuNzUpOwogIC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yOiByZ2IoNDAuOTUsIDQwLjk1LCA0MC45NSk7CiAgLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC44Nyk7CiAgLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKTsKICAtLWRpc2FibGVkLXRleHQtY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4zOCk7CiAgLS1idXR0b24tYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICAtLXByaW1hcnktY29sb3I6ICNiYjg2ZmM7CiAgLS1iYWNrZ3JvdW5kLWNvbG9yOiAjMTIxMjEyOwogIC0tc2Fucy1zZXJpZi1mb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCBhdmVuaXIgbmV4dCwgYXZlbmlyLCBoZWx2ZXRpY2EgbmV1ZSwgaGVsdmV0aWNhLCBVYnVudHUsIHJvYm90bywgbm90bywgc2Vnb2UgdWksIGFyaWFsLCBzYW5zLXNlcmlmOwogIC0tbW9ub3NwYWNlLWZvbnQtZmFtaWx5OiBNZW5sbywgQ29uc29sYXMsIHVpLW1vbm9zcGFjZSwgbW9ub3NwYWNlOwp9CgovKiogdGV4dCBzaXplIGNsYXNzZXMgKi8KCi5oNiB7CiAgICBmb250LXNpemU6IDEuMjVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMDc1MHJlbTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkZXI7Cn0KCi5ib2R5MiwgZmllbGRzZXQgbGFiZWwsIGZpZWxkc2V0IG91dHB1dCwgZmllbGRzZXQgZGV0YWlscyB7CiAgICBmb250LXNpemU6IDAuODc1cmVtOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDE3ODZyZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwogICAgbGluZS1oZWlnaHQ6IDEuMjVyZW07Cn0KCi5idXR0b24sIGJ1dHRvbiwgLmFjdGlvbi1pY29uIHsKICAgIGZvbnQtc2l6ZTogMC44NzVyZW07CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMDg5MjlyZW07CiAgICBmb250LXdlaWdodDogYm9sZGVyOwp9Cgoub3ZlcmxpbmUsIHRoIHsKICAgIGZvbnQtc2l6ZTogMC42MjVyZW07CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuMTUwMDByZW07CiAgICBmb250LXdlaWdodDogbm9ybWFsOwp9CgouY2FwdGlvbiB7CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBsZXR0ZXItc3BhY2luZzogMC4wMzMzM3JlbTsKICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7Cn0KCi8qIGxpZ2h0IHRleHQgb24gZGFyayBiYWNrZ3JvdW5kIGNvbG9ycyAqLwoKLmhpZ2gtZW1waGFzaXMtdGV4dCB7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKLm1lZGl1bS1lbXBoYXNpcy10ZXh0LCBmaWVsZHNldCBsYWJlbCwgdGggewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKLmRpc2FibGVkLWVtcGhhc2lzLXRleHQgewogICAgY29sb3I6IHZhcigtLWRpc2FibGVkLXRleHQtY29sb3IpOwp9CgovKiogZWxldmF0aW9uIGJhY2tncm91bmRzICovCgouc3VyZmFjZS0wMSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwp9Cgouc3VyZmFjZS0wNCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTA0LWJhY2tncm91bmQtY29sb3IpOwp9CgovKiogYWN0aW9uLWljb24gKi8KCi5hY3Rpb24taWNvbiB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgbWluLWhlaWdodDogMnJlbTsKICAgIG1pbi13aWR0aDogMnJlbTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwogICAgb3BhY2l0eTogMC42OTsgIC8qKiBtZWRpdW0tZW1waGFzaXMgLyBoaWdoLWVtcGhhc2lzICovCiAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKfQoKQG1lZGlhIChob3ZlcjogaG92ZXIpIHsKICAgIC5hY3Rpb24taWNvbjpob3ZlciB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgICAgICBvcGFjaXR5OiAxOwogICAgfQp9CgovKiogYnV0dG9uICovCgpidXR0b24gewogICAgYm9yZGVyOiBub25lOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgbWluLXdpZHRoOiA4cmVtOwogICAgYm9yZGVyLXJhZGl1czogdmFyKC0tYnV0dG9uLWJvcmRlci1yYWRpdXMpOwp9CgpidXR0b24uc2VsZWN0ZWQgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wNC1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIGNvbG9yOiB2YXIoLS1oaWdoLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgpAbWVkaWEgKGhvdmVyKSB7CiAgICBidXR0b246aG92ZXIgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXN1cmZhY2UtMDQtYmFja2dyb3VuZC1jb2xvcik7CiAgICAgICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICB9Cn0KCmJ1dHRvbjpkaXNhYmxlZCB7CiAgICBjb2xvcjogdmFyKC0tZGlzYWJsZWQtdGV4dC1jb2xvcik7Cn0KCkBtZWRpYSAoaG92ZXIpIHsKICAgIGJ1dHRvbjpkaXNhYmxlZDpob3ZlciB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tc3VyZmFjZS0wMS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgICAgICBjdXJzb3I6IGRlZmF1bHQ7CiAgICB9Cn0KCi8qKiBhbmNob3JzICovCgphIHsKICAgIGNvbG9yOiB2YXIoLS1wcmltYXJ5LWNvbG9yKTsKICAgIHRleHQtdW5kZXJsaW5lLW9mZnNldDogMC4ycmVtOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgYTpob3ZlciB7CiAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7CiAgICB9Cn0KCi8qKiBmb3JtcyAqLwoKZmllbGRzZXQgewogICAgYm9yZGVyOiBzb2xpZCAxcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYwKTsKICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLWJ1dHRvbi1ib3JkZXItcmFkaXVzKTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXJvdy1nYXA6IDFyZW07CiAgICBncmlkLWNvbHVtbi1nYXA6IDFyZW07CiAgICBwYWRkaW5nOiAxcmVtOwp9CgpsYWJlbCB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIHBhZGRpbmc6IDAuNXJlbSAwOwp9CgouZm9ybS1saHMgewogICAgZ3JpZC1jb2x1bW46IDE7Cn0KCmlucHV0LCAuZm9ybS1yaHMgewogICAgZ3JpZC1jb2x1bW46IDI7CiAgICBtaW4td2lkdGg6IDA7Cn0KCi5mb3JtLXJvdyB7CiAgICBncmlkLWNvbHVtbjogMSAvIHNwYW4gMjsKfQoKZmllbGRzZXQgaW5wdXRbdHlwZT10ZXh0XSB7CiAgICBwYWRkaW5nOiAwLjVyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1zdXJmYWNlLTAxLWJhY2tncm91bmQtY29sb3IpOwogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXI6IHNvbGlkIDFweCB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1idXR0b24tYm9yZGVyLXJhZGl1cyk7Cn0KCmZpZWxkc2V0IG91dHB1dCB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKICAgIGNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCmZpZWxkc2V0IGRldGFpbHMgewogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKfQoKYDsKY29uc3QgSEVBREVSX0hUTUwgPSBodG1sYAo8aGVhZGVyIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQiPgogICAgPGRpdiBpZD0iaGVhZGVyLWNvbnRlbnQiPgogICAgICAgIFdlYnRhaWwKICAgICAgICA8c3BhbiBpZD0iaGVhZGVyLXZlcnNpb24iIGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCI+PC9zcGFuPgogICAgICAgIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayIgaWQ9ImdpdGh1Yi1sb2dvLWFuY2hvciI+PGltZyBpZD0iZ2l0aHViLWxvZ28iPjwvYT4KICAgIDwvZGl2Pgo8L2hlYWRlcj4KYDsKY29uc3QgSEVBREVSX0NTUyA9IGNzc2AKaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBwYWRkaW5nOiAxcmVtIDA7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsgLXdlYmtpdC11c2VyLXNlbGVjdDogbm9uZTsKfQoKI2hlYWRlci1jb250ZW50IHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogYmFzZWxpbmU7CiAgICBwYWRkaW5nLXJpZ2h0OiAyLjJyZW07Cn0KCiNoZWFkZXItdmVyc2lvbiB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNnaXRodWItbG9nby1hbmNob3IgewogICAgbGluZS1oZWlnaHQ6IDA7CiAgICBvcGFjaXR5OiAwLjU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICAjZ2l0aHViLWxvZ28tYW5jaG9yOmhvdmVyIHsKICAgICAgICBvcGFjaXR5OiAwLjc1OwogICAgfQp9CgojZ2l0aHViLWxvZ28gewogICAgd2lkdGg6IDFyZW07CiAgICBtYXJnaW4tYm90dG9tOiAtMC4xcmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0SGVhZGVyKGRvY3VtZW50LCB2bSwgZGF0YSkgewogICAgY29uc3QgaGVhZGVyQ29udGVudEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGVhZGVyLWNvbnRlbnQnKTsKICAgIGlmICgoZGF0YS5mbGFncyB8fCAnJykuaW5jbHVkZXMoJ2RlbW8tdG9nZ2xlJykpIHsKICAgICAgICBoZWFkZXJDb250ZW50RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdkYmxjbGljaycsIChlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZtLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBoZWFkZXJWZXJzaW9uU3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFkZXItdmVyc2lvbicpOwogICAgY29uc3QgeyB2ZXJzaW9uICB9ID0gZGF0YTsKICAgIGhlYWRlclZlcnNpb25TcGFuLnRleHRDb250ZW50ID0gdmVyc2lvbiA/IGB2JHt2ZXJzaW9ufWAgOiAnJzsKICAgIGNvbnN0IGdpdGh1YkxvZ29JbWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2l0aHViLWxvZ28nKTsKICAgIGdpdGh1YkxvZ29JbWcuc3JjID0gY29tcHV0ZUdpdGh1YkxvZ29EYXRhVXJsKCk7CiAgICByZXR1cm4gKCk9PnsKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUdpdGh1YkxvZ29EYXRhVXJsKCkgewogICAgY29uc3Qgc3ZnID0gR0lUSFVCX0xPR08ucmVwbGFjZSgnZmlsbDp3aGl0ZTsnLCBgZmlsbDoke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn07YCk7CiAgICByZXR1cm4gJ2RhdGE6aW1hZ2Uvc3ZnK3htbDt1dGY4LCcgKyBzdmc7Cn0KY29uc3QgR0lUSFVCX0xPR08gPSBgPHN2ZyB3aWR0aD0iYXV0byIgaGVpZ2h0PSJhdXRvIiB2aWV3Qm94PSIwIDAgMTM2IDEzMyIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxuczpzZXJpZj0iaHR0cDovL3d3dy5zZXJpZi5jb20vIiBzdHlsZT0iZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjI7Ij4KPGcgdHJhbnNmb3JtPSJtYXRyaXgoNC4xNjY2NywwLDAsNC4xNjY2NywtNTY4LC0xMzgxLjA2KSI+CiAgICA8cGF0aCBkPSJNMTUyLjYwOCwzMzEuNDU1QzE0My42MTQsMzMxLjQ1NSAxMzYuMzIsMzM4Ljc0OCAxMzYuMzIsMzQ3Ljc0NUMxMzYuMzIsMzU0Ljk0MiAxNDAuOTg3LDM2MS4wNDcgMTQ3LjQ2LDM2My4yMDFDMTQ4LjI3NSwzNjMuMzUxIDE0OC41NzIsMzYyLjg0OCAxNDguNTcyLDM2Mi40MTZDMTQ4LjU3MiwzNjIuMDI5IDE0OC41NTgsMzYxLjAwNSAxNDguNTUsMzU5LjY0NkMxNDQuMDE5LDM2MC42MyAxNDMuMDYzLDM1Ny40NjIgMTQzLjA2MywzNTcuNDYyQzE0Mi4zMjIsMzU1LjU4IDE0MS4yNTQsMzU1LjA3OSAxNDEuMjU0LDM1NS4wNzlDMTM5Ljc3NSwzNTQuMDY5IDE0MS4zNjYsMzU0LjA4OSAxNDEuMzY2LDM1NC4wODlDMTQzLjAwMSwzNTQuMjA0IDE0My44NjEsMzU1Ljc2OCAxNDMuODYxLDM1NS43NjhDMTQ1LjMxNCwzNTguMjU3IDE0Ny42NzQsMzU3LjUzOCAxNDguNjAyLDM1Ny4xMjFDMTQ4Ljc1LDM1Ni4wNjkgMTQ5LjE3MSwzNTUuMzUxIDE0OS42MzYsMzU0Ljk0NEMxNDYuMDE5LDM1NC41MzMgMTQyLjIxNiwzNTMuMTM1IDE0Mi4yMTYsMzQ2Ljg5M0MxNDIuMjE2LDM0NS4xMTUgMTQyLjg1MSwzNDMuNjYgMTQzLjg5MywzNDIuNTIyQzE0My43MjUsMzQyLjExIDE0My4xNjYsMzQwLjQ1MyAxNDQuMDUzLDMzOC4yMTFDMTQ0LjA1MywzMzguMjExIDE0NS40MiwzMzcuNzczIDE0OC41MzIsMzM5Ljg4MUMxNDkuODMxLDMzOS41MTkgMTUxLjIyNSwzMzkuMzM5IDE1Mi42MSwzMzkuMzMyQzE1My45OTQsMzM5LjMzOSAxNTUuMzg3LDMzOS41MTkgMTU2LjY4OCwzMzkuODgxQzE1OS43OTgsMzM3Ljc3MyAxNjEuMTYzLDMzOC4yMTEgMTYxLjE2MywzMzguMjExQzE2Mi4wNTIsMzQwLjQ1MyAxNjEuNDkzLDM0Mi4xMSAxNjEuMzI2LDM0Mi41MjJDMTYyLjM3LDM0My42NiAxNjMsMzQ1LjExNSAxNjMsMzQ2Ljg5M0MxNjMsMzUzLjE1MSAxNTkuMTkxLDM1NC41MjggMTU1LjU2MywzNTQuOTMxQzE1Ni4xNDcsMzU1LjQzNCAxNTYuNjY4LDM1Ni40MjggMTU2LjY2OCwzNTcuOTQ3QzE1Ni42NjgsMzYwLjEyNSAxNTYuNjQ4LDM2MS44ODIgMTU2LjY0OCwzNjIuNDE2QzE1Ni42NDgsMzYyLjg1MiAxNTYuOTQyLDM2My4zNTkgMTU3Ljc2OCwzNjMuMkMxNjQuMjM2LDM2MS4wNDEgMTY4Ljg5OSwzNTQuOTQgMTY4Ljg5OSwzNDcuNzQ1QzE2OC44OTksMzM4Ljc0OCAxNjEuNjA1LDMzMS40NTUgMTUyLjYwOCwzMzEuNDU1WiIgc3R5bGU9ImZpbGw6d2hpdGU7Ii8+CjwvZz4KPC9zdmc+YDsKZnVuY3Rpb24gYWN0aW9uSWNvbihpY29uLCBvcHRzID0gewp9KSB7CiAgICBjb25zdCB7IHRleHQgLCBvbmNsaWNrICB9ID0gb3B0czsKICAgIHJldHVybiBodG1sYDxkaXYgY2xhc3M9ImFjdGlvbi1pY29uIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgb25jbGljayAmJiBvbmNsaWNrKCk7CiAgICB9fT4ke2ljb259JHt0ZXh0IHx8ICcnfTwvZGl2PmA7Cn0KY29uc3QgQ0xFQVJfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTUgMTNoMTR2LTJINXYyem0tMiA0aDE0di0ySDN2MnpNNyA3djJoMTRWN0g3eiIvPjwvc3ZnPmA7CmNvbnN0IEVESVRfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjQiIGZpbGw9IiR7TWF0ZXJpYWwuaGlnaEVtcGhhc2lzVGV4dENvbG9yfSI+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE0LjA2IDkuMDJsLjkyLjkyTDUuOTIgMTlINXYtLjkybDkuMDYtOS4wNk0xNy42NiAzYy0uMjUgMC0uNTEuMS0uNy4yOWwtMS44MyAxLjgzIDMuNzUgMy43NSAxLjgzLTEuODNjLjM5LS4zOS4zOS0xLjAyIDAtMS40MWwtMi4zNC0yLjM0Yy0uMi0uMi0uNDUtLjI5LS43MS0uMjl6bS0zLjYgMy4xOUwzIDE3LjI1VjIxaDMuNzVMMTcuODEgOS45NGwtMy43NS0zLjc1eiIvPjwvc3ZnPmA7CmNvbnN0IEFERF9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgZmlsbD0iJHtNYXRlcmlhbC5oaWdoRW1waGFzaXNUZXh0Q29sb3J9Ij4+PHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE5IDEzaC02djZoLTJ2LTZINXYtMmg2VjVoMnY2aDZ2MnoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19CT1hfVU5DSEVDS0VEX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOSA1djE0SDVWNWgxNG0wLTJINWMtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yeiIvPjwvc3ZnPmA7CmNvbnN0IENIRUNLX0JPWF9DSEVDS0VEX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBmaWxsPSIke01hdGVyaWFsLmhpZ2hFbXBoYXNpc1RleHRDb2xvcn0iPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOSAzSDVjLTEuMSAwLTIgLjktMiAydjE0YzAgMS4xLjkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJWNWMwLTEuMS0uOS0yLTItMnptMCAxNkg1VjVoMTR2MTR6TTE3Ljk5IDlsLTEuNDEtMS40Mi02LjU5IDYuNTktMi41OC0yLjU3LTEuNDIgMS40MSA0IDMuOTl6Ii8+PC9zdmc+YDsKY29uc3QgU0lERUJBUl9IVE1MID0gaHRtbGAKPGRpdiBpZD0ic2lkZWJhciI+CiAgICAke0hFQURFUl9IVE1MfQogICAgPGEgaWQ9InNpZGViYXItYWJvdXQiIGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCIgaHJlZj0iIyI+QWJvdXQ8L2E+CiAgICA8ZGl2IGlkPSJwcm9maWxlcyI+PC9kaXY+CiAgICA8ZGl2IGlkPSJzaWRlYmFyLWFuYWx5dGljcyI+PC9kaXY+CiAgICA8ZGl2IGlkPSJzY3JpcHRzIj48L2Rpdj4KPC9kaXY+CmA7CmNvbnN0IFNJREVCQVJfQ1NTID0gY3NzYAoKI3NpZGViYXIgewogICAgbWFyZ2luLWxlZnQ6IDFyZW07CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgbWluLXdpZHRoOiAxNXJlbTsKfQoKI3NpZGViYXItYWJvdXQgewogICAgZGlzcGxheTogYmxvY2s7CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwp9Cgojc2lkZWJhciAuYnV0dG9uLWdyaWQgewogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDJyZW07CiAgICBncmlkLWdhcDogMXB4OwogICAgbWFyZ2luLWxlZnQ6IDFweDsKICAgIG1hcmdpbi10b3A6IDFyZW07Cn0KCiNzaWRlYmFyIC5idXR0b24tZ3JpZC1uZXcgewogICAgZ3JpZC1jb2x1bW46IDE7CiAgICBtaW4td2lkdGg6IDhyZW07Cn0KCiNzaWRlYmFyIGJ1dHRvbiB7CiAgICBncmlkLWNvbHVtbjogMTsKfQoKI3NpZGViYXIgLmJ1dHRvbi1ncmlkIC5oaW50IHsKICAgIGdyaWQtY29sdW1uOiAxOyAKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI3NjcmlwdHMtc2Nyb2xsZXIgewogICAgaGVpZ2h0OiBjYWxjKDEwMHZoIC0gMjhyZW0pOwp9Cgojc2lkZWJhciAuZXh0cmEtdG9wLW1hcmdpbiB7CiAgICBtYXJnaW4tdG9wOiAxcmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0U2lkZWJhcihkb2N1bWVudCwgdm0sIGRhdGEpIHsKICAgIGNvbnN0IHVwZGF0ZUhlYWRlciA9IGluaXRIZWFkZXIoZG9jdW1lbnQsIHZtLCBkYXRhKTsKICAgIGNvbnN0IGFib3V0QW5jaG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZGViYXItYWJvdXQnKTsKICAgIGNvbnN0IHByb2ZpbGVzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGVzJyk7CiAgICBjb25zdCBhbmFseXRpY3NEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2lkZWJhci1hbmFseXRpY3MnKTsKICAgIGNvbnN0IHNjcmlwdHNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NyaXB0cycpOwogICAgYWJvdXRBbmNob3Iub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5zaG93QWJvdXQoKTsKICAgIH07CiAgICByZXR1cm4gKCk9PnsKICAgICAgICB1cGRhdGVIZWFkZXIoKTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihQUk9GSUxFU19IVE1MKHZtKSwgcHJvZmlsZXNEaXYpOwogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKEFOQUxZVElDU19IVE1MKHZtKSwgYW5hbHl0aWNzRGl2KTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihTQ1JJUFRTX0hUTUwodm0pLCBzY3JpcHRzRGl2KTsKICAgIH07Cn0KY29uc3QgUFJPRklMRVNfSFRNTCA9ICh2bSk9Pmh0bWxgCiAgICA8ZGl2IGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCI+UHJvZmlsZXM8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAke3ZtLnByb2ZpbGVzLm1hcCgocHJvZmlsZSk9Pmh0bWxgPGJ1dHRvbiAKICAgICAgICAgICAgY2xhc3M9IiR7cHJvZmlsZS5pZCA9PT0gdm0uc2VsZWN0ZWRQcm9maWxlSWQgPyAnc2VsZWN0ZWQnIDogJyd9IiAKICAgICAgICAgICAgQGNsaWNrPSR7KCk9PnsKICAgICAgICAgICAgdm0uc2VsZWN0ZWRQcm9maWxlSWQgPSBwcm9maWxlLmlkOwogICAgICAgIH19CiAgICAgICAgICAgID9kaXNhYmxlZD0iJHt2bS5wcm9maWxlRm9ybS5zaG93aW5nfSI+JHtwcm9maWxlLnRleHR9PC9idXR0b24+CiAgICAgICAgJHtwcm9maWxlLmlkID09PSB2bS5zZWxlY3RlZFByb2ZpbGVJZCA/IGh0bWxgJHthY3Rpb25JY29uKEVESVRfSUNPTiwgewogICAgICAgICAgICBvbmNsaWNrOiAoKT0+dm0uZWRpdFByb2ZpbGUocHJvZmlsZS5pZCkKICAgICAgICB9KX1gIDogJyd9YAogICAgKX0KICAgICAgICA8ZGl2IGNsYXNzPSJidXR0b24tZ3JpZC1uZXciPiR7YWN0aW9uSWNvbihBRERfSUNPTiwgewogICAgICAgIHRleHQ6ICdOZXcnLAogICAgICAgIG9uY2xpY2s6ICgpPT52bS5uZXdQcm9maWxlKCkKICAgIH0pfTwvZGl2PgogICAgPC9kaXY+CmAKOwpjb25zdCBBTkFMWVRJQ1NfSFRNTCA9ICh2bSk9Pmh0bWxgCiAgICA8ZGl2IGNsYXNzPSJvdmVybGluZSBtZWRpdW0tZW1waGFzaXMtdGV4dCBleHRyYS10b3AtbWFyZ2luIj5BbmFseXRpY3M8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAke3ZtLmFuYWx5dGljcy5tYXAoKGFuYWx5dGljKT0+aHRtbGA8YnV0dG9uCiAgICAgICAgICAgICAgICBjbGFzcz0iJHt2bS5zZWxlY3RlZEFuYWx5dGljSWQgPT09IGFuYWx5dGljLmlkID8gJ3NlbGVjdGVkJyA6ICcnfSIgCiAgICAgICAgICAgICAgICBAY2xpY2s9JHsoKT0+dm0uc2hvd0FuYWx5dGljKGFuYWx5dGljLmlkKQogICAgICAgIH0gCiAgICAgICAgICAgICAgICA/ZGlzYWJsZWQ9IiR7dm0ucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7YW5hbHl0aWMudGV4dH08L2J1dHRvbj4KICAgICAgICBgCiAgICApfQogICAgPC9kaXY+CmAKOwpjb25zdCBTQ1JJUFRTX0hUTUwgPSAodm0pPT5odG1sYAogICAgPGRpdiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQgZXh0cmEtdG9wLW1hcmdpbiI+U2NyaXB0czwvZGl2PgogICAgPGRpdiBpZD0ic2NyaXB0cy1zY3JvbGxlciIgY2xhc3M9ImhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwiPgogICAgICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICAgICAgJHt2bS5zY3JpcHRzLm1hcCgoc2NyaXB0KT0+aHRtbGA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgY2xhc3M9IiR7dm0uc2VsZWN0ZWRTY3JpcHRJZHMuaGFzKHNjcmlwdC5pZCkgPyAnc2VsZWN0ZWQnIDogJyd9IiAKICAgICAgICAgICAgICAgICAgICBAY2xpY2s9JHsoZSk9PmhhbmRsZVNjcmlwdENsaWNrKGUsIHNjcmlwdC5pZCwgdm0pCiAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICA/ZGlzYWJsZWQ9IiR7dm0ucHJvZmlsZUZvcm0uc2hvd2luZ30iPiR7c2NyaXB0LnRleHR9PC9idXR0b24+CiAgICAgICAgICAgIGAKICAgICl9CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImJ1dHRvbi1ncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXB0aW9uIG1lZGl1bS1lbXBoYXNpcy10ZXh0IGhpbnQiPiR7Y29tcHV0ZU11bHRpc2VsZWN0S2V5Q2hhcigpfS1jbGljayB0byBtdWx0aXNlbGVjdDwvZGl2PgogICAgPC9kaXY+CmAKOwpmdW5jdGlvbiBjb21wdXRlTXVsdGlzZWxlY3RLZXlDaGFyKCkgewogICAgcmV0dXJuIGlzTWFjaW50b3NoKCkgPyAn4oyYJyA6ICdjdHJsJzsKfQpmdW5jdGlvbiBpc01hY2ludG9zaCgpIHsKICAgIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm0uaW5kZXhPZignTWFjJykgPiAtMTsKfQpmdW5jdGlvbiBoYW5kbGVTY3JpcHRDbGljayhlLCBzY3JpcHRJZCwgdm0pIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IG5ld1NjcmlwdElkcyA9IG5ldyBTZXQoWwogICAgICAgIHNjcmlwdElkCiAgICBdKTsKICAgIGNvbnN0IG11bHRpID0gaXNNYWNpbnRvc2goKSA/IGUubWV0YUtleSA6IGUuY3RybEtleTsKICAgIHZtLnNlbGVjdGVkU2NyaXB0SWRzID0gbXVsdGkgPyB2bS5zZWxlY3RlZFNjcmlwdElkcy5oYXMoc2NyaXB0SWQpID8gc2V0U3VidHJhY3Qodm0uc2VsZWN0ZWRTY3JpcHRJZHMsIG5ld1NjcmlwdElkcykgOiBzZXRVbmlvbih2bS5zZWxlY3RlZFNjcmlwdElkcywgbmV3U2NyaXB0SWRzKSA6IG5ld1NjcmlwdElkczsKfQpjbGFzcyBBcHBDb25zdGFudHMgewogICAgc3RhdGljIFdFQlNPQ0tFVF9QSU5HX0lOVEVSVkFMX1NFQ09ORFMgPSAxMDsKICAgIHN0YXRpYyBJTkFDVElWRV9UQUlMX1NFQ09ORFMgPSA1Owp9CmNsYXNzIFRhaWxDb250cm9sbGVyIHsKICAgIGNhbGxiYWNrczsKICAgIHJlY29yZHMgPSBuZXcgTWFwKCk7CiAgICB3ZWJzb2NrZXRQaW5nSW50ZXJ2YWxTZWNvbmRzOwogICAgaW5hY3RpdmVUYWlsU2Vjb25kczsKICAgIHRhaWxPcHRpb25zID0gewogICAgICAgIGZpbHRlcnM6IFtdCiAgICB9OwogICAgb25saW5lOwogICAgY29uc3RydWN0b3IoY2FsbGJhY2tzLCBvcHRzKXsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICB0aGlzLndlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgPSBvcHRzLndlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHM7CiAgICAgICAgdGhpcy5pbmFjdGl2ZVRhaWxTZWNvbmRzID0gb3B0cy5pbmFjdGl2ZVRhaWxTZWNvbmRzOwogICAgICAgIGNvbnN0IG5hdmlnYXRvckFzQW55ID0gd2luZG93Lm5hdmlnYXRvcjsKICAgICAgICBpZiAodHlwZW9mIG5hdmlnYXRvckFzQW55Lm9uTGluZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgIHRoaXMuc2V0T25saW5lKG5hdmlnYXRvckFzQW55Lm9uTGluZSk7CiAgICAgICAgfQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCAoKT0+dGhpcy5zZXRPbmxpbmUodHJ1ZSkKICAgICAgICApOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvZmZsaW5lJywgKCk9PnRoaXMuc2V0T25saW5lKGZhbHNlKQogICAgICAgICk7CiAgICB9CiAgICBzZXRUYWlsT3B0aW9ucyh0YWlsT3B0aW9ucykgewogICAgICAgIGNvbnNvbGUubG9nKGBUYWlsQ29udHJvbGxlci5zZXRUYWlsT3B0aW9ucyAke0pTT04uc3RyaW5naWZ5KHRhaWxPcHRpb25zKX1gKTsKICAgICAgICB0aGlzLnRhaWxPcHRpb25zID0gdGFpbE9wdGlvbnM7CiAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5yZWNvcmRzLnZhbHVlcygpKXsKICAgICAgICAgICAgaWYgKHJlY29yZC5jb25uZWN0aW9uKSB7CiAgICAgICAgICAgICAgICByZWNvcmQuY29ubmVjdGlvbi5zZXRPcHRpb25zKHRhaWxPcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHNldFRhaWxzKGFjY291bnRJZCwgYXBpVG9rZW4sIHNjcmlwdElkcykgewogICAgICAgIGNvbnN0IHN0b3BLZXlzID0gc2V0U3VidHJhY3QodGhpcy5jb21wdXRlU3RhcnRpbmdPclN0YXJ0ZWRUYWlsS2V5cygpLCBuZXcgU2V0KFsKICAgICAgICAgICAgLi4uc2NyaXB0SWRzCiAgICAgICAgXS5tYXAoKHYpPT5wYWNrVGFpbEtleShhY2NvdW50SWQsIHYpCiAgICAgICAgKSkpOwogICAgICAgIGZvciAoY29uc3Qgc3RvcEtleSBvZiBzdG9wS2V5cyl7CiAgICAgICAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQoc3RvcEtleSk7CiAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdpbmFjdGl2ZSc7CiAgICAgICAgICAgIHJlY29yZC5zdG9wUmVxdWVzdGVkVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScgJiYgcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lICYmIERhdGUubm93KCkgLSByZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPj0gdGhpcy5pbmFjdGl2ZVRhaWxTZWNvbmRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gJ3N0b3BwaW5nJzsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3RvcHBpbmcgJHtyZWNvcmQuc2NyaXB0SWR9LCBpbmFjdGl2ZSBmb3IgJHtEYXRlLm5vdygpIC0gcmVjb3JkLnN0b3BSZXF1ZXN0ZWRUaW1lfW1zYCk7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmNvbm5lY3Rpb24/LmNsb3NlKDEwMDAsICdubyBsb25nZXIgaW50ZXJlc3RlZCcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkcy5kZWxldGUocmVjb3JkLnRhaWxLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0aGlzLmluYWN0aXZlVGFpbFNlY29uZHMgKiAxMDAwKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0b3BLZXlzLnNpemUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKTsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBzY3JpcHRJZCBvZiBzY3JpcHRJZHMpewogICAgICAgICAgICBjb25zdCB0YWlsS2V5ID0gcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nUmVjb3JkID0gdGhpcy5yZWNvcmRzLmdldCh0YWlsS2V5KTsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkKSB7CiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdSZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUmV2aXZpbmcgaW5hY3RpdmUgJHtzY3JpcHRJZH1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGV4aXN0aW5nUmVjb3JkLnN0YXRlID0gJ3N0YXJ0ZWQnOwogICAgICAgICAgICAgICAgZXhpc3RpbmdSZWNvcmQuc3RvcFJlcXVlc3RlZFRpbWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCByZWNvcmQgPSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGU6ICdzdGFydGluZycsCiAgICAgICAgICAgICAgICAgICAgdGFpbEtleSwKICAgICAgICAgICAgICAgICAgICBhcGlUb2tlbiwKICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQsCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0SWQsCiAgICAgICAgICAgICAgICAgICAgcmV0cnlDb3VudEFmdGVyQ2xvc2U6IDAKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLnJlY29yZHMuc2V0KHRhaWxLZXksIHJlY29yZCk7CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKTsKICAgICAgICAgICAgICAgIHJlY29yZC5zdGF0ZSA9ICdzdGFydGVkJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRpc3BhdGNoVGFpbHNDaGFuZ2VkKCk7CiAgICAgICAgfQogICAgfQogICAgZGlzcGF0Y2hUYWlsc0NoYW5nZWQoKSB7CiAgICAgICAgY29uc3QgdGFpbEtleXMgPSBuZXcgU2V0KFsKICAgICAgICAgICAgLi4udGhpcy5yZWNvcmRzLnZhbHVlcygpCiAgICAgICAgXS5maWx0ZXIoKHYpPT52LnN0YXRlID09PSAnc3RhcnRlZCcKICAgICAgICApLm1hcCgodik9PnYudGFpbEtleQogICAgICAgICkpOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbHNDaGFuZ2VkKHRhaWxLZXlzKTsKICAgIH0KICAgIGNvbXB1dGVTdGFydGluZ09yU3RhcnRlZFRhaWxLZXlzKCkgewogICAgICAgIHJldHVybiBuZXcgU2V0KFsKICAgICAgICAgICAgLi4udGhpcy5yZWNvcmRzLnZhbHVlcygpCiAgICAgICAgXS5maWx0ZXIoKHYpPT52LnN0YXRlID09PSAnc3RhcnRpbmcnIHx8IHYuc3RhdGUgPT09ICdzdGFydGVkJwogICAgICAgICkubWFwKCh2KT0+di50YWlsS2V5CiAgICAgICAgKSk7CiAgICB9CiAgICBzZXRPbmxpbmUob25saW5lKSB7CiAgICAgICAgaWYgKG9ubGluZSA9PT0gdGhpcy5vbmxpbmUpIHJldHVybjsKICAgICAgICBjb25zdCBvbGRPbmxpbmUgPSB0aGlzLm9ubGluZTsKICAgICAgICB0aGlzLm9ubGluZSA9IG9ubGluZTsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vbk5ldHdvcmtTdGF0dXNDaGFuZ2VkKG9ubGluZSk7CiAgICAgICAgaWYgKHR5cGVvZiBvbGRPbmxpbmUgPT09ICdib29sZWFuJykgewogICAgICAgICAgICBpZiAob25saW5lKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiB0aGlzLnJlY29yZHMudmFsdWVzKCkpewogICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdzdGFydGVkJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGFjY291bnRJZCAsIHNjcmlwdElkICB9ID0gcmVjb3JkOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKS5jYXRjaCgoZSk9PnRoaXMuY2FsbGJhY2tzLm9uVGFpbEZhaWxlZFRvU3RhcnQoYWNjb3VudElkLCBzY3JpcHRJZCwgJ3Jlc3RhcnQtYWZ0ZXItY29taW5nLW9ubGluZScsIGUpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5yZWNvcmRzLnZhbHVlcygpKXsKICAgICAgICAgICAgICAgICAgICByZWNvcmQuY29ubmVjdGlvbj8uY2xvc2UoMTAwMCwgJ29mZmxpbmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKSB7CiAgICAgICAgY29uc3QgYWxsb3dlZFRvU3RhcnQgPSByZWNvcmQuc3RhdGUgPT09ICdzdGFydGluZycgfHwgcmVjb3JkLnN0YXRlID09PSAnc3RhcnRlZCc7CiAgICAgICAgaWYgKCFhbGxvd2VkVG9TdGFydCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgc2NyaXB0SWQgIH0gPSB1bnBhY2tUYWlsS2V5KHJlY29yZC50YWlsS2V5KTsKICAgICAgICBjb25zdCB7IGFwaVRva2VuICB9ID0gcmVjb3JkOwogICAgICAgIGlmICghcmVjb3JkLnRhaWwgfHwgRGF0ZS5ub3coKSA+IG5ldyBEYXRlKHJlY29yZC50YWlsLmV4cGlyZXNfYXQpLmdldFRpbWUoKSAtIDEwMDAgKiA2MCAqIDUpIHsKICAgICAgICAgICAgY29uc3QgdGFpbENyZWF0aW5nVGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpOwogICAgICAgICAgICBjb25zdCB0YWlsID0gYXdhaXQgY3JlYXRlVGFpbChhY2NvdW50SWQsIHNjcmlwdElkLCBhcGlUb2tlbik7CiAgICAgICAgICAgIHJlY29yZC50YWlsID0gdGFpbDsKICAgICAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpIC0gdGFpbENyZWF0aW5nVGltZSwgdGFpbCk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdpbmFjdGl2ZScpIHJldHVybjsKICAgICAgICBjb25zdCB7IGNhbGxiYWNrcyAsIHdlYnNvY2tldFBpbmdJbnRlcnZhbFNlY29uZHMgIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGRpcyA9IHRoaXM7CiAgICAgICAgY29uc3Qgb3BlbmluZ1RpbWUgPSBEYXRlLm5vdygpOwogICAgICAgIGNvbnN0IHRhaWxDb25uZWN0aW9uQ2FsbGJhY2tzID0gewogICAgICAgICAgICBvbk9wZW4gKF9jbiwgdGltZVN0YW1wKSB7CiAgICAgICAgICAgICAgICByZWNvcmQucmV0cnlDb3VudEFmdGVyQ2xvc2UgPSAwOwogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25PcGVuKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgRGF0ZS5ub3coKSAtIG9wZW5pbmdUaW1lKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25DbG9zZSAoX2NuLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uQ2xvc2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBjb2RlLCByZWFzb24sIHdhc0NsZWFuKTsKICAgICAgICAgICAgICAgIHJlY29yZC5jbG9zZVRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgaWYgKHJlY29yZC5zdGF0ZSA9PT0gJ3N0YXJ0ZWQnICYmIGRpcy5vbmxpbmUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLnJldHJ5Q291bnRBZnRlckNsb3NlKys7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVsYXlTZWNvbmRzID0gTWF0aC5taW4ocmVjb3JkLnJldHJ5Q291bnRBZnRlckNsb3NlICogNSwgNjApOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBXaWxsIGF0dGVtcHQgdG8gcmVzdGFydCAke3NjcmlwdElkfSBpbiAke2RlbGF5U2Vjb25kc30gc2Vjb25kc2ApOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXN5bmMgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgPT09ICdzdGFydGVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGlzLnN0YXJ0VGFpbENvbm5lY3Rpb24ocmVjb3JkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIGRlbGF5U2Vjb25kcyAqIDEwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBvbkVycm9yIChfY24sIHRpbWVTdGFtcCwgZXJyb3JJbmZvKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsTWVzc2FnZSAoX2NuLCB0aW1lU3RhbXAsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuc3RhdGUgIT09ICdzdGFydGVkJykgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uVW5wYXJzZWRNZXNzYWdlIChfY24sIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29uVW5wYXJzZWRNZXNzYWdlJywgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJlY29yZC5jb25uZWN0aW9uID0gbmV3IFRhaWxDb25uZWN0aW9uKHJlY29yZC50YWlsLnVybCwgdGFpbENvbm5lY3Rpb25DYWxsYmFja3MsIHsKICAgICAgICAgICAgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcwogICAgICAgIH0pLnNldE9wdGlvbnModGhpcy50YWlsT3B0aW9ucyk7CiAgICB9Cn0KZnVuY3Rpb24gdW5wYWNrVGFpbEtleSh0YWlsS2V5KSB7CiAgICBjb25zdCBtID0gL14oW15ccy1dKyktKFteXHNdKykkLy5leGVjKHRhaWxLZXkpOwogICAgaWYgKCFtKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB0YWlsS2V5OiAke3RhaWxLZXl9YCk7CiAgICByZXR1cm4gewogICAgICAgIGFjY291bnRJZDogbVsxXSwKICAgICAgICBzY3JpcHRJZDogbVsyXQogICAgfTsKfQpmdW5jdGlvbiBwYWNrVGFpbEtleShhY2NvdW50SWQsIHNjcmlwdElkKSB7CiAgICByZXR1cm4gYCR7YWNjb3VudElkfS0ke3NjcmlwdElkfWA7Cn0KY2xhc3MgU3dpdGNoYWJsZVRhaWxDb250cm9sbGVyQ2FsbGJhY2tzIHsKICAgIGNhbGxiYWNrczsKICAgIGVuYWJsZWRGbjsKICAgIGNvbnN0cnVjdG9yKGNhbGxiYWNrcywgZW5hYmxlZEZuKXsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICB0aGlzLmVuYWJsZWRGbiA9IGVuYWJsZWRGbjsKICAgIH0KICAgIG9uVGFpbENyZWF0aW5nKGFjY291bnRJZCwgc2NyaXB0SWQpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDcmVhdGluZyhhY2NvdW50SWQsIHNjcmlwdElkKTsKICAgIH0KICAgIG9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENyZWF0ZWQoYWNjb3VudElkLCBzY3JpcHRJZCwgdG9va01pbGxpcywgdGFpbCk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIHRvb2tNaWxsaXMpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uT3BlbihhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIHRvb2tNaWxsaXMpOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbkNsb3NlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25DbG9zZShhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGNvZGUsIHJlYXNvbiwgd2FzQ2xlYW4pOwogICAgfQogICAgb25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbkVycm9yKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgZXJyb3JJbmZvKTsKICAgIH0KICAgIG9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSkgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSk7CiAgICB9CiAgICBvblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgIGlmICghdGhpcy5lbmFibGVkRm4oKSkgcmV0dXJuOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25VbnBhcnNlZE1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgdGltZVN0YW1wLCBtZXNzYWdlLCBwYXJzZUVycm9yKTsKICAgIH0KICAgIG9uVGFpbHNDaGFuZ2VkKHRhaWxzKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsc0NoYW5nZWQodGFpbHMpOwogICAgfQogICAgb25OZXR3b3JrU3RhdHVzQ2hhbmdlZChvbmxpbmUpIHsKICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZEZuKCkpIHJldHVybjsKICAgICAgICB0aGlzLmNhbGxiYWNrcy5vbk5ldHdvcmtTdGF0dXNDaGFuZ2VkKG9ubGluZSk7CiAgICB9CiAgICBvblRhaWxGYWlsZWRUb1N0YXJ0KGFjY291bnRJZCwgc2NyaXB0SWQsIHRyaWdnZXIsIGVycm9yKSB7CiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRGbigpKSByZXR1cm47CiAgICAgICAgdGhpcy5jYWxsYmFja3Mub25UYWlsRmFpbGVkVG9TdGFydChhY2NvdW50SWQsIHNjcmlwdElkLCB0cmlnZ2VyLCBlcnJvcik7CiAgICB9Cn0KY2xhc3MgRGVtb01vZGUgewogICAgc3RhdGljIHByb2ZpbGVzID0gWwogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdwcm9maWxlMScsCiAgICAgICAgICAgIHRleHQ6ICdjb3JwLXByb2ZpbGUnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAncHJvZmlsZTInLAogICAgICAgICAgICB0ZXh0OiAncGVycy1wcm9maWxlJwogICAgICAgIH0sIAogICAgXTsKICAgIHN0YXRpYyBzZWxlY3RlZFByb2ZpbGVJZCA9ICdwcm9maWxlMSc7CiAgICBzdGF0aWMgc2V0U2VsZWN0ZWRQcm9maWxlSWQoX3ZhbHVlKSB7CiAgICB9CiAgICBzdGF0aWMgc2NyaXB0cyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnc2NyaXB0MScsCiAgICAgICAgICAgIHRleHQ6ICd3b3JrZXIxLWRldicKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQyJywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjEtcHJvZCcKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQzJywKICAgICAgICAgICAgdGV4dDogJ3dvcmtlcjItZGV2JwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDQnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMi1iZXRhJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDUnLAogICAgICAgICAgICB0ZXh0OiAnd29ya2VyMi1wcm9kJwogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZDogJ3NjcmlwdDYnLAogICAgICAgICAgICB0ZXh0OiAnZHVyYWJsZS1vYmplY3QtZGVtbycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICdzY3JpcHQ3JywKICAgICAgICAgICAgdGV4dDogJ3NlY3JldC1hcHAnCiAgICAgICAgfSwgCiAgICBdOwogICAgc3RhdGljIHNlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldChbCiAgICAgICAgJ3NjcmlwdDcnLAogICAgICAgICdzY3JpcHQ0JwogICAgXSk7CiAgICBzdGF0aWMgc2V0U2VsZWN0ZWRTY3JpcHRJZHMoX3NjcmlwdElkcykgewogICAgfQogICAgc3RhdGljIHRhaWxzID0gbmV3IFNldCgpOwogICAgc3RhdGljIGxvZ0Zha2VPdXRwdXQoY2FsbGJhY2tzKSB7CiAgICAgICAgY29uc3QgYWNjb3VudElkID0gJzE1YTdmYTNhMzcyNTRmZTRhN2NhZGQxYmIyNzYyODc5JzsKICAgICAgICBjb25zdCBzY3JpcHRJZCA9ICdzZWNyZXQtYXBwJzsKICAgICAgICBjYWxsYmFja3Mub25UYWlsQ3JlYXRpbmcoYWNjb3VudElkLCBzY3JpcHRJZCk7CiAgICAgICAgY29uc3QgdGFpbCA9IHsKICAgICAgICAgICAgaWQ6ICdkYjE5ZWI4YmU5ZjQ0NDNhYWI5MWE5MDQyYzBkMzUxNycsCiAgICAgICAgICAgIHVybDogJ3dzczovL3RhaWwuZGV2ZWxvcGVycy53b3JrZXJzLmRldi9kYjE5ZWI4YmU5ZjQ0NDNhYWI5MWE5MDQyYzBkMzUxNycsCiAgICAgICAgICAgICdleHBpcmVzX2F0JzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICAgICAgfTsKICAgICAgICBjYWxsYmFja3Mub25UYWlsQ3JlYXRlZChhY2NvdW50SWQsIHNjcmlwdElkLCAxNTUsIHRhaWwpOwogICAgICAgIGNhbGxiYWNrcy5vblRhaWxzQ2hhbmdlZChuZXcgU2V0KFsKICAgICAgICAgICAgcGFja1RhaWxLZXkoYWNjb3VudElkLCBzY3JpcHRJZCkKICAgICAgICBdKSk7CiAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25PcGVuKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIDQyKTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgMjsgaSsrKXsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlUmVxdWVzdCgpKTsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uVGFpbENvbm5lY3Rpb25NZXNzYWdlKGFjY291bnRJZCwgc2NyaXB0SWQsIERhdGUubm93KCksIGNvbXB1dGVGYWtlRG9SZXF1ZXN0KCkpOwogICAgICAgICAgICBjYWxsYmFja3Mub25UYWlsQ29ubmVjdGlvbk1lc3NhZ2UoYWNjb3VudElkLCBzY3JpcHRJZCwgRGF0ZS5ub3coKSwgY29tcHV0ZUZha2VSZXF1ZXN0V2l0aExvZ3MoKSk7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vblRhaWxDb25uZWN0aW9uTWVzc2FnZShhY2NvdW50SWQsIHNjcmlwdElkLCBEYXRlLm5vdygpLCBjb21wdXRlRmFrZVJlcXVlc3RFeGNlZWRpbmdUaW1lTGltaXQoKSk7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IFVTRVJfQUdFTlQgPSAnTW96aWxsYS81LjAgKE1hY2ludG9zaDsgSW50ZWwgTWFjIE9TIFggMTAuMTU7IHJ2OjkxLjApIEdlY2tvLzIwMTAwMTAxIEZpcmVmb3gvOTEuMCc7CmZ1bmN0aW9uIGNvbXB1dGVGYWtlUmVxdWVzdCgpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20vZW5kcG9pbnQnLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnY2YtY29ubmVjdGluZy1pcCc6ICcyMDMuMC4xMTMuMTInLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVVNFUl9BR0VOVAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNmOiB7CiAgICAgICAgICAgICAgICAgICAgY29sbzogJ0RGVycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogW10sCiAgICAgICAgZXhjZXB0aW9uczogW10sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ29rJwogICAgfTsKICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlRmFrZURvUmVxdWVzdCgpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZmFrZS1ob3N0L3B1dCcsCiAgICAgICAgICAgICAgICBtZXRob2Q6ICdQVVQnLAogICAgICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsb2dzOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnbG9nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnbG9ncHJvcHM6JywKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG86ICdFV1InLAogICAgICAgICAgICAgICAgICAgICAgICBkdXJhYmxlT2JqZWN0Q2xhc3M6ICdMb2dnZXJETycsCiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGVPYmplY3RJZDogJzUzOGZjN2NlNTViMTRlNTNiNmI4NTUyYmVmZWI5YWY0JywKICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZU9iamVjdE5hbWU6ICdsb2cxJwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwgCiAgICAgICAgXSwKICAgICAgICBleGNlcHRpb25zOiBbXSwKICAgICAgICBldmVudFRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICBvdXRjb21lOiAnb2snCiAgICB9OwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVGYWtlUmVxdWVzdFdpdGhMb2dzKCkgewogICAgY29uc3QgcnQgPSB7CiAgICAgICAgZXZlbnQ6IHsKICAgICAgICAgICAgcmVxdWVzdDogewogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9teS13b3JrZXIuc3ViZG9tYWluLndvcmtlcnMuZGV2L3Rlc3Q/bG9nPXRydWUnLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnY2YtY29ubmVjdGluZy1pcCc6ICcyMDMuMC4xMTMuMTInLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVVNFUl9BR0VOVAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNmOiB7CiAgICAgICAgICAgICAgICAgICAgY29sbzogJ0RGVycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9nczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2xvZycsCiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBbCiAgICAgICAgICAgICAgICAgICAgJ0xvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0LCBjb25zZWN0ZXR1ciBhZGlwaXNjaW5nIGVsaXQnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnZXJyb3InLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2luZm8nLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ3dhcm5pbmcnLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogWwogICAgICAgICAgICAgICAgICAgICdMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0JwogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXZlbDogJ2RlYnVnJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdCcKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwgCiAgICAgICAgXSwKICAgICAgICBleGNlcHRpb25zOiBbXSwKICAgICAgICBldmVudFRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICBvdXRjb21lOiAnb2snCiAgICB9OwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVGYWtlUmVxdWVzdEV4Y2VlZGluZ1RpbWVMaW1pdCgpIHsKICAgIGNvbnN0IHJ0ID0gewogICAgICAgIGV2ZW50OiB7CiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vbXktd29ya2VyLnN1YmRvbWFpbi53b3JrZXJzLmRldi9jb21wdXRlLWRpZ2l0cy1vZi1waScsCiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgICAgICdjZi1jb25uZWN0aW5nLWlwJzogJzIwMy4wLjExMy4xMicsCiAgICAgICAgICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiBVU0VSX0FHRU5UCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2Y6IHsKICAgICAgICAgICAgICAgICAgICBjb2xvOiAnREZXJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsb2dzOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldmVsOiAnbG9nJywKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFsKICAgICAgICAgICAgICAgICAgICAnYnVybmluZyBjcHUnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXhjZXB0aW9uczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lOiAnRXJyb3InLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgbWVzc2FnZTogJ1dvcmtlciBleGNlZWRlZCBDUFUgdGltZSBsaW1pdC4nCiAgICAgICAgICAgIH0sIAogICAgICAgIF0sCiAgICAgICAgZXZlbnRUaW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgb3V0Y29tZTogJ2V4Y2VlZGVkQ3B1JwogICAgfTsKICAgIHJldHVybiBydDsKfQpjbGFzcyBRcHNDb250cm9sbGVyIHsKICAgIHNvcnRlZEV2ZW50VGltZXMgPSBbXTsKICAgIGNhbGxiYWNrczsKICAgIG47CiAgICBfcXBzID0gMDsKICAgIGdldCBxcHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3FwczsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG4sIGNhbGxiYWNrcyl7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5uID0gbjsKICAgIH0KICAgIGFkZEV2ZW50KGV2ZW50VGltZSkgewogICAgICAgIGNvbnN0IHFwcyA9IGNvbXB1dGVRcHModGhpcy5uLCB0aGlzLnNvcnRlZEV2ZW50VGltZXMsIGV2ZW50VGltZSk7CiAgICAgICAgaWYgKHFwcyA9PT0gdGhpcy5fcXBzKSByZXR1cm47CiAgICAgICAgdGhpcy5fcXBzID0gcXBzOwogICAgICAgIHRoaXMuY2FsbGJhY2tzLm9uUXBzQ2hhbmdlZChxcHMpOwogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVRcHMobiwgc29ydGVkRXZlbnRUaW1lcywgZXZlbnRUaW1lKSB7CiAgICBhZGQoZXZlbnRUaW1lLCBzb3J0ZWRFdmVudFRpbWVzKTsKICAgIHdoaWxlKHNvcnRlZEV2ZW50VGltZXMubGVuZ3RoID4gbil7CiAgICAgICAgc29ydGVkRXZlbnRUaW1lcy5zaGlmdCgpOwogICAgfQogICAgY29uc3QgbnVtID0gc29ydGVkRXZlbnRUaW1lcy5sZW5ndGg7CiAgICBpZiAobnVtIDwgMikgcmV0dXJuIDA7CiAgICBjb25zdCB0aW1lRGlmZlNlY29uZHMgPSAoc29ydGVkRXZlbnRUaW1lc1tzb3J0ZWRFdmVudFRpbWVzLmxlbmd0aCAtIDFdIC0gc29ydGVkRXZlbnRUaW1lc1swXSkgLyAxMDAwOwogICAgcmV0dXJuIChudW0gLSAxKSAvIHRpbWVEaWZmU2Vjb25kczsKfQpmdW5jdGlvbiBhZGQoZWwsIGFycikgewogICAgYXJyLnNwbGljZShmaW5kTG9jKGVsLCBhcnIpICsgMSwgMCwgZWwpOwogICAgcmV0dXJuIGFycjsKfQpmdW5jdGlvbiBmaW5kTG9jKGVsLCBhcnIsIHN0LCBlbikgewogICAgc3QgPSBzdCB8fCAwOwogICAgZW4gPSBlbiB8fCBhcnIubGVuZ3RoOwogICAgZm9yKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKGFycltpXSA+IGVsKSB7CiAgICAgICAgICAgIHJldHVybiBpIC0gMTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gZW47Cn0KZnVuY3Rpb24gY2hlY2tFcXVhbChuYW1lLCB2YWx1ZSwgZXhwZWN0ZWQpIHsKICAgIGlmICh2YWx1ZSAhPT0gZXhwZWN0ZWQpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06IGV4cGVjdGVkICR7ZXhwZWN0ZWR9LCBmb3VuZCAke3ZhbHVlfWApOwp9CmZ1bmN0aW9uIGNoZWNrTWF0Y2hlcyhuYW1lLCB2YWx1ZSwgcGF0dGVybikgewogICAgaWYgKCFwYXR0ZXJuLnRlc3QodmFsdWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfWApOwogICAgcmV0dXJuIHZhbHVlOwp9CmNsYXNzIEdyYXBocWxRdWVyeSB7CiAgICBfcGFyZW50OwogICAgX25vZGVzOwogICAgX25vZGVPcmRlcjsKICAgIF9hcmdzOwogICAgX2FyZ09yZGVyOwogICAgY29uc3RydWN0b3IocGFyZW50LCBub2Rlcywgbm9kZU9yZGVyLCBhcmdzLCBhcmdPcmRlcil7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gcGFyZW50OwogICAgICAgIHRoaXMuX25vZGVzID0gbm9kZXM7CiAgICAgICAgdGhpcy5fbm9kZU9yZGVyID0gbm9kZU9yZGVyOwogICAgICAgIHRoaXMuX2FyZ3MgPSBhcmdzOwogICAgICAgIHRoaXMuX2FyZ09yZGVyID0gYXJnT3JkZXI7CiAgICB9CiAgICBzdGF0aWMgY3JlYXRlKCkgewogICAgICAgIHJldHVybiBuZXcgR3JhcGhxbFF1ZXJ5KFtdLCBuZXcgTWFwKCksIFtdLCBuZXcgTWFwKCksIFtdKTsKICAgIH0KICAgIHNjYWxhcihuYW1lKSB7CiAgICAgICAgdGhpcy5hZGQobmFtZSwgTm9kZUtpbmQuU2NhbGFyKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIG9iamVjdChuYW1lKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuYWRkKG5hbWUsIE5vZGVLaW5kLk9iamVjdCk7CiAgICAgICAgY29uc3QgcnQgPSBuZXcgR3JhcGhxbFF1ZXJ5KFsKICAgICAgICAgICAgdGhpcwogICAgICAgIF0sIG5ldyBNYXAoKSwgW10sIG5ldyBNYXAoKSwgW10pOwogICAgICAgIG5vZGUucXVlcnkucHVzaChydCk7CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQogICAgb2JqZWN0UXVlcnkobmFtZSwgcXVlcnkpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5hZGQobmFtZSwgTm9kZUtpbmQuT2JqZWN0KTsKICAgICAgICBjb25zdCBxID0gcXVlcnkuY29weVdpdGhQYXJlbnQodGhpcyk7CiAgICAgICAgY29uc3QgcnQgPSBxOwogICAgICAgIG5vZGUucXVlcnkucHVzaChydCk7CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQogICAgYXJnUmF3KG5hbWUsIHJhd1ZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkQXJnKG5hbWUsIHJhd1ZhbHVlKTsKICAgIH0KICAgIGFyZ0Jvb2xlYW4obmFtZSwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgdmFsdWUgPyAndHJ1ZScgOiAnZmFsc2UnKTsKICAgIH0KICAgIGFyZ0xvbmcobmFtZSwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgYCR7dmFsdWV9YCk7CiAgICB9CiAgICBhcmdTdHJpbmcobmFtZSwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgYCIke3ZhbHVlLnJlcGxhY2VBbGwoJyInLCAnXFwiJyl9ImApOwogICAgfQogICAgYXJnT2JqZWN0KG5hbWUsIGZpZWxkTmFtZSwgZmllbGRWYWx1ZSkgewogICAgICAgIHJldHVybiB0aGlzLmFkZEFyZyhuYW1lLCBgeyR7ZmllbGROYW1lfToiJHtmaWVsZFZhbHVlLnJlcGxhY2VBbGwoJyInLCAnXFwiJyl9In1gKTsKICAgIH0KICAgIGFyZ1ZhcmlhYmxlKG5hbWUsIHZhcmlhYmxlTmFtZSkgewogICAgICAgIGNoZWNrTWF0Y2hlcygndmFyaWFibGVOYW1lJywgdmFyaWFibGVOYW1lLCAvXlthLXpdKyQvKTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRBcmcobmFtZSwgYCQke3ZhcmlhYmxlTmFtZX1gKTsKICAgIH0KICAgIGVuZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcGFyZW50Lmxlbmd0aCA+IDAgPyB0aGlzLl9wYXJlbnRbMF0gOiB0aGlzOwogICAgfQogICAgdG9wKCkgewogICAgICAgIGxldCBydCA9IHRoaXM7CiAgICAgICAgd2hpbGUocnQuX3BhcmVudC5sZW5ndGggPiAwKXsKICAgICAgICAgICAgcnQgPSBydC5fcGFyZW50WzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICB0b1N0cmluZygpIHsKICAgICAgICBjb25zdCBsaW5lcyA9IFtdOwogICAgICAgIGxpbmVzLnB1c2goJ3snKTsKICAgICAgICB0aGlzLndyaXRlKGxpbmVzLCAxKTsKICAgICAgICBsaW5lcy5wdXNoKCd9Jyk7CiAgICAgICAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xuJyk7CiAgICB9CiAgICBhZGRBcmcobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fYXJncy5oYXMobmFtZSkpIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIGFyZzogJHtuYW1lfWApOwogICAgICAgIHRoaXMuX2FyZ09yZGVyLnB1c2gobmFtZSk7CiAgICAgICAgdGhpcy5fYXJncy5zZXQobmFtZSwgdmFsdWUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgd3JpdGUobGluZXMsIGxldmVsKSB7CiAgICAgICAgY29uc3QgaW5kZW50ID0gJyAgJy5yZXBlYXQobGV2ZWwpOwogICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMuX25vZGVPcmRlcil7CiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBjaGVja0dldCgnX25vZGVzJywgdGhpcy5fbm9kZXMsIGtleSk7CiAgICAgICAgICAgIGlmIChub2RlLmtpbmQgPT09IE5vZGVLaW5kLlNjYWxhcikgewogICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtpbmRlbnR9JHtrZXl9YCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5raW5kID09PSBOb2RlS2luZC5PYmplY3QpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBub2RlLnF1ZXJ5WzBdOwogICAgICAgICAgICAgICAgbGV0IGxpbmUgPSBgJHtpbmRlbnR9JHtrZXl9YDsKICAgICAgICAgICAgICAgIGlmIChxLl9hcmdPcmRlci5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgbGluZSArPSAnKCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IGogPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgYXJnTmFtZSBvZiBxLl9hcmdPcmRlcil7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID4gMCkgbGluZSArPSAnLCAnOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5lICs9IGAke2FyZ05hbWV9OiAke2NoZWNrR2V0KCdxLl9hcmdzJywgcS5fYXJncywgYXJnTmFtZSl9YDsKICAgICAgICAgICAgICAgICAgICAgICAgaisrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsaW5lICs9ICcpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpbmUgKz0gJyB7JzsKICAgICAgICAgICAgICAgIGxpbmVzLnB1c2gobGluZSk7CiAgICAgICAgICAgICAgICBub2RlLnF1ZXJ5WzBdLndyaXRlKGxpbmVzLCBsZXZlbCArIDEpOwogICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtpbmRlbnR9fWApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbXBsZW1lbnQgbm9kZSBraW5kICR7bm9kZS5raW5kfWApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYWRkKG5hbWUsIGtpbmQpIHsKICAgICAgICBpZiAodGhpcy5fbm9kZXMuaGFzKG5hbWUpKSB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBmaWVsZDogJHtuYW1lfWApOwogICAgICAgIGNvbnN0IHJ0ID0gbmV3IE5vZGUoa2luZCk7CiAgICAgICAgdGhpcy5fbm9kZXMuc2V0KG5hbWUsIHJ0KTsKICAgICAgICB0aGlzLl9ub2RlT3JkZXIucHVzaChuYW1lKTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9CiAgICBjb3B5V2l0aFBhcmVudChwYXJlbnQpIHsKICAgICAgICBjb25zdCBub2RlcyA9IG5ldyBNYXAoKTsKICAgICAgICBjb25zdCBub2RlT3JkZXIgPSBbCiAgICAgICAgICAgIC4uLnRoaXMuX25vZGVPcmRlcgogICAgICAgIF07CiAgICAgICAgY29uc3QgYXJncyA9IG5ldyBNYXAoKTsKICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0aGlzLl9hcmdzLmVudHJpZXMoKSl7CiAgICAgICAgICAgIGFyZ3Muc2V0KGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhcmdPcmRlciA9IFsKICAgICAgICAgICAgLi4udGhpcy5fYXJnT3JkZXIKICAgICAgICBdOwogICAgICAgIGNvbnN0IHJ0ID0gbmV3IEdyYXBocWxRdWVyeShbCiAgICAgICAgICAgIHBhcmVudAogICAgICAgIF0sIG5vZGVzLCBub2RlT3JkZXIsIGFyZ3MsIGFyZ09yZGVyKTsKICAgICAgICBmb3IgKGNvbnN0IFtrZXkxLCBub2RlXSBvZiB0aGlzLl9ub2Rlcy5lbnRyaWVzKCkpewogICAgICAgICAgICBjb25zdCBuZXdOb2RlID0gbmV3IE5vZGUobm9kZS5raW5kKTsKICAgICAgICAgICAgaWYgKG5vZGUucXVlcnkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgbmV3UXVlcnkgPSBub2RlLnF1ZXJ5WzBdLmNvcHlXaXRoUGFyZW50KHJ0KTsKICAgICAgICAgICAgICAgIG5ld05vZGUucXVlcnkucHVzaChuZXdRdWVyeSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZXMuc2V0KGtleTEsIG5ld05vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcnQ7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tHZXQobWFwTmFtZSwgbWFwLCBrZXkpIHsKICAgIGNvbnN0IHJ0ID0gbWFwLmdldChrZXkpOwogICAgaWYgKCFydCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHttYXBOYW1lfS5rZXk6ICR7a2V5fWApOwogICAgcmV0dXJuIHJ0Owp9CnZhciBOb2RlS2luZDsKKGZ1bmN0aW9uKE5vZGVLaW5kKSB7CiAgICBOb2RlS2luZFtOb2RlS2luZFsiU2NhbGFyIl0gPSAxXSA9ICJTY2FsYXIiOwogICAgTm9kZUtpbmRbTm9kZUtpbmRbIk9iamVjdCJdID0gMl0gPSAiT2JqZWN0IjsKfSkoTm9kZUtpbmQgfHwgKE5vZGVLaW5kID0gewp9KSk7CmNsYXNzIE5vZGUgewogICAga2luZDsKICAgIHF1ZXJ5ID0gW107CiAgICBjb25zdHJ1Y3RvcihraW5kKXsKICAgICAgICB0aGlzLmtpbmQgPSBraW5kOwogICAgfQp9CmNsYXNzIENmR3FsQ2xpZW50IHsKICAgIHN0YXRpYyBERUJVRyA9IGZhbHNlOwogICAgc3RhdGljIFVSTF9UUkFOU0ZPUk1FUiA9ICh2KT0+dgogICAgOwogICAgcHJvZmlsZTsKICAgIGNvbnN0cnVjdG9yKHByb2ZpbGUpewogICAgICAgIHRoaXMucHJvZmlsZSA9IHByb2ZpbGU7CiAgICB9CiAgICBhc3luYyBnZXREdXJhYmxlT2JqZWN0UGVyaW9kaWNNZXRyaWNzQnlEYXRlKHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSkgewogICAgICAgIHJldHVybiBhd2FpdCBfZ2V0RHVyYWJsZU9iamVjdFBlcmlvZGljTWV0cmljc0J5RGF0ZSh0aGlzLnByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSk7CiAgICB9CiAgICBhc3luYyBnZXREdXJhYmxlT2JqZWN0U3RvcmFnZUJ5RGF0ZShzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgICAgICByZXR1cm4gYXdhaXQgX2dldER1cmFibGVPYmplY3RTdG9yYWdlQnlEYXRlKHRoaXMucHJvZmlsZSwgc3RhcnREYXRlSW5jbHVzaXZlLCBlbmREYXRlSW5jbHVzaXZlKTsKICAgIH0KICAgIGFzeW5jIGdldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZShzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgICAgICByZXR1cm4gYXdhaXQgX2dldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZSh0aGlzLnByb2ZpbGUsIHN0YXJ0RGF0ZUluY2x1c2l2ZSwgZW5kRGF0ZUluY2x1c2l2ZSk7CiAgICB9Cn0KYXN5bmMgZnVuY3Rpb24gcXVlcnkxKHByb2ZpbGUsIHF1ZXJ5Rm4sIHZhcmlhYmxlcykgewogICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICBjb25zdCBxID0gR3JhcGhxbFF1ZXJ5LmNyZWF0ZSgpLnNjYWxhcignY29zdCcpLm9iamVjdCgndmlld2VyJykuc2NhbGFyKCdidWRnZXQnKS5vYmplY3QoJ2FjY291bnRzJykuYXJnT2JqZWN0KCdmaWx0ZXInLCAnYWNjb3VudFRhZycsIGFjY291bnRJZCkuc2NhbGFyKCdhY2NvdW50VGFnJyk7CiAgICBxdWVyeUZuKHEpOwogICAgY29uc3QgcXVlcnkgPSBxLnRvcCgpLnRvU3RyaW5nKCk7CiAgICBpZiAoQ2ZHcWxDbGllbnQuREVCVUcpIGNvbnNvbGUubG9nKHF1ZXJ5KTsKICAgIGNvbnN0IHJlcU9iaiA9IHsKICAgICAgICBxdWVyeSwKICAgICAgICB2YXJpYWJsZXMKICAgIH07CiAgICBjb25zdCBib2R5ID0gSlNPTi5zdHJpbmdpZnkocmVxT2JqKTsKICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgIGNvbnN0IHVybCA9IENmR3FsQ2xpZW50LlVSTF9UUkFOU0ZPUk1FUignaHR0cHM6Ly9hcGkuY2xvdWRmbGFyZS5jb20vY2xpZW50L3Y0L2dyYXBocWwnKTsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCwgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JywKICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YXBpVG9rZW59YAogICAgICAgIH0sCiAgICAgICAgYm9keQogICAgfSk7CiAgICBjb25zdCBmZXRjaE1pbGxpcyA9IERhdGUubm93KCkgLSBzdGFydDsKICAgIGlmIChDZkdxbENsaWVudC5ERUJVRykgY29uc29sZS5sb2cocmVzKTsKICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHRocm93IG5ldyBFcnJvcihgQmFkIHJlcy5zdGF0dXM6ICR7cmVzLnN0YXR1c30sIGV4cGVjdGVkIDIwMCwgdGV4dD0ke2F3YWl0IHJlcy50ZXh0KCl9YCk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlcy5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyk7CiAgICBpZiAoY29udGVudFR5cGUgIT09ICdhcHBsaWNhdGlvbi9qc29uJykgdGhyb3cgbmV3IEVycm9yKGBCYWQgcmVzLmNvbnRlbnRUeXBlOiAke2NvbnRlbnRUeXBlfSwgZXhwZWN0ZWQgYXBwbGljYXRpb24vanNvbiwgZm91bmQgJHtjb250ZW50VHlwZX0sIHRleHQ9JHthd2FpdCByZXMudGV4dCgpfWApOwogICAgY29uc3QgcmVzT2JqID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIHJlc09iai5mZXRjaE1pbGxpcyA9IGZldGNoTWlsbGlzOwogICAgaWYgKENmR3FsQ2xpZW50LkRFQlVHKSBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXNPYmosIHVuZGVmaW5lZCwgMikpOwogICAgaWYgKGlzR3FsRXJyb3JSZXNwb25zZShyZXNPYmopKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc09iai5lcnJvcnMubWFwKGNvbXB1dGVHcWxFcnJvclN0cmluZykuam9pbignLCAnKSk7CiAgICB9CiAgICByZXR1cm4gcmVzT2JqOwp9CmZ1bmN0aW9uIGlzR3FsRXJyb3JSZXNwb25zZShvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmouZGF0YSA9PT0gbnVsbCAmJiBBcnJheS5pc0FycmF5KG9iai5lcnJvcnMpOwp9CmZ1bmN0aW9uIGNvbXB1dGVHcWxFcnJvclN0cmluZyhlcnJvcikgewogICAgY29uc3QgcGllY2VzID0gWwogICAgICAgIGVycm9yLm1lc3NhZ2UKICAgIF07CiAgICBpZiAoZXJyb3IucGF0aCkgcGllY2VzLnB1c2goYCgke2Vycm9yLnBhdGguam9pbignLycpfSlgKTsKICAgIGlmIChlcnJvci5leHRlbnNpb25zLmNvZGUpIHBpZWNlcy5wdXNoKGAoY29kZT0ke2Vycm9yLmV4dGVuc2lvbnMuY29kZX0pYCk7CiAgICByZXR1cm4gcGllY2VzLmpvaW4oJyAnKTsKfQphc3luYyBmdW5jdGlvbiBfZ2V0RHVyYWJsZU9iamVjdFBlcmlvZGljTWV0cmljc0J5RGF0ZShwcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgIGNvbnN0IHJlc09iaiA9IGF3YWl0IHF1ZXJ5MShwcm9maWxlLCAocSk9PnEub2JqZWN0KCdkdXJhYmxlT2JqZWN0c1BlcmlvZGljR3JvdXBzJykuYXJnTG9uZygnbGltaXQnLCAxMDAwMCkuYXJnUmF3KCdmaWx0ZXInLCBge2RhdGVfZ2VxOiAkc3RhcnQsIGRhdGVfbGVxOiAkZW5kfWApLmFyZ1Jhdygnb3JkZXJCeScsIGBbZGF0ZV9BU0NdYCkub2JqZWN0KCdkaW1lbnNpb25zJykuc2NhbGFyKCdkYXRlJykuc2NhbGFyKCduYW1lc3BhY2VJZCcpLmVuZCgpLm9iamVjdCgnbWF4Jykuc2NhbGFyKCdhY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucycpLmVuZCgpLm9iamVjdCgnc3VtJykuc2NhbGFyKCdhY3RpdmVUaW1lJykuc2NhbGFyKCdjcHVUaW1lJykuc2NhbGFyKCdleGNlZWRlZENwdUVycm9ycycpLnNjYWxhcignZXhjZWVkZWRNZW1vcnlFcnJvcnMnKS5zY2FsYXIoJ2ZhdGFsSW50ZXJuYWxFcnJvcnMnKS5zY2FsYXIoJ2luYm91bmRXZWJzb2NrZXRNc2dDb3VudCcpLnNjYWxhcignb3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCcpLnNjYWxhcignc3RvcmFnZURlbGV0ZXMnKS5zY2FsYXIoJ3N0b3JhZ2VSZWFkVW5pdHMnKS5zY2FsYXIoJ3N0b3JhZ2VXcml0ZVVuaXRzJykuc2NhbGFyKCdzdWJyZXF1ZXN0cycpCiAgICAsIHsKICAgICAgICBzdGFydDogc3RhcnREYXRlSW5jbHVzaXZlLAogICAgICAgIGVuZDogZW5kRGF0ZUluY2x1c2l2ZQogICAgfSk7CiAgICBjb25zdCBmZXRjaE1pbGxpcyA9IHJlc09iai5mZXRjaE1pbGxpczsKICAgIGNvbnN0IHJlcyA9IHJlc09iajsKICAgIGNvbnN0IGNvc3QgPSByZXMuZGF0YS5jb3N0OwogICAgY29uc3QgYnVkZ2V0ID0gcmVzLmRhdGEudmlld2VyLmJ1ZGdldDsKICAgIGNvbnN0IHJvd3MgPSBbXTsKICAgIGZvciAoY29uc3QgYWNjb3VudCBvZiByZXMuZGF0YS52aWV3ZXIuYWNjb3VudHMpewogICAgICAgIGNoZWNrRXF1YWwoJ2FjY291bnQuYWNjb3VudFRhZycsIGFjY291bnQuYWNjb3VudFRhZywgcHJvZmlsZS5hY2NvdW50SWQpOwogICAgICAgIGZvciAoY29uc3QgZ3JvdXAgb2YgYWNjb3VudC5kdXJhYmxlT2JqZWN0c1BlcmlvZGljR3JvdXBzKXsKICAgICAgICAgICAgY29uc3QgZGF0ZSA9IGdyb3VwLmRpbWVuc2lvbnMuZGF0ZTsKICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlSWQgPSBncm91cC5kaW1lbnNpb25zLm5hbWVzcGFjZUlkOwogICAgICAgICAgICBjb25zdCBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyA9IGdyb3VwLm1heC5hY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9uczsKICAgICAgICAgICAgY29uc3Qgc3VtQWN0aXZlVGltZSA9IGdyb3VwLnN1bS5hY3RpdmVUaW1lOwogICAgICAgICAgICBjb25zdCBzdW1DcHVUaW1lID0gZ3JvdXAuc3VtLmNwdVRpbWU7CiAgICAgICAgICAgIGNvbnN0IHN1bUV4Y2VlZGVkQ3B1RXJyb3JzID0gZ3JvdXAuc3VtLmV4Y2VlZGVkQ3B1RXJyb3JzOwogICAgICAgICAgICBjb25zdCBzdW1FeGNlZWRlZE1lbW9yeUVycm9ycyA9IGdyb3VwLnN1bS5leGNlZWRlZE1lbW9yeUVycm9yczsKICAgICAgICAgICAgY29uc3Qgc3VtRmF0YWxJbnRlcm5hbEVycm9ycyA9IGdyb3VwLnN1bS5mYXRhbEludGVybmFsRXJyb3JzOwogICAgICAgICAgICBjb25zdCBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgPSBncm91cC5zdW0uaW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50OwogICAgICAgICAgICBjb25zdCBzdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ID0gZ3JvdXAuc3VtLm91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ7CiAgICAgICAgICAgIGNvbnN0IHN1bVN0b3JhZ2VEZWxldGVzID0gZ3JvdXAuc3VtLnN0b3JhZ2VEZWxldGVzOwogICAgICAgICAgICBjb25zdCBzdW1TdG9yYWdlUmVhZFVuaXRzID0gZ3JvdXAuc3VtLnN0b3JhZ2VSZWFkVW5pdHM7CiAgICAgICAgICAgIGNvbnN0IHN1bVN0b3JhZ2VXcml0ZVVuaXRzID0gZ3JvdXAuc3VtLnN0b3JhZ2VXcml0ZVVuaXRzOwogICAgICAgICAgICBjb25zdCBzdW1TdWJyZXF1ZXN0cyA9IGdyb3VwLnN1bS5zdWJyZXF1ZXN0czsKICAgICAgICAgICAgcm93cy5wdXNoKHsKICAgICAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgICAgICBuYW1lc3BhY2VJZCwKICAgICAgICAgICAgICAgIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zLAogICAgICAgICAgICAgICAgc3VtQWN0aXZlVGltZSwKICAgICAgICAgICAgICAgIHN1bUNwdVRpbWUsCiAgICAgICAgICAgICAgICBzdW1FeGNlZWRlZENwdUVycm9ycywKICAgICAgICAgICAgICAgIHN1bUV4Y2VlZGVkTWVtb3J5RXJyb3JzLAogICAgICAgICAgICAgICAgc3VtRmF0YWxJbnRlcm5hbEVycm9ycywKICAgICAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgICAgICBzdW1TdG9yYWdlRGVsZXRlcywKICAgICAgICAgICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHMsCiAgICAgICAgICAgICAgICBzdW1TdG9yYWdlV3JpdGVVbml0cywKICAgICAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgaW5mbzogewogICAgICAgICAgICBmZXRjaE1pbGxpcywKICAgICAgICAgICAgY29zdCwKICAgICAgICAgICAgYnVkZ2V0CiAgICAgICAgfSwKICAgICAgICByb3dzCiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIF9nZXREdXJhYmxlT2JqZWN0U3RvcmFnZUJ5RGF0ZShwcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgIGNvbnN0IHJlc09iaiA9IGF3YWl0IHF1ZXJ5MShwcm9maWxlLCAocSk9PnEub2JqZWN0KCdkdXJhYmxlT2JqZWN0c1N0b3JhZ2VHcm91cHMnKS5hcmdMb25nKCdsaW1pdCcsIDEwMDAwKS5hcmdSYXcoJ2ZpbHRlcicsIGB7ZGF0ZV9nZXE6ICRzdGFydCwgZGF0ZV9sZXE6ICRlbmR9YCkuYXJnUmF3KCdvcmRlckJ5JywgYFtkYXRlX0FTQ11gKS5vYmplY3QoJ2RpbWVuc2lvbnMnKS5zY2FsYXIoJ2RhdGUnKS5lbmQoKS5vYmplY3QoJ21heCcpLnNjYWxhcignc3RvcmVkQnl0ZXMnKS5lbmQoKQogICAgLCB7CiAgICAgICAgc3RhcnQ6IHN0YXJ0RGF0ZUluY2x1c2l2ZSwKICAgICAgICBlbmQ6IGVuZERhdGVJbmNsdXNpdmUKICAgIH0pOwogICAgY29uc3QgZmV0Y2hNaWxsaXMgPSByZXNPYmouZmV0Y2hNaWxsaXM7CiAgICBjb25zdCByZXMgPSByZXNPYmo7CiAgICBjb25zdCBjb3N0ID0gcmVzLmRhdGEuY29zdDsKICAgIGNvbnN0IGJ1ZGdldCA9IHJlcy5kYXRhLnZpZXdlci5idWRnZXQ7CiAgICBjb25zdCByb3dzID0gW107CiAgICBmb3IgKGNvbnN0IGFjY291bnQgb2YgcmVzLmRhdGEudmlld2VyLmFjY291bnRzKXsKICAgICAgICBjaGVja0VxdWFsKCdhY2NvdW50LmFjY291bnRUYWcnLCBhY2NvdW50LmFjY291bnRUYWcsIHByb2ZpbGUuYWNjb3VudElkKTsKICAgICAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGFjY291bnQuZHVyYWJsZU9iamVjdHNTdG9yYWdlR3JvdXBzKXsKICAgICAgICAgICAgY29uc3QgZGF0ZSA9IGdyb3VwLmRpbWVuc2lvbnMuZGF0ZTsKICAgICAgICAgICAgY29uc3QgbWF4U3RvcmVkQnl0ZXMgPSBncm91cC5tYXguc3RvcmVkQnl0ZXM7CiAgICAgICAgICAgIHJvd3MucHVzaCh7CiAgICAgICAgICAgICAgICBkYXRlLAogICAgICAgICAgICAgICAgbWF4U3RvcmVkQnl0ZXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBpbmZvOiB7CiAgICAgICAgICAgIGZldGNoTWlsbGlzLAogICAgICAgICAgICBjb3N0LAogICAgICAgICAgICBidWRnZXQKICAgICAgICB9LAogICAgICAgIHJvd3MKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gX2dldER1cmFibGVPYmplY3RJbnZvY2F0aW9uc0J5RGF0ZShwcm9maWxlLCBzdGFydERhdGVJbmNsdXNpdmUsIGVuZERhdGVJbmNsdXNpdmUpIHsKICAgIGNvbnN0IHJlc09iaiA9IGF3YWl0IHF1ZXJ5MShwcm9maWxlLCAocSk9PnEub2JqZWN0KCdkdXJhYmxlT2JqZWN0c0ludm9jYXRpb25zQWRhcHRpdmVHcm91cHMnKS5hcmdMb25nKCdsaW1pdCcsIDEwMDAwKS5hcmdSYXcoJ2ZpbHRlcicsIGB7ZGF0ZV9nZXE6ICRzdGFydCwgZGF0ZV9sZXE6ICRlbmR9YCkuYXJnUmF3KCdvcmRlckJ5JywgYFtkYXRlX0FTQ11gKS5vYmplY3QoJ2RpbWVuc2lvbnMnKS5zY2FsYXIoJ2RhdGUnKS5zY2FsYXIoJ25hbWVzcGFjZUlkJykuZW5kKCkub2JqZWN0KCdhdmcnKS5zY2FsYXIoJ3NhbXBsZUludGVydmFsJykuZW5kKCkub2JqZWN0KCdzdW0nKS5zY2FsYXIoJ3JlcXVlc3RzJykuZW5kKCkKICAgICwgewogICAgICAgIHN0YXJ0OiBzdGFydERhdGVJbmNsdXNpdmUsCiAgICAgICAgZW5kOiBlbmREYXRlSW5jbHVzaXZlCiAgICB9KTsKICAgIGNvbnN0IGZldGNoTWlsbGlzID0gcmVzT2JqLmZldGNoTWlsbGlzOwogICAgY29uc3QgcmVzID0gcmVzT2JqOwogICAgY29uc3QgY29zdCA9IHJlcy5kYXRhLmNvc3Q7CiAgICBjb25zdCBidWRnZXQgPSByZXMuZGF0YS52aWV3ZXIuYnVkZ2V0OwogICAgY29uc3Qgcm93cyA9IFtdOwogICAgZm9yIChjb25zdCBhY2NvdW50IG9mIHJlcy5kYXRhLnZpZXdlci5hY2NvdW50cyl7CiAgICAgICAgY2hlY2tFcXVhbCgnYWNjb3VudC5hY2NvdW50VGFnJywgYWNjb3VudC5hY2NvdW50VGFnLCBwcm9maWxlLmFjY291bnRJZCk7CiAgICAgICAgZm9yIChjb25zdCBncm91cCBvZiBhY2NvdW50LmR1cmFibGVPYmplY3RzSW52b2NhdGlvbnNBZGFwdGl2ZUdyb3Vwcyl7CiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBncm91cC5kaW1lbnNpb25zLmRhdGU7CiAgICAgICAgICAgIGNvbnN0IG5hbWVzcGFjZUlkID0gZ3JvdXAuZGltZW5zaW9ucy5uYW1lc3BhY2VJZDsKICAgICAgICAgICAgY29uc3QgYXZnU2FtcGxlSW50ZXJ2YWwgPSBncm91cC5hdmcuc2FtcGxlSW50ZXJ2YWw7CiAgICAgICAgICAgIGNvbnN0IHN1bVJlcXVlc3RzID0gZ3JvdXAuc3VtLnJlcXVlc3RzOwogICAgICAgICAgICByb3dzLnB1c2goewogICAgICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgICAgIG5hbWVzcGFjZUlkLAogICAgICAgICAgICAgICAgYXZnU2FtcGxlSW50ZXJ2YWwsCiAgICAgICAgICAgICAgICBzdW1SZXF1ZXN0cwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGluZm86IHsKICAgICAgICAgICAgZmV0Y2hNaWxsaXMsCiAgICAgICAgICAgIGNvc3QsCiAgICAgICAgICAgIGJ1ZGdldAogICAgICAgIH0sCiAgICAgICAgcm93cwogICAgfTsKfQphc3luYyBmdW5jdGlvbiBjb21wdXRlRHVyYWJsZU9iamVjdHNDb3N0c1RhYmxlKGNsaWVudCwgb3B0cykgewogICAgY29uc3QgeyBsb29rYmFja0RheXMgIH0gPSBvcHRzOwogICAgY29uc3QgZW5kID0gdXRjQ3VycmVudERhdGUoKTsKICAgIGNvbnN0IHN0YXJ0ID0gYWRkRGF5c1RvRGF0ZShlbmQsIC1sb29rYmFja0RheXMpOwogICAgY29uc3QgW3N0b3JhZ2UsIHBlcmlvZGljLCBpbnZvY2F0aW9uc10gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICAgICAgY2xpZW50LmdldER1cmFibGVPYmplY3RTdG9yYWdlQnlEYXRlKHN0YXJ0LCBlbmQpLAogICAgICAgIGNsaWVudC5nZXREdXJhYmxlT2JqZWN0UGVyaW9kaWNNZXRyaWNzQnlEYXRlKHN0YXJ0LCBlbmQpLAogICAgICAgIGNsaWVudC5nZXREdXJhYmxlT2JqZWN0SW52b2NhdGlvbnNCeURhdGUoc3RhcnQsIGVuZCksIAogICAgXSk7CiAgICBjb25zdCBncWxSZXN1bHRJbmZvcyA9IHsKICAgICAgICAnc3RvcmFnZSc6IHN0b3JhZ2UuaW5mbywKICAgICAgICAncGVyaW9kaWMnOiBwZXJpb2RpYy5pbmZvLAogICAgICAgICdpbnZvY2F0aW9ucyc6IGludm9jYXRpb25zLmluZm8KICAgIH07CiAgICBjb25zdCByb3dzQnlOYW1lc3BhY2UgPSB7CiAgICB9OwogICAgY29uc3Qgcm93c0J5RGF0ZSA9IHsKICAgIH07CiAgICBmb3IgKGNvbnN0IHBSb3cgb2YgcGVyaW9kaWMucm93cyl7CiAgICAgICAgY29uc3QgeyBkYXRlICwgbmFtZXNwYWNlSWQgLCBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9ucyAsIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCAsIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQgLCBzdW1TdWJyZXF1ZXN0cyAsIHN1bUFjdGl2ZVRpbWUgLCBzdW1TdG9yYWdlUmVhZFVuaXRzICwgc3VtU3RvcmFnZVdyaXRlVW5pdHMgLCBzdW1TdG9yYWdlRGVsZXRlcyAsICB9ID0gcFJvdzsKICAgICAgICBsZXQgcm93cyA9IHJvd3NCeU5hbWVzcGFjZVtuYW1lc3BhY2VJZF07CiAgICAgICAgaWYgKCFyb3dzKSB7CiAgICAgICAgICAgIHJvd3MgPSBbXTsKICAgICAgICAgICAgcm93c0J5TmFtZXNwYWNlW25hbWVzcGFjZUlkXSA9IHJvd3M7CiAgICAgICAgfQogICAgICAgIGxldCBkYXRlUm93cyA9IHJvd3NCeURhdGVbZGF0ZV07CiAgICAgICAgaWYgKCFkYXRlUm93cykgewogICAgICAgICAgICBkYXRlUm93cyA9IFtdOwogICAgICAgICAgICByb3dzQnlEYXRlW2RhdGVdID0gZGF0ZVJvd3M7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsgc3VtUmVxdWVzdHMgIH0gPSBpbnZvY2F0aW9ucy5yb3dzLmZpbHRlcigodik9PnYuZGF0ZSA9PT0gZGF0ZSAmJiB2Lm5hbWVzcGFjZUlkID09PSBuYW1lc3BhY2VJZAogICAgICAgIClbMF0gfHwgewogICAgICAgICAgICBzdW1SZXF1ZXN0czogMAogICAgICAgIH07CiAgICAgICAgY29uc3QgcmVxdWVzdHNDb3N0ID0gc3VtUmVxdWVzdHMgLyAxMDAwMDAwICogMC4xNTsKICAgICAgICBjb25zdCB3ZWJzb2NrZXRzQ29zdCA9IHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCAvIDEwMDAwMDAgKiAwLjE1OwogICAgICAgIGNvbnN0IHN1YnJlcXVlc3RzQ29zdCA9IHN1bVN1YnJlcXVlc3RzIC8gMTAwMDAwMCAqIDAuMTU7CiAgICAgICAgY29uc3QgYWN0aXZlVGltZVNlY29uZHMgPSBzdW1BY3RpdmVUaW1lIC8gMTAwMCAvIDEwMDA7CiAgICAgICAgY29uc3QgYWN0aXZlR2JTZWNvbmRzID0gYWN0aXZlVGltZVNlY29uZHMgKiAxMjggLyAxMDI0OwogICAgICAgIGNvbnN0IGFjdGl2ZUNvc3QgPSBhY3RpdmVHYlNlY29uZHMgLyA0MDAwMDAgKiAxMi41OwogICAgICAgIGNvbnN0IHJlYWRVbml0c0Nvc3QgPSBzdW1TdG9yYWdlUmVhZFVuaXRzIC8gMTAwMDAwMCAqIDAuMjsKICAgICAgICBjb25zdCB3cml0ZVVuaXRzQ29zdCA9IHN1bVN0b3JhZ2VXcml0ZVVuaXRzIC8gMTAwMDAwMCAqIDE7CiAgICAgICAgY29uc3QgZGVsZXRlc0Nvc3QgPSBzdW1TdG9yYWdlRGVsZXRlcyAvIDEwMDAwMDAgKiAxOwogICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IHJlcXVlc3RzQ29zdCArIHdlYnNvY2tldHNDb3N0ICsgc3VicmVxdWVzdHNDb3N0ICsgYWN0aXZlQ29zdCArIHJlYWRVbml0c0Nvc3QgKyB3cml0ZVVuaXRzQ29zdCArIGRlbGV0ZXNDb3N0OwogICAgICAgIGNvbnN0IHJvdyA9IHsKICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgc3VtUmVxdWVzdHMsCiAgICAgICAgICAgIHJlcXVlc3RzQ29zdCwKICAgICAgICAgICAgbWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCwKICAgICAgICAgICAgd2Vic29ja2V0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzLAogICAgICAgICAgICBzdWJyZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIGFjdGl2ZUdiU2Vjb25kcywKICAgICAgICAgICAgYWN0aXZlQ29zdCwKICAgICAgICAgICAgc3VtU3RvcmFnZVJlYWRVbml0cywKICAgICAgICAgICAgcmVhZFVuaXRzQ29zdCwKICAgICAgICAgICAgc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgIHdyaXRlVW5pdHNDb3N0LAogICAgICAgICAgICBzdW1TdG9yYWdlRGVsZXRlcywKICAgICAgICAgICAgZGVsZXRlc0Nvc3QsCiAgICAgICAgICAgIHRvdGFsQ29zdAogICAgICAgIH07CiAgICAgICAgcm93cy5wdXNoKHJvdyk7CiAgICAgICAgZGF0ZVJvd3MucHVzaChyb3cpOwogICAgfQogICAgY29uc3QgbmFtZXNwYWNlVGFibGVzID0gewogICAgfTsKICAgIGZvciAoY29uc3QgW25hbWVzcGFjZUlkLCByb3dzXSBvZiBPYmplY3QuZW50cmllcyhyb3dzQnlOYW1lc3BhY2UpKXsKICAgICAgICBjb25zdCB0b3RhbFJvdyA9IGNvbXB1dGVUb3RhbFJvdygnJywgcm93cyk7CiAgICAgICAgY29uc3QgZXN0aW1hdGVkMzBEYXlSb3cgPSBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3cocm93cyk7CiAgICAgICAgbmFtZXNwYWNlVGFibGVzW25hbWVzcGFjZUlkXSA9IHsKICAgICAgICAgICAgcm93cywKICAgICAgICAgICAgZXN0aW1hdGVkMzBEYXlSb3csCiAgICAgICAgICAgIHRvdGFsUm93CiAgICAgICAgfTsKICAgIH0KICAgIGNvbnN0IGFjY291bnRSb3dzID0gW107CiAgICBmb3IgKGNvbnN0IFtkYXRlLCBkYXRlUm93c10gb2YgT2JqZWN0LmVudHJpZXMocm93c0J5RGF0ZSkpewogICAgICAgIGNvbnN0IHsgbWF4U3RvcmVkQnl0ZXMgIH0gPSBzdG9yYWdlLnJvd3MuZmlsdGVyKCh2KT0+di5kYXRlID09PSBkYXRlCiAgICAgICAgKVswXSB8fCB7CiAgICAgICAgICAgIG1heFN0b3JlZEJ5dGVzOiAwCiAgICAgICAgfTsKICAgICAgICBjb25zdCBzdG9yYWdlR2IgPSBtYXhTdG9yZWRCeXRlcyAvIDEwMjQgLyAxMDI0IC8gMTAyNDsKICAgICAgICBjb25zdCBzdG9yYWdlQ29zdCA9IHN0b3JhZ2VHYiAqIDAuMiAvIDMwOwogICAgICAgIGFjY291bnRSb3dzLnB1c2goY29tcHV0ZVRvdGFsUm93KGRhdGUsIGRhdGVSb3dzLCB7CiAgICAgICAgICAgIHN0b3JhZ2VHYiwKICAgICAgICAgICAgc3RvcmFnZUNvc3QKICAgICAgICB9KSk7CiAgICB9CiAgICBjb25zdCBzdG9yYWdlQ29zdCA9IGFjY291bnRSb3dzLm1hcCgodik9PnYuc3RvcmFnZUNvc3QgfHwgMAogICAgKS5yZWR1Y2UoKGEsIGIpPT5hICsgYgogICAgKTsKICAgIGNvbnN0IGFjY291bnRPcHRzID0gewogICAgICAgIHN0b3JhZ2VHYjogMCwKICAgICAgICBzdG9yYWdlQ29zdAogICAgfTsKICAgIGNvbnN0IHRvdGFsUm93ID0gY29tcHV0ZVRvdGFsUm93KCcnLCBhY2NvdW50Um93cywgYWNjb3VudE9wdHMpOwogICAgY29uc3QgZXN0aW1hdGVkMzBEYXlSb3cgPSBjb21wdXRlRXN0aW1hdGVkMzBEYXlSb3coYWNjb3VudFJvd3MsIGFjY291bnRPcHRzKTsKICAgIGNvbnN0IGFjY291bnRUYWJsZSA9IHsKICAgICAgICByb3dzOiBhY2NvdW50Um93cywKICAgICAgICBlc3RpbWF0ZWQzMERheVJvdywKICAgICAgICB0b3RhbFJvdwogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgYWNjb3VudFRhYmxlLAogICAgICAgIG5hbWVzcGFjZVRhYmxlcywKICAgICAgICBncWxSZXN1bHRJbmZvcwogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlVG90YWxSb3coZGF0ZSwgcm93cywgb3B0cykgewogICAgbGV0IGNvbXB1dGVkU3RvcmFnZUNvc3QgPSBmYWxzZTsKICAgIGNvbnN0IGNvbXB1dGVTdG9yYWdlQ29zdE9uY2UgPSAoKT0+ewogICAgICAgIGNvbnN0IHJ0ID0gIWNvbXB1dGVkU3RvcmFnZUNvc3QgPyBvcHRzPy5zdG9yYWdlQ29zdCB8fCAwIDogMDsKICAgICAgICBjb21wdXRlZFN0b3JhZ2VDb3N0ID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9OwogICAgcmV0dXJuIHJvd3MucmVkdWNlKChsaHMsIHJocyk9Pih7CiAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgIHN1bVJlcXVlc3RzOiBsaHMuc3VtUmVxdWVzdHMgKyByaHMuc3VtUmVxdWVzdHMsCiAgICAgICAgICAgIHJlcXVlc3RzQ29zdDogbGhzLnJlcXVlc3RzQ29zdCArIHJocy5yZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIG1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zOiBsaHMubWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMgKyByaHMubWF4QWN0aXZlV2Vic29ja2V0Q29ubmVjdGlvbnMsCiAgICAgICAgICAgIHN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudDogbGhzLnN1bUluYm91bmRXZWJzb2NrZXRNc2dDb3VudCArIHJocy5zdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IGxocy5zdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ICsgcmhzLnN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQsCiAgICAgICAgICAgIHdlYnNvY2tldHNDb3N0OiBsaHMud2Vic29ja2V0c0Nvc3QgKyByaHMud2Vic29ja2V0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN1YnJlcXVlc3RzOiBsaHMuc3VtU3VicmVxdWVzdHMgKyByaHMuc3VtU3VicmVxdWVzdHMsCiAgICAgICAgICAgIHN1YnJlcXVlc3RzQ29zdDogbGhzLnN1YnJlcXVlc3RzQ29zdCArIHJocy5zdWJyZXF1ZXN0c0Nvc3QsCiAgICAgICAgICAgIGFjdGl2ZUdiU2Vjb25kczogbGhzLmFjdGl2ZUdiU2Vjb25kcyArIHJocy5hY3RpdmVHYlNlY29uZHMsCiAgICAgICAgICAgIGFjdGl2ZUNvc3Q6IGxocy5hY3RpdmVDb3N0ICsgcmhzLmFjdGl2ZUNvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHM6IGxocy5zdW1TdG9yYWdlUmVhZFVuaXRzICsgcmhzLnN1bVN0b3JhZ2VSZWFkVW5pdHMsCiAgICAgICAgICAgIHJlYWRVbml0c0Nvc3Q6IGxocy5yZWFkVW5pdHNDb3N0ICsgcmhzLnJlYWRVbml0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VXcml0ZVVuaXRzOiBsaHMuc3VtU3RvcmFnZVdyaXRlVW5pdHMgKyByaHMuc3VtU3RvcmFnZVdyaXRlVW5pdHMsCiAgICAgICAgICAgIHdyaXRlVW5pdHNDb3N0OiBsaHMud3JpdGVVbml0c0Nvc3QgKyByaHMud3JpdGVVbml0c0Nvc3QsCiAgICAgICAgICAgIHN1bVN0b3JhZ2VEZWxldGVzOiBsaHMuc3VtU3RvcmFnZURlbGV0ZXMgKyByaHMuc3VtU3RvcmFnZURlbGV0ZXMsCiAgICAgICAgICAgIGRlbGV0ZXNDb3N0OiBsaHMuZGVsZXRlc0Nvc3QgKyByaHMuZGVsZXRlc0Nvc3QsCiAgICAgICAgICAgIHN0b3JhZ2VHYjogb3B0cz8uc3RvcmFnZUdiLAogICAgICAgICAgICBzdG9yYWdlQ29zdDogb3B0cz8uc3RvcmFnZUNvc3QsCiAgICAgICAgICAgIHRvdGFsQ29zdDogbGhzLnRvdGFsQ29zdCArIHJocy50b3RhbENvc3QgKyBjb21wdXRlU3RvcmFnZUNvc3RPbmNlKCkKICAgICAgICB9KQogICAgKTsKfQpmdW5jdGlvbiBtdWx0aXBseVJvdyhyb3csIG11bHRpcGxpZXIpIHsKICAgIHJldHVybiB7CiAgICAgICAgZGF0ZTogJycsCiAgICAgICAgc3VtUmVxdWVzdHM6IHJvdy5zdW1SZXF1ZXN0cyAqIG11bHRpcGxpZXIsCiAgICAgICAgcmVxdWVzdHNDb3N0OiByb3cucmVxdWVzdHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBtYXhBY3RpdmVXZWJzb2NrZXRDb25uZWN0aW9uczogcm93Lm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zICogbXVsdGlwbGllciwKICAgICAgICBzdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IHJvdy5zdW1JbmJvdW5kV2Vic29ja2V0TXNnQ291bnQgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bU91dGJvdW5kV2Vic29ja2V0TXNnQ291bnQ6IHJvdy5zdW1PdXRib3VuZFdlYnNvY2tldE1zZ0NvdW50ICogbXVsdGlwbGllciwKICAgICAgICB3ZWJzb2NrZXRzQ29zdDogcm93LndlYnNvY2tldHNDb3N0ICogbXVsdGlwbGllciwKICAgICAgICBzdW1TdWJyZXF1ZXN0czogcm93LnN1bVN1YnJlcXVlc3RzICogbXVsdGlwbGllciwKICAgICAgICBzdWJyZXF1ZXN0c0Nvc3Q6IHJvdy5zdWJyZXF1ZXN0c0Nvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIGFjdGl2ZUdiU2Vjb25kczogcm93LmFjdGl2ZUdiU2Vjb25kcyAqIG11bHRpcGxpZXIsCiAgICAgICAgYWN0aXZlQ29zdDogcm93LmFjdGl2ZUNvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHN1bVN0b3JhZ2VSZWFkVW5pdHM6IHJvdy5zdW1TdG9yYWdlUmVhZFVuaXRzICogbXVsdGlwbGllciwKICAgICAgICByZWFkVW5pdHNDb3N0OiByb3cucmVhZFVuaXRzQ29zdCAqIG11bHRpcGxpZXIsCiAgICAgICAgc3VtU3RvcmFnZVdyaXRlVW5pdHM6IHJvdy5zdW1TdG9yYWdlV3JpdGVVbml0cyAqIG11bHRpcGxpZXIsCiAgICAgICAgd3JpdGVVbml0c0Nvc3Q6IHJvdy53cml0ZVVuaXRzQ29zdCAqIG11bHRpcGxpZXIsCiAgICAgICAgc3VtU3RvcmFnZURlbGV0ZXM6IHJvdy5zdW1TdG9yYWdlRGVsZXRlcyAqIG11bHRpcGxpZXIsCiAgICAgICAgZGVsZXRlc0Nvc3Q6IHJvdy5kZWxldGVzQ29zdCAqIG11bHRpcGxpZXIsCiAgICAgICAgc3RvcmFnZUdiOiByb3cuc3RvcmFnZUdiID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiByb3cuc3RvcmFnZUdiICogbXVsdGlwbGllciwKICAgICAgICBzdG9yYWdlQ29zdDogcm93LnN0b3JhZ2VDb3N0ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiByb3cuc3RvcmFnZUNvc3QgKiBtdWx0aXBsaWVyLAogICAgICAgIHRvdGFsQ29zdDogcm93LnRvdGFsQ29zdCAqIG11bHRpcGxpZXIKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUVzdGltYXRlZDMwRGF5Um93KHJvd3MsIG9wdHMpIHsKICAgIGlmIChyb3dzLmxlbmd0aCA8PSAxKSByZXR1cm4gdW5kZWZpbmVkOwogICAgY29uc3Qgc3VtID0gY29tcHV0ZVRvdGFsUm93KCcnLCByb3dzLnNsaWNlKDAsIC0xKSwgb3B0cyk7CiAgICBjb25zdCBkYXlzID0gcm93cy5sZW5ndGggLSAxOwogICAgcmV0dXJuIG11bHRpcGx5Um93KHN1bSwgMzAgLyBkYXlzKTsKfQpmdW5jdGlvbiB1dGNDdXJyZW50RGF0ZSgpIHsKICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3Vic3RyaW5nKDAsIDEwKTsKfQpmdW5jdGlvbiBhZGREYXlzVG9EYXRlKGRhdGUsIGRheXMpIHsKICAgIGNvbnN0IGQgPSBuZXcgRGF0ZShgJHtkYXRlfVQwMDowMDowMFpgKTsKICAgIHJldHVybiBuZXcgRGF0ZShkLmdldEZ1bGxZZWFyKCksIGQuZ2V0TW9udGgoKSwgZC5nZXREYXRlKCkgKyBkYXlzLCBkLmdldEhvdXJzKCksIGQuZ2V0TWludXRlcygpLCBkLmdldFNlY29uZHMoKSwgZC5nZXRNaWxsaXNlY29uZHMoKSkudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMTApOwp9CmNsYXNzIFdlYnRhaWxBcHBWTSB7CiAgICBfcHJvZmlsZXMgPSBbXTsKICAgIGdldCBwcm9maWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnByb2ZpbGVzIDogdGhpcy5fcHJvZmlsZXM7CiAgICB9CiAgICBnZXQgcmVhbFByb2ZpbGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wcm9maWxlczsKICAgIH0KICAgIF9zZWxlY3RlZFByb2ZpbGVJZDsKICAgIGdldCBzZWxlY3RlZFByb2ZpbGVJZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnNlbGVjdGVkUHJvZmlsZUlkIDogdGhpcy5fc2VsZWN0ZWRQcm9maWxlSWQ7CiAgICB9CiAgICBzZXQgc2VsZWN0ZWRQcm9maWxlSWQodmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgewogICAgICAgICAgICBEZW1vTW9kZS5zZXRTZWxlY3RlZFByb2ZpbGVJZCh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID09PSB2YWx1ZSkgcmV0dXJuOwogICAgICAgIHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID0gdmFsdWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9maWxlSWQgPSB2YWx1ZTsKICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5maW5kU2NyaXB0cygpOwogICAgfQogICAgX2FuYWx5dGljcyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAnZHVyYWJsZS1vYmplY3RzJywKICAgICAgICAgICAgdGV4dDogJ0R1cmFibGUgT2JqZWN0cycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnRGFpbHkgbWV0cmljcyBhbmQgYXNzb2NpYXRlZCBjb3N0cycKICAgICAgICB9CiAgICBdOwogICAgZ2V0IGFuYWx5dGljcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYW5hbHl0aWNzOwogICAgfQogICAgX3NlbGVjdGVkQW5hbHl0aWNJZDsKICAgIGdldCBzZWxlY3RlZEFuYWx5dGljSWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkQW5hbHl0aWNJZDsKICAgIH0KICAgIGFuYWx5dGljc1N0YXRlID0gewogICAgICAgIHF1ZXJ5aW5nOiBmYWxzZQogICAgfTsKICAgIF9zY3JpcHRzID0gW107CiAgICBnZXQgc2NyaXB0cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnNjcmlwdHMgOiB0aGlzLl9zY3JpcHRzOwogICAgfQogICAgX3NlbGVjdGVkU2NyaXB0SWRzID0gbmV3IFNldCgpOwogICAgZ2V0IHNlbGVjdGVkU2NyaXB0SWRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmRlbW9Nb2RlID8gRGVtb01vZGUuc2VsZWN0ZWRTY3JpcHRJZHMgOiB0aGlzLl9zZWxlY3RlZFNjcmlwdElkczsKICAgIH0KICAgIHNldCBzZWxlY3RlZFNjcmlwdElkcyhzY3JpcHRJZHMpIHsKICAgICAgICBpZiAodGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5fc2VsZWN0ZWRBbmFseXRpY0lkID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSB7CiAgICAgICAgICAgIERlbW9Nb2RlLnNldFNlbGVjdGVkU2NyaXB0SWRzKHNjcmlwdElkcyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHNldEVxdWFsKHRoaXMuX3NlbGVjdGVkU2NyaXB0SWRzLCBzY3JpcHRJZHMpKSByZXR1cm47CiAgICAgICAgdGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHMgPSBuZXcgU2V0KHNjcmlwdElkcyk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnNlbGVjdGVkUHJvZmlsZUlkICYmIHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgaWYgKHByb2ZpbGUpIHsKICAgICAgICAgICAgcHJvZmlsZS5zZWxlY3RlZFNjcmlwdElkcyA9IFsKICAgICAgICAgICAgICAgIC4uLnNjcmlwdElkcwogICAgICAgICAgICBdOwogICAgICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2V0VGFpbHMoKTsKICAgIH0KICAgIHByb2ZpbGVGb3JtID0gbmV3IFByb2ZpbGVGb3JtVk0oKTsKICAgIGZpbHRlckZvcm0gPSBuZXcgRmlsdGVyRm9ybVZNKCk7CiAgICBmaWx0ZXIgPSB7CiAgICB9OwogICAgZXh0cmFGaWVsZHMgPSBbXTsKICAgIF90YWlscyA9IG5ldyBTZXQoKTsKICAgIGdldCB0YWlscygpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZW1vTW9kZSA/IERlbW9Nb2RlLnRhaWxzIDogdGhpcy5fdGFpbHM7CiAgICB9CiAgICBzZXQgdGFpbHModGFpbHMpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgRGVtb01vZGUudGFpbHMgPSB0YWlsczsKICAgICAgICB0aGlzLl90YWlscyA9IHRhaWxzOwogICAgfQogICAgd2VsY29tZVNob3dpbmcgPSBmYWxzZTsKICAgIGFib3V0U2hvd2luZyA9IGZhbHNlOwogICAgc3RhdGUgPSBsb2FkU3RhdGUoKTsKICAgIHRhaWxDb250cm9sbGVyOwogICAgdGFpbENvbnRyb2xsZXJDYWxsYmFja3M7CiAgICBxcHNDb250cm9sbGVyOwogICAgZGVtb01vZGUgPSBmYWxzZTsKICAgIG9uQ2hhbmdlID0gKCk9PnsKICAgIH07CiAgICBsb2dnZXIgPSAoKT0+ewogICAgfTsKICAgIG9uUmVzZXRPdXRwdXQgPSAoKT0+ewogICAgfTsKICAgIG9uUXBzQ2hhbmdlID0gKCk9PnsKICAgIH07CiAgICBjb25zdHJ1Y3RvcigpewogICAgICAgIGNvbnN0IGRpcyA9IHRoaXM7CiAgICAgICAgdGhpcy5xcHNDb250cm9sbGVyID0gbmV3IFFwc0NvbnRyb2xsZXIoMjAsIHsKICAgICAgICAgICAgb25RcHNDaGFuZ2VkIChxcHMpIHsKICAgICAgICAgICAgICAgIGlmIChkaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGRpcy5vblFwc0NoYW5nZShxcHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgbG9nVGFpbHNDaGFuZ2UgPSAoYWN0aW9uLCB0YWlsS2V5cyk9PnsKICAgICAgICAgICAgaWYgKHRhaWxLZXlzLnNpemUgPiAwKSB0aGlzLmxvZ1dpdGhQcmVmaXgoYCR7YWN0aW9ufSAke1sKICAgICAgICAgICAgICAgIC4uLnRhaWxLZXlzCiAgICAgICAgICAgIF0ubWFwKCh2KT0+dW5wYWNrVGFpbEtleSh2KS5zY3JpcHRJZAogICAgICAgICAgICApLnNvcnQoKS5qb2luKCcsICcpfWApOwogICAgICAgIH07CiAgICAgICAgY29uc3QgbG9nV2l0aFByZWZpeCA9IHRoaXMubG9nV2l0aFByZWZpeC5iaW5kKHRoaXMpOwogICAgICAgIGNvbnN0IHZlcmJvc2VXaXRoUHJlZml4ID0gdGhpcy52ZXJib3NlV2l0aFByZWZpeC5iaW5kKHRoaXMpOwogICAgICAgIGNvbnN0IGNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgb25UYWlsQ3JlYXRpbmcgKF9hY2NvdW50SWQsIHNjcmlwdElkKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgQ3JlYXRpbmcgdGFpbCBmb3IgJHtzY3JpcHRJZH0uLi5gKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ3JlYXRlZCAoX2FjY291bnRJZCwgc2NyaXB0SWQsIHRvb2tNaWxsaXMsIHRhaWwpIHsKICAgICAgICAgICAgICAgIHZlcmJvc2VXaXRoUHJlZml4KGBDcmVhdGVkIHRhaWwgZm9yICR7c2NyaXB0SWR9IGluICR7dG9va01pbGxpc31tcywgJHtKU09OLnN0cmluZ2lmeSh0YWlsKX1gKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbk9wZW4gKF9hY2NvdW50SWQsIHNjcmlwdElkLCBfdGltZVN0YW1wLCB0b29rTWlsbGlzKSB7CiAgICAgICAgICAgICAgICB2ZXJib3NlV2l0aFByZWZpeChgT3BlbmVkIHRhaWwgZm9yICR7c2NyaXB0SWR9IGluICR7dG9va01pbGxpc31tc2ApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uQ2xvc2UgKGFjY291bnRJZCwgc2NyaXB0SWQsIHRpbWVTdGFtcCwgY29kZSwgcmVhc29uLCB3YXNDbGVhbikgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29uVGFpbENvbm5lY3Rpb25DbG9zZScsIHsKICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQsCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0SWQsCiAgICAgICAgICAgICAgICAgICAgdGltZVN0YW1wLAogICAgICAgICAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgICAgICAgICAgcmVhc29uLAogICAgICAgICAgICAgICAgICAgIHdhc0NsZWFuCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHZlcmJvc2VXaXRoUHJlZml4KGBDbG9zZWQgdGFpbCBmb3IgJHtzY3JpcHRJZH0sICR7SlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgICAgICAgICAgcmVhc29uLAogICAgICAgICAgICAgICAgICAgIHdhc0NsZWFuCiAgICAgICAgICAgICAgICB9KX1gKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25UYWlsQ29ubmVjdGlvbkVycm9yIChhY2NvdW50SWQsIHNjcmlwdElkLCB0aW1lU3RhbXAsIGVycm9ySW5mbykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29uVGFpbENvbm5lY3Rpb25FcnJvcicsIHsKICAgICAgICAgICAgICAgICAgICBhY2NvdW50SWQsCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0SWQsCiAgICAgICAgICAgICAgICAgICAgdGltZVN0YW1wLAogICAgICAgICAgICAgICAgICAgIGVycm9ySW5mbwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBsb2dXaXRoUHJlZml4KGBFcnJvciBpbiB0YWlsIGZvciAke3NjcmlwdElkfWAsIHsKICAgICAgICAgICAgICAgICAgICBlcnJvckluZm8KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uTWVzc2FnZSAoX2FjY291bnRJZCwgX3NjcmlwdElkLCBfdGltZVN0YW1wLCBtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBpZiAoY29tcHV0ZU1lc3NhZ2VQYXNzZXNGaWx0ZXIobWVzc2FnZSwgZGlzLmZpbHRlcikpIHsKICAgICAgICAgICAgICAgICAgICBkdW1wTWVzc2FnZVByZXR0eShtZXNzYWdlLCBkaXMubG9nZ2VyLCBkaXMuY29tcHV0ZUFkZGl0aW9uYWxMb2dzKG1lc3NhZ2UpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChkaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGRpcy5xcHNDb250cm9sbGVyLmFkZEV2ZW50KG1lc3NhZ2UuZXZlbnRUaW1lc3RhbXApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxDb25uZWN0aW9uVW5wYXJzZWRNZXNzYWdlIChfYWNjb3VudElkLCBzY3JpcHRJZCwgX3RpbWVTdGFtcCwgbWVzc2FnZSwgcGFyc2VFcnJvcikgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2cobWVzc2FnZSk7CiAgICAgICAgICAgICAgICBsb2dXaXRoUHJlZml4KGBVbnBhcnNlZCBtZXNzYWdlIGluIHRhaWwgZm9yICR7c2NyaXB0SWR9YCwgcGFyc2VFcnJvci5zdGFjayB8fCBwYXJzZUVycm9yLm1lc3NhZ2UpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxzQ2hhbmdlZCAodGFpbHMpIHsKICAgICAgICAgICAgICAgIGlmIChzZXRFcXVhbChkaXMudGFpbHMsIHRhaWxzKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlZCA9IHNldFN1YnRyYWN0KGRpcy50YWlscywgdGFpbHMpOwogICAgICAgICAgICAgICAgbG9nVGFpbHNDaGFuZ2UoJ1VudGFpbGluZycsIHJlbW92ZWQpOwogICAgICAgICAgICAgICAgY29uc3QgYWRkZWQgPSBzZXRTdWJ0cmFjdCh0YWlscywgZGlzLnRhaWxzKTsKICAgICAgICAgICAgICAgIGxvZ1RhaWxzQ2hhbmdlKCdUYWlsaW5nJywgYWRkZWQpOwogICAgICAgICAgICAgICAgZGlzLnRhaWxzID0gdGFpbHM7CiAgICAgICAgICAgICAgICBkaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25OZXR3b3JrU3RhdHVzQ2hhbmdlZCAob25saW5lKSB7CiAgICAgICAgICAgICAgICBpZiAob25saW5lKSB7CiAgICAgICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeCgnJWNPTkxJTkUlYycsICdjb2xvcjogZ3JlZW4nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbG9nV2l0aFByZWZpeCgnJWNPRkZMSU5FJWMnLCAnY29sb3I6IHJlZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBvblRhaWxGYWlsZWRUb1N0YXJ0IChfYWNjb3VudElkLCBzY3JpcHRJZCwgdHJpZ2dlciwgZXJyb3IpIHsKICAgICAgICAgICAgICAgIHZlcmJvc2VXaXRoUHJlZml4KGBUYWlsIGZvciAke3NjcmlwdElkfSBmYWlsZWQgdG8gc3RhcnQgKCR7dHJpZ2dlcn0pOiAke2Vycm9yLm5hbWV9ICR7ZXJyb3IubWVzc2FnZX1gKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgY29uc3Qgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcyA9IEFwcENvbnN0YW50cy5XRUJTT0NLRVRfUElOR19JTlRFUlZBTF9TRUNPTkRTOwogICAgICAgIGNvbnN0IGluYWN0aXZlVGFpbFNlY29uZHMgPSBBcHBDb25zdGFudHMuSU5BQ1RJVkVfVEFJTF9TRUNPTkRTOwogICAgICAgIHRoaXMudGFpbENvbnRyb2xsZXIgPSBuZXcgVGFpbENvbnRyb2xsZXIobmV3IFN3aXRjaGFibGVUYWlsQ29udHJvbGxlckNhbGxiYWNrcyhjYWxsYmFja3MsICgpPT4hdGhpcy5kZW1vTW9kZQogICAgICAgICksIHsKICAgICAgICAgICAgd2Vic29ja2V0UGluZ0ludGVydmFsU2Vjb25kcywKICAgICAgICAgICAgaW5hY3RpdmVUYWlsU2Vjb25kcwogICAgICAgIH0pOwogICAgICAgIHRoaXMudGFpbENvbnRyb2xsZXJDYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5leHRyYUZpZWxkcyA9IFsKICAgICAgICAgICAgLi4udGhpcy5zdGF0ZS5leHRyYUZpZWxkcyB8fCBbXQogICAgICAgIF07CiAgICAgICAgdGhpcy5maWx0ZXIgPSB0aGlzLnN0YXRlLmZpbHRlciB8fCB7CiAgICAgICAgfTsKICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgc2F2ZTogZmFsc2UKICAgICAgICB9KTsKICAgIH0KICAgIHN0YXJ0KCkgewogICAgICAgIHRoaXMucmVsb2FkUHJvZmlsZXMoKTsKICAgICAgICB0aGlzLnJlY29tcHV0ZVdlbGNvbWVTaG93aW5nKCk7CiAgICAgICAgdGhpcy5wZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpOwogICAgfQogICAgbmV3UHJvZmlsZSgpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgewogICAgICAgICAgICBpZiAodGhpcy53ZWxjb21lU2hvd2luZykgewogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMucHJvZmlsZUZvcm0ucHJvZmlsZUlkID0gZ2VuZXJhdGVVdWlkKCk7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnRpdGxlID0gJ05ldyBQcm9maWxlJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSB0aGlzLl9wcm9maWxlcy5sZW5ndGggPT09IDAgPyAnZGVmYXVsdCcgOiBgcHJvZmlsZSR7dGhpcy5fcHJvZmlsZXMubGVuZ3RoICsgMX1gOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5hcGlUb2tlbiA9ICcnOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA9IGZhbHNlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBlZGl0UHJvZmlsZShwcm9maWxlSWQpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLnN0YXRlLnByb2ZpbGVzW3Byb2ZpbGVJZF07CiAgICAgICAgaWYgKCFwcm9maWxlKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgJHtwcm9maWxlSWR9IG5vdCBmb3VuZGApOwogICAgICAgIHRoaXMuX3NlbGVjdGVkUHJvZmlsZUlkID0gcHJvZmlsZUlkOwogICAgICAgIGNvbnN0IHsgbmFtZSAsIGFjY291bnRJZCAsIGFwaVRva2VuICB9ID0gcHJvZmlsZTsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCA9IHByb2ZpbGVJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0udGl0bGUgPSAnRWRpdCBQcm9maWxlJzsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYWNjb3VudElkID0gYWNjb3VudElkOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSBhcGlUb2tlbjsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmRlbGV0ZVZpc2libGUgPSB0cnVlOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJyc7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5jb21wdXRlU2F2ZUVuYWJsZWQoKTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBkZWxldGVQcm9maWxlKHByb2ZpbGVJZCkgewogICAgICAgIGNvbnNvbGUubG9nKCdkZWxldGUgcHJvZmlsZScsIHByb2ZpbGVJZCk7CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBpZiAoIXByb2ZpbGUpIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSAke3Byb2ZpbGVJZH0gbm90IGZvdW5kYCk7CiAgICAgICAgZGVsZXRlIHRoaXMuc3RhdGUucHJvZmlsZXNbcHJvZmlsZUlkXTsKICAgICAgICBzYXZlU3RhdGUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5wcm9maWxlRm9ybS5zaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5yZWxvYWRQcm9maWxlcygpOwogICAgICAgIHRoaXMucmVjb21wdXRlV2VsY29tZVNob3dpbmcoKTsKICAgICAgICB0aGlzLnBlcmZvcm1Jbml0aWFsU2VsZWN0aW9uKCk7CiAgICB9CiAgICBjYW5jZWxQcm9maWxlKCkgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVOYW1lKG5hbWUpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uY29tcHV0ZVNhdmVFbmFibGVkKCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2V0UHJvZmlsZUFjY291bnRJZChhY2NvdW50SWQpIHsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmFjY291bnRJZCA9IGFjY291bnRJZDsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNldFByb2ZpbGVBcGlUb2tlbihhcGlUb2tlbikgewogICAgICAgIHRoaXMucHJvZmlsZUZvcm0uYXBpVG9rZW4gPSBhcGlUb2tlbjsKICAgICAgICB0aGlzLnByb2ZpbGVGb3JtLmNvbXB1dGVTYXZlRW5hYmxlZCgpOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNhdmVQcm9maWxlKCkgewogICAgICAgIGNvbnN0IHsgcHJvZmlsZUZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHsgcHJvZmlsZUlkICB9ID0gcHJvZmlsZUZvcm07CiAgICAgICAgY29uc3QgbmV3UHJvZmlsZSA9IHsKICAgICAgICAgICAgbmFtZTogcHJvZmlsZUZvcm0ubmFtZS50cmltKCksCiAgICAgICAgICAgIGFjY291bnRJZDogcHJvZmlsZUZvcm0uYWNjb3VudElkLnRyaW0oKSwKICAgICAgICAgICAgYXBpVG9rZW46IHByb2ZpbGVGb3JtLmFwaVRva2VuLnRyaW0oKQogICAgICAgIH07CiAgICAgICAgdGhpcy50cnlTYXZlUHJvZmlsZShwcm9maWxlSWQsIG5ld1Byb2ZpbGUpOwogICAgfQogICAgZWRpdEV2ZW50RmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnRXZlbnQgdHlwZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnY3JvbicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQ1JPTiB0cmlnZ2VyJwogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJ2h0dHAnLAogICAgICAgICAgICAgICAgdGV4dDogJ0hUVFAgcmVxdWVzdCcKICAgICAgICAgICAgfSwgCiAgICAgICAgXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyLmV2ZW50MSA9PT0gJ2h0dHAnID8gJ2h0dHAnIDogZmlsdGVyLmV2ZW50MSA9PT0gJ2Nyb24nID8gJ2Nyb24nIDogJ2FsbCc7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdDaG9vc2Ugd2hpY2ggdHlwZXMgb2YgZXZlbnRzIHRvIHNob3cnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuZXZlbnQxID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmV2ZW50MSA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZENob2ljZVRleHQgPSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVDaG9pY2VzLmZpbmQoKHYpPT52LmlkID09PSBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUKICAgICAgICAgICAgKS50ZXh0OwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYEV2ZW50IHR5cGUgZmlsdGVyIGNoYW5nZWQgdG86ICR7c2VsZWN0ZWRDaG9pY2VUZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFN0YXR1c0ZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1N0YXR1czonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnYWxsJywKICAgICAgICAgICAgICAgIHRleHQ6ICdBbGwnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnc3VjY2VzcycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnU3VjY2VzcycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICdlcnJvcicsCiAgICAgICAgICAgICAgICB0ZXh0OiAnRXJyb3InCiAgICAgICAgICAgIH0sIAogICAgICAgIF07CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpbHRlci5zdGF0dXMxID09PSAnc3VjY2VzcycgPyAnc3VjY2VzcycgOiBmaWx0ZXIuc3RhdHVzMSA9PT0gJ2Vycm9yJyA/ICdlcnJvcicgOiAnYWxsJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ1Nob3cgZXZlbnRzIHRoaXMgdGhpcyBzdGF0dXMnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc3RhdHVzMSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5zdGF0dXMxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQ2hvaWNlVGV4dCA9IGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMuZmluZCgodik9PnYuaWQgPT09IGZpbHRlckZvcm0uZmllbGRWYWx1ZQogICAgICAgICAgICApLnRleHQ7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgU3RhdHVzIGZpbHRlciBjaGFuZ2VkIHRvOiAke3NlbGVjdGVkQ2hvaWNlVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRJcEFkZHJlc3NGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGlzVmFsaWRJcEFkZHJlc3MgPSAoaXBBZGRyZXNzKT0+ewogICAgICAgICAgICByZXR1cm4gL14oc2VsZnxbXGRcLjphLWZdezMsfSkkLy50ZXN0KGlwQWRkcmVzcyk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjaGVja1ZhbGlkSXBBZGRyZXNzID0gKGlwQWRkcmVzcyk9PnsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkSXBBZGRyZXNzKGlwQWRkcmVzcykpIHRocm93IG5ldyBFcnJvcihgQmFkIGlwIGFkZHJlc3M6ICR7aXBBZGRyZXNzfWApOwogICAgICAgICAgICByZXR1cm4gaXBBZGRyZXNzOwogICAgICAgIH07CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJJcEFkZHJlc3Nlc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3Qodi5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApLm1hcChjaGVja1ZhbGlkSXBBZGRyZXNzKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJJcEFkZHJlc3NlcyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIuaXBBZGRyZXNzMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdJUCBhZGRyZXNzKHMpOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJJcEFkZHJlc3NlcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ3NlbGYnIHRvIGZpbHRlciB5b3VyIG93biBhZGRyZXNzLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGUsIGUuZy4gc2VsZiwgMS4xLjEuMWA7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlcklwQWRkcmVzc2VzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLmlwQWRkcmVzczEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmlwQWRkcmVzczEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ2FueSBJUCBhZGRyZXNzJyA6IG5ld1ZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgSVAgYWRkcmVzcyBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdE1ldGhvZEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgcGFyc2VGaWx0ZXJNZXRob2RzRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2ID0gKGZpZWxkVmFsdWUgfHwgJycpLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHYgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2LnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkudG9VcHBlckNhc2UoKQogICAgICAgICAgICApLmZpbHRlcigodik9PnYgIT09ICcnCiAgICAgICAgICAgICkpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcyA9ICgpPT57CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdChmaWx0ZXIubWV0aG9kMSB8fCBbXSkubWFwKCh2KT0+di50b1VwcGVyQ2FzZSgpCiAgICAgICAgICAgICkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdIVFRQIE1ldGhvZChzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVyTWV0aG9kcygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSAnY29tbWEtc2VwYXJhdGVkIGlmIG11bHRpcGxlLCBlLmcuIEdFVCwgUE9TVCc7CiAgICAgICAgZmlsdGVyRm9ybS5hcHBseVZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXJzZUZpbHRlck1ldGhvZHNGcm9tRmllbGRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoc2V0RXF1YWwobmV3IFNldChmaWx0ZXIubWV0aG9kMSB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWUpKSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIubWV0aG9kMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZS5sZW5ndGggPT09IDAgPyAnYW55IG1ldGhvZCcgOiBuZXdWYWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgICB0aGlzLmxvZ1dpdGhQcmVmaXgoYE1ldGhvZCBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNhbXBsaW5nUmF0ZUZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHBhcnNlU2FtcGxlUmF0ZUZyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIDE7CiAgICAgICAgICAgIGNvbnN0IG51bSA9IHBhcnNlRmxvYXQodik7CiAgICAgICAgICAgIGlmICghaXNWYWxpZFNhbXBsaW5nUmF0ZShudW0pKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcmF0ZTogJHt2fWApOwogICAgICAgICAgICByZXR1cm4gbnVtOwogICAgICAgIH07CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBmaWx0ZXJGb3JtLnNob3dpbmcgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZE5hbWUgPSAnU2FtcGxpbmcgcmF0ZTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gKHR5cGVvZiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gJ251bWJlcicgJiYgaXNWYWxpZFNhbXBsaW5nUmF0ZShmaWx0ZXIuc2FtcGxpbmdSYXRlMSkgPyBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA6IDEpLnRvRml4ZWQoMik7CiAgICAgICAgZmlsdGVyRm9ybS5oZWxwVGV4dCA9ICdDYW4gcmFuZ2UgZnJvbSAwICgwJSkgdG8gMSAoMTAwJSknOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VTYW1wbGVSYXRlRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKGZpbHRlci5zYW1wbGluZ1JhdGUxID09PSBuZXdWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBuZXdWYWx1ZSA9PT0gMSA/ICdubyBzYW1wbGluZycgOiBgJHtuZXdWYWx1ZX0gKCR7KG5ld1ZhbHVlICogMTAwKS50b0ZpeGVkKDIpfSUpYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTYW1wbGUgcmF0ZSBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgZWRpdFNlYXJjaEZpbHRlcigpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZmlsdGVyICwgZmlsdGVyRm9ybSAgfSA9IHRoaXM7CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ1NlYXJjaCB0ZXh0Oic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBmaWx0ZXIuc2VhcmNoMSB8fCAnJzsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ0ZpbHRlciBieSBhIHRleHQgbWF0Y2ggaW4gY29uc29sZS5sb2cgbWVzc2FnZXMnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGlmIChmaWx0ZXIuc2VhcmNoMSA9PT0gZmlsdGVyRm9ybS5maWVsZFZhbHVlKSByZXR1cm47CiAgICAgICAgICAgIGZpbHRlci5zZWFyY2gxID0gZmlsdGVyRm9ybS5maWVsZFZhbHVlOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHsKICAgICAgICAgICAgICAgIHNhdmU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSAoZmlsdGVyLnNlYXJjaDEgfHwgJycpLmxlbmd0aCA9PT0gMCA/ICdubyBzZWFyY2ggZmlsdGVyJyA6IGAnJHtmaWx0ZXIuc2VhcmNoMX0nYDsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBTZWFyY2ggZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRIZWFkZXJGaWx0ZXIoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlciAsIGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IHBhcnNlRmlsdGVySGVhZGVyc0Zyb21GaWVsZFZhbHVlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgeyBmaWVsZFZhbHVlICB9ID0gZmlsdGVyRm9ybTsKICAgICAgICAgICAgY29uc3QgdiA9IChmaWVsZFZhbHVlIHx8ICcnKS50cmltKCk7CiAgICAgICAgICAgIGlmICh2ID09PSAnJykgcmV0dXJuIFtdOwogICAgICAgICAgICByZXR1cm4gZGlzdGluY3Qodi5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgICAgICkuZmlsdGVyKCh2KT0+diAhPT0gJycKICAgICAgICAgICAgKSk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb21wdXRlRmllbGRWYWx1ZUZyb21GaWx0ZXJIZWFkZXJzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5oZWFkZXIxIHx8IFtdKS5qb2luKCcsICcpOwogICAgICAgIH07CiAgICAgICAgZmlsdGVyRm9ybS5zaG93aW5nID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmVuYWJsZWQgPSB0cnVlOwogICAgICAgIGZpbHRlckZvcm0uZmllbGROYW1lID0gJ0hlYWRlcihzKTonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gY29tcHV0ZUZpZWxkVmFsdWVGcm9tRmlsdGVySGVhZGVycygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ2tleScsIG9yICdrZXk6cXVlcnknLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGVgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VGaWx0ZXJIZWFkZXJzRnJvbUZpZWxkVmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQoZmlsdGVyLmhlYWRlcjEgfHwgW10pLCBuZXcgU2V0KG5ld1ZhbHVlKSkpIHJldHVybjsKICAgICAgICAgICAgZmlsdGVyLmhlYWRlcjEgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gbmV3VmFsdWUubGVuZ3RoID09PSAwID8gJ25vIGhlYWRlciBmaWx0ZXInIDogbmV3VmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBIZWFkZXIgZmlsdGVyIGNoYW5nZWQgdG86ICR7dGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRMb2dwcm9wRmlsdGVyKCkgewogICAgICAgIGlmICh0aGlzLmRlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgLCBmaWx0ZXJGb3JtICB9ID0gdGhpczsKICAgICAgICBjb25zdCBwYXJzZUxvZ3Byb3BGaWx0ZXJzRnJvbUZpZWxkVmFsdWUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCB7IGZpZWxkVmFsdWUgIH0gPSBmaWx0ZXJGb3JtOwogICAgICAgICAgICBjb25zdCB2ID0gKGZpZWxkVmFsdWUgfHwgJycpLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHYgPT09ICcnKSByZXR1cm4gW107CiAgICAgICAgICAgIHJldHVybiBkaXN0aW5jdCh2LnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGNvbXB1dGVGaWVsZFZhbHVlRnJvbUxvZ1Byb3BGaWx0ZXJzID0gKCk9PnsKICAgICAgICAgICAgcmV0dXJuIGRpc3RpbmN0KGZpbHRlci5sb2dwcm9wMSB8fCBbXSkuam9pbignLCAnKTsKICAgICAgICB9OwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdMb2dwcm9wKHMpOic7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlQ2hvaWNlcyA9IFtdOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgPSBjb21wdXRlRmllbGRWYWx1ZUZyb21Mb2dQcm9wRmlsdGVycygpOwogICAgICAgIGZpbHRlckZvcm0uaGVscFRleHQgPSBgJ2tleScsIG9yICdrZXk6dmFsdWUnLCBjb21tYS1zZXBhcmF0ZWQgaWYgbXVsdGlwbGUsIHZhbHVlIG1heSBpbmNsdWRlICpgOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGFyc2VMb2dwcm9wRmlsdGVyc0Zyb21GaWVsZFZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMuc2V0TG9ncHJvcEZpbHRlcihuZXdWYWx1ZSk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBzZXRMb2dwcm9wRmlsdGVyKGxvZ3Byb3BGaWx0ZXJzKSB7CiAgICAgICAgY29uc3QgeyBmaWx0ZXIgIH0gPSB0aGlzOwogICAgICAgIGlmIChzZXRFcXVhbChuZXcgU2V0KGZpbHRlci5sb2dwcm9wMSB8fCBbXSksIG5ldyBTZXQobG9ncHJvcEZpbHRlcnMpKSkgcmV0dXJuOwogICAgICAgIGZpbHRlci5sb2dwcm9wMSA9IGxvZ3Byb3BGaWx0ZXJzOwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgdGV4dCA9IGxvZ3Byb3BGaWx0ZXJzLmxlbmd0aCA9PT0gMCA/ICdubyBsb2dwcm9wIGZpbHRlcicgOiBsb2dwcm9wRmlsdGVycy5qb2luKCcsICcpOwogICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgTG9ncHJvcCBmaWx0ZXIgY2hhbmdlZCB0bzogJHt0ZXh0fWApOwogICAgfQogICAgaGFzQW55RmlsdGVycygpIHsKICAgICAgICBjb25zdCB7IGZpbHRlciAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgeyBldmVudDEgIH0gPSBmaWx0ZXI7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVUYWlsT3B0aW9uc0ZvckZpbHRlcihmaWx0ZXIpLmZpbHRlcnMubGVuZ3RoID4gMCB8fCB0eXBlb2YgZXZlbnQxID09PSAnc3RyaW5nJyAmJiBldmVudDEgIT09ICcnICYmIGV2ZW50MSAhPT0gJ2FsbCc7CiAgICB9CiAgICByZXNldEZpbHRlcnMoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlciA9IHsKICAgICAgICB9OwogICAgICAgIHRoaXMuYXBwbHlGaWx0ZXIoewogICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5sb2dXaXRoUHJlZml4KGBGaWx0ZXJzIHJlc2V0YCk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgY2FuY2VsRmlsdGVyKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdjYW5jZWxGaWx0ZXInKTsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIHNhdmVGaWx0ZXIoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ3NhdmVGaWx0ZXInKTsKICAgICAgICBjb25zdCB7IGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIGZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZSA9ICdDaGVja2luZyBmaWx0ZXIuLi4nOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBmaWx0ZXJGb3JtLmFwcGx5VmFsdWUoKTsKICAgICAgICAgICAgZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlID0gYGA7CiAgICAgICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgZmlsdGVyRm9ybS5vdXRwdXRNZXNzYWdlID0gYEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIHNlbGVjdEZpbHRlckNob2ljZShpZCkgewogICAgICAgIGlmICh0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9PT0gaWQpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGlkOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGVkaXRTZWxlY3Rpb25GaWVsZHMoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICBjb25zdCB7IGZpbHRlckZvcm0gIH0gPSB0aGlzOwogICAgICAgIGZpbHRlckZvcm0uc2hvd2luZyA9IHRydWU7CiAgICAgICAgZmlsdGVyRm9ybS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkTmFtZSA9ICdBZGRpdGlvbmFsIGZpZWxkczonOwogICAgICAgIGZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgICAgICBmaWx0ZXJGb3JtLmZpZWxkVmFsdWVPcHRpb25zID0gRVhUUkFfRklFTERTX09QVElPTlM7CiAgICAgICAgZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gKHRoaXMuZXh0cmFGaWVsZHMgfHwgW10pLmpvaW4oJywnKTsKICAgICAgICBmaWx0ZXJGb3JtLmhlbHBUZXh0ID0gJ1NlbGVjdCBhZGRpdGlvbmFsIGZpZWxkcyB0byBzaG93IGluIHRoZSBvdXRwdXQnOwogICAgICAgIGZpbHRlckZvcm0uYXBwbHlWYWx1ZSA9ICgpPT57CiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlcyA9IGRpc3RpbmN0KChmaWx0ZXJGb3JtLmZpZWxkVmFsdWUgfHwgJycpLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICAgICApKTsKICAgICAgICAgICAgaWYgKHNldEVxdWFsKG5ldyBTZXQodGhpcy5leHRyYUZpZWxkcyB8fCBbXSksIG5ldyBTZXQobmV3VmFsdWVzKSkpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5leHRyYUZpZWxkcyA9IG5ld1ZhbHVlczsKICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcih7CiAgICAgICAgICAgICAgICBzYXZlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBleHRyYUZpZWxkc1RleHQgPSB0aGlzLmNvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KCk7CiAgICAgICAgICAgIHRoaXMubG9nV2l0aFByZWZpeChgT3V0cHV0IGZpZWxkcyBjaGFuZ2VkIHRvOiAke2V4dHJhRmllbGRzVGV4dH1gKTsKICAgICAgICB9OwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICAgIGNvbXB1dGVTZWxlY3Rpb25GaWVsZHNUZXh0KCkgewogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICdzdGFuZGFyZCBmaWVsZHMnLAogICAgICAgICAgICAuLi50aGlzLmV4dHJhRmllbGRzLm1hcCgoaWQpPT5FWFRSQV9GSUVMRFNfT1BUSU9OUy5maW5kKCh2KT0+di5pZCA9PT0gaWQKICAgICAgICAgICAgICAgICk/LnRleHQgfHwgaWQKICAgICAgICAgICAgKQogICAgICAgIF0uam9pbignLCAnKTsKICAgIH0KICAgIHRvZ2dsZUZpbHRlck9wdGlvbihpZCkgewogICAgICAgIGNvbnN0IGV4dHJhRmllbGRzID0gZGlzdGluY3QoKHRoaXMuZmlsdGVyRm9ybS5maWVsZFZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCgodik9PnYudHJpbSgpCiAgICAgICAgKS5maWx0ZXIoKHYpPT52ICE9PSAnJwogICAgICAgICkpOwogICAgICAgIGNvbnN0IGkgPSBleHRyYUZpZWxkcy5pbmRleE9mKGlkKTsKICAgICAgICBpZiAoaSA+PSAwKSB7CiAgICAgICAgICAgIGV4dHJhRmllbGRzLnNwbGljZShpLCAxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHRyYUZpZWxkcy5wdXNoKGlkKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZmllbGRWYWx1ZSA9IGV4dHJhRmllbGRzLmpvaW4oJywnKTsKICAgICAgICBpZiAodGhpcy5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPT09IGZpZWxkVmFsdWUpIHJldHVybjsKICAgICAgICB0aGlzLmZpbHRlckZvcm0uZmllbGRWYWx1ZSA9IGZpZWxkVmFsdWU7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgdGhpcy5zZXREZW1vTW9kZSghdGhpcy5kZW1vTW9kZSk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgcmVzZXRPdXRwdXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgIH0KICAgIHNob3dBYm91dCgpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSkgcmV0dXJuOwogICAgICAgIHRoaXMuYWJvdXRTaG93aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICB9CiAgICBjbG9zZUFib3V0KCkgewogICAgICAgIHRoaXMuYWJvdXRTaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgc2hvd0FuYWx5dGljKGFuYWx5dGljSWQpIHsKICAgICAgICBjb25zdCBhbmFseXRpYyA9IHRoaXMuYW5hbHl0aWNzLmZpbmQoKHYpPT52LmlkID09PSBhbmFseXRpY0lkCiAgICAgICAgKTsKICAgICAgICBpZiAoIWFuYWx5dGljIHx8IGFuYWx5dGljLmlkID09PSB0aGlzLl9zZWxlY3RlZEFuYWx5dGljSWQpIHJldHVybjsKICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgaWYgKHByb2ZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgIHRoaXMuX3NlbGVjdGVkQW5hbHl0aWNJZCA9IGFuYWx5dGljSWQ7CiAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5xdWVyeWluZyA9IHRydWU7CiAgICAgICAgdGhpcy5hbmFseXRpY3NTdGF0ZS5kdXJhYmxlT2JqZWN0c0Nvc3RzID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuYW5hbHl0aWNzU3RhdGUuZXJyb3IgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBDZkdxbENsaWVudCh7CiAgICAgICAgICAgIGFjY291bnRJZCwKICAgICAgICAgICAgYXBpVG9rZW4KICAgICAgICB9KTsKICAgICAgICB0aGlzLnF1ZXJ5RHVyYWJsZU9iamVjdHNDb3N0cyhjbGllbnQpOwogICAgfQogICAgc2V0RGVtb01vZGUoZGVtb01vZGUpIHsKICAgICAgICBpZiAodGhpcy5kZW1vTW9kZSA9PT0gZGVtb01vZGUpIHJldHVybjsKICAgICAgICB0aGlzLmRlbW9Nb2RlID0gZGVtb01vZGU7CiAgICAgICAgaWYgKGRlbW9Nb2RlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFbmFibGUgZGVtbyBtb2RlJyk7CiAgICAgICAgICAgIHRoaXMub25RcHNDaGFuZ2UoMTIuMzQpOwogICAgICAgICAgICB0aGlzLm9uUmVzZXRPdXRwdXQoKTsKICAgICAgICAgICAgRGVtb01vZGUubG9nRmFrZU91dHB1dCh0aGlzLnRhaWxDb250cm9sbGVyQ2FsbGJhY2tzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRGlzYWJsZSBkZW1vIG1vZGUnKTsKICAgICAgICAgICAgdGhpcy5vblFwc0NoYW5nZSh0aGlzLnFwc0NvbnRyb2xsZXIucXBzKTsKICAgICAgICAgICAgdGhpcy5vblJlc2V0T3V0cHV0KCk7CiAgICAgICAgfQogICAgfQogICAgYXBwbHlGaWx0ZXIob3B0cykgewogICAgICAgIGNvbnN0IHsgc2F2ZSAgfSA9IG9wdHM7CiAgICAgICAgdGhpcy5zdGF0ZS5maWx0ZXIgPSB0aGlzLmZpbHRlcjsKICAgICAgICB0aGlzLnN0YXRlLmV4dHJhRmllbGRzID0gdGhpcy5leHRyYUZpZWxkczsKICAgICAgICBpZiAoc2F2ZSkgc2F2ZVN0YXRlKHRoaXMuc3RhdGUpOwogICAgICAgIGNvbnN0IHRhaWxPcHRpb25zID0gY29tcHV0ZVRhaWxPcHRpb25zRm9yRmlsdGVyKHRoaXMuZmlsdGVyKTsKICAgICAgICB0aGlzLnRhaWxDb250cm9sbGVyLnNldFRhaWxPcHRpb25zKHRhaWxPcHRpb25zKTsKICAgIH0KICAgIGxvZ1dpdGhQcmVmaXgoLi4uZGF0YSkgewogICAgICAgIGNvbnN0IHRpbWUgPSBmb3JtYXRMb2NhbFl5eXlNbURkSGhNbVNzKG5ldyBEYXRlKCkpOwogICAgICAgIGlmIChkYXRhLmxlbmd0aCA+IDAgJiYgdHlwZW9mIGRhdGFbMF0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGRhdGEgPSBbCiAgICAgICAgICAgICAgICBgWyVjJHt0aW1lfSVjXSAke2RhdGFbMF19YCwKICAgICAgICAgICAgICAgICdjb2xvcjogZ3JheScsCiAgICAgICAgICAgICAgICAnJywKICAgICAgICAgICAgICAgIC4uLmRhdGEuc2xpY2UoMSkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sb2dnZXIoLi4uZGF0YSk7CiAgICB9CiAgICB2ZXJib3NlV2l0aFByZWZpeChtZXNzYWdlKSB7CiAgICAgICAgY29uc3QgdGltZSA9IGZvcm1hdExvY2FsWXl5eU1tRGRIaE1tU3MobmV3IERhdGUoKSk7CiAgICAgICAgdGhpcy5sb2dnZXIoYFslYyR7dGltZX0lY10gJWMke21lc3NhZ2V9JWNgLCAnY29sb3I6IGdyYXknLCAnJywgJ2NvbG9yOiBncmF5Jyk7CiAgICB9CiAgICBwZXJmb3JtSW5pdGlhbFNlbGVjdGlvbigpIHsKICAgICAgICBjb25zdCBpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZCA9IGNvbXB1dGVJbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZCh0aGlzLnN0YXRlLCB0aGlzLl9wcm9maWxlcyk7CiAgICAgICAgaWYgKGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJbml0aWFsbHkgc2VsZWN0aW5nIHByb2ZpbGU6ICR7dGhpcy5zdGF0ZS5wcm9maWxlc1tpbml0aWFsbHlTZWxlY3RlZFByb2ZpbGVJZF0ubmFtZX1gKTsKICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9IGluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyB0cnlTYXZlUHJvZmlsZShwcm9maWxlSWQsIHByb2ZpbGUpIHsKICAgICAgICBjb25zdCB7IHByb2ZpbGVGb3JtICB9ID0gdGhpczsKICAgICAgICBwcm9maWxlRm9ybS5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgcHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlID0gdHJ1ZTsKICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gJ0NoZWNraW5nIHByb2ZpbGUuLi4nOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBjYW5MaXN0VGFpbHMgPSBhd2FpdCBjb21wdXRlQ2FuTGlzdFRhaWxzKHByb2ZpbGUuYWNjb3VudElkLCBwcm9maWxlLmFwaVRva2VuKTsKICAgICAgICAgICAgaWYgKGNhbkxpc3RUYWlscykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5wcm9maWxlc1twcm9maWxlSWRdID0gcHJvZmlsZTsKICAgICAgICAgICAgICAgIHNhdmVTdGF0ZSh0aGlzLnN0YXRlKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSAnJzsKICAgICAgICAgICAgICAgIHRoaXMucmVsb2FkUHJvZmlsZXMoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjb21wdXRlV2VsY29tZVNob3dpbmcoKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVGb3JtLnNob3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgPSBwcm9maWxlSWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlID0gYFRoZXNlIGNyZWRlbnRpYWxzIGRvIG5vdCBoYXZlIHBlcm1pc3Npb24gdG8gdGFpbGA7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHByb2ZpbGVGb3JtLm91dHB1dE1lc3NhZ2UgPSBgRXJyb3I6ICR7ZS5tZXNzYWdlfWA7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICBwcm9maWxlRm9ybS5wcm9ncmVzc1Zpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgcHJvZmlsZUZvcm0uZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICByZWxvYWRQcm9maWxlcygpIHsKICAgICAgICBjb25zdCB7IHN0YXRlICB9ID0gdGhpczsKICAgICAgICB0aGlzLl9wcm9maWxlcy5zcGxpY2UoMCk7CiAgICAgICAgZm9yIChjb25zdCBbcHJvZmlsZUlkLCBwcm9maWxlXSBvZiBPYmplY3QuZW50cmllcyhzdGF0ZS5wcm9maWxlcykpewogICAgICAgICAgICBjb25zdCBuYW1lID0gcHJvZmlsZS5uYW1lIHx8ICcodW5uYW1lZCknOwogICAgICAgICAgICB0aGlzLl9wcm9maWxlcy5wdXNoKHsKICAgICAgICAgICAgICAgIGlkOiBwcm9maWxlSWQsCiAgICAgICAgICAgICAgICB0ZXh0OiBuYW1lCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGZpbmRTY3JpcHRzKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUHJvZmlsZUlkID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgICAgIGlmIChwcm9maWxlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgeyBhY2NvdW50SWQgLCBhcGlUb2tlbiAgfSA9IHByb2ZpbGU7CiAgICAgICAgICAgIHRoaXMudmVyYm9zZVdpdGhQcmVmaXgoYEZpbmRpbmcgc2NyaXB0cyBmb3IgJHtwcm9maWxlLm5hbWUudG9VcHBlckNhc2UoKX0uLi5gKTsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBjb25zdCBzY3JpcHRzID0gYXdhaXQgbGlzdFNjcmlwdHMoYWNjb3VudElkLCBhcGlUb2tlbik7CiAgICAgICAgICAgIGlmICghdGhpcy5kZW1vTW9kZSkgdGhpcy52ZXJib3NlV2l0aFByZWZpeChgRm91bmQgJHtzY3JpcHRzLmxlbmd0aH0gc2NyaXB0cyBpbiAke0RhdGUubm93KCkgLSBzdGFydH1tc2ApOwogICAgICAgICAgICB0aGlzLl9zY3JpcHRzLnNwbGljZSgwKTsKICAgICAgICAgICAgZm9yIChjb25zdCBzY3JpcHQgb2Ygc2NyaXB0cyl7CiAgICAgICAgICAgICAgICB0aGlzLl9zY3JpcHRzLnB1c2goewogICAgICAgICAgICAgICAgICAgIGlkOiBzY3JpcHQuaWQsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogc2NyaXB0LmlkCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9zY3JpcHRzLnNvcnQoKGxocywgcmhzKT0+bGhzLnRleHQubG9jYWxlQ29tcGFyZShyaHMudGV4dCkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRTY3JpcHRJZHMgPSB0aGlzLmNvbXB1dGVTZWxlY3RlZFNjcmlwdElkc0FmdGVyRmluZFNjcmlwdHMoKTsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkU2NyaXB0SWRzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkU2NyaXB0SWRzID0gc2VsZWN0ZWRTY3JpcHRJZHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmRlbW9Nb2RlKSB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoIXRoaXMuZGVtb01vZGUpIHRoaXMubG9nZ2VyKGBFcnJvciBpbiBmaW5kU2NyaXB0czogJHtlLnN0YWNrfWApOwogICAgICAgIH0KICAgIH0KICAgIGNvbXB1dGVTZWxlY3RlZFNjcmlwdElkc0FmdGVyRmluZFNjcmlwdHMoKSB7CiAgICAgICAgaWYgKHRoaXMuX3NjcmlwdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbml0aWFsbHkgc2VsZWN0aW5nIG5vIHNjcmlwdHMsIG5vIHNjcmlwdHMgdG8gc2VsZWN0Jyk7CiAgICAgICAgICAgIHJldHVybiBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUHJvZmlsZUlkICYmIHRoaXMuc2VsZWN0ZWRQcm9maWxlSWQgJiYgdGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2ZpbGVJZCkgewogICAgICAgICAgICBjb25zdCBpbml0aWFsUHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgICAgIGlmIChpbml0aWFsUHJvZmlsZSAmJiBpbml0aWFsUHJvZmlsZS5zZWxlY3RlZFNjcmlwdElkcyAmJiBpbml0aWFsUHJvZmlsZS5zZWxlY3RlZFNjcmlwdElkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U2NyaXB0SWRzID0gbmV3IFNldCh0aGlzLl9zY3JpcHRzLm1hcCgodik9PnYuaWQKICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgY29uc3QgY2FuZGlkYXRlcyA9IHNldEludGVyc2VjdChjdXJyZW50U2NyaXB0SWRzLCBuZXcgU2V0KGluaXRpYWxQcm9maWxlLnNlbGVjdGVkU2NyaXB0SWRzKSk7CiAgICAgICAgICAgICAgICBpZiAoY2FuZGlkYXRlcy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJbml0aWFsbHkgc2VsZWN0aW5nIHNjcmlwdCR7Y2FuZGlkYXRlcy5zaXplID09PSAxID8gJycgOiAncyd9ICR7WwogICAgICAgICAgICAgICAgICAgICAgICAuLi5jYW5kaWRhdGVzCiAgICAgICAgICAgICAgICAgICAgXS5zb3J0KCkuam9pbignLCAnKX06IHJlbWVtYmVyZWQgZnJvbSBsYXN0IHRpbWVgKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FuZGlkYXRlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBmaXJzdFNjcmlwdElkID0gdGhpcy5fc2NyaXB0c1swXS5pZDsKICAgICAgICBjb25zb2xlLmxvZyhgSW5pdGlhbGx5IHNlbGVjdGluZyBzY3JpcHQgJHtmaXJzdFNjcmlwdElkfTogZmlyc3Qgb25lIGluIHRoZSBsaXN0YCk7CiAgICAgICAgcmV0dXJuIG5ldyBTZXQoWwogICAgICAgICAgICB0aGlzLl9zY3JpcHRzWzBdLmlkCiAgICAgICAgXSk7CiAgICB9CiAgICBhc3luYyBzZXRUYWlscygpIHsKICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFByb2ZpbGVJZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMuc3RhdGUucHJvZmlsZXNbdGhpcy5zZWxlY3RlZFByb2ZpbGVJZF07CiAgICAgICAgaWYgKHByb2ZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwcm9maWxlOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMudGFpbENvbnRyb2xsZXIuc2V0VGFpbHMoYWNjb3VudElkLCBhcGlUb2tlbiwgdGhpcy5fc2VsZWN0ZWRTY3JpcHRJZHMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgdGhpcy5sb2dnZXIoJ0Vycm9yIGluIHNldFRhaWxzJywgZS5zdGFjayB8fCBlLm1lc3NhZ2UpOwogICAgICAgIH0KICAgIH0KICAgIGNvbXB1dGVBZGRpdGlvbmFsTG9ncyhtZXNzYWdlKSB7CiAgICAgICAgY29uc3QgcnQgPSBbXTsKICAgICAgICBjb25zdCBpbmNsdWRlSXBBZGRyZXNzID0gdGhpcy5leHRyYUZpZWxkcy5pbmNsdWRlcygnaXAtYWRkcmVzcycpOwogICAgICAgIGNvbnN0IGluY2x1ZGVVc2VyQWdlbnQgPSB0aGlzLmV4dHJhRmllbGRzLmluY2x1ZGVzKCd1c2VyLWFnZW50Jyk7CiAgICAgICAgY29uc3QgaW5jbHVkZVJlZmVyZXIgPSB0aGlzLmV4dHJhRmllbGRzLmluY2x1ZGVzKCdyZWZlcmVyJyk7CiAgICAgICAgaWYgKGluY2x1ZGVJcEFkZHJlc3MgfHwgaW5jbHVkZVVzZXJBZ2VudCB8fCBpbmNsdWRlUmVmZXJlcikgewogICAgICAgICAgICBpZiAoIWlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQobWVzc2FnZS5ldmVudCkpIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlSXBBZGRyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXBBZGRyZXNzID0gbWVzc2FnZS5ldmVudC5yZXF1ZXN0LmhlYWRlcnNbJ2NmLWNvbm5lY3RpbmctaXAnXSB8fCB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlwQWRkcmVzcykgcnQucHVzaChjb21wdXRlQWRkaXRpb25hbExvZ0ZvckV4dHJhRmllbGQoJ0lQIGFkZHJlc3MnLCBpcEFkZHJlc3MpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlVXNlckFnZW50KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlckFnZW50ID0gbWVzc2FnZS5ldmVudC5yZXF1ZXN0LmhlYWRlcnNbJ3VzZXItYWdlbnQnXSB8fCB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZXJBZ2VudCkgcnQucHVzaChjb21wdXRlQWRkaXRpb25hbExvZ0ZvckV4dHJhRmllbGQoJ1VzZXIgYWdlbnQnLCB1c2VyQWdlbnQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlUmVmZXJlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZXIgPSBtZXNzYWdlLmV2ZW50LnJlcXVlc3QuaGVhZGVyc1sncmVmZXJlciddIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAocmVmZXJlcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWZlcmVyVXJsID0gdHJ5UGFyc2VVcmwocmVmZXJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBsb2cgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVmZXJlclVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXF1ZXN0VXJsID0gdHJ5UGFyc2VVcmwobWVzc2FnZS5ldmVudC5yZXF1ZXN0LnVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVxdWVzdFVybCAmJiByZXF1ZXN0VXJsLm9yaWdpbiA9PT0gcmVmZXJlclVybC5vcmlnaW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9nKSBydC5wdXNoKGNvbXB1dGVBZGRpdGlvbmFsTG9nRm9yRXh0cmFGaWVsZCgnUmVmZXJlcicsIHJlZmVyZXIpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJ0OwogICAgfQogICAgcmVjb21wdXRlV2VsY29tZVNob3dpbmcoKSB7CiAgICAgICAgY29uc3Qgc2hvdWxkU2hvdyA9IHRoaXMucHJvZmlsZXMubGVuZ3RoID09PSAwOwogICAgICAgIGlmIChzaG91bGRTaG93ID09PSB0aGlzLndlbGNvbWVTaG93aW5nKSByZXR1cm47CiAgICAgICAgdGhpcy5zZXREZW1vTW9kZShzaG91bGRTaG93KTsKICAgICAgICB0aGlzLndlbGNvbWVTaG93aW5nID0gc2hvdWxkU2hvdzsKICAgIH0KICAgIGFzeW5jIHF1ZXJ5RHVyYWJsZU9iamVjdHNDb3N0cyhjbGllbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLmR1cmFibGVPYmplY3RzQ29zdHMgPSBhd2FpdCBjb21wdXRlRHVyYWJsZU9iamVjdHNDb3N0c1RhYmxlKGNsaWVudCwgewogICAgICAgICAgICAgICAgbG9va2JhY2tEYXlzOiAyOAogICAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGxldCBlcnJvciA9IGAke2V9YDsKICAgICAgICAgICAgaWYgKGVycm9yLmluY2x1ZGVzKCcoY29kZT1hdXRoeiknKSkgewogICAgICAgICAgICAgICAgZXJyb3IgPSBgVGhlIGF1dGggdG9rZW4gZm9yIHRoaXMgcHJvZmlsZSBkb2VzIG5vdCBoYXZlIHRoZSBBY2NvdW50IEFuYWx5dGljczpSZWFkIHBlcm1pc3Npb24uYDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLmVycm9yID0gZXJyb3I7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICB0aGlzLmFuYWx5dGljc1N0YXRlLnF1ZXJ5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUFkZGl0aW9uYWxMb2dGb3JFeHRyYUZpZWxkKG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gewogICAgICAgIGRhdGE6IFsKICAgICAgICAgICAgYCAlY3wlYyBbJWMke25hbWV9JWNdICR7dmFsdWV9YCwKICAgICAgICAgICAgJ2NvbG9yOmdyYXknLAogICAgICAgICAgICAnJywKICAgICAgICAgICAgJ2NvbG9yOmdyYXknCiAgICAgICAgXQogICAgfTsKfQpjbGFzcyBQcm9maWxlRm9ybVZNIHsKICAgIHNob3dpbmcgPSBmYWxzZTsKICAgIGVuYWJsZWQgPSBmYWxzZTsKICAgIG5hbWUgPSAnJzsKICAgIGFjY291bnRJZCA9ICcnOwogICAgYXBpVG9rZW4gPSAnJzsKICAgIGRlbGV0ZVZpc2libGUgPSBmYWxzZTsKICAgIHNhdmVFbmFibGVkID0gZmFsc2U7CiAgICBwcm9maWxlSWQgPSAnJzsKICAgIHRpdGxlID0gJyc7CiAgICBwcm9ncmVzc1Zpc2libGUgPSBmYWxzZTsKICAgIG91dHB1dE1lc3NhZ2UgPSAnJzsKICAgIGNvbXB1dGVTYXZlRW5hYmxlZCgpIHsKICAgICAgICB0aGlzLnNhdmVFbmFibGVkID0gdGhpcy5uYW1lLnRyaW0oKS5sZW5ndGggPiAwICYmIHRoaXMuYXBpVG9rZW4udHJpbSgpLmxlbmd0aCA+IDAgJiYgdGhpcy5hY2NvdW50SWQudHJpbSgpLmxlbmd0aCA+IDA7CiAgICB9Cn0KY2xhc3MgRmlsdGVyRm9ybVZNIHsKICAgIHNob3dpbmcgPSBmYWxzZTsKICAgIGVuYWJsZWQgPSBmYWxzZTsKICAgIGZpZWxkTmFtZSA9ICcnOwogICAgZmllbGRWYWx1ZUNob2ljZXMgPSBbXTsKICAgIGZpZWxkVmFsdWVPcHRpb25zID0gW107CiAgICBmaWVsZFZhbHVlOwogICAgaGVscFRleHQgPSAnJzsKICAgIG91dHB1dE1lc3NhZ2UgPSAnJzsKICAgIGFwcGx5VmFsdWUgPSAoKT0+ewogICAgfTsKfQpjb25zdCBFWFRSQV9GSUVMRFNfT1BUSU9OUyA9IFsKICAgIHsKICAgICAgICBpZDogJ2lwLWFkZHJlc3MnLAogICAgICAgIHRleHQ6ICdJUCBhZGRyZXNzJwogICAgfSwKICAgIHsKICAgICAgICBpZDogJ3VzZXItYWdlbnQnLAogICAgICAgIHRleHQ6ICdVc2VyIGFnZW50JwogICAgfSwKICAgIHsKICAgICAgICBpZDogJ3JlZmVyZXInLAogICAgICAgIHRleHQ6ICdSZWZlcmVyJwogICAgfSwgCl07CmNvbnN0IFNUQVRFX0tFWSA9ICdzdGF0ZTEnOwpmdW5jdGlvbiBsb2FkU3RhdGUoKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IGpzb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVEFURV9LRVkpIHx8IHVuZGVmaW5lZDsKICAgICAgICBpZiAoanNvbikgewogICAgICAgICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKGpzb24pOwogICAgICAgICAgICBjb25zdCBydCA9IHBhcnNlU3RhdGUob2JqKTsKICAgICAgICAgICAgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ2xvYWRTdGF0ZTogRXJyb3IgbG9hZGluZyBzdGF0ZScsIGUuc3RhY2sgfHwgZSk7CiAgICB9CiAgICBjb25zb2xlLmxvZygnbG9hZFN0YXRlOiByZXR1cm5pbmcgbmV3IHN0YXRlJyk7CiAgICByZXR1cm4gewogICAgICAgIHByb2ZpbGVzOiB7CiAgICAgICAgfQogICAgfTsKfQpmdW5jdGlvbiBwYXJzZVN0YXRlKHBhcnNlZCkgewogICAgaWYgKHR5cGVvZiBwYXJzZWQgIT09ICdvYmplY3QnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIG9iamVjdGApOwogICAgY29uc3QgeyBwcm9maWxlcyAgfSA9IHBhcnNlZDsKICAgIGlmICh0eXBlb2YgcHJvZmlsZXMgIT09ICdvYmplY3QnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHByb2ZpbGVzIG9iamVjdGApOwogICAgZm9yIChjb25zdCBbcHJvZmlsZUlkLCBwcm9maWxlU3RhdGVdIG9mIE9iamVjdC5lbnRyaWVzKHByb2ZpbGVzKSl7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9maWxlSWQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2ZpbGUgaWQgbXVzdCBiZSBzdHJpbmcnKTsKICAgICAgICBwYXJzZVByb2ZpbGVTdGF0ZShwcm9maWxlU3RhdGUpOwogICAgfQogICAgcmV0dXJuIHBhcnNlZDsKfQpmdW5jdGlvbiBwYXJzZVByb2ZpbGVTdGF0ZShwYXJzZWQpIHsKICAgIGlmICh0eXBlb2YgcGFyc2VkICE9PSAnb2JqZWN0JyB8fCBwYXJzZWQgPT09IG51bGwpIHRocm93IG5ldyBFcnJvcignUHJvZmlsZSBzdGF0ZSBtdXN0IGJlIG9iamVjdCcpOwogICAgY29uc3QgeyBuYW1lICwgYWNjb3VudElkICwgYXBpVG9rZW4gIH0gPSBwYXJzZWQ7CiAgICBpZiAodHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnIHx8IG5hbWUudHJpbSgpLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKGBQcm9maWxlIHN0YXRlIG5hbWUgbXVzdCBleGlzdGApOwogICAgaWYgKHR5cGVvZiBhY2NvdW50SWQgIT09ICdzdHJpbmcnIHx8IGFjY291bnRJZC50cmltKCkubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYFByb2ZpbGUgc3RhdGUgYWNjb3VudElkIG11c3QgZXhpc3RgKTsKICAgIGlmICh0eXBlb2YgYXBpVG9rZW4gIT09ICdzdHJpbmcnIHx8IGFwaVRva2VuLnRyaW0oKS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcihgUHJvZmlsZSBzdGF0ZSBhcGlUb2tlbiBtdXN0IGV4aXN0YCk7CiAgICByZXR1cm4gcGFyc2VkOwp9CmZ1bmN0aW9uIHNhdmVTdGF0ZShzdGF0ZSkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RBVEVfS0VZLCBKU09OLnN0cmluZ2lmeShzdGF0ZSkpOwp9CmFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVDYW5MaXN0VGFpbHMoYWNjb3VudElkLCBhcGlUb2tlbikgewogICAgdHJ5IHsKICAgICAgICBhd2FpdCBsaXN0VGFpbHMoYWNjb3VudElkLCAnJywgYXBpVG9rZW4pOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChlIGluc3RhbmNlb2YgQ2xvdWRmbGFyZUFwaUVycm9yICYmIGUuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9CmZ1bmN0aW9uIGlzVmFsaWRTYW1wbGluZ1JhdGUoc2FtcGxpbmdSYXRlKSB7CiAgICByZXR1cm4gIWlzTmFOKHNhbXBsaW5nUmF0ZSkgJiYgc2FtcGxpbmdSYXRlID49IDAgJiYgc2FtcGxpbmdSYXRlIDw9IDE7Cn0KZnVuY3Rpb24gY29tcHV0ZUluaXRpYWxseVNlbGVjdGVkUHJvZmlsZUlkKHN0YXRlLCBwcm9maWxlcykgewogICAgaWYgKHN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkICYmIHN0YXRlLnByb2ZpbGVzW3N0YXRlLnNlbGVjdGVkUHJvZmlsZUlkXSkgcmV0dXJuIHN0YXRlLnNlbGVjdGVkUHJvZmlsZUlkOwogICAgaWYgKHByb2ZpbGVzLmxlbmd0aCA+IDApIHJldHVybiBwcm9maWxlc1swXS5pZDsKICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gY29tcHV0ZVRhaWxPcHRpb25zRm9yRmlsdGVyKGZpbHRlcikgewogICAgY29uc3QgZmlsdGVycyA9IFtdOwogICAgaWYgKGZpbHRlci5zdGF0dXMxID09PSAnZXJyb3InKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgb3V0Y29tZTogWwogICAgICAgICAgICAgICAgJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgICAgICAnZXhjZWVkZWRDcHUnLAogICAgICAgICAgICAgICAgJ2NhbmNlbGVkJywKICAgICAgICAgICAgICAgICd1bmtub3duJwogICAgICAgICAgICBdCiAgICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGZpbHRlci5zdGF0dXMxID09PSAnc3VjY2VzcycpIHsKICAgICAgICBmaWx0ZXJzLnB1c2goewogICAgICAgICAgICBvdXRjb21lOiBbCiAgICAgICAgICAgICAgICAnb2snCiAgICAgICAgICAgIF0KICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuc2FtcGxpbmdSYXRlMSAhPT0gdW5kZWZpbmVkICYmIGlzVmFsaWRTYW1wbGluZ1JhdGUoZmlsdGVyLnNhbXBsaW5nUmF0ZTEpICYmIGZpbHRlci5zYW1wbGluZ1JhdGUxIDwgMSkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIHNhbXBsaW5nX3JhdGU6IGZpbHRlci5zYW1wbGluZ1JhdGUxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLnNlYXJjaDEgIT09IHVuZGVmaW5lZCAmJiBmaWx0ZXIuc2VhcmNoMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgcXVlcnk6IGZpbHRlci5zZWFyY2gxCiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoZmlsdGVyLm1ldGhvZDEgJiYgZmlsdGVyLm1ldGhvZDEubGVuZ3RoID4gMCkgewogICAgICAgIGZpbHRlcnMucHVzaCh7CiAgICAgICAgICAgIG1ldGhvZDogZmlsdGVyLm1ldGhvZDEKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChmaWx0ZXIuaXBBZGRyZXNzMSAmJiBmaWx0ZXIuaXBBZGRyZXNzMS5sZW5ndGggPiAwKSB7CiAgICAgICAgZmlsdGVycy5wdXNoKHsKICAgICAgICAgICAgY2xpZW50X2lwOiBmaWx0ZXIuaXBBZGRyZXNzMQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGZpbHRlci5oZWFkZXIxICYmIGZpbHRlci5oZWFkZXIxLmxlbmd0aCA+IDApIHsKICAgICAgICBmb3IgKGNvbnN0IGhlYWRlciBvZiBmaWx0ZXIuaGVhZGVyMSl7CiAgICAgICAgICAgIGZpbHRlcnMucHVzaChwYXJzZUhlYWRlckZpbHRlcihoZWFkZXIpKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGZpbHRlcnMKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZU1lc3NhZ2VQYXNzZXNGaWx0ZXIobWVzc2FnZSwgZmlsdGVyKSB7CiAgICBpZiAoIWNvbXB1dGVNZXNzYWdlUGFzc2VzTG9nUHJvcEZpbHRlcihtZXNzYWdlLCBmaWx0ZXIubG9ncHJvcDEpKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoZmlsdGVyLmV2ZW50MSA9PT0gJ2Nyb24nIHx8IGZpbHRlci5ldmVudDEgPT09ICdodHRwJykgewogICAgICAgIGNvbnN0IGlzQ3JvbiA9IGlzVGFpbE1lc3NhZ2VDcm9uRXZlbnQobWVzc2FnZSk7CiAgICAgICAgcmV0dXJuIGlzQ3JvbiAmJiBmaWx0ZXIuZXZlbnQxID09PSAnY3JvbicgfHwgIWlzQ3JvbiAmJiBmaWx0ZXIuZXZlbnQxID09PSAnaHR0cCc7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBjb21wdXRlTWVzc2FnZVBhc3Nlc0xvZ1Byb3BGaWx0ZXIobWVzc2FnZSwgbG9ncHJvcDEpIHsKICAgIGlmIChsb2dwcm9wMSA9PT0gdW5kZWZpbmVkIHx8IGxvZ3Byb3AxLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWU7CiAgICBjb25zdCBsb2dwcm9wRmlsdGVycyA9IGxvZ3Byb3AxLm1hcChwYXJzZUhlYWRlckZpbHRlcik7CiAgICBjb25zdCB7IHByb3BzICB9ID0gcGFyc2VMb2dQcm9wcyhtZXNzYWdlLmxvZ3MpOwogICAgZm9yIChjb25zdCBsb2dwcm9wRmlsdGVyIG9mIGxvZ3Byb3BGaWx0ZXJzKXsKICAgICAgICBpZiAoY29tcHV0ZVByb3BzUGFzc0xvZ3Byb3BGaWx0ZXIocHJvcHMsIGxvZ3Byb3BGaWx0ZXIpKSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBjb21wdXRlUHJvcHNQYXNzTG9ncHJvcEZpbHRlcihwcm9wcywgbG9ncHJvcEZpbHRlcikgewogICAgY29uc3QgdmFsID0gcHJvcHNbbG9ncHJvcEZpbHRlci5rZXldOwogICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7CiAgICBpZiAobG9ncHJvcEZpbHRlci5xdWVyeSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdHJ1ZTsKICAgIGNvbnN0IHEgPSBsb2dwcm9wRmlsdGVyLnF1ZXJ5LnRyaW0oKS5yZXBsYWNlQWxsKC9cKisvZywgJyonKTsKICAgIGlmICghcS5pbmNsdWRlcygnKicpKSByZXR1cm4gcSA9PT0gdmFsOwogICAgaWYgKHEgPT09ICcqJykgcmV0dXJuIHRydWU7CiAgICBpZiAodHlwZW9mIHZhbCAhPT0gJ3N0cmluZycpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IHBhdHRlcm4gPSAnXicgKyBlc2NhcGVGb3JSZWdleChxKS5yZXBsYWNlQWxsKCdcXConLCAnLionKSArICckJzsKICAgIHJldHVybiBuZXcgUmVnRXhwKHBhdHRlcm4pLnRlc3QodmFsKTsKfQpmdW5jdGlvbiBlc2NhcGVGb3JSZWdleChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvWy1cL1xcXiQqKz8uKCl8W1xde31dL2csICdcXCQmJyk7Cn0KZnVuY3Rpb24gZGlzdGluY3QodmFsdWVzKSB7CiAgICBjb25zdCBydCA9IFtdOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpewogICAgICAgIGlmICghcnQuaW5jbHVkZXModmFsdWUpKSB7CiAgICAgICAgICAgIHJ0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiB0cnlQYXJzZVVybCh1cmwpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwodXJsKTsKICAgIH0gY2F0Y2ggIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQp9CmNvbnN0IEZJTFRFUl9FRElUT1JfSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJmaWx0ZXItZm9ybSIgYXV0b2NvbXBsZXRlPSJvZmYiPgo8ZmllbGRzZXQgaWQ9ImZpbHRlci1maWVsZHNldCI+CiAgPGRpdiBpZD0iZmlsdGVyLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQgZm9ybS1yb3ciPkVkaXQgZmlsdGVyPC9kaXY+CgogIDxsYWJlbCBpZD0iZmlsdGVyLWZpZWxkLWxhYmVsIj5GaWx0ZXIgZmllbGQ6PC9sYWJlbD4KICA8aW5wdXQgaWQ9ImZpbHRlci1maWVsZC10ZXh0IiB0eXBlPSJ0ZXh0Ij4KICA8ZGl2IGlkPSJmaWx0ZXItZmllbGQtY2hvaWNlIj48L2Rpdj4KICA8ZGl2IGlkPSJmaWx0ZXItZmllbGQtb3B0aW9ucyI+PC9kaXY+CgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLWhlbHAiIGNsYXNzPSJib2R5MiBtZWRpdW0tZW1waGFzaXMtdGV4dCI+CiAgPC9kaXY+ICAKCiAgPGRpdiBpZD0iZmlsdGVyLWZvcm0tb3V0cHV0LXJvdyIgY2xhc3M9ImZvcm0tcm93Ij4KICAgIDxvdXRwdXQgaWQ9ImZpbHRlci1mb3JtLW91dHB1dCI+PC9vdXRwdXQ+CiAgPC9kaXY+CgogIDxkaXYgaWQ9ImZpbHRlci1mb3JtLWJ1dHRvbnMiIGNsYXNzPSJmb3JtLXJocyI+CiAgICA8YnV0dG9uIGlkPSJmaWx0ZXItYXBwbHkiIHR5cGU9InN1Ym1pdCI+QXBwbHk8L2J1dHRvbj48IS0tIGZpcnN0IHNvIGl0IGlzIGRlZmF1bHQgYnV0dG9uIG9uIHJldHVybiAtLT4KICAgIDxidXR0b24gaWQ9ImZpbHRlci1jYW5jZWwiPkNhbmNlbDwvYnV0dG9uPgogIDwvZGl2Pgo8L2ZpZWxkc2V0Pgo8L2Zvcm0+CmA7CmNvbnN0IEZJTFRFUl9FRElUT1JfQ1NTID0gY3NzYAoKICAgICNmaWx0ZXItZm9ybS1idXR0b25zIHsKICAgICAgICBqdXN0aWZ5LXNlbGY6IGVuZDsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgICAgICBnYXA6IDFyZW07CiAgICB9CgogICAgI2ZpbHRlci1maWVsZC1jaG9pY2UgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZ2FwOiAxcHg7CiAgICB9CgogICAgI2ZpbHRlci1maWVsZC1vcHRpb25zIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGZsZXgtd3JhcDogd3JhcDsKICAgICAgICBnYXA6IDFweDsKICAgIH0KCiAgICAjZmlsdGVyLWZpZWxkLW9wdGlvbnMgYnV0dG9uIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAwLjVyZW07CiAgICB9CgogICAgI2ZpbHRlci1mb3JtLWhlbHAgewogICAgICAgIGdyaWQtY29sdW1uOiAyOwogICAgfQoKICAgICNmaWx0ZXItZm9ybS1vdXRwdXQtcm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgZ2FwOiAxcmVtOwogICAgICAgIG1pbi1oZWlnaHQ6IDIuNXJlbTsKICAgIH0KCiAgICAjZmlsdGVyLWZvcm0tb3V0cHV0LXJvdyBvdXRwdXQgewogICAgICAgIGZsZXgtZ3JvdzogMTsKICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRGaWx0ZXJFZGl0b3IoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBmaWx0ZXJGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZHNldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGRzZXQnKTsKICAgIGNvbnN0IGZpbHRlckZpZWxkTGFiZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWxhYmVsJyk7CiAgICBjb25zdCBmaWx0ZXJGaWVsZFRleHRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXItZmllbGQtdGV4dCcpOwogICAgY29uc3QgZmlsdGVyRmllbGRDaG9pY2VEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZpZWxkLWNob2ljZScpOwogICAgY29uc3QgZmlsdGVyRmllbGRPcHRpb25zRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1maWVsZC1vcHRpb25zJyk7CiAgICBjb25zdCBmaWx0ZXJDYW5jZWxCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWNhbmNlbCcpOwogICAgY29uc3QgZmlsdGVyQXBwbHlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWFwcGx5Jyk7CiAgICBjb25zdCBmaWx0ZXJGb3JtT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbHRlci1mb3JtLW91dHB1dCcpOwogICAgY29uc3QgZmlsdGVyRm9ybUhlbHBEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyLWZvcm0taGVscCcpOwogICAgZmlsdGVyQ2FuY2VsQnV0dG9uLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uY2FuY2VsRmlsdGVyKCk7CiAgICB9OwogICAgZmlsdGVyQXBwbHlCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBjb25zdCB0eXBlID0gY29tcHV0ZVR5cGUodm0pOwogICAgICAgIGlmICh0eXBlID09PSAndGV4dCcpIHsKICAgICAgICAgICAgdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlID0gZmlsdGVyRmllbGRUZXh0SW5wdXQudmFsdWU7CiAgICAgICAgfQogICAgICAgIHZtLnNhdmVGaWx0ZXIoKTsKICAgIH07CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB3YXNIaWRkZW4gPSBmaWx0ZXJGb3JtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJzsKICAgICAgICBmaWx0ZXJGb3JtLnN0eWxlLmRpc3BsYXkgPSB2bS5maWx0ZXJGb3JtLnNob3dpbmcgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGZpbHRlckZpZWxkc2V0LmRpc2FibGVkID0gIXZtLmZpbHRlckZvcm0uZW5hYmxlZDsKICAgICAgICBjb25zdCB0eXBlID0gY29tcHV0ZVR5cGUodm0pOwogICAgICAgIGZpbHRlckZpZWxkTGFiZWwudGV4dENvbnRlbnQgPSB2bS5maWx0ZXJGb3JtLmZpZWxkTmFtZTsKICAgICAgICBmaWx0ZXJGaWVsZExhYmVsLmh0bWxGb3IgPSB0eXBlID09ICdjaG9pY2UnID8gZmlsdGVyRmllbGRDaG9pY2VEaXYuaWQgOiB0eXBlID09ICdvcHRpb25zJyA/IGZpbHRlckZpZWxkT3B0aW9uc0Rpdi5pZCA6IGZpbHRlckZpZWxkVGV4dElucHV0LmlkOwogICAgICAgIGZpbHRlckZpZWxkVGV4dElucHV0LnN0eWxlLmRpc3BsYXkgPSB0eXBlID09ICd0ZXh0JyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgZmlsdGVyRmllbGRDaG9pY2VEaXYuc3R5bGUuZGlzcGxheSA9IHR5cGUgPT0gJ2Nob2ljZScgPyAnZmxleCcgOiAnbm9uZSc7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoQ0hPSUNFU19IVE1MKHZtKSwgZmlsdGVyRmllbGRDaG9pY2VEaXYpOwogICAgICAgIGZpbHRlckZpZWxkT3B0aW9uc0Rpdi5zdHlsZS5kaXNwbGF5ID0gdHlwZSA9PSAnb3B0aW9ucycgPyAnZmxleCcgOiAnbm9uZSc7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoT1BUSU9OU19IVE1MKHZtKSwgZmlsdGVyRmllbGRPcHRpb25zRGl2KTsKICAgICAgICBmaWx0ZXJGb3JtSGVscERpdi50ZXh0Q29udGVudCA9IHZtLmZpbHRlckZvcm0uaGVscFRleHQ7CiAgICAgICAgZmlsdGVyRm9ybU91dHB1dC50ZXh0Q29udGVudCA9IHZtLmZpbHRlckZvcm0ub3V0cHV0TWVzc2FnZTsKICAgICAgICBpZiAod2FzSGlkZGVuICYmIHZtLmZpbHRlckZvcm0uc2hvd2luZykgewogICAgICAgICAgICBjb25zb2xlLmxvZygnZmlsdGVyIGZvcm0gb3BlbicpOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3RleHQnICYmIHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZSkgZmlsdGVyRmllbGRUZXh0SW5wdXQudmFsdWUgPSB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWU7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIGZpbHRlckZpZWxkVGV4dElucHV0LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBmaWx0ZXJGaWVsZFRleHRJbnB1dC5zZWxlY3QoKTsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgfQogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlVHlwZSh2bSkgewogICAgcmV0dXJuIHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMubGVuZ3RoID4gMCA/ICdjaG9pY2UnIDogdm0uZmlsdGVyRm9ybS5maWVsZFZhbHVlT3B0aW9ucy5sZW5ndGggPyAnb3B0aW9ucycgOiAndGV4dCc7Cn0KY29uc3QgQ0hPSUNFU19IVE1MID0gKHZtKT0+ewogICAgcmV0dXJuIHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZUNob2ljZXMubWFwKChjaG9pY2UpPT5odG1sYDxidXR0b24gY2xhc3M9IiR7Y2hvaWNlLmlkID09PSB2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgPyAnc2VsZWN0ZWQnIDogJyd9IiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2bS5zZWxlY3RGaWx0ZXJDaG9pY2UoY2hvaWNlLmlkKTsKICAgICAgICB9fSA/ZGlzYWJsZWQ9IiR7IXZtLmZpbHRlckZvcm0uc2hvd2luZ30iPiR7Y2hvaWNlLnRleHR9PC9idXR0b24+YAogICAgKTsKfTsKY29uc3QgT1BUSU9OU19IVE1MID0gKHZtKT0+ewogICAgcmV0dXJuIHZtLmZpbHRlckZvcm0uZmllbGRWYWx1ZU9wdGlvbnMubWFwKChvcHRpb24pPT57CiAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSBmaWVsZFZhbHVlU2V0KHZtKS5oYXMob3B0aW9uLmlkKTsKICAgICAgICByZXR1cm4gaHRtbGA8YnV0dG9uIGNsYXNzPSIke3NlbGVjdGVkID8gJ3NlbGVjdGVkJyA6ICcnfSIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdm0udG9nZ2xlRmlsdGVyT3B0aW9uKG9wdGlvbi5pZCk7CiAgICAgICAgfX0gP2Rpc2FibGVkPSIkeyF2bS5maWx0ZXJGb3JtLnNob3dpbmd9Ij4ke3NlbGVjdGVkID8gQ0hFQ0tfQk9YX0NIRUNLRURfSUNPTiA6IENIRUNLX0JPWF9VTkNIRUNLRURfSUNPTn0gJHtvcHRpb24udGV4dH08L2J1dHRvbj5gOwogICAgfSk7Cn07CmZ1bmN0aW9uIGZpZWxkVmFsdWVTZXQodm0pIHsKICAgIHJldHVybiBuZXcgU2V0KCh2bS5maWx0ZXJGb3JtLmZpZWxkVmFsdWUgfHwgJycpLnNwbGl0KCcsJykubWFwKCh2KT0+di50cmltKCkKICAgICkuZmlsdGVyKCh2KT0+di5sZW5ndGggPiAwCiAgICApKTsKfQpjb25zdCBQUk9GSUxFX0VESVRPUl9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9InByb2ZpbGUtZm9ybSIgYXV0b2NvbXBsZXRlPSJvZmYiPgo8ZmllbGRzZXQgaWQ9InByb2ZpbGUtZmllbGRzZXQiPgogIDxkaXYgaWQ9InByb2ZpbGUtZm9ybS10aXRsZSIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCBmb3JtLXJvdyI+UHJvZmlsZTwvZGl2PgoKICA8bGFiZWwgZm9yPSJwcm9maWxlLW5hbWUiPlByb2ZpbGUgbmFtZTo8L2xhYmVsPgogIDxpbnB1dCBpZD0icHJvZmlsZS1uYW1lIiB0eXBlPSJ0ZXh0Ij4KCiAgPGxhYmVsIGZvcj0iYWNjb3VudC1pZCI+Q2xvdWRmbGFyZSBBY2NvdW50IElEOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJwcm9maWxlLWFjY291bnQtaWQiIHR5cGU9InRleHQiPgoKICA8bGFiZWwgZm9yPSJhcGktdG9rZW4iPkNsb3VkZmxhcmUgQVBJIFRva2VuOjwvbGFiZWw+CiAgPGlucHV0IGlkPSJwcm9maWxlLWFwaS10b2tlbiIgdHlwZT0idGV4dCI+CgogIDxkZXRhaWxzIGlkPSJwcm9maWxlLWZvcm0taGVscC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8c3VtbWFyeT5Vc2UgYSA8YSBocmVmPSJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9QcmluY2lwbGVfb2ZfbGVhc3RfcHJpdmlsZWdlIiB0YXJnZXQ9Il9ibGFuayI+bGVhc3QgcHJpdmlsZWdlPC9hPiB0b2tlbiB3aXRoIHBlcm1pc3Npb246IDxjb2RlPkFjY291bnQgJmd0OyBXb3JrZXJzIFRhaWwgJmd0OyBSZWFkPC9jb2RlPjwvc3VtbWFyeT4KICAgIDxvbD4KICAgICAgICA8bGk+U2VsZWN0IDxzcGFuIGNsYXNzPSJjZi1idXR0b24iPkNyZWF0ZSBUb2tlbjwvc3Bhbj4gb24geW91ciBDbG91ZGZsYXJlIDxhIGhyZWY9Imh0dHBzOi8vZGFzaC5jbG91ZGZsYXJlLmNvbS9wcm9maWxlL2FwaS10b2tlbnMiIHRhcmdldD0iX2JsYW5rIj5BUEkgVG9rZW5zPC9hPiBwYWdlLjwvbGk+CiAgICAgICAgPGxpPlNjcm9sbCBkb3duIHRvIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5DcmVhdGUgQ3VzdG9tIFRva2VuPC9zcGFuPiwgdGhlbiA8c3BhbiBjbGFzcz0iY2YtYnV0dG9uIj5HZXQgc3RhcnRlZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5VbmRlciA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UGVybWlzc2lvbnM8L3NwYW4+LCBncmFudCB5b3VyIHRva2VuIDxzcGFuIGNsYXNzPSJjZi1zZWN0aW9uIj5BY2NvdW50PC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+V29ya2VycyBUYWlsPC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UmVhZDwvc3Bhbj48L2xpPgogICAgICAgIDxsaT5BbHNvIChmb3IgYW5hbHl0aWNzKSwgZ3JhbnQgeW91ciB0b2tlbiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+QWNjb3VudDwvc3Bhbj4gPHNwYW4gY2xhc3M9ImNmLXNlY3Rpb24iPkFjY291bnQgQW5hbHl0aWNzPC9zcGFuPiA8c3BhbiBjbGFzcz0iY2Ytc2VjdGlvbiI+UmVhZDwvc3Bhbj48L2xpPgogICAgPC9vbD4KICA8L2RldGFpbHM+ICAKCiAgPGRpdiBpZD0icHJvZmlsZS1mb3JtLW91dHB1dC1yb3ciIGNsYXNzPSJmb3JtLXJvdyI+CiAgICA8b3V0cHV0IGlkPSJwcm9maWxlLWZvcm0tb3V0cHV0Ij48L291dHB1dD4KICAgIDxwcm9ncmVzcyBpZD0icHJvZmlsZS1mb3JtLXByb2dyZXNzIiBjbGFzcz0icHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciI+PC9wcm9ncmVzcz4KICA8L2Rpdj4KCiAgPGRpdiBjbGFzcz0iZm9ybS1saHMiPgogICAgPGJ1dHRvbiBpZD0icHJvZmlsZS1kZWxldGUiPkRlbGV0ZTwvYnV0dG9uPgogIDwvZGl2PgogIDxkaXYgaWQ9InByb2ZpbGUtZm9ybS1idXR0b25zIiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0icHJvZmlsZS1jYW5jZWwiPkNhbmNlbDwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0icHJvZmlsZS1zYXZlIj5TYXZlPC9idXR0b24+CiAgPC9kaXY+CjwvZmllbGRzZXQ+CjwvZm9ybT4KYDsKY29uc3QgUFJPRklMRV9FRElUT1JfQ1NTID0gY3NzYAoKICAgICNwcm9maWxlLWZvcm0tYnV0dG9ucyB7CiAgICAgICAganVzdGlmeS1zZWxmOiBlbmQ7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBnYXA6IDFyZW07CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyB7CiAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgc3VtbWFyeSB7CiAgICAgICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1oZWxwLXJvdyBvbCB7CiAgICAgICAgY3Vyc29yOiBkZWZhdWx0OwogICAgfQoKICAgICNwcm9maWxlLWZvcm0taGVscC1yb3cgbGkgewogICAgICAgIHBhZGRpbmc6IDAuNXJlbSAwOwogICAgfQoKICAgIC5jZi1idXR0b24gewogICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiBibHVlOwogICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICBwYWRkaW5nOiAwLjI1cmVtIDAuNXJlbTsKICAgICAgICBib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogICAgfQoKICAgIC5jZi1zZWN0aW9uIHsKICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7CiAgICAgICAgY29sb3I6IGJsYWNrOwogICAgICAgIHBhZGRpbmc6IDAuMjVyZW0gMC41cmVtOwogICAgICAgIG91dGxpbmU6IHNvbGlkIDFweCBncmF5OwogICAgfQoKICAgICNwcm9maWxlLWZvcm0tb3V0cHV0LXJvdyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGdhcDogMXJlbTsKICAgICAgICBtaW4taGVpZ2h0OiAyLjVyZW07CiAgICB9CgogICAgI3Byb2ZpbGUtZm9ybS1vdXRwdXQtcm93IG91dHB1dCB7CiAgICAgICAgZmxleC1ncm93OiAxOwogICAgfQoKICAgICNwcm9maWxlLWZvcm0tcHJvZ3Jlc3MgewogICAgICAgIGZvbnQtc2l6ZTogMC41cmVtOyAvKiBkZWZhdWx0IDNlbSA9PiAxLjVyZW0gKi8KICAgIH0KCmA7CmZ1bmN0aW9uIGluaXRQcm9maWxlRWRpdG9yKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgcHJvZmlsZUZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtJyk7CiAgICBjb25zdCBwcm9maWxlRm9ybVRpdGxlRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS10aXRsZScpOwogICAgY29uc3QgcHJvZmlsZUZpZWxkc2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZmllbGRzZXQnKTsKICAgIGNvbnN0IHByb2ZpbGVOYW1lSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1uYW1lJyk7CiAgICBjb25zdCBwcm9maWxlQWNjb3VudElkSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1hY2NvdW50LWlkJyk7CiAgICBjb25zdCBwcm9maWxlQXBpVG9rZW5JbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFwaS10b2tlbicpOwogICAgY29uc3QgcHJvZmlsZURlbGV0ZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWRlbGV0ZScpOwogICAgY29uc3QgcHJvZmlsZUNhbmNlbEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWNhbmNlbCcpOwogICAgY29uc3QgcHJvZmlsZVNhdmVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1zYXZlJyk7CiAgICBjb25zdCBwcm9maWxlRm9ybVByb2dyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2ZpbGUtZm9ybS1wcm9ncmVzcycpOwogICAgY29uc3QgcHJvZmlsZUZvcm1PdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvZmlsZS1mb3JtLW91dHB1dCcpOwogICAgY29uc3QgcHJvZmlsZUZvcm1IZWxwRGV0YWlscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWZvcm0taGVscC1yb3cnKTsKICAgIHByb2ZpbGVDYW5jZWxCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5jYW5jZWxQcm9maWxlKCk7CiAgICB9OwogICAgcHJvZmlsZU5hbWVJbnB1dC5vbmlucHV0ID0gKCk9PnsKICAgICAgICB2bS5zZXRQcm9maWxlTmFtZShwcm9maWxlTmFtZUlucHV0LnZhbHVlKTsKICAgIH07CiAgICBwcm9maWxlQWNjb3VudElkSW5wdXQub25pbnB1dCA9ICgpPT57CiAgICAgICAgdm0uc2V0UHJvZmlsZUFjY291bnRJZChwcm9maWxlQWNjb3VudElkSW5wdXQudmFsdWUpOwogICAgfTsKICAgIHByb2ZpbGVBcGlUb2tlbklucHV0Lm9uaW5wdXQgPSAoKT0+ewogICAgICAgIHZtLnNldFByb2ZpbGVBcGlUb2tlbihwcm9maWxlQXBpVG9rZW5JbnB1dC52YWx1ZSk7CiAgICB9OwogICAgcHJvZmlsZVNhdmVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5zYXZlUHJvZmlsZSgpOwogICAgfTsKICAgIHByb2ZpbGVEZWxldGVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5kZWxldGVQcm9maWxlKHZtLnByb2ZpbGVGb3JtLnByb2ZpbGVJZCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gcHJvZmlsZUZvcm0uc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnOwogICAgICAgIHByb2ZpbGVGb3JtLnN0eWxlLmRpc3BsYXkgPSB2bS5wcm9maWxlRm9ybS5zaG93aW5nID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBwcm9maWxlRmllbGRzZXQuZGlzYWJsZWQgPSAhdm0ucHJvZmlsZUZvcm0uZW5hYmxlZDsKICAgICAgICBwcm9maWxlRm9ybVRpdGxlRGl2LnRleHRDb250ZW50ID0gdm0ucHJvZmlsZUZvcm0udGl0bGU7CiAgICAgICAgcHJvZmlsZU5hbWVJbnB1dC52YWx1ZSA9IHZtLnByb2ZpbGVGb3JtLm5hbWU7CiAgICAgICAgcHJvZmlsZUFjY291bnRJZElucHV0LnZhbHVlID0gdm0ucHJvZmlsZUZvcm0uYWNjb3VudElkOwogICAgICAgIHByb2ZpbGVBcGlUb2tlbklucHV0LnZhbHVlID0gdm0ucHJvZmlsZUZvcm0uYXBpVG9rZW47CiAgICAgICAgcHJvZmlsZURlbGV0ZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gdm0ucHJvZmlsZUZvcm0uZGVsZXRlVmlzaWJsZSA/ICdpbmxpbmUtYmxvY2snIDogJ25vbmUnOwogICAgICAgIHByb2ZpbGVTYXZlQnV0dG9uLmRpc2FibGVkID0gIXZtLnByb2ZpbGVGb3JtLnNhdmVFbmFibGVkOwogICAgICAgIHByb2ZpbGVGb3JtUHJvZ3Jlc3Muc3R5bGUuZGlzcGxheSA9IHZtLnByb2ZpbGVGb3JtLnByb2dyZXNzVmlzaWJsZSA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgcHJvZmlsZUZvcm1PdXRwdXQudGV4dENvbnRlbnQgPSB2bS5wcm9maWxlRm9ybS5vdXRwdXRNZXNzYWdlOwogICAgICAgIGlmICh3YXNIaWRkZW4gJiYgdm0ucHJvZmlsZUZvcm0uc2hvd2luZykgewogICAgICAgICAgICBjb25zdCBpbml0aWFsRGV0YWlsc09wZW4gPSB2bS5yZWFsUHJvZmlsZXMubGVuZ3RoID09PSAwOwogICAgICAgICAgICBwcm9maWxlRm9ybUhlbHBEZXRhaWxzLm9wZW4gPSBpbml0aWFsRGV0YWlsc09wZW47CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgIHByb2ZpbGVOYW1lSW5wdXQuZm9jdXMoKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVOYW1lSW5wdXQuc2VsZWN0KCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgV0VMQ09NRV9QQU5FTF9IVE1MID0gaHRtbGAKPGZvcm0gaWQ9IndlbGNvbWUtcGFuZWwiIGF1dG9jb21wbGV0ZT0ib2ZmIj4KPGZpZWxkc2V0IGlkPSJ3ZWxjb21lLXBhbmVsLWZpZWxkc2V0Ij4KICA8ZGl2IGlkPSJ3ZWxjb21lLXBhbmVsLWZvcm0tdGl0bGUiIGNsYXNzPSJoNiBoaWdoLWVtcGhhc2lzLXRleHQgZm9ybS1yb3ciPnRpdGxlPC9kaXY+CgogIDxkaXYgY2xhc3M9ImZvcm0tcm93IGJvZHkyIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij4KICAgIFdlbGNvbWUgdG8gPHNwYW4gY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+V2VidGFpbCBmb3IgQ2xvdWRmbGFyZSBXb3JrZXJzPC9zcGFuPiEKICAgIDxwPlZpZXcgbGl2ZSByZXF1ZXN0cyBhbmQgbG9ncyBmcm9tIDxhIGhyZWY9Imh0dHBzOi8vd29ya2Vycy5jbG91ZGZsYXJlLmNvbS8iIHRhcmdldD0iX2JsYW5rIj5DbG91ZGZsYXJlIFdvcmtlcnM8L2E+IGZyb20gdGhlIGNvbWZvcnQgb2YgeW91ciBicm93c2VyLiAKICAgIEEgZmV3IGVuaGFuY2VtZW50cyBvdmVyIHdoYXQncyBwcm92aWRlZCA8YSBocmVmPSJodHRwczovL2Jsb2cuY2xvdWRmbGFyZS5jb20vaW50cm9kdWNpbmctd29ya2Vycy1kYXNoYm9hcmQtbG9ncy8iIHRhcmdldD0iX2JsYW5rIj5ieSBkZWZhdWx0PC9hPiBpbiB0aGUgQ2xvdWRmbGFyZSBkYXNoYm9hcmQ6PC9wPgogICAgPHVsPgogICAgICAgIDxsaT5UYWlsIG11bHRpcGxlIHdvcmtlcnMgYXQgdGhlIHNhbWUgdGltZTwvbGk+CiAgICAgICAgPGxpPkFkdmFuY2VkIGZpbHRlcmluZyBhbmQgbXVsdGktY29sb3Igb3V0cHV0IHNpbWlsYXIgdG8gPGEgaHJlZj0iaHR0cHM6Ly9kZXZlbG9wZXJzLmNsb3VkZmxhcmUuY29tL3dvcmtlcnMvY2xpLXdyYW5nbGVyL2NvbW1hbmRzI3RhaWwiIHRhcmdldD0iX2JsYW5rIj53cmFuZ2xlciB0YWlsPC9hPjwvbGk+CiAgICAgICAgPGxpPkR1cmFibGUgb2JqZWN0IGNsYXNzL25hbWUvaWQgYW5kIGNvbG8gaW5mb3JtYXRpb24gY2FuIGJlIHN1cmZhY2VkIHdpdGggPGEgaHJlZj0iaHR0cHM6Ly9kZW5vZmxhcmUuZGV2L2V4YW1wbGVzL3dlYnRhaWwjbG9ncHJvcHMiIHRhcmdldD0iX2JsYW5rIj5sb2dwcm9wczwvYT48L2xpPgogICAgICAgIDxsaT5NdWx0aXBsZSBwcm9maWxlcywgc3dpdGNoIGVhc2lseSBiZXR3ZWVuIG11bHRpcGxlIGFjY291bnRzPC9saT4KICAgICAgICA8bGk+Tm8gbmVlZCB0byBsb2cgaW4gd2l0aCB5b3VyIGZ1bGwgQ2xvdWRmbGFyZSBjcmVkZW50aWFscy4gIFByb2ZpbGVzIGFyZSBzdG9yZWQgbG9jYWxseSBpbiB0aGUgYnJvd3NlciwgYW5kIGNhbiBiZSBwZXJtaXNzaW9uZWQgb25seSBmb3IgdGFpbGluZyB3b3JrZXJzPC9saT4KICAgICAgICA8bGk+SW1wbGVtZW50ZWQgYXMgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL3NreW1ldGhvZC9kZW5vZmxhcmUvdHJlZS9tYXN0ZXIvZXhhbXBsZXMvd2VidGFpbC13b3JrZXIiIHRhcmdldD0iX2JsYW5rIj5hbiBvcGVuLXNvdXJjZSBDbG91ZGZsYXJlIFdvcmtlcjwvYT4sIAogICAgICAgICAgIDxhIGhyZWY9Imh0dHBzOi8vZGVub2ZsYXJlLmRldi9leGFtcGxlcy93ZWJ0YWlsI2RlcGxveS1pdC10by15b3VyLW93bi1hY2NvdW50IiB0YXJnZXQ9Il9ibGFuayI+ZGVwbG95IGl0IHRvIHlvdXIgb3duIGFjY291bnQ8L2E+LCAKICAgICAgICAgICAgb3IgPGEgaHJlZj0iaHR0cHM6Ly9kZW5vZmxhcmUuZGV2L2V4YW1wbGVzL3dlYnRhaWwjaG9zdC1pdC1sb2NhbGx5IiB0YXJnZXQ9Il9ibGFuayI+aG9zdCBpdCBsb2NhbGx5PC9hPiB3aXRoIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayI+PGNvZGU+ZGVub2ZsYXJlPC9jb2RlPjwvYT48L2xpPgogICAgPC91bD4KICAgIDxwIGlkPSJ3ZWxjb21lLXBhbmVsLXRyYWlsZXIiPkNyZWF0ZSBhIG5ldyBwcm9maWxlIHRvIGdldCBzdGFydGVkITwvcD4KICAgIDxwIGlkPSJhYm91dC1wYW5lbC10cmFpbGVyIj5IZWFkIG92ZXIgdG8gdGhlIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9za3ltZXRob2QvZGVub2ZsYXJlIiB0YXJnZXQ9Il9ibGFuayI+RGVub2ZsYXJlIEdpdEh1YiByZXBvPC9hPiB0byByZXF1ZXN0IGZlYXR1cmVzLCByZXBvcnQgYnVncywgb3IgY2hlY2sgb3V0IHRoZSBjb2RlITwvcD4KICA8L2Rpdj4KCiAgPGRpdiBjbGFzcz0iZm9ybS1yaHMiPgogICAgPGJ1dHRvbiBpZD0id2VsY29tZS1wYW5lbC1uZXctcHJvZmlsZSIgdHlwZT0ic3VibWl0Ij5OZXcgcHJvZmlsZTwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0id2VsY29tZS1wYW5lbC1jbG9zZSIgdHlwZT0ic3VibWl0Ij5DbG9zZTwvYnV0dG9uPgogIDwvZGl2Pgo8L2ZpZWxkc2V0Pgo8L2Zvcm0+CmA7CmNvbnN0IFdFTENPTUVfUEFORUxfQ1NTID0gY3NzYAoKICAgICN3ZWxjb21lLXBhbmVsLWZvcm0tdGl0bGUgewogICAgICAgIHVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgfQoKYDsKZnVuY3Rpb24gaW5pdFdlbGNvbWVQYW5lbChkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHdlbGNvbWVQYW5lbEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2VsY29tZS1wYW5lbCcpOwogICAgY29uc3QgdGl0bGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtZm9ybS10aXRsZScpOwogICAgY29uc3Qgd2VsY29tZVRyYWlsZXJFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtdHJhaWxlcicpOwogICAgY29uc3QgYWJvdXRUcmFpbGVyRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhYm91dC1wYW5lbC10cmFpbGVyJyk7CiAgICBjb25zdCBuZXdQcm9maWxlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtbmV3LXByb2ZpbGUnKTsKICAgIGNvbnN0IGNsb3NlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtcGFuZWwtY2xvc2UnKTsKICAgIG5ld1Byb2ZpbGVCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5uZXdQcm9maWxlKCk7CiAgICB9OwogICAgY2xvc2VCdXR0b24ub25jbGljayA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5jbG9zZUFib3V0KCk7CiAgICB9OwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzSGlkZGVuID0gd2VsY29tZVBhbmVsRWxlbWVudC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7CiAgICAgICAgY29uc3Qgc2hvdyA9IHZtLndlbGNvbWVTaG93aW5nICYmICF2bS5wcm9maWxlRm9ybS5zaG93aW5nIHx8IHZtLmFib3V0U2hvd2luZzsKICAgICAgICB3ZWxjb21lUGFuZWxFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjb25zdCB3ZWxjb21lID0gdm0ud2VsY29tZVNob3dpbmc7CiAgICAgICAgdGl0bGVFbGVtZW50LnRleHRDb250ZW50ID0gd2VsY29tZSA/ICdIZWxsbyDwn5GLJyA6ICdBYm91dCc7CiAgICAgICAgd2VsY29tZVRyYWlsZXJFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBhYm91dFRyYWlsZXJFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ25vbmUnIDogJ2Jsb2NrJzsKICAgICAgICBuZXdQcm9maWxlQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSB3ZWxjb21lID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjbG9zZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gd2VsY29tZSA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgaWYgKHdhc0hpZGRlbiAmJiBzaG93KSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3dlbGNvbWUgPyAnd2VsY29tZScgOiAnYWJvdXQnfSBwYW5lbCBvcGVuYCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICAgICAgICAgICh3ZWxjb21lID8gbmV3UHJvZmlsZUJ1dHRvbiA6IGNsb3NlQnV0dG9uKS5mb2N1cygpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IE1PREFMX0hUTUwgPSBodG1sYAo8ZGl2IGlkPSJtb2RhbCIgY2xhc3M9Im1vZGFsIGhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwiPgogICAgPGRpdiBjbGFzcz0ibW9kYWwtY29udGVudCI+CiAgICAke1dFTENPTUVfUEFORUxfSFRNTH0KICAgICR7UFJPRklMRV9FRElUT1JfSFRNTH0KICAgICR7RklMVEVSX0VESVRPUl9IVE1MfQogICAgPC9kaXY+CjwvZGl2PgpgOwpjb25zdCBNT0RBTF9DU1MgPSBjc3NgCi5tb2RhbCB7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9zaXRpb246IGZpeGVkOwogICAgei1pbmRleDogMTsKICAgIGxlZnQ6IDA7CiAgICB0b3A6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMCwgMCwgMC40KTsKfQoKLm1vZGFsLWNvbnRlbnQgewogICAgbWFyZ2luOiAxMCUgYXV0bzsKICAgIHdpZHRoOiA4MCU7CiAgICBtYXgtd2lkdGg6IDQwcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCkBtZWRpYSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDYwMHB4KSB7CiAgICAubW9kYWwtY29udGVudCB7CiAgICAgICAgbWFyZ2luOiAxMCUgMDsKICAgICAgICB3aWR0aDogMTAwJTsKICAgIH0KfQoKYDsKZnVuY3Rpb24gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgbW9kYWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kYWwnKTsKICAgIGNvbnN0IHVwZGF0ZVByb2ZpbGVFZGl0b3IgPSBpbml0UHJvZmlsZUVkaXRvcihkb2N1bWVudCwgdm0pOwogICAgY29uc3QgdXBkYXRlRmlsdGVyRWRpdG9yID0gaW5pdEZpbHRlckVkaXRvcihkb2N1bWVudCwgdm0pOwogICAgY29uc3QgdXBkYXRlV2VsY29tZVBhbmVsID0gaW5pdFdlbGNvbWVQYW5lbChkb2N1bWVudCwgdm0pOwogICAgY29uc3QgY2xvc2VNb2RhbCA9ICgpPT57CiAgICAgICAgaWYgKCF2bS5wcm9maWxlRm9ybS5zaG93aW5nICYmICF2bS5maWx0ZXJGb3JtLnNob3dpbmcgJiYgIXZtLndlbGNvbWVTaG93aW5nICYmICF2bS5hYm91dFNob3dpbmcpIHJldHVybjsKICAgICAgICBpZiAodm0ucHJvZmlsZUZvcm0ucHJvZ3Jlc3NWaXNpYmxlKSByZXR1cm47CiAgICAgICAgdm0ucHJvZmlsZUZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHZtLmZpbHRlckZvcm0uc2hvd2luZyA9IGZhbHNlOwogICAgICAgIHZtLmFib3V0U2hvd2luZyA9IGZhbHNlOwogICAgICAgIHZtLm9uQ2hhbmdlKCk7CiAgICB9OwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2ZW50KT0+ewogICAgICAgIGlmIChldmVudC50YXJnZXQgPT0gbW9kYWwpIHsKICAgICAgICAgICAgY2xvc2VNb2RhbCgpOwogICAgICAgIH0KICAgIH0pOwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChldmVudCk9PnsKICAgICAgICBldmVudCA9IGV2ZW50IHx8IHdpbmRvdy5ldmVudDsKICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAnRXNjYXBlJykgewogICAgICAgICAgICBjbG9zZU1vZGFsKCk7CiAgICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICB1cGRhdGVQcm9maWxlRWRpdG9yKCk7CiAgICAgICAgdXBkYXRlRmlsdGVyRWRpdG9yKCk7CiAgICAgICAgdXBkYXRlV2VsY29tZVBhbmVsKCk7CiAgICAgICAgbW9kYWwuc3R5bGUuZGlzcGxheSA9IHZtLnByb2ZpbGVGb3JtLnNob3dpbmcgfHwgdm0uZmlsdGVyRm9ybS5zaG93aW5nIHx8IHZtLndlbGNvbWVTaG93aW5nIHx8IHZtLmFib3V0U2hvd2luZyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKY29uc3QgQ09OU09MRV9IVE1MID0gaHRtbGAKPGRpdiBpZD0iY29uc29sZSI+CiAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlciI+CiAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItZmlsdGVycyIgY2xhc3M9ImJvZHkyIj48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1zdGF0dXMiPgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci10YWlscyIgY2xhc3M9Im92ZXJsaW5lIG1lZGl1bS1lbXBoYXNpcy10ZXh0Ij48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iY29uc29sZS1oZWFkZXItcXBzIiBjbGFzcz0ib3ZlcmxpbmUgbWVkaXVtLWVtcGhhc2lzLXRleHQiPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGlkPSJjb25zb2xlLWhlYWRlci1jbGVhciI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxjb2RlIGlkPSJjb25zb2xlLWxhc3QtbGluZSIgY2xhc3M9ImxpbmUiPnNwYWNlcjwvY29kZT4KPC9kaXY+CmA7CmNvbnN0IENPTlNPTEVfQ1NTID0gY3NzYAoKI2NvbnNvbGUgewogICAgY29sb3I6IHZhcigtLWhpZ2gtZW1waGFzaXMtdGV4dC1jb2xvcik7CiAgICBoZWlnaHQ6IDEwMHZoOwogICAgd2lkdGg6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKICAgIG92ZXJmbG93LXk6IHNjcm9sbDsKICAgIG92ZXJmbG93LXg6IGhpZGRlbjsKICAgIGZsZXgtZ3JvdzogMTsKfQoKI2NvbnNvbGU6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICAgIHdpZHRoOiAxcmVtOwogICAgaGVpZ2h0OiAzcmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7Cn0KCiNjb25zb2xlOjotd2Via2l0LXNjcm9sbGJhci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1tZWRpdW0tZW1waGFzaXMtdGV4dC1jb2xvcik7Cn0KCiNjb25zb2xlLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgaGVpZ2h0OiAzLjc1cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgcGFkZGluZzogMS4yNXJlbSAxcmVtIDFyZW0gMDsKfQoKI2NvbnNvbGUtaGVhZGVyLWZpbHRlcnMgewogICAgZmxleC1ncm93OiAxOwogICAgY29sb3I6IHZhcigtLW1lZGl1bS1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1zYW5zLXNlcmlmLWZvbnQtZmFtaWx5KTsKCiAgICBkaXNwbGF5OiAtd2Via2l0LWJveDsKICAgIC13ZWJraXQtbGluZS1jbGFtcDogMzsKICAgIC13ZWJraXQtYm94LW9yaWVudDogdmVydGljYWw7ICAKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1zdGF0dXMgewogICAgaGVpZ2h0OiAxcmVtOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtaW4td2lkdGg6IDZyZW07CiAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgIHBhZGRpbmctdG9wOiAwLjI1cmVtOwogICAgdXNlci1zZWxlY3Q6IG5vbmU7IC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCiNjb25zb2xlLWhlYWRlci10YWlscyB7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgojY29uc29sZS1oZWFkZXItY2xlYXIgewogICAgbWFyZ2luLXJpZ2h0OiAtMC41cmVtOwogICAgbWFyZ2luLWxlZnQ6IDFyZW07CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCiNjb25zb2xlLWhlYWRlci1jbGVhciAuYWN0aW9uLWljb24gewogICAgcGFkZGluZy1yaWdodDogMC41cmVtOwogICAgcGFkZGluZy1sZWZ0OiAwLjVyZW07Cn0KCiNjb25zb2xlIC5saW5lIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1zaXplOiAwLjc1cmVtOyAvKiAxMnB4ICovCiAgICBsaW5lLWhlaWdodDogMS4xcmVtOwogICAgZm9udC1mYW1pbHk6IHZhcigtLW1vbm9zcGFjZS1mb250LWZhbWlseSk7CiAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCiNjb25zb2xlLWxhc3QtbGluZSB7CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCmA7CmZ1bmN0aW9uIGluaXRDb25zb2xlKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgY29uc29sZURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyRmlsdGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1maWx0ZXJzJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyVGFpbHNFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnNvbGUtaGVhZGVyLXRhaWxzJyk7CiAgICBjb25zdCBjb25zb2xlSGVhZGVyUXBzRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25zb2xlLWhlYWRlci1xcHMnKTsKICAgIGNvbnN0IGNvbnNvbGVIZWFkZXJDbGVhckVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1oZWFkZXItY2xlYXInKTsKICAgIGNvbnN0IGNvbnNvbGVMYXN0TGluZUVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uc29sZS1sYXN0LWxpbmUnKTsKICAgIGxldCBzaG93aW5nQ2xlYXJCdXR0b24gPSBmYWxzZTsKICAgIHZtLmxvZ2dlciA9ICguLi5kYXRhKT0+ewogICAgICAgIGNvbnN0IGxpbmVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY29kZScpOwogICAgICAgIGxpbmVFbGVtZW50LmNsYXNzTmFtZSA9ICdsaW5lJzsKICAgICAgICBsZXQgcG9zID0gMDsKICAgICAgICB3aGlsZShwb3MgPCBkYXRhLmxlbmd0aCl7CiAgICAgICAgICAgIGlmIChwb3MgPiAwKSB7CiAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnLCAnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgbXNnID0gZGF0YVtwb3NdOwogICAgICAgICAgICBpZiAodHlwZW9mIG1zZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRva2VucyA9IG1zZy5zcGxpdCgnJWMnKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlbmRlcmVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPiAwICYmIGkgPCB0b2tlbnMubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRhdGFbcG9zICsgaV07CiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uc2V0QXR0cmlidXRlKCdzdHlsZScsIHN0eWxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdHlsZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZS5pbmNsdWRlcygneC0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSAveC1kdXJhYmxlLW9iamVjdC0oY2xhc3N8bmFtZXxpZClccyo6XHMqJyguKj8pJy8uZXhlYyhzdHlsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHlwZSA9IG1bMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gbVsyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9ncHJvcE5hbWUgPSAnZHVyYWJsZU9iamVjdCcgKyB0eXBlLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgdHlwZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuaHJlZiA9ICcjJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5vbmNsaWNrID0gKCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtLnNldExvZ3Byb3BGaWx0ZXIoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ3Byb3BOYW1lICsgJzonICsgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm0ub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0b2tlbnNbaV0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbmRlcmVkKSByZW5kZXJUZXh0SW50b1NwYW4odG9rZW5zW2ldLCBzcGFuKTsKICAgICAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvcyArPSAxICsgdG9rZW5zLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5lRWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShKU09OLnN0cmluZ2lmeShtc2cpKSk7CiAgICAgICAgICAgICAgICBwb3MrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zb2xlRGl2Lmluc2VydEJlZm9yZShsaW5lRWxlbWVudCwgY29uc29sZUxhc3RMaW5lRWxlbWVudCk7CiAgICAgICAgY29uc3QgeyBzY3JvbGxIZWlnaHQgLCBzY3JvbGxUb3AgLCBjbGllbnRIZWlnaHQgIH0gPSBjb25zb2xlRGl2OwogICAgICAgIGNvbnN0IGRpZmYgPSBzY3JvbGxIZWlnaHQgLSBzY3JvbGxUb3A7CiAgICAgICAgY29uc3QgYXV0b3Njcm9sbCA9IGRpZmYgLSAxNiAqIDQgPD0gY2xpZW50SGVpZ2h0OwogICAgICAgIGlmIChhdXRvc2Nyb2xsKSB7CiAgICAgICAgICAgIGNvbnNvbGVMYXN0TGluZUVsZW1lbnQuc2Nyb2xsSW50b1ZpZXcoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZiAoIXNob3dpbmdDbGVhckJ1dHRvbikgewogICAgICAgICAgICBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgICAgICAgIHNob3dpbmdDbGVhckJ1dHRvbiA9IHRydWU7CiAgICAgICAgfQogICAgfTsKICAgIHZtLm9uUmVzZXRPdXRwdXQgPSAoKT0+ewogICAgICAgIGNvbnN0IGxpbmVzID0gY29uc29sZURpdi5xdWVyeVNlbGVjdG9yQWxsKCcubGluZScpOwogICAgICAgIGxpbmVzLmZvckVhY2goKGxpbmUpPT57CiAgICAgICAgICAgIGlmIChsaW5lLmlkICE9PSAnY29uc29sZS1sYXN0LWxpbmUnKSBjb25zb2xlRGl2LnJlbW92ZUNoaWxkKGxpbmUpOwogICAgICAgIH0pOwogICAgICAgIGNvbnNvbGVIZWFkZXJDbGVhckVsZW1lbnQuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgICAgIHNob3dpbmdDbGVhckJ1dHRvbiA9IGZhbHNlOwogICAgfTsKICAgIGNvbnNvbGVIZWFkZXJRcHNFbGVtZW50LnRleHRDb250ZW50ID0gY29tcHV0ZVFwc1RleHQoMCk7CiAgICB2bS5vblFwc0NoYW5nZSA9IChxcHMpPT57CiAgICAgICAgY29uc29sZUhlYWRlclFwc0VsZW1lbnQudGV4dENvbnRlbnQgPSBjb21wdXRlUXBzVGV4dChxcHMpOwogICAgfTsKICAgIExpdEVsZW1lbnQucmVuZGVyKGFjdGlvbkljb24oQ0xFQVJfSUNPTiwgewogICAgICAgIHRleHQ6ICdDbGVhcicsCiAgICAgICAgb25jbGljazogKCk9PnZtLnJlc2V0T3V0cHV0KCkKICAgIH0pLCBjb25zb2xlSGVhZGVyQ2xlYXJFbGVtZW50KTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnNvbGVEaXYuc3R5bGUuZGlzcGxheSA9IHZtLnNlbGVjdGVkQW5hbHl0aWNJZCA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgY29uc29sZUhlYWRlckZpbHRlcnNEaXYuc3R5bGUudmlzaWJpbGl0eSA9IHZtLnByb2ZpbGVzLmxlbmd0aCA+IDAgPyAndmlzaWJsZScgOiAnaGlkZGVuJzsKICAgICAgICBjb25zb2xlSGVhZGVyVGFpbHNFbGVtZW50LnRleHRDb250ZW50ID0gY29tcHV0ZVRhaWxzVGV4dCh2bS50YWlscy5zaXplKTsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihGSUxURVJTX0hUTUwodm0pLCBjb25zb2xlSGVhZGVyRmlsdGVyc0Rpdik7CiAgICB9Owp9CmNvbnN0IEZJTFRFUlNfSFRNTCA9ICh2bSk9PnsKICAgIHJldHVybiBodG1sYFNob3dpbmcgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRTZWxlY3Rpb25GaWVsZHMoKTsKICAgIH19PiR7dm0uY29tcHV0ZVNlbGVjdGlvbkZpZWxkc1RleHQoKX08L2E+CiAgICAgZm9yIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0RXZlbnRGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZUV2ZW50RmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4KICAgICB3aXRoIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U3RhdHVzRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTdGF0dXNGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwKICAgICA8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0uZWRpdElwQWRkcmVzc0ZpbHRlcigpOwogICAgfX0+JHtjb21wdXRlSXBBZGRyZXNzRmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4sCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRNZXRob2RGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZU1ldGhvZEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LAogICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0U2FtcGxpbmdSYXRlRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVTYW1wbGluZ1JhdGVGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwgCiAgICAgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRTZWFyY2hGaWx0ZXIoKTsKICAgIH19PiR7Y29tcHV0ZVNlYXJjaEZpbHRlclRleHQodm0uZmlsdGVyKX08L2E+LCAKICAgIDxhIGhyZWY9IiMiIEBjbGljaz0keyhlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2bS5lZGl0SGVhZGVyRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVIZWFkZXJGaWx0ZXJUZXh0KHZtLmZpbHRlcil9PC9hPiwKICAgICBhbmQgPGEgaHJlZj0iIyIgQGNsaWNrPSR7KGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZtLmVkaXRMb2dwcm9wRmlsdGVyKCk7CiAgICB9fT4ke2NvbXB1dGVMb2dwcm9wRmlsdGVyVGV4dCh2bS5maWx0ZXIpfTwvYT4uCiAgICAgJHt2bS5oYXNBbnlGaWx0ZXJzKCkgPyBodG1sYCg8YSBocmVmPSIjIiBAY2xpY2s9JHsoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdm0ucmVzZXRGaWx0ZXJzKCk7CiAgICB9fT5yZXNldDwvYT4pYCA6ICcnfWA7Cn07CmZ1bmN0aW9uIGNvbXB1dGVFdmVudEZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCB7IGV2ZW50MSAgfSA9IGZpbHRlcjsKICAgIHJldHVybiBldmVudDEgPT09ICdjcm9uJyA/ICdDUk9OIHRyaWdnZXIgZXZlbnRzJyA6IGV2ZW50MSA9PT0gJ2h0dHAnID8gJ0hUVFAgcmVxdWVzdCBldmVudHMnIDogJ2FsbCBldmVudHMnOwp9CmZ1bmN0aW9uIGNvbXB1dGVTdGF0dXNGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgeyBzdGF0dXMxICB9ID0gZmlsdGVyOwogICAgcmV0dXJuIHN0YXR1czEgPT09ICdlcnJvcicgPyAnZXJyb3Igc3RhdHVzJyA6IHN0YXR1czEgPT09ICdzdWNjZXNzJyA/ICdzdWNjZXNzIHN0YXR1cycgOiAnYW55IHN0YXR1cyc7Cn0KZnVuY3Rpb24gY29tcHV0ZUlwQWRkcmVzc0ZpbHRlclRleHQoZmlsdGVyKSB7CiAgICBjb25zdCBpcEFkZHJlc3MxID0gZmlsdGVyLmlwQWRkcmVzczEgfHwgW107CiAgICByZXR1cm4gaXBBZGRyZXNzMS5sZW5ndGggPT09IDAgPyAnYW55IElQIGFkZHJlc3MnIDogaXBBZGRyZXNzMS5sZW5ndGggPT09IDEgPyBgSVAgYWRkcmVzcyBvZiAke2lwQWRkcmVzczFbMF19YCA6IGBJUCBhZGRyZXNzIGluIFske2lwQWRkcmVzczEuam9pbignLCAnKX1dYDsKfQpmdW5jdGlvbiBjb21wdXRlTWV0aG9kRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IG1ldGhvZDEgPSBmaWx0ZXIubWV0aG9kMSB8fCBbXTsKICAgIHJldHVybiBtZXRob2QxLmxlbmd0aCA9PT0gMCA/ICdhbnkgbWV0aG9kJyA6IG1ldGhvZDEubGVuZ3RoID09PSAxID8gYG1ldGhvZCBvZiAke21ldGhvZDFbMF19YCA6IGBtZXRob2QgaW4gWyR7bWV0aG9kMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVTYW1wbGluZ1JhdGVGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3Qgc2FtcGxpbmdSYXRlMSA9IHR5cGVvZiBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA9PT0gJ251bWJlcicgPyBmaWx0ZXIuc2FtcGxpbmdSYXRlMSA6IDE7CiAgICByZXR1cm4gc2FtcGxpbmdSYXRlMSA+PSAxID8gJ25vIHNhbXBsaW5nJyA6IGAkeyhNYXRoLm1heCgwLCBzYW1wbGluZ1JhdGUxKSAqIDEwMCkudG9GaXhlZCgyKX0lIHNhbXBsaW5nIHJhdGVgOwp9CmZ1bmN0aW9uIGNvbXB1dGVTZWFyY2hGaWx0ZXJUZXh0KGZpbHRlcikgewogICAgY29uc3QgeyBzZWFyY2gxICB9ID0gZmlsdGVyOwogICAgcmV0dXJuIHR5cGVvZiBzZWFyY2gxID09PSAnc3RyaW5nJyAmJiBzZWFyY2gxLmxlbmd0aCA+IDAgPyBgY29uc29sZSBsb2dzIGNvbnRhaW5pbmcgIiR7c2VhcmNoMX0iYCA6ICdubyBzZWFyY2ggZmlsdGVyJzsKfQpmdW5jdGlvbiBjb21wdXRlSGVhZGVyRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IGhlYWRlcjEgPSBmaWx0ZXIuaGVhZGVyMSB8fCBbXTsKICAgIHJldHVybiBoZWFkZXIxLmxlbmd0aCA9PT0gMCA/ICdubyBoZWFkZXIgZmlsdGVyJyA6IGhlYWRlcjEubGVuZ3RoID09PSAxID8gYGhlYWRlciBmaWx0ZXIgb2YgJHtoZWFkZXIxWzBdfWAgOiBgaGVhZGVyIGZpbHRlcnMgb2YgWyR7aGVhZGVyMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVMb2dwcm9wRmlsdGVyVGV4dChmaWx0ZXIpIHsKICAgIGNvbnN0IGxvZ3Byb3AxID0gZmlsdGVyLmxvZ3Byb3AxIHx8IFtdOwogICAgcmV0dXJuIGxvZ3Byb3AxLmxlbmd0aCA9PT0gMCA/ICdubyBsb2dwcm9wIGZpbHRlcicgOiBsb2dwcm9wMS5sZW5ndGggPT09IDEgPyBgbG9ncHJvcCBmaWx0ZXIgb2YgJHtsb2dwcm9wMVswXX1gIDogYGxvZ3Byb3AgZmlsdGVycyBvZiBbJHtsb2dwcm9wMS5qb2luKCcsICcpfV1gOwp9CmZ1bmN0aW9uIGNvbXB1dGVUYWlsc1RleHQodGFpbENvdW50KSB7CiAgICByZXR1cm4gdGFpbENvdW50ID09PSAwID8gJ25vIHRhaWxzJyA6IHRhaWxDb3VudCA9PT0gMSA/ICcxIHRhaWwnIDogYCR7dGFpbENvdW50fSB0YWlsc2A7Cn0KZnVuY3Rpb24gY29tcHV0ZVFwc1RleHQocXBzKSB7CiAgICByZXR1cm4gYCR7cXBzLnRvRml4ZWQoMil9IHFwc2A7Cn0KZnVuY3Rpb24gcmVuZGVyVGV4dEludG9TcGFuKHRleHQsIHNwYW4pIHsKICAgIGNvbnN0IHBhdHRlcm4gPSAvKGh0dHBzOlwvXC9bXlxzKV0rfFxkezEsM31cLlxkezEsM31cLlxkezEsM31cLlxkezEsM318W1xkMC1mXSsoOihbXGQwLWZdezAsNH0pPyl7NSw3fSkvZzsKICAgIGxldCBtOwogICAgbGV0IGkgPSAwOwogICAgd2hpbGUobnVsbCAhPT0gKG0gPSBwYXR0ZXJuLmV4ZWModGV4dCkpKXsKICAgICAgICBpZiAobS5pbmRleCA+IGkpIHsKICAgICAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0LnN1YnN0cmluZyhpLCBtLmluZGV4KSkpOwogICAgICAgIH0KICAgICAgICBjb25zdCB1cmxPcklwID0gbVswXTsKICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGEuaHJlZiA9IHVybE9ySXAuc3RhcnRzV2l0aCgnaHR0cHM6Ly8nKSA/IHVybE9ySXAgOiBgaHR0cHM6Ly9pcGluZm8uaW8vJHt1cmxPcklwfWA7CiAgICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICBhLnJlbCA9ICdub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93JzsKICAgICAgICBhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHVybE9ySXApKTsKICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGEpOwogICAgICAgIGkgPSBtLmluZGV4ICsgdXJsT3JJcC5sZW5ndGg7CiAgICB9CiAgICBpZiAoaSA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0LnN1YnN0cmluZyhpKSkpOwogICAgfQp9CmNvbnN0IEFOQUxZVElDU19IVE1MMSA9IGh0bWxgCjxkaXYgaWQ9ImFuYWx5dGljcyI+CiAgICA8ZGl2IGlkPSJhbmFseXRpY3MtaGVhZGVyIj4KICAgICAgICA8ZGl2IGlkPSJhbmFseXRpY3MtaGVhZGluZyIgY2xhc3M9Img2IGhpZ2gtZW1waGFzaXMtdGV4dCI+PC9kaXY+CiAgICAgICAgPGRpdiBpZD0iYW5hbHl0aWNzLXN1YmhlYWRpbmciIGNsYXNzPSJtZWRpdW0tZW1waGFzaXMtdGV4dCI+PC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1xdWVyeWluZyI+PHByb2dyZXNzIGlkPSJhbmFseXRpY3MtcHJvZ3Jlc3MiIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPiBGZXRjaGluZyBhbmFseXRpY3MuLi48L2Rpdj4KICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1lcnJvciI+PC9kaXY+CiAgICA8ZGl2IGlkPSJhbmFseXRpY3MtdGFibGUiIGNsYXNzPSJtZWRpdW0tZW1waGFzaXMtdGV4dCI+PC9kaXY+CjwvZGl2PgpgOwpjb25zdCBBTkFMWVRJQ1NfQ1NTID0gY3NzYAoKI2FuYWx5dGljcyB7CiAgICBjb2xvcjogdmFyKC0taGlnaC1lbXBoYXNpcy10ZXh0LWNvbG9yKTsKICAgIGhlaWdodDogMTAwdmg7CiAgICB3aWR0aDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWJhY2tncm91bmQtY29sb3IpOwogICAgb3ZlcmZsb3cteTogc2Nyb2xsOwogICAgb3ZlcmZsb3cteDogaGlkZGVuOwogICAgZmxleC1ncm93OiAxOwogICAgZGlzcGxheTogbm9uZTsKfQoKI2FuYWx5dGljczo6LXdlYmtpdC1zY3JvbGxiYXIgewogICAgd2lkdGg6IDFyZW07CiAgICBoZWlnaHQ6IDNyZW07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iYWNrZ3JvdW5kLWNvbG9yKTsKfQoKI2FuYWx5dGljczo6LXdlYmtpdC1zY3JvbGxiYXItdGh1bWIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbWVkaXVtLWVtcGhhc2lzLXRleHQtY29sb3IpOwp9CgojYW5hbHl0aWNzLWhlYWRlciB7CiAgICBwb3NpdGlvbjogc3RpY2t5OwogICAgdG9wOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmFja2dyb3VuZC1jb2xvcik7CiAgICBwYWRkaW5nOiAxcmVtIDA7CiAgICBoZWlnaHQ6IDNyZW07Cn0KCiNhbmFseXRpY3Mtc3ViaGVhZGluZyB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMDsKfQoKI2FuYWx5dGljcy1wcm9ncmVzcyB7CiAgICBmb250LXNpemU6IDAuNXJlbTsgLyogZGVmYXVsdCAzZW0gPT4gMS41cmVtICovCn0KCiNhbmFseXRpY3MtdGFibGUgdGFibGUgewogICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICBib3JkZXItc3BhY2luZzogMC4zNzVyZW07CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgojYW5hbHl0aWNzLXRhYmxlIHRoIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI2FuYWx5dGljcy10YWJsZSAuc3BhY2VyIHsKICAgIHdpZHRoOiAwLjc1cmVtOwp9CgojYW5hbHl0aWNzLXRhYmxlIC5lc3RpbWF0ZSB0ZCB7CiAgICBwYWRkaW5nLXRvcDogMXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdEFuYWx5dGljcyhkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IGFuYWx5dGljc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MnKTsKICAgIGNvbnN0IGFuYWx5dGljc0hlYWRpbmcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5hbHl0aWNzLWhlYWRpbmcnKTsKICAgIGNvbnN0IGFuYWx5dGljc1N1YmhlYWRpbmcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5hbHl0aWNzLXN1YmhlYWRpbmcnKTsKICAgIGNvbnN0IGFuYWx5dGljc1F1ZXJ5aW5nRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtcXVlcnlpbmcnKTsKICAgIGNvbnN0IGFuYWx5dGljc0Vycm9yRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtZXJyb3InKTsKICAgIGNvbnN0IGFuYWx5dGljc1RhYmxlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbmFseXRpY3MtdGFibGUnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGFuYWx5dGljc0Rpdi5zdHlsZS5kaXNwbGF5ID0gdm0uc2VsZWN0ZWRBbmFseXRpY0lkID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBpZiAoIXZtLnNlbGVjdGVkQW5hbHl0aWNJZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHNlbGVjdGVkQW5hbHl0aWMgPSB2bS5hbmFseXRpY3MuZmluZCgodik9PnYuaWQgPT09IHZtLnNlbGVjdGVkQW5hbHl0aWNJZAogICAgICAgICk7CiAgICAgICAgaWYgKCFzZWxlY3RlZEFuYWx5dGljKSByZXR1cm47CiAgICAgICAgYW5hbHl0aWNzSGVhZGluZy50ZXh0Q29udGVudCA9IHNlbGVjdGVkQW5hbHl0aWMudGV4dDsKICAgICAgICBhbmFseXRpY3NTdWJoZWFkaW5nLnRleHRDb250ZW50ID0gc2VsZWN0ZWRBbmFseXRpYy5kZXNjcmlwdGlvbiB8fCAnJzsKICAgICAgICBjb25zdCB7IGR1cmFibGVPYmplY3RzQ29zdHMgLCBxdWVyeWluZyAsIGVycm9yICB9ID0gdm0uYW5hbHl0aWNzU3RhdGU7CiAgICAgICAgYW5hbHl0aWNzUXVlcnlpbmdFbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSBxdWVyeWluZyA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgIGFuYWx5dGljc0Vycm9yRWxlbWVudC50ZXh0Q29udGVudCA9IGVycm9yIHx8ICcnOwogICAgICAgIGlmIChkdXJhYmxlT2JqZWN0c0Nvc3RzKSB7CiAgICAgICAgICAgIExpdEVsZW1lbnQucmVuZGVyKENPU1RTX0hUTUwoZHVyYWJsZU9iamVjdHNDb3N0cyksIGFuYWx5dGljc1RhYmxlRWxlbWVudCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBGSVhFRF8xID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdlbi1VUycsIHsKICAgIG1heGltdW1GcmFjdGlvbkRpZ2l0czogMSwKICAgIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMQp9KTsKY29uc3QgRklYRURfMiA9IG5ldyBJbnRsLk51bWJlckZvcm1hdCgnZW4tVVMnLCB7CiAgICBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDIsCiAgICBtaW5pbXVtRnJhY3Rpb25EaWdpdHM6IDIKfSk7CmZ1bmN0aW9uIGZvcm1hdDEodmFsKSB7CiAgICBpZiAodmFsIDwgMTAwMCkgcmV0dXJuIHZhbC50b1N0cmluZygpOwogICAgcmV0dXJuIGAke0ZJWEVEXzEuZm9ybWF0KHZhbCAvIDEwMDApfWtgOwp9CmZ1bmN0aW9uIGZvcm1hdDIodmFsKSB7CiAgICBpZiAodmFsIDwgMTAwMCkgcmV0dXJuIHZhbC50b0ZpeGVkKDIpOwogICAgcmV0dXJuIGAke0ZJWEVEXzIuZm9ybWF0KHZhbCAvIDEwMDApfWtgOwp9CmZ1bmN0aW9uIGZvcm1hdEdiKHZhbCkgewogICAgaWYgKHZhbCA8IDEpIHJldHVybiBgJHtmb3JtYXQyKHZhbCAqIDEwMjQpfW1iYDsKICAgIHJldHVybiBgJHtmb3JtYXQyKHZhbCl9Z2JgOwp9CmNvbnN0IENPU1RTX0hUTUwgPSAodGFibGUpPT5odG1sYAogICAgPHRhYmxlPgogICAgICAgIDx0cj4KICAgICAgICAgICAgPHRoPlVUQyBEYXk8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+UmVxdWVzdHM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iNCI+V2Vic29ja2V0czwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj5TdWJyZXF1ZXN0czwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj5EdXJhdGlvbjwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj5SZWFkczwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj5Xcml0ZXM8L3RoPjx0aCBjbGFzcz0ic3BhY2VyIj48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+RGVsZXRlczwvdGg+PHRoIGNsYXNzPSJzcGFjZXIiPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj5TdG9yYWdlPC90aD48dGggY2xhc3M9InNwYWNlciI+PC90aD4KICAgICAgICAgICAgPHRoPlRvdGFsPC90aD4KICAgICAgICA8L3RyPgogICAgICAgIDx0cj4KICAgICAgICAgICAgPHRoPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGg+TWF4PC90aD4KICAgICAgICAgICAgPHRoPkluPC90aD4KICAgICAgICAgICAgPHRoPk91dDwvdGg+CiAgICAgICAgICAgIDx0aD48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoPkdCLXNlYzwvdGg+CiAgICAgICAgICAgIDx0aD48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoIGNvbHNwYW49IjIiPjwvdGg+PHRoPjwvdGg+CiAgICAgICAgICAgIDx0aCBjb2xzcGFuPSIyIj48L3RoPjx0aD48L3RoPgogICAgICAgICAgICA8dGggY29sc3Bhbj0iMiI+PC90aD48dGg+PC90aD4KICAgICAgICAgICAgPHRoPjwvdGg+CiAgICAgICAgPC90cj4KICAgICAgICAke3RhYmxlLmFjY291bnRUYWJsZS5yb3dzLm1hcCgodik9Pmh0bWxgPHRyPgogICAgICAgICAgICA8dGQ+JHt2LmRhdGV9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVJlcXVlc3RzKX08L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2Lm1heEFjdGl2ZVdlYnNvY2tldENvbm5lY3Rpb25zKX08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtSW5ib3VuZFdlYnNvY2tldE1zZ0NvdW50KX08L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtT3V0Ym91bmRXZWJzb2NrZXRNc2dDb3VudCl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi53ZWJzb2NrZXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0MSh2LnN1bVN1YnJlcXVlc3RzKX08L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LnN1YnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0Mih2LmFjdGl2ZUdiU2Vjb25kcyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5hY3RpdmVDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtU3RvcmFnZVJlYWRVbml0cyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5yZWFkVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQgY2xhc3M9ImhpZ2gtZW1waGFzaXMtdGV4dCI+JHtmb3JtYXQxKHYuc3VtU3RvcmFnZVdyaXRlVW5pdHMpfTwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHYud3JpdGVVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZCBjbGFzcz0iaGlnaC1lbXBoYXNpcy10ZXh0Ij4ke2Zvcm1hdDEodi5zdW1TdG9yYWdlRGVsZXRlcyl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5kZWxldGVzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkIGNsYXNzPSJoaWdoLWVtcGhhc2lzLXRleHQiPiR7Zm9ybWF0R2Iodi5zdG9yYWdlR2IgfHwgMCl9PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodi5zdG9yYWdlQ29zdCB8fCAwKX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih2LnRvdGFsQ29zdCl9PC90ZD4KICAgICAgICA8L3RyPmAKICAgICl9CiAgICAgICAgPHRyPgogICAgICAgICAgICA8dGQ+PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmFjY291bnRUYWJsZS50b3RhbFJvdy5yZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmFjY291bnRUYWJsZS50b3RhbFJvdy53ZWJzb2NrZXRzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmFjY291bnRUYWJsZS50b3RhbFJvdy5zdWJyZXF1ZXN0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5hY2NvdW50VGFibGUudG90YWxSb3cuYWN0aXZlQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmFjY291bnRUYWJsZS50b3RhbFJvdy5yZWFkVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLnRvdGFsUm93LndyaXRlVW5pdHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLnRvdGFsUm93LmRlbGV0ZXNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLnRvdGFsUm93LnN0b3JhZ2VDb3N0IHx8IDApfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmFjY291bnRUYWJsZS50b3RhbFJvdy50b3RhbENvc3QpfTwvdGQ+CiAgICAgICAgPC90cj4KICAgICAgICAke3RhYmxlLmFjY291bnRUYWJsZS5lc3RpbWF0ZWQzMERheVJvdyA/IGh0bWxgPHRyIGNsYXNzPSJlc3RpbWF0ZSI+CiAgICAgICAgICAgIDx0ZD4zMC1kYXkgZXN0aW1hdGU8L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLmVzdGltYXRlZDMwRGF5Um93LnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLmVzdGltYXRlZDMwRGF5Um93LndlYnNvY2tldHNDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLmVzdGltYXRlZDMwRGF5Um93LnN1YnJlcXVlc3RzQ29zdCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD4kJHtmb3JtYXQyKHRhYmxlLmFjY291bnRUYWJsZS5lc3RpbWF0ZWQzMERheVJvdy5hY3RpdmVDb3N0KX08L3RkPjx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLmVzdGltYXRlZDMwRGF5Um93LnJlYWRVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5hY2NvdW50VGFibGUuZXN0aW1hdGVkMzBEYXlSb3cud3JpdGVVbml0c0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5hY2NvdW50VGFibGUuZXN0aW1hdGVkMzBEYXlSb3cuZGVsZXRlc0Nvc3QpfTwvdGQ+PHRkPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICA8dGQ+JCR7Zm9ybWF0Mih0YWJsZS5hY2NvdW50VGFibGUuZXN0aW1hdGVkMzBEYXlSb3cuc3RvcmFnZUNvc3QgfHwgMCl9PC90ZD48dGQ+PC90ZD4KICAgICAgICAgICAgPHRkPiQke2Zvcm1hdDIodGFibGUuYWNjb3VudFRhYmxlLmVzdGltYXRlZDMwRGF5Um93LnRvdGFsQ29zdCl9PC90ZD4KICAgICAgICA8L3RyPmAgOiAnJ30KICAgIDwvdGFibGU+CmAKOwpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKCm1haW4gewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41cmVtOwp9Cgo6cm9vdCB7CiAgICAtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2I6IHJnYigxODcsIDEzNCwgMjUyKTsKfQoKLmhpZGRlbi12ZXJ0aWNhbC1zY3JvbGwgewogICAgc2Nyb2xsYmFyLXdpZHRoOiBub25lOyAtbXMtb3ZlcmZsb3ctc3R5bGU6IG5vbmU7CiAgICBvdmVyZmxvdy15OiBzY3JvbGw7Cn0KCi5oaWRkZW4tdmVydGljYWwtc2Nyb2xsOjotd2Via2l0LXNjcm9sbGJhciB7CiAgICBkaXNwbGF5OiBub25lOyAvKiBmb3IgQ2hyb21lLCBTYWZhcmksIGFuZCBPcGVyYSAqLwp9CgpgOwpjb25zdCBhcHBIdG1sID0gaHRtbGAKPG1haW4+CiR7U0lERUJBUl9IVE1MfQoke0NPTlNPTEVfSFRNTH0KJHtBTkFMWVRJQ1NfSFRNTDF9CiR7TU9EQUxfSFRNTH0KPC9tYWluPmA7CmZ1bmN0aW9uIGFwcGVuZFN0eWxlc2hlZXRzKGNzc1RleHRzKSB7CiAgICBjb25zdCBzdHlsZVNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgIHN0eWxlU2hlZXQudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgICBzdHlsZVNoZWV0LnRleHRDb250ZW50ID0gY3NzVGV4dHMuam9pbignXG5cbicpOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZVNoZWV0KTsKfQphcHBlbmRTdHlsZXNoZWV0cyhbCiAgICBNQVRFUklBTF9DU1MuY3NzVGV4dCwKICAgIGFwcENzcy5jc3NUZXh0LAogICAgSEVBREVSX0NTUy5jc3NUZXh0LAogICAgU0lERUJBUl9DU1MuY3NzVGV4dCwKICAgIENPTlNPTEVfQ1NTLmNzc1RleHQsCiAgICBBTkFMWVRJQ1NfQ1NTLmNzc1RleHQsCiAgICBNT0RBTF9DU1MuY3NzVGV4dCwKICAgIFdFTENPTUVfUEFORUxfQ1NTLmNzc1RleHQsCiAgICBQUk9GSUxFX0VESVRPUl9DU1MuY3NzVGV4dCwKICAgIEZJTFRFUl9FRElUT1JfQ1NTLmNzc1RleHQsCiAgICBDSVJDVUxBUl9QUk9HUkVTU19DU1MuY3NzVGV4dCwgCl0pOwpMaXRFbGVtZW50LnJlbmRlcihhcHBIdG1sLCBkb2N1bWVudC5ib2R5KTsKZnVuY3Rpb24gcGFyc2VTdGF0aWNEYXRhKCkgewogICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRpYy1kYXRhLXNjcmlwdCcpOwogICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0LnRleHQpOwogICAgY29uc3QgdmVyc2lvbiA9IHR5cGVvZiBkYXRhLnZlcnNpb24gPT09ICdzdHJpbmcnID8gZGF0YS52ZXJzaW9uIDogdW5kZWZpbmVkOwogICAgY29uc3QgZmxhZ3MgPSB0eXBlb2YgZGF0YS5mbGFncyA9PT0gJ3N0cmluZycgPyBkYXRhLmZsYWdzIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGZsYWdzCiAgICB9Owp9CmNvbnN0IGRhdGExID0gcGFyc2VTdGF0aWNEYXRhKCk7CmNvbnN0IHZtID0gbmV3IFdlYnRhaWxBcHBWTSgpOwpjb25zdCB1cGRhdGVTaWRlYmFyID0gaW5pdFNpZGViYXIoZG9jdW1lbnQsIHZtLCBkYXRhMSk7CmNvbnN0IHVwZGF0ZUNvbnNvbGUgPSBpbml0Q29uc29sZShkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVBbmFseXRpY3MgPSBpbml0QW5hbHl0aWNzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZU1vZGFsID0gaW5pdE1vZGFsKGRvY3VtZW50LCB2bSk7CnZtLm9uQ2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZVNpZGViYXIoKTsKICAgIHVwZGF0ZUNvbnNvbGUoKTsKICAgIHVwZGF0ZUFuYWx5dGljcygpOwogICAgdXBkYXRlTW9kYWwoKTsKfTsKQ2xvdWRmbGFyZUFwaS5VUkxfVFJBTlNGT1JNRVIgPSBDZkdxbENsaWVudC5VUkxfVFJBTlNGT1JNRVIgPSAodik9PmAvZmV0Y2gvJHt2LnN1YnN0cmluZygnaHR0cHM6Ly8nLmxlbmd0aCl9YAo7CnZtLnN0YXJ0KCk7CnNldEFwcFN0YXRlKCdzdGFydGVkJyk7Cg==';